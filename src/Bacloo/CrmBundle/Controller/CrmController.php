<?php
namespace Bacloo\CrmBundle\Controller;


use Symfony\Bundle\FrameworkBundle\Controller\Controller;
use Symfony\Component\Httpfoundation\Response;
use Symfony\Component\Form\Form;
use Symfony\Component\HttpFoundation\Request;
use Symfony\Component\HttpFoundation\StreamedResponse;
use Symfony\Component\HttpFoundation\Session\Session;
use Symfony\Component\Validator\Constraints\Email as EmailConstraint;
use Symfony\Component\Form\Extension\Core\ChoiceList\ChoiceList;

use Sensio\Bundle\FrameworkExtraBundle\Configuration\Route;
use Sensio\Bundle\FrameworkExtraBundle\Configuration\Method;
use Symfony\Component\HttpFoundation\JsonResponse;
use Symfony\Component\Filesystem\Filesystem;

use RecursiveIteratorIterator;
use RecursiveArrayIterator;
use RecursiveDirectoryIterator;

use Bacloo\CrmBundle\Entity\Fiche;
use Bacloo\CrmBundle\Entity\Memo;
use Bacloo\CrmBundle\Entity\Bcontacts;
use Bacloo\CrmBundle\Entity\Brappels;
use Bacloo\CrmBundle\Entity\Event;
use Bacloo\CrmBundle\Entity\Search;
use Bacloo\CrmBundle\Entity\Rapsearch;
use Bacloo\CrmBundle\Entity\Prospot;
use Bacloo\CrmBundle\Entity\Prospects;
use Bacloo\CrmBundle\Entity\interresses;
use Bacloo\CrmBundle\Entity\Messages;
use Bacloo\CrmBundle\Entity\Fichesvendables;
use Bacloo\CrmBundle\Entity\Transaction;
use Bacloo\CrmBundle\Entity\Transac;
use Bacloo\CrmBundle\Entity\Prospectsbacloo;
use Bacloo\CrmBundle\Entity\Prospotbacloo;
use Bacloo\CrmBundle\Entity\Searchuser;
use Bacloo\CrmBundle\Entity\Userfav;
use Bacloo\CrmBundle\Entity\Favoris;
use Bacloo\CrmBundle\Entity\Alteruser;
use Bacloo\CrmBundle\Entity\Donemail;
use Bacloo\CrmBundle\Entity\Commandes;
use Bacloo\CrmBundle\Entity\Partenaires;
use Bacloo\CrmBundle\Entity\Articles;
use Bacloo\CrmBundle\Entity\Blog;
use Bacloo\CrmBundle\Entity\Modules;
use Bacloo\CrmBundle\Entity\Moda;
use Bacloo\UserBundle\Entity\User;
use Bacloo\CrmBundle\Entity\Pipeline;
use Bacloo\CrmBundle\Entity\Userpipe;
use Bacloo\CrmBundle\Entity\Ca;
use Bacloo\CrmBundle\Entity\Locata;
use Bacloo\CrmBundle\Entity\Locations;
use Bacloo\CrmBundle\Entity\Locataclone;
use Bacloo\CrmBundle\Entity\Locationsclone;
use Bacloo\CrmBundle\Entity\Locatasl;
use Bacloo\CrmBundle\Entity\Locationssl;
use Bacloo\CrmBundle\Entity\Locatafrs;
use Bacloo\CrmBundle\Entity\Locationsfrs;
use Bacloo\CrmBundle\Entity\Locationsslclone;
use Bacloo\CrmBundle\Entity\Locatafrsclone;
use Bacloo\CrmBundle\Entity\Locationsfrsclone;
use Bacloo\CrmBundle\Entity\Chantier;
use Bacloo\CrmBundle\Entity\Machines;
use Bacloo\CrmBundle\Entity\Machinessl;
use Bacloo\CrmBundle\Entity\Eventsite;
use Bacloo\CrmBundle\Entity\Eventparc;
use Bacloo\CrmBundle\Entity\Logis;
use Bacloo\CrmBundle\Entity\Logistique;
use Bacloo\CrmBundle\Entity\Logisrep;
use Bacloo\CrmBundle\Entity\Logistiquerep;
use Bacloo\CrmBundle\Entity\Grille;
use Bacloo\CrmBundle\Entity\Grillesl;
use Bacloo\CrmBundle\Entity\Afacturer;
// use Bacloo\CrmBundle\Entity\Facta;
use Bacloo\CrmBundle\Entity\Factures;
use Bacloo\CrmBundle\Entity\Echanges;
use Bacloo\CrmBundle\Entity\Venda;
use Bacloo\CrmBundle\Entity\Ventes;
use Bacloo\CrmBundle\Entity\Transferts;
use Bacloo\CrmBundle\Entity\Locataventes;
use Bacloo\CrmBundle\Entity\Doca;
use Bacloo\CrmBundle\Entity\Document;
use Bacloo\CrmBundle\Entity\Regla;
use Bacloo\CrmBundle\Entity\Reglement;
use Bacloo\CrmBundle\Entity\Depensesmachine;
use Bacloo\CrmBundle\Entity\Bondepart;
use Bacloo\CrmBundle\Entity\Bonretour;

use Bacloo\CrmBundle\Form\FicheType;
use Bacloo\CrmBundle\Form\MemoType;
use Bacloo\CrmBundle\Form\BcontactsType;
use Bacloo\CrmBundle\Form\BrappelsType;
use Bacloo\CrmBundle\Form\EventType;
use Bacloo\CrmBundle\Form\SearchType;
use Bacloo\CrmBundle\Form\RapsearchType;
use Bacloo\CrmBundle\Form\ProspotType;
use Bacloo\CrmBundle\Form\ProspectsType;
use Bacloo\CrmBundle\Form\MessagesType;
use Bacloo\CrmBundle\Form\TransactionType;
use Bacloo\CrmBundle\Form\TransacType;
use Bacloo\CrmBundle\Form\ProspectsbaclooType;
use Bacloo\CrmBundle\Form\ProspotbaclooType;
use Bacloo\CrmBundle\Form\SearchuserType;
use Bacloo\CrmBundle\Form\UserfavType;
use Bacloo\CrmBundle\Form\FavorisType;
use Bacloo\CrmBundle\Form\AlteruserType;
use Bacloo\CrmBundle\Form\CommandesType;
use Bacloo\CrmBundle\Form\DonemailType;
use Bacloo\CrmBundle\Form\ArticlesType;
use Bacloo\CrmBundle\Form\ModulesType;
use Bacloo\CrmBundle\Form\ModaType;
use Bacloo\CrmBundle\Form\PipelineType;
use Bacloo\CrmBundle\Form\UserpipeType;
use Bacloo\CrmBundle\Form\LocataType;
use Bacloo\CrmBundle\Form\LocatacloneType;
use Bacloo\CrmBundle\Form\LocationscloneType;
use Bacloo\CrmBundle\Form\LocationsslcloneType;
use Bacloo\CrmBundle\Form\LocataventescloneType;
use Bacloo\CrmBundle\Form\LocationsType;
use Bacloo\CrmBundle\Form\MachinesType;
use Bacloo\CrmBundle\Form\LocataslType;
use Bacloo\CrmBundle\Form\LocationsslType;
use Bacloo\CrmBundle\Form\LocatafrsType;
use Bacloo\CrmBundle\Form\LocationsfrsType;
use Bacloo\CrmBundle\Form\MachinesslType;
use Bacloo\CrmBundle\Form\EventparcType;
use Bacloo\CrmBundle\Form\EventsiteType;
use Bacloo\CrmBundle\Form\LogisType;
use Bacloo\CrmBundle\Form\LogisrepType;
use Bacloo\CrmBundle\Form\LogistiqueType;
use Bacloo\CrmBundle\Form\LogistiquerepType;
use Bacloo\CrmBundle\Form\GrilleType;
use Bacloo\CrmBundle\Form\GrilleslType;
use Bacloo\CrmBundle\Form\FactaType;
use Bacloo\CrmBundle\Form\FacturesType;
use Bacloo\CrmBundle\Form\VendaType;
use Bacloo\CrmBundle\Form\ReglaType;
use Bacloo\CrmBundle\Form\VentesType;
use Bacloo\CrmBundle\Form\LocataventesType;
use Bacloo\CrmBundle\Form\LocatafrscloneType;
use Bacloo\CrmBundle\Form\LocationsfrscloneType;
use Bacloo\CrmBundle\Form\DocaType;
use Bacloo\CrmBundle\Form\DocumentType;
use Bacloo\CrmBundle\Form\BonretourType;
use Bacloo\CrmBundle\Form\BondepartType;
use Bacloo\UserBundle\Entity\UserRepository;

use Symfony\Component\Validator\Constraints\DateTime;
use DateInterval;
use DatePeriod;


class CrmController extends Controller
{
    public function ajouterAction()
    {

        $objUser = $this->get('security.context')->getToken()->getUsername(); if(empty($objUser) or !isset($objUser) or $objUser == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        $em = $this->getDoctrine()->getManager();
        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($objUser);
        $userid = $userdetails->getId();

        $query = $em->createQuery(
            'SELECT b.compteurfiche
			FROM BaclooCrmBundle:Fiche b
			ORDER BY b.id DESC'
        )->setMaxResults(1);
        $lastnumfiche = $query->getOneOrNullResult();//print_r($lastnumfiche);
        if(empty($lastnumfiche) or !isset($lastnumfiche) or $lastnumfiche == null)
        {//echo 'vide';
            $lastnumfiche = 'AAAAAA';//echo 'vide';
        }
        else
        {//echo 'pas vide';
            $lastnumfiche = $query->getSingleScalarResult();
        }
        //echo '>>>';echo $lastnumfiche;	echo '<<<';	//echo '***'.$lastnumfiche++.'*****';

        // On crée un objet Fiche
        $fiche = new Fiche;
        // $userid = $this->get('security.context')->getToken()->GetUser()->getId();
        $form = $this->createForm(new FicheType($userid), $fiche);

        $today = date('d/m/Y');
        include('societe.php');
        // On récupère la requête
        $request = $this->get('request');
        // On vérifie qu'elle est de type POST
        if ($request->getMethod() == 'POST')
        {
            // On fait le lien Requête <-> Formulaire
            // À partir de maintenant, la variable $fiche contient les valeurs entrées dans le formulaire rempli par le visiteur
            $form->bind($request);
            // On vérifie que les valeurs entrées sont correctes

            if ($form->isValid()){
                //Avant de persister la fiche, on supprime les collections qui sont entièrement vides
                foreach ($form->get('event')->getData() as $bee) {
                    if(!isset($bee)){
                        $fiche->getEvent()->clear();
                    }
                }

                foreach ($form->get('bcontacts')->getData() as $bcc) {
                    if(!isset($bcc)){
                        $fiche->getBcontacts()->clear();
                    }
                }

                foreach ($form->get('brappels')->getData() as $brr) {
                    if(!isset($brr)){
                        $fiche->getBrappels()->clear();
                    }

                }
                foreach ($form->get('commandes')->getData() as $bcoco) {
                    if(!isset($bcoco)){
                        $fiche->getCommandes()->clear();
                    }

                }
                // On enregistre notre objet $fiche dans la base de données
                $em = $this->getDoctrine()->getManager();
                $em->persist($fiche);
                $em->flush();

                //On persiste les rappels
                foreach ($form->get('brappels')->getData() as $br) {
                    $br->addFiche($fiche);
                    if(isset($br)){//echo'llllllllllloooooooo';
                        $br->setEntreprise($fiche->GetRaisonSociale());
                        $br->setCp($fiche->GetCp());
                        $em->persist($br);
                    }
                }

                //On persiste les events
                foreach ($form->get('event')->getData() as $be) {
                    $be->addFiche($fiche);
                    if(isset($be)){
                        $be->setEntreprise($fiche->GetRaisonSociale());
                        $be->setCp($fiche->GetCp());
                        $em->persist($be);
                    }
                }

                //On persiste les contacts
                foreach ($form->get('bcontacts')->getData() as $bc) {
                    $bc->addFiche($fiche);
                    if(isset($bc)){
                        $bc->setEntreprise($fiche->GetRaisonSociale());
                        $bc->setCp($fiche->GetCp());
                        $bc->setUser($objUser);
                        $em->persist($bc);
                    }
                }

                //On persiste les commandes
                foreach ($form->get('commandes')->getData() as $bco) {
                    $bco->addFiche($fiche);
                    if(isset($bco)){
                        $bco->setEntreprise($fiche->GetRaisonSociale());
                        $bco->setUser($objUser);
                        $em->persist($bco);
                    }
                }
                // on flush le tout
                // $em->flush();

                $fichesn = $em->getRepository('BaclooCrmBundle:Fiche')
                    ->findall();
                $ok = 0;
                $pok = 0;
                $numfiche = '411'.str_pad($lastnumfiche, 3, "0", STR_PAD_LEFT);
                $lastnumfiche++;
                $fiche->setNewid($numfiche);
                $fiche->setCompteurfiche($lastnumfiche);
                
                //Ajout du prix carb et gnr
                $fichefgg = $em->getRepository('BaclooCrmBundle:Fiche')
                    ->findOneById(4566);
                $fiche->setPrixcarb($fichefgg->getPrixcarb());
                $fiche->setPrixgnr($fichefgg->getPrixgnr());
                $em->persist($fiche);
                $em->flush();
                // On définit un message flash sympa
                $this->get('session')->getFlashBag()->add('info', 'Fiche bien ajouté');

                // On redirige vers la page de visualisation de la fiche nouvellement créée
                return $this->redirect($this->generateUrl('bacloocrm_voir', array('id' => $fiche->getId())));
            }
        }
        $em = $this->getDoctrine()->getManager();
        $fiches  = $em->getRepository('BaclooCrmBundle:Fiche')
            ->findByUser($objUser);
        $nbfiches = count($fiches);

        $user  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($objUser);
        $fichelimitok = $user->getFichelimit();
        if($fichelimitok == null)
        {
            $fichelimit = 50;
        }
        else
        {
            $fichelimit = $fichelimitok;
        }

        $modules  = $em->getRepository('BaclooCrmBundle:Modules')
            ->findOneByUsername($objUser);

        return $this->render('BaclooCrmBundle:Crm:ajouter.html.twig', array('form' => $form->createView(),
            'date' => $today,
            'nbfiches' => $nbfiches,
            'usersociete' => $societe,
            'modules' => $modules,
            'fichelimit' => $fichelimit,
            'user' => $objUser));
    }

    public function voirAction($id, $raison, Request $request)
    {
        $objUser = $this->get('security.context')->getToken()->getUsername();

        $em = $this->getDoctrine()->getManager();
        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($objUser);
        $userid = $userdetails->getId();
        $modules  = $em->getRepository('BaclooCrmBundle:Modules')
            ->findOneByUsername($objUser);
        $module9activation = $modules->getModule9activation();

        // $idok  = $em->getRepository('BaclooUserBundle:Fiche')
        // ->findOneByid($id);

        if($id == 0)
        {
            $idok = $em->getRepository('BaclooCrmBundle:Fiche')
                ->findOneByRaisonSociale($raison);
            $id = $idok->getId();
        }
        //Gestion de l'encours
        $encoursfac  = $em->getRepository('BaclooCrmBundle:Factures')
            ->encoursfac($id);
        // print_r($encoursfac);
        $totalencoursfac = 0;
        foreach($encoursfac as $ef)
        {//echo $ef->getTotalttc();echo '<br>';
            if($ef->getTypedoc() == 'facture')
            {
                $totalencoursfac += $ef->getTotalttc()-$ef->getMontantdejareg();
            }
            elseif($ef->getTypedoc() == 'avoir')
            {
                $totalencoursfac = $totalencoursfac - $ef->getTotalttc();
            }
        }
// echo 'fac ='.$totalencoursfac;
	$encoursloc  = $em->getRepository('BaclooCrmBundle:Locations')
				   ->findBy(array('etatloc' => 'En location', 'codeclient' => $id));
        $totalencoursloc = 0;
        foreach($encoursloc as $el)
        {
            $finloc = $el->getFinloc();//echo $el->getFinloc();
            $today = date('Y-m-d');
            if(strtotime($finloc) - strtotime($today) > 0)
            {
                $diff = abs(strtotime($finloc) - strtotime($today));
            }
            else
            {
                $diff = 0;
            }

            if(null !== $el->getLoyerp1())
            {
                $loyer = $el->getLoyerp1();
            }
            elseif(null !== $el->getLoyerp2())
            {
                $loyer = $el->getLoyerp2();
            }
            elseif(null !== $el->getLoyerp3())
            {
                $loyer = $el->getLoyerp3();
            }
            elseif(null !== $el->getLoyerp4())
            {
                $loyer = $el->getLoyerp4();
            }
            elseif(null !== $el->getLoyermensuel())
            {
                $loyer = $el->getLoyermensuel()/20;
            }
            $totalencoursloc += ($loyer*($diff/86400));
        }
        //echo 'loc ='.$totalencoursloc;echo 'yyy'.$diff/86400;
        $encourssl = $em->getRepository('BaclooCrmBundle:Locationssl')
            ->findBy(array('etatloc' => 'En location', 'codeclient' => $id));
        $totalencourssl  = 0;
        foreach($encourssl  as $esl)
        {
            if($esl->getEtatloc() == 'En location')
            {
                $finloc = $esl->getFinloc();
                $today = date('Y-m-d');
                if(strtotime($finloc) - strtotime($today) > 0)
                {
                    $diff = abs(strtotime($finloc) - strtotime($today));
                }
                else
                {
                    $diff = 0;
                }

                if(null !== $esl->getLoyerp1())
                {
                    $loyer = $esl->getLoyerp1();
                }
                elseif(null !== $esl->getLoyerp2())
                {
                    $loyer = $esl->getLoyerp2();
                }
                elseif(null !== $esl->getLoyerp3())
                {
                    $loyer = $esl->getLoyerp3();
                }
                elseif(null !== $esl->getLoyerp4())
                {
                    $loyer = $esl->getLoyerp4();
                }
                elseif(null !== $esl->getLoyermensuel())
                {
                    $loyer = $esl->getLoyermensuel()/20;
                }
                $totalencourssl += ($loyer*($diff/86400));
            }
        }
// echo 'sl ='.$totalencourssl;
        $debutmois = date('Y-m-01');
        $jodla = date('Y-m-d');
        $encoursvente  = $em->getRepository('BaclooCrmBundle:Venda')
            ->encoursvente($debutmois, $jodla, $id);
        $totalencoursvente  = 0;
        foreach($encoursvente  as $ev)
        {
            $totalencoursvente += $ev->getMontantvente();
        }
// echo 'vente ='.$totalencoursvente;
        // $encours = $totalencoursfac + $totalencoursloc + $totalencourssl + $totalencoursvente;
        $encours = $totalencoursloc + $totalencourssl;
        if(!isset($encours)){$encours = 0;}
        $soldeimpay = $totalencoursfac;
        $soldeimpaye = round($soldeimpay, 2);

        $fiche = $em->getRepository('BaclooCrmBundle:Fiche')
            ->findOneById($id);
        $fiche->setSoldeimpayes($soldeimpaye);
        $fiche->setEncours($encours);
        $em->persist($fiche);
        $em->flush();
        // $soldeimpaye = number_format($soldeimpaya, 2, ',', ' ');echo $soldeimpaye;
        //Fin gestion de l'encours
// echo 'SOLDIMPAYE'; echo $soldeimpaye;
        if(empty($objUser) or !isset($objUser) or $objUser == 'anon.')
        {
            return $this->redirect($this->generateUrl('fos_user_security_login'));
        }

        $session = new Session();
        $session = $request->getSession();

        // définit et récupère des attributs de session
        $session->set('idfiche', $id);
        $session->set('init', '1');//on est en recherche
// echo 'view session'.$session->get('view');
        $vue = $session->get('vue');
        $pid = $session->get('idsearch');
        $idsearchrap = $session->get('idsearchrap');
        if($session->get('page') > 0)
        {
            $page = $session->get('page');
        }
        else
        {
            $page = 1;
        }
        $view = $session->get('view');
        $init = $session->get('init');
        include('societe.php');

        $fiche_sel  = $em->getRepository('BaclooCrmBundle:Fiche')
            ->find($id);

//CLONAGE SI Bacloo

        $fiche = $fiche_sel;

//echo '444';
        $ficheuser = $em->getRepository('BaclooCrmBundle:Fiche')
            ->findOneBy(array('user'=> $objUser, 'usersociete'=> $societe));
//if(empty($ficheuser)){echo 'vide';}else{echo 'pas vide';}
        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($objUser);
        $email = $userdetails->getEmail();
// echo $objUser;
        // echo 'modac='.$module9activation;
// echo 'fg='.$fiche->getUser();
        if($module9activation == 1 && $fiche->getUser() == 'Bacloo' && empty($ficheuser))
        { //echo 'clone';
            //On clone la fiche en remplaçant le pseudo du user
            $copyfiche = clone $fiche;
            $Memo = $copyfiche->getMemo();//echo 'lememo'.$Memo;
            if(isset($Memo)){$em->detach($Memo);}
            $copyfiche->setCopyof($fiche->getId());
            $copyfiche->setUser($objUser);
            $copyfiche->setTypefiche('prospect');

            $copyfiche->setUseremail($email);

            // echo 'cash';
            $em->persist($copyfiche);
// echo '3333333333333';
            $em->flush();

        }
        else
        {//echo 'la';
            $ficheca = $em->getRepository('BaclooCrmBundle:Fiche')
                ->find($id);
            $pipeid = $ficheca->getPipeline();//On recup le n° de pipeline de la fiche
            if(isset($pipeid) && $ficheca->getPotentiel() != NULL) //Si n° pipeline ok et capot ok
            {
                $pipestate = $em->getRepository('BaclooCrmBundle:Pipeline')
                    ->find($pipeid);// on  recup les données du pipeline
                //On créé le svariable des différents états du pipe
                $perdu = $pipestate->getPerdu();//echo 'perdu'.$perdu;
                $exclusion = $pipestate->getExclusion();//echo 'exclusion'.$exclusion;
                $realise = $pipestate->getRealise();//echo 'realise'.$realise;
// echo '444444444';
                $today = date('Y-m-d');
                //On  récup le dernier ca dans la table ca
                $ca = $em->getRepository('BaclooCrmBundle:Ca')
                    ->findOneBy(array('userid'=> $userid, 'ficheid'=> $id), array('id' => 'DESC'));

                $catoday = $em->getRepository('BaclooCrmBundle:Ca')
                    ->findOneBy(array('userid'=> $userid, 'ficheid'=> $id, 'date'=> $today));

                if(empty($ca)){$ca = new Ca;}//Si pas de CA on créée un objet vierge
                if(empty($catoday)){$catoday = new Ca;}//Si pas de CA du jour on créée un objet vierge

                if($perdu != 1 AND $exclusion != 1 AND $realise != 1)//Il s'agit d'un devis fait donc d'un capot
                {//echo 'capot';
                    if($ca->getCapot() != $ficheca->getPotentiel() && $ca->getDate() != $catoday->getDate())
                    {//echo 'capotaaaaaaaaaaa';
                        $catoday->setUserid($userid);
                        $catoday->setUsername($objUser);
                        $catoday->setCapot($ficheca->getPotentiel());
                        $catoday->setCareal(0);
                        $catoday->setCaperdu(0);
                        $catoday->setDate($today);
                        $catoday->setFicheid($ficheca->getId());
                        $catoday->setRaisonsociale($ficheca->getRaisonSociale());
                        $em->persist($catoday);
                        $em->flush();
                    }
                }
                elseif($realise == 1)//Ca réalisé
                {//echo 'realise';
                    if($ca->getCareal() != $ficheca->getPotentiel() && $ca->getDate() != $catoday->getDate())
                    {
                        $catoday->setUserid($userid);
                        $catoday->setUsername($objUser);
                        $catoday->setCapot($ficheca->getPotentiel());
                        $catoday->setCareal($ficheca->getPotentiel());
                        $catoday->setCaperdu(0);
                        $catoday->setDate($today);
                        $catoday->setFicheid($ficheca->getId());
                        $catoday->setRaisonsociale($ficheca->getRaisonSociale());
                        $em->persist($catoday);
                        $em->flush();
                    }
                }
                elseif($perdu == 1)//Ca perdu
                {//echo 'perdu1';
                    if($ca->getCaperdu() != $ficheca->getPotentiel() && $ca->getDate() != $catoday->getDate())
                    {
                        $catoday->setUserid($userid);
                        $catoday->setUsername($objUser);
                        $catoday->setCapot(0);
                        $catoday->setCareal(0);
                        $catoday->setCaperdu($ficheca->getPotentiel());
                        $catoday->setDate($today);
                        $catoday->setFicheid($ficheca->getId());
                        $catoday->setRaisonsociale($ficheca->getRaisonSociale());
                        $em->persist($catoday);
                        $em->flush();
                    }
                }

            }
        }
//echo $objUser;	echo $fiche->getRaisonSociale();
        $fiche_sel = $em->getRepository('BaclooCrmBundle:Fiche')
            ->findOneBy(array('user'=> $objUser, 'raisonSociale'=> $fiche->getRaisonSociale(), 'cp'=> $fiche->getCp()));
// FIN CLONAGE SI BACLOO




// echo '  décollage';
        // On récupère l'EntityManager
        $em = $this->getDoctrine()
            ->getManager();

        $today = date('d/m/Y');
        $listeBr = array();
        foreach ($fiche->getBrappels() as $br) {
            $listeBr[] = $br;
        }

        $listeBe = array();
        foreach ($fiche->getEvent() as $be) {
            $listeBe[] = $be;
        }

        $listeBc = array();
        foreach ($fiche->getBcontacts() as $bc) {
            $listeBc[] = $bc;
        }

        $listeBa = array();
        foreach ($fiche->getAlteruser() as $ba) {
            $listeBa[] = $ba;
        }

        $listeBco = array();
        foreach ($fiche->getCommandes() as $bco) {
            $listeBco[] = $bco;
        }

        // On créé le formulaire
        $em = $this->getDoctrine()->getManager();
        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneBy(array('roleuser'=> 'admin', 'usersociete' => $societe));
        $userid = $userdetails->getId();
        $form = $this->createForm(new FicheType($userid), $fiche);
        $request = $this->getRequest();
        if ($request->getMethod() == 'POST') {
// echo 'pos';
            $form->bind($request);
            if ($form->isValid()) {
                echo 'SOLDIMPAYE'.$soldeimpaye;
                $em = $this->getDoctrine()->getManager();
                $fiche->setUsersociete($societe);
                $em->persist($fiche);
                $em->flush();

                //Modification du carburant dans toutes les fiches
                if($fiche->getId() == 51)
                {
                    $allfiche = $em->getRepository('BaclooCrmBundle:Fiche')
                        ->findAll();
                    foreach($allfiche as $all)
                    {
                        $all->setPrixcarb($fiche->getPrixcarb());
                        $all->setPrixgnr($fiche->getPrixgnr());
                        $em->persist($all);
                    }
                }
                //Ajout Relance encours
                $z=0;
                $daterelance = date('Y-m-d', strtotime($fiche->getDatedepot() . '+11 months'));
                $texte = 'ATTENTION !!! Son chèque de caution expire dans 1 mois';
                $relancecontrole  = $em->getRepository('BaclooCrmBundle:Brappels')
                    ->findOneBy(array('date' => $daterelance, 'rapTexte' => $texte));
// print_r($relancecontrole);
// echo $form->get('datedepot')->getData();
                if(empty($relancecontrole) && $form->get('chequeencoffre')->getData() == 1 && null !== $form->get('datedepot')->getData())
                {echo 'laaaaaaa';
                    $relance = new Brappels;
                    $relance->setDate($daterelance);
                    $relance->setRapTexte($texte);
                    $relance->setUser($objUser);
                    $relance->setEntreprise($fiche->getRaisonSociale());
                    $relance->setAfaire(0);
                    $relance->setRdv(0);
                    $relance->setCp($fiche->getCp());
                    $relance->addFiche($fiche);
                    $fiche->addBrappel($relance);
                    $em->persist($relance);
                    $em->flush();
                }
                else{echo 'pas empty';}
                //Fin ajout relance encours

                //ON vire les éléments vides
                foreach ($fiche->getBrappels() as $br) {
                    if(empty($br->getRapTexte())){$em->remove($br);}
                }

                $listeBe = array();
                foreach ($fiche->getEvent() as $be) {
                    if(empty($be->getEventComment())){$em->remove($be);}
                }

                $listeBc = array();
                foreach ($fiche->getBcontacts() as $bc) {
                    if(empty($bc->getNom()) and empty($bc->getPrenom()) and empty($bc->getFonction()) and empty($bc->getTel1()) and empty($bc->getEmail())){$em->remove($bc);}
                }

                $listeBco = array();
                foreach ($fiche->getCommandes() as $bco) {
                    if(empty($bco->getDesignation())){$em->remove($bco);}
                }
                $em->flush();

                $modules  = $em->getRepository('BaclooCrmBundle:Modules')
                    ->findOneByUsername($objUser);
            }
            return $this->redirect($this->generateUrl('bacloocrm_voir', array('id' => $fiche->getId())));
        }


        $query = $em->createQuery(
            'SELECT u 
			FROM BaclooUserBundle:User u
			WHERE u.username != :username
			Group By u.id'
        );
        $query->setParameter('username', $objUser);
        $list_fichespot = $query->getResult();

        $i = 0;




        //Fin partie liste

        //Partie liste activite

        //Fin partie liste



//créer table ca avec cols : userid, username, capot, cares, caperdu, date, ficheid
        if($module9activation != 1) // si annuaire pas activé
        {
            $ficheca = $em->getRepository('BaclooCrmBundle:Fiche')
                ->find($id);
            $pipeid = $ficheca->getPipeline();
            if(isset($pipeid) && $ficheca->getPotentiel() != NULL)
            {
                $pipestate = $em->getRepository('BaclooCrmBundle:Pipeline')
                    ->find($pipeid);
                $perdu = $pipestate->getPerdu();//echo 'perdu'.$perdu;
                $exclusion = $pipestate->getExclusion();//echo 'exclusion'.$exclusion;
                $realise = $pipestate->getRealise();//echo 'realise'.$realise;

                $today = date('Y-m-d');
                $ca = $em->getRepository('BaclooCrmBundle:Ca')
                    ->findOneBy(array('userid'=> $userid, 'ficheid'=> $id), array('id' => 'DESC'));

                if(empty($ca)){$ca = new Ca;}

                if($perdu != 1 AND $exclusion != 1 AND $realise != 1 AND $realise != 1)
                {//echo 'capot';
                    if($ca->getCapot() != $ficheca->getPotentiel())
                    {
                        $ca->setUserid($userid);
                        $ca->setUsername($objUser);
                        $ca->setCapot($ficheca->getPotentiel());
                        $ca->setCareal(0);
                        $ca->setCaperdu(0);
                        $ca->setDate($today);
                        $ca->setFicheid($ficheca->getId());
                        $ca->setRaisonsociale($ficheca->getRaisonSociale());
                        $em->persist($ca);
                        $em->flush();
                    }
                }
                elseif($realise == 1)
                {//echo 'realise';
                    if($ca->getCareal() != $ficheca->getPotentiel())
                    {
                        $ca->setUserid($userid);
                        $ca->setUsername($objUser);
                        $ca->setCapot($ficheca->getPotentiel());
                        $ca->setCareal($ficheca->getPotentiel());
                        $ca->setCaperdu(0);
                        $ca->setDate($today);
                        $ca->setFicheid($ficheca->getId());
                        $ca->setRaisonsociale($ficheca->getRaisonSociale());
                        $em->persist($ca);
                        $em->flush();
                    }
                }
                elseif($perdu == 1)
                {//echo 'perdu';
                    if($ca->getCaperdu() != $ficheca->getPotentiel())
                    {//echo 'set ca perdu';
                        $ca->setUserid($userid);
                        $ca->setUsername($objUser);
                        $ca->setCapot(0);
                        $ca->setCareal(0);
                        $ca->setCaperdu($ficheca->getPotentiel());
                        $ca->setDate($today);
                        $ca->setFicheid($ficheca->getId());
                        $ca->setRaisonsociale($ficheca->getRaisonSociale());
                        $em->persist($ca);
                        $em->flush();
                    }
                }
            }
        }

        $modules  = $em->getRepository('BaclooCrmBundle:Modules')
            ->findOneByUsername($objUser);

        $devis  = $em->getRepository('BaclooCrmBundle:Locata')
            ->findBy(array('clientid' => $id, 'offreencours' => 1, 'contrat' => 0),array('id' => 'DESC'));

//        $bdcfrs  = $em->getRepository('BaclooCrmBundle:Locatafrs')
//            ->findBy(array('fournisseurid' => $id),array('id' => 'DESC'));

        $query = $em->createQuery(
            'SELECT f
            FROM BaclooCrmBundle:Locatafrs f
            WHERE f.fournisseurid = :fournisseurid
            AND (f.speedachat != :speedachat or f.speedachat is null)
			ORDER BY f.id DESC'
        )->setParameter('fournisseurid', $id);
        $query->setParameter('speedachat', 1);
        $bdcfrs = $query->getResult();
// echo $id;
        $contrats  = $em->getRepository('BaclooCrmBundle:Locata')
            ->findBy(array('clientid' => $id, 'contrat' => 1),array('id' => 'DESC'));

        $contratsenloc  = $em->getRepository('BaclooCrmBundle:Locata')
            ->contratsenloc($id);
        $nbloc = 0;
        foreach($contratsenloc as $contratsx)
        {
            foreach($contratsx->getLocations() as $contrat)
            {
                if($contrat->getEtatloc() == 'En location')
                {
                    $nbloc++;
                }
            }
            foreach($contratsx->getLocationssl() as $contrat)
            {
                if($contrat->getEtatloc() == 'En location')
                {
                    $nbloc++;
                }
            }
        }

        $devisventes = $em->getRepository('BaclooCrmBundle:Venda')
            ->findBy(array('clientid' => $id, 'bdcrecu' => 0));

        $ventes = $em->getRepository('BaclooCrmBundle:Venda')
            ->findBy(array('clientid' => $id, 'bdcrecu' => 1));

        $contratssl  = $em->getRepository('BaclooCrmBundle:Locatasl')
            ->findBy(array('clientid' => $id, 'contrat' => 1));

        $transferts  = $em->getRepository('BaclooCrmBundle:Transferts')
            ->findBy(array('clientid' => $id));

        $echanges  = $em->getRepository('BaclooCrmBundle:Echanges')
            ->findBy(array('clientid' => $id));

        if ($fiche->getTypefiche() == 'fournisseur') {
            $factures = $em->getRepository('BaclooCrmBundle:Factures')
                ->findBy(array('clientid' => $id, 'typedoc' => 'facture frs'), array('datecrea' => 'DESC'));
        } else {
            $factures = $em->getRepository('BaclooCrmBundle:Factures')
                ->findBy(array('clientid' => $id, 'typedoc' => 'facture'), array('datecrea' => 'DESC'));
        }

        $avoirs  = $em->getRepository('BaclooCrmBundle:Factures')
            ->findBy(array('clientid' => $id, 'typedoc' => 'avoir'), array('datecrea' => 'DESC'));

        if ($fiche->getTroppercu() >= 0) {
            foreach ($factures as $fact) {
                $fact->setTroppercu($fiche->getTroppercu());
                $em->persist($fact);
            }
        }
        $em->flush();
// echo 'looooo';
        $string = str_replace(' ', '+', $fiche->getRaisonSociale());
        $urlg = 'http://www.google.com/search?q='.$string;//echo $urlg;
        $pagesr = $session->get('pagesr');
        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($objUser);
        $documents  = $em->getRepository('BaclooCrmBundle:Document')
            ->findBy(array('codecontrat' => $fiche->getId(), 'type' => 'fiche'));
        $docsuppr = 'aaa';
        $erreur = 0;
        if(isset($documents))
        {
            foreach($documents as $document)
            {
                if($document->geterreur() == 1)
                {
                    $docsuppr = $document->getNom();
                    $erreur = 1;
                    $em->remove($document);
                    $em->flush();
                }
            }
        }
        $documents  = $em->getRepository('BaclooCrmBundle:Document')
            ->findBy(array('codecontrat' => $fiche->getId(), 'type' => 'fiche'));
        return $this->render('BaclooCrmBundle:Crm:voir.html.twig', array(
            'form'    => $form->createView(),
            //'countinter' => $countinter,
            // 'list_tags' => $list_tags,
            'id' => $fiche->getId(),
            'societe' => $fiche->getRaisonSociale(),
            'cp' => $fiche->getCp(),
            'usersociete' => $societe,
            'soldeimpaye' => $soldeimpaye,
            'useracc' => $objUser,
            'userdetails' => $userdetails,
            'fiche' => $fiche,
            'vue' => $vue,
            'page' => $page,
            'pagesr' => $pagesr,
            'pid'	=> $pid,
            'idsearchrap'	=> $idsearchrap,
            'view' => $view,
            'init' => $init,
            'date' => $today,
            'roleuser' => $userdetails->getRoleuser(),
            'module3activation' => $modules->getModule3activation(),
            'module5activation' => $modules->getModule5activation(),
            'module7activation' => $modules->getModule7activation(),
            'module8activation' => $modules->getModule8activation(),
            'module11activation' => $modules->getModule11activation(),
            'user' => $objUser,
            'modules' => $modules,
            'contrats' => $contrats,
            'contratsenloc' => $contratsenloc,
            'contratssl' => $contratssl,
            'devis' => $devis,
            'devisventes' => $devisventes,
            'ventes' => $ventes,
            'transferts' => $transferts,
            'echanges' => $echanges,
            'bdcfrs' => $bdcfrs,
            'roleuser' => $userdetails->getRoleuser(),
            'factures' => $factures,
            'avoirs' => $avoirs,
            'encours' => $encours,
            'documents' => $documents,
            'nbloc' => $nbloc,
            'urlg' => $urlg
        ));
    }

    public function searchAction($page, $view, $init, $vue, $speed, Request $request)
    {//echo 'view init'.$view;
        $session = $request->getSession();
        if(!isset($page)){
            $page=1;
        }
        else{
            $page = $session->get('page');
        }
        // echo 'YYYYYYY'.$view;echo 'VVVVVVV'.$session->get('view');
        if($view != $session->get('view') && $view != 'def')
        {
            $session->set('view', $view);
            $page=1;
        }
        $nbparpage = 20;
        set_time_limit(600);
        if(!isset($page) || $page == 0){$page =1;}
        include('societe.php');
        $usersess = $this->get('security.context')->getToken()->getUsername(); if(empty($usersess) or !isset($usersess) or $usersess == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}//Récupère le nom d'utilisateur
        $em = $this->getDoctrine()->getManager();//echo'usersess'.$usersess;
        // echo 'vue_envoyée'.$vue;

        $session = $request->getSession();
        // echo 'id   ds sess'.$session->get('id');echo 'init'.$init;
        $vue2 = $session->get('vue');
        // echo 'vue session'.$vue2;
        // echo 'view session'.$session->get('view');
        $pagesr = $session->get('pagesr');//echo 'ooo'.$pagesr;
        $id = $session->get('idsearch');//echo 'ooo'.$id;
        $idsearchrap = $session->get('idsearchrap');//echo 'ooo'.$id;
        if(empty($idsearchrap))
        {
            $idsearchrap = 0;
        }
        //echo $idsearchrap;
        if($id)
        {//echo 'yyOOOOOOy';
            $id = $session->get('idsearch');
        }
        else
        {//echo 'zzz';
            $id = 0;
        }
        if($speed == 3)
        {
            $id = 0;
            $session->set('id', 0);
            $session->set('idsearch', 0);
            $session->set('besoinfilter', 'contient');
            $session->set('rsfilter', 'contient');
            $session->set('nomfilter', 'contient');
            $session->set('activitefilter', 'contient');
            $session->set('cpfilter', 'contient');
            $session->set('villefilter', 'contient');
            $session->set('cperso1filter', 'contient');
            $session->set('cperso2filter', 'contient');
            $session->set('cperso3filter', 'contient');
            $session->set('memofilter', 'contient');
            $session->set('histofilter', 'contient');
            $session->set('fonctionfilter', 'contient');
        }
        //echo 'xxx'.$session->get('idsearch');
        if(isset($vue) && $vue != 'def')
        {
            $session = new Session();//echo 'daaaaaa';
            $session->set('page', $page);
            $session->set('vue', $vue);
        }
        else
        {
            $session = new Session();//echo 'new vue sess';
            $session->set('page', $page);
            $session->set('vue', $vue2);
        }

        //On récupère les favoris niveau ALL
        $em = $this->getDoctrine()->getManager();
        $query = $em->createQuery(
            'SELECT f.favusername
						FROM BaclooCrmBundle:Favoris f
						WHERE f.favusername = :favusername
						AND f.toutpart = :toutpart'
        )->setParameter('favusername', $usersess);
        $query->setParameter('toutpart', 1);
        $favoriall = $query->getResult();
        //echo 'cbien2 favoriall'.count($favoriall);

        //On créée un tableau sous le modèle 'user'=>$xxxx pour le repository
        if(isset($favoriall) && !empty($favoriall))
        {//echo 'liiiiiii';
            $i = 1;
            foreach($favoriall as $favo)
            {
                foreach($favo as $fav)
                {
                    ////echo 'favo'.$fav;
                    $favor  = $em->getRepository('BaclooCrmBundle:Favoris')
                        ->findOneByFavusername($usersess);
                    ${'choix'.$i++} = $favor->getUsername();
                }
            }
            //echo 'choix1'.$choix1;
            $critere = array($usersess);

            for($j=1;$j<$i;$j++)
            {
                ${'critere'.$j} = array(${"choix".$j});
                $critere = array_merge(${'critere'.$j},$critere);
            }

        }
        else
        {
            $critere = array($usersess);
        }
// $critere = array('jmr', 'toto');



//$critere = array('jmr', 'toto');
        // On déplace la vérification du numéro de page dans cette méthode



        // echo 'vue33333'.$vue;
        $user  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($usersess);

        //Protect double connexion
        $session = $request->getSession();
        $sessionId = $session->getId();
        // echo $sessionId;
        // echo 'xxxxx'.$user->getLogged();
        // echo '  '.$user->getUsername();
        if($user->getLogged() != $sessionId)
        {
            return $this->redirect($this->generateUrl('fos_user_security_logout'));
        }
        //Fin protect double connexion

        $query = $em->createQuery(
            'SELECT f
					FROM BaclooCrmBundle:Fiche f
					WHERE f.useremail = :useremail
					AND f.user = :user'
        )->setParameter('useremail', $user->getEmail())
            ->setParameter('user', 'x');
        $fichetempuser = $query->getResult();

        if(isset($fichetempuser))
        {
            foreach($fichetempuser as $fichetemp)
            {
                $fichetemp->setUser($usersess);
                $em->flush();
            }
        }
        if($view != 'search')
        {
            $mesfichestot = $em->getRepository('BaclooCrmBundle:Fiche')
                ->searchfiche_init($nbparpage, $page, $critere, $societe);
        }
        $session = $request->getSession();
        //echo '$session->get(view)'.$session->get('view');
        $v = $session->get('view');//echo 'lavue'.$view;
        if($view != 'def' && isset($v) && $v != 1)
        {//echo 'ICI'.$v;
            if($v != $view)
            {//echo '$v != $view'.$view;
                $view = $view;
                $session = new Session();
                $session = $request->getSession();
                $session->set('page', $page);
                $session->set('view', $view);
            }
            else
            {//echo $v.'$v = $view';
                $view = $v;
            }//echo $view.'>>>>';
            if($view == 'client')
            {//echo ' on est client';
                $typefiche = $view;
                include('searchprospects.php');

                if(!isset($mesfiches)){$mesfiches = 'nok';$session->set('id', '0');}

            }
            elseif($view == 'prospect')
            {//echo ' on est prospect'.$session->get('idsearch');
                $typefiche = $view;
                include('searchprospects.php');

                if(!isset($mesfiches)){$mesfiches = 'nok';$session->set('id', '0');}
                if($session->get('id') > 0)
                {
                    return $this->redirect($this->generateUrl('bacloocrm_find', array('id' => $id, 'page' => $session->get('page'), 'view' => $session->get('view') )));
                }
            }
            elseif($view == 'annuaire')
            {//echo ' on est prospect';
                $typefiche = 'prospect';
                include('searchprospects.php');

                if(!isset($mesfiches)){$mesfiches = 'nok';$session->set('id', '0');}
                if($session->get('id') > 0)
                {
                    return $this->redirect($this->generateUrl('bacloocrm_find', array('id' => $id, 'page' => $session->get('page'), 'view' => $session->get('view') )));
                }
            }
            elseif($view == 'fournisseur')
            {//echo 'laaaaaaaaaa';
                $mesfiches = $em->getRepository('BaclooCrmBundle:Fiche')
                    ->searchfiche_init_fournisseur($nbparpage, $page, $societe);
                if(!isset($mesfiches)){$mesfiches = 'nok';$session->set('id', '0');}
                $lesfichesss = $mesfiches;

            }
            elseif($view == 'corbeille')
            {
                $mesfiches = $em->getRepository('BaclooCrmBundle:Fiche')
                    ->searchfiche_init_corbeille($nbparpage, $page, $societe);
                if(!isset($mesfiches)){$mesfiches = 'nok';$session->set('id', '0');}

                $lesfichesss = $mesfiches;
            }
            elseif($view == 'shared')
            {//echo 'ocooooooooooooooo';
                $mesfiches = $em->getRepository('BaclooCrmBundle:Fiche')
                    ->searchfiche_init_shared($nbparpage, $page, $societe);
                if(!isset($mesfiches)){$mesfiches = 'nok';$session->set('id', '0');}

                $lesfichesss = $mesfiches;
            }
        }
        elseif($view = 'def' && isset($v) && $v != 1 && !empty($v))
        {
// echo $view.'<<<';
            $view = $v;//echo'ppppppp'.$v.'tt';

            if($view == 'client')
            {//echo ' on est client';
                //print_r($critere);
                $typefiche = $view;
                include('searchprospects.php');

                if(!isset($mesfiches)){$mesfiches = 'nok';}
                if($id > 0)
                {
                    return $this->redirect($this->generateUrl('bacloocrm_find', array('id' => $id, 'page' =>$session->get('page'), 'view' => $session->get('view') )));
                }
                else
                {
                    $session->set('id', '0');
                }
            }
            elseif($view == 'prospect')
            {//echo 'iccccci'.$id;
                $typefiche = $view;
                include('searchprospects.php');

                if(!isset($mesfiches)){$mesfiches = 'nok';}
                if($id > 0)
                {//echo 'ghj';
                    return $this->redirect($this->generateUrl('bacloocrm_find', array('id' => $id, 'page' => $session->get('page'), 'view' => $session->get('view') )));
                }
                else
                {//echo 'codiiiiiii';
                    $session->set('id', '0');
                }
            }
            elseif($view == 'annuaire')
            {//echo 'iiiiiiiiiii';
                $typefiche = 'prospect';
                include('searchprospects.php');

                if(!isset($mesfiches)){$mesfiches = 'nok';}
                if($id > 0)
                {
                    return $this->redirect($this->generateUrl('bacloocrm_find', array('id' => $id, 'page' => $session->get('page'), 'view' => $session->get('view') )));
                }
                else
                {//echo 'codiiiiiii';
                    $session->set('id', '0');
                }
            }
            elseif($view == 'fournisseur')
            {//echo 'frs';
                $mesfiches = $em->getRepository('BaclooCrmBundle:Fiche')
                    ->searchfiche_init_fournisseur(20, $page, $societe);
                if(!isset($mesfiches)){$mesfiches = 'nok';}
                if($id > 0)
                {
                    return $this->redirect($this->generateUrl('bacloocrm_find', array('id' => $id, 'page' => $session->get('page'), 'view' => $session->get('view') )));
                }
                else
                {
                    $session->set('id', '0');
                    $lesfichesss = $mesfiches;
                }
            }
            elseif($view == 'corbeille')
            {
                $mesfiches = $em->getRepository('BaclooCrmBundle:Fiche')
                    ->searchfiche_init_corbeille($nbparpage, $page, $usersess, $societe);
                if(!isset($mesfiches)){$mesfiches = 'nok';}
                if($id > 0)
                {
                    return $this->redirect($this->generateUrl('bacloocrm_find', array('id' => $id, 'page' => $session->get('page'), 'view' => $session->get('view') )));
                }
                else
                {
                    $session->set('id', '0');
                    $lesfichesss = $mesfiches;
                }
            }
            elseif($view == 'shared')
            {//echo 'iciiiiiiii';
                $mesfiches = $em->getRepository('BaclooCrmBundle:Fiche')
                    ->searchfiche_init_shared($nbparpage, $page, $usersess, $societe);
                if(!isset($mesfiches)){$mesfiches = 'nok';}
                if($id > 0)
                {
                    return $this->redirect($this->generateUrl('bacloocrm_find', array('id' => $id, 'page' => $session->get('page'), 'view' => $session->get('view') )));
                }
                else
                {
                    $session->set('id', '0');
                    $lesfichesss = $mesfiches;
                }
            }
            elseif($view == 'search')
            {//echo ' init '.$init;
                $session = $request->getSession();
                $inot = $session->get('init');//echo ' inot '.$inot;
                if(isset($init) && !isset($inot))
                {//echo 'pass session';
                    if($init == '2')//2 = on est pas en recherche
                    {
                        $id = $session->get('id');
                        //return $this->redirect($this->generateUrl('bacloocrm_find', array('id' => $id)));
                    }
                    else
                    {
                        $id = '0';
                        $session = new Session();
                        $session = $request->getSession();
                        $session->clear();
                        $session->set('init', '1');
                        // return $this->redirect($this->generateUrl('bacloocrm_find', array('id' => $id, 'page' => $page, 'view' => $view)));
                    }
                }
                elseif(isset($inot))
                {//echo 'session';
                    $init = $inot;
                    if($init == '2')//2 = on est pas en recherche
                    {//echo ' la ?';
                        $id = $session->get('id');
                        // return $this->redirect($this->generateUrl('bacloocrm_search'));
                    }
                    else
                    {//echo 'idddd';
                        $id = '0';
                        $session = new Session();
                        $session = $request->getSession();
                        $session->remove('init');
                        $page = $session->get('page');
                        $id = $session->get('id');
                        if(!isset($id)){$id = '0';}
                        $session->set('init', '1');	//echo 'idff'.$id; echo 'page'.$page;
                        return $this->redirect($this->generateUrl('bacloocrm_find', array('id' => $id, 'page' => $page)));
                    }
                }
            }
            else
            {//echo 'olololo';
                $mesfiches = 'nok';
            }
        }
        else
        {
            $view = 'client';//Détermine la vue par défaut
            //echo ' on est client'.$view;
            $typefiche = $view;
            include('searchprospects.php');

            if(!isset($mesfiches)){$mesfiches = 'nok';}
            //$session->set('id', '0');
        }
        //On passe tout en session pour les retours
        $session = new Session();
        $session = $request->getSession();
        $session->set('page', $page);
        $session->set('view', $view);

        // Pour récupérer le service UserManager du bundle
        $objUser = $this->get('security.context')->getToken()->getUsername(); if(empty($objUser) or !isset($objUser) or $objUser == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}

        $em = $this->getDoctrine()->getManager();
        $query = $em->createQuery(
            'SELECT u
			FROM BaclooUserBundle:User u
			WHERE u.username = :username'
        )->setParameter('username', $objUser);
        $userdetail = $query->getSingleResult();
        $tags= $userdetail->getTags();
        $actvise= $userdetail->getActvise();
        $activite= $userdetail->getActivite();
        $plein= $userdetail->getPlein();
        if($plein != 1)
        {
            if(empty($tags) OR empty($actvise) OR empty($activite))
            {
                $userdetail->setPlein(0);
                $em->flush();
            }
            elseif(isset($tags) AND isset($actvise) AND isset($activite))
            {
                $userdetail->setPlein(1);
                if($userdetail->getPoint() != 2)
                {
                    $userdetail->setPoint(2);
                }
                $em->flush();
            }
        }

        // On crée un objet Search
        $search = new Search;//echo 'eeeeeeeeeeeeeeee';
        $form = $this->createForm(new SearchType(), $search);
        $request = $this->getRequest();
        if ($request->getMethod() == 'POST') {
            $form->bind($request);
            if ($form->isValid()) {
                // On Flush la recherche
                $data = $form->getData();
                $besoinfilter = $form->get('besoinfilter')->getData();
                $rsfilter = $form->get('rsfilter')->getData();
                $nomfilter = $form->get('nomfilter')->getData();
                $activitefilter = $form->get('activitefilter')->getData();
                $cpfilter = $form->get('cpfilter')->getData();
                $villefilter = $form->get('villefilter')->getData();
                $cperso1filter = $form->get('cperso1filter')->getData();
                $cperso2filter = $form->get('cperso2filter')->getData();
                $cperso3filter = $form->get('cperso3filter')->getData();
                $memofilter = $form->get('memofilter')->getData();
                $histofilter = $form->get('histofilter')->getData();
                $fonctionfilter = $form->get('fonctionfilter')->getData();
                $em = $this->getDoctrine()->getManager();
                $em->persist($search);
                // on flush le tout
                $em->flush();
                $session = new Session();
                $session = $request->getSession();
                $session->set('page', $page);
                $session->set('view', $view);
                $session->set('besoinfilter', $besoinfilter);
                $session->set('rsfilter', $rsfilter);
                $session->set('nomfilter', $nomfilter);
                $session->set('activitefilter', $activitefilter);
                $session->set('cpfilter', $cpfilter);
                $session->set('villefilter', $villefilter);
                $session->set('cperso1filter', $cperso1filter);
                $session->set('cperso2filter', $cperso2filter);
                $session->set('cperso3filter', $cperso3filter);
                $session->set('memofilter', $memofilter);
                $session->set('histofilter', $histofilter);
                $session->set('fonctionfilter', $fonctionfilter);

                // On redirige vers la page de visualisation de recherche
                //ici l'array doit se constituer en fonction des champs de formulaire remplis
                $idsearch = $search->getId();
                $session->set('idsearch', $idsearch);
                return $this->redirect($this->generateUrl('bacloocrm_find', array('id' => $idsearch, 'view' => $view )
                ));
            }
        }
        // echo count($lesfiches);
        // echo '  '.ceil(count($lesfiches)/$nbparpage);
        //echo 'view==='.$view;

        $modules  = $em->getRepository('BaclooCrmBundle:Modules')
            ->findOneByUsername($usersess);

        $besoinfilter = $session->get('besoinfilter');
        if($besoinfilter == null)
        {
            $besoinfilter = 'contient';
        }
        $rsfilter = $session->get('rsfilter');
        if($rsfilter == null)
        {
            $rsfilter = 'contient';
        }
        $nomfilter = $session->get('nomfilter');
        if($nomfilter == null)
        {
            $nomfilter = 'contient';
        }
        $activitefilter = $session->get('activitefilter');
        if($activitefilter == null)
        {
            $activitefilter = 'contient';
        }
        $cpfilter = $session->get('cpfilter');
        if($cpfilter == null)
        {
            $cpfilter = 'contient';
        }
        $villefilter = $session->get('villefilter');
        if($villefilter == null)
        {
            $villefilter = 'contient';
        }
        $cperso1filter = $session->get('cperso1filter');
        if($cperso1filter == null)
        {
            $cperso1filter = 'contient';
        }
        $cperso2filter = $session->get('cperso2filter');
        if($cperso2filter == null)
        {
            $cperso2filter = 'contient';
        }
        $cperso3filter = $session->get('cperso3filter');
        if($cperso3filter == null)
        {
            $cperso3filter = 'contient';
        }
        $memofilter = $session->get('memofilter');
        if($memofilter == null)
        {
            $memofilter = 'contient';
        }
        $histofilter = $session->get('histofilter');
        if($histofilter == null)
        {
            $histofilter = 'contient';
        }
        $fonctionfilter = $session->get('fonctionfilter');
        if($fonctionfilter == null)
        {
            $fonctionfilter = 'contient';
        }
        if($speed == 1)
        {
            return $this->render('BaclooCrmBundle:Crm:search3.html.twig', array('mesfiches' => $mesfiches,
                'page' => $page,
                'pagesr' => $pagesr,
                'user' => $usersess,
                'modules' => $modules,
                'mesfichestot' => $mesfichestot,
                'view' => $view,
                'vue' => $vue,
                'speed' => $speed,
                'init' => $init,
                'id' => $id,
                'tab' => 'tab1',
                'lesfichesss' => count($lesfichesss),
                'nombrePage' => ceil(count($lesfichesss)/$nbparpage),
                'actvise' => $actvise,
                'activite' => $activite,
                'tags' => $tags,
                'besoinfilter' => $besoinfilter,
                'rsfilter' => $rsfilter,
                'nomfilter' => $nomfilter,
                'activitefilter' => $activitefilter,
                'cpfilter' => $cpfilter,
                'villefilter' => $villefilter,
                'cperso1filter' => $cperso1filter,
                'cperso2filter' => $cperso2filter,
                'cperso3filter' => $cperso3filter,
                'memofilter' => $memofilter,
                'histofilter' => $histofilter,
                'fonctionfilter' => $fonctionfilter,
                'form' => $form->createView()));
        }
        else
        {
            // echo 'totoooooo'.count($lesfichesss);
            if(!isset($lesfichesss)){$lesfichesss = 0;}//echo 'uiuiuiii';echo $id;
            return $this->render('BaclooCrmBundle:Crm:search.html.twig', array('mesfiches' => $mesfiches,
                'page' => $page,
                'pagesr' => $pagesr,
                'user' => $usersess,
                'modules' => $modules,
                'mesfichestot' => $mesfichestot,
                'view' => $view,
                'vue' => $vue,
                'idsearchrap' => $idsearchrap,
                'speed' => $speed,
                'tab' => 'tab1',
                'lesfichesss' => count($lesfichesss),
                'nombrePage' => ceil(count($lesfichesss)/$nbparpage),
                'actvise' => $actvise,
                'activite' => $activite,
                'tags' => $tags,
                'besoinfilter' => $besoinfilter,
                'rsfilter' => $rsfilter,
                'nomfilter' => $nomfilter,
                'activitefilter' => $activitefilter,
                'cpfilter' => $cpfilter,
                'villefilter' => $villefilter,
                'cperso1filter' => $cperso1filter,
                'cperso2filter' => $cperso2filter,
                'cperso3filter' => $cperso3filter,
                'memofilter' => $memofilter,
                'histofilter' => $histofilter,
                'fonctionfilter' => $fonctionfilter,
                'form' => $form->createView()));
        }
    }

    public function search2Action($page, $vue, $speed, $useracc, Request $request)
    {if(!isset($page)){$page =1;}
        $nbparpage = 20;
        include('societe.php');
        $usersess = $this->get('security.context')->getToken()->getUsername(); if(empty($usersess) or !isset($usersess) or $usersess == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}//Récupère le nom d'utilisateur
        $em = $this->getDoctrine()->getManager();

        $mesfichestot = $em->getRepository('BaclooCrmBundle:Fiche')
            ->searchfiche_init($nbparpage, $page, $usersess, $societe);

        $session = $request->getSession();
        $view = $session->get('view');
        //echo 'lavue'.$view;

        //On récupère les favoris niveau ALL
        $em = $this->getDoctrine()->getManager();
        $query = $em->createQuery(
            'SELECT f.favusername
				FROM BaclooCrmBundle:Favoris f
				WHERE f.username = :username
				AND f.toutpart = :toutpart'
        )->setParameter('username', $usersess);
        $query->setParameter('toutpart', 1);
        $favoriall = $query->getResult();
        // echo 'cbien1 favoriall'.count($favoriall);

        //On créée un tableau sous le modèle 'user'=>$xxxx pour le repository
        if(isset($favoriall) && !empty($favoriall) && count($favoriall)>1)
        {//echo 'li';
            $i = 0;
            foreach($favoriall as $favo)
            {
                $favor  = $em->getRepository('BaclooCrmBundle:Favoris')
                    ->findOneByFavusername($favo);
                // $choix[$i++] = $favor->getFavusername();
            }

            $critere = "array(".$usersess;

            for($j=1;$j<$i;$j++)
            {
                $critere .= ", ".$choix[$j];
            }
            $critere .= ')';
        }
        else
        {
            $critere = array($usersess);
        }

        if($view == 'client')
        {
            $typefiche = $view;
            include('searchprospects.php');

            if(!isset($mesfiches)){$mesfiches = 'nok';}
        }
        elseif($view == 'prospect')
        {
            $typefiche = $view;
            include('searchprospects.php');

            if(!isset($mesfiches)){$mesfiches = 'nok';}
        }
        elseif($view == 'fournisseur')
        {
            $mesfiches = $em->getRepository('BaclooCrmBundle:Fiche')
                ->searchfiche_init_fournisseur($nbparpage, $page, $societe);
            if(!isset($mesfiches)){$mesfiches = 'nok';}
            $lesfichesss = $mesfiches;
        }
        elseif($view == 'corbeille')
        {
            $mesfiches = $em->getRepository('BaclooCrmBundle:Fiche')
                ->searchfiche_init_corbeille($nbparpage, $page, $usersess, $societe);
            if(!isset($mesfiches)){$mesfiches = 'nok';}
            $lesfichesss = $mesfiches;
        }
        elseif($view == 'shared')
        {
            $mesfiches = $em->getRepository('BaclooCrmBundle:Fiche')
                ->searchfiche_init_shared($nbparpage, $page, $usersess, $societe);
            if(!isset($mesfiches)){$mesfiches = 'nok';}
            $session->set('id', '0');
            $lesfichesss = $mesfiches;
        }
        else
        {
            $typefiche = 'client';
            include('searchprospects.php');

            if(!isset($mesfiches)){$mesfiches = 'nok';}
        }
        // On crée un objet Search
        $search = new Search;//echo 'ffffffffffffffff';
        $form = $this->createForm(new SearchType(), $search);
        $request = $this->getRequest();
        if ($request->getMethod() == 'POST') {//echo 'persistseach';
            $form->bind($request);
            if ($form->isValid()) {
                // On Flush la recherche
                $data = $form->getData();
                $besoinfilter = $form->get('besoinfilter')->getData();
                $rsfilter = $form->get('rsfilter')->getData();
                $nomfilter = $form->get('nomfilter')->getData();
                $activitefilter = $form->get('activitefilter')->getData();
                $cpfilter = $form->get('cpfilter')->getData();
                $villefilter = $form->get('villefilter')->getData();
                $cperso1filter = $form->get('cperso1filter')->getData();
                $cperso2filter = $form->get('cperso2filter')->getData();
                $cperso3filter = $form->get('cperso3filter')->getData();
                $memofilter = $form->get('memofilter')->getData();
                $histofilter = $form->get('histofilter')->getData();
                $fonctionfilter = $form->get('fonctionfilter')->getData();
                $em = $this->getDoctrine()->getManager();
                $em->persist($search);
                // on flush le tout
                $em->flush();
                $session = new Session();
                $session = $request->getSession();
                $session->set('page', $page);
                $session->set('view', $view);
                $session->set('besoinfilter', $besoinfilter);
                $session->set('rsfilter', $rsfilter);
                $session->set('nomfilter', $nomfilter);
                $session->set('activitefilter', $activitefilter);
                $session->set('cpfilter', $cpfilter);
                $session->set('villefilter', $villefilter);
                $session->set('cperso1filter', $cperso1filter);
                $session->set('cperso2filter', $cperso2filter);
                $session->set('cperso3filter', $cperso3filter);
                $session->set('memofilter', $memofilter);
                $session->set('histofilter', $histofilter);
                $session->set('fonctionfilter', $fonctionfilter);

                // On redirige vers la page de visualisation de recherche
                //ici l'array doit se constituer en fonction des champs de formulaire remplis
                $id = $search->getid();
                return $this->redirect($this->generateUrl('bacloocrm_find', array('id' => $id,
                        'page' => $page,
                        'view' => $view)
                ));
            }
        }
        $session = $request->getSession();
        $vue = $session->get('vue');
        $modules  = $em->getRepository('BaclooCrmBundle:Modules')
            ->findOneByUsername($usersess);

        $besoinfilter = $session->get('besoinfilter');
        if($besoinfilter == null)
        {
            $besoinfilter = 'contient';
        }
        $rsfilter = $session->get('rsfilter');
        if($rsfilter == null)
        {
            $rsfilter = 'contient';
        }
        $nomfilter = $session->get('nomfilter');
        if($nomfilter == null)
        {
            $nomfilter = 'contient';
        }
        $activitefilter = $session->get('activitefilter');
        if($activitefilter == null)
        {
            $activitefilter = 'contient';
        }
        $cpfilter = $session->get('cpfilter');
        if($cpfilter == null)
        {
            $cpfilter = 'contient';
        }
        $villefilter = $session->get('villefilter');
        if($villefilter == null)
        {
            $villefilter = 'contient';
        }
        $cperso1filter = $session->get('cperso1filter');
        if($cperso1filter == null)
        {
            $cperso1filter = 'contient';
        }
        $cperso2filter = $session->get('cperso2filter');
        if($cperso2filter == null)
        {
            $cperso2filter = 'contient';
        }
        $cperso3filter = $session->get('cperso3filter');
        if($cperso3filter == null)
        {
            $cperso3filter = 'contient';
        }
        $memofilter = $session->get('memofilter');
        if($memofilter == null)
        {
            $memofilter = 'contient';
        }
        $histofilter = $session->get('histofilter');
        if($histofilter == null)
        {
            $histofilter = 'contient';
        }
        $fonctionfilter = $session->get('fonctionfilter');
        if($fonctionfilter == null)
        {
            $fonctionfilter = 'contient';
        }

        if($speed == 1)
        {
            return $this->render('BaclooCrmBundle:Crm:searchfiche2.html.twig', array('mesfiches' => $mesfiches,
                'page' => $page,
                'mesfichestot' => $mesfichestot,
                'view' => $view,
                'modules' => $modules,
                'vue' => $vue,
                'lesfichesss' => count($lesfichesss),
                'nombrePage' => ceil(count($lesfichesss)/$nbparpage),
                'besoinfilter' => $besoinfilter,
                'rsfilter' => $rsfilter,
                'nomfilter' => $nomfilter,
                'activitefilter' => $activitefilter,
                'cpfilter' => $cpfilter,
                'villefilter' => $villefilter,
                'cperso1filter' => $cperso1filter,
                'cperso2filter' => $cperso2filter,
                'cperso3filter' => $cperso3filter,
                'memofilter' => $memofilter,
                'histofilter' => $histofilter,
                'fonctionfilter' => $fonctionfilter,
                'form' => $form->createView()));
        }
        else
        {
            return $this->render('BaclooCrmBundle:Crm:searchfiche.html.twig', array('mesfiches' => $mesfiches,
                'page' => $page,
                'mesfichestot' => $mesfichestot,
                'view' => $view,
                'modules' => $modules,
                'vue' => $vue,
                'lesfichesss' => count($lesfichesss),
                'nombrePage' => ceil(count($lesfichesss)/$nbparpage),
                'besoinfilter' => $besoinfilter,
                'rsfilter' => $rsfilter,
                'nomfilter' => $nomfilter,
                'activitefilter' => $activitefilter,
                'cpfilter' => $cpfilter,
                'villefilter' => $villefilter,
                'cperso1filter' => $cperso1filter,
                'cperso2filter' => $cperso2filter,
                'cperso3filter' => $cperso3filter,
                'memofilter' => $memofilter,
                'histofilter' => $histofilter,
                'fonctionfilter' => $fonctionfilter,
                'form' => $form->createView()));
        }
    }

// le paramètre de l'action doit se remplir en fonction des critères de recherche
    public function findAction($id, $page, $view, $speed, Request $request)
    {//echo 'page1'.$page;
        //echo 'lavue1'.$view;
        //echo $id;
        $session = $request->getSession();
        $nbparpage = 15;
        include('societe.php');
        $usersess = $this->get('security.context')->getToken()->getUsername(); if(empty($usersess) or !isset($usersess) or $usersess == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        // On récupère l'EntityManager
        $em = $this->getDoctrine()
            ->getManager();

        $query = $em->createQuery(
            'SELECT u
						FROM BaclooUserBundle:User u
						WHERE u.username = :username'
        )->setParameter('username', $usersess);
        $userdetail = $query->getSingleResult();
        $tags= $userdetail->getTags();
        $actvise= $userdetail->getActvise();
        $activite= $userdetail->getActivite();
        if(empty($tags) OR empty($actvise) OR empty($activite))
        {
            $userdetail->setPlein(0);
            $em->flush();
        }
        elseif(isset($tags) AND isset($actvise) AND isset($activite))
        {
            $userdetail->setPlein(1);
            if($userdetail->getPoint() != 2)
            {
                $userdetail->setPoint(2);
            }
            $em->flush();
        }

        if($id != 0)
        {

            //On récupère les favoris niveau ALL
            $em = $this->getDoctrine()->getManager();
            $query = $em->createQuery(
                'SELECT f.favusername
							FROM BaclooCrmBundle:Favoris f
							WHERE f.favusername = :favusername
							AND f.toutpart = :toutpart'
            )->setParameter('favusername', $usersess);
            $query->setParameter('toutpart', 1);
            $favoriall = $query->getResult();
            //echo 'cbien2 favoriall'.count($favoriall);

            //On créée un tableau sous le modèle 'user'=>$xxxx pour le repository
            if(isset($favoriall) && !empty($favoriall))
            {//echo 'liiiiiii';
                $i = 1;
                foreach($favoriall as $favo)
                {
                    foreach($favo as $fav)
                    {
                        ////echo 'favo'.$fav;
                        //BIZARD
                        $favor  = $em->getRepository('BaclooCrmBundle:Favoris')
                            ->findOneByFavusername($usersess);
                        ${'choix'.$i++} = $favor->getUsername();
                    }
                }
                //echo 'choix1'.$choix1;
                $critere = array($usersess);

                for($j=1;$j<$i;$j++)
                {
                    ${'critere'.$j} = array(${"choix".$j});
                    $critere = array_merge(${'critere'.$j},$critere);
                }

            }
            else
            {
                $critere = array($usersess);
            }
            $search = $em->getRepository('BaclooCrmBundle:Search')->find($id);
            $ficheid = $search->getFicheid();
            $raisonSociale = $search->getRaisonSociale();
            $nom = $search->getNom();
            $besoin = $search->getBesoins();
            $activite = $search->getActivite();
            $cp = $search->getCp();
            $ville = $search->getVille();
            $cperso1 = $search->getCperso1();
            $cperso2 = $search->getCperso2();
            $cperso3 = $search->getCperso3();
            $memo = $search->getMemo();
            $histo = $search->getHisto();
            $fonction = $search->getFonction();
            $searchsess = $search;
            $besoinfilter = $session->get('besoinfilter');
            $rsfilter = $session->get('rsfilter');
            $nomfilter = $session->get('nomfilter');
            $activitefilter = $session->get('activitefilter');
            $cpfilter = $session->get('cpfilter');
            $villefilter = $session->get('villefilter');
            $cperso1filter = $session->get('cperso1filter');
            $cperso2filter = $session->get('cperso2filter');
            $cperso3filter = $session->get('cperso3filter');
            $memofilter = $session->get('memofilter');
            $histofilter = $session->get('histofilter');
            $fonctionfilter = $session->get('fonctionfilter');
            $fiche = new Fiche;
            $em = $this->getDoctrine()->getManager();
            $resultats = $em->getRepository('BaclooCrmBundle:Fiche')
                ->searchfiche($raisonSociale, $view, $nom, $activite, $besoin, $nbparpage, $page, $societe, $cp, $ville, $cperso1, $cperso2, $cperso3, $memo, $histo, $fonction,
                    $besoinfilter, $rsfilter, $nomfilter, $activitefilter, $cpfilter, $villefilter, $cperso1filter, $cperso2filter, $cperso3filter, $memofilter, $histofilter, $fonctionfilter);
            // echo count($resultats);
            if(isset($resultats))
            {//echo 'set'.$id;
                $session = new Session();
                $session = $request->getSession();
                // $session->remove('idsearch');
                $session->set('page', $page);
                $session->set('view', $view);
                //c'est icic que se décide la sessionde ID

                //$idsearch = $session->get('idsearch');
                // $session->set('id', $idsearch);
                //echo 'id2'.$idsearch.'<<';


            }else
            {//echo 'pas de résultat';
                // $session = new Session();
                // $session = $request->getSession();
                // $session->set('page', $page);
                // $session->set('view', $view);
                // $session->set('id', 0);

            }
            $lesfichesss = $resultats;
            // echo 'id pas 0';echo $view;
        }
        elseif($id == 'xxx')
        {
            $offresdumois = $em->getRepository('BaclooCrmBundle:Locata')
                ->offresdumoisgroupe($page);
            $resultats = array();
            foreach($offresdumois as $of)
            {
                $resultats[] = $em->getRepository('BaclooCrmBundle:Fiche')
                    ->findOneByRaisonSociale($of->getClient());
                $lesfichesss = $resultats;
                // echo '**'.$of->getClient().'**';
            }
        }
        else
        {
            $idsearch = 0;
            $session = new Session();
            $session = $request->getSession();
            $session->set('page', $page);
            $session->set('view', $view);
            // $session->set('id', $id);
            //On récupère les favoris niveau ALL
            $em = $this->getDoctrine()->getManager();
            $query = $em->createQuery(
                'SELECT f.favusername
							FROM BaclooCrmBundle:Favoris f
							WHERE f.favusername = :favusername
							AND f.toutpart = :toutpart'
            )->setParameter('favusername', $usersess);
            $query->setParameter('toutpart', 1);
            $favoriall = $query->getResult();
            //echo 'cbien2 favoriall'.count($favoriall);

            //On créée un tableau sous le modèle 'user'=>$xxxx pour le repository
            if(isset($favoriall) && !empty($favoriall))
            {//echo 'liiiiiii';
                $i = 1;
                foreach($favoriall as $favo)
                {
                    foreach($favo as $fav)
                    {
                        ////echo 'favo'.$fav;
                        $favor  = $em->getRepository('BaclooCrmBundle:Favoris')
                            ->findOneByFavusername($usersess);
                        ${'choix'.$i++} = $favor->getUsername();
                    }
                }
                //echo 'choix1'.$choix1;
                $critere = array($usersess);

                for($j=1;$j<$i;$j++)
                {
                    ${'critere'.$j} = array(${"choix".$j});
                    $critere = array_merge(${'critere'.$j},$critere);
                }

            }
            else
            {
                $critere = array($usersess);
            }
            // echo 'ici'.$view;
            if($view == 'client')
            {//echo ' on est client';
                $typefiche = $view;
                include('searchprospects.php');

                if(!isset($mesfiches)){$mesfiches = 'nok';}
            }
            elseif($view == 'prospect')
            {//echo ' on est prospectooo';
                $typefiche = $view;
                include('searchprospects.php');

                if(!isset($mesfiches)){$mesfiches = 'nok';}
            }
            elseif($view == 'fournisseur')
            {//echo ' on est prospectooo';
                $typefiche = $view;
                include('searchprospects.php');

                if(!isset($mesfiches)){$mesfiches = 'nok';}
            }
            elseif($view == 'annuaire')
            {//echo ' on est annuaire';
                $typefiche = 'prospect';
                include('searchprospects.php');

                if(!isset($mesfiches)){$mesfiches = 'nok';}
            }
            elseif($view == 'corbeille')
            {//echo ' on est corbeille';
                $mesfiches = $em->getRepository('BaclooCrmBundle:Fiche')
                    ->searchfiche_init_corbeille($nbparpage, $page, $usersess);
                if(!isset($mesfiches)){$mesfiches = 'nok';}
                $lesfiches = $mesfiches;
                $lesfichesss = $mesfiches;
            }
            elseif($view == 'search')
            {//echo ' on est search';
                $mesfiches = 'nok';
                $lesfiches = $mesfiches;
            }//echo 'la vue'.$view;
            $resultats = $mesfiches;

        }
        $besoinfilter = $session->get('besoinfilter');
        if($besoinfilter == null)
        {
            $besoinfilter = 'contient';
        }
        $rsfilter = $session->get('rsfilter');
        if($rsfilter == null)
        {
            $rsfilter = 'contient';
        }
        $nomfilter = $session->get('nomfilter');
        if($nomfilter == null)
        {
            $nomfilter = 'contient';
        }
        $activitefilter = $session->get('activitefilter');
        if($activitefilter == null)
        {
            $activitefilter = 'contient';
        }
        $cpfilter = $session->get('cpfilter');
        if($cpfilter == null)
        {
            $cpfilter = 'contient';
        }
        $villefilter = $session->get('villefilter');
        if($villefilter == null)
        {
            $villefilter = 'contient';
        }
        $cperso1filter = $session->get('cperso1filter');
        if($cperso1filter == null)
        {
            $cperso1filter = 'contient';
        }
        $cperso2filter = $session->get('cperso2filter');
        if($cperso2filter == null)
        {
            $cperso2filter = 'contient';
        }
        $cperso3filter = $session->get('cperso3filter');
        if($cperso3filter == null)
        {
            $cperso3filter = 'contient';
        }
        $memofilter = $session->get('memofilter');
        if($memofilter == null)
        {
            $memofilter = 'contient';
        }
        $histofilter = $session->get('histofilter');
        if($histofilter == null)
        {
            $histofilter = 'contient';
        }
        $fonctionfilter = $session->get('fonctionfilter');
        if($fonctionfilter == null)
        {
            $fonctionfilter = 'contient';
        }
        if(!empty($resultats) && isset($resultats) && $resultats != 'nok')
        {//echo ' esttttttttttttttt ';echo $view;echo count($lesfiches);
            // On crée un objet Search

            $session = $request->getSession();
            $init = $session->get('init');//echo 'init sess'.$init;
            $searchf = new Search;
            //echo 'ggggggggggggggggg';echo $request->getMethod();
            $form = $this->createForm(new SearchType(), $searchf);
            $request = $this->getRequest();
            if ($request->getMethod() == 'POST') {
                $form->bind($request);
                if ($form->isValid()) {
                    // On Flush la recherche
                    $em = $this->getDoctrine()->getManager();
                    $em->persist($searchf);
                    // on flush le tout
                    $em->flush();
                    // echo 'lavue3'.$view;
                    // On redirige vers la page de visualisation de recherche
                    return $this->redirect($this->generateUrl('bacloocrm_find', array('id' => $idsearch, 'view' => $view)));//getID ?? non ?
                }
            }
            //echo 'la'.$page;
            //echo 'lavue2'.$view;
            $session = $request->getSession();
            //$id = $session->get('id');//echo 'iiddddd'.$session->get('id');
            $page = $session->get('page');
            $view = $session->get('view');
            $modules  = $em->getRepository('BaclooCrmBundle:Modules')
                ->findOneByUsername($usersess);
            // echo $view;echo count($lesfiches);
            if($speed == 1)
            {//echo 'balbalbal';
                return $this->render('BaclooCrmBundle:Crm:search3.html.twig', array(
                    'page' => $page,
                    'user' => $usersess,
                    'modules' => $modules,
                    'view' => $view,
                    'speed' => $speed,
                    'init' => $init,
                    'id' => $id,
                    'lesfichesss' => count($lesfichesss),
                    'nombrePage' => ceil(count($lesfichesss)/$nbparpage),
                    'resultats' => $resultats,
                    'actvise' => $actvise,
                    'activite' => $activite,
                    'tags' => $tags,
                    'rsfilter' => $rsfilter,
                    'nomfilter' => $nomfilter,
                    'activitefilter' => $activitefilter,
                    'cpfilter' => $cpfilter,
                    'villefilter' => $villefilter,
                    'cperso1filter' => $cperso1filter,
                    'cperso2filter' => $cperso2filter,
                    'cperso3filter' => $cperso3filter,
                    'memofilter' => $memofilter,
                    'histofilter' => $histofilter,
                    'fonctionfilter' => $fonctionfilter,
                    'form' => $form->createView()));
            }
            else
            {
                if($id == 0){
                    // $search = $em->getRepository('BaclooCrmBundle:Search')->find($id);
                    $search = $resultats;
                }
                elseif($id ='xxx')
                {
                    $search = $resultats;
                }
                // foreach($resultats as $res){echo '>'.$res->getRaisonSociale().'<';}
                // echo 'ooo'.$id.'lllllll'.$search->getId();
                return $this->render('BaclooCrmBundle:Crm:search.html.twig', array(
                    'id' => $id,
                    'idsearchrap' => 0,
                    'search' => $search,
                    'page' => $page,
                    'pagesr' => 1,
                    'user' => $usersess,
                    'modules' => $modules,
                    'view' => $view,
                    'lesfichesss' => count($lesfichesss),
                    'vue' => 'rappels',
                    'nombrePage' => ceil(count($lesfichesss)/$nbparpage),
                    'resultats' => $resultats, // C'est ici tout l'intérêt : le contrôleur passe les variables nécessaires au template !
                    'tags' => $tags,
                    'actvise' => $actvise,
                    'activite' => $activite,
                    'besoinfilter' => $besoinfilter,
                    'rsfilter' => $rsfilter,
                    'nomfilter' => $nomfilter,
                    'activitefilter' => $activitefilter,
                    'cpfilter' => $cpfilter,
                    'villefilter' => $villefilter,
                    'cperso1filter' => $cperso1filter,
                    'cperso2filter' => $cperso2filter,
                    'cperso3filter' => $cperso3filter,
                    'memofilter' => $memofilter,
                    'histofilter' => $histofilter,
                    'fonctionfilter' => $fonctionfilter,
                    'form' => $form->createView()
                ));
            }

        }
        else{//echo ' onnnnnnnnnnnnnn ';
            // On crée un objet Search
            $searchf = new Search;
            $form = $this->createForm(new SearchType(), $searchf);
            $request = $this->getRequest();
            if ($request->getMethod() == 'POST') {
                $form->bind($request);
                if ($form->isValid()) {
                    // On Flush la recherche
                    $em = $this->getDoctrine()->getManager();
                    $em->persist($searchf);
                    // on flush le tout
                    $em->flush();

                    //echo 'lavue4'.$view;
                    // On redirige vers la page de visualisation de recherche
                    // return $this->redirect($this->generateUrl('bacloocrm_find', array('id' => $search->getFicheid(), 'view' => $view)));
                }
            }

            //echo 'totaaaaaaaaaaaaa'.count($lesfichesss);
            $modules  = $em->getRepository('BaclooCrmBundle:Modules')
                ->findOneByUsername($usersess);
            return $this->render('BaclooCrmBundle:Crm:search.html.twig', array('idsearchrap' => 0,
                'pagesr' => 1,
                'form' => $form->createView(),
                'tags' => $tags,'actvise' => $actvise,
                'activite' => $activite,
                'user' => $usersess,
                'modules' => $modules,
                'view' => $view,
                'besoinfilter' => $besoinfilter,
                'rsfilter' => $rsfilter,
                'nomfilter' => $nomfilter,
                'activitefilter' => $activitefilter,
                'cpfilter' => $cpfilter,
                'villefilter' => $villefilter,
                'cperso1filter' => $cperso1filter,
                'cperso2filter' => $cperso2filter,
                'cperso3filter' => $cperso3filter,
                'memofilter' => $memofilter,
                'histofilter' => $histofilter,
                'fonctionfilter' => $fonctionfilter));
        }

    }

    public function searchrappelsAction($idsearchrap, $page, $vue, $speed, Request $request){
        $user= $this->get('security.context')->getToken()->getUsername(); if(empty($user) or !isset($user) or $user == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        // Avant de lancer une recherche on vide la table rapsearch
        $em = $this->getDoctrine()->getManager();
        // echo 'YYYYYY'.$page;
        if(!isset($idsearchrap)){$idsearchrap = 0;}
        $id = $idsearchrap;//echo 'iddd'.$id;

        $session = $request->getSession();
        if($id != 'xxx' || $id == 0)
        {
            $du = $session->get('du');
            $au = $session->get('au');//print_r($au);
        }
        elseif($id == 'xxx')
        {//echo 'mmmmmmmm';echo $id;
            $session->set('pagesr',1);
            $du = '2013-01-01';
            $au = date('Y-m-d');
            $session->set('du', $du);
            $session->set('au', $au);
        }

        $vue = $session->get('vue');//echo 'session vue'.$vue;
        $viewb = $session->get('view');//echo 'viewb'.$viewb;
        $page = $session->get('pagesr');//echo 'XXXXXXX'.$page;

        if(!isset($du) && !isset($au))
        {
            $du = '2013-01-01';
            $au = date('Y-m-d');
        }

        if(!isset($vue))
        {
            $vue = 'rappels';
        }

        if(!isset($page))
        {
            $page = 1;
        }

        if(!isset($idsearchrap))
        {
            $id = 0;
        }

        if($vue == 'rappels')
        {
            //$fiche = new Fiche;
            $fiche = $em->getRepository('BaclooCrmBundle:Fiche')
                ->searchrap($du, $au, 10, $page, $user);
            //$id = 0;
            $session->set('vue', $vue);
        }
        elseif($vue == 'a_faire')
        {
            $fiche = $em->getRepository('BaclooCrmBundle:Fiche')
                ->searcha_faire($du, $au, 10, $page, $user);
            //$id = 0;
            $session = new Session();
            $session->set('vue', $vue);
        }
        elseif($vue == 'rdv')
        {
            $fiche = $em->getRepository('BaclooCrmBundle:Fiche')
                ->searchrdv($du, $au, 10, $page, $user);
            //$id = 0;
            $session->set('vue', $vue);
        }
        elseif($vue == 'all')
        {
            $fiche = $em->getRepository('BaclooCrmBundle:Fiche')
                ->searchallrap($du, $au, 10, $page, $user);
            //$id = 0;
            $session->set('vue', $vue);
        }
        else
        {
            //$fiche = new Fiche;
            $fiche = $em->getRepository('BaclooCrmBundle:Fiche')
                ->searchrap($du, $au, 10, $page1, $user);
            // $id = 0;
            $session->set('vue', $vue);
        }//echo 'session vue2'.$vue;

        $rapsearch = new Rapsearch;//echo 'rapsearch';
        $form = $this->createForm(new RapsearchType(), $rapsearch);
        $request = $this->getRequest();
        if ($request->getMethod() == 'POST') {//echo 'postrap';
            $form->bind($request);
            if ($form->isValid())
            {
                // On Flush la recherche
                $em = $this->getDoctrine()->getManager();
                $em->persist($rapsearch);
                // on flush le tout
                $em->flush();
                $session->set('vue', $vue);
                $session->set('du', $du);
                $session->set('au', $au);
                // On redirige vers la page de visualisation de recherche

                return $this->redirect($this->generateUrl('bacloocrm_showrappels', array('id' => $id, 'vue'=> $vue)
                ));
            }
        }
        // echo 'rap pas post   ';	echo $request->getMethod();

        $modules  = $em->getRepository('BaclooCrmBundle:Modules')
            ->findOneByUsername($user);

        if($speed == 1)
        {
            return $this->render('BaclooCrmBundle:Crm:searchdate2.html.twig', array('id' => $id,
                'page' => $page,
                'nombrePage' => ceil(count($fiche)/10),
                'fiche' => $fiche, // C'est ici tout l'intérêt : le contrôleur passe les variables nécessaires au template !
                'du' => $du,
                'modules' => $modules,
                'au'=> $au,
                'vue'=> $vue,
                'p'=> '1',
                'user' => $user,
                'form' => $form->createView()
            ));
        }
        else
        {
            return $this->render('BaclooCrmBundle:Crm:searchdate.html.twig', array('id' => $id,
                'page' => $page,
                'nombrePage' => ceil(count($fiche)/10),
                'fiche' => $fiche, // C'est ici tout l'intérêt : le contrôleur passe les variables nécessaires au template !
                'du' => $du,
                'modules' => $modules,
                'au'=> $au,
                'vue'=> $vue,
                'p'=> '1',
                'user' => $user,
                'useracc' => $user,
                'form' => $form->createView()
            ));
        }

    }

    public function showrappelsAction($page, $pagesr, $id, $vue, Request $request){//echo 'showrap';
        if(!isset($page) || $page == 0){$page =1;}//echo $page;
        $user= $this->get('security.context')->getToken()->getUsername(); if(empty($user) or !isset($user) or $user == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        $em = $this->getDoctrine()->getManager();
        $useracc = $user;
// echo 'page'.$pagesr;
        $session = $request->getSession();
        if($id != 'xxx')
        {//echo 'ici';
            $du = $session->get('du');
            $au = $session->get('au');//print_r($au);
            $session->set('pagesr', $pagesr);
        }
        elseif($id == 'xxx')
        {
            $session->set('pagesr',1);
            $du = '2013-01-01';
            $au = date('Y-m-d');
            $session->set('du', $du);
            $session->set('au', $au);
        }
        $vue = $session->get('vue');//echo 'session vue'.$vue;
        $viewb = $session->get('view');//echo 'viewb'.$viewb;
        $pagesr = $session->get('pagesr');
        if(isset($viewb))
        {
            $view = $viewb;
        }

        if(!isset($id))
        {
            $id = 0;
        }

        if(!isset($du) && !isset($au))
        {
            $du = '2013-01-01';
            $au = date('Y-m-d');
        }

        if(!isset($vue))
        {
            $vue = 'rappels';
        }

        if($vue == 'rappels')
        {
            if($id == 0){//echo 'pas de rech';
                $em = $this->getDoctrine()->getManager();
                $rapsearch = new Rapsearch;
                $du = '2013-01-01';
                $au = date('Y-m-d');
                $fiche = new Fiche;
                $resultrap = $em->getRepository('BaclooCrmBundle:Fiche')
                    ->searchrap($du, $au, 10, $pagesr, $user);
            }
            else{//echo 'rech';
                // echo $id;
                $em = $this->getDoctrine()->getManager();
                $rapsearch = $em->getRepository('BaclooCrmBundle:Rapsearch')->find($id);
                $du = $rapsearch->getDu();
                $au = $rapsearch->getAu();
                $fiche = new Fiche;
                $resultrap = $em->getRepository('BaclooCrmBundle:Fiche')
                    ->searchrap($du, $au, 10, $pagesr, $user);
                // $listeBr = array();
                // foreach ($fiche->getBrappels() as $br) {
                // $listeBr[] = $br;
                // }
            }
            $session->set('vue', $vue);
        }
        elseif($vue == 'a_faire')
        {
            if($id == 0){//echo 'pas de rech';
                $em = $this->getDoctrine()->getManager();
                $rapsearch = new Rapsearch;
                $du = '2013-01-01';
                $au = date('Y-m-d');
                $fiche = new Fiche;
                $resultrap = $em->getRepository('BaclooCrmBundle:Fiche')
                    ->searcha_faire($du, $au, 10, $pagesr, $user);
            }
            else{//echo 'rech';
                // echo $id;
                $em = $this->getDoctrine()->getManager();
                $rapsearch = $em->getRepository('BaclooCrmBundle:Rapsearch')->find($id);
                $du = $rapsearch->getDu();
                $au = $rapsearch->getAu();
                $fiche = new Fiche;
                $resultrap = $em->getRepository('BaclooCrmBundle:Fiche')
                    ->searcha_faire($du, $au, 10, $pagesr, $user);
                // $listeBr = array();
                // foreach ($fiche->getBrappels() as $br) {
                // $listeBr[] = $br;
                // }
            }
            $session->set('vue', $vue);
        }
        elseif($vue == 'rdv')
        {
            if($id == 0){//echo 'pas de rech';
                $em = $this->getDoctrine()->getManager();
                $rapsearch = new Rapsearch;
                $du = '2013-01-01';
                $au = date('Y-m-d');
                $fiche = new Fiche;
                $resultrap = $em->getRepository('BaclooCrmBundle:Fiche')
                    ->searchrdv($du, $au, 10, $pagesr, $user);
            }
            else{//echo 'rech';
                // echo $id;
                $em = $this->getDoctrine()->getManager();
                $rapsearch = $em->getRepository('BaclooCrmBundle:Rapsearch')->find($id);
                $du = $rapsearch->getDu();
                $au = $rapsearch->getAu();
                $fiche = new Fiche;
                $resultrap = $em->getRepository('BaclooCrmBundle:Fiche')
                    ->searchrdv($du, $au, 10, $pagesr, $user);
                // $listeBr = array();
                // foreach ($fiche->getBrappels() as $br) {
                // $listeBr[] = $br;
                // }
            }
            $session->set('vue', $vue);
        }
        elseif($vue == 'all')
        {
            if($id == 0){//echo 'pas de rech';
                $em = $this->getDoctrine()->getManager();
                $rapsearch = new Rapsearch;
                $du = '2013-01-01';
                $au = date('Y-m-d');
                $fiche = new Fiche;
                $resultrap = $em->getRepository('BaclooCrmBundle:Fiche')
                    ->searchallrap($du, $au, 10, $pagesr, $user);
            }
            else{//echo 'rech';
                // echo $id;
                $em = $this->getDoctrine()->getManager();
                $rapsearch = $em->getRepository('BaclooCrmBundle:Rapsearch')->find($id);
                $du = $rapsearch->getDu();
                $au = $rapsearch->getAu();
                $fiche = new Fiche;
                $resultrap = $em->getRepository('BaclooCrmBundle:Fiche')
                    ->searchallrap($du, $au, 10, $pagesr, $user);
                // $listeBr = array();
                // foreach ($fiche->getBrappels() as $br) {
                // $listeBr[] = $br;
                // }
            }
            $session->set('vue', $vue);
        }


        if(!empty($resultrap)){	//echo 'resultrap pas vide';
            $form = $this->createForm(new RapsearchType(), $rapsearch);
            $request = $this->getRequest();
            if ($request->getMethod() == 'POST') {//echo 'post';
                $form->bind($request);
                $data = $form->getData();
                if ($form->isValid()) {
                    // On Flush la recherche

                    $du = $form->get('du')->getData();
                    $au= $form->get('au')->getData();

                    $session->set('du', $du);
                    $session->set('au', $au);
                    $em = $this->getDoctrine()->getManager();
                    $em->persist($rapsearch);
                    // on flush le tout
                    $em->flush();
                    // On définit un message flash sympa
                    $rapsearchi = $em->getRepository('BaclooCrmBundle:Rapsearch')
                        ->findOneBy(array('du'=> $du, 'au'=> $au));
                    $id= $rapsearchi->getid();
                    $session->set('idsearchrap', $id);
                    $this->get('session')->getFlashBag()->add('info', 'votre recherche a été soumise');
                    // On redirige vers la page de visualisation de recherche
                    //ici l'array doit se constituer en fonction des champs de formulaire remplis


                    return $this->redirect($this->generateUrl('bacloocrm_showrappels', array('id' => $id,'vue'=> $vue)
                    ));
                }
            }//echo 'pas post'.count($resultrap);
            // $rapsearch = $em->getRepository('BaclooCrmBundle:Rapsearch')->findOneById($id);

            // $em-> remove($rapsearch);

            // $em->flush();
            $modules  = $em->getRepository('BaclooCrmBundle:Modules')
                ->findOneByUsername($user);

            return $this->render('BaclooCrmBundle:Crm:search2.html.twig', array(
                'resultrap' => $resultrap,
                'au' => $au,
                'vue' => $vue,
                'useracc' => $useracc,
                'modules' => $modules,
                'page' => $page,
                'pagesr' => $pagesr,
                'nombrePage' => ceil(count($resultrap)/10),
                'id' => $id,
                'form' => $form->createView()
            ));
        }
        else{//echo 'resultrap plein';
            $du = '2013-01-01';
            $au = date('Y-m-d');
            // $fiche = new Fiche;
            $em = $this->getDoctrine()->getManager();
            $fiche = $em->getRepository('BaclooCrmBundle:Fiche')
                ->searchrap($du, $au, 10, $pagesr, $user);
            $rapsearch = new Rapsearch;
            $form = $this->createForm(new RapsearchType(), $rapsearch);
            $request = $this->getRequest();
            if ($request->getMethod() == 'POST') {
                $form->bind($request);
                if ($form->isValid()) {
                    $du = $rapsearch->getdu();
                    $au = $rapsearch->getau();
                    return $this->redirect($this->generateUrl('bacloocrm_showrappels', array('id' => $id,'vue'=> $vue)
                    ));
                }
            }
            $modules  = $em->getRepository('BaclooCrmBundle:Modules')
                ->findOneByUsername($user);
            return $this->render('BaclooCrmBundle:Crm:search2.html.twig', array(
                'resultrap' => $resultrap,
                'page' => $page,
                'pagesr' => $pagesr,
                'nombrePage' => ceil(count($resultrap)/10),
                'fiche' => $fiche,
                'useracc' => $useracc,
                'modules' => $modules,
                'id' => $id,
                'vue' => $vue,
                'form' => $form->createView()
            ));
        }
    }

    //Compte les prospects potentiel dans le bandeau du haut
    public function showprospotAction($mode, Request $request)
    {
        $usersess = $this->get('security.context')->getToken()->getUsername();//Récupère le nom d'utilisateur
        $em = $this->getDoctrine()->getManager();
        $query = $em->createQuery(
            'SELECT u
				FROM BaclooUserBundle:User u
				WHERE u.username = :username'
        )->setParameter('username', $usersess);
        $userdetail = $query->getSingleResult();
        $actvise= $userdetail->getActvise();
        $tabtags = $userdetail->getTags();

        $activisse = str_replace(", ", ",", $actvise);
        $actv	   = explode(",", $activisse);
        if(empty($actv)){$actv = 0;}
        // si tags, on sort les prospects correspondants qu'on stock dans $fiche (instance de Fiche)
        $tagss = str_replace(", ", ",", $tabtags);
        $tags = explode(",", $tagss);
        // if(empty($tabtags)){echo 'yagsu vide';}else{echo 'tagsu plein';}
        // if(!isset($actvise)){echo 'actv vide';}else{echo 'actv plein';}
        if(empty($actvise) && empty($tabtags))
        {//echo 'ici';
            $i = 0;
        }
        else
        {//echo 'la';
            $i = $this->get('session')->get('countprospot');//echo 'iiiiiiiiiiiiiiiiiiiii'.$refresh;
            if(!isset($i))
            {
                return $this->redirect($this->generateUrl('fos_user_security_logout'));
            }
        }
        return $this->render('BaclooCrmBundle:Crm:opportunity.html.twig', array(
            'prospot' => $i,
            'mode'	  => $mode));
    }

    public function showprospotlistAction($page, $nbresult, $insert, Request $request)
    {
        $usersess = $this->get('security.context')->getToken()->getUsername(); if(empty($usersess) or !isset($usersess) or $usersess == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}//Récupère le nom d'utilisateur
        $nbparpage = 20;

        if($this->getRequest()->request->get('pagination') > 0)
        {
            $page = $this->getRequest()->request->get('pagination');
            // echo 'la page2'.$page;
        }
        $em = $this->getDoctrine()->getManager();
        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($usersess);

        //On récupère l'id de l'utilisateur connecté
        $uid = $userdetails->getId();
        // echo $request->getMethod();
        if($insert == 'nok')
        { //echo 'insert nok';
            $prospota = $em->getRepository('BaclooCrmBundle:Prospects')
                ->findOneByUserid($uid);

            // On créé le formulaire
            $form = $this->createForm(new ProspectsType(), $prospota);
            // on soumet la requete
            $request = $this->getRequest();

            if ($this->getRequest()->request->get('masquer') == 'Masquer la sélection')
            {
                if ($request->getMethod() == 'POST') {//echo 'POST';
                    // On fait le lien Requête <-> Formulaire
                    $form->bind($request);
                    if ($form->isValid())
                    {//echo 'form valide';
                        // if(!empty($form)){echo'plein';}else{echo'vide';}
                        //on rend invisible les prospots qui ont été suppr
                        foreach ($form->get('prospot')->getData() as $rb)
                        {//pour chaque prospot en bdd
                            // echo '$originalprospo->getRaisonSociale()'.$originalprospo->getRaisonSociale().'<------';
                            // echo '$rb->getRaisonSociale()'.$rb->getRaisonSociale();

                            // echo 'DIFFERENT';
                            $em = $this->getDoctrine()
                                ->getManager();
                            if($rb->getVoir() == true)
                            {//echo 'true?';	if($rb->getRaisonSociale()=='jmr'){echo'jolo';}else{echo'pasj';}
                                $prospot = $em->getRepository('BaclooCrmBundle:Prospot')
                                    ->findOneBy(array('user' => $rb->getUser(), 'RaisonSociale' => $rb->getRaisonSociale()));
                                // echo $prospot->getUser();
                                $prospot->setVoir(true);
                                $prospot->setMasquer(1);
                                $em->detach($prospota);
                                $em->persist($prospot);

                                $em->flush();
                            }
                        }
                        // On enregistre les prospects en base de donnée afin d'avoir son id
                        return $this->redirect($this->generateUrl('bacloocrm_showprospotlist', array('nbresult' => $nbresult, 'page' => $page, 'insert' => 'nok')));
                    }
                }
                return $this->redirect($this->generateUrl('bacloocrm_showprospotlist', array('nbresult' => $nbresult, 'page' => $page, 'insert' => 'nok')));
            }
            elseif ($this->getRequest()->request->get('pagination') == $page)
            {
                if ($request->getMethod() == 'POST')
                {//echo 'POST';
                    // On fait le lien Requête <-> Formulaire
                    $form->bind($request);
                    if ($form->isValid())
                    {
                        // foreach ($form->get('prospot')->getData() as $rb)
                        // {
                        // $em->persist($prospot);
                        // $em->flush();
                        // }
                        return $this->redirect($this->generateUrl('bacloocrm_showprospotlist', array('nbresult' => $nbresult, 'page' => $page, 'insert' => 'nok')));
                    }
                }
                return $this->redirect($this->generateUrl('bacloocrm_showprospotlist', array('nbresult' => $nbresult, 'page' => $page, 'insert' => 'nok')));
            }

        }
        else
        {

            $em = $this->getDoctrine()->getManager();
            //On récupère le nombre de prospects de ce user
            $prospinit  = $em->getRepository('BaclooCrmBundle:Prospot')
                ->findByUser($usersess);
            $nbprospotinit = count($prospinit);

            $tabact = array('',',',' de',' du',' avec',' dans',' pour',' des',' les', ' et', ' à', ' au', '&', ' en', 'd\'');
            $tabact2 = str_replace($tabact, '', $userdetails->getTags());
            $splitby = array('',',');
            $text    = $tabact2;
            $pattern = '/\s'.implode($splitby, '\s?|\s?').'\s?/';
            $tagsu   = preg_split($pattern, $text, -1, PREG_SPLIT_NO_EMPTY);

            //On récupère les activités visées de l'utilisateur
            $actvise   = $userdetails->getActvise();
            $activisse = str_replace(", ", ",", $actvise);
            $actv	   = explode(",", $activisse);

            function str_to_noaccent($str)
            {
                $url = $str;
                $url = preg_replace('#Ç#', 'C', $url);
                $url = preg_replace('#ç#', 'c', $url);
                $url = preg_replace('#è|é|ê|ë#', 'e', $url);
                $url = preg_replace('#È|É|Ê|Ë#', 'E', $url);
                $url = preg_replace('#à|á|â|ã|ä|å#', 'a', $url);
                $url = preg_replace('#@|À|Á|Â|Ã|Ä|Å#', 'A', $url);
                $url = preg_replace('#ì|í|î|ï#', 'i', $url);
                $url = preg_replace('#Ì|Í|Î|Ï#', 'I', $url);
                $url = preg_replace('#ð|ò|ó|ô|õ|ö#', 'o', $url);
                $url = preg_replace('#Ò|Ó|Ô|Õ|Ö#', 'O', $url);
                $url = preg_replace('#ù|ú|û|ü#', 'u', $url);
                $url = preg_replace('#Ù|Ú|Û|Ü#', 'U', $url);
                $url = preg_replace('#ý|ÿ#', 'y', $url);
                $url = preg_replace('#Ý#', 'Y', $url);

                return ($url);
            }


            //DEBUT MENAGE TABLE PROSPOT au cas ou le user a modif/suppr ses tags ou actvise
            //!!!!!Verifier s'il y a des occurences des mots clés actuels dans les prospo et virer tous les
            //prospo qui n'ont pas d'occurence. Pour ce faire exploser les mots clés comme dnas la recherche de prospot dans fiche
            // et à chaque itération faire le remove.

            if(empty($tagsu) && empty($actvise))//Si le user n'a pas de tags et d'activités visées
            {
                // echo 'tagsu vide';
                //On la vire des fiches vendables

                //On le vire des interresses
                $listintfiche2  = $em->getRepository('BaclooCrmBundle:interresses')
                    ->findByUsername($usersess);
                foreach($listintfiche2 as $list2)
                {
                    $em->remove($list2);
                    $em->flush();
                }
                //On la vire des fiches prospot
                $listintfiche3  = $em->getRepository('BaclooCrmBundle:Prospot')
                    ->findByUser($usersess);

                foreach($listintfiche3 as $list3)
                {
                    $em->remove($list3);
                    $em->flush();
                }
            }
            else // S'il a des tags OU des activités visées : on vire les prospot qui n'ont plus de correspondance
            {
                // echo 'tagsu pas vide';
                //On fait la même pour chacun des tags
                foreach($prospinit as $prospi)
                {
                    $p = 0;
                    foreach($tagsu as $tags)
                    {
                        // echo $tags; echo ' vs '.$prospi->getBesoins();
                        if(stristr(str_to_noaccent($prospi->getBesoins()), str_to_noaccent($tags)))//si la chaine de caractère commence pas le tag
                        {
                            $p = 1;
                        }
                    }
                    foreach($actv as $act)
                    {
                        // echo $act; echo ' vs '.$prospi->getActivite();
                        if(stristr(str_to_noaccent($prospi->getActivite()), str_to_noaccent($act)))//si la chaine de caractère commence pas le tag
                        {
                            $p = 1;
                        }
                    }
                    //echo' p= '.$p;
                    if($p == 0)//Si aucun prosppot ne correspond aux tags de l'utilisateur
                    {//echo 'suppr';
                        $em->remove($prospi);
                        $em->flush();
                    }
                }
            }
            // FIN DU MENAGE

            //Début ajout des prospects
            set_time_limit(300);
            // if(empty($tagsu)){echo 'yagsu vide';}else{echo 'tagsu plein';}
            // if(!isset($actvise)){echo 'actv vide';}else{echo 'actv plein';}
            if(empty($tagsu) && empty($actvise)){
                $fiche = 0;//si pas de tags alors pas de prospects
            }
            else //s'il a des tags ou des actvises => on insère
            {
                //On récupère l'array avec  les prospot
                // echo 't la';
                // var_dump($tagsu);
                // var_dump($actv);
                //$em->clear();
                $fiche = $em->getRepository('BaclooCrmBundle:Fiche')
                    ->prospotlist($tagsu, $actv, $usersess);// on obtient la liste des prospects


                //$fiche = array_slice($fiches, $limitebasse, $nbparpage);//echo 'nbslice'.count($fiche);
            }

            //On regarde si l'utilisateur connecté est déja entegistré dnas la table prospects
            $em2 = $this->getDoctrine()
                ->getManager()
                ->getRepository('BaclooCrmBundle:Prospects');
            $prospects = $em2->findOneByUserid($uid);

            //On récupère les anciens prospot proposés à l'utilisateur connecté
            $em = $this->getDoctrine()
                ->getManager()
                ->getRepository('BaclooCrmBundle:Prospot');
            $prospotaa = $em->findByUser($usersess);

            if(empty($prospects))//Si utilisateur pas enregistré dans prospect on l'insère
            {
                // echo 'ajout prospects';
                // On enregistre le userid dans prospects
                $prospects = new Prospects();
                $prospects->setUserid($uid);
                $em = $this->getDoctrine()->getManager();
                $em->persist($prospects);
                $em->flush();

            }

            //Maintenant que prospect a son uid on enregistre les prospots
            //pour chaque prospect proposé, on regarde s'il a déjà été proposé
            if(isset($fiche) && !empty($fiche))
            {
                foreach($fiche as $fic)// pour chaque fiche trouvée
                {
                    if(isset($prospotaa) && !empty($prospotaa))// Si des prospects lui ont deja été proposés on compare aux nouveaux avant d'ajouter
                    {
                        //on cherche prospect bdd qui correspond a prospect trouvé
                        $em = $this->getDoctrine()
                            ->getManager()
                            ->getRepository('BaclooCrmBundle:Prospot');
                        $prospotok = $em->findOneBy(array('RaisonSociale' => $fic->GetRaisonSociale(), 'user' => $usersess));// y a t il des prospot qui ont deja cette raison sociale ?

                        $em = $this->getDoctrine()
                            ->getManager();
                        $query = $em->createQuery(
                            'SELECT u.email
								FROM BaclooUserBundle:User u
								WHERE u.username = :username'
                        )->setParameter('username', $fic->GetUser());
                        $mail = $query->getSingleScalarResult();
                        // $em->clear();
                        //Si prospect pas encore dans la base on insere
                        if(empty($prospotok) && $fic->GetUser() != $usersess) // si nouveau prospect pas dans prospot ni dans table prospects
                        {
                            // echo 'pas empty prospotok1';

                            // $em2->clear();
                            $prospot = new Prospot();
                            $prospot->setRaisonSociale($fic->GetRaisonSociale());
                            $prospot->setActivite($fic->GetActivite());
                            $prospot->setBesoins($fic->GetTags());
                            $prospot->setCp(substr($fic->GetCp(), 0, 2));
                            $prospot->setVille($fic->GetVille());
                            $prospot->setVendeur($fic->GetUser());
                            $prospot->setDescbesoins($fic->GetDescbesoins());
                            $prospot->setVemail($mail);
                            $prospot->setFicheid($fic->GetId());
                            $prospot->setAVendre($fic->GetAVendre());
                            $prospot->setAVendrec($fic->GetAVendrec());
                            $prospot->setPrixavcont($fic->GetPrixavcont());
                            $prospot->setPrixsscont($fic->GetPrixsscont());
                            $prospot->setUser($usersess);
                            $prospot->setLastmodif($fic->GetLastmodif());
                            $prospot->setVoir(false);
                            $prospot->setMasquer(0);
                            $prospot->addProspect($prospects);
                            $prospects->addProspot($prospot);

                            $em = $this->getDoctrine()->getManager();
                            $em->persist($prospot);
                            // $em->persist($prospects);
                            $em->flush();
                        }
                        elseif(!empty($prospotok)) // si nouveau prospect déjà dans prospot mais user dans table prospects
                        {
                            if($fic->getTags() != $prospotok->getBesoins())// Si les besoins  ont été mis à jour
                            {
                                $prospotok->setBesoins($fic->getTags());
                                $prospotok->setVoir(false);
                                $prospotok->setMasquer(0);
                            }
                            elseif($fic->getActivite() != $prospotok->getActivite())// Si les activités  ont été mises à jour
                            {
                                $prospotok->setActivite($fic->getActivite());
                                $prospotok->setVoir(false);
                                $prospotok->setMasquer(0);
                            }
                            elseif($fic->getAVendre() != $prospotok->getAvendre())// Si statut à vendre a changé
                            {
                                $prospotok->setAvendre($fic->getAvendre());
                                $prospotok->setPrixsscont($fic->getPrixsscont());
                                $prospotok->setVoir(false);
                                $prospotok->setMasquer(0);
                            }
                            elseif($fic->getAVendrec() != $prospotok->getAvendrec())// Si statut à vendre a changé
                            {
                                $prospotok->setAvendrec($fic->getAvendrec());
                                $prospotok->setPrixavcont($fic->getPrixavcont());
                                $prospotok->setVoir(false);
                                $prospotok->setMasquer(0);
                            }
                            elseif($fic->getPrixsscont() != $prospotok->getPrixsscont())// Si prix sans contact a changé
                            {
                                $prospotok->setPrixsscont($fic->getPrixsscont());
                                $prospotok->setVoir(false);
                                $prospotok->setMasquer(0);
                            }
                            elseif($fic->getPrixavcont() != $prospotok->getPrixavcont())// Si prix avec contact a changé
                            {
                                $prospotok->setPrixavcont($fic->getPrixavcont());
                                $prospotok->setVoir(false);
                                $prospotok->setMasquer(0);
                            }
                            $em->flush();
                        }
                    }
                    else //Si aucun prospect ne lui a été proposé précédemment cad qu'on ne trouve l'utilisateur ni dans prospects, ni dans prospot
                    {
                        $em = $this->getDoctrine()
                            ->getManager()
                            ->getRepository('BaclooCrmBundle:Prospot');
                        $prospotok = $em->findOneBy(array('RaisonSociale' => $fic->GetRaisonSociale(), 'user' => $usersess));
                        // echo 'empty prospotok';

                        if(empty($prospotok) && $fic->GetUser() != $usersess) // si nouveau prospect pas dans prospot ni dans table prospects
                        {
                            $em = $this->getDoctrine()
                                ->getManager();
                            $query = $em->createQuery(
                                'SELECT u.email
									FROM BaclooUserBundle:User u
									WHERE u.username = :username'
                            )->setParameter('username', $fic->GetUser());
                            $mail = $query->getSingleScalarResult();
                            // $em2->clear();
                            if($fic->GetUser() != $usersess)
                            {
                                $prospot = new Prospot();
                                $prospot->setRaisonSociale($fic->GetRaisonSociale());
                                $prospot->setActivite($fic->GetActivite());
                                $prospot->setBesoins($fic->GetTags());
                                $prospot->setCp(substr($fic->GetCp(), 0, 2));
                                $prospot->setVille($fic->GetVille());
                                $prospot->setVendeur($fic->GetUser());
                                $prospot->setDescbesoins($fic->GetDescbesoins());
                                $prospot->setVemail($mail);
                                $prospot->setFicheid($fic->GetId());
                                $prospot->setAVendre($fic->GetAVendre());
                                $prospot->setAVendrec($fic->GetAVendrec());
                                $prospot->setPrixavcont($fic->GetPrixavcont());
                                $prospot->setPrixsscont($fic->GetPrixsscont());
                                $prospot->setUser($usersess);
                                $prospot->setLastmodif($fic->GetLastmodif());
                                $prospot->setVoir(false);
                                $prospot->setMasquer(0);
                                $prospot->addProspect($prospects);
                                $prospects->addProspot($prospot);

                                $em->persist($prospot);
                                $em->persist($prospects);
                                $em->flush();
                            }
                        }
                    }
                }

            }
            // FIN COTE AJOUT Prospects
        }
        //On récupère l'entite Prospects avec sa colection Prospot




        $em = $this->getDoctrine()
            ->getManager()
            ->getRepository('BaclooCrmBundle:Prospot');
        $prospotaa = $em->findBy(array(
            'user'=>$usersess,
            'voir'=>0));
        $i = count($prospotaa);//echo '$i'.count($prospotaa);
        //maj la valeur prospot en session
        $this->get('session')->set('countprospot', $i);
        //echo $this->get('session')->get('countprospot');
        $nbresultats = $i;
        $nbresult = $i;
        $nombrePage = ceil($nbresult/$nbparpage);
        if($i == 0 || empty($prospotaa))
        {
            $page = 1;
            if($nombrePage < 2){$nombrePage = 1;}
        }
        else
        {
            $nombrePage = ceil($nbresult/$nbparpage);
        }
        // $em->clear();
        $em2 = $this->getDoctrine()
            ->getManager()
            ->getRepository('BaclooCrmBundle:Prospects');
        $prospota = $em2->findOneByUserid($uid);
        // echo 'nbpage'.$nombrePage;
        $form = $this->createForm(new ProspectsType(), $prospota);
        $limitebasse = ($nbparpage*$page)-$nbparpage;//echo 'limitebasse'.$limitebasse;
        $limitehaute = ($nbparpage*$page)+1;//echo 'limitehaute'.$limitehaute;
        return $this->render('BaclooCrmBundle:Crm:opportunity_list.html.twig', array(
            'form'    => $form->createView(),
            'nbresultats'	  => $nbresult,
            'limitebasse'	  => $limitebasse,
            'limitehaute'	  => $limitehaute,
            'nombrePage' 	  => $nombrePage,
            'page'	  	 	  => $page,
        ));

    }

    public function showlistficheintAction($id)
    {
        $em = $this->getDoctrine()
            ->getManager();

        $query = $em->createQuery(
            'SELECT f.raisonSociale
					FROM BaclooCrmBundle:Fiche f
					WHERE f.id = :id'
        );
        $query->setParameter('id', $id);

        $raisonsociale = $query->getSingleScalarResult();//compte des users interressé par cettee fiche

        $query = $em->createQuery(
            'SELECT i
					FROM BaclooCrmBundle:interresses i
					WHERE i.ficheid = :ficheid'
        );
        $query->setParameter('ficheid', $id);

        $listint = $query->getResult();//compte des users interressé par cettee fiche

        return $this->render('BaclooCrmBundle:Crm:interresses_list.html.twig', array(
            'listint'    => $listint,
            'id'			=> $id,
            'raisonsociale'	=> $raisonsociale
        ));
    }

    public function listficheintAction()
    {
        $usersess = $this->get('security.context')->getToken()->getUsername(); if(empty($usersess) or !isset($usersess) or $usersess == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}//Récupère le nom d'utilisateur
        $em = $this->getDoctrine()
            ->getManager();
        $listficheinte = $em->getRepository('BaclooCrmBundle:Fichesvendables')
            ->findByVendeur($usersess);

        return $this->render('BaclooCrmBundle:Crm:ficheint.html.twig', array(
            'listficheint'    => $listficheinte
        ));
    }

    public function compteficheintAction(Request $request)
    {
        $nbfiche = $this->get('session')->get('countfv');


        return $this->render('BaclooCrmBundle:Crm:compteficheint.html.twig', array(
            'nbfiche'    => $nbfiche
        ));
    }

    public function sendmessageAction($vemail, $type, $rais)
    {//echo 'rais1'.$rais;
        $em = $this->getDoctrine()->getManager();
        $destinataire  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($vemail);

        $usersess = $this->get('security.context')->getToken()->getUsername(); if(empty($usersess) or !isset($usersess) or $usersess == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        $expediteur  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($usersess);
        if($rais != 0)
        {
            $raison  = $em->getRepository('BaclooCrmBundle:Fiche')
                ->findOneById($rais);
        }

        $proprioid = $destinataire->getId();

        $message = new Messages();

        $form = $this->createForm(new MessagesType(), $message);
        // on soumet la requete
        $request = $this->getRequest();
        if($rais != 0)
        {
            $send = 'nok';
        }
        else
        {
            $send = 'favoris';
        }
        if ($request->getMethod() == 'POST') {
            // On fait le lien Requête <-> Formulaire
            $form->bind($request);
            if ($form->isValid())
            {//echo 'dans post';
                $message->setFromId($expediteur->getId());
                $message->setDestId($destinataire->getId());
                $message->setFromNom($expediteur->getNom());
                $message->setFromPrenom($expediteur->getPrenom());
                $message->setDestNom($destinataire->getNom());
                $message->setDestPrenom($destinataire->getPrenom());
                $message->setProprio($proprioid);
                $message->setDestinataire($destinataire->getEmail());
                if($rais != 0)
                {//echo 'rais'.$rais;
                    $message->setRaisonsociale($raison->getRaisonSociale());
                }
                else
                {
                    $message->setRaisonsociale('0');
                }
                $message->setLu('nok');
                $em = $this->getDoctrine()->getManager();
                $em->persist($message);
                $em->flush();

                $send = 'ok';

                // Partie envoi du mail
                // Récupération du service
                $mailer = $this->get('mailer');

                $message = \Swift_Message::newInstance()
                    ->setSubject('Bacloo : Un nouveau message est arrivé')
                    ->setFrom(array('bacloo@bacloo.fr' => 'Bacloo CRM'))
                    ->setTo($destinataire->getEmail())
                    ->setBody($this->renderView('BaclooCrmBundle:Crm:new_email.html.twig', array('nom' 		=> $expediteur->getNom(),
                        'prenom'	=> $expediteur->getPrenom(),
                        'username'	=> $destinataire->getUsername(),
                        'dest_pseudo'	=> $destinataire->getUsername()
                    )))
                ;
                $mailer->send($message);

                $mailer = $this->get('mailer');

                $message = \Swift_Message::newInstance()
                    ->setSubject('Bacloo : Un nouveau message est arrivé')
                    ->setFrom(array('bacloo@bacloo.fr' => 'Bacloo CRM'))
                    ->setTo('ringuetjm@gmail.com')
                    ->setBody($this->renderView('BaclooCrmBundle:Crm:new_email.html.twig', array('nom' 		=> $expediteur->getNom(),
                        'prenom'	=> $expediteur->getPrenom(),
                        'username'	=> $destinataire->getUsername(),
                        'dest_pseudo'	=> $destinataire->getUsername()
                    )))
                ;
                $mailer->send($message);
                // Fin partie envoi mail
            }
        }
        $previous = $this->get('request')->server->get('HTTP_REFERER');
        return $this->render('BaclooCrmBundle:Crm:send_message.html.twig', array(
            'sendok'    => $send,
            'user'    	=> $usersess,
            'vemail'	=> $vemail,
            'rais'		=> $rais,
            'type'		=> $type,
            'previous'	=> $previous,
            'proprio'	=> $proprioid,
            'nom'		=> $destinataire->getNom(),
            'prenom'	=> $destinataire->getPrenom(),
            'form'    	=> $form->createView()
        ));
    }

    public function sendmessagefavAction($vemail, $type, $rais)
    {
        $em = $this->getDoctrine()->getManager();
        $destinataire  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($vemail);

        $usersess = $this->get('security.context')->getToken()->getUsername(); if(empty($usersess) or !isset($usersess) or $usersess == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        $expediteur  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($usersess);


        $message = new Messages();

        $form = $this->createForm(new MessagesType(), $message);
        // on soumet la requete
        $request = $this->getRequest();
        $send = 'nok';
        if ($request->getMethod() == 'POST') {
            // On fait le lien Requête <-> Formulaire
            $form->bind($request);
            if ($form->isValid())
            {		//echo 'ici';
                $message->setFromId($expediteur->getId());
                $message->setDestId($destinataire->getId());
                $message->setFromNom($expediteur->getNom());
                $message->setFromPrenom($expediteur->getPrenom());
                $message->setDestNom($destinataire->getNom());
                $message->setDestPrenom($destinataire->getPrenom());
                //$message->setProprio($proprioid);
                $message->setDestinataire($destinataire->getEmail());
                $message->setRaisonsociale($rais);
                $message->setLu('nok');
                $em = $this->getDoctrine()->getManager();
                $em->persist($message);
                $em->flush();
                $send = 'favoris';

                // Partie envoi du mail
                // Récupération du service
                $mailer = $this->get('mailer');

                $message = \Swift_Message::newInstance()
                    ->setSubject('Bacloo : Un nouveau message est arrivé')
                    ->setFrom(array('bacloo@bacloo.fr' => 'Bacloo CRM'))
                    ->setTo($destinataire->getEmail())
                    ->setBody($this->renderView('BaclooCrmBundle:Crm:new_email.html.twig', array('nom' 		=> $expediteur->getNom(),
                        'prenom'	=> $expediteur->getPrenom(),
                        'username'	=> $destinataire->getUsername(),
                        'dest_pseudo'	=> $destinataire->getUsername()
                    )))
                ;
                $mailer->send($message);

                $mailer = $this->get('mailer');

                $message = \Swift_Message::newInstance()
                    ->setSubject('Bacloo : Un nouveau message est arrivé')
                    ->setFrom(array('bacloo@bacloo.fr' => 'Bacloo CRM'))
                    ->setTo('ringuetjm@gmail.com')
                    ->setBody($this->renderView('BaclooCrmBundle:Crm:new_email.html.twig', array('nom' 		=> $expediteur->getNom(),
                        'prenom'	=> $expediteur->getPrenom(),
                        'username'	=> $destinataire->getUsername(),
                        'dest_pseudo'	=> $destinataire->getUsername()
                    )))
                ;
                $mailer->send($message);
                // Fin partie envoi mail

            }
        }
        $previous = $this->get('request')->server->get('HTTP_REFERER');
        return $this->render('BaclooCrmBundle:Crm:send_message.html.twig', array(
            'sendok'    => 'favoris',
            'rais'		=> $rais,
            'user'    	=> $usersess,
            'vemail'	=> $vemail,
            'type'		=> $type,
            'previous'	=> $previous,
            'nom'		=> $destinataire->getNom(),
            'prenom'	=> $destinataire->getPrenom(),
            'form'    	=> $form->createView()
        ));
    }

    public function senddetmessageAction($id, $destid)
    {
        $user= $this->get('security.context')->getToken()->getUsername(); if(empty($user) or !isset($user) or $user == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}

        $em = $this->getDoctrine()->getManager();

        $query = $em->createQuery(
            'SELECT u.id
						FROM BaclooUserBundle:User u
						WHERE u.username = :username'
        )->setParameter('username', $user);
        $uid = $query->getSingleScalarResult();

        $destinataire  = $em->getRepository('BaclooUserBundle:User')
            ->findOneById($destid);
        // echo 'id'.$id.'   ';
        $raison  = $em->getRepository('BaclooCrmBundle:Messages')
            ->findOneById($id);
        //echo $id;
        $rais = $raison->getRaisonsociale();//echo 'rais1'.$rais.'   ';

        $usersess = $this->get('security.context')->getToken()->getUsername(); if(empty($usersess) or !isset($usersess) or $usersess == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        $expediteur  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($usersess);
        if(isset($rais))
        {//echo 'rais'.$rais;
            if($rais !=0)
            {
                $proprio  = $em->getRepository('BaclooCrmBundle:Fiche')
                    ->findOneByRaisonSociale($rais);

                $proprioid = $raison->getProprio();
            }
            else
            {
                $proprioid = $raison->getProprio();
            }
        }
        $query = $em->createQuery(
            'SELECT m
						FROM BaclooCrmBundle:Messages m
						WHERE m.id = :id or  m.idmsgoriginal = :idmsgoriginal'
        );
        $query->setParameter('id', $id);
        $query->setParameter('idmsgoriginal', $id);
        $detail = $query->getResult();

        $query = $em->createQuery(
            'SELECT m.objet
						FROM BaclooCrmBundle:Messages m
						WHERE m.id = :id or  m.idmsgoriginal = :idmsgoriginal'
        );
        $query->setParameter('id', $id);
        $query->setParameter('idmsgoriginal', $id);
        $query->setMaxResults(1);
        $objet = $query->getSingleScalarResult();

        $query = $em->createQuery(
            'SELECT m
						FROM BaclooCrmBundle:Messages m
						WHERE m.destId = :destId or m.id = :id or m.idmsgoriginal = :idmsgoriginal'
        );
        $query->setParameter('destId', $uid);
        $query->setParameter('id', $id);
        $query->setParameter('idmsgoriginal', $id);

        $detoil = $query->getResult();

        foreach($detoil as $detal)
        {
            if($detal->getDestId() == $uid)
            {
                $detal->setLu('ok');
            }
        }
        $em->detach($destinataire);
        $em->detach($expediteur);
        // if(isset($rais) && $rais !=0)
        // {
        // $em->detach($proprio);
        // }
        $em->flush();
        $message = new Messages();

        $form = $this->createForm(new MessagesType(), $message);
        // on soumet la requete
        $request = $this->getRequest();
        $send = 'nok';
        if ($request->getMethod() == 'POST') {
            // On fait le lien Requête <-> Formulaire
            $form->bind($request);
            if ($form->isValid())
            {
                $messageform = $form->get('message')->getData();
                if(isset($messageform) and !empty($messageform))
                {
                    $em = $this->getDoctrine()->getManager();
                    $query = $em->createQuery(
                        'SELECT m.message
							FROM BaclooCrmBundle:Messages m
							WHERE m.message = :message
							and m.fromId = :fromId'
                    );
                    $query->setParameter('message', $messageform);
                    $query->setParameter('fromId', $uid);
                    $query->setMaxResults(1);
                    $messagebdd = $query->getResult();

                    if(!empty($messagebdd))
                    {}
                    else
                    {
                        $message->setFromId($expediteur->getId());
                        $message->setDestId($destinataire->getId());
                        $message->setFromNom($expediteur->getNom());
                        $message->setFromPrenom($expediteur->getPrenom());
                        $message->setDestNom($destinataire->getNom());
                        $message->setDestPrenom($destinataire->getPrenom());
                        if(isset($proprioid))
                        {
                            $message->setProprio($proprioid);
                        }
                        $message->setDestinataire($destinataire->getEmail());
                        $message->setRaisonsociale($rais);
                        $message->setIdmsgoriginal($id);
                        $message->setLu('nok');
                        $em = $this->getDoctrine()->getManager();
                        $em->persist($message);
                        $em->flush();
                        $send = 'ok';

                        // Partie envoi du mail
                        // Récupération du service
                        $mailer = $this->get('mailer');

                        $message = \Swift_Message::newInstance()
                            ->setSubject('Bacloo : Un nouveau message est arrivé')
                            ->setFrom(array('bacloo@bacloo.fr' => 'Bacloo CRM'))
                            ->setTo($destinataire->getEmail())
                            ->setBody($this->renderView('BaclooCrmBundle:Crm:new_email.html.twig', array('nom' 		=> $expediteur->getNom(),
                                'prenom'	=> $expediteur->getPrenom(),
                                'username'	=> $destinataire->getUsername(),
                                'dest_pseudo'	=> $destinataire->getUsername()
                            )))
                        ;
                        $mailer->send($message);

                        $mailer = $this->get('mailer');

                        $message = \Swift_Message::newInstance()
                            ->setSubject('Bacloo : Un nouveau message est arrivé')
                            ->setFrom(array('bacloo@bacloo.fr' => 'Bacloo CRM'))
                            ->setTo('ringuetjm@gmail.com')
                            ->setBody($this->renderView('BaclooCrmBundle:Crm:new_email.html.twig', array('nom' 		=> $expediteur->getNom(),
                                'prenom'	=> $expediteur->getPrenom(),
                                'username'	=> $destinataire->getUsername(),
                                'dest_pseudo'	=> $destinataire->getUsername()
                            )))
                        ;
                        $mailer->send($message);
                        // Fin partie envoi mail
                    }
                }
                return $this->redirect($this->generateUrl('bacloocrm_senddetmessage', array(
                    'destid'	=> $destid,
                    'rais'		=> $rais,
                    'id'		=> $id
                )));
            }
        }
        if(isset($rais))
        {//echo 'argt';echo $proprioid;
            return $this->render('BaclooCrmBundle:Crm:detailmessage.html.twig', array(
                'sendok'    => $send,
                'destid'	=> $destid,
                'userid'	=> $uid,
                'rais'		=> $rais,
                'objet'		=> $objet,
                'proprio'	=> $proprioid,
                'id'		=> $id,
                'detail'	=> $detail,
                'nom'		=> $destinataire->getNom(),
                'prenom'	=> $destinataire->getPrenom(),
                'form'    	=> $form->createView()
            ));
        }
        else
        {//echo 'bronze';
            return $this->render('BaclooCrmBundle:Crm:detailmessage.html.twig', array(
                'sendok'    => $send,
                'destid'	=> $destid,
                'userid'		=> $uid,
                'userid'	=> $expediteur->getId(),
                'rais'		=> $rais,
                'objet'		=> $objet,
                'proprio'	=> $proprioid,
                'id'		=> $id,
                'detail'	=> $detail,
                'nom'		=> $destinataire->getNom(),
                'prenom'	=> $destinataire->getPrenom(),
                'form'    	=> $form->createView()
            ));

        }

    }

    public function buyficheAction($ficheid, $vendeur, $typev, Request $request)
    {
        //On récupère les crédits de l'achteur
        $user= $this->get('security.context')->getToken()->getUsername(); if(empty($user) or !isset($user) or $user == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        $em = $this->getDoctrine()->getManager();
        $query = $em->createQuery(
            'SELECT u.credits
			FROM BaclooUserBundle:User u
			WHERE u.username LIKE :username'
        );
        $query->setParameter('username', $user);
        $credits = $query->getSingleScalarResult();

        //On récupère les crédits du vendeur
        $query = $em->createQuery(
            'SELECT u.credits
			FROM BaclooUserBundle:User u
			WHERE u.username LIKE :username'
        );
        $query->setParameter('username', $vendeur);
        $creditsv = $query->getSingleScalarResult();

        //On récupère les détails de la fiche vendue
        $fiche  = $em->getRepository('BaclooCrmBundle:Fiche')
            ->find($ficheid);

        //On récupère l'id du vendeur
        $query = $em->createQuery(
            'SELECT u.id
			FROM BaclooUserBundle:User u
			WHERE u.username LIKE :username'
        );
        $query->setParameter('username', $fiche->getUser());
        $vendeurid = $query->getSingleScalarResult();

        //On récupère les détails de la fiche vendue dasn prospot
        $prospot  = $em->getRepository('BaclooCrmBundle:Prospot')
            ->findOneByFicheid($ficheid);

        //Si les crédits de l'acheteur sont inférieurs au prix d'achat
        //on retourne message crédits insufisants
        if($credits < $fiche->getPrixsscont())
        {
            $grant = 'nok';
            $previous = $this->get('request')->server->get('HTTP_REFERER');
            return $this->render('BaclooCrmBundle:Crm:buyfiche.html.twig', array(
                'previous'    => $previous,
                'grant'    => $grant
            ));
        }
        else
        {//echo 'debut4';

            //Si les crédits sont suffisants ont valide la transaction
            $grant = 'ok';
            $today = date('Y-m-d');
            $form = $this->createForm(new ProspotType(), $prospot);
            // on soumet la requete
            $request = $this->getRequest();
            if ($request->getMethod() == 'POST')
            {
                $vente = 'ok';
                $session = $request->getSession();//echo '2';
                $controle4 = $session->get('controle4');//echo '4';
                //echo 'controle4--- = '.$controle4.'   ';
                $controle4++;
                //echo 'controle4 = '.$controle4.'   ';
                if($controle4 == 1)
                {
                    if($typev == 'ssc')
                    {
                        $fiche->getBcontacts()->clear();
                    }
                    //Début clonage
                    $fiche->getEvent()->clear();
                    $textememo = '0';
                    $copyfiche = clone $fiche;
                    $Memo = $copyfiche->getMemo();
                    $em->detach($Memo);
                    $copyfiche->setCopyof($fiche->getId());
                    $copyfiche->setUser($user);
                    $copyfiche->setTags('');
                    $copyfiche->setDescbesoins('');
                    $copyfiche->setTypefiche('prospect');
                    $copyfiche->setAVendre('0');
                    $copyfiche->setAVendrec('0');
                    $copyfiche->setPrixsscont('0');
                    $copyfiche->setPrixavcont('0');

                    $em->persist($copyfiche);

                    $em->flush();

                    $creditsfinal = $credits - $fiche->getPrixsscont();
                    $creditsfinalv = $creditsv + $fiche->getPrixsscont();

                    $em = $this->getDoctrine()->getManager();
                    $query = $em->createQuery(
                        'SELECT u
						FROM BaclooUserBundle:User u
						WHERE u.username = :username'
                    );
                    $query->setParameter('username', $user);
                    $acheteur = $query->getSingleResult();
                    $acheteur->setCredits($creditsfinal);

                    $em = $this->getDoctrine()->getManager();
                    $query = $em->createQuery(
                        'SELECT u
						FROM BaclooUserBundle:User u
						WHERE u.username = :username'
                    );
                    $query->setParameter('username', $vendeur);
                    $vendeurok = $query->getSingleResult();
                    $vendeurok->setCredits($creditsfinalv);
                    $em->persist($acheteur);
                    $em->persist($vendeurok);
                    $em->flush();

                    if($typev == 'ssc')
                    {
                        $prix = $fiche->getPrixsscont();

                    }
                    else
                    {
                        $prix = $fiche->getPrixavcont();
                    }
                    //Maintenant on renseigne le champ copyof de cette copie
                    $em = $this->getDoctrine()
                        ->getManager()
                        ->getRepository('BaclooCrmBundle:Fiche');
                    // On récupère la fiche qui nous intéresse
                    $fichecopy = $em->findOneBy(array('raisonSociale' => $fiche->getRaisonSociale(),
                        'user' => $user));
                    $fichecopyid = $fichecopy->getId();
                    // $em2 = $this->getDoctrine()
                    // ->getManager()
                    // ->getRepository('BaclooCrmBundle:Transac');
                    // $transac = $em2->findOneByUserid($uid);
                    $em = $this->getDoctrine()->getManager();
                    $transac = $em->getRepository('BaclooCrmBundle:Transac')
                        ->findOneByVendeur('1234');
                    if(empty($transac))
                    {
                        $transac = new Transac();
                        $transac->setVendeur('1234');
                        $transac->setAcheteur('1234');
                        $em = $this->getDoctrine()->getManager();
                        $em->persist($transac);

                    }
                    $transaction = new Transaction();
                    $transaction->setRaisonSociale($fiche->GetRaisonSociale());
                    $transaction->setVendeur($fiche->GetUser());
                    $transaction->setAcheteur($user);
                    $transaction->setDate($today);
                    if($typev == 'ssc'){$type = 'Sans des contacts';$transaction->setPrix($fiche->getPrixsscont());}else{$type = 'Avec les contacts';$transaction->setPrix($fiche->getPrixavcont());}
                    $transaction->setTypetransac($type);
                    $transaction->setControle('1234');
                    $transaction->setFicheid($ficheid);
                    $transaction->setNficheid($fichecopyid);
                    $transaction->addTransac($transac);
                    $transac->addTransaction($transaction);
                    $em = $this->getDoctrine()->getManager();
                    $em->persist($transaction);
                    $em->persist($transac);
                    $em->detach($prospot);
                    $fiche->getBrappels()->clear();
                    $em->flush();

                    $destinataire  = $em->getRepository('BaclooUserBundle:User')
                        ->findOneByUsername($fiche->GetUser());
                    // Partie envoi du mail
                    // Récupération du service
                    $mailer = $this->get('mailer');

                    $message = \Swift_Message::newInstance()
                        ->setSubject('Bacloo : Vous avez effectué une vente')
                        ->setFrom(array('bacloo@bacloo.fr' => 'Bacloo CRM'))
                        ->setTo($destinataire->getEmail())
                        ->setBody($this->renderView('BaclooCrmBundle:Crm:new_vente.html.twig', array('dest_prenom'	=> $destinataire->getPrenom(),
                            'societe'	=> $fiche->GetRaisonSociale(),
                            'acheteur'	=> $user
                        )))
                    ;
                    $mailer->send($message);

                    // Fin partie envoi mail

                    //FIN CLONAGE
                    $controle4++;
                    $previous = $this->get('request')->server->get('HTTP_REFERER');
                    $session->set('controle4', $controle4);//echo '4';
                    return $this->render('BaclooCrmBundle:Crm:buyfiche.html.twig', array(
                        'previous'    => $previous,
                        'grant'    => $grant,
                        'typev'	   => $typev,
                        'ficheid'  => $ficheid,
                        'vendeur'  => $vendeur,
                        'vente'    => $vente,
                        'fichecopyid'    => $fichecopyid,
                        'raisonsociale'    => $fiche->GetRaisonSociale(),
                        'form'    	=> $form->createView(),
                        'prix'	   => $prix
                    ));
                }
                else
                {//echo 'zarb';
                    //return $this->redirect($this->generateUrl('bacloocrm_showprospotlist'));
                }
            }
            else
            {//echo 'toktok';
                if($typev == 'ssc')
                {
                    $prix = $fiche->getPrixsscont();
                    $vente = 'nok';
                }
                else
                {
                    $prix = $fiche->getPrixavcont();
                    $vente = 'nok';
                }
                //echo 'niveau remove4';
                $session = $request->getSession();//echo '1';
                $session->remove('controle4');//echo '2';
                $session = new Session();//echo '3';
                $session->set('controle4', '0');//echo '4';
            }
            $previous = $this->get('request')->server->get('HTTP_REFERER');
            return $this->render('BaclooCrmBundle:Crm:buyfiche.html.twig', array(
                'previous'    => $previous,
                'grant'    => $grant,
                'typev'	   => $typev,
                'ficheid'  => $ficheid,
                'vendeur'  => $vendeur,
                'vente'    => $vente,
                'raisonsociale'    => $fiche->GetRaisonSociale(),
                'form'    	=> $form->createView(),
                'prix'	   => $prix
            ));

        }

    }
    public function showachatsAction($dix)
    {
        $user= $this->get('security.context')->getToken()->getUsername(); if(empty($user) or !isset($user) or $user == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        $em = $this->getDoctrine()->getManager();


        $transaction = $em->getRepository('BaclooCrmBundle:Transaction')
            ->findByAcheteur($user);
        if(empty($transaction)){$presenc_transac = 'nok';}else{$presenc_transac = 'ok';}
        $transac = $em->getRepository('BaclooCrmBundle:Transac')
            ->findOneByAcheteur('1234');

        $form = $this->createForm(new TransacType(), $transac);
        // on soumet la requete
        $request = $this->getRequest();
        //echo $request->getMethod();
        if ($request->getMethod() == 'POST')
        {
            // On fait le lien Requête <-> Formulaire
            $form->bind($request);$data = $form->getData();
            if ($form->isValid())
            {
                foreach($transaction as $trans)
                {
                    $em = $this->getDoctrine()->getManager();
                    $em->persist($trans);
                    $em->detach($transac);
                    $em->flush();
                }
            }
        }
        if($dix == 1)
        {
            return $this->render('BaclooCrmBundle:Crm:achats.html.twig', array(
                'form'    => $form->createView(),
                'presenc_transac'    => $presenc_transac,
                'acheteur' => $user));
        }
        else
        {
            return $this->render('BaclooCrmBundle:Crm:ok_achats.html.twig', array(
                'form'    => $form->createView(),
                'acheteur' => $user));
        }
    }

    public function showventesAction()
    {
        $user= $this->get('security.context')->getToken()->getUsername(); if(empty($user) or !isset($user) or $user == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        $em = $this->getDoctrine()->getManager();

        $transaction = $em->getRepository('BaclooCrmBundle:Transaction')
            ->findByVendeur($user);

        if(empty($transaction)){$presenc_transac = 'nok';}else{$presenc_transac = 'ok';}
        $transac = $em->getRepository('BaclooCrmBundle:Transac')
            ->findOneByVendeur('1234');

        $form = $this->createForm(new TransacType(), $transac);
        // on soumet la requete
        $request = $this->getRequest();
        if ($request->getMethod() == 'POST')
        {
            // On fait le lien Requête <-> Formulaire
            $form->bind($request);$data = $form->getData();
            if ($form->isValid())
            {
                foreach ($transaction as $transbdd)
                {
                    foreach ($form->get('transaction')->getData() as $transform)
                    {
                        $em = $this->getDoctrine()->getManager();
                        $query = $em->createQuery(
                            'SELECT t
							FROM BaclooCrmBundle:Transaction t
							WHERE t.raisonsociale = :raisonsociale
							AND t.acheteur = :acheteur
							AND t.vendeur = :vendeur
							AND t.note != :note'
                        );
                        $query->setParameter('raisonsociale', $transform->getRaisonsociale());
                        $query->setParameter('acheteur', $transform->getVendeur());
                        $query->setParameter('vendeur', $user);
                        $query->setParameter('note', $transform->getNote());
                        $transactionbdd = $query->getResult();

                    }
                }
            }
        }

        return $this->render('BaclooCrmBundle:Crm:ventes.html.twig', array(
            'form'    => $form->createView(),
            'presenc_transac'    => $presenc_transac,
            'vendeur' => $user));
    }

    public function showachatscreditsAction()
    {
        $user= $this->get('security.context')->getToken()->getUsername(); if(empty($user) or !isset($user) or $user == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}

        $em = $this->getDoctrine()
            ->getManager();

        $query = $em->createQuery(
            'SELECT p
					FROM PaymentBundle:Payment p
					WHERE p.user = :user
					ORDER BY p.id DESC'
        );
        $query->setParameter('user', $user);

        $lisachatsc = $query->getResult();//compte des users interressés par cettee fiche
        if(empty($lisachatsc))
        {
            $test = 'nok';
        }
        else{
            $test = 'ok';
        }

        return $this->render('BaclooCrmBundle:Crm:achats_credits.html.twig', array(
            'lisachatsc'    => $lisachatsc,
            'test'    		=> $test
        ));
    }

    public function showmessagesAction()
    {
        $user= $this->get('security.context')->getToken()->getUsername(); if(empty($user) or !isset($user) or $user == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        $em = $this->getDoctrine()->getManager();

        $query = $em->createQuery(
            'SELECT u.id
			FROM BaclooUserBundle:User u
			WHERE u.username = :username'
        )->setParameter('username', $user);
        $uid = $query->getSingleScalarResult();


        $query = $em->createQuery(
            'SELECT m
			FROM BaclooCrmBundle:Messages m
			WHERE m.destId = :destId
			ORDER BY m.id DESC'
        )->setParameter('destId', $uid);

        $receive = $query->getResult();

        return $this->render('BaclooCrmBundle:Crm:messages.html.twig', array(
            'receive'	   => $receive
        ));
    }

    public function publicprofileAction($user)
    {
        $em = $this->getDoctrine()->getManager();
        $query = $em->createQuery(
            'SELECT COUNT(f.id) as nbfiche
			FROM BaclooCrmBundle:Fiche f
			WHERE f.user = :user'
        )->setParameter('user', $user);
        $nbfiche = $query->getSingleScalarResult();

        $query = $em->createQuery(
            'SELECT u
			FROM BaclooUserBundle:User u
			WHERE u.username = :username'
        )->setParameter('username', $user);
        $userdata = $query->getSingleResult();

        $em = $this->getDoctrine()
            ->getManager()
            ->getRepository('BaclooCrmBundle:Transaction');
        $noteco = $em->findByVendeur($user);
        // print_r($noteco);
        $i=0;
        $t=0;
        if(!empty($noteco))
        {
            foreach($noteco as $notec)
            {
                $t++;
                $noteok = $notec->getNote();
                if(isset($noteok))
                {

                    if($i == 0)
                    {
                        $note = $notec->getNote();
                        $i++;
                    }
                    else
                    {
                        $note += $notec->getNote();
                        $i++;
                    }
                }
                else
                {

                }
            }
            if(isset($note))
            {
                $noteok = $note/$i;
            }
            else
            {
                $noteok = 'na';
                $noteco = 'na';
            }
            $em = $this->getDoctrine()->getManager();
            $userdata->SetNote($noteok);
            $em->persist($userdata);
            $em->flush();
        }
        else
        {
            $noteok = 'na';
            $noteco = 'na';
        }

        $previous = $this->get('request')->server->get('HTTP_REFERER');
        return $this->render('BaclooCrmBundle:Crm:publicprofile.html.twig', array(
            'userdata'	   => $userdata,
            'noteco'   		=> $noteco,
            'previous'		=> $previous,
            'nbeval'		=> $i,
            'nbtransac'		=> $t,
            'nbfiche'		=> $nbfiche,
            'noteok'		=> $noteok
        ));
    }

    public function newmessageAction()
    {
        $user= $this->get('security.context')->getToken()->getUsername(); if(empty($user) or !isset($user) or $user == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        $em = $this->getDoctrine()->getManager();

        $query = $em->createQuery(
            'SELECT u.id
			FROM BaclooUserBundle:User u
			WHERE u.username = :username'
        )->setParameter('username', $user);
        $uid = $query->getSingleScalarResult();

        $query = $em->createQuery(
            'SELECT COUNT(m.id) as nbmsg
			FROM BaclooCrmBundle:Messages m
			WHERE m.destId = :destId
			AND m.lu = :lu');
        $query->setParameter('destId', $uid);
        $query->setParameter('lu', 'nok');
        $nbmsg = $query->getSingleScalarResult();

        return $this->render('BaclooCrmBundle:Crm:newmessage.html.twig', array(
            'nbmsg'	   => $nbmsg
        ));
    }

    public function paiementAction()
    {
        $request = $this->getRequest();
        if($request->getMethod()=='POST'){
            $paiement = $request->request->get('custom');
        }
        else{

        }

        return $this->render('BaclooCrmBundle:Crm:paiement.html.twig', array(
            'paiement'	   => $paiement
        ));
    }

    public function contactAction(Request $request)
    {
        $defaultData = array('message' => 'Veuillez saisir un message, il nous fera avancer.');
        $form = $this->createFormBuilder($defaultData)
            ->add('name', 'text', array('required' => true))
            ->add('email', 'email', array('required' => true))
            ->add('message', 'textarea', array('required' => true))
            ->getForm();

        $form->handleRequest($request);

        if ($form->isValid()) {
            // Les données sont un tableau avec les clés "name", "email", et "message"
            $data = $form->getData();
            // Partie envoi du mail
            // Récupération du service
            $mailer = $this->get('mailer');

            $message = \Swift_Message::newInstance()
                ->setSubject('Bacloo : Message reçu du formulaire de contact')
                ->setFrom($data['email'])
                ->setTo('ringuetjm@gmail.com')
                ->setBody($this->renderView('BaclooCrmBundle:Crm:contactparform.html.twig', array('message' 		=>$data['message'],
                    'nom'	=> $data['name']
                )))
            ;
            $mailer->send($message);

            // Fin partie envoi mail
            $validation = 'ok';
            return $this->render('BaclooCrmBundle:Crm:contactok.html.twig',array('ok' => 'ok'));
        }

        return $this->render('BaclooCrmBundle:Crm:contact.html.twig',array('form' => $form->createView(),
            'ok' => 'nok'));
    }

    public function contact2Action(Request $request)
    {
        $defaultData = array('message' => 'Veuillez saisir un message, il nous fera avancer.');
        $form = $this->createFormBuilder($defaultData)
            ->add('name', 'text', array('required' => true))
            ->add('email', 'email', array('required' => true))
            ->add('message', 'textarea', array('required' => true))
            ->getForm();

        $form->handleRequest($request);

        if ($form->isValid()) {
            // Les données sont un tableau avec les clés "name", "email", et "message"
            $data = $form->getData();
            // Partie envoi du mail
            // Récupération du service
            $mailer = $this->get('mailer');

            $message = \Swift_Message::newInstance()
                ->setSubject('Bacloo : Message reçu du formulaire de contact')
                ->setFrom($data['email'])
                ->setTo('ringuetjm@gmail.com')
                ->setBody($this->renderView('BaclooCrmBundle:Crm:contactparform.html.twig', array('message' 		=>$data['message'],
                    'nom'	=> $data['name']
                )))
            ;
            $mailer->send($message);

            // Fin partie envoi mail
            $validation = 'ok';
            return $this->render('BaclooCrmBundle:Crm:contact2ok.html.twig',array('ok' => 'ok'));
        }

        return $this->render('BaclooCrmBundle:Crm:contact2.html.twig',array('form' => $form->createView(),
            'ok' => 'nok'));
    }

    public function conditionsAction()
    {
        return $this->render('BaclooCrmBundle:Crm:conditions_generales.html.twig');
    }

    public function conditionspubAction()
    {
        return $this->render('BaclooCrmBundle:Crm:conditions_generales_public.html.twig');
    }

    public function storeAction()
    {
        return $this->render('BaclooCrmBundle:Crm:store.html.twig');
    }

//Recherche de Prospects
    public function searchbaclooAction($mode)
    {
        $page=1;
        if(!isset($page) || $page == 0){$page =1;}
        $usersess = $this->get('security.context')->getToken()->getUsername(); if(empty($usersess) or !isset($usersess) or $usersess == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}//Récupère le nom d'utilisateur
        $em = $this->getDoctrine()->getManager();

        // echo 'on efface';
        //On réinitialise la recherche
        $em = $this->getDoctrine()
            ->getManager()
            ->getRepository('BaclooCrmBundle:Prospotbacloo');
        $prospotaa = $em->findByUser($usersess);

        // Si des prospotbacloo lui ont deja été proposés on supprime avant d'ajouter
        $em = $this->getDoctrine()->getManager();
        if(isset($prospotaa) && !empty($prospotaa))
        {//echo '3';
            foreach($prospotaa as $prosp)
            {
                $em->remove($prosp);//echo '4';
                $em->flush();
            }
        }

        // On crée un objet Search
        $search = new Search;//echo 'aaaaaaaaa';
        $form = $this->createForm(new SearchType(), $search);
        $request = $this->getRequest();

        if ($request->getMethod() == 'POST')
        {
            $form->bind($request);
            if ($form->isValid())
            {
                // On Flush la recherche

                $em->persist($search);
                // on flush le tout
                $em->flush();

                // On redirige vers la page de visualisation de recherche
                //ici l'array doit se constituer en fonction des champs de formulaire remplis
                $id = $search->getid();
                return $this->redirect($this->generateUrl('bacloocrm_findbacloo', array('id' => $id, 'mode' => $mode )
                ));
            }
        }

        return $this->render('BaclooCrmBundle:Crm:searchbacloo.html.twig', array('mode'=> $mode, 'form' => $form->createView()));
    }

// le paramètre de l'action doit se remplir en fonction des critères de recherche
    public function findbaclooAction($id, $mode, $page, $toc, $insert, Request $request)
    {
        //echo 'find';echo 'mode'.$mode;echo 'letoc'.$this->getRequest()->request->get('pagination');

        //$toc = 1, signifie que pagination = page : on a cliqué sur un bouton  de pagination
        //$insert signifie qu'on a juste cliqué sur tout cocher ou tout décocher
        //$find pour indiquer que nous avons déjà fait l'ajout dans la fonction find

        $usersess = $this->get('security.context')->getToken()->getUsername(); if(empty($usersess) or !isset($usersess) or $usersess == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        // On récupère l'EntityManager
        $em = $this->getDoctrine()->getManager();
        // On récupere l'id de la recherche	puis les paramètres dela recherche
        $search = $em->getRepository('BaclooCrmBundle:Search')->find($id);
        $besoin = $search->getBesoins();
        $activite = $search->getRaisonSociale();
        $departement = $search->getNom();
        // On récupere l'id de la recherche	puis les paramètres dela recherche
        // $search = $em->getRepository('BaclooCrmBundle:Search')->find($id);
        // $besoin = $search->getBesoins();
        // $activite = $search->getRaisonSociale();
        // $departement = $search->getNom();
        //$usersess = 'jmr';
        //echo $departement;
        //$fiche = new Fiche;
        //echo $id;
        $search = $em->getRepository('BaclooCrmBundle:Search')->find($id);//echo 'bbbbbbbbbb';
        $form = $this->createForm(new SearchType(), $search);//if(!empty($form)){echo 'form plein';}
        $request = $this->getRequest();
        // Dans le cas ou le formulaire a été posté
        if ($request->getMethod() == 'POST')
        {
            ///echo 'post';
            $form->bind($request);
            if ($form->isValid())
            {
                // On Flush la recherche
                $em = $this->getDoctrine()->getManager();
                $em->persist($search);
                // on flush le tout
                $em->flush();

                // On redirige vers la page de visualisation de recherche
                return $this->redirect($this->generateUrl('bacloocrm_find', array('id' => $search->getFicheid())));//getID ?? non ?
            }
        }
        $nbparpage = 20;
        $em = $this->getDoctrine()->getManager();
        $fiche = $em->getRepository('BaclooCrmBundle:Fiche')
            ->searchfichebacloo2($besoin, $activite, $departement, $nbparpage, $page, $usersess, $mode);
        //echo 'pas post';echo 'id'.$id.'  insert'.$insert.'  toc'.$toc.'  mode'.$mode.'  page'.$page;
        if(!isset($insert)){$insert = 'ok';}
        return $this->render('BaclooCrmBundle:Crm:searchbacloo.html.twig', array(
            'id' => $id,
            'insert' => $insert,
            'toc' => $toc,
            'mode' => $mode,
            'page' => $page,
            'resultats' => $fiche,
            'form' => $form->createView()
        ));

    }

    public function showbacloolistAction($id, $mode, $page, $toc, $insert, Request $request)
    {
        //echo 'le show';
        //echo ' toc1'.$toc.'insert1'.$insert;
        //$toc = 1, signifie que pagination = page : on a cliqué sur un bouton  de pagination
        //$insert signifie qu'on a juste cliqué sur tout cocher ou tout décocher
        //$find pour indiquer que nous avons déjà fait l'ajout dans la fonction find

        $usersess = $this->get('security.context')->getToken()->getUsername(); if(empty($usersess) or !isset($usersess) or $usersess == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}//Récupère le nom d'utilisateur
        //echo 'la page'.$page;
        $nbparpage = 20;
        set_time_limit(300);//Pour augmenter le temps d'exécution des grosses requêtes

        //Si c'est le bouton pagination qui a été cliqué ?????????
        if($this->getRequest()->request->get('pagination') > 0)
        {
            $page = $this->getRequest()->request->get('pagination');
            // echo 'la page2'.$page;
        }

        $em = $this->getDoctrine()->getManager();
        //echo 'id'.$id;
        // on récupère la recherche
        $search = $em->getRepository('BaclooCrmBundle:Search')->find($id);
        $besoin = $search->getBesoins();
        $activite = $search->getRaisonSociale();
        $departement = $search->getNom();
        //$usersess = 'jmr';
        //$fiche = new Fiche;
        //echo 'besoin1'.$besoin;echo 'activite1'.$activite;echo 'departement1'.$departement;
        //On récupère les fiches bacloo qui correspondent à la recherche

        //On récupère l'id de l'utilisateur connecté
        //$em = $this->getDoctrine()->getManager();
        $query = $em->createQuery(
            'SELECT u.id
			FROM BaclooUserBundle:User u
			WHERE u.username = :username'
        )->setParameter('username', $usersess);
        $uid = $query->getSingleScalarResult();
        //echo 'uid'.$uid;
        // $em2 = $this->getDoctrine()
        // ->getManager()
        // ->getRepository('BaclooCrmBundle:Prospotbacloo');
        // $prospo = $em2->searchprospotbacloo2($usersess, $nbparpage, $page);
        //echo 'countprospo'.count($prospo);

        //On affiche le formulaire
        $em2 = $this->getDoctrine()
            ->getManager()
            ->getRepository('BaclooCrmBundle:Prospectsbacloo');
        $prospota2 = $em2->findOneByUserid($uid);

        if(empty($prospota2))//Si utilisateur pas enregistré dans prospect
        {
            //echo 'ajout prospectsbacloo';
            // On enregistre le userid dans prospects
            $Prospectsbacloo = new Prospectsbacloo();
            $Prospectsbacloo->setUserid($uid);
            $em = $this->getDoctrine()->getManager();
            $em->persist($Prospectsbacloo);
            $em->flush();

        }
        //echo 'countprospoota2'.count($prospota2);
        // On créé le formulaire
        $form = $this->createForm(new ProspectsbaclooType(), $prospota2);
        // on soumet la requete
        $request = $this->getRequest();

        // Si c'est le bouton acheter qui a été appuyé
        if ($this->getRequest()->request->get('acheter') == 'Acheter')
        {
            //echo 'acheter';
            $previous = $this->get('request')->server->get('HTTP_REFERER');
            if($request->getMethod() == 'POST')
            {//echo '6';
                // On fait le lien Requête <-> Formulaire

                $form->bind($request);//echo $form->isValid();
                if ($form->isValid())
                {//echo '7';


                    // ICI ON COMMENCE L'OPERATION BUYFICHE AVEC LA BOUCLE
                    //On récupère les crédits de l'acheteur
                    $user= $this->get('security.context')->getToken()->getUsername(); if(empty($user) or !isset($user) or $user == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
                    $em = $this->getDoctrine()->getManager();
                    $query = $em->createQuery(
                        'SELECT u.credits
					FROM BaclooUserBundle:User u
					WHERE u.username LIKE :username'
                    );
                    $query->setParameter('username', $user);
                    $credits = $query->getSingleScalarResult();

                    //PREMIERE BOUCLE POUR AVOIR LA SOMME DE TOUS LES CREDITS NECESSAIRES POUR ACHETER TOUTES LES FICHES
                    $prix = 0;
                    $nbfiche = 0;
                    foreach ($form->get('prospotbacloo')->getData() as $rb)
                    {//echo '8'.$rb->getPrixsscont();
                        if($rb->getAcheter() == '1')
                        {//echo 'kkkkk';
                            $nbfiche++;
                            $prix += $rb->getPrixsscont();
                        }
                    }//echo 'gggggg'.$prix*$nbfiche;
                    //SI CDREDITS ACHETEUR INSUFFISANT => ON EJECTE
                    //echo 'crecits'.$credits;
                    //echo ' prix'.$prix;
                    if($credits < $prix)
                    {//echo 'return1';
                        $grant = 'nok';
                        return $this->render('BaclooCrmBundle:Crm:buyfiche.html.twig', array(
                            'previous'    => $previous,
                            'grant'    => $grant
                        ));
                    }
                    else
                    {	$i=0;
                        //DEBUT DE LA BOUCLE D'ACHAT
                        foreach ($form->get('prospotbacloo')->getData() as $rb)
                        {//echo '$rb->getAcheter()'.$rb->getAcheter();$i++;
                            if($rb->getAcheter() == '1')
                            {
                                $em->clear();
                                //echo 'JACHETE';
                                $ficheid = $rb->getFicheid();
                                $grant = 'ok';
                                //echo 'la'.$ficheid;
                                //On récupère les détails des fiches vendues
                                $fiche  = $em->getRepository('BaclooCrmBundle:Fiche')
                                    ->find($ficheid);
                                //echo 'ici';
                                //On récupère les crédits du vendeur
                                $query = $em->createQuery(
                                    'SELECT u.credits
							FROM BaclooUserBundle:User u
							WHERE u.username LIKE :username'
                                );
                                $query->setParameter('username', $fiche->getUser());
                                $creditsv = $query->getSingleScalarResult();

                                //On récupère l'id du vendeur
                                $query = $em->createQuery(
                                    'SELECT u.id
							FROM BaclooUserBundle:User u
							WHERE u.username LIKE :username'
                                );
                                $query->setParameter('username', $fiche->getUser());
                                $vendeurid = $query->getSingleScalarResult();

                                //On récupère les détails de la fiche vendue dasn prospot
                                // $prospotbacloo  = $em->getRepository('BaclooCrmBundle:Prospotbacloo')
                                // ->findOneByFicheid($ficheid);

                                $today = date('Y-m-d');
                                // $form = $this->createForm(new ProspotbaclooType(), $prospotbacloo);
                                // on soumet la requete

                                $vente = 'ok';
                                //echo '9';
                                $session = $request->getSession();//echo '2';
                                $controle2 = $session->get('controle2');//echo '4';
                                //echo 'controle--- = '.$controle2.'   ';
                                $controle2++;
                                //echo 'controle2 = '.$controle2.'   ';
                                // if($controle2 == 1)
                                // {
                                //Début clonage
                                $textememo = '0';
                                $copyfiche = clone $fiche;
                                $Memo = $copyfiche->getMemo();
                                if(isset($Memo))
                                {
                                    $em->detach($Memo);
                                }
                                $copyfiche->setCopyof($fiche->getId());
                                $copyfiche->setUser($user);
                                $copyfiche->setTags('');
                                $copyfiche->setDescbesoins('');
                                $copyfiche->setTypefiche('prospect');
                                $copyfiche->setAVendre('0');
                                $copyfiche->setAVendrec('0');
                                $copyfiche->setPrixsscont('0');

                                $em->persist($copyfiche);
                                //echo 'apres detach 1';

                                $em->flush();

                                $creditsfinal = $credits - $fiche->getPrixsscont();
                                $creditsfinalv = $creditsv + $fiche->getPrixsscont();

                                //MISE A JOUR CREDITS ACHETEUR
                                $em = $this->getDoctrine()->getManager();
                                $query = $em->createQuery(
                                    'SELECT u
									FROM BaclooUserBundle:User u
									WHERE u.username LIKE :username'
                                );
                                $query->setParameter('username', $user);
                                $acheteur = $query->getSingleResult();
                                $acheteur->setCredits($creditsfinal);

                                //MAJ CREDITS VENDEUR ET FLUSH
                                $em = $this->getDoctrine()->getManager();
                                $query = $em->createQuery(
                                    'SELECT u
									FROM BaclooUserBundle:User u
									WHERE u.username LIKE :username'
                                );
                                $query->setParameter('username', $fiche->getUser());
                                $vendeurok = $query->getSingleResult();
                                $vendeurok->setCredits($creditsfinalv);
                                $em->persist($acheteur);
                                $em->persist($vendeurok);
                                $em->flush();

                                //Maintenant on renseigne le champ copyof de cette copie
                                $em = $this->getDoctrine()
                                    ->getManager()
                                    ->getRepository('BaclooCrmBundle:Fiche');
                                // On récupère la fiche qui nous intéresse
                                $fichecopy = $em->findOneBy(array('raisonSociale' => $fiche->getRaisonSociale(),
                                    'user' => $user));
                                $fichecopyid = $fichecopy->getId();

                                $em = $this->getDoctrine()->getManager();
                                $transac = $em->getRepository('BaclooCrmBundle:Transac')
                                    ->findOneByVendeur('1234');
                                $transaction = new Transaction();
                                $transaction->setRaisonSociale($fiche->GetRaisonSociale());
                                $transaction->setVendeur($fiche->GetUser());
                                $transaction->setAcheteur($user);
                                $transaction->setDate($today);
                                $type = 'Sans les contacts';
                                $transaction->setPrix($fiche->getPrixsscont());
                                $transaction->setTypetransac($type);
                                $transaction->setControle('1234');
                                $transaction->setFicheid($ficheid);
                                $transaction->setNficheid($fichecopyid);
                                $transaction->addTransac($transac);
                                $transac->addTransaction($transaction);
                                $em = $this->getDoctrine()->getManager();
                                $em->persist($transaction);
                                // $em->detach($prospotbacloo);
                                $fiche->getBrappels()->clear();
                                $em->flush();

                                $destinataire  = $em->getRepository('BaclooUserBundle:User')
                                    ->findOneByUsername($fiche->GetUser());
                                // Partie envoi du mail
                                // Récupération du service
                                $mailer = $this->get('mailer');

                                $message = \Swift_Message::newInstance()
                                    ->setSubject('Bacloo : Vous avez effectué une vente')
                                    ->setFrom(array('bacloo@bacloo.fr' => 'Bacloo CRM'))
                                    ->setTo($destinataire->getEmail())
                                    ->setBody($this->renderView('BaclooCrmBundle:Crm:new_vente.html.twig', array('dest_prenom'	=> $destinataire->getPrenom(),
                                        'societe'	=> $fiche->GetRaisonSociale(),
                                        'acheteur'	=> $user
                                    )))
                                ;
                                $mailer->send($message);

                                $mailer = $this->get('mailer');

                                $message = \Swift_Message::newInstance()
                                    ->setSubject('Bacloo : Vous avez effectué une vente')
                                    ->setFrom(array('bacloo@bacloo.fr' => 'Bacloo CRM'))
                                    ->setTo('ringuetjm@gmail.com')
                                    ->setBody($this->renderView('BaclooCrmBundle:Crm:new_vente.html.twig', array('dest_prenom'	=> $destinataire->getPrenom(),
                                        'societe'	=> $fiche->GetRaisonSociale(),
                                        'acheteur'	=> $user
                                    )))
                                ;
                                $mailer->send($message);
                                // Fin partie envoi mail

                                //FIN CLONAGE
                                //FIN DE BOUCLE
                                // $controle2++;//echo 'return2';
                                // $session->set('controle2', $controle2);//echo '4';
                                // }
                                // else
                                // {echo 'zarb';
                                // $search = new Search;// 'dddddddddddddddddddd';
                                // $form = $this->createForm(new SearchType(), $search);//echo 'return3';
                                // return $this->render('BaclooCrmBundle:Crm:searchbacloo.html.twig', array('form' => $form->createView(), 'mode' => 'prospssc'));
                                // }
                            }
                        }
                        //echo 'iiiiiiiiiiiiiiiii'.$i;
                        $session->remove('controle2');
                        return $this->render('BaclooCrmBundle:Crm:buyfiche.html.twig', array(
                            'previous' => $previous,
                            'grant'    => $grant,
                            'vente'    => 'bacloo',
                            'nbfiche'  => $nbfiche
                        ));
                    }
                }
            }
        }
        elseif ($this->getRequest()->request->get('pagination') == $page || $this->getRequest()->request->get('pagination') == 'Tout cocher' || $this->getRequest()->request->get('pagination') == 'Tout décocher' || $toc == 1)
        {
            //echo 'pagination'.$request->getMethod();echo $this->getRequest()->request->get('pagination');
            //echo ' toc2'.$toc.'insert2'.$insert;
            // 1. Un bouton de pagination a été appuyé, on update les données de la page précédente dans la table
            $toc = 1;
            if ($request->getMethod() == 'POST')
            {
                //echo '6'.$page;
                $form->bind($request);//echo $form->isValid();
                if ($form->isValid())
                {
                    // On boucle sur chaque ligne du tableau formulaire
                    foreach ($form->get('prospotbacloo')->getData() as $pr)
                    {
                        //echo '8'.$pr->getRaisonSociale();
                        $em->clear();
                        // On récupère Prospectsbacloo
                        // $em2 = $this->getDoctrine()
                        // ->getManager()
                        // ->getRepository('BaclooCrmBundle:Prospectsbacloo');
                        // $prospota2 = $em2->findOneByUserid($uid);

                        // On récupère ProspotBacloo
                        $em3 = $this->getDoctrine()
                            ->getManager()
                            ->getRepository('BaclooCrmBundle:Prospotbacloo');
                        $prospo2 = $em3->findOneByRaisonSociale($pr->getRaisonsociale());

                        // echo 'ph1'.$prospo2->getAcheter();
                        // echo 'ph2'.$pr->getAcheter();

                        //Si tout cocher ou tout décocher a été cliqué

                        $prospo2->setAcheter($pr->getAcheter());
                        $insert = 'ok';//echo 'toc=null';

                        $em->flush();

                        //Comme cette condition est réalisée on ne fait pas d'insertion


                        // echo 'lolorrrr';
                        // 2. On récupère les données de la page suivante pour les affichées
                    }//echo 'insertpag'.$insert;

                    if(!isset($insert)){$insert = 'ok';}

                    if(isset($insert) && $insert == 'nok')//  tout cocher ou tout decocher
                    {
                        //echo 'ici?';
                        return $this->redirect($this->generateUrl('bacloocrm_findbacloo', array(
                            'toc'=> $toc,
                            'insert'=> $insert,
                            'id' => $id,
                            'mode' => $mode,
                            'page' => $page )));
                    }
                    else // S'il ne s'agit pas de tout cocher ou tout décocher alors $insert = nok
                    {
                        $em = $this->getDoctrine()->getManager();

                        //DEBUT PARTIE COMPTAGE RESULTATS
                        $fiche2 = $em->getRepository('BaclooCrmBundle:Fiche')
                            ->searchfichebacloosp($besoin, $activite, $departement, $usersess, $mode);
                        //echo 'ccccccccccccc'.count($fiche2);
                        $c = 0;
                        // $p = 0;
                        foreach($fiche2 as $fic)
                        {//$p++;
                            $ficheuser = $em->getRepository('BaclooCrmBundle:Fiche')
                                ->findBy(array('user' => $usersess, 'raisonSociale' => $fic->GetRaisonSociale(), 'ville' => $fic->GetVille()));
                            //echo 'nb resultatfind'.ceil(count($fiche));
                            if(empty($ficheuser))
                            {
                                $c++;
                            }
                        }
                        // echo $p;
                        // echo $c;

                        //FIN PARTIE COMPTAGE RESULTATS

                        $fiche = $em->getRepository('BaclooCrmBundle:Fiche')
                            ->searchfichebacloo2($besoin, $activite, $departement, $nbparpage, $page, $usersess, $mode);

                        // echo 'countfiche'.count($fiche);
                        //S'il y a des fiches correspondantes à la recherche
                        if(!empty($fiche ))
                        {
                            // echo 'pas empty result';
                            //Début ajout des resultats dans la table prospotbacloo
                            //echo 'countfiche1'.count($fiche);
                            //On récupère l'id de l'utilisateur connecté
                            $query = $em->createQuery(
                                'SELECT u.id
								FROM BaclooUserBundle:User u
								WHERE u.username = :username'
                            )->setParameter('username', $usersess);
                            $uid = $query->getSingleScalarResult();

                            //On regarde si l'utilisateur connecté est déja entegistré dans la table prospects
                            $em2 = $this->getDoctrine()
                                ->getManager()
                                ->getRepository('BaclooCrmBundle:Prospectsbacloo');
                            $prospectsbacloo = $em2->findOneByUserid($uid);

                            $em2 = $this->getDoctrine()
                                ->getManager()
                                ->getRepository('BaclooCrmBundle:Prospotbacloo');
                            $prospotbacloo = $em2->findByUser($usersess);
                            $countprospotbacloo = count($prospotbacloo);

                            // si le nombre de prospot est inférieur au nombre de résultats on insère
                            if(count($fiche)> $countprospotbacloo)
                            {
                                //S'il n'y a pas encore de prospot dans la table prosppotbacloo
                                $i=0;
                                // Pour chaque fiche trouvée on l'insère dans la table prospot
                                foreach($fiche as $fic)
                                {
                                    $i++;
                                    // echo $fic->getRaisonSociale();
                                    //echo 'on insere';echo $insert;
                                    $em = $this->getDoctrine()
                                        ->getManager();
                                    $query = $em->createQuery(
                                        'SELECT u.email
										FROM BaclooUserBundle:User u
										WHERE u.username = :username'
                                    )->setParameter('username', $fic->GetUser());
                                    $mail = $query->getSingleScalarResult();

                                    // echo 'nb resultat3'.ceil(count($fiche));
                                    $ficheuser = $em->getRepository('BaclooCrmBundle:Fiche')
                                        ->findBy(array('user' => $usersess, 'raisonSociale' => $fic->GetRaisonSociale(), 'ville' => $fic->GetVille()));
                                    //echo 'nb resultatfind'.ceil(count($fiche));
                                    if(empty($ficheuser))
                                    {
                                        //echo 'ficheuserempty2';
                                        $prospot = new Prospotbacloo();
                                        $prospot->setRaisonSociale($fic->GetRaisonSociale());
                                        $prospot->setActivite($fic->GetActivite());
                                        $prospot->setCp(substr($fic->GetCp(), 0, 2));
                                        $prospot->setVille($fic->GetVille());
                                        $prospot->setBesoins($fic->GetTags());
                                        $prospot->setDescbesoins($fic->GetDescbesoins());
                                        $prospot->setVendeur($fic->GetUser());
                                        $prospot->setVemail($mail);
                                        $prospot->setFicheid($fic->GetId());
                                        $prospot->setAVendre($fic->GetAVendre());
                                        $prospot->setAVendrec($fic->GetAVendrec());
                                        $prospot->setPrixavcont($fic->GetPrixavcont());
                                        $prospot->setPrixsscont($fic->GetPrixsscont());
                                        $prospot->setUser($usersess);
                                        $prospot->setLastmodif($fic->GetLastmodif());
                                        $prospot->addProspectsbacloo($prospectsbacloo);
                                        $prospectsbacloo->addProspotbacloo($prospot);

                                        $em = $this->getDoctrine()->getManager();
                                        $em->persist($prospot);
                                        $em->persist($prospectsbacloo);

                                        //Permet de bloquer la réinsertion à la fin de showbacloolist.
                                        //echo 'iiiiiiiiiiiiiiii'.$i;
                                        // FIN AJOUT
                                    }
                                    else
                                    {
                                        //echo 'ficheuser plein2';
                                    }
                                    //echo 'iiiiiiiiiiiiiiii'.$i;
                                    // FIN AJOUT
                                }
                                $em->flush();
                            }
                            //echo 'return8';
                            return $this->redirect($this->generateUrl('bacloocrm_findbacloo', array(
                                'toc'=> $toc,
                                'id' => $id,
                                'mode' => $mode,
                                'page' => $page )));
                        }
                    }

                    //echo 'lalarrrrrrr';
                    $em = $this->getDoctrine()->getManager();

                    $em = $this->getDoctrine()->getManager();
                    $fiche = $em->getRepository('BaclooCrmBundle:Fiche')
                        ->searchfichebacloo2($besoin, $activite, $departement, $nbparpage, $page, $usersess, $mode);
                    $fiche2 = $em->getRepository('BaclooCrmBundle:Fiche')
                        ->searchfichebacloosp($besoin, $activite, $departement, $usersess, $mode);
                    // echo 'ccccccccccccc'.count($fiche);
                    $c = 0;
                    // $p = 0;
                    foreach($fiche2 as $fic)
                    {//$p++;
                        $ficheuser = $em->getRepository('BaclooCrmBundle:Fiche')
                            ->findBy(array('user' => $usersess, 'raisonSociale' => $fic->GetRaisonSociale(), 'ville' => $fic->GetVille()));
                        //echo 'nb resultatfind'.ceil(count($fiche));
                        if(empty($ficheuser))
                        {
                            $c++;
                        }
                    }
                    // echo $p;
                    //echo $c;
                    $grant = 'nok';	//echo 'besoin'.$besoin;echo 'activite'.$activite;echo 'departement'.$departement;
                    $em3 = $this->getDoctrine()
                        ->getManager()
                        ->getRepository('BaclooCrmBundle:Prospotbacloo');
                    $prospo2 = $em3->findByAcheter('1');$em->clear();
                    $countselect =count($prospo2); //echo '$countselect'.$countselect;
                    $nbresultats = $c;//echo 'nbresult'.$nbresultats;
                    $limitebasse = ($nbparpage*$page)-$nbparpage;//echo 'limitebasse'.$limitebasse;
                    $limitehaute = ($nbparpage*$page)+1;//echo 'limitehaute'.$limitehaute;
                    //echo 'return9';
                    // return $this->render('BaclooCrmBundle:Crm:showbacloo_list.html.twig', array(
                    // 'form'    		  => $form->createView(),
                    // 'id'	  	      => $id,
                    // 'countselect'	  => $countselect,
                    // 'nbresultats'	  => $nbresultats,
                    // 'mode'	  		  => $mode,
                    // 'limitebasse'	  => $limitebasse,
                    // 'limitehaute'	  => $limitehaute,
                    // 'nombrePage' 	  => ceil(count($fiche)/$nbparpage),
                    // 'page'	  	 	  => $page,
                    // 'grant'	  		  => $grant));


                }
            }

        }
        //echo 'mode'.$mode;
        $em = $this->getDoctrine()->getManager();
        $fiche = $em->getRepository('BaclooCrmBundle:Fiche')
            ->searchfichebacloo2($besoin, $activite, $departement, $nbparpage, $page, $usersess, $mode);
        $fiche2 = $em->getRepository('BaclooCrmBundle:Fiche')
            ->searchfichebacloosp($besoin, $activite, $departement, $usersess, $mode);
        // echo 'ccccccccccccc'.count($fiche);
        $c = 0;
        // $p = 0;
        $countficheuser = 0;
        foreach($fiche2 as $fic2)
        {//$p++;
            $ficheuser = $em->getRepository('BaclooCrmBundle:Fiche')
                ->findBy(array('user' => $usersess, 'raisonSociale' => $fic2->GetRaisonSociale(), 'ville' => $fic2->GetVille()));
            //echo 'nb resultatfind'.ceil(count($fiche));
            $countficheuser += count($ficheuser);
            if(empty($ficheuser))
            {

                $c++;
            }
        }
        // echo $p;
        //echo 'countficheuser'.count($ficheuser);
        //echo 'c'.$c;
        // echo 'countfiche'.count($fiche);
        //S'il y a des fiches correspondantes à la recherche
        //if($this->getRequest()->request->get('pagination') == ''){echo 'égalité';}else{echo'pas égalité';}echo'findzzzzzzzzz'.$find.'insert'.$insert;

        if(!empty($fiche))
        {
            // echo 'pas empty result';
            //Début ajout des resultats dans la table prospotbacloo
            //echo 'countfiche1'.count($fiche);
            //On récupère l'id de l'utilisateur connecté
            $query = $em->createQuery(
                'SELECT u.id
			FROM BaclooUserBundle:User u
			WHERE u.username = :username'
            )->setParameter('username', $usersess);
            $uid = $query->getSingleScalarResult();

            //On regarde si l'utilisateur connecté est déja entegistré dans la table prospects
            $em2 = $this->getDoctrine()
                ->getManager()
                ->getRepository('BaclooCrmBundle:Prospectsbacloo');
            $prospectsbacloo = $em2->findOneByUserid($uid);

            $em2 = $this->getDoctrine()
                ->getManager()
                ->getRepository('BaclooCrmBundle:Prospotbacloo');
            $prospotbacloo = $em2->findByUser($usersess);
            $countprospotbacloo = count($prospotbacloo);

            // si le nombre de prospot est inférieur au nombre de résultats on insère
            if(count($fiche)> $countprospotbacloo)
            {
                //S'il n'y a pas encore de prospot dans la table prosppotbacloo
                $i=0;
                // Pour chaque fiche trouvée on l'insère dans la table prospot
                foreach($fiche as $fic)
                {
                    $i++;
                    // echo $fic->getRaisonSociale();
                    // echo 'on insere';
                    $em = $this->getDoctrine()
                        ->getManager();
                    $query = $em->createQuery(
                        'SELECT u.email
					FROM BaclooUserBundle:User u
					WHERE u.username = :username'
                    )->setParameter('username', $fic->GetUser());
                    $mail = $query->getSingleScalarResult();

                    //echo 'nb resultat3'.ceil(count($fiche));echo 'findinterieur'.$find;

                    $ficheuser = $em->getRepository('BaclooCrmBundle:Fiche')
                        ->findBy(array('user' => $usersess, 'raisonSociale' => $fic->GetRaisonSociale(), 'ville' => $fic->GetVille()));
                    // $countficheuser += count($ficheuser);
                    // echo 'countficheuser'.ceil(count($ficheuser));
                    if(empty($ficheuser) && $toc != 1)
                    {
                        // echo 'ficheuserempty1';echo ' toc'.$toc.'insert'.$insert;
                        $prospot = new Prospotbacloo();
                        $prospot->setRaisonSociale($fic->GetRaisonSociale());
                        $prospot->setActivite($fic->GetActivite());
                        $prospot->setCp(substr($fic->GetCp(), 0, 2));
                        $prospot->setVille($fic->GetVille());
                        $prospot->setBesoins($fic->GetTags());
                        $prospot->setDescbesoins($fic->GetDescbesoins());
                        $prospot->setVendeur($fic->GetUser());
                        $prospot->setVemail($mail);
                        $prospot->setFicheid($fic->GetId());
                        $prospot->setAVendre($fic->GetAVendre());
                        $prospot->setAVendrec($fic->GetAVendrec());
                        $prospot->setPrixavcont($fic->GetPrixavcont());
                        $prospot->setPrixsscont($fic->GetPrixsscont());
                        $prospot->setUser($usersess);
                        $prospot->setLastmodif($fic->GetLastmodif());
                        $prospot->addProspectsbacloo($prospectsbacloo);
                        $prospectsbacloo->addProspotbacloo($prospot);

                        $em = $this->getDoctrine()->getManager();
                        $em->persist($prospot);
                        $em->persist($prospectsbacloo);

                        $find = 'ok';//Permet de bloquer la réinsertion à la fin de showbacloolist.
                        //echo 'iiiiiiiiiiiiiiii'.$i;
                        // FIN AJOUT
                    }
                    else
                    {
                        //echo 'ficheuser plein1'.$fic->GetRaisonSociale();
                    }
                    //echo 'iiiiiiiiiiiiiiii'.$i;
                    // FIN AJOUT
                }
                $em->flush();
            }
            //echo 'iiiiiiiiiiiiiiii'.$i;

        }
        $grant = 'nok';	//echo 'besoin2'.$besoin;echo 'activite'.$activite;echo 'departement'.$departement;
        $em3 = $this->getDoctrine()
            ->getManager()
            ->getRepository('BaclooCrmBundle:Prospotbacloo');
        $prospo2 = $em3->findByAcheter('1');
        $em->clear();
        $countselect =count($prospo2); //echo '$countselect'.$countselect;
        $nbresultats = $c - $countficheuser;//echo 'nbresult'.$nbresultats;
        $limitebasse = ($nbparpage*$page)-$nbparpage;//echo 'limitebasse'.$limitebasse;
        $limitehaute = ($nbparpage*$page)+1;//echo 'limitehaute'.$limitehaute;
        $em2 = $this->getDoctrine()
            ->getManager()
            ->getRepository('BaclooCrmBundle:Prospectsbacloo');
        $prospota2 = $em2->findOneByUserid($uid);
        //echo 'countprospoota2'.count($prospota2);
        // On créé le formulaire
        $form = $this->createForm(new ProspectsbaclooType(), $prospota2);
        //echo 'return5';
        return $this->render('BaclooCrmBundle:Crm:showbacloo_list.html.twig', array(
            'form'    		  => $form->createView(),
            'id'	  	      => $id,
            'countselect'	  => $countselect,
            'nbresultats'	  => $nbresultats,
            'mode'	  		  => $mode,
            'limitebasse'	  => $limitebasse,
            'limitehaute'	  => $limitehaute,
            'nombrePage' 	  => ceil($nbresultats/$nbparpage),
            'page'	  	 	  => $page,
            'grant'	  		  => $grant));
    }

    public function searchuserAction($mode, Request $request)
    {
        $page=1;
        if(!isset($page) || $page == 0){$page =1;}
        $usersess = $this->get('security.context')->getToken()->getUsername(); if(empty($usersess) or !isset($usersess) or $usersess == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}//Récupère le nom d'utilisateur
        $em = $this->getDoctrine()->getManager();

        //On met l'anti refresh à
        $session = $request->getSession();//echo '1';
        $session->remove('controle');//echo '2';
        $session = new Session();//echo '3';
        $session->set('controle', '0');//echo '4';

        $query = $em->createQuery(
            'SELECT u.id
			FROM BaclooUserBundle:User u
			WHERE u.username = :username'
        )->setParameter('username', $usersess);
        $uid = $query->getSingleScalarResult();


        // On crée un objet Search
        $searchuser = new Searchuser;
        $form = $this->createForm(new SearchuserType(), $searchuser);
        $request = $this->getRequest();
        if ($request->getMethod() == 'POST') {
            $form->bind($request);
            if ($form->isValid()) {
                // On Flush la recherche

                $em->persist($searchuser);
                // on flush le tout
                $em->flush();

                // On redirige vers la page de visualisation de recherche
                //ici l'array doit se constituer en fonction des champs de formulaire remplis
                $id = $searchuser->getid();
                return $this->redirect($this->generateUrl('bacloocrm_finduser', array('id' => $id, 'mode' => $mode)
                ));
            }
        }
        //echo 'ici?';
        $previous = $this->get('request')->server->get('HTTP_REFERER');
        return $this->render('BaclooCrmBundle:Crm:searchuser.html.twig', array('form' => $form->createView(), 'previous' => $previous ,'resultats' => 'begin', 'mode' => $mode));
    }

    public function finduserAction($id, $page, $mode, Request $request)
    {//echo 'find';
        $usersess = $this->get('security.context')->getToken()->getUsername(); if(empty($usersess) or !isset($usersess) or $usersess == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        // On récupère l'EntityManager
        $em = $this->getDoctrine()
            ->getManager();
        $previous = $this->get('request')->server->get('HTTP_REFERER');

        $partenaires  = $em->getRepository('BaclooCrmBundle:Partenaires')
            ->findByUsername($usersess);

        $searchuser = $em->getRepository('BaclooCrmBundle:Searchuser')->find($id);
        $username = $searchuser->getUsername();//echo 'u'.$username;
        $activite = $searchuser->getActivite();//echo 'activ'.$activite;
        $nom = $searchuser->getNom();//echo 'nom'.$nom;
        $tags = $searchuser->getTags();//echo 'tag'.$tags;
        $actvise = $searchuser->getActvise();//echo 'actv'.$actvise;
        //$usersess = 'jmr';
        //$fiche = new Fiche;
        if($mode == 'bigsearch')
        {
            $resultats = $em->getRepository('BaclooUserBundle:User')
                ->recupuser($username, $nom, $activite, $tags, $actvise, 10, $page);
        }
        else
        {
            $em = $this->getDoctrine()->getManager();
            $em = $this->getDoctrine()->getManager();
            $query = $em->createQuery(
                'SELECT u
						FROM BaclooUserBundle:User u
						WHERE u.username = :username'
            )->setParameter('username', $username);
            $resultats = $query->getResult();
        }
        if(!empty($resultats )){
            //echo 'pas empty result';
            // On crée un objet Search
            $searchuser = new Searchuser;
            $form = $this->createForm(new SearchuserType(), $searchuser);
            $request = $this->getRequest();
            if ($request->getMethod() == 'POST') {//echo 'post';
                $form->bind($request);
                if ($form->isValid()) {
                    // On Flush la recherche
                    $em = $this->getDoctrine()->getManager();
                    $em->persist($searchuser);
                    // on flush le tout
                    $em->flush();


                    // On redirige vers la page de visualisation de recherche
                    return $this->redirect($this->generateUrl('bacloocrm_finduser', array('id' => $searchuser->getId())));//getID ?? non ?
                }
            }
            //echo 'pas post';
            $session = $request->getSession();
            $idfiche = $session->get('idfiche');//echo'toto';
            $countresult = count($resultats);
            //echo 'uiuoiu'.$idfiche;if(isset($partenaires)){ echo 'ok part';} elseif(empty($partenaires)){echo 'part vide';}
            return $this->render('BaclooCrmBundle:Crm:searchuser.html.twig', array(
                'id' => $id,
                'user' => $usersess,
                'page' => $page,
                'mode' => $mode,
                'idfiche' => $idfiche,
                'previous' => $previous,
                'nombrePage' => ceil($countresult/10),
                'resultats' => $resultats,
                'partenaires' => $partenaires,
                'form' => $form->createView()
            ));
        }
        else{//echo 'resultat vide';
            // On crée un objet Search
            $searchuser = new Searchuser;
            $form = $this->createForm(new SearchuserType(), $searchuser);
            $request = $this->getRequest();
            if ($request->getMethod() == 'POST') {
                $form->bind($request);
                if ($form->isValid()) {
                    // On Flush la recherche
                    $em = $this->getDoctrine()->getManager();
                    $em->persist($searchuser);
                    // on flush le tout
                    $em->flush();

                    // On redirige vers la page de visualisation de recherche
                    return $this->redirect($this->generateUrl('bacloocrm_finduser', array('id' => $searchuser->getFicheid())));
                }
            }//echo 'glax';
            return $this->render('BaclooCrmBundle:Crm:searchuser.html.twig', array('form' => $form->createView(), 'resultats' => 'rien', 'previous' => $previous, 'partenaires' => $partenaires, 'mode' => $mode));
        }

    }

    public function ajouterfavorisAction($favuserid, $mode)
    {
//echo 'favuserid'.$favuserid;
        $usersess = $this->get('security.context')->getToken()->getUsername(); if(empty($usersess) or !isset($usersess) or $usersess == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}//Récupère le nom d'utilisateur
        //Début ajout des favoris
        $previous = $this->get('request')->server->get('HTTP_REFERER');

        //On récupère l'id de l'utilisateur connecté
        $em = $this->getDoctrine()->getManager();
        $query = $em->createQuery(
            'SELECT u
						FROM BaclooUserBundle:User u
						WHERE u.username = :username'
        )->setParameter('username', $usersess);
        $user = $query->getSingleResult();

        //On regarde si l'utilisateur connecté est déja entegistré dnas la table userfav
        $em2 = $this->getDoctrine()
            ->getManager()
            ->getRepository('BaclooCrmBundle:Userfav');
        $userfav = $em2->findOneByUserid($user->getId());

        //On récupère les anciens utilisateutrs favoris proposés à l'utilisateur connecté
        // $em = $this->getDoctrine()
        // ->getManager()
        // ->getRepository('BaclooCrmBundle:Favoris');
        // $ancfavoris = $em->findByUsername(array(
        // 'user'=>$usersess));

        if(empty($userfav))//Si utilisateur pas enregistré dans userfav
        {
            //On enregistre le userid dans userfav
            $userfav = new userfav();
            $userfav->setUserid($user->getId());
            $em = $this->getDoctrine()->getManager();
            $em->persist($userfav);

        }
        // echo 'dabord';
        //Maintenant que userfav a son uid on enregistre les favoris


        $newfavori = $em->getRepository('BaclooCrmBundle:favoris')
            ->findOneByfavuserid($favuserid);
        //Si l'utilisateur n'est pas dans les favoris on l'ajoute
        if(empty($newfavori))
        {
            //echo 'ici';
            $em = $this->getDoctrine()->getManager();
            $query = $em->createQuery(
                'SELECT u
						FROM BaclooUserBundle:User u
						WHERE u.id = :id'
            )->setParameter('id', $favuserid);
            $newfavoris = $query->getSingleResult();

            // Partie envoi du mail
            $em = $this->getDoctrine()->getManager();
            $destinataire  = $em->getRepository('BaclooUserBundle:User')
                ->findOneByUsername($newfavoris->getUsername());

            $objUser = $this->get('security.context')->getToken()->getUsername(); if(empty($objUser) or !isset($objUser) or $objUser == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
            $expediteur  = $em->getRepository('BaclooUserBundle:User')
                ->findOneByUsername($user->getUsername());
            // Récupération du service
            $mailer = $this->get('mailer');

            $message = \Swift_Message::newInstance()
                ->setSubject($destinataire->getPrenom().' : L\'utilisateur '.$expediteur->getNom().' vous a ajouté dans sa liste de collègues sur Bacloo')
                ->setFrom(array('bacloo@bacloo.fr' => 'Bacloo CRM'))
                ->setTo($destinataire->getEmail())
                ->setBody($this->renderView('BaclooCrmBundle:Crm:new_favoris.html.twig', array('nom' 		=> $expediteur->getNom(),
                    'prenom'	=> $expediteur->getPrenom(),
                    'dest_prenom'	=> $destinataire->getPrenom()
                )))
            ;
            $mailer->send($message);

            $mailer = $this->get('mailer');

            $message = \Swift_Message::newInstance()
                ->setSubject($destinataire->getPrenom().' : L\'utilisateur '.$expediteur->getNom().' vous a ajouté dans sa liste de collègues sur Bacloo')
                ->setFrom(array('bacloo@bacloo.fr' => 'Bacloo CRM'))
                ->setTo('ringuetjm@gmail.com')
                ->setBody($this->renderView('BaclooCrmBundle:Crm:new_favoris.html.twig', array('nom' 		=> $expediteur->getNom(),
                    'prenom'	=> $expediteur->getPrenom(),
                    'dest_prenom'	=> $destinataire->getPrenom()
                )))
            ;
            $mailer->send($message);
            // Fin partie envoi mail

            //On a les infos, on enregistre dans la table favoris

            $favoris = new Favoris();
            $favoris->setUserid($user->getId());
            $favoris->setUsername($user->getUsername());
            $favoris->setFavuserid($newfavoris->getId());
            $favoris->setFavusername($newfavoris->getUsername());
            $favoris->setFavemail($newfavoris->getEmail());
            $favoris->addUserfav($userfav);
            $userfav->addFavori($favoris);
            $em = $this->getDoctrine()->getManager();
            $em->persist($favoris);
            $em->persist($userfav);
            $em->flush();

            $searchuser = new Searchuser;
            $form = $this->createForm(new SearchuserType(), $searchuser);//echo 'glox';
            return $this->render('BaclooCrmBundle:Crm:searchuser.html.twig', array(
                'newfavusername' => $newfavoris->GetUsername(),
                'previous' => $previous,
                'mode' => $mode,
                'resultats' => 'ajoutok',
                'form' => $form->createView()
            ));
        }
        else
        {
            //echo 'la';
            $em = $this->getDoctrine()->getManager();
            $query = $em->createQuery(
                'SELECT u
						FROM BaclooUserBundle:User u
						WHERE u.id = :id'
            )->setParameter('id', $favuserid);
            $newfavoris = $query->getSingleResult();

            $searchuser = new Searchuser;
            $form = $this->createForm(new SearchuserType(), $searchuser);
            $previous = $this->get('request')->server->get('HTTP_REFERER');	//echo 'ppppp';
            return $this->render('BaclooCrmBundle:Crm:searchuser.html.twig', array('form' => $form->createView(),'resultats' => 'ajoutok', 'newfavusername' => $newfavoris->GetUsername(), 'previous' => $previous, 'mode' => $mode));
        }
// FIN COTE AJOUT userfav
    }

    public function showfavorisAction()
    {
        $usersess = $this->get('security.context')->getToken()->getUsername(); if(empty($usersess) or !isset($usersess) or $usersess == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}//Récupère le nom d'utilisateur

        //On récupère l'id de l'utilisateur connecté
        $em = $this->getDoctrine()->getManager();
        $query = $em->createQuery(
            'SELECT u.id
				FROM BaclooUserBundle:User u
				WHERE u.username = :username'
        )->setParameter('username', $usersess);
        $uid = $query->getSingleScalarResult();

        //On récupère les favoris de l'utilisateur connecté
        $em2 = $this->getDoctrine()
            ->getManager()
            ->getRepository('BaclooCrmBundle:Favoris');
        $favo = $em2->findByUsername($usersess);

        //Tag OK s'il y a des favoris sinon NOK
        if(isset($favo) && !empty($favo)){$grant = 'ok';}else{$grant = 'nok';}

        //On récupère les userfav du user connecté
        $em2 = $this->getDoctrine()
            ->getManager()
            ->getRepository('BaclooCrmBundle:Userfav');
        $userfava = $em2->findOneByUserid($uid);

        // On créé le formulaire
        $form = $this->createForm(new UserfavType(), $userfava);
        // on soumet la requete
        $request = $this->getRequest();

        //echo 'method'.$request->getMethod();
        if ($request->getMethod() == 'POST') {
            // On fait le lien Requête <-> Formulaire
            $form->bind($request);
            if ($form->isValid())
            {
                //echo 'form valide'.$grant;
                // if(!isset($form->get('favoris')->getData())){echo 'form vide';}else{echo 'form plein';}
                //on rend invisible les favoris qui ont été suppr

                //pour chaque favoris en bdd
                $isforeach = 0;
                foreach ($form->get('favoris')->getData() as $rb)
                {
                    foreach($favo as $fav)
                    {
                        $isforeach = 1;
                        // echo 'favok'.$fav->getFavusername();
                        // echo 'favt2'.$fav4->getToutpart();
                        // if(isset($rb->getFavusername())){echo 'formfav ok';}else{echo 'formfav viiiide';}


                        $em2 = $this->getDoctrine()
                            ->getManager()
                            ->getRepository('BaclooCrmBundle:Favoris');
                        $favok2 = $em2->findOneBy(array('username' => $rb->getFavusername(), 'username'  => $usersess));

                        $em = $this->getDoctrine()
                            ->getManager()
                            ->getRepository('BaclooCrmBundle:Alteruser');
                        $alter = $em->findOneBy(array('username' => $fav->getUsername(), 'proprio'  => $usersess));

                        //S'il n'y a pas de favoris équivalent dans le formulaire ---> c'est qu'il a été supprimé

                        //echo $fav->getFavusername().' vs '. $rb->getFavusername();
                        if($fav->getFavusername() == $rb->getFavusername())
                        {
                            $suppr = 0;
                        }
                        else
                        {
                            $suppr = 1;
                        }

                        //echo  '  suppr'.$suppr;
                        if($suppr == 1)
                        {
                            //echo 'remove'.$fav->getFavusername();
                            $em = $this->getDoctrine()
                                ->getManager();
                            $em->remove($fav);
                            if(isset($alter))
                            {
                                foreach($alter as $alt)
                                {
                                    $em->remove($alter);
                                }
                            }
                            $em->detach($rb);
                            $em->detach($favok2);
                            $em->detach($userfava);
                            $em->flush();
                        }
                        elseif($rb->getToutpart() == 1 )
                        {//echo 'ici';echo 'favt'.$fav->getToutpart();
                            $em = $this->getDoctrine()->getManager();
                            $em->clear();
                            $em2->clear();
                            $favoris = $em->getRepository('BaclooCrmBundle:Favoris')
                                ->findOneBy(array('username' => $usersess, 'favusername' => $fav->getFavusername()));
                            // $em->detach($rb);
                            // $em->detach($favok2);
                            $em->detach($userfava);
                            // $em->detach($fav);
                            $favoris->setToutpart(1);
                            $em->persist($favoris);
                            $em->flush();
                        }
                        elseif($fav->getToutpart() == 0 && $rb->getToutpart() != 1)
                        {//echo 'ico';echo 'favt2'.$fav->getToutpart();
                            $em = $this->getDoctrine()->getManager();
                            $em->clear();
                            $em2->clear();
                            $favoris = $em->getRepository('BaclooCrmBundle:Favoris')
                                ->findOneBy(array('username' => $usersess, 'favusername' => $fav->getFavusername()));
                            // $em->detach($rb);
                            // $em->detach($favok2);
                            $em->detach($userfava);
                            // $em->detach($fav);
                            $favoris->setToutpart(0);
                            $em->persist($favoris);
                            $em->flush();
                        }
                    }
                }
                //echo $isforeach;
                if(empty($favok2) || $isforeach == 0)
                {
                    foreach($favo as $fav)
                    {
                        //echo 'remove2';
                        $em = $this->getDoctrine()->getManager();
                        $em->remove($fav);
                        // $em->detach($rb);
                        // $em->detach($userfava);

                        $em = $this->getDoctrine()->getManager();
                        $favo1 = $em->getRepository('BaclooCrmBundle:Favoris')
                            ->findOneBy(array('username' => $usersess, 'favusername' => $fav->getFavusername()));

                        $alter = $em->getRepository('BaclooCrmBundle:Alteruser')
                            ->findOneBy(array('username' => $favo1->getUsername(), 'proprio' => $usersess));
                        if(isset($alter) && !empty($alter))
                        {
                            foreach($alter as $alt)
                            {
                                //echo 'remove2';
                                $em->remove($alt);
                                // $em->detach($rb);
                                // $em->detach($userfava);
                                // $em->flush();
                            }
                        }
                        $em->flush();
                    }
                }
                // $em->flush();
                // On enregistre les prospects en base de donnée afin d'avoir son id
                return $this->redirect($this->generateUrl('bacloocrm_showfavoris'));
                //echo 'bogo';
            }
        }
        //echo 'baga';
        //On récupère les userfav du user connecté
        // $em2->clear();
        // $em->clear();
        $em2 = $this->getDoctrine()
            ->getManager()
            ->getRepository('BaclooCrmBundle:Userfav');
        $userfava = $em2->findOneByUserid($uid);

        // On créé le formulaire
        $form = $this->createForm(new UserfavType(), $userfava);
        return $this->render('BaclooCrmBundle:Crm:favoris_list.html.twig', array(
            'form'    => $form->createView(),
            'grant'	  => $grant
        ));

    }

    public function donnerficheAction($ficheid, $username, Request $request)
    {//echo $ficheid;
        //echo $username;
        $em = $this->getDoctrine()->getManager();
        //On récupère les détails de la fiche vendue

        $fichecheck  = $em->getRepository('BaclooCrmBundle:Fiche')
            ->findOneBy(array('copyof' => $ficheid, 'user' => $username));
        if(!isset($fichecheck))
        {//echo 'iciiiiiii';
            $fiche  = $em->getRepository('BaclooCrmBundle:Fiche')
                ->find($ficheid);

            $session = $request->getSession();//echo '2';
            $controle = $session->get('controle');//echo '4';
            //echo 'controle--- = '.$controle.'   ';
            $controle++;
            //echo 'controle = '.$controle.'   ';
            if($controle == 1)
            {
                //On récupère l'id du vendeur
                $query = $em->createQuery(
                    'SELECT u.id
						FROM BaclooUserBundle:User u
						WHERE u.username LIKE :username'
                );
                $query->setParameter('username', $fiche->getUser());
                $vendeurid = $query->getSingleScalarResult();
                //echo '2';

                //Si les crédits de l'acheteur sont inférieurs au prix d'achat
                //on retourne message crédits insufisants

                //Si les crédits sont suffisants ont valide la transaction
                $grant = 'ok';
                $today = date('Y-m-d');
                $vente = 'don';
                //Début clonage
                $fiche->getEvent()->clear();
                $textememo = '0';
                $copyfiche = clone $fiche;
                $Memo = $copyfiche->getMemo();//echo '2.4';
                if(isset($Memo))
                {
                    $em->detach($Memo);	//echo '2.5';
                }
                $copyfiche->setCopyof($fiche->getId());
                $copyfiche->setUser($username);
                $copyfiche->setTypefiche('prospect');
                $copyfiche->setAVendre('0');
                $copyfiche->setAVendrec('0');
                $copyfiche->setPrixsscont('0');
                $copyfiche->setPrixavcont('0');

                $em->persist($copyfiche);
                //echo '3';
                $em->flush();

                //Maintenant on renseigne le champ copyof de cette copie
                $em = $this->getDoctrine()
                    ->getManager()
                    ->getRepository('BaclooCrmBundle:Fiche');
                // On récupère la fiche qui nous intéresse
                $fichecopy = $em->findOneBy(array('raisonSociale' => $fiche->getRaisonSociale(),
                    'user' => $username));
                $fichecopyid = $fichecopy->getId();
                // $em2 = $this->getDoctrine()
                // ->getManager()
                // ->getRepository('BaclooCrmBundle:Transac');
                // $transac = $em2->findOneByUserid($uid);
                $em = $this->getDoctrine()->getManager();
                $transac = $em->getRepository('BaclooCrmBundle:Transac')
                    ->findOneByVendeur('1234');
                if(empty($transac))
                {
                    $transac = new Transac();
                    $transac->setVendeur('1234');
                    $transac->setAcheteur('1234');
                    $em = $this->getDoctrine()->getManager();
                    $em->persist($transac);

                }
                $transaction = new Transaction();
                $transaction->setRaisonSociale($fiche->GetRaisonSociale());
                $transaction->setVendeur($fiche->GetUser());
                $transaction->setAcheteur($username);
                $transaction->setDate($today);
                $type = 'Don avec les contacts';
                $transaction->setPrix('0');
                $transaction->setTypetransac($type);
                $transaction->setControle('1234');
                $transaction->setFicheid($ficheid);
                $transaction->setNficheid($fichecopyid);
                $transaction->addTransac($transac);
                $transac->addTransaction($transaction);
                $em = $this->getDoctrine()->getManager();
                $em->persist($transaction);
                $em->persist($transac);
                $fiche->getBrappels()->clear();
                $em->flush();

                $destinataire  = $em->getRepository('BaclooUserBundle:User')
                    ->findOneByUsername($username);

                $expediteur  = $em->getRepository('BaclooUserBundle:User')
                    ->findOneByUsername($fiche->getUser());
                // Partie envoi du mail
                // Récupération du service
                $mailer = $this->get('mailer');
                $exp_prenom = $expediteur->getPrenom();
                if(isset($exp_prenom))
                {
                    $exp_prenom = $expediteur->getNom().' '.$expediteur->getPrenom();
                }
                else
                {
                    $exp_prenom = $expediteur->getUsername();
                }

                $message = \Swift_Message::newInstance()
                    ->setSubject($exp_prenom.' a une piste commerciale pour vous')
                    ->setFrom(array('bacloo@bacloo.fr' => 'Bacloo CRM'))
                    ->setTo($destinataire->getEmail())
                    ->setBody($this->renderView('BaclooCrmBundle:Crm:new_don.html.twig', array('dest_prenom'	=> $destinataire->getPrenom(),
                        'societe'	=> $fiche->GetRaisonSociale(),
                        'exp_prenom'	=> $exp_prenom
                    )))
                ;
                $mailer->send($message);

                $mailer = $this->get('mailer');

                $message = \Swift_Message::newInstance()
                    ->setSubject($exp_prenom.' a une piste commerciale pour vous')
                    ->setFrom(array('bacloo@bacloo.fr' => 'Bacloo CRM'))
                    ->setTo('ringuetjm@gmail.com')
                    ->setBody($this->renderView('BaclooCrmBundle:Crm:new_don.html.twig', array('dest_prenom'	=> $destinataire->getPrenom(),
                        'societe'	=> $fiche->GetRaisonSociale(),
                        'exp_prenom'	=> $exp_prenom
                    )))
                ;
                $mailer->send($message);
                // Fin partie envoi mail
                $controle++;
                $session->set('controle', $controle);//echo '4';
                //FIN CLONAGE

                $previous = $this->get('request')->server->get('HTTP_REFERER');
                return $this->render('BaclooCrmBundle:Crm:buyfiche.html.twig', array(
                    'previous'    => $previous,
                    'grant'    => $grant,
                    'typev'	   => 'avc',
                    'ficheid'  => $ficheid,
                    'vendeur'  => $fiche->getUser(),
                    'acheteur' => $username,
                    'vente'    => $vente,
                    'fichecopyid'    => $fichecopyid,
                    'raisonsociale'    => $fiche->GetRaisonSociale()
                ));
            }
            else
            {//echo 'zarb';
                return $this->redirect($this->generateUrl('bacloocrm_searchuser', array('mode' => 'donner')));
            }
        }
        else
        {//echo 'occcciiiiiioooo';
            $previous = $this->get('request')->server->get('HTTP_REFERER');
            return $this->render('BaclooCrmBundle:Crm:buyfiche.html.twig', array(
                'previous'    => $previous,
                'grant'    => 'dejadonne',
                'acheteur' => $username,
                'raisonsociale'    => $fichecheck->GetRaisonSociale()
            ));
        }
    }

    public function donemailAction($id, Request $request)
    {
        $session = $request->getSession();//echo '1';
        $session->remove('controle5');//echo '2';
        $session = new Session();//echo '3';
        $session->set('controle5', '0');//echo '4';

        $usersess = $this->get('security.context')->getToken()->getUsername(); if(empty($usersess) or !isset($usersess) or $usersess == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        $em = $this->getDoctrine()->getManager();
        $expediteur  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($usersess);
        if($id == 0)
        {
            //echo '1';
            $donemail = new Donemail();

            $form = $this->createForm(new DonemailType(), $donemail);
            //echo '2';				// on soumet la requete
            $request = $this->getRequest();
            $send = 'nok';
            if ($request->getMethod() == 'POST') {
                // On fait le lien Requête <-> Formulaire
                $form->bind($request);
                if ($form->isValid())
                {
                    $email = $form->get('email')->getData();
                    $findme   = '@';
                    $pos = strpos($email, $findme);

                    $check  = $em->getRepository('BaclooCrmBundle:Donemail')
                        ->findOneBy(array('email' => $form->get('email')->getData(), 'parrainpseudo'  => $usersess, 'ficheid' => 0));
                    if(!isset($check) && $pos !== false)
                    {

                        $today = date('Y-m-d');
                        $donemail->setEmail($form->get('email')->getData());
                        $donemail->setFicheid(0);
                        $donemail->setRaisonsociale($form->get('raisonsociale')->getData());
                        $donemail->setParrainid($expediteur->getId());
                        $donemail->setParrainpseudo($expediteur->getUsername());
                        $donemail->setPoint(1);
                        $donemail->setDate($today);
                        $em = $this->getDoctrine()->getManager();
                        $em->persist($donemail);

                        $creditsfinal = $expediteur->getCredits() + 1;
                        $expediteur->setCredits($creditsfinal);

                        $em->flush();


                        // Partie envoi du mail
                        // Récupération du service
                        $mailer = $this->get('mailer');
                        $data = $form->getData();
                        $message = \Swift_Message::newInstance()
                            ->setSubject($form->get('raisonsociale')->getData().' - '.$expediteur->getPrenom().' '.$expediteur->getNom().' vous invite à rejoindre Bacloo.fr pour trouver vos futurs clients')
                            ->setFrom(array('bacloo@bacloo.fr' => 'Bacloo CRM'))
                            ->setTo($form->get('email')->getData())
                            ->setBody($this->renderView('BaclooCrmBundle:Crm:envoi_invitation.html.twig', array('filleul' =>$form->get('raisonsociale')->getData(),
                                'pseudo' =>$expediteur->getUsername(),
                                'nom' =>$expediteur->getNom(),
                                'prenom' =>$expediteur->getPrenom())))
                            ->setContentType("text/html");
                        $mailer->send($message);
                        // Fin partie envoi mail

                        // Partie envoi du mail
                        // Récupération du service
                        $mailer = $this->get('mailer');
                        $data = $form->getData();
                        $message = \Swift_Message::newInstance()
                            ->setSubject($form->get('raisonsociale')->getData().' - '.$expediteur->getPrenom().' '.$expediteur->getNom().' vous invite à rejoindre Bacloo.fr pour trouver vos futurs clients')
                            ->setFrom(array('bacloo@bacloo.fr' => 'Bacloo CRM'))// ->setTo($form->get('email')->getData())
                            ->setTo('ringuetjm@gmail.com')
                            ->setBody($this->renderView('BaclooCrmBundle:Crm:envoi_invitation.html.twig', array('filleul' =>$form->get('raisonsociale')->getData(),
                                'pseudo' =>$expediteur->getUsername(),
                                'nom' =>$expediteur->getNom(),
                                'prenom' =>$expediteur->getPrenom())))
                            ->setContentType("text/html");
                        $mailer->send($message);
                        // Fin partie envoi mail

                        $previous = $this->get('request')->server->get('HTTP_REFERER');
                        return $this->render('BaclooCrmBundle:Crm:buyfiche.html.twig', array(
                            'vente'    => 'invitation',
                            'previous' => $previous,
                            'societe'  => $form->get('raisonsociale')->getData(),
                            'grant'    => 'ok',
                            'email'	   => $form->get('email')->getData(),
                            'id'	   => $id
                        ));
                    }
                    elseif($pos === false)
                    {
                        $previous = $this->get('request')->server->get('HTTP_REFERER');
                        return $this->render('BaclooCrmBundle:Crm:buyfiche.html.twig', array(
                            'vente'    => 'badmail',
                            'previous' => $previous,
                            'grant'    => 'ok',
                            'email'	   => $form->get('email')->getData(),
                            'id'	   => $id
                        ));
                    }
                    else
                    {
                        $previous = $this->get('request')->server->get('HTTP_REFERER');
                        return $this->render('BaclooCrmBundle:Crm:buyfiche.html.twig', array(
                            'vente'    => 'deja',
                            'previous' => $previous,
                            'grant'    => 'ok',
                            'email'	   => $form->get('email')->getData(),
                            'id'	   => $id
                        ));
                    }

                }

            }//echo '3';
            $previous = $this->get('request')->server->get('HTTP_REFERER');
            return $this->render('BaclooCrmBundle:Crm:donemail.html.twig', array(
                'send'    => $send,
                'nom'    => $expediteur->getNom(),
                'prenom' => $expediteur->getPrenom(),
                'previous'=> $previous,
                'id'	  => 0,
                'form'    => $form->createView()
            ));
        }
        else
        {
            $fiche  = $em->getRepository('BaclooCrmBundle:Fiche')
                ->findOneById($id);
            //echo '1';
            $donemail = new Donemail();

            $form = $this->createForm(new DonemailType(), $donemail);
            //echo '2';				// on soumet la requete
            $request = $this->getRequest();
            $send = 'nok';
            if ($request->getMethod() == 'POST') {
                // On fait le lien Requête <-> Formulaire
                $form->bind($request);
                if ($form->isValid())
                {
                    $today = date('Y-m-d');
                    $donemail->setDate($today);
                    $donemail->setEmail($form->get('email')->getData());
                    $donemail->setFicheid($id);
                    $donemail->setRaisonsociale($fiche->getRaisonSociale());
                    $donemail->setParrainid($expediteur->getId());
                    $donemail->setParrainpseudo($expediteur->getUsername());
                    $em = $this->getDoctrine()->getManager();
                    $em->persist($donemail);
                    $em->flush();

                    // Partie envoi du mail
                    // Récupération du service
                    // $mailer = $this->get('mailer');

                    // $message = \Swift_Message::newInstance()
                    // ->setSubject('Bacloo : Un nouveau message est arrivé')
                    // ->setFrom(array('bacloo@bacloo.fr' => 'Bacloo CRM'))
                    // ->setTo($form->get('email')->getData())
                    // ->setBody($this->renderView('BaclooCrmBundle:Crm:new_donemail.html.twig', array('exp_nom' 	=> $expediteur->getNom(),
                    // 'exp_prenom'	=> $expediteur->getPrenom(),
                    // 'email'		=> $form->get('email')->getData()
                    // )));
                    // $mailer->send($message);

                    // Fin partie envoi mail

                    //DEBUT CLONAGE PROCESS

                    $session = $request->getSession();//echo '2';
                    $controle5 = $session->get('controle5');//echo '4';
                    //echo 'controle5--- = '.$controle5.'   ';
                    $controle5++;
                    //echo 'controle5 = '.$controle5.'   ';
                    if($controle5 == 1)
                    {
                        //On récupère l'id du vendeur
                        $query = $em->createQuery(
                            'SELECT u.id
							FROM BaclooUserBundle:User u
							WHERE u.username LIKE :username'
                        );
                        $query->setParameter('username', $usersess);
                        $vendeurid = $query->getSingleScalarResult();
                        //echo '2';

                        //Si les crédits de l'acheteur sont inférieurs au prix d'achat
                        //on retourne message crédits insufisants

                        //Si les crédits sont suffisants ont valide la transaction
                        $grant = 'ok';
                        $today = date('Y-m-d');
                        $vente = 'donemail';
                        //Début clonage
                        $fiche->getEvent()->clear();
                        $textememo = '0';
                        $copyfiche = clone $fiche;
                        $Memo = $copyfiche->getMemo();//echo '2.4';
                        if(isset($Memo))
                        {
                            $em->detach($Memo);	//echo '2.5';
                        }
                        $email = $form->get('email')->getData();
                        $copyfiche->setCopyof($fiche->getId());
                        $copyfiche->setUser('x');
                        $copyfiche->setTypefiche('prospect');
                        $copyfiche->setAVendre('0');
                        $copyfiche->setAVendrec('0');
                        $copyfiche->setPrixsscont('0');
                        $copyfiche->setPrixavcont('0');
                        $copyfiche->setUseremail($email);


                        $em->persist($copyfiche);
                        //echo '3';
                        $em->flush();


                        $em = $this->getDoctrine()
                            ->getManager()
                            ->getRepository('BaclooCrmBundle:Fiche');
                        // On récupère la fiche qui nous intéresse
                        $fichecopy = $em->findOneBy(array('raisonSociale' => $fiche->getRaisonSociale(),
                            'useremail' => $email));
                        $fichecopyid = $fichecopy->getId();
                        // $em2 = $this->getDoctrine()
                        // ->getManager()
                        // ->getRepository('BaclooCrmBundle:Transac');
                        // $transac = $em2->findOneByUserid($uid);
                        $em = $this->getDoctrine()->getManager();
                        $transac = $em->getRepository('BaclooCrmBundle:Transac')
                            ->findOneByVendeur('1234');
                        if(empty($transac))
                        {
                            $transac = new Transac();
                            $transac->setVendeur('1234');
                            $transac->setAcheteur('1234');
                            $em = $this->getDoctrine()->getManager();
                            $em->persist($transac);

                        }
                        $transaction = new Transaction();
                        $transaction->setRaisonSociale($fiche->GetRaisonSociale());
                        $transaction->setVendeur($fiche->GetUser());
                        $transaction->setAcheteur($email);
                        $transaction->setDate($today);
                        $type = 'Don avec les contacts';
                        $transaction->setPrix('0');
                        $transaction->setTypetransac($type);
                        $transaction->setControle('1234');
                        $transaction->setFicheid($id);
                        $transaction->setNficheid($fichecopyid);
                        $transaction->addTransac($transac);
                        $transac->addTransaction($transaction);
                        $em = $this->getDoctrine()->getManager();
                        $em->persist($transaction);
                        $em->persist($transac);
                        $fiche->getBrappels()->clear();
                        $em->flush();


                        $expediteur  = $em->getRepository('BaclooUserBundle:User')
                            ->findOneByUsername($fiche->getUser());
                        // Partie envoi du mail
                        // Récupération du service
                        $mailer = $this->get('mailer');
                        $exp_prenom = $expediteur->getPrenom();
                        if(isset($exp_prenom))
                        {
                            $exp_prenom = $expediteur->getNom().' '.$expediteur->getPrenom();
                        }
                        else
                        {
                            $exp_prenom = $expediteur->getUsername();
                        }

                        // Partie envoi du mail
                        // Récupération du service
                        $mailer = $this->get('mailer');

                        $message = \Swift_Message::newInstance()
                            ->setSubject($exp_prenom.' a une piste commerciale pour vous')
                            ->setFrom(array($expediteur->getEmail() => $exp_prenom))
                            ->setTo($email)
                            ->setBody($this->renderView('BaclooCrmBundle:Crm:new_donemail.html.twig', array('exp_prenom'	=> $exp_prenom,
                                'email'		=> $email
                            )));
                        $mailer->send($message);

                        $mailer = $this->get('mailer');

                        $mailer = $this->get('mailer');

                        $message = \Swift_Message::newInstance()
                            ->setSubject($exp_prenom.' a une piste commerciale pour vous')
                            ->setFrom(array($expediteur->getEmail() => $exp_prenom))
                            ->setTo('ringuetjm@gmail.com')
                            ->setBody($this->renderView('BaclooCrmBundle:Crm:new_donemail.html.twig', array('exp_prenom'	=> $exp_prenom,
                                'email'		=> $email
                            )));
                        $mailer->send($message);
                        // Fin partie envoi mail
                        //FIN CLONAGE
                        $controle5++;
                        $session->set('controle5', $controle5);//echo '4';
                        $previous = $this->get('request')->server->get('HTTP_REFERER');
                        return $this->render('BaclooCrmBundle:Crm:buyfiche.html.twig', array(
                            'vente'    => 'donemail',
                            'previous'    => $previous,
                            'grant'    => 'ok',
                            'societe'	=> $fiche->GetRaisonSociale(),
                            'email'	=> $email,
                            'id'	   => $id
                        ));
                    }
                    else
                    {//echo 'zarb';
                        return $this->redirect($this->generateUrl('bacloocrm_donemail'));
                    }
                }

            }//echo '3';
            return $this->render('BaclooCrmBundle:Crm:donemail.html.twig', array(
                'send'    => $send,
                'raison'  => $fiche->getRaisonSociale(),
                'id'	  => $fiche->getId(),
                'form'    => $form->createView()
            ));
        }
    }

    public function compteclientAction()
    {
        $usersess = $this->get('security.context')->getToken()->getUsername();
        $em = $this->getDoctrine()
            ->getManager();

        $query = $em->createQuery(
            'SELECT f.favusername
				FROM BaclooCrmBundle:Favoris f
				WHERE f.favusername = :favusername
				AND f.toutpart = :toutpart'
        )->setParameter('favusername', $usersess);
        $query->setParameter('toutpart', 1);
        $favoriall = $query->getResult();
        //echo 'cbien2 favoriall'.count($favoriall);

        //On créée un tableau sous le modèle 'user'=>$xxxx pour le repository
        if(isset($favoriall) && !empty($favoriall))
        {//echo 'liiiiiii';
            $i = 1;
            $b = 0;
            foreach($favoriall as $favo)
            {
                foreach($favo as $fav)
                {
                    //echo 'favo'.$fav;
                    $favor  = $em->getRepository('BaclooCrmBundle:Favoris')
                        ->findOneByFavusername($usersess);
                    ${'choix'.$i++} = $favor->getUsername();
                }
            }
            //echo 'choix1'.$choix1;
            $critere = array($usersess);

            for($j=1;$j<$i;$j++)
            {
                ${'critere'.$j} = array(${"choix".$j});
                $critere = array_merge(${'critere'.$j},$critere);
            }

        }
        else
        {
            $b = 1;
            $critere = $usersess;
        }

        $query = $em->createQuery(
            'SELECT f
		FROM BaclooCrmBundle:Fiche f
		WHERE f.user in (:user)
		AND f.typefiche = :typefiche
		ORDER BY f.raisonSociale ASC')
            ->setParameter('user', $critere)
            ->setParameter('typefiche', 'client');
        $fichesclient = $query->getResult();

        $nbclient = count($fichesclient);

        return $this->render('BaclooCrmBundle:Crm:compteclient.html.twig', array(
            'nbclient'    => $nbclient
        ));
    }

    public function compteprospectAction()
    {
        $usersess = $this->get('security.context')->getToken()->getUsername();
        $em = $this->getDoctrine()
            ->getManager();

        $query = $em->createQuery(
            'SELECT f.favusername
				FROM BaclooCrmBundle:Favoris f
				WHERE f.favusername = :favusername
				AND f.toutpart = :toutpart'
        )->setParameter('favusername', $usersess);
        $query->setParameter('toutpart', 1);
        $favoriall = $query->getResult();
        //echo 'cbien2 favoriall'.count($favoriall);

        //On créée un tableau sous le modèle 'user'=>$xxxx pour le repository
        if(isset($favoriall) && !empty($favoriall))
        {//echo 'liiiiiii';
            $i = 1;
            $b = 0;
            foreach($favoriall as $favo)
            {
                foreach($favo as $fav)
                {
                    //echo 'favo'.$fav;
                    $favor  = $em->getRepository('BaclooCrmBundle:Favoris')
                        ->findOneByFavusername($usersess);
                    ${'choix'.$i++} = $favor->getUsername();
                }
            }
            //echo 'choix1'.$choix1;
            $critere = array($usersess);

            for($j=1;$j<$i;$j++)
            {
                ${'critere'.$j} = array(${"choix".$j});
                $critere = array_merge(${'critere'.$j},$critere);
            }

        }
        else
        {
            $b = 1;
            $critere = $usersess;
        }

        $query = $em->createQuery(
            'SELECT f
		FROM BaclooCrmBundle:Fiche f
		WHERE f.user in (:user)
		AND f.typefiche = :typefiche
		ORDER BY f.raisonSociale ASC')
            ->setParameter('user', $critere)
            ->setParameter('typefiche', 'prospect');
        $fichesprospect = $query->getResult();

        $nbprospect = count($fichesprospect);

        return $this->render('BaclooCrmBundle:Crm:compteprospect.html.twig', array(
            'nbprospect'    => $nbprospect
        ));
    }

    public function comptefournisseurAction()
    {
        $proprio = $this->get('security.context')->getToken()->getUsername();
        $em = $this->getDoctrine()
            ->getManager();
        $query = $em->createQuery(
            'SELECT COUNT(f.id) as nbfournisseur
					FROM BaclooCrmBundle:Fiche f
					WHERE f.user = :user
					AND f.typefiche = :typefiche'
        );
        $query->setParameter('user', $proprio);
        $query->setParameter('typefiche', 'fournisseur');

        $nbfournisseur= $query->getSingleScalarResult();

        return $this->render('BaclooCrmBundle:Crm:comptefournisseur.html.twig', array(
            'nbfournisseur'    => $nbfournisseur
        ));
    }

    public function comptesharedAction()
    {
        $user= $this->get('security.context')->getToken()->getUsername(); //if(empty($user) or !isset($user) or $user == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        $em = $this->getDoctrine()->getManager();
        $nbshared = $em->getRepository('BaclooCrmBundle:Fiche')
            ->count_shared_fiche($user);

        return $this->render('BaclooCrmBundle:Crm:compteshared.html.twig', array(
            'nbshared'    => $nbshared
        ));
    }

    public function comptecorbeilleAction()
    {
        $proprio = $this->get('security.context')->getToken()->getUsername();
        $em = $this->getDoctrine()
            ->getManager();
        $query = $em->createQuery(
            'SELECT COUNT(f.id) as nbcorbeille
					FROM BaclooCrmBundle:Fiche f
					WHERE f.user = :user
					AND f.typefiche = :typefiche'
        );
        $query->setParameter('user', $proprio);
        $query->setParameter('typefiche', 'corbeille');

        $nbcorbeille = $query->getSingleScalarResult();

        return $this->render('BaclooCrmBundle:Crm:comptecorbeille.html.twig', array(
            'nbcorbeille'    => $nbcorbeille
        ));
    }

    public function compterappelsAction($type, $useracc, Request $request)
    {
        $user= $this->get('security.context')->getToken()->getUsername(); //if(empty($user) or !isset($user) or $user == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        $session = $request->getSession();
        $du = $session->get('du');
        $au = $session->get('au');
        if(!isset($du) && !isset($au))
        {
            $du = '2013-01-01';
            $au = date('Y-m-d');
        }
        $em = $this->getDoctrine()->getManager();
        if($type == 'accueil')
        {
            $user = $useracc;
        }
        if(is_array($user) == 1)
        {
            $nbrappels = $em->getRepository('BaclooCrmBundle:Fiche')
                ->count_rappelsarray($du, $au, $user);
        }
        else
        {
            $nbrappels = $em->getRepository('BaclooCrmBundle:Fiche')
                ->count_rappels($du, $au, $user);
        }
        return $this->render('BaclooCrmBundle:Crm:compterappels.html.twig', array(
            'nbrappels'    => $nbrappels,
            'type'    => $type
        ));
    }
    public function comptea_faireAction($type, $useracc, Request $request)
    {
        $user= $this->get('security.context')->getToken()->getUsername(); if(empty($user) or !isset($user) or $user == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        $session = $request->getSession();
        $du = $session->get('du');
        $au = $session->get('au');
        if(!isset($du) && !isset($au))
        {
            $du = '2013-01-01';
            $au = date('Y-m-d');
        }
        $em = $this->getDoctrine()->getManager();
        if($type == 'accueil')
        {
            $user = $useracc;
        }
        if(is_array($user) == 1)
        {
            $nba_faire = $em->getRepository('BaclooCrmBundle:Fiche')
                ->count_a_faire_array($du, $au, $user);
        }
        else
        {
            $nba_faire = $em->getRepository('BaclooCrmBundle:Fiche')
                ->count_a_faire($du, $au, $user);
        }


        return $this->render('BaclooCrmBundle:Crm:comptea_faire.html.twig', array(
            'nba_faire'    => $nba_faire,
            'type'    => $type
        ));
    }
    public function compterdvAction($type, $useracc, Request $request)
    {
        $user= $this->get('security.context')->getToken()->getUsername(); if(empty($user) or !isset($user) or $user == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        $session = $request->getSession();
        $du = $session->get('du');
        $au = $session->get('au');
        if(!isset($du) && !isset($au))
        {
            $du = '2013-01-01';
            $au = date('Y-m-d');
        }
        $em = $this->getDoctrine()->getManager();
        if($type == 'accueil')
        {
            $user = $useracc;
        }
        if(is_array($user) == 1)
        {
            $nbrdv = $em->getRepository('BaclooCrmBundle:Fiche')
                ->count_rdv_array($du, $au, $user);
        }
        else
        {
            $nbrdv = $em->getRepository('BaclooCrmBundle:Fiche')
                ->count_rdv($du, $au, $user);
        }


        return $this->render('BaclooCrmBundle:Crm:compterdv.html.twig', array(
            'nbrdv'    => $nbrdv,
            'type'    => $type
        ));
    }

    public function importAction()
    {
        return $this->render('BaclooCrmBundle:Crm:import_donnees.html.twig');
    }

    public function importergrilleAction($ficheid, $mode)
    {
        $session = new Session();
        if(null !== $session->get('idfiche'))
        {
            $ficheid = $session->get('idfiche');//echo $ficheid;
        }
        return $this->render('BaclooCrmBundle:Crm:importergrille.html.twig',(array('id' => $ficheid, 'mode' => $mode)));
    }

    public function exportAction()
    {
        $usersess = $this->get('security.context')->getToken()->getUsername(); if(empty($usersess) or !isset($usersess) or $usersess == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}//Récupère le nom d'utilisateur

        include('societe.php');
        $em = $this->getDoctrine()->getManager();
        // si user pas dans modules on créé sa ligne module avec les infos user
        $modules  = $em->getRepository('BaclooCrmBundle:Modules')
            ->findOneByUsername($usersess);
        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneBy(array('roleuser'=> 'admin', 'usersociete' => $societe));
        $credits = $userdetails->getCredits();
        $pseudoadmin = $userdetails->getUsername();

        if($usersess != $pseudoadmin && !empty($modules) && $modules->getBbuseractivation() == 0)
        {
            return $this->redirect($this->generateUrl('bacloocrm_user_restreint'));
        }

        return $this->render('BaclooCrmBundle:Crm:export_donnees.html.twig', array('user' => $usersess));
    }

    Public function partenairesAction($modepart, Request $request)
    {
        // echo 'fonctionne';
        $usersess = $this->get('security.context')->getToken()->getUsername(); if(empty($usersess) or !isset($usersess) or $usersess == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        // On récupère les activités connexes
        $em = $this->getDoctrine()->getManager();
        $user  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($usersess);
        $acticouser = $user->getActconnexes();
        $id = $user->getId();

        // Ouverture de la session
        $session = new Session();
        $session = $request->getSession();

        // On affecte l'id utilisateur
        $session->set('iduser', $id);
        //$session->set('init', '1');//on est en recherche

        // On traite la chaine de caractère des activités connexes de manière à les insérer dans un tableau $activites_connexes sans les virgules et autres
        $splitby = array(',',', ',' , ',' ,');
        $text = $acticouser;
        $pattern = '/\s'.implode($splitby, '\s?|\s?').'\s?/';
        $listactico = preg_split($pattern, $text, -1, PREG_SPLIT_NO_EMPTY);
        // print_r($listactico);


        //$listactico = preg_split("/\s|[\s,]+|\s?de\s?|\s?du\s?|\s?avec\s?|\s?dans\s?|\s?pour\s?|\s?des\s?|\s?les\s?/", $acticouser);
        // print_r($listactico);

        // Partie liste activités 2 cas de figure :
        // - Activités connexes nulles
        // - Activités connexes Existantes

        // Si cet utilisateur n'a pas de listactico on ne fait rien
        // Si la fiche utilisateur a le champs activités connexes renseigné, on récupère les termes dans un tableau et on rempli la table
        // $Partenaires

        if(!empty($listactico))
        {
            // On récupère la liste des utilisateurs déjà dans la table $partenaires
            $partenaires  = $em->getRepository('BaclooCrmBundle:Partenaires')
                ->findByUserid($id);
        }
        // Pour chaque activité connexe
        // On sort la liste des utilisateurs ayant dezs activités correspondantes

        $i = 0;
        foreach($listactico as $act)
        {
            $i++;
            $query = $em->createQuery(
                'SELECT u 
							FROM BaclooUserBundle:User u
							WHERE u.activite = :activite
							Group By u.id'
            );
            $query->setParameter('activite', '%'.$act.'%');

            //Liste des users ayant les activités connexes qui correspondent
            $list_partspot = $query->getResult();
            //print_r($list_partspot);

            //Si il y a déjà des utilisateurs dans la table $partenaires on les comparent au résultat de la recherche
            if(!empty($partenaires))
            {
                //Pour chaque utilisateur avec les activités connexes de la fiche
                foreach($list_partspot as $lfp)
                {
                    // On regarde s'il est présent dans la table $partenaires
                    foreach($partenaires as $lif)
                    {
                        $fichecheck  = $em->getRepository('BaclooCrmBundle:Partenaires')
                            ->findOneBy(array('userid'=> $id, 'partpotid' => $lfp->GetId()));

                        // S'il n'est pas présent on l'insère
                        if(!isset($fichecheck))
                        {
                            $diff = '1';
                            $Partenaires = new Partenaires();
                            $Partenaires->setUserid($id);
                            $Partenaires->setUsername($usersess);
                            $Partenaires->setUseractco($acticouser);
                            $Partenaires->setUsertags($user->getTags());
                            $Partenaires->setUserdescrech($user->getDescrech());
                            $Partenaires->setUseractvise($user->getActvise());
                            $Partenaires->setPartactvise($lfp->GetActvise());
                            $Partenaires->setUseractivite($user->getActivite());
                            $Partenaires->setPartpotid($lfp->GetId());
                            $Partenaires->setPartpotUsername($lfp->GetUsername());
                            $Partenaires->setActipart($lfp->GetActivite());
                            $Partenaires->setDescrech($lfp->GetDescRech());
                            $Partenaires->setTags($lfp->GetTags());
                            $Partenaires->setActicon($lfp->GetActconnexes());
                            $Partenaires->setPartenaire(0);

                            $em = $this->getDoctrine()->getManager();
                            $em->persist($Partenaires);
                            $em->flush();
                        }
                    }

                }
            }

            //Si il n'y a pas d'utilisateurs dans la table $partenaires on les rajoute d'office
            else
            {
                foreach($list_partspot as $lfp)
                {
                    $diff = '1';
                    $Partenaires = new Partenaires();
                    $Partenaires->setUserid($id);
                    $Partenaires->setUsername($usersess);
                    $Partenaires->setUseractco($acticouser);
                    $Partenaires->setUsertags($user->getTags());
                    $Partenaires->setUserdescrech($user->getDescrech());
                    $Partenaires->setUseractvise($user->getActvise());
                    $Partenaires->setPartactvise($lfp->GetActvise());
                    $Partenaires->setUseractivite($user->getActivite());
                    $Partenaires->setPartpotid($lfp->GetId());
                    $Partenaires->setPartpotUsername($lfp->GetUsername());
                    $Partenaires->setActipart($lfp->GetActivite());
                    $Partenaires->setDescrech($lfp->GetDescRech());
                    $Partenaires->setTags($lfp->GetTags());
                    $Partenaires->setActicon($lfp->GetActconnexes());
                    $Partenaires->setPartenaire(0);

                    $em = $this->getDoctrine()->getManager();
                    $em->persist($Partenaires);
                    $em->flush();
                }
            }

        }
        // Si diff = 1 on envoie un mail disant qu'il y a de nouveaux partenaires potentiels détectés ?
        if(isset($diff) && $diff == 1)
        {
            // Partie envoi du mail
            // Récupération du service
            $mailer = $this->get('mailer');
            $message = \Swift_Message::newInstance()
                ->setSubject('Bacloo : Nouveaux Partenaires Commerciaux détectés')
                ->setFrom(array('bacloo@bacloo.fr' => 'Bacloo CRM'))
                ->setTo($user->getEmail())
                ->setBody($this->renderView('BaclooCrmBundle:Crm:new_part.html.twig', array('dest_prenom'	=> $user->getPrenom(),
                    'diff'	=> $diff
                )))
            ;
            $mailer->send($message);
            // Fin partie envoi mail
        }
        if($modepart == 'partpot')
        {//echo 'ici';
            unset($partenaires);
            if(!isset($page)){$page = 1;}
            $partenaires  = $em->getRepository('BaclooCrmBundle:Partenaires')
                ->showpartenaires($id, $modepart, '0', 20, $page);

            return $this->render('BaclooCrmBundle:Crm:partpot.html.twig', array('partenaires' => $partenaires,
                'modepart' => $modepart));
        }
        elseif($modepart == 'partenaires')
        {
            if(!isset($page)){$page = 1;}
            unset($partenaires);
            $partenairess  = $em->getRepository('BaclooCrmBundle:Partenaires')
                ->showpartenaires($id, $modepart, 'ok', 20, $page);
            unset($partenaires);
            $partenaires_attente = $em->getRepository('BaclooCrmBundle:Partenaires')
                ->findBy(array('partpotid' => $id, 'partenaire' => 1));
            $i = 0;
            foreach($partenaires_attente as $parta){$i++;}//echo '$i'.$i;
            return $this->render('BaclooCrmBundle:Crm:partpot.html.twig', array('partenaires' => $partenairess,
                'partenaires_attente' => $partenaires_attente,
                'check' => $i,
                'modepart' => $modepart));
        }
    }

    public function showpartpotAction(Request $request)
    {
        $usersess = $this->get('security.context')->getToken()->getUsername();
        // On récupère les activités connexes
        //Pour count partenaires
        $refreshpart = $this->get('session')->get('countpart');
        if(isset($refreshpart))
        {
            //ne pas faire le refresh
            $i = $refreshpart;
        }
        else
        {
            //Lancer la requête
            $em = $this->getDoctrine()->getManager();

            $user  = $em->getRepository('BaclooUserBundle:User')
                ->findOneByUsername($usersess);
            $acticouser = $user->getActconnexes();
            $id = $user->getId();

            // Ouverture de la session
            $session = new Session();
            $session = $request->getSession();

            // On affecte l'id utilisateur
            $session->set('iduser', $id);
            //$session->set('init', '1');//on est en recherche

            // On traite la chaine de caractère des activités connexes de manière à les insérer dans un tableau $activites_connexes sans les virgules et autres
            $splitby = array(',',', ',' , ',' ,');
            $text = $acticouser;
            $pattern = '/\s'.implode($splitby, '\s?|\s?').'\s?/';
            $listactico = preg_split($pattern, $text, -1, PREG_SPLIT_NO_EMPTY);
            //print_r($listactico);


            //$listactico = preg_split("/\s|[\s,]+|\s?de\s?|\s?du\s?|\s?avec\s?|\s?dans\s?|\s?pour\s?|\s?des\s?|\s?les\s?/", $acticouser);
            // print_r($listactico);

            // Partie liste activités 2 cas de figure :
            // - Activités connexes nulles
            // - Activités connexes Existantes

            // Si cet utilisateur n'a pas de listactico on ne fait rien
            // Si la fiche utilisateur a le champs activités connexes renseigné, on récupère les termes dans un tableau et on rempli la table
            // $Partenaires

            if(!empty($listactico))
            {
                // On récupère la liste des utilisateurs déjà dans la table $partenaires
                $partenaires  = $em->getRepository('BaclooCrmBundle:Partenaires')
                    ->findByUserid($id);
            }
            // Pour chaque activité connexe
            // On sort la liste des utilisateurs ayant des activités correspondantes

            $i = 0;
            foreach($listactico as $act)
            {//echo '   aaa'.$act;
                $i++;
                $query = $em->createQuery(
                    'SELECT u 
													FROM BaclooUserBundle:User u
													WHERE u.activite LIKE :activite
													AND u.id != :id
													Group By u.id'
                );
                $query->setParameter('activite', '%'.$act.'%');
                $query->setParameter('id', $id);

                //Liste des users ayant les activités connexes qui correspondent
                $list_partspot = $query->getResult();
                //print_r($list_partspot);

                //Si il y a déjà des utilisateurs dans la table $partenaires on les comparent au résultat de la recherche
                if(!empty($partenaires))
                {
                    //Pour chaque utilisateur avec les activités connexes de la fiche
                    foreach($list_partspot as $lfp)
                    {//echo 'xxxxxxxxxxxxxxxx';
                        // On regarde s'il est présent dans la table $partenaires
                        foreach($partenaires as $lif)
                        {
                            $fichecheck  = $em->getRepository('BaclooCrmBundle:Partenaires')
                                ->findOneBy(array('userid'=> $id, 'partpotid' => $lfp->GetId()));

                            // S'il n'est pas présent on l'insère
                            if(!isset($fichecheck))
                            {	//echo 'AAAAAA';
                                $diff = '1';
                                $Partenaires = new Partenaires();
                                $Partenaires->setUserid($id);
                                $Partenaires->setUsername($usersess);
                                $Partenaires->setUseractco($acticouser);
                                $Partenaires->setUsertags($user->getTags());
                                $Partenaires->setUserdescrech($user->getDescrech());
                                $Partenaires->setUseractvise($user->getActvise());
                                $Partenaires->setPartactvise($lfp->GetActvise());
                                $Partenaires->setUseractivite($user->getActivite());
                                $Partenaires->setPartpotid($lfp->GetId());
                                $Partenaires->setPartpotUsername($lfp->GetUsername());
                                $Partenaires->setActipart($lfp->GetActivite());
                                $Partenaires->setDescrech($lfp->GetDescRech());
                                $Partenaires->setTags($lfp->GetTags());
                                $Partenaires->setActicon($lfp->GetActconnexes());
                                $Partenaires->setPartenaire(0);

                                $em = $this->getDoctrine()->getManager();
                                $em->persist($Partenaires);
                                $em->flush();
                            }
                        }

                    }
                }

                //Si il n'y a pas d'utilisateurs dans la table $partenaires on les rajoute d'office
                else
                {
                    foreach($list_partspot as $lfp)
                    {	//echo'kkkkkkkkkkkkkkkkkkk';
                        $diff = '1';
                        $Partenaires = new Partenaires();
                        $Partenaires->setUserid($id);
                        $Partenaires->setUsername($usersess);
                        $Partenaires->setUseractco($acticouser);
                        $Partenaires->setUsertags($user->getTags());
                        $Partenaires->setUserdescrech($user->getDescrech());
                        $Partenaires->setUseractvise($user->getActvise());
                        $Partenaires->setPartactvise($lfp->GetActvise());
                        $Partenaires->setUseractivite($user->getActivite());
                        $Partenaires->setPartpotid($lfp->GetId());
                        $Partenaires->setPartpotUsername($lfp->GetUsername());
                        $Partenaires->setActipart($lfp->GetActivite());
                        $Partenaires->setDescrech($lfp->GetDescRech());
                        $Partenaires->setTags($lfp->GetTags());
                        $Partenaires->setActicon($lfp->GetActconnexes());
                        $Partenaires->setPartenaire(0);

                        $em = $this->getDoctrine()->getManager();
                        $em->persist($Partenaires);
                        $em->flush();
                    }
                }

            }
            // Si diff = 1 on envoie un mail disant qu'il y a de nouveaux partenaires potentiels détectés ?
            if(isset($diff) && $diff == 1)
            {
                // Partie envoi du mail
                // Récupération du service
                $mailer = $this->get('mailer');
                $message = \Swift_Message::newInstance()
                    ->setSubject('Bacloo : Nouveaux Partenaires Commerciaux détectés')
                    ->setFrom(array('bacloo@bacloo.fr' => 'Bacloo CRM'))
                    ->setTo($user->getEmail())
                    ->setBody($this->renderView('BaclooCrmBundle:Crm:new_part.html.twig', array('dest_prenom'	=> $user->getPrenom(),
                        'diff'	=> $diff
                    )))
                ;
                $mailer->send($message);
                // Fin partie envoi mail
            }
            unset($partenaires);//echo 'idid'.$id;
            $partpotlist = $em->getRepository('BaclooCrmBundle:Partenaires')
                ->showpartpot($id);
            if(isset($partpotlist))
            {//echo 'iciciciii';
                $i = 0;

                foreach($partpotlist as $pl)
                {//echo 'x'.$pl->getId();
                    $i++;
                }
            }
            else
            {//echo'lalalaal';
                $i = 0;
            }
            //maj la valeur fichesvendables en session
            $this->get('session')->set('countpart', $i);
        }//echo 'iiiiiiiiiiiiiiiiiiiiii'.$i;
        return $this->render('BaclooCrmBundle:Crm:boutonpartpot.html.twig', array(
            'partpot' => $i
        ));

    }

    public function showpartatAction(Request $request)
    {
        $session = $request->getSession();
        $id = $session->get('iduser');

        $em = $this->getDoctrine()->getManager();
        $partat = $em->getRepository('BaclooCrmBundle:Partenaires')
            ->findBy(array('partpotid' => $id, 'partenaire' => 1));
        if(isset($partat))
        {//echo 'iciciciii';
            $i = 0;

            foreach($partat as $pl)
            {//echo 'x'.$pl->getId();
                $i++;
            }
        }
        else
        {//echo'lalalaal';
            $i = 0;
        }//echo 'iiiiiiiiiiiiiiiiiiiiii'.$i;
        return $this->render('BaclooCrmBundle:Crm:boutonpartat.html.twig', array(
            'partat' => $i,
            'vuestyle' => 'accueil'
        ));
    }
    public function removepartAction($id, Request $request)
    {//$id = id ligne partenaire
        $session = $request->getSession();
        $uid = $session->get('iduser');

        $em = $this->getDoctrine()->getManager();
        //On la vire des fiches vendables
        $partenaires1  = $em->getRepository('BaclooCrmBundle:Partenaires')
            ->findOneByid($id);
        //echo $id;

        $idpartenaires2  = $em->getRepository('BaclooCrmBundle:Partenaires')
            ->trouvepart2($partenaires1->GetPartpotid(), $partenaires1->GetUserid());

        $partenaires2  = $em->getRepository('BaclooCrmBundle:Partenaires')
            ->findOneByid($idpartenaires2);

        if(isset($partenaires1))
        {//echo 'ici';
            $em->remove($partenaires1);
        }

        // $remid = $partenaires2->getId();echo 'trrr'.$remid;

        if(isset($partenaires2))
        {//echo 'la';
            $em->remove($partenaires2);
        }
        $em->flush();
        $page = 1;
        $partenaires  = $em->getRepository('BaclooCrmBundle:Partenaires')
            ->showpartenaires($uid, 'partenaires', 'ok', 20, $page);

        return $this->redirect($this->generateUrl('bacloocrm_showpartlist', array('modepart' => 'partenaires')));

    }

    public function nofollowpartAction($id, Request $request)
    {//$id = id ligne partenaire
        $session = $request->getSession();
        $uid = $session->get('iduser');

        $em = $this->getDoctrine()->getManager();
        //On la vire des fiches vendables
        $partenaires1  = $em->getRepository('BaclooCrmBundle:Partenaires')
            ->findOneByid($id);

        if(isset($partenaires1))
        {
            $partenaires1->setPartenaire('nok');
            $em->flush();
        }
        $page = 1;
        $partenaires  = $em->getRepository('BaclooCrmBundle:Partenaires')
            ->showpartenaires($uid, 'partenaires', 'ok', 20, $page);

        return $this->render('BaclooCrmBundle:Crm:partpot.html.twig', array('partenaires' => $partenaires,
            'modepart' => 'partpot'));

    }

    public function followpartAction($id, Request $request)
    {//$id = id ligne partenaire

        $em = $this->getDoctrine()->getManager();
        //On la vire des fiches vendables
        $partenaires1  = $em->getRepository('BaclooCrmBundle:Partenaires')
            ->findOneByid($id);

        if(isset($partenaires1))
        {
            $partenaires1->setPartenaire('ok');
            $Partenaires = new Partenaires();
            $Partenaires->setUserid($partenaires1->GetPartpotid());
            $Partenaires->setUsername($partenaires1->GetPartpotUsername());
            $Partenaires->setUseractco($partenaires1->GetActicon());
            $Partenaires->setUsertags($partenaires1->GetTags());
            $Partenaires->setUserdescrech($partenaires1->GetDescrech());
            $Partenaires->setUseractvise($partenaires1->GetPartactvise());
            $Partenaires->setPartactvise($partenaires1->GetUseractvise());
            $Partenaires->setUseractivite($partenaires1->GetActipart());
            $Partenaires->setPartpotid($partenaires1->GetUserid());
            $Partenaires->setPartpotUsername($partenaires1->GetUsername());
            $Partenaires->setActipart($partenaires1->GetUseractivite());
            $Partenaires->setDescrech($partenaires1->GetDescRech());
            $Partenaires->setTags($partenaires1->GetUsertags());
            $Partenaires->setActicon($partenaires1->GetUseractco());
            $Partenaires->setPartenaire('ok');

            $em = $this->getDoctrine()->getManager();
            $em->persist($Partenaires);
            $em->flush();
        }
        $page = 1;
        $partenaires  = $em->getRepository('BaclooCrmBundle:Partenaires')
            ->showpartenaires($partenaires1->GetPartpotid(), 'partenaires', 'ok', 20, $page);

        $partenaires_attente = $em->getRepository('BaclooCrmBundle:Partenaires')
            ->findBy(array('partpotid' => $partenaires1->GetPartpotid(), 'partenaire' => 1));
        $i = 0;
        foreach($partenaires_attente as $parta){$i++;}//echo '$i'.$i;
        return $this->render('BaclooCrmBundle:Crm:partpot.html.twig', array('partenaires' => $partenaires,
            'partenaires_attente' => $partenaires_attente,
            'check' => $i,
            'modepart' => 'partenaires'));

    }

    public function askpartAction($id, $partpotid, $modepart, Request $request)
    {//$id = id ligne partenaire
        $session = $request->getSession();
        $uid = $session->get('iduser');

        $em = $this->getDoctrine()->getManager();
        //On la vire des fiches vendables
        if($modepart == 'partpot')
        {
            $partenaires1  = $em->getRepository('BaclooCrmBundle:Partenaires')
                ->findOneByid($id);

            if(isset($partenaires1))
            {
                $partenaires1->setPartenaire('1');
                $em->flush();
            }
            $page = 1;
            $partenaires  = $em->getRepository('BaclooCrmBundle:Partenaires')
                ->showpartenaires($uid, 'partpot', '0', 20, $page);

            // return $this->render('BaclooCrmBundle:Crm:partpot.html.twig', array('partenaires' => $partenaires,
            // 'modepart' => 'partpot'));
        }
        elseif($modepart == 'bigsearch')
        {
            //id = id de du partpot
            //$uid = id user connecté
            $partpot  = $em->getRepository('BaclooUserBundle:User')
                ->findOneByid($id);

            $user  = $em->getRepository('BaclooUserBundle:User')
                ->findOneByid($uid);

            $Partenaires = new Partenaires();
            $Partenaires->setUserid($uid);
            $Partenaires->setUsername($user->GetUsername());
            $Partenaires->setUseractco($user->GetActconnexes());
            $Partenaires->setUsertags($user->getTags());
            $Partenaires->setUserdescrech($user->getDescrech());
            $Partenaires->setUseractvise($user->getActvise());
            $Partenaires->setPartactvise($partpot->GetActvise());
            $Partenaires->setUseractivite($user->getActivite());
            $Partenaires->setPartpotid($partpot->GetId());
            $Partenaires->setPartpotUsername($partpot->GetUsername());
            $Partenaires->setActipart($partpot->GetActivite());
            $Partenaires->setDescrech($partpot->GetDescRech());
            $Partenaires->setTags($partpot->GetTags());
            $Partenaires->setActicon($partpot->GetActconnexes());
            $Partenaires->setPartenaire(1);

            $em->persist($Partenaires);
            $em->flush();
            $page = 1;
            $partenaires  = $em->getRepository('BaclooCrmBundle:Partenaires')
                ->showpartenaires($uid, 'partpot', '0', 20, $page);

            return $this->redirect($this->generateUrl('bacloocrm_finduser', array('id' => $partpotid, 'mode' => 'bigsearch')));
        }


    }

    public function publisharticleAction($artvue, Request $request)
    {
        $usersess = $this->get('security.context')->getToken()->getUsername(); if(empty($usersess) or !isset($usersess) or $usersess == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}//Récupère le nom d'utilisateur

        // On crée un objet Articles
        $articles = new Articles;
        $today = date('Y-m-d');//echo $today;
        $form = $this->createForm(new ArticlesType(), $articles);
        $request = $this->getRequest();
        if ($request->getMethod() == 'POST') {
            $form->bind($request);
            if ($form->isValid()) {
                // On Flush la recherche
                $em = $this->getDoctrine()->getManager();
                $articles->setDate($today);
                $em->persist($articles);
                // on flush le tout
                $em->flush();
                // Partie envoi du mail
                // Récupération du service
                $mailer = $this->get('mailer');
                $data = $form->getData();
                $message = \Swift_Message::newInstance()
                    ->setSubject('Bacloo : Un message a été publié sur la timeline')
                    ->setFrom(array('bacloo@bacloo.fr' => 'Bacloo CRM'))
                    ->setTo('ringuetjm@gmail.com')
                    ->setBody($this->renderView('BaclooCrmBundle:Crm:alertmessage.html.twig', array('message' =>$data->GetTexte(),
                        'auteur' =>$data->GetAuteur(),
                        'titre' =>$data->GetTitre())))
                ;
                $mailer->send($message);
                // Fin partie envoi mail

                if($artvue == 'accueil')
                {
                    return $this->redirect($this->generateUrl('bacloocrm_communication'));
                }
                else
                {
                    return $this->redirect($this->generateUrl('bacloocrm_articles'));
                }
                // si on est sur la page d'accueil on redirige vers celle-ci sinon vers la page des articles
            }
        }

        if($artvue == 'accueil')
        {//echo 'accueil';
            return $this->render('BaclooCrmBundle:Crm:publisharticle.html.twig', array('artvue' => 'accueil',
                'date' => $today,
                'auteur' => $usersess,
                'form' => $form->createView()
            ));
        }
        elseif($artvue == 'articles')
        {//echo 'articles';
            return $this->render('BaclooCrmBundle:Crm:articles.html.twig',  array('artvue' => 'articles',
                'date' => $date,
                'auteur' => $usersess,
                'form' => $form->createView()
            ));
        }
    }

    public function showarticlesAction()
    {
        $user= $this->get('security.context')->getToken()->getUsername(); if(empty($user) or !isset($user) or $user == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        $em = $this->getDoctrine()->getManager();

        $query = $em->createQuery(
            'SELECT u.id
			FROM BaclooUserBundle:User u
			WHERE u.username = :username'
        )->setParameter('username', $user);
        $uid = $query->getSingleScalarResult();

        $query = $em->createQuery(
            'SELECT p
			FROM BaclooCrmBundle:Partenaires p
			WHERE p.username = :username'
        )->setParameter('username', $user);
        $partenaires = $query->getResult();
        $articles = $em->getRepository('BaclooCrmBundle:Articles')
            ->showarticle($partenaires, $user);


        return $this->render('BaclooCrmBundle:Crm:showarticles.html.twig', array(
            'articles'    => $articles,
            'user'    	  => $user
        ));
    }

    public function editarticleAction($id)
    {
        $usersess = $this->get('security.context')->getToken()->getUsername(); if(empty($usersess) or !isset($usersess) or $usersess == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}//Récupère le nom d'utilisateur
        $previous = $this->get('request')->server->get('HTTP_REFERER');
        // On crée un objet Articles
        $em = $this->getDoctrine()->getManager();
        $articles = $em->getRepository('BaclooCrmBundle:Articles')
            ->findOneById($id);
        $form = $this->createForm(new ArticlesType(), $articles);
        $request = $this->getRequest();
        if ($request->getMethod() == 'POST') {
            $form->bind($request);
            if ($form->isValid()) {
                // On Flush la recherche

                $em->persist($articles);
                // on flush le tout
                $em->flush();
                // si on est sur la page d'accueil on redirige vers celle-ci sinon vers la page des articles

                return $this->render('BaclooCrmBundle:Crm:editarticle.html.twig', array('edit' => 'ok',
                    'auteur' => $usersess,
                    'id' => $id,
                    'previous' => $previous,
                    'form' => $form->createView()
                ));
            }
        }

        return $this->render('BaclooCrmBundle:Crm:editarticle.html.twig', array('auteur' => $usersess,
            'previous' => $previous,
            'id' => $id,
            'form' => $form->createView()
        ));

    }

    public function shareAction($id)
    {
        $usersess = $this->get('security.context')->getToken()->getUsername(); if(empty($usersess) or !isset($usersess) or $usersess == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}//Récupère le nom d'utilisateur
        $previous = $this->get('request')->server->get('HTTP_REFERER');
        $today = date('Y-m-d');//echo $today;
        // On crée un objet Articles
        $em = $this->getDoctrine()->getManager();
        $article = $em->getRepository('BaclooCrmBundle:Articles')
            ->findOneById($id);

        $articles = new articles();
        $articles->setDate($today);
        $articles->setTexte($article->getTexte());
        $articles->setAuteur($article->getAuteur());
        $articles->setSharepartenaire('1');
        $articles->setTitre($article->getTitre());
        $articles->setCategorie($article->getCategorie());
        $articles->setShare('1');
        $articles->setTransfereur($usersess);
        $em->persist($articles);
        // on flush le tout
        $em->flush();
        // si on est sur la page d'accueil on redirige vers celle-ci sinon vers la page des articles

        return $this->render('BaclooCrmBundle:Crm:sharearticle.html.twig', array('previous' => $previous
        ));
    }

    public function removeartAction($id)
    {//$id = id ligne partenaire
        $em = $this->getDoctrine()->getManager();

        $article  = $em->getRepository('BaclooCrmBundle:Articles')
            ->findOneByid($id);

        if(isset($article))
        {//echo 'ici';
            $em->remove($article);
        }

        $em->flush();
        return $this->render('BaclooCrmBundle:Crm:removearticle.html.twig');

    }

    public function showblogAction()
    {

        $em = $this->getDoctrine()->getManager();

        $query = $em->createQuery(
            'SELECT b
			FROM BaclooCrmBundle:Blog b
			ORDER BY b.id DESC'
        )->setMaxResults(5);
        $blog = $query->getResult();

        return $this->render('BaclooCrmBundle:Crm:showblogarticles.html.twig', array(
            'blog'    => $blog
        ));
    }

    public function replyartAction($id)
    {
        $usersess = $this->get('security.context')->getToken()->getUsername(); if(empty($usersess) or !isset($usersess) or $usersess == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}//Récupère le nom d'utilisateur
        $previous = $this->get('request')->server->get('HTTP_REFERER');
        $today = date('Y-m-d');//echo $today;
        // On crée un objet Articles
        $em = $this->getDoctrine()->getManager();
        $articlo = $em->getRepository('BaclooCrmBundle:Articles')
            ->findOneById($id);
        $request = $this->getRequest();
        if ($request->getMethod() == 'POST') {
            $articles = new Articles;
            $form = $this->createForm(new ArticlesType(), $articles);
            $form->bind($request);
            if ($form->isValid()) {
                // On Flush la recherche
                $articles->setDate($today);
                $articles->setCategorie($articlo->getCategorie());
                $em->persist($articles);
                // on flush le tout
                $em->flush();
                // si on est sur la page d'accueil on redirige vers celle-ci sinon vers la page des articles

                return $this->render('BaclooCrmBundle:Crm:communication.html.twig');
            }
        }

        $articles = new Articles;
        $form = $this->createForm(new ArticlesType(), $articles);

        return $this->render('BaclooCrmBundle:Crm:replyarticle.html.twig', array('user' => $usersess,
            'previous' => $previous,
            'article' => $articlo,
            'today' => $today,
            'id' => $id,
            'form' => $form->createView()
        ));

    }

    public function removeficheAction($id, $check)
    {//$id = id ligne partenaire
        $em = $this->getDoctrine()->getManager();
        $previous = $this->get('request')->server->get('HTTP_REFERER');

        if($check == '0')
        {
            return $this->render('BaclooCrmBundle:Crm:removefiche.html.twig', array('id' => $id,
                'previous' => $previous,
                'check' => 1));
        }
        elseif($check == 'ok')
        {
            $fiche  = $em->getRepository('BaclooCrmBundle:Fiche')
                ->findOneByid($id);
            $em->remove($fiche);
            $em->flush();
            return $this->render('BaclooCrmBundle:Crm:removefiche.html.twig', array('check' => $check));
        }
    }

    public function showlistinvitationsAction($page)
    {
        $usersess = $this->get('security.context')->getToken()->getUsername(); if(empty($usersess) or !isset($usersess) or $usersess == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}//Récupère le nom d'utilisateur

        $em = $this->getDoctrine()->getManager();

        $invitations = $em->getRepository('BaclooCrmBundle:Donemail')
            ->showinvitations(20, $page, $usersess);

        return $this->render('BaclooCrmBundle:Crm:showinvitations.html.twig', array(
            'invitations' => $invitations,
            'nbinvit'     => count($invitations),
            'nombrePage'  => ceil(count($invitations)/20),
            'page'        => $page
        ));
    }

    public function showlistfilleulsAction($page)
    {
        $usersess = $this->get('security.context')->getToken()->getUsername(); if(empty($usersess) or !isset($usersess) or $usersess == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}//Récupère le nom d'utilisateur

        $em = $this->getDoctrine()->getManager();

        $filleuls = $em->getRepository('BaclooUserBundle:User')
            ->recupfilleuls($usersess, 20, $page);

        return $this->render('BaclooCrmBundle:Crm:showfilleuls.html.twig', array(
            'filleuls'    => $filleuls,
            'nbfilleuls'     => count($filleuls),
            'nombrePage'  => ceil(count($filleuls)/20),
            'page'        => $page
        ));
    }

    public function speedpartageAction($id, Request $request)
    {
        $usersess = $this->get('security.context')->getToken()->getUsername(); if(empty($usersess) or !isset($usersess) or $usersess == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}//Récupère le nom d'utilisateur
        $previous = $this->get('request')->server->get('HTTP_REFERER');
        $defaultData = array();
        $form = $this->createFormBuilder($defaultData)
            ->add('pseudo', 'text', array('required' => false))
            ->getForm();

        $form->handleRequest($request);

        if ($form->isValid()) {
            // echo 'XXXXXXXXXXXXXXXX';
            // Les données sont un tableau avec les clés "name", "email", et "message"
            $data = $form->getData();
            // Partie envoi du mail
            // Récupération du service
            $user = $data['pseudo']; //echo 'uuuu'.$user;
            //Si le user est l'admin
            $em = $this->getDoctrine()->getManager();
            $userdetails  = $em->getRepository('BaclooCrmBundle:Favoris')
                ->findOneByfavusername($user);
            if(empty($userdetails))
            {
                $partager = 'pok';
            }
            else
            {
                $query = $em->createQuery(
                    'SELECT a 
					FROM BaclooCrmBundle:Alteruser a
					WHERE a.username = :username
					AND a.ficheid = :ficheid'
                );
                $query->setParameter('username', $user);
                $query->setParameter('ficheid', $id);
                $alter = $query->getResult();

                if(empty($alter))
                {
                    $fiche  = $em->getRepository('BaclooCrmBundle:Fiche')
                        ->findOneById($id);
                    $alteruser = new alteruser();
                    $alteruser->setUsername($user);
                    $alteruser->setFicheid($id);
                    $fiche->addAlteruser($alteruser);
                    $em->persist($alteruser);
                    $em->flush();
                    $partager = 'ok';
                }
                else
                {
                    $partager = 'nok';
                }
            }
// echo 'partager=='.$partager;
            return $this->render('BaclooCrmBundle:Crm:speedpartage.html.twig', array(
                'partager'    => $partager,
                'previous'    => $previous,
                'user'       => $user
            ));

        }
        return $this->render('BaclooCrmBundle:Crm:speedpartageform.html.twig', array(
            'form' 		  => $form->createView(),
            'previous'    => $previous,
            'id'    	  => $id,
            'partager'    => 'pok'
        ));
    }

    public function modulesAction(Request $request)
    {
        $usersess = $this->get('security.context')->getToken()->getUsername(); if(empty($usersess) or !isset($usersess) or $usersess == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}//Récupère le nom d'utilisateur
        $previous = $this->get('request')->server->get('HTTP_REFERER');

        $prixmodule1 = 0;
        $prixmodule2 = 0;
        $prixmodule3 = 0;
        $prixmodule4 = 0;
        $prixmodule5 = 0;
        $prixmodule6 = 0;
        $prixmodule7 = 0;
        $prixmodule8 = 0;
        $prixmodule9 = 45;
        $prixmodule10 = 0;
        $prixmodule11 = 0;
        $prixmodule12 = 0;

        $em = $this->getDoctrine()->getManager();

        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($usersess);

        // $societe = $userdetails->getUsersociete();//echo 'jkjjk'.$societe;

        // $admin = $em->getRepository('BaclooUserBundle:User')
        // ->findOneBy(array('usersociete'=>$societe, 'roleuser'=>'admin'));
        // $query = $em->createQuery(
        // 'SELECT u.credits
        // FROM BaclooUserBundle:User u
        // WHERE u.usersociete = :usersociete
        // AND u.roleuser = :roleuser');
        // $query->setParameter('usersociete', $societe);
        // $query->setParameter('roleuser', 'admin');
        // $admin = $query->getSingleScalarResult();

        $credits = $userdetails->getCredits();

        $modules  = $em->getRepository('BaclooCrmBundle:Modules')
            ->findOneByUsername($usersess);
        //Si le user n'est pas encore présent dans la table modules on en créée un nouveau
        // echo 'fggsfdgsg';
        if(empty($modules))
        {
            $table_module = 0;
            // echo'module vide';
            $modules = new Modules();
            $form = $this->createForm(new ModulesType(), $modules);
            $request = $this->getRequest();
            $form->bind($request);
            if ($request->getMethod() == 'POST')
            {
                if ($form->isValid())
                {
                    $prix = 0;
                    $module1activation = $form->get('module1activation')->getData();
                    if($module1activation == 1){$prix += $prixmodule1;}
                    $module2activation = $form->get('module2activation')->getData();
                    if($module2activation == 1){$prix += $prixmodule2;}
                    $module3activation = $form->get('module3activation')->getData();
                    if($module3activation == 1){$prix += $prixmodule3;}
                    $module4activation = $form->get('module4activation')->getData();
                    if($module4activation == 1){$prix += $prixmodule4;}
                    $module5activation = $form->get('module5activation')->getData();
                    if($module5activation == 1){$prix += $prixmodule5;}
                    $module6activation = $form->get('module6activation')->getData();
                    if($module6activation == 1){$prix += $prixmodule6;}
                    $module7activation = $form->get('module7activation')->getData();
                    if($module7activation == 1){$prix += $prixmodule7;}
                    $module8activation = $form->get('module8activation')->getData();
                    if($module8activation == 1){$prix += $prixmodule8;}
                    $module9activation = $form->get('module9activation')->getData();
                    if($module9activation == 1){$prix += $prixmodule9;}
                    $module10activation = $form->get('module10activation')->getData();
                    if($module10activation == 1){$prix += $prixmodule10;}
                    $module11activation = $form->get('module11activation')->getData();
                    if($module11activation == 1){$prix += $prixmodule11;}
                    $module11activation = $form->get('module11activation')->getData();
                    if($module11activation == 1){$prix += $prixmodule12;}

                    //Si pas suffisament de crédits on renvoie vers la fenêtre d'alerte
                    if($credits < $prix)
                    {//echo 'return1';
                        $grant = 'nok';
                        return $this->render('BaclooCrmBundle:Crm:buyfiche.html.twig', array(
                            'previous'    => $previous,
                            'credits'    => $credits,
                            'prix'    => $prix,
                            'grant'    => $grant
                        ));
                    }
                    else
                    {
                        $expiration = date('d/m/Y', strtotime("+30 days"));//echo $expiration;
                        $soldepoints = $credits - $prix;
                        $userdetails->setCredits($soldepoints);
                        if($module1activation == 1){$modules->setModule1debut(date('d/m/Y'));$modules->setModule1expiration($expiration);}
                        if($module2activation == 1){$modules->setModule2debut(date('d/m/Y'));$modules->setModule2expiration($expiration);}
                        if($module3activation == 1){$modules->setModule3debut(date('d/m/Y'));$modules->setModule3expiration($expiration);}
                        if($module4activation == 1){$modules->setModule4debut(date('d/m/Y'));$modules->setModule4expiration($expiration);}
                        if($module5activation == 1){$modules->setModule5debut(date('d/m/Y'));$modules->setModule5expiration($expiration);}
                        if($module6activation == 1){$modules->setModule6debut(date('d/m/Y'));$modules->setModule6expiration($expiration);}
                        if($module7activation == 1){$modules->setModule7debut(date('d/m/Y'));$modules->setModule7expiration($expiration);}
                        if($module8activation == 1){$modules->setModule8debut(date('d/m/Y'));$modules->setModule8expiration($expiration);}
                        if($module9activation == 1){$modules->setModule9debut(date('d/m/Y'));$modules->setModule9expiration($expiration);}
                        if($module10activation == 1){$modules->setModule10debut(date('d/m/Y'));$modules->setModule10expiration($expiration);}
                        if($module11activation == 1){$modules->setModule11debut(date('d/m/Y'));$modules->setModule11expiration($expiration);}
                        if($module12activation == 1){$modules->setModule12debut(date('d/m/Y'));$modules->setModule12expiration($expiration);}
                        $em->persist($modules);
                        $em->flush();
                    }

                    return $this->redirect($this->generateUrl('bacloocrm_modules'));

                }
            }
        }
        else
        {
            $table_module = 1;
            // echo'module plein';
            $form = $this->createForm(new ModulesType(), $modules);
            $request = $this->getRequest();
            if ($request->getMethod() == 'POST')
            {
                $form->bind($request);
                if ($form->isValid())
                {
                    $prix = 0;
                    $module1activation = $form->get('module1activation')->getData();// echo 'activation'.$module1activation;
                    $module1debut = $form->get('module1debut')->getData();
                    if($module1activation == 1 && $module1debut == null){$prix += $prixmodule1;}elseif($module1activation == 1 && $module1debut != null){}else{$modules->setModule1activation(0);$modules->setModule1debut('');$modules->setModule1expiration('');}

                    $module2activation = $form->get('module2activation')->getData();//echo $form->get('module2debut')->getData();
                    $module2debut = $form->get('module2debut')->getData();
                    if($module2activation == 1 && $module2debut == null){$prix += $prixmodule2;}elseif($module2activation == 1 && $module2debut != null){}else{$modules->setModule2activation(0);$modules->setModule2debut('');$modules->setModule2expiration('');}

                    $module3activation = $form->get('module3activation')->getData();//echo $form->get('module3debut')->getData();
                    $module3debut = $form->get('module3debut')->getData();
                    if($module3activation == 1 && $module3debut == null){$prix += $prixmodule3;}elseif($module3activation == 1 && $module3debut != null){}else{$modules->setModule3activation(0);$modules->setModule3debut('');$modules->setModule3expiration('');}

                    $module4activation = $form->get('module4activation')->getData();//echo $form->get('module4debut')->getData();
                    $module4debut = $form->get('module4debut')->getData();
                    if($module4activation == 1 && $module4debut == null){$prix += $prixmodule4;}elseif($module4activation == 1 && $module4debut != null){}else{$modules->setModule4activation(0);$modules->setModule4debut('');$modules->setModule4expiration('');}

                    $module5activation = $form->get('module5activation')->getData();//echo $form->get('module5debut')->getData();
                    $module5debut = $form->get('module5debut')->getData();
                    if($module5activation == 1 && $module5debut == null){$prix += $prixmodule5;}elseif($module5activation == 1 && $module5debut != null){}else{$modules->setModule5activation(0);$modules->setModule5debut('');$modules->setModule5expiration('');}

                    $module6activation = $form->get('module6activation')->getData();//echo $form->get('module6debut')->getData();
                    $module6debut = $form->get('module6debut')->getData();
                    if($module6activation == 1 && $module6debut == null){$prix += $prixmodule6;}elseif($module6activation == 1 && $module6debut != null){}else{$modules->setModule6activation(0);$modules->setModule6debut('');$modules->setModule6expiration('');}

                    $module7activation = $form->get('module7activation')->getData();//echo $form->get('module7debut')->getData();
                    $module7debut = $form->get('module7debut')->getData();
                    if($module7activation == 1 && $module7debut == null){$prix += $prixmodule7;}elseif($module7activation == 1 && $module7debut != null){}else{$modules->setModule7activation(0);$modules->setModule7debut('');$modules->setModule7expiration('');}

                    $module8activation = $form->get('module8activation')->getData();//echo $form->get('module8debut')->getData();
                    $module8debut = $form->get('module8debut')->getData();
                    if($module8activation == 1 && $module8debut == null){$prix += $prixmodule8;}elseif($module8activation == 1 && $module8debut != null){}else{$modules->setModule8activation(0);$modules->setModule8debut('');$modules->setModule8expiration('');}

                    $module9activation = $form->get('module9activation')->getData();//echo $form->get('module9debut')->getData();
                    $module9debut = $form->get('module9debut')->getData();
                    if($module9activation == 1 && $module9debut == null){$prix += $prixmodule9;}elseif($module9activation == 1 && $module9debut != null){}else{$modules->setModule9activation(0);$modules->setModule9debut('');$modules->setModule9expiration('');}

                    $module10activation = $form->get('module10activation')->getData();//echo $form->get('module10debut')->getData();
                    $module10debut = $form->get('module10debut')->getData();
                    if($module10activation == 1 && $module10debut == null){$prix += $prixmodule10;}elseif($module10activation == 1 && $module10debut != null){}else{$modules->setModule10activation(0);$modules->setModule10debut('');$modules->setModule10expiration('');}

                    $module11activation = $form->get('module11activation')->getData();//echo $form->get('module11debut')->getData();
                    $module11debut = $form->get('module11debut')->getData();
                    if($module11activation == 1 && $module11debut == null){$prix += $prixmodule11;}elseif($module11activation == 1 && $module11debut != null){}else{$modules->setModule11activation(0);$modules->setModule11debut('');$modules->setModule11expiration('');}

                    $module12activation = $form->get('module12activation')->getData();//echo $form->get('module12debut')->getData();
                    $module12debut = $form->get('module12debut')->getData();
                    if($module12activation == 1 && $module12debut == null){$prix += $prixmodule12;}elseif($module12activation == 1 && $module12debut != null){}else{$modules->setModule12activation(0);$modules->setModule12debut('');$modules->setModule12expiration('');}

                    //Si pas suffisament de crédits on renvoie vers la fenêtre d'alerte
                    if($credits < $prix)
                    {//echo 'return1';
                        $grant = 'nok';
                        return $this->render('BaclooCrmBundle:Crm:buyfiche.html.twig', array(
                            'previous'    => $previous,
                            'credits'    => $credits,
                            'prix'    => $prix,
                            'grant'    => $grant
                        ));
                    }
                    else
                    {
                        $expiration = date('d/m/Y', strtotime("+30 days"));//echo $expiration;
                        $soldepoints = $credits - $prix;
                        $userdetails->setCredits($soldepoints);
                        if($module1activation == 1){$modules->setModule1debut(date('d/m/Y'));$modules->setModule1expiration($expiration);}
                        if($module2activation == 1){$modules->setModule2debut(date('d/m/Y'));$modules->setModule2expiration($expiration);}
                        if($module3activation == 1){$modules->setModule3debut(date('d/m/Y'));$modules->setModule3expiration($expiration);}
                        if($module4activation == 1){$modules->setModule4debut(date('d/m/Y'));$modules->setModule4expiration($expiration);}
                        if($module5activation == 1){$modules->setModule5debut(date('d/m/Y'));$modules->setModule5expiration($expiration);}
                        if($module6activation == 1){$modules->setModule6debut(date('d/m/Y'));$modules->setModule6expiration($expiration);}
                        if($module7activation == 1){$modules->setModule7debut(date('d/m/Y'));$modules->setModule7expiration($expiration);}
                        if($module8activation == 1){$modules->setModule8debut(date('d/m/Y'));$modules->setModule8expiration($expiration);}
                        if($module9activation == 1){$modules->setModule9debut(date('d/m/Y'));$modules->setModule9expiration($expiration);}
                        if($module10activation == 1){$modules->setModule10debut(date('d/m/Y'));$modules->setModule10expiration($expiration);}
                        if($module11activation == 1){$modules->setModule11debut(date('d/m/Y'));$modules->setModule11expiration($expiration);}
                        if($module12activation == 1){$modules->setModule12debut(date('d/m/Y'));$modules->setModule12expiration($expiration);}
                        $em->persist($modules);
                        $em->flush();
                    }

                    return $this->redirect($this->generateUrl('bacloocrm_modules'));

                }
                else
                {
                    //echo 'form pas valide';
                }
            }
        }


        return $this->render('BaclooCrmBundle:Crm:modules.html.twig', array(
            'form' 		 => $form->createView(),
            'modules'    => $modules,
            'userdetails'    => $userdetails,
            'table_module'    => $table_module,
            'previous'   => $previous
        ));
    }

    public function gerer_utilisateursAction($dix)
    {
        $usersess= $this->get('security.context')->getToken()->getUsername(); if(empty($usersess) or !isset($usersess) or $usersess == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        $em = $this->getDoctrine()->getManager();
        $previous = $this->get('request')->server->get('HTTP_REFERER');

        include('societe.php');//echo '$$$$'.$societe;

        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($usersess);
        $credits = $userdetails->getCredits();

        $modules = $em->getRepository('BaclooCrmBundle:Modules')
            ->findByUsersociete($societe);
        if($dix == 1)
        {
            $moda = $em->getRepository('BaclooCrmBundle:Moda')
                ->findOneBySociete('1234');
        }else
        {
            // echo 'bbbbb555';
        }


        if(empty($moda))
        {//echo 'rrrrr';
            $moda = new moda();
            $moda->setSociete('1234');
            $em = $this->getDoctrine()->getManager();
            $em->persist($moda);
        }else
        {
            // echo 'bbb6666';
        }
        $form = $this->createForm(new ModaType(), $moda);
        // on soumet la requete
        $request = $this->getRequest();
        // echo $request->getMethod();
        if ($request->getMethod() == 'POST')
        {
            // On fait le lien Requête <-> Formulaire
            $form->bind($request);$data = $form->getData();
            if ($form->isValid())
            {
                // echo 'ici';
                $prix = 0;
                //Boucle recup données formulaire
                foreach ($form->get('modules')->getData() as $modulform)
                {
                    // echo 'Pour '.$modulform->getUsername();echo '  de la société '.$modulform->getUsersociete();
                    //On récupère la modules correspondant en BDD
                    $em = $this->getDoctrine()->getManager();
                    $modulesbdd = $em->getRepository('BaclooCrmBundle:Modules')
                        ->findOneBy(array('username'=> $modulform->getUsername(), 'usersociete' => $societe));

                    // echo 'bdd'.$modulesbdd->getModule1activation();echo '  form'.$modulform->getModule1activation();

                    if($modulform->getBbuseractivation() == 1 && $modulesbdd->getBbuseractivation() == 0 )
                    {
                        $userprix = 3;
                        if($credits < $userprix)
                        {
                            // echo 'return0';
                            $grant = 'nok';
                            return $this->render('BaclooCrmBundle:Crm:buyfiche.html.twig', array(
                                'previous'    => $previous,
                                'credits'    => $credits,
                                'prix'    => $userprix,
                                'grant'    => $grant
                            ));
                        }
                        else
                        {
                            $expiration = date('d/m/Y', strtotime("+30 days"));//echo 'xxx'.$expiration;
                            $soldepoints = $credits - $userprix;
                            $userdetails->setCredits($soldepoints);
                            $modulesbdd->setUserprix($userprix);
                            $modulesbdd->setUserdebut(date('d/m/Y'));
                            $modulesbdd->setUserexpiration($expiration);
                            $modulesbdd->setBbuseractivation(1);
                            $em->persist($modulesbdd);
                            $em->detach($moda);
                            $em->flush();
                        }
                    }
                    elseif($modulform->getBbuseractivation() == 0  && $modulesbdd->getBbuseractivation() == 1)
                    {
                        $expiration = date('d/m/Y');//echo 'rrrrr'.$expiration;
                        $modulesbdd->setUserexpiration($expiration);
                        $modulesbdd->setBbuseractivation(0);
                        $em->persist($modulesbdd);
                        $em->detach($moda);
                        $em->flush();
                    }

                    $module1prix = 1;
                    $module2prix = 2;
                    $module3prix = 1;
                    $module4prix = 1;
                    $module5prix = 1;
                    $module6prix = 1;
                    $module7prix = 1;
                    $module8prix = 1;
                    $module9prix = 45;
                    $module10prix = 10;
                    $module11prix = 1;
                    $module12prix = 1;

                    include('gerermodule1.php');
                    include('gerermodule2.php');
                    include('gerermodule3.php');
                    include('gerermodule4.php');
                    include('gerermodule5.php');
                    include('gerermodule6.php');
                    include('gerermodule7.php');
                    include('gerermodule8.php');
                    include('gerermodule9.php');
                    include('gerermodule10.php');
                    include('gerermodule11.php');
                    include('gerermodule12.php');

                }
                return $this->redirect($this->generateUrl('bacloocrm_utilisateurs'));
            }
        }

        return $this->render('BaclooCrmBundle:Crm:gerer_les_utilisateurs.html.twig', array(
            'form'    => $form->createView(),
            'societe'    => $societe,
            'credits' => $credits
        ));
    }


    public function societeAction()
    {
        include('societe.php');
        return $this->render('BaclooCrmBundle:Crm:societe.html.twig', array(
            'societe'    => $societe
        ));
    }

    public function blancAction()
    {
        $usersess = $this->get('security.context')->getToken()->getUsername(); if(empty($usersess) or !isset($usersess) or $usersess == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}//Récupère le nom d'utilisateur

        $em = $this->getDoctrine()->getManager();

        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($usersess);

        $roleuser = $userdetails->getRoleuser();
        // $Usersociete = $userdetails->getUsersociete();
        if($roleuser == 'admin')
        {
            $usersess = $this->get('security.context')->getToken()->getUsername(); if(empty($usersess) or !isset($usersess) or $usersess == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}//Récupère le nom d'utilisateur
            $previous = $this->get('request')->server->get('HTTP_REFERER');

            $em = $this->getDoctrine()->getManager();

            $userdetails  = $em->getRepository('BaclooUserBundle:User')
                ->findOneByUsername($usersess);

            $societe = $userdetails->getUsersociete();//echo 'jkjjk'.$societe;

            // $alluser = $em->getRepository('BaclooUserBundle:User')
            // ->findByUsersociete($societe);

            // $nbuser = count($alluser);

            $credits = $userdetails->getCredits();

            $modules = $em->getRepository('BaclooCrmBundle:Modules')
                ->findOneByUsername($usersess);
            $module_init = $modules->getBbactivation();
            // echo'module plein';
            $form = $this->createForm(new ModulesType(), $modules);
            $request = $this->getRequest();
            if ($request->getMethod() == 'POST')
            {
                $form->bind($request);
                if ($form->isValid())
                {
                    $prixc = 150;
                    $prixpc= 110;
                    if($userdetails->getTypebacloo() == 'fichier_commun'){$prix = $prixc;}else{$prix = $prixpc;}
                    $bbactivation = $form->get('bbactivation')->getData();// echo 'activation'.$module1activation;

                    // echo $bbactivation;
                    // echo 'ggg'.$modules->getBbactivation();

                    //Si pas suffisament de crédits on renvoie vers la fenêtre d'alerte
                    if($credits < $prix)
                    {//echo 'return1';
                        $grant = 'nok';
                        return $this->render('BaclooCrmBundle:Crm:buyfiche.html.twig', array(
                            'previous'    => $previous,
                            'credits'    => $credits,
                            'prix'    => $prix,
                            'grant'    => $grant
                        ));
                    }
                    else
                    {
                        $expiration = date('d/m/Y', strtotime("+30 days"));//echo $expiration;

                        if($bbactivation == 1 && $module_init != 1)
                        {
                            //echo 'laaaaaa';
                            $soldepoints = $credits - $prix;
                            $userdetails->setCredits($soldepoints);
                            $modules->setbbdebut(date('d/m/Y'));
                            $modules->setbbexpiration($expiration);
                            $modules->setbbprix($prix);
                        }
                        $em->persist($modules);
                        $em->flush();
                    }

                    return $this->redirect($this->generateUrl('bacloocrm_bb'));

                }
                else
                {
                    // echo 'form pas valide';
                }
            }


            return $this->render('BaclooCrmBundle:Crm:descbb.html.twig', array(
                'form' 		 => $form->createView(),
                'modules'    => $modules,
                'userdetails'    => $userdetails,
                'previous'   => $previous
            ));
        }
        else
        {
            $prixc = 150;
            $prixpc= 110;

            return $this->render('BaclooCrmBundle:Crm:descbb.html.twig', array(
                'userdetails'    => $userdetails,
                'roleuser'    	 => $roleuser,
                'prixc'			 => $prixc,
                'prixpc'		 => $prixpc
            ));
        }
    }

    public function confbbAction($mode, $credits, Request $request)
    {
        $usersess = $this->get('security.context')->getToken()->getUsername(); if(empty($usersess) or !isset($usersess) or $usersess == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}//Récupère le nom d'utilisateur
        $previous = $this->get('request')->server->get('HTTP_REFERER');

        $prixc = 150;
        $prixpc= 110;

        $defaultData = array('message' => 'Veuillez saisir un message, il nous fera avancer.');
        $form = $this->createFormBuilder($defaultData)
            ->add('societe', 'text', array('required' => true))
            ->getForm();

        $form->handleRequest($request);
// echo $request->getMethod();
        if ($request->getMethod() == 'POST')
        {
            // echo'llaaaaa';
            if ($form->isValid())
            {
                // echo 'iiiiiiiiii';
                // Les données sont un tableau avec les clés "name", "email", et "message"
                $data = $form->getData();
                // Partie envoi du mail
                // Récupération du service
                $society = $data['societe'];
                $chaine = preg_replace("#[^a-zA-Z]#", "", $society);
                $tabact = array(' ', ' & ', '\'');
                $societe = str_replace($tabact, '_', $chaine);


                $em = $this->getDoctrine()->getManager();

                $userdetails  = $em->getRepository('BaclooUserBundle:User')
                    ->findOneByUsername($usersess);
                $roleuser = $userdetails->getRoleuser(); //echo $roleuser;
                $userid = $userdetails->getId(); //echo $roleuser;
                $usersociete = $userdetails->getUsersociete();//echo $usersociete;
                // echo $roleuser;
                if($roleuser == 'admin')
                {
                    return $this->render('BaclooCrmBundle:Crm:confbb.html.twig',array('mode'	=> 'nok',
                        'roleuser'	=> $roleuser
                    ));
                }
                $credits = $userdetails->getCredits();

                $userdetails->setUsersociete($society);
                $userdetails->setTextaccueil('Personnalisez ce texte dans votre profil');
                $userdetails->setTypebacloo($mode);
                $userdetails->setRoleuser('admin');
                $userdetails->setNomrep($societe);

                // echo 'lierrrrrrrrrrrr';
                $em = $this->getDoctrine()->getManager();
                $modules  = $em->getRepository('BaclooCrmBundle:Modules')
                    ->findOneByUsername($usersess);
                if(empty($modules))
                {
                    // echo'module vide';
                    $modules = new Modules();
                }
                $expiration = date('d/m/Y', strtotime("+30 days"));//echo $expiration;
                $modules->setBb('Bacloo personnalisé');
                if($mode == 'fichier_commun')
                {
                    $prix = $prixc;
                }
                elseif($mode == 'fichier_pas_commun')
                {
                    $prix = $prixpc;
                }
                $solde = $credits-$prix;
                $userdetails->setCredits($solde);
                $modules->setUserid($userid);
                $modules->setUsername($usersess);
                $modules->setBb($mode);
                $modules->setBbprix($prix);
                $modules->setBbdebut(date('d/m/Y'));
                $modules->setBbexpiration($expiration);
                $modules->setBbactivation(1);
                $em->persist($modules);
                $em->flush();
                //Extration du contenu de bacloo.zip
                set_time_limit(300);
                $zip = new ZipArchive;
                if($mode == 'fichier_commun')
                {
                    if ($zip->open('bacloo2.zip') === TRUE) {
                        $zip->extractTo('b/');
                        $zip->close();
                        // echo 'ok';
                    } else {
                        // echo 'échec';
                    }
                    $fs = new Filesystem();
                    $fs->rename('b/bacloo2/', 'b/'.$societe.'/');
                }
                else
                {
                    if ($zip->open('bacloo.zip') === TRUE) {
                        $zip->extractTo('b/');
                        $zip->close();
                        // echo 'ok';
                    } else {
                        // echo 'échec';
                    }
                    $fs = new Filesystem();
                    $fs->rename('b/bacloo/', 'b/'.$societe.'/');
                }

                // sleep(40);



                //On inscrit le nom de la societe dans societe.txt

                $monfichier = fopen('b/'.$societe.'/src/Bacloo/CrmBundle/Controller/societe.php', 'w');
                $monfichier = fopen('b/'.$societe.'/src/Bacloo/CrmBundle/Controller/societe.php', 'r+');

                fseek($monfichier, 0); // On remet le curseur au début du fichier
                fputs($monfichier, '<?php $societe = "'.$society.'";?>'); // On écrit le nouveau nom de société
                fclose($monfichier);

                $monfichier2 = fopen('b/'.$societe.'/src/Bacloo/UserBundle/Controller/societe.php', 'w');
                $monfichier2 = fopen('b/'.$societe.'/src/Bacloo/UserBundle/Controller/societe.php', 'r+');

                fseek($monfichier2, 0); // On remet le curseur au début du fichier
                fputs($monfichier2, '<?php $societe = "'.$society.'";?>'); // On écrit le nouveau nom de société
                fclose($monfichier2);
                // $file = "societe.php";
                // $fs->copy('societe.php', '../src/Bacloo/UserBundle/Controller/societe.php', true);
                // copy($file, "../src/Bacloo/UserBundle/Controller/societe.php");
                $destinataire = $userdetails;
                $mailer = $this->get('mailer');

                $message = \Swift_Message::newInstance()
                    ->setSubject($destinataire->getPrenom(). ' : '.$usersess.' a créée un bacloo personnalisé')
                    ->setFrom(array('bacloo@bacloo.fr' => 'Bacloo CRM'))
                    ->setTo('ringuetjm@gmail.com')
                    ->setBody($society)
                ;
                $mailer->send($message);
                // Fin partie envoi mail
                $validation = 'ok';
                // $url = 'http://127.0.0.1/symfony2/web/b/lamiecaline/web/app_dev.php/login';
                $url = 'https://www.bacloo.fr/b/'.$societe.'/web/app.php';
                return $this->render('BaclooCrmBundle:Crm:confbb.html.twig',array('mode'		=> 'ok',
                    'url'			=> $url
                ));
            }
            // echo 'uuuuuu';
        }

        return $this->render('BaclooCrmBundle:Crm:confbb.html.twig',array('form' 		=> $form->createView(),
            'previous'    => $previous,
            'credits'     => $credits,
            'mode'		=> $mode
        ));
    }

    public function pregenerationbbAction($typebb)
    {
        $defaultData = array();
        $form = $this->createFormBuilder($defaultData)
            ->add('type_bacloo', 'text', array('required' => true))
            ->add('email', 'email', array('required' => true))
            ->add('message', 'textarea', array('required' => true))
            ->getForm();

        $form->handleRequest($request);

        //Extration du contenu de bacloo.zip
        $zip = new ZipArchive;
        if($mode == 'fichier_commun')
        {
            if ($zip->open('bacloo2.zip') === TRUE) {
                $zip->extractTo('b/');
                $zip->close();
                //echo 'ok';
            } else {
                //echo 'échec';
            }
            $fs = new Filesystem();
            $fs->rename('b/bacloo2/', 'b/'.$societe);
        }
        else
        {
            if ($zip->open('bacloo.zip') === TRUE) {
                $zip->extractTo('b/');
                $zip->close();
                //echo 'ok';
            } else {
                //echo 'échec';
            }
            $fs = new Filesystem();
            $fs->rename('b/bacloo/', 'b/'.$societe);
        }


        //On inscrit le nom de la societe dans societe.txt

        $monfichier = fopen('../src/Bacloo/CrmBundle/Controller/societe.php', 'r+');
        $file = "societe.php";
        copy($file, "../src/Bacloo/UserBundle/Controller/societe.php");
        copy($file, "../src/Avro/CsvBundle/Import/societe.php");
        fseek($monfichier, 0); // On remet le curseur au début du fichier
        fputs($monfichier, '<?php $societe = "'.$societe.'";?>'); // On écrit le nouveau nom de société

        fclose($monfichier);

        //Include à insérer dans le controler après décompréssion de bacloo.zip
        // include('societe.php');

    }

    public function gdriveAction($id, request $request)
    {
        $usersess = $this->get('security.context')->getToken()->getUsername(); if(empty($usersess) or !isset($usersess) or $usersess == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}//Récupère le nom d'utilisateur
        $previous = $this->get('request')->server->get('HTTP_REFERER');
        $defaultData = array();
        $form = $this->createFormBuilder($defaultData)
            ->add('folder_id', 'text', array('required' => false))
            ->getForm();
// echo 'dodo'.$id;
        $form->handleRequest($request);

        if ($form->isValid()) {
            // echo 'XXXXXXXXXXXXXXXX';
            // Les données sont un tableau avec les clés "name", "email", et "message"
            $data = $form->getData();
            // Partie envoi du mail
            // Récupération du service
            $folderid = $data['folder_id']; //echo 'uuuu'.$user;
            //Si le user est l'admin
            $em = $this->getDoctrine()->getManager();
            $fiche  = $em->getRepository('BaclooCrmBundle:Fiche')
                ->findOneById($id);
            // echo'iddd'.$id;
            $fiche->setFolderid($folderid);
            $em->flush();

// echo 'partager=='.$partager;
            return $this->redirect($this->generateUrl('bacloocrm_voir', array('id' => $id)));

        }
        return $this->render('BaclooCrmBundle:Crm:gdrive.html.twig', array(
            'form' 		  => $form->createView(),
            'previous'    => $previous,
            'id'    	  => $id
        ));
    }

    public function colleguetempAction()
    {
        $usersess = $this->get('security.context')->getToken()->getUsername(); if(empty($usersess) or !isset($usersess) or $usersess == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}

        //On récupère les favoris niveau ALL
        $em = $this->getDoctrine()->getManager();

        $modules  = $em->getRepository('BaclooCrmBundle:Modules')
            ->findOneByUsername($usersess);
        // include('societe.php');
        return $this->render('BaclooCrmBundle:Crm:collegues_temp.html.twig', array(
            'modules8activation' => $modules->getModule8activation()
        ));
    }

    public function showpointsAction()
    {
        $usersess = $this->get('security.context')->getToken()->getUsername();

        //On récupère les favoris niveau ALL
        $em = $this->getDoctrine()->getManager();

        $user  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($usersess);
        $points = $user->getCredits();
        // include('societe.php');
        return $this->render('BaclooCrmBundle:Crm:showpoints.html.twig', array(
            'points' => $points
        ));
    }

    public function showcommAction($id, $module1act, Request $request)
    {
        $usersess = $this->get('security.context')->getToken()->getUsername();
        $em = $this->getDoctrine()->getManager();
        $fiche  = $em->getRepository('BaclooCrmBundle:Fiche')
            ->findOneById($id);
        $i = 0;
        $len = count($fiche->getEvent());

        if($len > 0)
        {
            $test = 'ok';
            foreach($fiche->getEvent() as $ev)
            {
                if($i == $len - 1)
                {

                    $commentaire = $ev->getEventComment();
                    $datecomm = $ev->getEventDate();
                    break;
                }
                else
                {
                    $i++;
                }
            }
        }
        else
        {
            $test = 'nok';
            $commentaire = '';
            $datecomm = '';
        }

        $defaultData = array();
        $form = $this->createFormBuilder($defaultData)
            ->add('pseudo', 'text', array('required' => false))
            ->getForm();

        $form->handleRequest($request);

        return $this->render('BaclooCrmBundle:Crm:showcomm.html.twig', array(
            'form' 		  => $form->createView(),
            'commentaire'    => $commentaire,
            'module1act'	=> $module1act,
            'test'    => $test,
            'id'    => $id,
            'datecomm'    => $datecomm
        ));
    }

    public function showpipelineAction()
    {
        $usersess = $this->get('security.context')->getToken()->getUsername(); if(empty($usersess) or !isset($usersess) or $usersess == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}//Récupère le nom d'utilisateur

        //On récupère l'id de l'utilisateur connecté
        $em = $this->getDoctrine()->getManager();

        $modules  = $em->getRepository('BaclooCrmBundle:Modules')
            ->findOneByUsername($usersess);
        $module2activation = $modules->getmodule2activation();

        $query = $em->createQuery(
            'SELECT u.id
				FROM BaclooUserBundle:User u
				WHERE u.username = :username'
        )->setParameter('username', $usersess);
        $uid = $query->getSingleScalarResult();
        //On regarde si l'utilisateur connecté est déja entegistré dnas la table userpipe
        $userpipe = $em->getRepository('BaclooCrmBundle:Userpipe')
            ->findOneByUserid($uid);

        //On récupère les pipelines de l'utilisateur connecté
        $em2 = $this->getDoctrine()
            ->getManager()
            ->getRepository('BaclooCrmBundle:Pipeline');
        $pipe = $em2->findByUsername($usersess);


        //On récupère les userpipe du user connecté
        $em2 = $this->getDoctrine()
            ->getManager()
            ->getRepository('BaclooCrmBundle:Userpipe');
        $userpipa = $em2->findOneByUserid($uid);

        if(empty($userpipa))
        {
            // echo 'pppppppooo';
            $userpipe = new userpipe();
            $userpipe->setUserid($uid);
            $em = $this->getDoctrine()->getManager();
            $em->persist($userpipe);
            $em->flush();

            $em2 = $this->getDoctrine()
                ->getManager()
                ->getRepository('BaclooCrmBundle:Userpipe');
            $userpipo = $em2->findOneByUserid($uid);

            $pipe0 = new pipeline();
            $pipe0->setUserid($uid);
            $pipe0->setUsername($usersess);
            $pipe0->setPipename('---------');
            $pipe0->setPipeorder(0);
            $pipe0->addUserpipe($userpipo);
            $userpipo->addPipeline($pipe0);
            $em->persist($pipe0);
            $em->persist($userpipo);
            $em->flush();

            $pipe0 = new pipeline();
            $pipe0->setUserid($uid);
            $pipe0->setUsername($usersess);
            $pipe0->setPipename('Devis fait');
            $pipe0->setPipeorder(1);
            $pipe0->addUserpipe($userpipo);
            $userpipo->addPipeline($pipe0);
            $em->persist($pipe0);
            $em->persist($userpipo);
            $em->flush();

            $pipe0 = new pipeline();
            $pipe0->setUserid($uid);
            $pipe0->setUsername($usersess);
            $pipe0->setPipename('Affaires signées');
            $pipe0->setPipeorder(2);
            $pipe0->setRealise(true);
            $pipe0->addUserpipe($userpipo);
            $userpipo->addPipeline($pipe0);
            $em->persist($pipe0);
            $em->persist($userpipo);
            $em->flush();

            $pipe0 = new pipeline();
            $pipe0->setUserid($uid);
            $pipe0->setUsername($usersess);
            $pipe0->setPipename('Affaires perdues');
            $pipe0->setPipeorder(3);
            $pipe0->setPerdu(true);
            $pipe0->setExclusion(true);
            $pipe0->addUserpipe($userpipo);
            $userpipo->addPipeline($pipe0);
            $em->persist($pipe0);
            $em->persist($userpipo);
            $em->flush();
        }
        else
        {
            // echo 'loulou';
            $pipe_zero = $em->getRepository('BaclooCrmBundle:Pipeline')
                ->findOneBy(array('username' => $usersess, 'pipeorder' => 0, 'pipename' => '---------'));
            if(empty($pipe_zero) && !isset($pipe_zero))
            {
                // echo 'lili';
                $em2 = $this->getDoctrine()
                    ->getManager()
                    ->getRepository('BaclooCrmBundle:Userpipe');
                $userpipo = $em2->findOneByUserid($uid);

                $pipe0 = new pipeline();
                $pipe0->setUserid($uid);
                $pipe0->setUsername($usersess);
                $pipe0->setPipename('---------');
                $pipe0->setPipeorder(0);
                $pipe0->addUserpipe($userpipa);
                $userpipa->addPipeline($pipe0);
                $em->persist($pipe0);
                $em->persist($userpipo);
                $em->flush();
            }
        }

        $em2 = $this->getDoctrine()
            ->getManager()
            ->getRepository('BaclooCrmBundle:Userpipe');
        $userpipo = $em2->findOneByUserid($uid);

        $form = $this->createForm(new UserpipeType(), $userpipo);

        //Tag OK s'il y a des pipeline sinon NOK
        if(isset($pipe) && !empty($pipe)){$grant = 'ok';}else{$grant = 'nok';}

        // on soumet la requete
        $request = $this->getRequest();
        // echo 'methodoooo'.$request->getMethod();
        if ($request->getMethod() == 'POST') {
            // On fait le lien Requête <-> Formulaire
            $form->bind($request);
            if ($form->isValid())
            {
                // echo 'isi';
                foreach ($form->get('pipeline')->getData() as $bee)
                {
                    if(!isset($bee)){echo 'iiiiiiggg';
                        $userpipe->getPipeline()->clear();
                    }
                }

                $em = $this->getDoctrine()->getManager();
                $em->persist($userpipe);
                $em->flush();


                // $listeBr = array();
                // foreach ($userpipe->getPipeline() as $br) {
                // $listeBr[] = $br;
                // }
                // $efface = 1;
                //On persiste les events
                foreach ($pipe as $originalBr)
                {
                    // echo 'compar pipeline'.$originalBr->getPipename();
                    $efface = 1;
                    $i=1;
                    foreach ($form->get('pipeline')->getData() as $rb)
                    {
                        // echo 'dada'.$rb->getPipename();
                        if($i < 4)
                        {
                            // echo 'iiiii'.$i;
                            // Si pas de rappel en bdd et rb existe: On persist
                            if(empty($originalBr) && !empty($rb)){echo 'ddododod';
                                // On persiste les pipeline et autres (propriétaire) maintenant que $fiche a un id
                                if(isset($br) && !empty($br)){
                                    // $br->addFiche($fiche);
                                    $em->persist($br);
                                }
                            }
                            elseif($originalBr->getPipename() == $rb->getPipename()) //si present db et form
                            {
                                // echo 'dododo'.$efface;
                                $efface = 0;
                            }
                            elseif($originalBr->getPipename() == '---------') //si present db et form
                            {
                                // echo 'dododo'.$efface;
                                $efface = 0;
                            }
                            if($efface == 1)
                            {
                                // echo 'cocococ'.$efface;
                                $em->remove($originalBr);
                            }
                            $i++;
                        }
                        else
                        {
                            // echo 'gggggg'.$i;
                            $em->detach($userpipe);
                            $i++;
                        }
                    }
                    if($efface == 1)
                    {
                        // echo 'cocococ'.$efface;
                        $em->remove($originalBr);
                    }
                }
                $em->persist($userpipe);
                $em->flush();

                $pipe_zero2 = $em->getRepository('BaclooCrmBundle:Pipeline')
                    ->findBy(array('username' => $usersess, 'pipeorder' => 0, 'pipename' => '---------'));
                if(empty($pipe_zero2))
                {
                    $pipe0 = new pipeline();
                    $pipe0->setUserid($uid);
                    $pipe0->setUsername($usersess);
                    $pipe0->setPipename('---------');
                    $pipe0->setPipeorder(0);
                    $pipe0->addUserpipe($userpipo);
                    $userpipo->addPipeline($pipe0);
                    $em->persist($pipe0);
                    $em->persist($userpipo);
                    $em->flush();
                }

                // $em->clear();
                // $pipeline = $em->getRepository('BaclooCrmBundle:Pipeline')
                // ->findByUsername($usersess);
                // foreach($pipeline as $pipe)
                // {
                // if($pipe->getPipeorder() == 0 &&  $pipe->getPipename() != '---------')
                // {
                // echo 'LOGIQUE';
                // $em->remove($pipe);
                // $em->flush();
                // }
                // }
                //Module 9
                $modules  = $em->getRepository('BaclooCrmBundle:Modules')
                    ->findOneByUsername($usersess);
                $module2activation = $modules->getmodule2activation();
                if($module2activation == 0)
                {
                    $em->clear();
                    $pipeline = $em->getRepository('BaclooCrmBundle:Pipeline')
                        ->findByUsername($usersess);

                    $nbpipe = count($pipeline);//echo 'nbpipe'.$nbpipe;
                    if($nbpipe > 4)
                    {

                        $i = 1;
                        // echo 'LOLOLO'.$i;
                        foreach($pipeline as $pipe)
                        {
                            // echo 'easy'.$i;echo $pipe->getPipeorder();
                            if($i > 4)
                            {
                                // echo 'LALAAL'.$i;
                                $em->remove($pipe);
                                $em->flush();
                            }
                            $i++;
                        }
                    }

                }
                // On enregistre les prospects en base de donnée afin d'avoir son id
                return $this->redirect($this->generateUrl('bacloocrm_showpipeline'));
                //echo 'bogo';
            }
        }

        //echo 'baga';
        //On récupère les userpipe du user connecté
        // $em2->clear();
        $em->clear();


        return $this->render('BaclooCrmBundle:Crm:pipeline_list.html.twig', array(
            'form'    => $form->createView(),
            'userid' => $uid,
            'username' => $usersess,
            'module2activation' => $module2activation,
            'grant'	  => $grant
        ));

    }

    public function communicationAction()
    {
        $usersess = $this->get('security.context')->getToken()->getUsername();

        // include('societe.php');
        return $this->render('BaclooCrmBundle:Crm:communication.html.twig');
    }

    public function listuserAction($useracc, Request $request)
    {
        $usersess = $this->get('security.context')->getToken()->getUsername(); if(empty($usersess) or !isset($usersess) or $usersess == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}//Récupère le nom d'utilisateur
        $previous = $this->get('request')->server->get('HTTP_REFERER');
        $defaultData = array();
        include('societe.php');
        $em = $this->getDoctrine()->getManager();
        $username = $em->getRepository('BaclooUserBundle:User')
            ->findBy(array('usersociete' => $societe));
        $i = 0;
        foreach($username as $usern)
        {
            $i++;
        }
        if($i > 1)
        {
            foreach($username as $value) {
                $name_set[] = $value->getUsername();
                $id_set[] = $value->getId();
            }
            $form = $this->createFormBuilder($defaultData)
                ->add('username', 'choice', array(
                    'choice_list' => new ChoiceList($id_set, $name_set)
                ))
                ->getForm();
        }
        else
        {
            $form = $this->createFormBuilder($defaultData)
                ->add('username', 'choice', array(
                    'choices'	=> array(
                        $usersess   => $usersess
                    ),
                    'multiple'  => false))
                ->getForm();
        }

        $form->handleRequest($request);

        if ($form->isValid()) {
            // echo 'XXXXXXXXXXXXXXXX';
            $data = $form->getData();
            $user = $data['username']; //echo 'uuuu'.$user;
            //Si le user est l'admin
            $userdaccueil  = $em->getRepository('BaclooUserBundle:User')
                ->findOneById($user);
            $username = $userdaccueil->getUsername();

            return $this->redirect($this->generateUrl('bacloocrm_home', array('useracc' => $username)));

        }
        return $this->render('BaclooCrmBundle:Crm:listuser.html.twig', array(
            'form' 		  => $form->createView(),
            'useracc' 	  => $useracc
        ));
    }

    public function showcrAction($page, $mode)
    {
        $usersess = $this->get('security.context')->getToken()->getUsername();

        // echo 'yyy';echo $mode;



        $request = $this->getRequest();
        $session = $request->getSession();

        $du = $session->get('crdu');
        $au = $session->get('crau');
        $user = $session->get('username');
        $moda = $session->get('mode');
        $relances = $session->get('relances');
        if(isset($moda))
        {
            $mode = $moda;
        }
        // echo 'xxx';echo $mode;
        // $page = $session->get('page');
        // echo 'user1'.$user;
        if(!isset($du)){$du = date('Y-m-d', strtotime('-7 days'));}
        if(!isset($au)){$au = date('Y-m-d');}
        if(!isset($page)){$page = 1;}
        if(!isset($user)){$user = $usersess;}

        $defaultData = array();
        include('societe.php');
        $em = $this->getDoctrine()->getManager();
        $username = $em->getRepository('BaclooUserBundle:User')
            ->findBy(array('usersociete' => $societe));

        $i = 0;
        foreach($username as $usern)
        {
            $i++;
        }
        $name_set[] = 'tous';
        $id_set[] = 'xxx';
        if($i > 1)
        {
            foreach($username as $value) {
                $name_set[] = $value->getUsername();
                $id_set[] = $value->getId();
            }

            $form = $this->createFormBuilder($defaultData)
                ->add('du', 'date', array('widget' => 'single_text',
                    'input' => 'string',
                    'format' => 'dd/MM/yyyy',
                    'required' => false,
                    'attr' => array('class' => 'date'),
                ))
                ->add('au', 'date', array('widget' => 'single_text',
                    'input' => 'string',
                    'format' => 'dd/MM/yyyy',
                    'required' => false,
                    'attr' => array('class' => 'date'),
                ))
                ->add('username', 'choice', array(
                    'choice_list' => new ChoiceList($id_set, $name_set)
                ))
                ->add('relances', 'checkbox', array('required' => false))





                ->getForm();
        }
        else
        {
            $form = $this->createFormBuilder($defaultData)
                ->add('du', 'date', array('widget' => 'single_text',
                    'input' => 'string',
                    'format' => 'dd/MM/yyyy',
                    'required' => false,
                    'attr' => array('class' => 'date'),
                ))
                ->add('au', 'date', array('widget' => 'single_text',
                    'input' => 'string',
                    'format' => 'dd/MM/yyyy',
                    'required' => false,
                    'attr' => array('class' => 'date'),
                ))
                ->add('username', 'choice', array(
                    'choices'	=> array(
                        $usersess   => $usersess
                    ),
                    'multiple'  => false))
                ->getForm();
        }
// echo 'dodo'.$id;
        $form->handleRequest($request);

        if ($form->isValid()) {
            // echo 'XXXXXXXXXXXXXXXX';
            // Les données sont un tableau avec les clés "name", "email", et "message"
            $data = $form->getData();
            $du = $data['du'];
            $au = $data['au'];
            $user = $data['username'];
            $relances = $data['relances'];



            // echo $user;
            if($user == 'xxx')
            {
                $username = 'tous';
            }
            else
            {
                $userdaccueil  = $em->getRepository('BaclooUserBundle:User')
                    ->findOneById($user);
                $username = $userdaccueil->getUsername();
            }
            // echo $username;
            $session->set('crdu', $du);
            $session->set('crau', $au);
            $session->set('username', $username);



            $session->set('relances', $relances);
            if($relances == 1)
            {
                $session->set('mode', 'brappels');
            }
            else
            {
                $session->set('mode', 'cr');
            }
            return $this->redirect($this->generateUrl('bacloocrm_cr', array('mode' => $mode)));

        }

        $em = $this->getDoctrine()->getManager();
        $cr = $em->getRepository('BaclooCrmBundle:Event')
            ->searchcr($du, $au, 30, $page, $user, $societe);

        $cra = $em->getRepository('BaclooCrmBundle:Event')
            ->searchcradmin($du, $au, 30, $page, $user, $societe);

        $bra = $em->getRepository('BaclooCrmBundle:Brappels')
            ->searchbrappelsadmin($du, $au, 30, $page, $user, $societe);

        $modules  = $em->getRepository('BaclooCrmBundle:Modules')
            ->findOneByUsername($usersess);

        $userdacc  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($usersess);
        $userdaccueil = $userdacc->getRoleuser();

        $module12activation = $modules->getModule12activation();

        // include('societe.php');
        return $this->render('BaclooCrmBundle:Crm:cr.html.twig', array('cr' => $cr,
            'cra' => $cra,
            'bra' => $bra,
            'du' => $du,
            'au' => $au,
            'mode' => $mode,
            'user' => $user,
            'societe' => $societe,
            'relances' => $relances,
            'userdaccueil' => $userdaccueil,
            'userdacc' => $userdacc,
            'page' => $page,
            'module12activation' => $module12activation,
            'nombrePage' => ceil(count($cr)/30),
            'form' => $form->createView()
        ));
    }

    /**
     * function getDatesBetween
     * renvoie un tableau contenant toutes les dates, jour par jour,
     * comprises entre les deux dates passées en paramètre.
     * NB : les dates doivent être au format aaaa-mm-dd (mais on peut changer le parsing)
     * @param (string) $dStart : date de départ
     * @param (string) $dEnd : date de fin
     * @return (array) aDates : tableau des dates si succès
     * @return (bool) false : si échec
     */
    public function createplanningAction($mode, $codemachine, $openModal, $event_id, Request $request)
    {
        $usersess = $this->get('security.context')->getToken()->getUsername(); if(empty($usersess) or !isset($usersess) or $usersess == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}//Récupère le nom d'utilisateur
        $dStart = date('Y-m-d');
        // $dStart = '2018-10-31';
        $dEnd = date('Y-m-d', strtotime("+20 days"));
        // $dEnd = '2018-11-30';

        //1.Récupérer les données de la table machines

        $em = $this->getDoctrine()->getManager();
        $query = $em->createQuery(
            'SELECT f
			FROM BaclooCrmBundle:Machines f
			Group By f.codegenerique
			Order by f.codegenerique ASC'
        );
        $machines = $query->getResult();
        $query = $em->createQuery(
            'SELECT f
				FROM BaclooCrmBundle:Machines f
				WHERE f.etat != :etat1 and f.etat != :etat2 and f.etat != :etat3 and f.etat != :etat4 and f.etat != :etat5
                Group By f.codegenerique
                Order by f.codegenerique ASC'
        );
        $query->setParameter('etat1', 'Hors Usage');
        $query->setParameter('etat2', 'Indisponible');
        $query->setParameter('etat3', 'Pièce');
        $query->setParameter('etat4', 'Vendu');
        $query->setParameter('etat5', 'Volé');
        $machiness = $query->getResult();
        $tableau = array();
        $tableau[0] = '';
        foreach ($machines as $loco) {
            $tableau[$loco->getCodegenerique()] = $loco->getCodegenerique();
        }
        $machines = $tableau;
        $em = $this->getDoctrine()->getManager();
        $defaultData = array();
        $form = $this->createFormBuilder($defaultData)
            ->add('codemachine', 'choice', array(
                'choices'   => $machines,
                'multiple'  => false,
            ))
            ->getForm();
        $form->handleRequest($request);

//        $codemachine = 0;

        // On vérifie qu'elle est de type POST
        if ($request->getMethod() == 'POST')
        {
            // On vérifie que les valeurs entrées sont correctes
            if ($form->isValid()) {
                $data = $form->getData();
                $codemachine = $data['codemachine'];
                return $this->redirect($this->generateUrl('bacloocrm_planning', array('codemachine' => $codemachine)));
            }
        }

//        if(!isset($codemachine) or $codemachine == 'tout')
//        {
//            $codemachine = 'tout';
//        }

        //Sélectionner dans la table locata toutes les lignes qui ont un champ client egal à "Raison sociale"
        $query = $em->createQuery(
            'SELECT v
			FROM BaclooCrmBundle:Locata v
			WHERE v.client LIKE :client'
        )->setParameter('client', 'Raison sociale');
        $clientsasuppr = $query->getResult();
        if(isset($clientsasuppr))
        {//*echo 'ici';exit();
            foreach($clientsasuppr as $clientsuppr)
            {
                foreach($clientsuppr->getLocations() as $ven)
                {
                    $em->remove($ven);
                    $em->flush();
                }
                foreach($clientsuppr->getLocationssl() as $vensl)
                {
                    $em->remove($vensl);
                    $em->flush();
                }
                $em->remove($clientsuppr);
                $em->flush();
            }
        }
        //Fin select
        $machines  = $em->getRepository('BaclooCrmBundle:Machines')
                ->listemachines();


        foreach($machines as $machine)
        {
            $location  = $em->getRepository('BaclooCrmBundle:Locations')
                ->findOneBy(array('machineid' => $machine->getId(), 'id' => $machine->getCodelocations(), 'etatloc' => $machine->getEtat()));

            if((empty($location) && $machine->getEntreprise() != 'DTBA sas' && $machine->getEtat() != 'Inspection' && $machine->getEtat() != 'En panne') or (!empty($location) && $location->getEtatlog() == 'Refusé' && $machine->getEtat() != 'Inspection' && $machine->getEtat() != 'En panne'))
            {
                if($machine->getOriginal() == 0)
                {
                    $em->remove($machine);
                    $em->flush();
                }
                elseif($machine->getOriginal() == 1)
                {//ie('cest la fin1');
                    $machine->setEtat('Disponible');
                    $machine->setDebutloc('');
                    $machine->setFinloc('');
                    $machine->setEntreprise('');
                    $machine->setNomchantier('');
                    $machine->setcodelocations('');
                    $machine->setcodecontrat('');
                    $machine->setClientid(0);
                    $em->persist($machine);
                    $em->flush();
                }
            }
            if(($machine->getEtat() == 'Disponible' or $machine->getEtat() == 'Inspection') and null !== $machine->getDebutloc() and null !== $machine->getFinloc())
            {//die('cest la fin2');
                $machine->setEtat('Disponible');
                $machine->setDebutloc('');
                $machine->setFinloc('');
                $machine->setEntreprise('');
                $machine->setNomchantier('');
                $machine->setcodelocations('');
                $machine->setcodecontrat('');
                $machine->setClientid(0);
                $em->persist($machine);
                $em->flush();
            }
        }

//        $locations  = $em->getRepository('BaclooCrmBundle:Locations')->findAll();

        //2.On génère les entêtes de colonnes à partir de la fonction createplanning
        $iStart = strtotime ($dStart);//Formate une date/heure locale avec la Something is wronguration locale
        $iEnd = strtotime ($dEnd);
        if (false === $iStart || false === $iEnd) {
            return false;
        }
        $aStart = explode ('-', $dStart);
        $aEnd = explode ('-', $dEnd);
        if (count ($aStart) !== 3 || count ($aEnd) !== 3) {
            return false;
        }
        if (false === checkdate ($aStart[1], $aStart[2], $aStart[0]) || false === checkdate ($aEnd[1], $aEnd[2], $aEnd[0]) || $iEnd <= $iStart) {
            // return false;
        }
        for ($i = $iStart; $i <= $iEnd; $i = $i + 86400 ) {
            $sDateToArr = strftime ('%Y-%m-%d', $i);
            $sYear = substr ($sDateToArr, 0, 4);
            $sMonth = substr ($sDateToArr, 5, 2);
            $aDates[$sYear][$sMonth][] = $sDateToArr;
        }

        $nbannee = 0;
        $nbmoisparannee = 0;
        //Calcule le nombre de jours dans le mois
        $annee1 = date("Y", strtotime($dStart));
        $anneef = date("Y", strtotime($dStart));
        $anneefin = $anneef + 1;

        //Boucle parcours tableau année, mois, jours.
        //Celle-ci renvoie le nombre de  jours du premier mois m1
        $m11 = 1;
        foreach($aDates as $annee => $moiss)
        {
            foreach($moiss as $date => $mois)
            {
                if($m11 == 1)//si on est en m1 on procède sinon break
                {
                    foreach($mois as $dat)
                    {
                        $m11++;
                    }
                }
                else
                {
                    break;
                }
            }

        }
        $m1 = $m11-1;
        //Calcul du nb total de mois $m
        $m = 0;
        foreach($aDates as $annee => $moiss)
        {
            foreach($moiss as $date => $mois)
            {
                $m++;
            }

        }

        //Calcul du nb total d'années $a
        $an = 0;
        foreach($aDates as $annee => $moiss)
        {
            $an++;
        }
// echo $m;
        //Celle-ci renvoie le nombre de jours du dernier mois mm
        $mm = 0;
        $compteurm = 1;
        foreach($aDates as $annee => $moiss)
        {
            foreach($moiss as $date => $mois)
            {
                if($compteurm == $m)//si on est le dernier mois
                {
                    foreach($mois as $dat)
                    {
                        $mm++;
                    }
                }
                else
                {}
                $compteurm++;
            }

        }

        //Celle-ci renvoie le nombre de jours de la première année $a1
        $a11 = 1;
        foreach($aDates as $annee => $moiss)
        {
            if($a11 == 1)//si on est en a1 on procède sinon break
            {
                foreach($moiss as $date => $mois)
                {
                    foreach($mois as $dat)
                    {
                        $a11++;
                    }
                }
            }
            else
            {
                break;
            }
        }
        $a1 = $a11-1;
        //Fonction qui calcule le nombre de jours dans l'année
        function cal_days_in_year($year){
            $days=0;
            for($month=1;$month<=12;$month++){
                $days = $days + cal_days_in_month(CAL_GREGORIAN,$month,$year);
            }
            return $days;
        }
        //Celle-ci renvoie le nombre de jours de la dernière année $aa
        $aa = 0;
        $compteura = 1;
        foreach($aDates as $annee => $moiss)
        {
            if($compteura == $an)//si on est en end ernière année on calcule le nb de jours $aa
            {
                foreach($moiss as $date => $mois)
                {
                    foreach($mois as $dat)
                    {
                        $aa++;
                    }
                }
            }
            else
            {
                break;
            }
            $compteura++;
        }
        // echo 'www'.$mm.'www';
        // $mm = 0; //Compteur de mois qui s'incrémente de 1 afin de faire un compte indépendant des mois.
        $nbjrparmois = 0;
        $i = 1; //Compteur pour premier mois
        $a = 1; //Compteur pour la première année
        $nbmois = array();
        $nbjannee = array();
        foreach($aDates as $annee => $moiss)
        {
            //Calculer le nombre d'années
            // echo $annee;
            if($a == 1)//Si on est en première année
            {
                $nbjannee[] = $a1;//nb de jours de la première année
            }
            elseif($a == $an)
            {
                $nbjannee[] = $aa;
            }
            else
            {
                $nbjannee[] = cal_days_in_year($annee);
            }
            foreach($moiss as $date => $mois)
            {
                if($i == 1)//on est au premier mois
                {
                    //nb jours mois courant
                    $nbmois[] = $m1;
                }
                elseif($i == $m)//Si on est  le dernier mois de la période on met le nb de jours
                {
                    //nb de jours du dernier mois
                    $nbmois[] = $mm;
                }
                else
                {
                    //Pour les autres mois
                    $nbmois[] = cal_days_in_month(CAL_GREGORIAN, $date, $annee);
                }
                $i++;
            }
            $a++;
        }
//echo 'uuuu'.$codemachine;
        //aDates contient nos entêtes de colonnes
        return $this->render('BaclooCrmBundle:Crm:planning.html.twig', array(
            'form' => $form->createView(),
            'dates' => $aDates,
            'dstart' => $dStart,
            'dend' => $dEnd,
            'machines' => $machines,
            'nbjannee' => $nbjannee,
            'user' => $usersess,
            'mode' => $mode,
            'nbmois' => $nbmois,
            'codemachine' => $codemachine,
            'openModal' => $openModal,
            'event_id' => $event_id
        ));
    }

    public function createplanningslAction($mode, $codemachine, $openModal, $event_id, Request $request)
    {
        $usersess = $this->get('security.context')->getToken()->getUsername(); if(empty($usersess) or !isset($usersess) or $usersess == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}//Récupère le nom d'utilisateur
        $dStart = date('Y-m-d');
        // $dStart = '2018-10-31';
        $dEnd = date('Y-m-d', strtotime("+20 days"));
        // $dEnd = '2018-11-30';

        //1.Récupérer les données de la table machines

        $em = $this->getDoctrine()->getManager();
        $query = $em->createQuery(
            'SELECT f
			FROM BaclooCrmBundle:Machinessl f
			Group By f.codegenerique
			Order by f.codegenerique ASC'
        );
        $machines = $query->getResult();
        $tableau = array();
        $tableau[0] = '';
        foreach ($machines as $loco) {
            $tableau[$loco->getCodegenerique()] = $loco->getCodegenerique();
        }
        $machines = $tableau;
        $em = $this->getDoctrine()->getManager();
        $defaultData = array();
        $form = $this->createFormBuilder($defaultData)
            ->add('codemachine', 'choice', array(
                'choices'   => $machines,
                'multiple'  => false,
            ))
            ->getForm();
        $form->handleRequest($request);

//        $codemachine = 0;

        // On vérifie qu'elle est de type POST
        if ($request->getMethod() == 'POST')
        {
            // On vérifie que les valeurs entrées sont correctes
            if ($form->isValid()) {
                $data = $form->getData();
                $codemachine = $data['codemachine'];
                return $this->redirect($this->generateUrl('bacloocrm_planningsl', array('codemachine' => $codemachine)));
            }
        }

//        if(!isset($codemachine) or $codemachine == 'tout')
//        {
//            $codemachine = 'tout';
//        }

        //Sélectionner dans la table locata toutes les lignes qui ont un champ client egal à "Raison sociale"
        $query = $em->createQuery(
            'SELECT v
			FROM BaclooCrmBundle:Locata v
			WHERE v.client LIKE :client'
        )->setParameter('client', 'Raison sociale');
        $clientsasuppr = $query->getResult();
        if(isset($clientsasuppr))
        {//*echo 'ici';exit();
            foreach($clientsasuppr as $clientsuppr)
            {
                foreach($clientsuppr->getLocations() as $ven)
                {
                    $em->remove($ven);
                    $em->flush();
                }
                foreach($clientsuppr->getLocationssl() as $vensl)
                {
                    $em->remove($vensl);
                    $em->flush();
                }
                $em->remove($clientsuppr);
                $em->flush();
            }
        }
        //Fin select
        $machines  = $em->getRepository('BaclooCrmBundle:Machinessl')
                ->findAll();


        foreach($machines as $machine)
        {
            $location  = $em->getRepository('BaclooCrmBundle:Locationssl')
                ->findOneBy(array('machineid' => $machine->getId(), 'id' => $machine->getCodelocations(), 'etatloc' => $machine->getEtat()));

            if((empty($location) && $machine->getEntreprise() != 'DTBA sas' && $machine->getEtat() != 'Inspection' && $machine->getEtat() != 'En panne') or (!empty($location) && $location->getEtatlog() == 'Refusé' && $machine->getEtat() != 'Inspection' && $machine->getEtat() != 'En panne'))
            {
                if($machine->getOriginal() == 0)
                {
                    $em->remove($machine);
                    $em->flush();
                }
                elseif($machine->getOriginal() == 1)
                {//ie('cest la fin1');
                    $machine->setEtat('Disponible');
                    $machine->setDebutloc('');
                    $machine->setFinloc('');
                    $machine->setEntreprise('');
                    $machine->setNomchantier('');
                    $machine->setcodelocations('');
                    $machine->setcodecontrat('');
                    $machine->setClientid(0);
                    $em->persist($machine);
                    $em->flush();
                }
            }
            if(($machine->getEtat() == 'Disponible' or $machine->getEtat() == 'Inspection') and null !== $machine->getDebutloc() and null !== $machine->getFinloc())
            {//die('cest la fin2');
                $machine->setEtat('Disponible');
                $machine->setDebutloc('');
                $machine->setFinloc('');
                $machine->setEntreprise('');
                $machine->setNomchantier('');
                $machine->setcodelocations('');
                $machine->setcodecontrat('');
                $machine->setClientid(0);
                $em->persist($machine);
                $em->flush();
            }
        }

        $locations  = $em->getRepository('BaclooCrmBundle:Locationssl')->findAll();

        //2.On génère les entêtes de colonnes à partir de la fonction createplanning
        $iStart = strtotime ($dStart);//Formate une date/heure locale avec la Something is wronguration locale
        $iEnd = strtotime ($dEnd);
        if (false === $iStart || false === $iEnd) {
            return false;
        }
        $aStart = explode ('-', $dStart);
        $aEnd = explode ('-', $dEnd);
        if (count ($aStart) !== 3 || count ($aEnd) !== 3) {
            return false;
        }
        if (false === checkdate ($aStart[1], $aStart[2], $aStart[0]) || false === checkdate ($aEnd[1], $aEnd[2], $aEnd[0]) || $iEnd <= $iStart) {
            // return false;
        }
        for ($i = $iStart; $i <= $iEnd; $i = $i + 86400 ) {
            $sDateToArr = strftime ('%Y-%m-%d', $i);
            $sYear = substr ($sDateToArr, 0, 4);
            $sMonth = substr ($sDateToArr, 5, 2);
            $aDates[$sYear][$sMonth][] = $sDateToArr;
        }

        $nbannee = 0;
        $nbmoisparannee = 0;
        //Calcule le nombre de jours dans le mois
        $annee1 = date("Y", strtotime($dStart));
        $anneef = date("Y", strtotime($dStart));
        $anneefin = $anneef + 1;

        //Boucle parcours tableau année, mois, jours.
        //Celle-ci renvoie le nombre de  jours du premier mois m1
        $m11 = 1;
        foreach($aDates as $annee => $moiss)
        {
            foreach($moiss as $date => $mois)
            {
                if($m11 == 1)//si on est en m1 on procède sinon break
                {
                    foreach($mois as $dat)
                    {
                        $m11++;
                    }
                }
                else
                {
                    break;
                }
            }

        }
        $m1 = $m11-1;
        //Calcul du nb total de mois $m
        $m = 0;
        foreach($aDates as $annee => $moiss)
        {
            foreach($moiss as $date => $mois)
            {
                $m++;
            }

        }

        //Calcul du nb total d'années $a
        $an = 0;
        foreach($aDates as $annee => $moiss)
        {
            $an++;
        }
// echo $m;
        //Celle-ci renvoie le nombre de jours du dernier mois mm
        $mm = 0;
        $compteurm = 1;
        foreach($aDates as $annee => $moiss)
        {
            foreach($moiss as $date => $mois)
            {
                if($compteurm == $m)//si on est le dernier mois
                {
                    foreach($mois as $dat)
                    {
                        $mm++;
                    }
                }
                else
                {}
                $compteurm++;
            }

        }

        //Celle-ci renvoie le nombre de jours de la première année $a1
        $a11 = 1;
        foreach($aDates as $annee => $moiss)
        {
            if($a11 == 1)//si on est en a1 on procède sinon break
            {
                foreach($moiss as $date => $mois)
                {
                    foreach($mois as $dat)
                    {
                        $a11++;
                    }
                }
            }
            else
            {
                break;
            }
        }
        $a1 = $a11-1;
        //Fonction qui calcule le nombre de jours dans l'année
        function cal_days_in_year($year){
            $days=0;
            for($month=1;$month<=12;$month++){
                $days = $days + cal_days_in_month(CAL_GREGORIAN,$month,$year);
            }
            return $days;
        }
        //Celle-ci renvoie le nombre de jours de la dernière année $aa
        $aa = 0;
        $compteura = 1;
        foreach($aDates as $annee => $moiss)
        {
            if($compteura == $an)//si on est en end ernière année on calcule le nb de jours $aa
            {
                foreach($moiss as $date => $mois)
                {
                    foreach($mois as $dat)
                    {
                        $aa++;
                    }
                }
            }
            else
            {
                break;
            }
            $compteura++;
        }
        // echo 'www'.$mm.'www';
        // $mm = 0; //Compteur de mois qui s'incrémente de 1 afin de faire un compte indépendant des mois.
        $nbjrparmois = 0;
        $i = 1; //Compteur pour premier mois
        $a = 1; //Compteur pour la première année
        $nbmois = array();
        $nbjannee = array();
        foreach($aDates as $annee => $moiss)
        {
            //Calculer le nombre d'années
            // echo $annee;
            if($a == 1)//Si on est en première année
            {
                $nbjannee[] = $a1;//nb de jours de la première année
            }
            elseif($a == $an)
            {
                $nbjannee[] = $aa;
            }
            else
            {
                $nbjannee[] = cal_days_in_year($annee);
            }
            foreach($moiss as $date => $mois)
            {
                if($i == 1)//on est au premier mois
                {
                    //nb jours mois courant
                    $nbmois[] = $m1;
                }
                elseif($i == $m)//Si on est  le dernier mois de la période on met le nb de jours
                {
                    //nb de jours du dernier mois
                    $nbmois[] = $mm;
                }
                else
                {
                    //Pour les autres mois
                    $nbmois[] = cal_days_in_month(CAL_GREGORIAN, $date, $annee);
                }
                $i++;
            }
            $a++;
        }
//echo 'uuuu'.$codemachine;
        //aDates contient nos entêtes de colonnes
        return $this->render('BaclooCrmBundle:Crm:planningsl.html.twig', array(
            'form' => $form->createView(),
            'dates' => $aDates,
            'dstart' => $dStart,
            'dend' => $dEnd,
            'machines' => $machines,
            'nbjannee' => $nbjannee,
            'user' => $usersess,
            'mode' => $mode,
            'nbmois' => $nbmois,
            'codemachine' => $codemachine,
            'openModal' => $openModal,
            'event_id' => $event_id,
            'locations' => $locations
        ));
    }

    /**
     * function getDatesBetween
     * renvoie un tableau contenant toutes les dates, jour par jour,
     * comprises entre les deux dates passées en paramètre.
     * NB : les dates doivent être au format aaaa-mm-dd (mais on peut changer le parsing)
     * @param (string) $dStart : date de départ
     * @param (string) $dEnd : date de fin
     * @return (array) aDates : tableau des dates si succès
     * @return (bool) false : si échec
     */
    public function createplanningtestAction()
    {
        $usersess = $this->get('security.context')->getToken()->getUsername(); if(empty($usersess) or !isset($usersess) or $usersess == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}//Récupère le nom d'utilisateur
        $dStart = date('Y-m-d');
        // $dStart = '2018-10-31';
        $dEnd = date('Y-m-d', strtotime("+20 days"));
        // $dEnd = '2018-11-30';

        //1.Récupérer les données de la table Machines
        $em = $this->getDoctrine()->getManager();
        $events = $em->getRepository('BaclooCrmBundle:Event')
                ->findAll();

        // Conversion des données en un tableau PHP
        $eventsArray = array();
        foreach ($events as $event) {
            $eventsArray[] = array(
                'title' => $event->getUser(),
                'start' => $event->getEventDate(),
                'end' => $event->getEntreprise(),
                'id' => $event->getId(),
            );
        }

        // Conversion du tableau PHP en un format JSON
        $eventsJson = json_encode($eventsArray);


        return $this->render('BaclooCrmBundle:Crm:planningtest.html.twig', array(
            'eventsJson' => $eventsJson
        ));
    }

    /**
     * function getDatesBetween
     * renvoie un tableau contenant toutes les dates, jour par jour,
     * comprises entre les deux dates passées en paramètre.
     * NB : les dates doivent être au format aaaa-mm-dd (mais on peut changer le parsing)
     * @param (string) $dStart : date de départ
     * @param (string) $dEnd : date de fin
     * @return (array) aDates : tableau des dates si succès
     * @return (bool) false : si échec
     */
    public function createplanningsloldAction($mode, Request $request)
    {
        $dStart = date('Y-m-d');
        // $dStart = '2018-10-31';
        $dEnd = date('Y-m-d', strtotime("+20 days"));
        // $dEnd = '2018-11-30';

        //1.Récupérer les données de la table Machinessl
        $em = $this->getDoctrine()->getManager();

        if($mode == 'location')
        {
            $locations  = $em->getRepository('BaclooCrmBundle:Machinessl')
                ->findByEtat('En location');
        }
        else
        {
            $locations  = $em->getRepository('BaclooCrmBundle:Machinessl')
                ->findAll();
        }
        foreach($locations as $machine)
        {
            $location  = $em->getRepository('BaclooCrmBundle:Locationssl')
                ->findOneBy(array('machineid' => $machine->getId(), 'id' => $machine->getCodelocations(), 'etatloc' => $machine->getEtat()));

            if((empty($location) && $machine->getEntreprise() != 'DTBA sas') or (!empty($location) and $location->getEtatlog() == 'Refusé'))
            {
                if($machine->getOriginal() == 0)
                {
                    $em->remove($machine);
                    $em->flush();
                }
                elseif($machine->getOriginal() == 1)
                {
                    $machine->setEtat('Disponible');
                    $machine->setDebutloc('');
                    $machine->setFinloc('');
                    $machine->setEntreprise('');
                    $machine->setNomchantier('');
                    $machine->setcodelocations('');
                    $machine->setcodecontrat('');
                    $machine->setClientid(0);
                    $em->persist($machine);
                    $em->flush();
                }
            }
            if(($machine->getEtat() == 'Disponible' or $machine->getEtat() == 'Inspection') and null !== $machine->getDebutloc() and null !== $machine->getFinloc())
            {
                $machine->setEtat('Disponible');
                $machine->setDebutloc('');
                $machine->setFinloc('');
                $machine->setEntreprise('');
                $machine->setNomchantier('');
                $machine->setcodelocations('');
                $machine->setcodecontrat('');
                $machine->setClientid(0);
                $em->persist($machine);
                $em->flush();
            }
        }

        if($mode == 'location')
        {
            $locations  = $em->getRepository('BaclooCrmBundle:Machinessl')
                ->findByEtat('En location');
        }
        else
        {
            $locations  = $em->getRepository('BaclooCrmBundle:Machinessl')
                ->findAll();
        }
        $defaultData = array();
        $form = $this->createFormBuilder($defaultData)
            ->add('filtre', 'choice', array(
                'choices'   => array(
                    'location'   => 'En location',
                    'all'   => 'Tout afficher',
                ),
                'multiple'  => false,
            ))
            ->getForm();
        $form->handleRequest($request);
        if($form->isValid()) {
            $data = $form->getData();
            $mode = $data['filtre'];
            if(isset($mode) && $mode == 'all')
            {
                return $this->redirect($this->generateUrl('bacloocrm_planningsl', array('mode' => 'all' )));
            }
            elseif(isset($mode) && $mode == 'location')
            {
                return $this->redirect($this->generateUrl('bacloocrm_planningsl', array('mode' => 'location' )));
            }
        }

        //2.On génère les entêtes de colonnes à partir de la fonction createplanning
        $iStart = strtotime ($dStart);//Formate une date/heure locale avec la Something is wronguration locale
        $iEnd = strtotime ($dEnd);
        if (false === $iStart || false === $iEnd) {
            return false;
        }
        $aStart = explode ('-', $dStart);
        $aEnd = explode ('-', $dEnd);
        if (count ($aStart) !== 3 || count ($aEnd) !== 3) {
            return false;
        }
        if (false === checkdate ($aStart[1], $aStart[2], $aStart[0]) || false === checkdate ($aEnd[1], $aEnd[2], $aEnd[0]) || $iEnd <= $iStart) {
            // return false;
        }
        for ($i = $iStart; $i < $iEnd + 86400; $i = strtotime ('+1 day', $i) ) {
            $sDateToArr = strftime ('%Y-%m-%d', $i);
            $sYear = substr ($sDateToArr, 0, 4);
            $sMonth = substr ($sDateToArr, 5, 2);
            $aDates[$sYear][$sMonth][] = $sDateToArr;
        }

        $nbannee = 0;
        $nbmoisparannee = 0;
        //Calcule le nombre de jours dans le mois
        $annee1 = date("Y", strtotime($dStart));
        $anneef = date("Y", strtotime($dStart));
        $anneefin = $anneef + 1;

        //Boucle parcours tableau année, mois, jours.
        //Celle-ci renvoie le nombre de  jours du premier mois m1
        $m11 = 1;
        foreach($aDates as $annee => $moiss)
        {
            foreach($moiss as $date => $mois)
            {
                if($m11 == 1)//si on est en m1 on procède sinon break
                {
                    foreach($mois as $dat)
                    {
                        $m11++;
                    }
                }
                else
                {
                    break;
                }
            }

        }
        $m1 = $m11-1;
        //Calcul du nb total de mois $m
        $m = 0;
        foreach($aDates as $annee => $moiss)
        {
            foreach($moiss as $date => $mois)
            {
                $m++;
            }

        }

        //Calcul du nb total d'années $a
        $an = 0;
        foreach($aDates as $annee => $moiss)
        {
            $an++;
        }
// echo $m;
        //Celle-ci renvoie le nombre de jours du dernier mois mm
        $mm = 0;
        $compteurm = 1;
        foreach($aDates as $annee => $moiss)
        {
            foreach($moiss as $date => $mois)
            {
                if($compteurm == $m)//si on est le dernier mois
                {
                    foreach($mois as $dat)
                    {
                        $mm++;
                    }
                }
                else
                {}
                $compteurm++;
            }

        }

        //Celle-ci renvoie le nombre de jours de la première année $a1
        $a11 = 1;
        foreach($aDates as $annee => $moiss)
        {
            if($a11 == 1)//si on est en a1 on procède sinon break
            {
                foreach($moiss as $date => $mois)
                {
                    foreach($mois as $dat)
                    {
                        $a11++;
                    }
                }
            }
            else
            {
                break;
            }
        }
        $a1 = $a11-1;
        //Fonction qui calcule le nombre de jours dans l'année
        function cal_days_in_year($year){
            $days=0;
            for($month=1;$month<=12;$month++){
                $days = $days + cal_days_in_month(CAL_GREGORIAN,$month,$year);
            }
            return $days;
        }
        //Celle-ci renvoie le nombre de jours de la dernière année $aa
        $aa = 0;
        $compteura = 1;
        foreach($aDates as $annee => $moiss)
        {
            if($compteura == $an)//si on est en end ernière année on calcule le nb de jours $aa
            {
                foreach($moiss as $date => $mois)
                {
                    foreach($mois as $dat)
                    {
                        $aa++;
                    }
                }
            }
            else
            {
                break;
            }
            $compteura++;
        }
        // echo 'www'.$mm.'www';
        // $mm = 0; //Compteur de mois qui s'incrémente de 1 afin de faire un compte indépendant des mois.
        $nbjrparmois = 0;
        $i = 1; //Compteur pour premier mois
        $a = 1; //Compteur pour la première année
        $nbmois = array();
        $nbjannee = array();
        foreach($aDates as $annee => $moiss)
        {
            //Calculer le nombre d'années
            // echo $annee;
            if($a == 1)//Si on est en première année
            {
                $nbjannee[] = $a1;//nb de jours de la première année
            }
            elseif($a == $an)
            {
                $nbjannee[] = $aa;
            }
            else
            {
                $nbjannee[] = cal_days_in_year($annee);
            }
            foreach($moiss as $date => $mois)
            {
                if($i == 1)//on est au premier mois
                {
                    //nb jours mois courant
                    $nbmois[] = $m1;
                }
                elseif($i == $m)//Si on est  le dernier mois de la période on met le nb de jours
                {
                    //nb de jours du dernier mois
                    $nbmois[] = $mm;
                }
                else
                {
                    //Pour les autres mois
                    $nbmois[] = cal_days_in_month(CAL_GREGORIAN, $date, $annee);
                }
                $i++;
            }
            $a++;
        }

        // echo $i;
        // print_r($nbmois);
        //aDates contient nos entêtes de colonnes
        return $this->render('BaclooCrmBundle:Crm:planningsl.html.twig', array(
            'dates' => $aDates,
            'dstart' => $dStart,
            'dend' => $dEnd,
            'locations' => $locations,
            'nbjannee' => $nbjannee,
            'nbmois' => $nbmois,
            'mode' => $mode,
            'form' => $form->createView()
        ));
    }


    public function rechercheAction(Request $request)
    {
        $villes = 0;
        return $this->render('BaclooCrmBundle:Crm:recherche.html.twig', array(
            'villes' => $villes
        ));
    }

    // public function larouteAction()
    // {
    // $usersess = $this->get('security.context')->getToken()->getUsername();


    // $repository = $this
    // ->getDoctrine()
    // ->getManager()->getRepository('BaclooCrmBundle:Fiche');

    // $villes = $repository->findByVille('gagny');

    // return $this->render('BaclooCrmBundle:Crm:result.html.twig', array(
    // 'villes' => $villes
    // ));
    // }



    // public function listechantierAction(Request $request)
    // {
    // $term = $request->get('motcle');

    // $em = $this->getDoctrine()->getManager();
    // $array = $em->getRepository('BaclooCrmBundle:Fiche')
    // ->updateData($term);

    // $response = new Response(json_encode($array));

    // $response -> headers -> set('Content-Type', 'application/json');
    // return $response;
    // }

    public function updatechantierAction(Request $request)
    {
        $search = $request->get('search');
        if(!empty($search))
        {
            $em = $this->getDoctrine()->getManager();
            $query = $em->createQuery(
                'SELECT f
					FROM BaclooCrmBundle:Chantier f
					WHERE f.nom LIKE :nom'
            );
            $query->setParameter('nom', '%'.$search.'%');
            $result = $query->getArrayResult();

            // Transformer le tableau associatif en un tableau standard
            $array = array();
            foreach ($result as $data) {
                $array[] = array("value"=>$data['id'],"label"=>$data['nom'],"adresse1"=>$data['adresse1'],"adresse2"=>$data['adresse2'],"adresse3"=>$data['adresse3'],"cp"=>$data['cp'],"ville"=>$data['ville']);
            }
        }
        $response = new Response(json_encode($array));
        return $response;
    }

    public function updatecodemachineinterneAction(Request $request)
    {
        $search = $request->get('search');
        if(!empty($search))
        {
            $em = $this->getDoctrine()->getManager();
            $query = $em->createQuery(
                'SELECT f
					FROM BaclooCrmBundle:Machines f
					WHERE f.code LIKE :code
					AND f.etat = :etat'
            );
            $query->setParameter('code', '%'.$search.'%');
            $query->setParameter('etat', 'Disponible');
            $result = $query->getArrayResult();

            // Transformer le tableau associatif en un tableau standard
            $array = array();
            foreach ($result as $data) {
                $array[] = array("label"=>$data['code']);
            }
        }
        $response = new Response(json_encode($array));
        return $response;
    }

    public function updatecodemachineinternetoutAction(Request $request)
    {
        $search = $request->get('search');
        if(!empty($search))
        {
            $em = $this->getDoctrine()->getManager();
            $query = $em->createQuery(
                'SELECT f
					FROM BaclooCrmBundle:Machines f
					WHERE f.code LIKE :code'
            );
            $query->setParameter('code', '%'.$search.'%');
            $result = $query->getArrayResult();

            // Transformer le tableau associatif en un tableau standard
            $array = array();
            foreach ($result as $data) {
                $array[] = array("label"=>$data['code']);
            }
        }
        $response = new Response(json_encode($array));
        return $response;
    }

    public function updatecodemachineinterneslAction(Request $request)
    {
        $search = $request->get('search');
        if(!empty($search))
        {
            $em = $this->getDoctrine()->getManager();
            $query = $em->createQuery(
                'SELECT f
					FROM BaclooCrmBundle:Machinessl f
					WHERE f.code LIKE :code
					AND f.etat = :etat'
            );
            $query->setParameter('code', '%'.$search.'%');
            $query->setParameter('etat', 'Disponible');
            $result = $query->getArrayResult();

            // Transformer le tableau associatif en un tableau standard
            $array = array();
            foreach ($result as $data) {
                $array[] = array("label"=>$data['code']);
            }
        }
        $response = new Response(json_encode($array));
        return $response;
    }

    public function updatecodemachineinternemixteAction(Request $request)
    {
        $search = $request->get('search');
        // $search = 'SL';
        if(!empty($search))
        {
            $em = $this->getDoctrine()->getManager();
            $query = $em->createQuery(
                'SELECT f
					FROM BaclooCrmBundle:Machines f
					WHERE f.code LIKE :code
					AND f.etat = :etat'
            );
            
//                $query = $em->createQuery(
//                    'SELECT f
//						FROM BaclooCrmBundle:Machinessl f
//						WHERE f.code LIKE :code
//						AND f.etat = :etat'
//                );
//                $query->setParameter('code', '%'.$search.'%');
//                $query->setParameter('etat', 'Disponible');
//                $result = $query->getArrayResult();
//            }
            // else{}print_r($result);
            // Transformer le tableau associatif en un tableau standard
            $array = array();
            foreach ($result as $data) {
                $array[] = array("label"=>$data['code']);
            }
        }
        $response = new Response(json_encode($array));
        return $response;
    }

    public function ajouterlocationAction($ficheid, $locid, $erreur, $mode,  Request $request)
    {
        $objUser = $this->get('security.context')->getToken()->getUsername(); if(empty($objUser) or !isset($objUser) or $objUser == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        // echo 'erreur'.$erreur;
        // if ($this->container->has('profiler'))
        // {
        // $this->container->get('profiler')->disable();
        // }
        $today = date('Y-m-d');
        $year = date('Y');

        // $erreur = 0;
        $em = $this->getDoctrine()->getManager();//echo 'locid'.$locid;echo 'ficheid'.$ficheid;
        if($ficheid == 0)
        {
            $locata  = $em->getRepository('BaclooCrmBundle:Locata')
                ->findOneById($locid);
            $ficheid = $locata->getClientid();
        }
        $client  = $em->getRepository('BaclooCrmBundle:Fiche')
            ->findOneById($ficheid);

        $totalht = 0;//echo $locid;
        $totaltrspaller = 0;//echo $locid;
        $totaltrspretour = 0;//echo $locid;
        $contributionverte = 0;//echo $locid;
        $assurance = 0;//echo $locid;
        $montantcarb = 0;

        $listeDesComposantsParDefautRoulottes = $em->getRepository('BaclooCrmBundle:ComposantsRoulotte')
            ->findAll();
        // On crée un objet Locata
        if($locid == 0)
        {
            $locata = new Locata;
            $contrat = 0;
            $bdcrecu = 0;
            $montantcarb = 0;
            $locata->setDatecrea(date('Y-m-d'));
            $locata->setPrixcarb($client->getPrixcarb());
            $locata->setPrixgnr($client->getPrixgnr());
            $locata->setFacturersamedi(true);
            $locata->setFacturerdimanche(true);
            $locata->setFacturationferies(true);
            $locata->setCommentaire('Participation à la gestion des déchets - compris dans le tarif de la prestation de la vidange');

            foreach ($listeDesComposantsParDefautRoulottes as $component) {
                $locatavente = new LocataVentes();
//                $locatavente->setRefArticle($component->getRefArticle());
                $locatavente->setDescription($component->getDescription());
                $locatavente->setQuantite($component->getQuantite());
                $locatavente->setPu($component->getPu());
                // Ajoutez d'autres propriétés si nécessaire
                $locata->addLocatavente($locatavente);
            }

        }
        else
        {
            $locata = $em->getRepository('BaclooCrmBundle:Locata')
                ->findOneById($locid);
            $client  = $em->getRepository('BaclooCrmBundle:Fiche')
                ->findOneById($ficheid);
            if(isset($client))
            {
//                $locata->setPrixcarb($client->getPrixcarb());
//                $locata->setPrixgnr($client->getPrixgnr());
                if($client->getAssurance() == 1 && $locata->getAssurance() == 0)
                {
                    $locata->setAssurance(0);
                    $em->persist($locata);
                }
            }

            $contrat = $locata->getContrat();
            $bdcrecu = $locata->getBdcrecu();

            if(null == $locata->getChantierid())
            {
                $chantier = $em->getRepository('BaclooCrmBundle:Chantier')
                    ->findOneByNom($locata->getNomchantier());

                if(!empty($chantier))
                {
                    $chantierid = $chantier->getId();
                    $locata->setChantierid($chantierid);
                }
            }
            $em->flush();
//            foreach($locata->getLocations()  as $loca)
//            {
//                echo 'ééééé'.$loca->getEtatloc();exit();
//            }
        }
        $objUser = $this->get('security.context')->getToken()->getUsername(); if(empty($objUser) or !isset($objUser) or $objUser == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        $em = $this->getDoctrine()->getManager();
        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($objUser);

        $fiche  = $em->getRepository('BaclooCrmBundle:Fiche')
            ->findOneById($ficheid);
        $userid = $userdetails->getId();
        $form = $this->createForm(new LocataType(), $locata);
        $today = date('Y-m-d');
        include('societe.php');

        //On met les locations dans un array pour controle ultérieur
        // $listeloc = array();
        // foreach ($locata->getLocations() as $loc) {
        // $listeloc[] = $loc;
        // }

        $em = $this->getDoctrine()->getManager();
        $modules  = $em->getRepository('BaclooCrmBundle:Modules')
            ->findOneByUsername($objUser);

        $destinatairedevis = 'non renseigné';
        $destinatairecontrat = 'non renseigné';
        $destinataireproforma = 'non renseigné';
        if(isset($client))
        {
            foreach($client->getBcontacts() as $contact)
            {
                if($contact->getRecoitdevis() == 1)
                {
                    $destinatairedevis  = $contact->getEmail();
                    $destinatairecontrat  = $contact->getEmail();
                    $destinataireproforma  = $contact->getEmail();
                }
                elseif($locid > 0)
                {
                    $destinatairedevis  = $locata->getDestinatairedevis();
                    $destinatairecontrat  = $locata->getDestinatairecontrat();
                    $destinataireproforma  = $locata->getDestinataireproforma();
                }
            }
        }
// echo 'WWWWWWWWWWWWWWWWWWWWWWWWW';
        // On récupère la requête
        $request = $this->get('request');
        // On vérifie qu'elle est de type POST
        // echo $request->getMethod();
        if ($request->getMethod() == 'POST')
        {
            if ($this->getRequest()->request->get('devis') == 'Envoyer' or $this->getRequest()->request->get('contrat') == 'Envoyer' or $this->getRequest()->request->get('proforma') == 'Envoyer')
            {//echo 'envoi de devis';
                // On fait le lien Requête <-> Formulaire
                $form->bind($request);
                //Mettre à jour la date

                echo 'aprè';
                $today = date('Y-m-d');
                $em = $this->getDoctrine()->getManager();//echo 'locid'.$locid;

                $client  = $em->getRepository('BaclooCrmBundle:Fiche')
                    ->findOneById($ficheid);

                $totalht = 0;//echo $locid;


                $locata  = $em->getRepository('BaclooCrmBundle:Locata')
                    ->findOneById($locid);

                $client  = $em->getRepository('BaclooCrmBundle:Fiche')
                    ->findOneById($ficheid);

                $userdetails  = $em->getRepository('BaclooUserBundle:User')
                    ->findOneByUsername($objUser);

                $em->persist($locata);
                $em->flush();

                if(null !== $locata->getDestinatairedevis() or null !== $locata->getDestinatairecontrat() or null !== $locata->getDestinataireproforma())
                {echo 'envoi mail';
                    $codecontrat = $locata->getId();
                    $clientid = $locata->getClientid();

                    $clients  = $em->getRepository('BaclooCrmBundle:Fiche')
                        ->findOneById($clientid);

                    $totalvente = 0;
                    foreach($locata->getLocataventes() as $ven)
                    {
                        $montantvente = $ven->getQuantite() * abs($ven->getPu());
                        $totalvente += $ven->getQuantite() * abs($ven->getPu());
                        // $em->flush();
                    }

                    // echo 'RECOIT';echo $contact->getRecoitfact();
                    // echo 'OK';
                    // Récupération du service
                    $pdf = $this->get("white_october.tcpdf")->create();
                    if($this->getRequest()->request->get('devis') == 'Envoyer')
                    {
                        $mode = 'offreloc';
                    }
                    elseif($this->getRequest()->request->get('devisvente') == 'Envoyer')
                    {
                        $mode = 'devisvente';
                    }
                    elseif($this->getRequest()->request->get('contrat') == 'Envoyer')
                    {
                        $mode = 'contrat';
                    }
                    elseif($this->getRequest()->request->get('proforma') == 'Envoyer')
                    {echo 'date proforma';
                        $mode = 'proforma';
                    }
                    $html = $this->renderView('BaclooCrmBundle:Crm:nouvelle_locationpdf.html.twig', array('form' => $form->createView(),
                        'mode' => $mode,
                        'date' => date('Y-m-d'),
                        'roleuser' => $userdetails->getRoleuser(),
                        'client' => $clients,
                        'locata' => $locata,
                        'contrat' => $locata->getContrat(),
                        'bdcrecu' => $locata->getBdcrecu(),
                        'locid' => $locata->getId(),
                        'totalvente' => $totalvente,
                        'anneedevis' => date("Y", strtotime($locata->getDatecrea())),
                        'moisdevis' => date("m", strtotime($locata->getDatecrea())),
                        'compteurdevis' => $locata->getCompteurdevis(),
                        'user' => $objUser));

                    $pdf->SetFont('helvetica', '', 9, '', true);
                    // set margins
                    $pdf->SetMargins(13, '10', '5', '0');
                    $pdf->AddPage();

                    // -- set new background ---

                    // get the current page break margin
                    $bMargin = $pdf->getBreakMargin();
                    // get current auto-page-break mode
                    $auto_page_break = $pdf->getAutoPageBreak();
                    // disable auto-page-break
                    $pdf->SetAutoPageBreak(false, 0);
                    // set bacground image
                    $img_file = K_PATH_IMAGES.'devistemplate.jpg';
                    $pdf->Image($img_file, 0, 0, 210, 297, 'JPG', '', '', false, 300, '', false, false, 0);
                    // restore auto-page-break status
                    $pdf->SetAutoPageBreak($auto_page_break, $bMargin);
                    // set the starting point for the page content
                    $pdf->setPageMark();

                    $pdf->writeHTML($html, true, false, true, false, '');
                    $pdf->lastPage();
                    $pdf_as_string = new Response($pdf->Output('devis.pdf', 'S')); // $pdf is a TCPDF instance
                    // $pdf_as_string = $response->headers->set('Content-Type', 'application/pdf');
                    $mailer = $this->get('mailer');

                    if ($this->getRequest()->request->get('devis') == 'Envoyer') {
                        $message = \Swift_Message::newInstance()
                            ->setSubject('FGG Location : Votre devis')
                            // ->setFrom(array('zinedine.cora2ltm@gmail.com ' => 'Cora2Ltm'))
                            ->setFrom(array('bacloo@bacloo.fr' => 'FGG Location'))
                            ->setTo($locata->getDestinatairedevis())
                            ->setReplyTo('info@fgglocation.fr')
                            // ->setTo('ringuetjm@gmail.com')
                            ->setBody($this->renderView('BaclooCrmBundle:Crm:devis_email.html.twig', array()))
                            ->setContentType("text/html");
                        $attachment = \Swift_Attachment::newInstance($pdf_as_string, 'devis.pdf', 'application/pdf');
                        $message->attach($attachment);
                        //On joint les fiches techiques dynamiquement

//                        $fichestech = $em->getRepository('BaclooCrmBundle:Locata')
//                            ->fichestech($locid);//print_r($fichestech);
//                        $appPath = $this->container->getParameter('kernel.root_dir');
//                        $webPath = realpath($appPath . '/../web/uploads/Fichestech');//echo $webPath;
//                        foreach ($fichestech as $fich) {
//                            $machine = $fich['codemachine'];
//                            // $message->attach(\Swift_Attachment::fromPath(''.$webPath.'\\'.$machine.'.pdf'));
//                            $filename = $webPath . '/' . $machine . '.pdf';
//                            if (file_exists($filename)) {
//                                echo 'filename';
//                                $message->attach(\Swift_Attachment::fromPath('' . $webPath . '/' . $machine . '.pdf'));
//                            } else {
//                                echo 'pas filename';
//                            }
//                        }
                        $mailer->send($message);
                        if ($mailer->send($message)) {
                            $locata->setDateenvoidevis(new \DateTime('now'));
                            $em->persist($locata);
                            $em->flush();
                        } else {
                            echo "Failed\n";
                        }

                        //Envoie de la copie du message
                        $message2 = \Swift_Message::newInstance()
                            ->setSubject('FGG Location : Devis envoyé à ' . $locata->getClient() . ' à l adresse ' . $locata->getDestinatairedevis())
                            // ->setFrom(array('zinedine.cora2ltm@gmail.com ' => 'Cora2Ltm'))
                            ->setFrom(array('bacloo@bacloo.fr' => 'FGG Location'))
                            ->setTo('info@fgglocation.fr')
                            ->setReplyTo('info@fgglocation.fr')
//							 ->setTo('ringuetjm@gmail.com')
                            ->setBody($this->renderView('BaclooCrmBundle:Crm:devis_email.html.twig', array()))
                            ->setContentType("text/html");
                        $attachment = \Swift_Attachment::newInstance($pdf_as_string, 'devis.pdf', 'application/pdf');
                        $message2->attach($attachment);
                        //On joint les fiches techiques dynamiquement

//                        $fichestech = $em->getRepository('BaclooCrmBundle:Locata')
//                            ->fichestech($locid);//print_r($fichestech);
//                        $appPath = $this->container->getParameter('kernel.root_dir');
//                        $webPath = realpath($appPath . '/../web/uploads/Fichestech');//echo $webPath;
//                        foreach ($fichestech as $fich) {
//                            $machine = $fich['codemachine'];
//                            // $message->attach(\Swift_Attachment::fromPath(''.$webPath.'\\'.$machine.'.pdf'));
//                            $filename = $webPath . '/' . $machine . '.pdf';
//                            if (file_exists($filename)) {
//                                echo 'filename';
//                                $message2->attach(\Swift_Attachment::fromPath('' . $webPath . '/' . $machine . '.pdf'));
//                            } else {
//                                echo 'pas filename';
//                            }
//                        }
                        $mailer->send($message2);
                    }
                    elseif ($this->getRequest()->request->get('contrat') == 'Envoyer')
                    {
                        $message = \Swift_Message::newInstance()
                            ->setSubject('FGG Location: Votre Contrat')
                            // ->setFrom(array('zinedine.cora2ltm@gmail.com ' => 'Cora2Ltm'))
                            ->setFrom(array('bacloo@bacloo.fr' => 'FGG Location'))
                            ->setTo($locata->getDestinatairecontrat())
                            ->setReplyTo('info@fgglocation.fr')
                            // ->setTo('ringuetjm@gmail.com')
                            ->setBody($this->renderView('BaclooCrmBundle:Crm:contrat_email.html.twig', array()));
                        $attachment = \Swift_Attachment::newInstance($pdf_as_string, 'contrat.pdf', 'application/pdf');
                        $message->attach($attachment);
                        $mailer->send($message);
                        if ($mailer->send($message)) {
                            $locata->setDateenvoiproforma(new \DateTime('now'));
                            $em->persist($locata);
                            $em->flush();
                        } else {
                            echo "Failed\n";
                        }

                        //Envoie de la copie du message
                        $message2 = \Swift_Message::newInstance()
                            ->setSubject('FGG Location : Contrat envoyé à ' . $locata->getClient() . ' à l adresse ' . $locata->getDestinatairedevis())
                            // ->setFrom(array('zinedine.cora2ltm@gmail.com ' => 'Cora2Ltm'))
                            ->setFrom(array('bacloo@bacloo.fr' => 'FGG Location'))
                            ->setTo('info@fgglocation.fr')
                            ->setReplyTo('info@fgglocation.fr')
//							 ->setTo('ringuetjm@gmail.com')
                            ->setBody($this->renderView('BaclooCrmBundle:Crm:contrat_email.html.twig', array()));
                        $attachment = \Swift_Attachment::newInstance($pdf_as_string, 'contrat.pdf', 'application/pdf');
                        $message2->attach($attachment);
                        $mailer->send($message2);
                        if ($mailer->send($message2)) {
                            $locata->setDateenvoiproforma(new \DateTime('now'));
                            $em->persist($locata);
                            $em->flush();
                        } else {
                            echo "Failed\n";
                        }
                    }
                    elseif($this->getRequest()->request->get('proforma') == 'Envoyer')
                    {	echo 'envoi proforma';
                        $message = \Swift_Message::newInstance()
                            ->setSubject('FGG Location  : Votre facture proforma')
                            // ->setFrom(array('info@fgglocation.fr' => 'FGG Location'))
                            ->setFrom(array('info@fgglocation.fr' => 'FGG Location'))
                            ->setTo($locata->getDestinataireproforma())
                            ->setReplyTo('info@fgglocation.fr')
                            // ->setTo('ringuetjm@gmail.com')
                            ->setBody($this->renderView('BaclooCrmBundle:Crm:proforma_email.html.twig', array()))
                        ;
                        $attachment = \Swift_Attachment::newInstance($pdf_as_string, 'proforma.pdf', 'application/pdf');
                        $message->attach($attachment);
                        $mailer->send($message);

                        //Envoi de la copie
                        echo 'envoi proforma';
                        $message2 = \Swift_Message::newInstance()
                            ->setSubject('FGG Location : Proforma envoyé à '.$locata->getClient().' à l adresse '.$locata->getDestinatairedevis())
                            // ->setFrom(array('info@fgglocation.fr' => 'FGG Location'))
                            ->setFrom(array('info@fgglocation.fr' => 'FGG Location'))
                            ->setTo('info@fgglocation.fr')
                            ->setReplyTo('info@fgglocation.fr')
                            //							 ->setTo('ringuetjm@gmail.com')
                            ->setBody($this->renderView('BaclooCrmBundle:Crm:proforma_email.html.twig', array()))
                        ;
                        $attachment = \Swift_Attachment::newInstance($pdf_as_string, 'proforma.pdf', 'application/pdf');
                        $message2->attach($attachment);
                        $mailer->send($message2);
                    }

                }else{echo 'pas de destinataire';}
            }
            else
            {
                $form->bind($request);
                // On vérifie que les valeurs entrées sont correctes
                // $data = $form->getData();
                if ($form->isValid()) {
                    //Création du numero d'offre unique
                    echo 'loooogique';
                    //Création du numero de contrat unique
                    // $data = $form->getData();
                    $facturersamedi = 1;
                    $facturerdimanche = 1;
                    $facturationferies = 1;
                    if ($facturersamedi == 1) {
                        $locata->setFacturersamedi(1);
                    } elseif ($facturersamedi == 0) {

                        $locata->setFacturersamedi(0);
                    }
                    if ($facturerdimanche == 1) {
                        $locata->setFacturerdimanche(1);
                    } elseif ($facturerdimanche == 0) {
                        $locata->setFacturerdimanche(0);
                    }
                    if ($facturationferies == 1) {
                        $locata->setFacturationferies(1);
                    } elseif ($facturationferies == 0) {
                        $locata->setFacturationferies(0);
                    }

                    $rempli = 0;
                    foreach ($form->get('locations')->getData() as $loc) {//echo '&&&&&'.$loc->getEtatloc();exit();
                        if (null !== $loc->getCodemachine()) {
                            $rempli++;echo 'ass'.$loc->getAssurance();
                            $machine2 = $em->getRepository('BaclooCrmBundle:Machines')
                                ->findBy(array('code' => $loc->getCodemachineinterne(), 'etat' => 'Réservé'));

                            if (isset($machine2)) {
                                foreach ($machine2 as $macha) {
                                    if (isset($macha) && strtotime($macha->getDebutloc()) <= strtotime($loc->getFinloc()) && $macha->getEntreprise() != $loc->getEntreprise()) {
                                        //									return $this->redirect($this->generateUrl('bacloocrm_ajouterlocation', array('ficheid' => $ficheid, 'locid' => $locid, 'erreur' => 6 )));
                                    }
                                }
                            }

                            if(empty($loc->getAssurance()) or $loc->getAssurance() == '')
                            {//echo 'laaaaa';
                                $loc->setAssurance(0);
                            }
                        }
                    }
                    foreach ($form->get('locationssl')->getData() as $loc) {//echo '&&&&&'.$loc->getEtatloc();
                        if (null !== $loc->getCodemachine()) {
                            $rempli++;
                        }
                    }

                    if ($rempli == 0) {
                        return $this->redirect($this->generateUrl('bacloocrm_ajouterlocation', array('ficheid' => $ficheid, 'locid' => $locid, 'erreur' => 3)));
                    }

                    // $debutloc = $form->get('debutloc')->getData();
                    // $finloc = $form->get('finloc')->getData();
                    $entreprise = $form->get('client')->getData();
                    $nomchantier = $form->get('nomchantier')->getData();
                    $adresse1 = $form->get('adresse1')->getData();
                    $adresse2 = $form->get('adresse2')->getData();
                    $adresse3 = $form->get('adresse3')->getData();
                    $cp = $form->get('cp')->getData();
                    $ville = $form->get('ville')->getData();
                    $bdcrecu = $form->get('bdcrecu')->getData();
                    $contrat = $form->get('contrat')->getData();
                    $offreencours = $form->get('offreencours')->getData();
                    $refusee = $form->get('offrerefusee')->getData();
//                    $locations = $form->get('locations')->getData();

                    // if($contrat != 1 && $offreencours != 1)
                    // {
                    $em->persist($locata);
                    $em->flush();//echo 'enlocaaaa';exit();
                    $locid = $locata->getId();

                    if($locata->getClientid() == 0)
                    {
                        $client  = $em->getRepository('BaclooCrmBundle:Fiche')
                            ->findOneByRaisonSociale($locata->getClient());

                        if(!isset($client))
                        {
                            $client = new Fiche;
                            $client->setRaisonSociale($form->get('client')->getData());
                            $client->setAdresse1($form->get('adresse1')->getData());
                            $client->setAdresse2($form->get('adresse2')->getData());
                            $client->setAdresse3($form->get('adresse3')->getData());
                            $client->setCp($form->get('cp')->getData());
                            $client->setVille($form->get('ville')->getData());                //Ajout du prix carb et gnr
                            $fichefgg = $em->getRepository('BaclooCrmBundle:Fiche')
                                ->findOneById(4566);
//                            $client->setPrixcarb($fichefgg->getPrixcarb());
//                            $client->setPrixgnr($fichefgg->getPrixgnr());
                            $em->persist($client);
                            $em->flush();
                            $locata->setClientid($client->getId());
                            //ajouter les adresse
                            $locata->setAdresse1($form->get('adresse1')->getData());
                            $locata->setAdresse2($form->get('adresse2')->getData());
                            $locata->setAdresse3($form->get('adresse3')->getData());
//                            $locata->setPrixcarb($client->getPrixcarb());
//                            $locata->setPrixgnr($client->getPrixgnr());
                            $locata->setCp($form->get('cp')->getData());
                            $locata->setVille($form->get('ville')->getData());
                        }
                        $locata->setClientid($client->getId());
                        foreach($locata->getLocations() as $loca)
                        {
                            $loca->setCodeclient($client->getId());
                            $loca->setEntreprise($client->getRaisonSociale());
                        }
                        $em->persist($locata);
                        $em->flush();
                    }//die('ici'.$locata->getClientid() );
//                    echo 'LOCAID' . $locid;
                    // }
                    //Mise à jour de la table chantier si le chantier n'existe pas
                    $chantier = $em->getRepository('BaclooCrmBundle:Chantier')
                        ->findOneByNom($nomchantier);
                    if (empty($chantier)) {
                        $newchantier = new Chantier;
                        $newchantier->setNom($nomchantier);
                        $newchantier->setAdresse1($adresse1);
                        $newchantier->setAdresse2($adresse2);
                        $newchantier->setAdresse3($adresse3);
                        $newchantier->setCp($cp);
                        $newchantier->setVille($ville);
                        $em->persist($newchantier);
                        // $em->flush();
                    }
                    //Fin maj chantier

                    //FACTURATION

                    //Création du montant HT ligne par ligne
                    $totalht = 0;//echo $locid;
                    $totaltrspaller = 0;
                    $totaltrspretour = 0;
                    $contributionverte = 0;
                    $assurance = 0;

                    //Calcul totalht locations parc
                    foreach ($form->get('locations')->getData() as $loc)
                    {
                        if ($loc->getEntreprise() == 'ASY TS') {
                            $loc->getAssurance(1);
                        }
                        $nbjlocadeduire = 0;
                        $nbjloc = 0;
                        $nbjlocass = 0;
                        $debutloc = $loc->getDebutloc();//echo $debutloc;
                        $finloc = $loc->getFinloc();//echo $finloc;
                        $dStart = $debutloc;
                        $dEnd = $finloc;

                        //mettre le if sur debutloc ou finloc et si <= date du jour >>>> redirect !
                        if ($debutloc <= $today && $loc->getEtatloc() != 'Location terminée') {
                            $this->redirect($request->server->get('HTTP_REFERER'));
                        }
                        // fin redirect
                        //1.Récupérer les données de la table Machines

                        //2.On génère les entêtes de colonnes à partir de la fonction createplanning
                        $iStart = strtotime($dStart);//Formate une date/heure locale avec la Something is wronguration locale
                        $iEnd = strtotime($dEnd);
                        if (false === $iStart || false === $iEnd) {
                            // return false;
                        }
                        $aStart = explode('-', $dStart);
                        $aEnd = explode('-', $dEnd);
                        if (count($aStart) !== 3 || count($aEnd) !== 3) {
                            // return false;
                        }
                        // if (false === checkdate ($aStart[1], $aStart[2], $aStart[0]) || false === checkdate ($aEnd[1], $aEnd[2], $aEnd[0]) || $iEnd <= $iStart) {
                        // return false;
                        // }

                        $jour50 = $loc->getJour50();
                        $jour100 = $loc->getJour100();

                        $aDates = array();
                        for ($i = $iStart; $i <= $iEnd; $i = $i + 86400) {
                            $sDateToArr = strftime('%Y-%m-%d', $i);
                            $sYear = substr($sDateToArr, 0, 4);
                            $sMonth = substr($sDateToArr, 5, 2);

                            if(strftime ('%Y-%m-%d', $i) != strftime ('%Y-%m-%d', $i + 86400))
                            {
                                $aDates[] = $sDateToArr;//echo '>>'.$sDateToArr;
                            }
                        }

                        //on calcule le nombre de jours de location

                        $feries = $this->getHolidays($year);
                        foreach ($aDates as $dat) {    //echo $dat;
                            $time = strtotime($dat);
                            $newformat = date('D', strtotime($dat));
                            // echo $dat;
                            //Calcul nb jours fériés
                            $i = 0;
                            foreach ($feries as $fer) {
                                if (date('m-d', $fer) == date('m-d', $time)) {
                                    if ($newformat !== 'Sat' and $newformat !== 'Sun') {
                                        $i++;
                                    }
                                }
                            }
                            //Facturation WE ou pas
                            $newformat = date('D', $time);

                            if ($facturersamedi == 1 && $newformat == 'Sat') {
                                $nbjloc++;
                            } elseif ($facturerdimanche == 1 && $newformat == 'Sun') {
                                $nbjloc++;
                            } elseif ($newformat == 'Sat' or $newformat == 'Sun') {
                            } else {////echo '== ajout';
                                $nbjloc++;
                            }
                            if ($facturationferies == 0) {
                                $nbjloc = $nbjloc - $i;
                            }
                        }


                        //nb jour pour les assurances car 7/7
                        foreach ($aDates as $dat) {
                            $nbjlocass++;
                        }
                        $jour50 = $loc->getJour50();
                        $jour100 = $loc->getJour100();

                        if (isset($jour50)) {
                            $nbjlocadeduire += $jour50 * 0.5;//nb jours corrigé
                        }
                        if (isset($jour100)) {
                            $nbjlocadeduire += $jour100;//nb jours corrigé
                        }
                        // echo 'nbjloc'.$nbjloc;
                        $nbjloc += $nbjlocadeduire;
                        $nbjlocass += $nbjlocadeduire;
                        // echo '***';
                        // echo $nbjlocadeduire;
                         echo 'HHHHH'.$nbjloc;
                        if (null !== $loc->getLoyerp1()) {
                            $totalht += $nbjloc * $loc->getLoyerp1();
                            $totalhtloc = $nbjloc * $loc->getLoyerp1();
                            $totalhtlocass = $nbjlocass * $loc->getLoyerp1();
                            $loyer = $loc->getLoyerp1();
                        } elseif (null !== $loc->getLoyerp2()) {
                            $totalht += $nbjloc * $loc->getLoyerp2();
                            $totalhtloc = $nbjloc * $loc->getLoyerp2();
                            $totalhtlocass = $nbjlocass * $loc->getLoyerp2();
                            $loyer = $loc->getLoyerp2();
                        } elseif (null !== $loc->getLoyerp3()) {
                            $totalht += $nbjloc * $loc->getLoyerp3();
                            $totalhtloc = $nbjloc * $loc->getLoyerp3();
                            $totalhtlocass = $nbjlocass * $loc->getLoyerp3();
                            $loyer = $loc->getLoyerp3();
                        } elseif (null !== $loc->getLoyerp4()) {
                            $totalht += $nbjloc * $loc->getLoyerp4();
                            $totalhtloc = $nbjloc * $loc->getLoyerp4();
                            $totalhtlocass = $nbjlocass * $loc->getLoyerp4();
                            $loyer = $loc->getLoyerp4();
                        } elseif (null !== $loc->getLoyermensuel()) {
                            include('calculnbjlocmensuelle.php');
                            //echo 'nbjloc' . $nbjloc;exit();
                            $loyer = $loc->getLoyermensuel() / 20;
                            $totalht += $loyer * $nbjloc;
                            $totalhtloc = $loyer * $nbjloc;
                            echo 'totalht' . $totalht;
                            $totalhtlocass = ($loyer) * $nbjlocass;
                        }
                        if($loc->getRemise() > 0)
                        {//echo 'totalhtlocavant'.$totalhtloc;
                            $totalht = $totalht  - ($totalhtloc * $loc->getRemise()/100);
                            $totalhtloc = $totalhtloc - ($totalhtloc * $loc->getRemise()/100);
                            //echo 'totalhtxxx'.$totalht;echo 'remise'.$loc->getRemise();echo 'totalhtloc'.$totalhtloc;exit();
                        }
                        // echo 'loyer';echo $loyer;
                        $totaltrspaller += $loc->getTransportaller();
                        $totaltrspretour += $loc->getTransportretour();

                        if ($loc->getContributionverte() == 1) {
                            $contributionverte += 0.0215 * $loyer * $nbjloc;
                        }

                        if ($loc->getAssurance() == 1) {
                            if($client->getAssurance() == 1)
                            {
                                $assurance = 0;
                            }
                            else
                            {
                                $assurance += $totalhtloc * 0.10;
                            }
                        }//echo '$assurance'.$assurance;echo '$totalhtloc'.$totalhtloc;exit();
                        echo 'machineid' . $loc->getMachineid();
                        if($loc->getEtatloc() != 'Location terminée')
                        {
                            $machine = $em->getRepository('BaclooCrmBundle:Machines')
                                ->findOneById($loc->getMachineid());
                            if (isset($machine)) {
                                $machine->setDebutloc($loc->getDebutloc());
                                $machine->setFinloc($loc->getFinloc());
                                $em->persist($machine);
                            }
                        }
                        $loc->setMontantloc($totalhtloc);
                        $loc->setNbjloc($nbjloc);
                        $loc->setNbjlocass($nbjlocass);
                        $em->persist($loc);
                        //						}
                        $em->flush();

                    }
                    //echo 'nbjloc'.$nbjloc;exit();
                    //Calcul total ht sous loc
                    foreach ($form->get('locationssl')->getData() as $loc) {    //echo 'yyyyyyyyyy';
                        if ($loc->getEntreprise() == 'ASY TS') {
                            $loc->setAssurance(1);
                        }
                        $nbjlocadeduire = 0;
                        $nbjloc = 0;
                        $nbjlocass = 0;
                        $debutloc = $loc->getDebutloc();//echo $debutloc;
                        $finloc = $loc->getFinloc();//echo $finloc;
                        $dStart = $debutloc;
                        $dEnd = $finloc;

                        //mettre le if sur debutloc ou finloc et si <= date du jour >>>> redirect !
                        if ($debutloc <= $today) {
                            $this->redirect($request->server->get('HTTP_REFERER'));
                        }
                        // fin redirect
                        //1.Récupérer les données de la table Machines

                        //2.On génère les entêtes de colonnes à partir de la fonction createplanning
                        $iStart = strtotime($dStart);//Formate une date/heure locale avec la Something is wronguration locale
                        $iEnd = strtotime($dEnd);
                        if (false === $iStart || false === $iEnd) {
                            // return false;
                        }
                        $aStart = explode('-', $dStart);
                        $aEnd = explode('-', $dEnd);
                        if (count($aStart) !== 3 || count($aEnd) !== 3) {
                            // return false;
                        }
                        // if (false === checkdate ($aStart[1], $aStart[2], $aStart[0]) || false === checkdate ($aEnd[1], $aEnd[2], $aEnd[0]) || $iEnd <= $iStart) {
                        // return false;
                        // }

                        $jour50 = $loc->getJour50();
                        $jour100 = $loc->getJour100();
                        $aDates = array();
                        for ($i = $iStart; $i <= $iEnd; $i = $i + 86400) {
                            $sDateToArr = strftime('%Y-%m-%d', $i);
                            $sYear = substr($sDateToArr, 0, 4);
                            $sMonth = substr($sDateToArr, 5, 2);

                            if (strftime('%Y-%m-%d', $i) != strftime('%Y-%m-%d', $i + 86400)) {
                                $aDates[] = $sDateToArr;//echo '>>'.$sDateToArr;
                            }//echo '>>'.$sDateToArr;
                        }
                        //print_r($aDates);
                        //on calcule le nombre de jours de location
                        $feries = $this->getHolidays($year);
                        foreach ($aDates as $dat) {    //echo $dat;
                            $time = strtotime($dat);
                            $newformat = date('D', strtotime($dat));
                            // echo $dat;
                            //Calcul nb jours fériés
                            $i = 0;
                            foreach ($feries as $fer) {
                                if (date('m-d', $fer) == date('m-d', $time)) {
                                    if ($newformat !== 'Sat' and $newformat !== 'Sun') {//echo 'grrr'.$dat;echo 'fuck'.$newformat;echo 'ladate'.date('D',strtotime($dat));echo 'newformat'.$newformat;
                                        $i++;
                                    }
                                }
                            }
                            //Facturation WE ou pas
                            $newformat = date('D', $time);

                            if ($facturersamedi == 1 && $newformat == 'Sat') {
                                $nbjloc++;
                            } elseif ($facturerdimanche == 1 && $newformat == 'Sun') {
                                $nbjloc++;
                            } elseif ($newformat == 'Sat' or $newformat == 'Sun') {
                            } else {////echo '== ajout';
                                $nbjloc++;
                            }
                            if ($facturationferies == 0) {
                                $nbjloc = $nbjloc - $i;
                            }
                            //echo 'dat'.$dat;
                        }//echo '<br>NBJLOC'.$nbjloc.'<<<';echo $i;
                        //nb jour pour les assurances car 7/7
                        foreach ($aDates as $dat) {
                            $nbjlocass++;
                        }//echo 'nbjlocass'.$nbjlocass;exit();
                        $jour50 = $loc->getJour50();
                        $jour100 = $loc->getJour100();
                        if (isset($jour50)) {
                            $nbjlocadeduire += $jour50 * 0.5;//nb jours corrigé
                        }
                        if (isset($jour100)) {
                            $nbjlocadeduire += $jour100;//nb jours corrigé
                        }
                        echo $nbjloc;
                        $nbjloc += $nbjlocadeduire;
                        $nbjlocass += $nbjlocadeduire;
                        echo '***';
                        echo $nbjlocadeduire;
                        echo 'HHHHH' . $nbjloc;
                        if (null !== $loc->getLoyerp1()) {
                            $totalht += $nbjloc * $loc->getLoyerp1();
                            $totalhtloc = $nbjloc * $loc->getLoyerp1();
                            $totalhtlocass = $nbjlocass * $loc->getLoyerp1();
                            $loyer = $loc->getLoyerp1();
                        } elseif (null !== $loc->getLoyerp2()) {
                            $totalht += $nbjloc * $loc->getLoyerp2();
                            $totalhtloc = $nbjloc * $loc->getLoyerp2();
                            $totalhtlocass = $nbjlocass * $loc->getLoyerp2();
                            $loyer = $loc->getLoyerp2();
                        } elseif (null !== $loc->getLoyerp3()) {
                            $totalht += $nbjloc * $loc->getLoyerp3();
                            $totalhtloc = $nbjloc * $loc->getLoyerp3();
                            $totalhtlocass = $nbjlocass * $loc->getLoyerp3();
                            $loyer = $loc->getLoyerp3();
                        } elseif (null !== $loc->getLoyerp4()) {
                            $totalht += $nbjloc * $loc->getLoyerp4();
                            $totalhtloc = $nbjloc * $loc->getLoyerp4();
                            $totalhtlocass = $nbjlocass * $loc->getLoyerp4();
                            $loyer = $loc->getLoyerp4();
                        } elseif (null !== $loc->getLoyermensuel()) {
                            include('calculnbjlocmensuelle.php');
                            $loyer = $loc->getLoyermensuel() / 20;
                            $totalht += $loyer * $nbjloc;
                            $totalhtloc = $loyer * $nbjloc;
                            $totalhtlocass = ($loyer) * $nbjlocass;
                        }
                        echo 'LOYER';
                        echo $loyer;
                        echo 'totalhtloc';
                        echo $totalhtloc;
                        $totaltrspaller += $loc->getTransportaller();
                        $totaltrspretour += $loc->getTransportretour();

                        if ($loc->getContributionverte() == 1) {
                            $contributionverte += 0.0215 * $loyer * $nbjloc;
                        }
                        if($loc->getRemise() > 0)
                        {
                            $totalhtloc = $totalhtloc - ($totalhtloc * $loc->getRemise()/100);
                            $totalht = $totalht - ($totalhtloc * $loc->getRemise()/100);
                        }
                        if ($loc->getAssurance() == 1) {
                            if($client->getAssurance() == 1)
                            {
                                $assurance = 0;
                            }

                            if ($loc->getAssurance() == 1) {
                                $assurance += $totalhtlo * 0.10;
                            }
                        }
                        $loc->setMontantloc($totalhtloc);
                        echo 'totalhtloc2';
                        echo $totalhtloc;
                        $loc->setNbjloc($nbjloc);
                        $loc->setNbjlocass($nbjlocass);
                        $em->persist($loc);
                        $em->flush();
                        echo 'Loyerdef' . $loc->getMontantloc();
                    }


                    $montantvente = 0;
                    $totalvente = 0;
                    foreach ($form->get('locataventes')->getData() as $ven) {
                        $montantvente = $ven->getQuantite() * abs($ven->getPu());
                        $totalvente += $ven->getQuantite() * abs($ven->getPu());

                        $ven->setMontantvente($montantvente);
                        $em->persist($ven);
                        // $em->flush();
                    }

                    // if($locata->getRemise() > 0)
                    // {
                    // $totalht = $totalht - ($totalht * $locata->getRemise()/100);
                    // }
//                    echo 'TOTAL' . $totalht;exit();
                    $locata->setTransportaller($totaltrspaller);
                    $locata->setTransportretour($totaltrspretour);
                    $locata->setAssurance($assurance);
                    $locata->setContributionverte($contributionverte);
                    $locata->setMontantlocavente($totalvente);
                    $locata->setMontantloc($totalht);//echo 'totalht'.$totalht;exit();
                    $em->persist($locata);
                    $em->flush();
                    //FIN FACTURATION
                    //echo 'rrrrrrrrrrrrrr';
                    //MAJ de la table machine lorsqu'on reçoit un BDC pour réserver
                    if ($bdcrecu == 1 && $offreencours == 1 && $contrat == 0)
                    {
                        echo 'bdcrecu1 contrat0';
                        $locata = $em->getRepository('BaclooCrmBundle:Locata')
                            ->findOneById($locata->getId());

                        //machines parc
                        foreach ($locata->getLocations() as $loc) {
                            //Insertion du code location à la machine
                            $codelocations = $loc->getId();
                            $debutloc = $loc->getDebutloc();
                            $finloc = $loc->getFinloc();
                            echo 'x' . $codelocations;
                            //On vérifie si une becane est déjà réservée sur cet ecode
                            $locations = $em->getRepository('BaclooCrmBundle:Locations')
                                ->findOneById($codelocations);
                            if (null === $locations->getCodemachineinterne() && isset($locations))
                            {
                                $debutlocok = date('Y-m-d', strtotime($debutloc . ' -1 day'));
                                $finlocok = date('Y-m-d', strtotime($finloc . ' +1 day'));
                                $machin = $em->getRepository('BaclooCrmBundle:Machines')
                                    ->unedispo($loc->getCodemachine(), $debutlocok, $finlocok);
                                if (!empty($machin)) {
                                    $machinesok = array();
                                    foreach ($machin as $mach) {
                                        $machinesok[] = $mach['code'];
                                    }
                                    echo 'loto';
                                    $index = array_rand($machin);//echo $machinesok[$index];
                                    $code = $machinesok[$index];
                                    foreach ($machin as $mach) {
                                        if ($mach['code'] == $code) {
                                            $code = $mach['code'];
                                            $etat = $mach['etat'];
                                            $energie = $mach['energie'];
                                            $machineid = $mach['id'];
                                        }
                                    }
                                    echo 'code1' . $code;

                                    //MAJ table Locations suite réservation
//                                    $resaloc = $em->getRepository('BaclooCrmBundle:Locations')
//                                        ->findOneById($codelocations);
//                                    $resaloc->setEtatloc('Réservé');
//                                    $resaloc->setCodemachineinterne($code);
//                                    $resaloc->setEnergie($energie);
//                                    $resaloc->setMachineid($machineid);
//                                    $em->persist($resaloc);
//                                    $em->flush();

//                                    if ($etat == 'Disponible')
//                                    {
//                                        $today = date('Y-m-d');
//                                        $diff = abs(strtotime($debutloc) - strtotime($today));
//                                        $nbjrsdiff = $diff / 86400;
//
//                                        $machine = $em->getRepository('BaclooCrmBundle:Machines')
//                                            ->findOneByCode(array('code' => $code, 'etat' => 'Disponible'));
//                                        if ($nbjrsdiff < 2) {
//                                            $machine->setDebutloc($debutloc);
//                                            $machine->setFinloc($finloc);
//                                            $machine->setEtat('Réservé');
//                                            $machine->setEntreprise($entreprise);
//                                            $machine->setNomchantier($nomchantier);
//                                            $machine->setcodelocations($codelocations);
//                                            $machine->setcodecontrat($locid);
//                                            $machine->setClientid($ficheid);
//                                            $em->persist($machine);
//                                            $em->flush();
//                                        } else {
//                                            $copymachine = clone $machine;
//                                            $copymachine->setDebutloc($debutloc);
//                                            $copymachine->setFinloc($finloc);
//                                            $copymachine->setEtat('Réservé');
//                                            $copymachine->setEntreprise($entreprise);
//                                            $copymachine->setNomchantier($nomchantier);
//                                            $copymachine->setcodelocations($codelocations);
//                                            $copymachine->setcodecontrat($locid);
//                                            $copymachine->setClientid($ficheid);
//                                            $copymachine->setOriginal(0);
//                                            $em->persist($copymachine);
//                                            $em->flush();
//
//                                            $resaloc->setMachineid($copymachine->getId());
//                                            $em->persist($resaloc);
//                                            $em->flush();
//                                        }
//                                    }
//                                    elseif ($etat == 'En location')
//                                    {
//                                        $machine = $em->getRepository('BaclooCrmBundle:Machines')
//                                            ->findOneBy(array('code' => $code, 'original' => 1));
//
//                                        $machinecheck = $em->getRepository('BaclooCrmBundle:Machines')
//                                            ->findOneBy(array('code' => $code, 'codelocations' => $codelocations, 'original' => 0));
//
//                                        if (!isset($machinecheck)) {
//                                            echo 'clone2';
//                                            $copymachine = clone $machine;
//                                            $copymachine->setDebutloc($debutloc);
//                                            $copymachine->setFinloc($finloc);
//                                            $copymachine->setEtat('Réservé');
//                                            $copymachine->setEntreprise($entreprise);
//                                            $copymachine->setNomchantier($nomchantier);
//                                            $copymachine->setcodelocations($codelocations);
//                                            $copymachine->setcodecontrat($locid);
//                                            $copymachine->setClientid($ficheid);
//                                            $copymachine->setOriginal(0);
//                                            $em->persist($copymachine);
//                                            $em->flush();
//                                            echo 'MACHINE COPIE';
//                                            echo $copymachine->getId();
//
//                                            $resaloc->setMachineid($copymachine->getId());
//                                            $em->persist($resaloc);
//                                            $em->flush();
//                                        }
//                                    }
//                                    elseif ($etat == 'Réservé')
//                                    {
//                                        $machine = $em->getRepository('BaclooCrmBundle:Machines')
//                                            ->findOneByCodelocations($codelocations);
//                                        if (isset($machine)) {
//                                            $machine->setDebutloc($debutloc);
//                                            $machine->setFinloc($finloc);
//                                            $machine->setNomchantier($nomchantier);
//                                            $em->persist($machine);
//                                            $em->flush();
//                                        } else {
//                                            $machine = $em->getRepository('BaclooCrmBundle:Machines')
//                                                ->findOneByCode(array('code' => $code));
//
//                                            $copymachine = clone $machine;
//                                            $copymachine->setDebutloc($debutloc);
//                                            $copymachine->setFinloc($finloc);
//                                            $copymachine->setEtat('Réservé');
//                                            $copymachine->setEntreprise($entreprise);
//                                            $copymachine->setNomchantier($nomchantier);
//                                            $copymachine->setcodelocations($codelocations);
//                                            $copymachine->setcodecontrat($locid);
//                                            $copymachine->setClientid($ficheid);
//                                            $copymachine->setOriginal(0);
//                                            $em->persist($copymachine);
//                                            $em->flush();
//
//                                            $resaloc->setMachineid($copymachine->getId());
//                                            $em->persist($resaloc);
//                                            $em->flush();
//                                        }
//
//                                    }
                                    //Faire un if pour le cas d'un refus de l'offre alors qu'un BDC a été émis
                                    //Il faut donc supprimer la machine réservée en fonction du codelocation et du code origine
                                    if (isset($refusee) && $refusee == 1) {
                                        $machine = $em->getRepository('BaclooCrmBundle:Machines')
                                            ->findOneBy(array('code' => $code, 'codelocations' => $codelocations));
                                        //Si machine originale on fait un update
                                        if (isset($machine)) {
                                            if ($machine->getOriginal() == 1) {
                                                $machine->setCodelocations(NULL);
                                                $machine->setCodecontrat(NULL);
                                                $machine->setClientid($ficheid);
                                                $machine->setEntreprise(NULL);
                                                $machine->setNomchantier(NULL);
                                                $machine->setDebutloc(NULL);
                                                $machine->setFinloc(NULL);
                                                $machine->setEtat('Disponible');
                                                $em->persist($machine);
                                                $em->flush();
                                            } else {
                                                $em->remove($machine);
                                                $em->flush();
                                            }
                                        }
                                        $refusloc = $em->getRepository('BaclooCrmBundle:Locations')
                                            ->findOneById($codelocations);
                                        $refusloc->setEtatloc('Refusé');
                                        $refusloc->setEtatlog('Refusé');
                                        $locata->setContrat(0);
                                        $em->persist($refusloc);
                                        $em->flush();

                                    }
                                }
                            }
                        }
                        //Partie sous-locations
                        $nbdemachines = 0;
                        $nbdemachinesreservees = 0;
                    }

                    if ($contrat == 1 && $offreencours == 1)
                    {
//                         echo 'contrat ok offre ok';
                        $locata = $em->getRepository('BaclooCrmBundle:Locata')
                            ->findOneById($locata->getId());
//                            $totalht = 0;
                        $montantcarb = 0;
                        $contributionverte = 0;
                        if (null !== $locata->getLocations()) {
                            echo 'xxx';
                            echo $loc->getId() . '-';
                            echo $nbjloc;
                            echo 'xxx';

                            //Partie locations parc
                            foreach ($locata->getLocations() as $loc) {
                                $jour50 = $loc->getJour50();
                                $jour100 = $loc->getJour100();
                                if ($loc->getEtatloc() != 'Location terminée')
                                {
                                    //Insertion du code location à la machine
                                    $codelocations = $loc->getId();//echo $codelocations;
                                    $debutloc = $loc->getDebutloc();
                                    $finloc = $loc->getFinloc();
                                    // echo $codelocationssl;
                                    //On vérifie si une becane est déjà réservée sur cet ecode
                                    $locations = $em->getRepository('BaclooCrmBundle:Locations')
                                        ->findOneById($codelocations);
                                    if (null === $locations->getCodemachineinterne() && isset($locations))
                                    {
//                                        echo 'il est null';
//                                        $debutlocok = date('Y-m-d', strtotime($debutloc . ' -1 day'));
//                                        $finlocok = date('Y-m-d', strtotime($finloc . ' +1 day'));
//                                        $machin = $em->getRepository('BaclooCrmBundle:Machines')
//                                            ->unedispo($loc->getCodemachine(), $debutlocok, $finlocok);
//                                        if (!empty($machin)) {
//                                            foreach ($machin as $mach) {
//                                                $code = $mach['code'];
//                                                $etat = $mach['etat'];
//                                                $energie = $mach['energie'];
//                                                $machineid = $mach['id'];
//                                                $machinedef = $em->getRepository('BaclooCrmBundle:Machines')
//                                                    ->dispoprecisenot($loc->getCodemachine(), $debutlocok, $finlocok);
//
//                                                if ($etat == 'Disponible') {
//                                                    break;
//                                                }
//                                            }
//                                            if (empty($code)) {
//                                                foreach ($machin as $mach) {
//                                                    $code = $mach['code'];
//                                                    $etat = $mach['etat'];
//                                                    $energie = $mach['energie'];
//                                                    $machineid = $mach['id'];
//                                                    $machinedef = $em->getRepository('BaclooCrmBundle:Machines')
//                                                        ->dispoprecisenot($code, $debutlocok, $finlocok);
//
//                                                    if (empty($machinedef)) {
//                                                        break;
//                                                    }
//                                                }
//                                            }
//                                            if (!empty($code)) {
//                                                echo 'boucle2';
//                                                // foreach($machin as $mach)
//                                                // {echo 'les différents coces'.$mach['code'];
//                                                // $code = $mach['code'];
//                                                // $etat = $mach['etat'];
//                                                // $energie = $mach['energie'];
//                                                // $machineid = $mach['id'];
//                                                // $machinedef = $em->getRepository('BaclooCrmBundle:Machines')
//                                                // ->dispoprecisenot($code, $debutlocok, $finlocok);
//
//                                                // if(!empty($machinedef))
//                                                // {
//                                                // $machinedefresa = $em->getRepository('BaclooCrmBundle:Machines')
//                                                // ->dispopreciseresa($code, $debutlocok, $finlocok);
//                                                // if(empty($machinedefresa))
//                                                // {
//                                                // break;
//                                                // }
//                                                // }
//                                                // else
//                                                // {
//                                                // echo 'machinedef est vide';
//                                                // break;
//                                                // }
//                                                // }
//                                            }
//                                            echo 'code1' . $code;
//
//                                            //MAJ table Locations suite réservation
//                                            $resaloc = $em->getRepository('BaclooCrmBundle:Locations')
//                                                ->findOneById($codelocations);
//                                            $resaloc->setEtatloc('Réservé');
//                                            $resaloc->setCodemachineinterne($code);
//                                            $resaloc->setEnergie($energie);
//                                            $resaloc->setMachineid($machineid);
//                                            $em->persist($resaloc);
//                                            $em->flush();
//
//                                            if ($etat == 'Disponible')
//                                            {//echo 'dispo';exit();
//                                                $today = date('Y-m-d');
//                                                $diff = strtotime($debutloc) - strtotime($today);
//                                                $nbjrsdiff = $diff / 86400;
//
//                                                $machine = $em->getRepository('BaclooCrmBundle:Machines')
//                                                    ->findOneBy(array('code' => $code, 'etat' => 'Disponible'));
//
//                                                $machine2 = $em->getRepository('BaclooCrmBundle:Machines')
//                                                    ->findOneBy(array('code' => $code, 'codelocations' => $codelocations));
//                                                echo '<br>nbjrdiff' . $nbjrsdiff;
//                                                if ($nbjrsdiff > 0 and $nbjrsdiff < 2) {
//                                                    $machine->setDebutloc($debutloc);
//                                                    $machine->setFinloc($finloc);
//                                                    $machine->setEtat('Réservé');
//                                                    $machine->setEntreprise($entreprise);
//                                                    $machine->setNomchantier($nomchantier);
//                                                    $machine->setcodelocations($codelocations);
//                                                    $machine->setcodecontrat($locid);
//                                                    $machine->setClientid($ficheid);
//                                                    $em->persist($machine);
//                                                    $em->flush();
////                                                } elseif ($nbjrsdiff <= 0) {echo 'x0j';
////                                                    $machine->setDebutloc($debutloc);
////                                                    $machine->setFinloc($finloc);
////                                                    $machine->setEtat('En location');
////                                                    $machine->setEntreprise($entreprise);
////                                                    $machine->setNomchantier($nomchantier);
////                                                    $machine->setcodelocations($codelocations);
////                                                    $machine->setcodecontrat($locid);
////                                                    $machine->setClientid($ficheid);
////                                                    $em->persist($machine);
////                                                    $em->flush();
//                                                } elseif (empty($machine2)) {
//                                                    echo 'clone4';
//                                                    $copymachine = clone $machine;
//                                                    $copymachine->setDebutloc($debutloc);
//                                                    $copymachine->setFinloc($finloc);
//                                                    $copymachine->setEtat('Réservé');
//                                                    $copymachine->setEntreprise($entreprise);
//                                                    $copymachine->setNomchantier($nomchantier);
//                                                    $copymachine->setcodelocations($codelocations);
//                                                    $copymachine->setcodecontrat($locid);
//                                                    $copymachine->setClientid($ficheid);
//                                                    $copymachine->setOriginal(0);
//                                                    $em->persist($copymachine);
//                                                    $em->flush();
//
//                                                    $resaloc->setMachineid($copymachine->getId());
//                                                    $em->persist($resaloc);
//                                                    $em->flush();
//                                                }
//                                            }
//                                            elseif ($etat == 'En location')
//                                            {
//                                                //echo 'EN lOC';exit();
//                                                $machine = $em->getRepository('BaclooCrmBundle:Machines')
//                                                    ->findOneBy(array('code' => $code, 'original' => 1));
//
//                                                $machinecheck = $em->getRepository('BaclooCrmBundle:Machines')
//                                                    ->findOneBy(array('code' => $code, 'codelocations' => $codelocations, 'original' => 0));
//
//                                                if (!isset($machinecheck)) {
//                                                    echo 'clone5';
//                                                    $copymachine = clone $machine;
//                                                    $copymachine->setDebutloc($debutloc);
//                                                    $copymachine->setFinloc($finloc);
//                                                    $copymachine->setEtat('Réservé');
//                                                    $copymachine->setEntreprise($entreprise);
//                                                    $copymachine->setNomchantier($nomchantier);
//                                                    $copymachine->setcodelocations($codelocations);
//                                                    $copymachine->setcodecontrat($locid);
//                                                    $copymachine->setClientid($ficheid);
//                                                    $copymachine->setOriginal(0);
//                                                    $em->persist($copymachine);
//                                                    $em->flush();
//                                                    echo 'MACHINE COPIE';
//                                                    echo $copymachine->getId();
//
//                                                    $resaloc->setMachineid($copymachine->getId());
//                                                    $em->persist($resaloc);
//                                                    $em->flush();
//                                                }
//                                            }
//                                            elseif ($etat == 'Réservé')
//                                            {//echo 'reserve';exit();
//                                                echo 'RESERVE';
//                                                $machine = $em->getRepository('BaclooCrmBundle:Machines')
//                                                    ->findOneByCodelocations($codelocations);
//                                                if (isset($machine)) {
//                                                    $machine->setDebutloc($debutloc);
//                                                    $machine->setFinloc($finloc);
//                                                    $machine->setNomchantier($nomchantier);
//                                                    $em->persist($machine);
//                                                    $em->flush();
//                                                } else {
//                                                    echo 'clone6';
//                                                    $machine = $em->getRepository('BaclooCrmBundle:Machines')
//                                                        ->findOneByCode(array('code' => $code));
//
//                                                    $copymachine = clone $machine;
//                                                    $copymachine->setDebutloc($debutloc);
//                                                    $copymachine->setFinloc($finloc);
//                                                    $copymachine->setEtat('Réservé');
//                                                    $copymachine->setEntreprise($entreprise);
//                                                    $copymachine->setNomchantier($nomchantier);
//                                                    $copymachine->setcodelocations($codelocations);
//                                                    $copymachine->setcodecontrat($locid);
//                                                    $copymachine->setClientid($ficheid);
//                                                    $copymachine->setOriginal(0);
//                                                    $em->persist($copymachine);
//                                                    $em->flush();
//
//                                                    $resaloc->setMachineid($copymachine->getId());
//                                                    $em->persist($resaloc);
//                                                    $em->flush();
//                                                }
//
//                                            }
//                                            else
//                                            {
//                                                $machine = $em->getRepository('BaclooCrmBundle:Machines')
//                                                    ->findOneBy(array('code' => $code, 'original' => 1));
//
//                                                $machinecheck = $em->getRepository('BaclooCrmBundle:Machines')
//                                                    ->findOneBy(array('code' => $code, 'codelocations' => $codelocations, 'original' => 0));
//
//                                                if (!isset($machinecheck)) {
//                                                    echo 'clone5';
//                                                    $copymachine = clone $machine;
//                                                    $copymachine->setDebutloc($debutloc);
//                                                    $copymachine->setFinloc($finloc);
//                                                    $copymachine->setEtat('Réservé');
//                                                    $copymachine->setEntreprise($entreprise);
//                                                    $copymachine->setNomchantier($nomchantier);
//                                                    $copymachine->setcodelocations($codelocations);
//                                                    $copymachine->setcodecontrat($locid);
//                                                    $copymachine->setClientid($ficheid);
//                                                    $copymachine->setOriginal(0);
//                                                    $em->persist($copymachine);
//                                                    $em->flush();
//                                                    echo 'MACHINE COPIE';
//                                                    echo $copymachine->getId();
//
//                                                    $resaloc->setMachineid($copymachine->getId());
//                                                    $em->persist($resaloc);
//                                                    $em->flush();
//                                                }
//                                            }
//                                            //Faire un if pour le cas d'un refus de l'offre alors qu'un BDC a été émis
//                                            //Il faut donc supprimer la machine réservée en fonction du codelocation et du code origine
//                                            if (isset($refusee) && $refusee == 1) {
//                                                $machine = $em->getRepository('BaclooCrmBundle:Machines')
//                                                    ->findOneBy(array('code' => $code, 'codelocations' => $codelocations));
//                                                //Si machine originale on fait un update
//                                                if ($machine->getOriginal() == 1) {
//                                                    $machine->setCodelocations(NULL);
//                                                    $machine->setCodecontrat(NULL);
//                                                    $machine->setClientid($ficheid);
//                                                    $machine->setEntreprise(NULL);
//                                                    $machine->setNomchantier(NULL);
//                                                    $machine->setDebutloc(NULL);
//                                                    $machine->setFinloc(NULL);
//                                                    $machine->setEtat('Disponible');
//                                                    $machine->setEtatlog('');
//                                                    $em->persist($machine);
//                                                    $em->flush();
//                                                } else {
//                                                    $em->remove($machine);
//                                                    $em->flush();
//                                                }
//                                                $refusloc = $em->getRepository('BaclooCrmBundle:Locations')
//                                                    ->findOneById($codelocations);
//                                                $refusloc->setEtatloc('Refusé');
//                                                $refusloc->setEtatlog('Refusé');
//                                                $em->persist($refusloc);
//                                                $em->flush();
//
//                                            }
//                                        }
                                        $erreur = 11;
                                        $locata->setContrat(0);
                                    }
                                    else
                                    {
                                        if($loc->getLocdirect() == 1 and ($loc->getEtatloc() == '' or null === $loc->getEtatloc()))
                                        {
                                            $machine = $em->getRepository('BaclooCrmBundle:Machines')
                                                ->findOneBy(array('code' => $loc->getCodemachineinterne(), 'original' => 1));
                                            if(isset($machine))
                                            {
                                                //maj location
                                                $loc->setEtatloc('En location');
                                                $loc->setEtatlog('Livré chez le client');
                                                $em->persist($loc);

                                                //maj machine
                                                $machine->setEtat('En location');
                                                $machine->setEtatlog('Livré chez le client');
                                                $machine->setDebutloc($loc->getDebutloc());
                                                $machine->setFinloc($loc->getFinloc());
                                                $machine->setEntreprise($locata->getClient());
                                                $machine->setNomchantier($locata->getNomchantier());
                                                $machine->setcodelocations($loc->getId());
                                                $machine->setcodecontrat($locata->getId());
                                                $machine->setClientid($locata->getClientid());
                                                $em->persist($machine);

                                                $em->flush();//die('iciciiiii');
                                            }
                                        }
                                        else
                                        {
                                            $machine = $em->getRepository('BaclooCrmBundle:Machines')
                                                ->findOneByCodelocations($codelocations);
                                            echo 'il est pas null le code machine';
                                            if ($loc->getEtatloc() == 'Refusé')
                                            {
                                                $loc->setEtatloc('En location');//echo 'enloczzzzz';exit();
                                            }
                                            elseif($loc->getEtatloc() == '' and $erreur == 'planning' )
                                            {
                                                $loc->setEtatloc('Réservé');
//                                            if(isset($machine)){$machine->setEtat('Prêt au départ');}
                                            }
//                                        elseif($loc->getEtatloc() == 'Prêt au départ' )
//                                        {
//                                            if(!isset($machine))//Mise à jour de la machine
//                                            {
//                                                $machine = $em->getRepository('BaclooCrmBundle:Machines')
//                                                    ->findOneByCode($codelocations);
//                                                $machine->setDebutloc($loc->getDebutloc());
//                                                $machine->setFinloc($loc->getFinloc());
//                                                $machine->setEtat('Prêt au départ');
//                                                $machine->setEntreprise($locata->getClient());
//                                                $machine->setNomchantier($locata->getNomchantier());
//                                                $machine->setcodelocations($loc->getId());
//                                                $machine->setcodecontrat($locata->getId());
//                                                $machine->setClientid($locata->getClientid());
//                                                $em->persist($machine);
//                                                $em->flush();
//                                            }
//
//                                            $loc->setEtatloc('Prêt au départ');
//                                            if(isset($machine)){$machine->setEtat('Prêt au départ');}
//                                        }
                                            if(isset($machine))
                                            {
                                                $machine2 = $em->getRepository('BaclooCrmBundle:Machines')
                                                    ->findBy(array('code' => $loc->getCodemachineinterne(), 'etat' => 'Réservé'));
                                                if (isset($machine2)) {
                                                    foreach ($machine2 as $macha) {
                                                        if (isset($macha) && strtotime($macha->getDebutloc()) <= strtotime($loc->getFinloc()) && $macha->getEntreprise() != $loc->getEntreprise()) {
                                                            return $this->redirect($this->generateUrl('bacloocrm_ajouterlocation', array('ficheid' => $ficheid, 'locid' => $locid, 'erreur' => 6)));
                                                        }
                                                    }
                                                } else {
                                                    $machine->setDebutloc($loc->getDebutloc());
                                                    $machine->setFinloc($loc->getFinloc());
                                                    $em->persist($machine);
                                                    $em->flush();
                                                }
                                            }
                                            else
                                            {
                                                $machine = $em->getRepository('BaclooCrmBundle:Machines')
                                                    ->findOneByCode($loc->getCodemachineinterne());
                                                if ($machine->getEtat() == 'Disponible') {
                                                    $machine->setDebutloc($debutloc);
                                                    $machine->setFinloc($finloc);
                                                    $machine->setEtat('En location');
                                                    $machine->setEtatlog('Livré chez le client');
                                                    $machine->setEntreprise($entreprise);
                                                    $machine->setNomchantier($nomchantier);
                                                    $machine->setcodelocations($codelocations);
                                                    $machine->setcodecontrat($locid);
                                                    $machine->setClientid($ficheid);
                                                    $em->persist($machine);
                                                    $em->flush();
                                                }
                                            }

                                        }
                                    }
                                }
                                else //Location terminée
                                {
                                    //Insertion du code location à la machine
                                    $codelocations = $loc->getId();
                                    $debutloc = $loc->getDebutloc();
                                    $finloc = $loc->getFinloc();
                                    $machine = $em->getRepository('BaclooCrmBundle:Machines')
                                        ->findOneByCodelocations($codelocations);
                                    if (isset($machine)) {
                                        $machine->setDebutloc($debutloc);
                                        $machine->setFinloc($finloc);
                                        $em->persist($machine);
                                    }
                                }
                                $montantlocactu = 0;
                                //                                $nbjlocadeduire = 0;
                                //On récupère le loyer
                                if (null !== $loc->getLoyerp1()) {
                                    $loyer = $loc->getLoyerp1();
                                } elseif (null !== $loc->getLoyerp2()) {
                                    $loyer = $loc->getLoyerp2();
                                } elseif (null !== $loc->getLoyerp3()) {
                                    $loyer = $loc->getLoyerp3();
                                } elseif (null !== $loc->getLoyerp4()) {
                                    $loyer = $loc->getLoyerp4();
                                } elseif (null !== $loc->getLoyermensuel()) {
                                    //                                    $nbjloc = $loc->getNbjloc();
                                    //                                    include('calculnbjlocmensuelle.php');
                                    $loyer = $loc->getLoyermensuel() / 20;
                                }
                                if ($jour50 != 0) {
                                    //                                    $nbjlocadeduire += $jour50 * 0.5;//nb jours corrigé
                                }
                                if ($jour100 != 0) {
                                    //                                    $nbjlocadeduire += $jour100;//nb jours corrigé
                                }//if($loc->getcodemachineinterne() == 'C12EJ6'){echo 'loyer'.$nbjloc;exit();}
                                $nbjloc = $loc->getNbjloc();
                                $montantlocactu = $loyer * ($nbjloc - $nbjlocadeduire);
                                $montantcarb += $loc->getMontantcarb();
                                //$loc->setMontantloc($montantlocactu);
                                $loc->setCloture(0);
                                // $loc->setNbjloc($nbjloc - $nbjlocadeduire);
                                $em->persist($loc);
                                $em->flush();
                                //                                $nbjloc += $nbjlocadeduire;
                                //                                $nbjlocass += $nbjlocadeduire;
                                //$totalht += $nbjloc * $loyer;

                                if ($loc->getContributionverte() == 1) {
                                    $contributionverte += 0.0215 * $loyer * $nbjloc;

                                }
                                $bondepart= $em->getRepository('BaclooCrmBundle:Bondepart')
                                    ->findOneByCodelocation($loc->getId());
                                $machine = $em->getRepository('BaclooCrmBundle:Machines')
                                    ->findOneById($loc->getMachineid());
                                if(isset($bondepart))
                                {
                                    $bondepart->setEcode($loc->getCodemachineinterne());
                                    $bondepart->setDescription($loc->getTypemachine());
                                    $em->persist($bondepart);
                                    $em->flush();
                                }
                            }
                        }
                        //Partie sous-locations

                        if (null !== $locata->getLocationssl()) {
                            echo 'YYY';
                            echo $locata->getId() . '-';
                            echo $nbjloc;
                            echo 'xxx';
                            $nbdemachines = 0;
                            $nbdemachinesreservees = 0;

                            foreach ($locata->getLocationssl() as $loc) {
                                if (null !== $loc->getCodemachine()) {
                                    $nbdemachines++;
                                }
                                if (null !== $loc->getCodemachineinterne()) {
                                    $nbdemachinesreservees++;
                                }
                            }

                            $nbmachinesdispo = 0;
                            foreach ($locata->getLocationssl() as $loc) {
                                //Insertion du code location à la machine
                                $codelocations = $loc->getId();
                                // echo $codelocations;
                                $machineasuppr = $em->getRepository('BaclooCrmBundle:Machinessl')
                                    ->findByCodelocations($loc->getId());
                                foreach($machineasuppr as $machin)
                                {
                                    $machin->setCodelocations('');
                                    $machin->setCodecontrat('');
                                    $machin->setClientid(0);
                                    $machin->setEntreprise('');
                                    $machin->setNomchantier('');
                                    $machin->setDebutloc('');
                                    $machin->setFinloc('');
                                    $machin->setEtat('Disponible');
                                    $em->persist($machin);
                                }

                                $machine = $em->getRepository('BaclooCrmBundle:Machinessl')
                                    ->findOneBy(array('codegenerique' => $loc->getCodemachine(), 'loueur' => $loc->getLoueur()));

                                // On crée un objet Locatasl
                                if (!empty($machine)) {
                                    $nbmachinesdispo++;
                                }
                            }
                            echo 'XXXXXXXXXXXXXX';
                            echo 'nbdemachines' . $nbdemachines;
                            echo 'nbmachinesdispo' . $nbmachinesdispo;
                            echo 'nbdemachinesreservees' . $nbdemachinesreservees;
                            echo '**';echo 'laaa';


                            //Partie locations parc
                            $machineok = 0;
                            foreach ($locata->getLocationssl() as $loc) {
                                $jour50 = $loc->getJour50();
                                $jour100 = $loc->getJour100();
                                if(null === $loc->getCodemachineinterne())
                                {
                                    $machineok = 1;
                                }

                                $machine = $em->getRepository('BaclooCrmBundle:Machinessl')
                                    ->findOneBy(array('id' => $loc->getMachineid(), 'codelocations' => $loc->getId()));
                                if (!isset($machine) && empty($machine) && $loc->getEtatloc() != 'Location terminée') {
                                    $machine = new Machinessl;
                                }

                                if($loc->getEtatloc() != 'Location terminée')
                                {

                                    $machine->setCode($loc->getCodemachineinterne());
                                    $machine->setCodegenerique($loc->getCodemachine());
                                    $machine->setDescription($loc->getTypemachine());
                                    $machine->setDebutloc($loc->getDebutloc());
                                    $machine->setFinloc($loc->getFinloc());
                                    if($loc->getEtatloc() == '')
                                    {
                                        if($loc->getTransport() == 1 && $loc->getEtatloc() != 'En location')
                                        {
                                            $machine->setEtat('Prêt au départ');
                                            $loc->setEtatloc('Prêt au départ');
                                        }
                                        else
                                        {
                                            $machine->setEtat('En location');
                                            $loc->setEtatloc('En location');//echo 'enlocx';exit();
                                        }
                                    }
                                    $machine->setEtat($loc->getEtatloc());
                                    $machine->setEntreprise($locata->getClient());
                                    $machine->setNomchantier($locata->getNomchantier());
                                    $machine->setcodelocations($loc->getId());
                                    $machine->setcodecontrat($locata->getId());
                                    $machine->setClientid($locata->getClientid());
                                    $machine->setLoueur($loc->getLoueur());
                                    $machine->setOriginal(1);

                                    $em->persist($machine);
                                    $em->flush();

                                    $loc->setMachineid($machine->getId());
                                }
//                                        $loc->setEtatloc('');
                                $em->persist($loc);
                                $em->flush();


                                $machine = $em->getRepository('BaclooCrmBundle:Machinessl')
                                    ->findOneById($loc->getMachineid());
                                if ($machineok == 1) {
                                    $locata->setContrat(0);
//                                        $locata->setBdcrecu(0);
                                    $em->persist($locata);
                                    $em->flush();
                                    return $this->redirect($this->generateUrl('bacloocrm_ajouterlocation', array('ficheid' => $ficheid, 'locid' => $locid, 'erreur' => 1)));
                                }
                                //Faire un if pour le cas d'un refus de l'offre alors qu'un BDC a été émis
                                //Il faut donc supprimer la machine réservée en fonction du codelocation et du code origine
                                if (isset($refusee) && $refusee == 1) {
                                    $machine = $em->getRepository('BaclooCrmBundle:Machinessl')
                                        ->findOneBy(array('code' => $loc->getCodemachineinterne(), 'codelocations' => $loc->getId()));
                                    //Si machine originale on fait un update
                                    $em->remove($machine);
                                    $locata->setContrat(0);
                                    $refusloc = $em->getRepository('BaclooCrmBundle:Locationssl')
                                        ->findOneById($codelocations);
                                    $refusloc->setEtatloc('Refusé');
                                    $refusloc->setEtatlog('Refusé');
                                    $em->persist($refusloc);
                                    $em->flush();
                                }

                                $montantlocactu = 0;
                                //                                    $nbjlocadeduire = 0;
                                //On récupère le loyer
                                if (null !== $loc->getLoyerp1()) {
                                    $loyer = $loc->getLoyerp1();
                                } elseif (null !== $loc->getLoyerp2()) {
                                    $loyer = $loc->getLoyerp2();
                                } elseif (null !== $loc->getLoyerp3()) {
                                    $loyer = $loc->getLoyerp3();
                                } elseif (null !== $loc->getLoyerp4()) {
                                    $loyer = $loc->getLoyerp4();
                                } elseif (null !== $loc->getLoyermensuel()) {
                                    //                                        $nbjloc = $loc->getNbjloc();
                                    //                                        include('calculnbjlocmensuelle.php');
                                    $loyer = $loc->getLoyermensuel() / 20;
                                }
                                if ($jour50 != 0) {
                                    //                                        $nbjlocadeduire += $jour50 * 0.5;//nb jours corrigé
                                }
                                if ($jour100 != 0) {
                                    //                                        $nbjlocadeduire += $jour100;//nb jours corrigé
                                }
                                //                                    $nbjloc = $loc->getNbjloc();
                                $montantlocactu = $loyer * ($nbjloc + $nbjlocadeduire);
                                $montantcarb += $loc->getMontantcarb();
                                //                            $loc->setMontantloc($montantlocactu);
                                $loc->setCloture(0);
                                // $loc->setNbjloc($nbjloc + $nbjlocadeduire);
                                $em->persist($loc);
                                $em->flush();
                                //                                    $nbjloc += $nbjlocadeduire;
                                //                                    $nbjlocass += $nbjlocadeduire;
                                //$totalht += $nbjloc * $loyer;

                                if ($loc->getContributionverte() == 1) {
                                    $contributionverte += 0.0215 * $loyer * $nbjloc;
                                }
                            }
                            echo $locata->getId();
                            echo 'iioiioiiiio';
                            $montantloclocatafrs = 0;
                            foreach ($locata->getLocationssl() as $loc) {
                                echo 'pppppppppppppppppppppppp';
                                echo $loc->getId();
                                //Insertion du code location à la machine
                                $codelocationssl = $loc->getId();
                                // echo $codelocationssl;
                                echo $loc->getCodemachineinterne();
                                if ($loc->getEtatlog() == 'Livré chez le client' or $loc->getEtatlog() == 'Déposé en agence') {
                                } else {
                                    $machine = $em->getRepository('BaclooCrmBundle:Machinessl')
                                        ->findOneById($loc->getMachineid());
                                    if (!isset($machine)) {
                                        $locata->setContrat(0);
                                        $locata->setBdcrecu(0);
                                        $em->persist($locata);
                                        $em->flush();
                                        return $this->redirect($this->generateUrl('bacloocrm_ajouterlocation', array('ficheid' => $ficheid, 'locid' => $locid, 'erreur' => 1)));
                                    }
                                    //								$machine->setDebutloc($loc->getDebutloc());
                                    //								$machine->setFinloc($loc->getFinloc());
                                    //								$machine->setEtat('En location');
                                    //								$machine->setEntreprise($entreprise);
                                    //								$machine->setNomchantier($nomchantier);
                                    //								$machine->setCodelocations($codelocationssl);
                                    //								$machine->setCodecontrat($locid);
                                    //								$machine->setClientid($ficheid);
                                    //								$em->persist($machine);

                                    if ($loc->getTransport() == 1 && $loc->getEtatloc() !== 'En location' && $loc->getEtatloc() !== 'Location terminée' && $loc->getEtatloc() !== 'Retour planifié') {
                                        //echo '<br>transpor';exit();
                                        $loc->setEtatloc('Prêt au départ');
                                        $loc->setEtatlog('Prêt au départ');
                                        $machine->setEtat('Prêt au départ');
                                        $machine->setEtatlog('Prêt au départ');
                                    } elseif (($loc->getEtatloc() == 'En location' or empty($loc->getEtatloc())) && $loc->getTransport() == 1 && strtotime($loc->getDebutloc()) > strtotime(date('Y-m-d'))) {
                                        //echo '<br>enloc1';exit();
                                        $loc->setEtatloc('Prêt au départ');
                                        $loc->setEtatlog('Prêt au départ');
                                        $machine->setEtat('Prêt au départ');
                                        $machine->setEtatlog('Prêt au départ');

                                    } elseif (($loc->getEtatloc() == 'En location' or empty($loc->getEtatloc())) && $loc->getTransport() != 1) {
                                        //echo '<br>enloc2';exit();
                                        $loc->setEtatloc('En location');
                                        $loc->setEtatlog('Livré chez le client');
                                        $machine->setEtat('En location');
                                        $machine->setEtatlog('Livré chez le client');
                                    }
                                    // elseif($loc->getEtatloc('Location terminée')
                                    // {
                                    // $loc->setEtatloc('En location');
                                    // $loc->setEtatlog('Livré chez le client');
                                    // $machine->setEtat('En location');
                                    // $machine->setEtatlog('Livré chez le client');
                                    // }


                                }
                                // $em->persist($loc);
                                // $em->flush();
                                $montantlocactu = 0;
                                //                                $nbjlocadeduire = 0;
                                //On récupère le loyer
                                if (null !== $loc->getLoyerp1()) {
                                    $loyer = $loc->getLoyerp1();
                                } elseif (null !== $loc->getLoyerp2()) {
                                    $loyer = $loc->getLoyerp2();
                                } elseif (null !== $loc->getLoyerp3()) {
                                    $loyer = $loc->getLoyerp3();
                                } elseif (null !== $loc->getLoyerp4()) {
                                    $loyer = $loc->getLoyerp4();
                                } elseif (null !== $loc->getLoyermensuel()) {
                                    $nbjloc = $loc->getNbjloc();
                                    include('calculnbjlocmensuelle.php');
                                    $loyer = $loc->getLoyermensuel() / 20;

                                }
                                if ($jour50 != 0) {
                                    $nbjlocadeduire += $jour50 * 0.5;//nb jours corrigé
                                }
                                if ($jour100 != 0) {
                                    $nbjlocadeduire += $jour100;//nb jours corrigé

                                }
                                $nbjloc = $loc->getNbjloc();    //??
                                $montantlocactu = $loyer * ($nbjloc + $nbjlocadeduire);
                                $montantcarb += $loc->getMontantcarb();
                                //$loc->setMontantloc($montantlocactu);
                                $loc->setCloture(0);
                                // $loc->setNbjloc($nbjloc + $nbjlocadeduire);
                                $em->persist($loc);
                                $em->flush();

                                //                                $nbjloc += $nbjlocadeduire;
                                //                                $nbjlocass += $nbjlocadeduire;
                                // $totalht += $nbjloc * $loyer;echo 'TOTALHT0'.$totalht;
                                // if($loc->getContributionverte() == 1)
                                // {
                                // $contributionverte += ($nbjlocass*$loyer)*0.0215;

                                // }

                                //GENERATION DES BDC AUTOMATIQUES

                                //On est dans contrat, on vérifie s'il s'agit d'une sous-location
                                if (null !== $loc->getDebutloc() && null !== $loc->getFinloc()) {
                                    echo '1 ';
                                    //Si c'est une sous-location, on vérifie qu'un bdc (locatafrs) n'a pas été créé pour cette sl.
                                    $bdc = $em->getRepository('BaclooCrmBundle:Locatafrs')
                                        ->trouverBdcauto($locata->getId(), $loc->getLoueurid());
//                                        ->findOneBy(array('codelocatasl' => $locata->getId(), 'fournisseur' => $loc->getLoueur()));

                                    //Si pas de Locatafrs, on créée un new
                                    if (!isset($bdc)) {
                                        echo '2 ';
                                        $bdcauto = new Locatafrs;
                                        $bdcauto->setDatecrea(date('Y-m-d'));
                                        $erreur = 4;
                                    } else {
                                        echo '3 ';
                                        //Si deja locatafrs, on appelle l'existant et on fait les updates nécessaires
                                        $bdcauto = $bdc;
                                        $erreur = 5;
                                    }
                                    $bdcauto->setChantierid($locata->getChantierid());
                                    $bdcauto->setNomchantier($locata->getNomchantier());
                                    $bdcauto->setAdresse1($locata->getAdresse1());
                                    $bdcauto->setAdresse2($locata->getAdresse2());
                                    $bdcauto->setAdresse3($locata->getAdresse3());
                                    $bdcauto->setCp($locata->getCp());
                                    $bdcauto->setVille($locata->getVille());
                                    $bdcauto->setFournisseurid($loc->getLoueurid());
                                    $bdcauto->setFournisseur($loc->getLoueur());
                                    $bdcauto->setUser($locata->getUser());
                                    //                            $bdcauto->setContact($locata->getContactchantier());
                                    $bdcauto->setDatemodif($locata->getDatemodif());
                                    if ($bdcauto->getAnnulee() == 1) {
                                    } else {
                                        $bdcauto->setAnnulee(0);
                                    }
                                    if ($bdcauto->getEtatbdc() == 1) {
                                    } else {
                                        $bdcauto->setEtatbdc(0);
                                    }
//                                        $bdcauto->setCommentaire($locata->getCommentaire());
                                    $bdcauto->setCodelocatasl($locata->getId());
                                    $bdcauto->setMode('recurrent');
                                    $em->persist($bdcauto);
                                    $em->flush();

                                    //On verifie si le bdcloc existe dejà
                                    $bdclocauto = $em->getRepository('BaclooCrmBundle:Locationsfrs')
                                        ->findOneByCodelocationsl($loc->getId());

                                    $newloc = 0;
                                    //Si existe pas on le créée
                                    if (!isset($bdclocauto)) {
                                        echo 'auto4 ';
                                        $bdclocauto = new Locationsfrs;
                                        $bdclocauto->addLocatafr($bdcauto);
                                        $bdcauto->addLocationsfr($bdclocauto);
                                        $bdclocauto->setCodelocationsl($loc->getId());
                                        $newloc = 1;
                                    }
                                    $bdclocauto->setCodeclient($locata->getClientid());
                                    $bdclocauto->setFournisseurid($loc->getLoueurid());
                                    $bdclocauto->setFournisseur($loc->getLoueur());
                                    $bdclocauto->setReference('location');
                                    $bdclocauto->setDebutloc($loc->getDebutloc());
                                    $bdclocauto->setFinloc($loc->getFinloc());
                                    $bdclocauto->setCodelocationsl($loc->getId());
                                    $bdclocauto->setMensuel(0);
                                    $bdclocauto->setDesignation($loc->getTypemachine());
                                    if ($newloc == 1)
                                    {
                                        $bdclocauto->setPu(0);
                                        $bdclocauto->setMontantht(0);
                                    }
                                    $bdclocauto->setQuantite($loc->getNbjloc());
                                    if ($bdclocauto->getPu() > 0 && $bdclocauto->getQuantite() > 0) {
                                        $bdclocauto->setMontantht($bdclocauto->getPu() * $loc->getNbjloc());
                                        $montantloclocatafrs += $bdclocauto->getPu() * $loc->getNbjloc();
                                    }
                                    $em->persist($bdclocauto);
                                    $em->flush();
                                }
                                $bdcauto->setMontantloc($montantloclocatafrs);//Montant HT de la sous-loc. déterminer plus bas
                                $em->persist($bdcauto);
                                $em->flush();
                                //FIN GENERATION DES BDC AUTOMATIQUES
                            }
                            foreach ($locata->getLocataventes() as $loca) {
                                $articles = $em->getRepository('BaclooCrmBundle:Articlesenvente')
                                    ->findOneBy(array('reffrs' => $loca->getRefarticle(), 'designation' => $loca->getDescription()));

                                if (!empty($articles) && $loca->getStockenr() == 1) {
                                    if ($articles->getStockenr() < $articles->getStocktheo() - $loca->getQuantite()) {
                                        $quantite = ($articles->getStocktheo() - $loca->getQuantite()) - $articles->getStockenr();
                                        $articles->setStocktheo($articles->getStocktheo() + $quantite);
                                        $articles->setStockreel($articles->getStockreel() + $quantite);
                                        $em->persist($articles);
                                        $em->flush();
                                        $em->clear();
                                        $articles = $em->getRepository('BaclooCrmBundle:Articlesenvente')
                                            ->findOneBy(array('reffrs' => $loca->getRefarticle(), 'designation' => $loca->getDescription()));
                                        $articles->setStockenr($articles->getStocktheo() - $loca->getQuantite());
                                    } elseif ($articles->getStockenr() > $articles->getStocktheo() - $loca->getQuantite()) {
                                        $quantite = $articles->getStockenr() - ($articles->getStocktheo() - $loca->getQuantite());
                                        $articles->setStocktheo($articles->getStocktheo() - $quantite);
                                        $articles->setStockreel($articles->getStockreel() - $quantite);
                                        $em->persist($articles);
                                        $em->flush();
                                        $em->clear();
                                        $articles = $em->getRepository('BaclooCrmBundle:Articlesenvente')
                                            ->findOneBy(array('reffrs' => $loca->getRefarticle(), 'designation' => $loca->getDescription()));
                                        $articles->setStockenr($articles->getStocktheo() - $loca->getQuantite());
                                    }
                                    $loca->setStock($articles->getStocktheo());
                                } else {
                                    if (isset($articles)) {
                                        $articles->setStockenr($articles->getStocktheo());
                                        $articles->setStocktheo($articles->getStocktheo() - $loca->getQuantite());
                                        $articles->setStockreel($articles->getStockreel() - $loca->getQuantite());
                                        $loca->setStockenr(1);
                                        $loca->setStock($articles->getStocktheo());
                                    }
                                }
                                if (isset($articles)) {
                                    if ($articles->getStockmini() > $articles->getStocktheo()) {
                                        $articles->setAlerte(1);
                                    } elseif ($articles->getStocktheo() > $articles->getStockmini()) {
                                        $articles->setAlerte(0);
                                    }
                                    $em->persist($articles);
                                    $em->flush();
                                }
                            }
                            echo 'TOTALHT' . $totalht;
                            //$locata->setMontantloc($totalht);
                            //$locata->setMontantcarb($montantcarb);
                            //$locata->setContributionverte($contributionverte);
                            $em->persist($locata);
                            $em->flush();
                        }
                        if (isset($refusee) && $refusee == 1 && $offreencours == 1)
                        {
                            foreach ($locata->getLocations() as $loc) {
                                //Insertion du code location à la machine
                                $codelocations = $loc->getId();
                                $debutloc = $loc->getDebutloc();
                                $finloc = $loc->getFinloc();
                                $code = $loc->getCodemachineinterne();
                                // echo $codelocations;

                                $machine = $em->getRepository('BaclooCrmBundle:Machines')
                                    ->findOneBy(array('code' => $code, 'codelocations' => $codelocations));
                                //Si machine originale on fait un update
                                if (isset($machine)) {
                                    if ($machine->getOriginal() == 1) {
                                        $machine->setCodelocations(NULL);
                                        $machine->setCodecontrat(NULL);
                                        $machine->setClientid(0);
                                        $machine->setEntreprise(NULL);
                                        $machine->setNomchantier(NULL);
                                        $machine->setDebutloc(NULL);
                                        $machine->setFinloc(NULL);
                                        $machine->setEtat('Disponible');
                                        $em->persist($machine);
                                        $em->flush();
                                    } else {
                                        $em->remove($machine);
                                        $em->flush();
                                    }
                                }
                                $refusloc = $em->getRepository('BaclooCrmBundle:Locations')
                                    ->findOneById($codelocations);
                                $refusloc->setEtatloc('Refusé');
                                $refusloc->setEtatlog('Refusé');
                                $locata->setContrat(0);
                                $em->persist($refusloc);
                                $em->flush();
                            }
                            foreach ($locata->getLocationssl() as $loc) {
                                //Insertion du code location à la machine
                                $codelocations = $loc->getId();
                                $debutloc = $loc->getDebutloc();
                                $finloc = $loc->getFinloc();
                                $code = $loc->getCodemachineinterne();
                                // echo $codelocations;

                                $machine = $em->getRepository('BaclooCrmBundle:Machinessl')
                                    ->findOneBy(array('code' => $code, 'codelocations' => $codelocations));
                                //Si machine originale on fait un update
                                if (isset($machine)) {
                                    if ($machine->getOriginal() == 1) {
                                        $machine->setCodelocations(NULL);
                                        $machine->setCodecontrat(NULL);
                                        $machine->setClientid(0);
                                        $machine->setEntreprise(NULL);
                                        $machine->setNomchantier(NULL);
                                        $machine->setDebutloc(NULL);
                                        $machine->setFinloc(NULL);
                                        $machine->setEtat('Disponible');
                                        $em->persist($machine);
                                        $em->flush();
                                    } else {
                                        $em->remove($machine);
                                        $em->flush();
                                    }
                                }
                                $refusloc = $em->getRepository('BaclooCrmBundle:Locationssl')
                                    ->findOneById($codelocations);
                                $refusloc->setEtatloc('Refusé');
                                $refusloc->setEtatlog('Refusé');
                                $locata->setContrat(0);
                                $em->persist($refusloc);
                                $em->flush();

                            }
                        }
                        // echo 'ttttt';echo $locid;
                        $em->persist($locata);
                        $em->flush();
                        //Fin maj table machine
                        // $em = $this->getDoctrine()->getManager();
                        if ($locid == 0) {
                            $locid = $locata->getId();
                        }
                        if (!isset($erreur)) {
                            $erreur = 0;
                        }
//                        if($erreur === 'planning')
//                        {
//                            return $this->redirect($this->generateUrl('bacloocrm_planning', array('openModal' => 'true', 'event_id' => $locata->getId())));
//                        }
                        if($erreur === 'planning')
                        {
                            return $this->redirect($this->generateUrl('bacloocrm_planningsl', array('openModal' => 'true', 'event_id' => $locata->getId())));
                        }
                        else
                        {
                            return $this->redirect($this->generateUrl('bacloocrm_ajouterlocation', array('ficheid' => $ficheid, 'locid' => $locid, 'erreur' => $erreur)));
                        }

                    }
                }

            }
            if($erreur === 'planning')
            {
                return $this->redirect($this->generateUrl('bacloocrm_planning', array('openModal' => 'true', 'event_id' => $locata->getId())));
            }
            if($erreur === 'planningsl')
            {
                return $this->redirect($this->generateUrl('bacloocrm_planningsl', array('openModal' => 'true', 'event_id' => $locata->getId())));
            }
            else
            {
                return $this->redirect($this->generateUrl('bacloocrm_ajouterlocation', array('ficheid' => $ficheid, 'locid' => $locid, 'erreur' => $erreur)));
            }
        }
        $listedispos = array();
        $totalht = 0;
        if($locid > 0)
        {//echo 'laaa';echo 'locid'.$locid;
            // $dstart = new \DateTime($locata->getDebutloc());
            // $dend = new \DateTime($locata->getFinloc());
            $listedispos = array();
            $listecodes = array();

            //Calcul total ht loc parc
            foreach($locata->getLocations() as $loca)
            {
                $dstart = $loca->getDebutloc();
                $dend = $loca->getFinloc();
                $dstartok = date('Y-m-d', strtotime($dstart . ' -1 day'));//echo 'dtartok'.$dstartok;
                $dendok = date('Y-m-d', strtotime($dend . ' +1 day'));//echo 'dtartok'.$dendok;
                $codemachine = $loca->getCodemachine();
                $dispos = $em->getRepository('BaclooCrmBundle:Machines')
                    ->dispos($codemachine, $dstartok, $dendok);
                //echo 'dispo1';print_r($dispos);echo $codemachine;
                $i = 0;
                foreach($dispos as $disp)
                {//echo 'AAA'.($disp['code']).'AAA';
                    $dispo = $em->getRepository('BaclooCrmBundle:Machines')
                        ->dispoprecise($disp['code'], $dstart, $dend);
                    // print_r($dispo);
                    if(!empty($dispo)){$i = $i + 1;}
                }
                $listedispos[$codemachine]= count($dispos) - $i;


                //FACTURATION
                $dStart = $loca->getDebutloc();
                $dEnd = $loca->getFinloc();

                //1.Récupérer les données de la table Machines

                //2.On génère les entêtes de colonnes à partir de la fonction createplanning
                $nbjloc = $loca->getNbjloc();
                //nb jour pour les assurances car 7/7
                $nbjlocass = $loca->getNbjlocass();
                // echo 'xx'.$nbjloc.'xx';
                // echo 'hh'.$i.'hh';

                //Création du montant HT ligne par ligne


                $grille  = $em->getRepository('BaclooCrmBundle:Grille')
                    ->findByCodeclient($locata->getClientid());




                if(null !== $loca->getLoyerp1())
                {
                    $totalht += $nbjloc * $loca->getLoyerp1();
                    $totalhtloc = $nbjloc * $loca->getLoyerp1();
                    $totalhtlocass = $nbjlocass * $loca->getLoyerp1();
                    $loyer = $loca->getLoyerp1();
                }
                elseif(null !== $loca->getLoyerp2())
                {
                    $totalht += $nbjloc * $loca->getLoyerp2();
                    $totalhtloc = $nbjloc * $loca->getLoyerp2();
                    $totalhtlocass = $nbjlocass * $loca->getLoyerp2();
                    $loyer = $loca->getLoyerp2();
                }
                elseif(null !== $loca->getLoyerp3())
                {
                    $totalht += $nbjloc * $loca->getLoyerp3();
                    $totalhtloc = $nbjloc * $loca->getLoyerp3();
                    $totalhtlocass = $nbjlocass * $loca->getLoyerp3();
                    $loyer = $loca->getLoyerp3();
                }
                elseif(null !== $loca->getLoyerp4())
                {
                    $totalht += $nbjloc * $loca->getLoyerp4();
                    $totalhtloc = $nbjloc * $loca->getLoyerp4();
                    $totalhtlocass = $nbjlocass * $loca->getLoyerp4();
                    $loyer = $loca->getLoyerp4();
                }
                elseif(null !== $loca->getLoyermensuel())
                {
                    include('calculnbjlocamensuelle.php');
                    $loyer = $loca->getLoyermensuel()/20;
                    $totalht += $loyer * $nbjloc;
                    $totalhtloc = $loyer * $nbjloc;
                    $totalhtlocass = $loyer * $nbjlocass;
                }
                // echo 'c'.$totalht;echo 'nbjloccc'.$nbjloc;


                if($loca->getRemise() > 0)
                {//echo 'totalhtlocavant'.$totalhtloc;
                    $totalht = $totalht  - ($totalhtloc * $loca->getRemise()/100);
                    $totalhtloc = $totalhtloc - ($totalhtloc * $loca->getRemise()/100);
                    //echo 'totalhtxxx'.$totalht;echo 'remise'.$loc->getRemise();echo 'totalhtloc'.$totalhtloc;exit();
                }

                if(null !== $loca->getMontantcarb() && $loca->getMontantcarb()>0)
                {
                    $montantcarb += $loca->getLitrescarb()*1.97;
                }

//						$totaltrspaller += $loca->getTransportaller();
//						$totaltrspretour += $loca->getTransportretour();

                if($loca->getContributionverte() == 1)
                {
                    $contributionverte += 0.0215 * $loyer * $nbjloc;
                }

                if ($loca->getAssurance() == 1) {
                    if($client->getAssurance() == 1)
                    {
                        $assurance = 0;
                    }
                    else
                    {
                        $assurance += $totalhtloc * 0.10;
                    }
                }
                // $loca->setMontantloc($totalhtloc);
                // $loca->setNbjloc($nbjloc);
                // $em->persist($loca);
                // $em->flush();
            }


            //Calcul totalht Sous loc
            foreach($locata->getLocationssl() as $loca)
            {
                $dstart = $loca->getDebutloc();
                $dend = $loca->getFinloc();
                $dstartok = date('Y-m-d', strtotime($dstart . ' -1 day'));
                $dendok = date('Y-m-d', strtotime($dend . ' +1 day'));
                $codemachine = $loca->getCodemachine();
                $dispos = $em->getRepository('BaclooCrmBundle:Machinessl')
                    ->dispos($codemachine, $dstartok, $dendok, $loca->getLoueur());
                // print_r($dispos);echo $codemachine;
                $i = 0;
                foreach($dispos as $disp)
                {//echo 'AAA'.($disp['code']).'AAA';
                    $dispo = $em->getRepository('BaclooCrmBundle:Machinessl')
                        ->dispoprecise($disp['code'], $dstart, $dend, $loca->getLoueur());
                    // print_r($dispo);
                    if(!empty($dispo)){$i = $i + 1;}
                }
                $listedispos[$codemachine]= count($dispos) - $i;



                //FACTURATION
                $dStart = $loca->getDebutloc();
                $dEnd = $loca->getFinloc();

                //1.Récupérer les données de la table Machines

                //2.On génère les entêtes de colonnes à partir de la fonction createplanning
                $nbjloc = $loca->getNbjloc();
                //nb jour pour les assurances car 7/7
                $nbjlocass = $loca->getNbjlocass();
                // echo 'xx'.$nbjloc.'xx';
                // echo 'hh'.$i.'hh';

                //Création du montant HT ligne par ligne


                $grille  = $em->getRepository('BaclooCrmBundle:Grille')
                    ->findByCodeclient($locata->getClientid());

                if(null !== $loca->getLoyerp1())
                {
                    $totalht += $nbjloc * $loca->getLoyerp1();
                    $totalhtloc = $nbjloc * $loca->getLoyerp1();
                    $totalhtlocass = $nbjlocass * $loca->getLoyerp1();
                    $loyer = $loca->getLoyerp1();
                }
                elseif(null !== $loca->getLoyerp2())
                {
                    $totalht += $nbjloc * $loca->getLoyerp2();
                    $totalhtloc = $nbjloc * $loca->getLoyerp2();
                    $totalhtlocass = $nbjlocass * $loca->getLoyerp2();
                    $loyer = $loca->getLoyerp2();
                }
                elseif(null !== $loca->getLoyerp3())
                {
                    $totalht += $nbjloc * $loca->getLoyerp3();
                    $totalhtloc = $nbjloc * $loca->getLoyerp3();
                    $totalhtlocass = $nbjlocass * $loca->getLoyerp3();
                    $loyer = $loca->getLoyerp3();
                }
                elseif(null !== $loca->getLoyerp4())
                {
                    $totalht += $nbjloc * $loca->getLoyerp4();
                    $totalhtloc = $nbjloc * $loca->getLoyerp4();
                    $totalhtlocass = $nbjlocass * $loca->getLoyerp4();
                    $loyer = $loca->getLoyerp4();
                }
                elseif(null !== $loca->getLoyermensuel())
                {
                    include('calculnbjlocamensuelle.php');
                    $loyer = $loca->getLoyermensuel()/20;
                    $totalht += $loyer * $nbjloc;
                    $totalhtloc = $loyer * $nbjloc;
                    $totalhtlocass = $loyer * $nbjlocass;
                }

                if(null !== $loca->getMontantcarb() && $loca->getMontantcarb()>0)
                {
                    $montantcarb += $loca->getLitrescarb()*1.97;
                }

                if($loca->getRemise() > 0)
                {//echo 'totalhtlocavant'.$totalhtloc;
                    $totalht = $totalht  - ($totalhtloc * $loc->getRemise()/100);
                    $totalhtloc = $totalhtloc - ($totalhtloc * $loc->getRemise()/100);
                    //echo 'totalhtxxx'.$totalht;echo 'remise'.$loc->getRemise();echo 'totalhtloc'.$totalhtloc;exit();
                }
//				$totaltrspaller += $loca->getTransportaller();
//				$totaltrspretour += $loca->getTransportretour();

                if($loca->getContributionverte() == 1)
                {
                    $contributionverte += 0.0215 * $totalhtloc;
                }

                if ($loca->getAssurance() == 1) {
                    if($client->getAssurance() == 1)
                    {
                        $assurance = 0;
                    }
                    else
                    {
                        $assurance += $totalhtloc * 0.10;
                    }
                }
                 $loca->setMontantloc($totalhtloc);
                // $loca->setNbjloc($nbjloc);
                 $em->persist($loca);
                 $em->flush();
            }


            $montantvente = 0;
            $totalvente = 0;
            foreach($locata->getLocataventes() as $ven)
            {
                $montantvente = $ven->getQuantite() * abs($ven->getPu());
                $totalvente += $ven->getQuantite() * abs($ven->getPu());
                // $em->flush();
            }
            $totalht = $locata->getMontantloc();
            // if($locata->getRemise() > 0)
            // {
            // $totalht = $totalht - ($totalht * $locata->getRemise()/100);
            // }//echo 'b'.$totalht;

            // $locata->setMontantloc($totalht);
            // $locata->setTransportaller($totaltrspaller);
            // $locata->setTransportretour($totaltrspretour);
            // $locata->setAssurance($assurance);
            // $locata->setContributionverte($contributionverte);
            // $em->persist($locata);
            // $em->flush();
            //FIN FACTURATION
        }
        else
        {//echo 'ici';
            $totalht = 0;
            $nbjloc = 0;
            $nbjlocass = 0;
            $totalvente = 0;
            $grille = array();
        }//echo 'a'.$totalht;

        $factures = $em->getRepository('BaclooCrmBundle:Factures')
            ->findOneByCodelocata($locid);

        $locatafrs = $em->getRepository('BaclooCrmBundle:Locatafrs')
            ->findByCodelocatasl($locid);
//		echo $locatafrs->getId();
        if(empty($locatafrs)){ $locatafrs = 0;}
        if(isset($factures)){$afac = 'ok';}else{$afac = 'nok';}
        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($objUser);
        $roleuser = $userdetails->getRoleuser();
        // echo $grille;

        //On regarde dans les factures si deja compta
        $factures = $em->getRepository('BaclooCrmBundle:Factures')
            ->findOneByCodelocata($locid);
        if(isset($factures))
        {
            $proforma = 'ok';
        }
        else
        {
            if($client->getDelaireglement() == 1)
            {
                $proforma = 'nok';
            }
            else
            {
                $proforma = 'ok';
            }

        }
        $proforma = 'ok';
        $documents  = $em->getRepository('BaclooCrmBundle:Document')
            ->findBy(array('codecontrat' => $locid, 'type' => 'contrat'));
//echo 'locata'.$locata->getId();
        $moisdevis = date("m", strtotime($locata->getDatecrea()));
        $anneedevis = date("Y", strtotime($locata->getDatecrea()));
//        echo 'locid'.$locid;
        return $this->render('BaclooCrmBundle:Crm:nouvelle_location.html.twig', array('form' => $form->createView(),
            'date' => $today,
            'roleuser' => $roleuser,
            'client' => $client,
            'contrat' => $contrat,
            'bdcrecu' => $bdcrecu,
            'usersociete' => $societe,
            'modules' => $modules,
            'listedispos' => $listedispos,
            'entreprise' => $client->getRaisonSociale(),
            'id' => $ficheid,
            'erreur' => $erreur,
            'locid' => $locid,
            'totalht' => $totalht,
            'montantlocavente' => $totalvente,
            'totaltrspaller' => $totaltrspaller,
            'totaltrspretour' => $totaltrspretour,
            'assurance' => $assurance,
            'contributionverte' => $contributionverte,
            'montantcarb' => $montantcarb,
            'nbjloc' => $nbjloc,
            'grille' => $grille,
            'afac' => $afac,
            'proforma' => $proforma,
            'locatafrs' => $locatafrs,
            'documents' => $documents,
            'moisdevis' => $moisdevis,
            'anneedevis' => $anneedevis,
            'destinatairedevis' => $destinatairedevis,
            'destinatairecontrat' => $destinatairecontrat,
            'destinataireproforma' => $destinataireproforma,
            'mode' => $mode,
            'listeDesComposantsParDefautRoulottes' => $listeDesComposantsParDefautRoulottes,
            'user' => $objUser));
    }

    public function requete1Action(Request $request)
    {
        // $request = $request->get('request');
        // if($request == 1){
        $search = $request->get('search');
        if(!empty($search))
        {
            $em = $this->getDoctrine()->getManager();
            $query = $em->createQuery(
                'SELECT f
					FROM BaclooCrmBundle:Fiche f
					WHERE f.raisonSociale LIKE :raisonSociale'
            );
            $query->setParameter('raisonSociale', '%'.$search.'%');
            $result = $query->getArrayResult();

            // Transformer le tableau associatif en un tableau standard
            $array = array();
            foreach ($result as $data) {
                $array[] = array("value"=>$data['typemachine'],"label"=>$data['raisonSociale'],"id"=>$data['loyerp1'],"desc"=>$data['loyerp2'],"icon"=>$data['loyerp3'],"p4"=>$data['loyerp4'],"p5"=>$data['loyermensuel']);
            }
        }
        $response = new Response(json_encode($array));
        return $response;
        // }
    }

    public function requete2Action(Request $request)
    {
        // $request = $request->get('request');
        // if($request == 2){
        $userid = $request->get('userid');
        if(!empty($userid))
        {
            $em = $this->getDoctrine()->getManager();
            $query = $em->createQuery(
                'SELECT f.raisonSociale, f.cp
					FROM BaclooCrmBundle:Fiche f
					WHERE f.id = :id'
            );
            $query->setParameter('id', $userid);
            $result = $query->getArrayResult();
            $users_arr1 = array();

            foreach ($result as $data) {
                $users_arr1[] = array("cp" => $data['cp'], "raisonSociale" => $data['raisonSociale']);
            };
        }
        $users_arr = new Response(json_encode($users_arr1));
        return $users_arr;
        // }
    }

    public function requete1grilleAction(Request $request)
    {
        // $request = $request->get('request');
        // if($request == 1){
        $search = $request->get('search');
        $codeclient = $request->get('codeclient');
        if(!empty($search))
        {
            $em = $this->getDoctrine()->getManager();
            $query = $em->createQuery(
                'SELECT f
					FROM BaclooCrmBundle:Grille f
					WHERE f.codemachineinterne LIKE :codemachineinterne
					AND f.codeclient = :codeclient'
            );
            $query->setParameter('codemachineinterne', '%'.$search.'%');
            $query->setParameter('codeclient', $codeclient);
            $result = $query->getArrayResult();
            // Transformer le tableau associatif en un tableau standard
            $array = array();
            foreach ($result as $data) {
                $array[] = array("value"=>$data['typemachine'],"label"=>$data['codemachineinterne'],"id"=>$data['loyerp1'],"desc"=>$data['loyerp2'],"icon"=>$data['loyerp3'],"p4"=>$data['loyerp4'],"p5"=>$data['loyermensuel']);
            }

            if(empty($result))
            {
                $query = $em->createQuery(
                    'SELECT f
					FROM BaclooCrmBundle:Grille f
					WHERE f.codemachineinterne LIKE :codemachineinterne
					AND f.codeclient = :codeclient'
                );
                $query->setParameter('codemachineinterne', '%'.$search.'%');
                // $query->setParameter('codeclient', 5451);//Local
                $query->setParameter('codeclient', 51);//Prod
                $result = $query->getArrayResult();
                // Transformer le tableau associatif en un tableau standard
                $array = array();
                foreach ($result as $data) {
                    $array[] = array("value"=>$data['typemachine'],"label"=>$data['codemachineinterne'],"id"=>$data['loyerp1'],"desc"=>$data['loyerp2'],"icon"=>$data['loyerp3'],"p4"=>$data['loyerp4'],"p5"=>$data['loyermensuel']);
                }
            }

            if(empty($result))
            {
                $query = $em->createQuery(
                    'SELECT f
						FROM BaclooCrmBundle:Machines f
						WHERE f.codegenerique LIKE :codegenerique
						Group by f.codegenerique'
                );
                $query->setParameter('codegenerique', '%'.$search.'%');
                $result = $query->getArrayResult();
                // Transformer le tableau associatif en un tableau standard
                $array = array();
                foreach ($result as $data) {
                    $array[] = array("value"=>$data['description'],"label"=>$data['codegenerique'],"id"=>'',"desc"=>'',"icon"=>'',"p4"=>'');
                }
            }
        }
        $response = new Response(json_encode($array));
        return $response;
        // }
    }

    public function requete1grille2Action(Request $request)
    {
        // $request = $request->get('request');
        // if($request == 1){
        $search = $request->get('search');
        $codeclient = $request->get('codeclient');
        if(!empty($search))
        {
            $em = $this->getDoctrine()->getManager();
            $query = $em->createQuery(
                'SELECT f
						FROM BaclooCrmBundle:Machines f
						WHERE f.codegenerique LIKE :codegenerique
						Group by f.codegenerique'
            );
            $query->setParameter('codegenerique', '%'.$search.'%');
            $result = $query->getArrayResult();
            // Transformer le tableau associatif en un tableau standard
            $array = array();
            foreach ($result as $data) {
                $array[] = array("value"=>$data['description'],"label"=>$data['codegenerique'],"id"=>'',"desc"=>'',"icon"=>'',"p4"=>'');
            }
        }
        $response = new Response(json_encode($array));
        return $response;
        // }
    }

    public function requete1grilleslAction(Request $request)
    {
        // $request = $request->get('request');
        // if($request == 1){
        $search = $request->get('search');
        $loueur = $request->get('loueur');
        if(!empty($search))
        {
            $em = $this->getDoctrine()->getManager();
            $query = $em->createQuery(
                'SELECT f
					FROM BaclooCrmBundle:Grillesl f
					WHERE f.codemachineinterne LIKE :codemachineinterne
					AND f.loueur = :loueur'
            );
            $query->setParameter('codemachineinterne', '%'.$search.'%');
            $query->setParameter('loueur', $loueur);
            $result = $query->getArrayResult();
            // Transformer le tableau associatif en un tableau standard
            $array = array();
            foreach ($result as $data) {
                $array[] = array("value"=>$data['typemachine'],"label"=>$data['codemachineinterne'],"id"=>$data['loyerp1'],"desc"=>$data['loyerp2'],"icon"=>$data['loyerp3'],"p4"=>$data['loyerp4'],"p5"=>$data['loyermensuel']);
            }

            if(empty($result))
            {
                $query = $em->createQuery(
                    'SELECT f
						FROM BaclooCrmBundle:Machinessl f
						WHERE f.codegenerique LIKE :codegenerique
						AND f.loueur = :loueur
						Group by f.codegenerique'
                );
                $query->setParameter('codegenerique', '%'.$search.'%');
                $query->setParameter('loueur', $loueur);
                $result = $query->getArrayResult();
                // Transformer le tableau associatif en un tableau standard
                $array = array();
                foreach ($result as $data) {
                    $array[] = array("value"=>$data['description'],"label"=>$data['codegenerique'],"id"=>'',"desc"=>'',"icon"=>'',"p4"=>'');
                }
            }
        }
        $response = new Response(json_encode($array));
        return $response;
        // }
    }

    public function requete2grilleAction(Request $request)
    {
        // $request = $request->get('request');
        // if($request == 2){
        $codeclient = $request->get('userid');
        $codemachineinterne = $request->get('codemachineinterne');
        if(!empty($codeclient))
        {
            $em = $this->getDoctrine()->getManager();
            $query = $em->createQuery(
                'SELECT f.codemachineinterne, f.typemachine, f.loyerp1, f.loyerp2, f.loyerp3, f.loyerp4, f.loyermensuel
					FROM BaclooCrmBundle:Grille f
					WHERE f.codeclient = :codeclient
					AND f.codemachineinterne = :codemachineinterne'
            );
            $query->setParameter('codeclient', $codeclient);
            $query->setParameter('codemachineinterne', $codemachineinterne);
            $result = $query->getArrayResult();
            $users_arr1 = array();

            foreach ($result as $data) {
                $users_arr1[] = array("codemachineinterne" => $data['codemachineinterne'], "typemachine" => $data['typemachine'], "loyerp1" => $data['loyerp1'], "loyerp2" => $data['loyerp2'], "loyerp3" => $data['loyerp3'], "loyerp4" => $data['loyerp4'], "loyermensuel" => $data['loyermensuel']);
            };
        }
        $users_arr = new Response(json_encode($users_arr1));
        return $users_arr;
        // }
    }

    public function adispatcherAction(Request $request)
    {
        $usersess = $this->get('security.context')->getToken()->getUsername();

        //On récupère les favoris niveau ALL
        $em = $this->getDoctrine()->getManager();
		$userdetails  = $em->getRepository('BaclooUserBundle:User')
        ->findOneByUsername($usersess);
        
        //Calcul de la date de sprochains départs
        //Tout d'abord faut éviter les week end
        //On vérifie que demain ne soit pas un samedi ou un dimanche
        $today = date('D');
        if($today == 'Fri')
        {
            $date = date('Y-m-d', strtotime("+14 days"));
        }
        elseif($today == 'Sat')
        {
            $date = date('Y-m-d', strtotime("+13 days"));
        }
        elseif($today == 'Thu')
        {
            $date = date('Y-m-d', strtotime("+15 days"));
        }
        else
        {
            $date = date('Y-m-d', strtotime("+14 days"));
        }

//Partie Départ
        $adispatcher = $em->getRepository('BaclooCrmBundle:Locata')
            ->adispatcher($date);
// print_r($adispatcher);
        $i = 0;
        foreach($adispatcher as $disp)
        {
            foreach($disp->getLocations() as $di )
            {
                $i++;
            }
        }
        $em->clear();

        $dejadispatch = $em->getRepository('BaclooCrmBundle:Locata')
            ->dejadispatch($date);

        $a = 0;
        foreach($dejadispatch as $dejadisp)
        {
            foreach($dejadisp->getLocations() as $dis )
            {
                $a++;
            }
        }
        $em->clear();

        $resa = $em->getRepository('BaclooCrmBundle:Locata')
            ->resa($date);

//        $resa = $em->getRepository('BaclooCrmBundle:Locata')
//            ->createQueryBuilder('l')
//            ->join('l.locations', 'lo')
//            ->orderBy('lo.datedebut', 'ASC')
//            ->where('l.date = :date')
//            ->andWhere('l.user = :user')
//            ->andWhere('l.depot = :depot')
//            ->setParameter('date', $date)
//            ->setParameter('user', $usersess)
//            ->getQuery()
//            ->getResult();

        $d = 0;
        foreach($resa as $res)
        {
            foreach($res->getLocations() as $dis )
            {
                $d++;
            }
        }
        $em->clear();
//Fin partie Départ

//Partie retour
        $now = date('Y-m-d');
        $apreprarer = $em->getRepository('BaclooCrmBundle:Locata')
            ->apreprarer($now);

        $j = 0;
        foreach($apreprarer as $disp)
        {
            foreach($disp->getLocations() as $di )
            {
                $j++;
            }
        }
        $em->clear();

        $machinespretes = $em->getRepository('BaclooCrmBundle:Machines')
            ->findByEtat('Disponible');

        $b = 0;
        foreach($machinespretes as $mach)
        {
            $b++;
        }
//Fin partie retour

//Pannes
        $enpanne = $em->getRepository('BaclooCrmBundle:Machines')
            ->findByEtat('En panne');

        $c = 0;
        foreach($enpanne as $mach)
        {
            $c++;
        }
//Fin pannes

//Inspection
        $inspection = $em->getRepository('BaclooCrmBundle:Machines')
            ->findByEtat('Inspection');

        $e = 0;
        foreach($inspection as $mach)
        {
            $e++;
        }
//Fin inspection

        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($usersess);

        return $this->render('BaclooCrmBundle:Crm:adispatcher.html.twig', array(
            'adispatcher' => $adispatcher,
            'dejadispatch' => $dejadispatch,
            'apreprarer' => $apreprarer,
            'enpanne' => $enpanne,
            'inspection' => $inspection,
            'machinespretes' => $machinespretes,
            'resa' => $resa,
            'i' => $i,
            'a' => $a,
            'j' => $j,
            'b' => $b,
            'c' => $c,
            'd' => $d,
            'e' => $e,
            'date' => $date,
            'userdetails' => $userdetails,
            'date1' => date('Y-m-d', strtotime(" -1 days"))
        ));
    }

    public function dispatchAction($code, $codecont, $machinedor, $erreur, Request $request)
    {
        $em = $this->getDoctrine()->getManager();
// echo 'machinedor'.$machinedor;
        $locations  = $em->getRepository('BaclooCrmBundle:Locations')
            ->findOneById($code);
        $etat = $locations->getEtatloc();
        $defaultData = array();
        $form = $this->createFormBuilder($defaultData)
            ->add('codemachineinterne', 'text', array('required' => false))
            ->getForm();
        $form->handleRequest($request);
        // On vérifie qu'elle est de type POST
        if ($request->getMethod() == 'POST')
        {
            $data = $form->getData();

            // On vérifie que les valeurs entrées sont correctes
            if($form->isValid()){
                $data = $form->getData();
                $ecode =  $data['codemachineinterne'];

                //On vérifie qu'une machine existe avec l'ecode saisi dans le formulaire
                $ecodemachine = $em->getRepository('BaclooCrmBundle:Machines')
                    ->findOneBy(array('code'=> $ecode));

                //On vérifie que la machine saisie dans le formulaire soit disponible
                $machine = $em->getRepository('BaclooCrmBundle:Machines')
                    ->findOneBy(array('code'=> $ecode, 'etat'=> 'Disponible', 'original' => 1));

                //On regarde si une machine clone réservée ne porte pas cet ecode
                $machineresa = $em->getRepository('BaclooCrmBundle:Machines')
                    ->findBy(array('code'=> $ecode, 'codelocations' => $locations->getId(), 'original' => 0));

                //On regarde si une machine d'origine ne porte pas cet ecode
                $machinedorigine = $em->getRepository('BaclooCrmBundle:Machines')
                    ->findOneBy(array('codelocations' => $locations->getId(), 'code' => $machinedor, 'entreprise' => $locations->getEntreprise()));
// echo 'codeloc'.$locations->getId();	echo 'ecode ori'.$machinedor;
                //On récupère le contrat concerné
                $locata = $em->getRepository('BaclooCrmBundle:Locata')
                    ->findOneById($codecont);

                //Si il n'y a pas de machine qui porte cet ecode
                if(empty($ecodemachine) or $ecodemachine == NULL and isset($machine))
                {
                    return $this->redirect($this->generateUrl('bacloocrm_dispatch', array('code' => $code, 'codecont' => $codecont, 'erreur' => 2)));
                }
                // elseif(!isset($machineresa) && !isset($machine))
                // {
                // return $this->redirect($this->generateUrl('bacloocrm_dispatch', array('code' => $code, 'codecont' => $codecont, 'erreur' => 1)));
                // }
// echo $locata->getDebutloc();
                // $em->clear();

                // elseif(isset($machineresa) && $machineresa->getCode() != $ecode)
                // {
                // $em->remove($machineresa);
                // $em->flush();
                // }
                echo 'codezmch'.$ecode;
                echo 'codecontrat'.$codecont;
                $machin = $em->getRepository('BaclooCrmBundle:Machines')
                    ->findOneBy(array('code'=> $ecode, 'original'=> 1, 'etat' => 'disponible'));
                if(!isset($machin))
                {
                    $machin = $em->getRepository('BaclooCrmBundle:Machines')
                        ->findOneBy(array('code'=> $ecode, 'original'=> 1, 'codecontrat' => $codecont));
                }

                if(isset($machin))
                {//echo 'okkkkkkk';
                    $machin->setDebutloc($locations->getDebutloc());
                    $machin->setFinloc($locations->getFinloc());
                    $machin->setEtat('Prêt au départ');
                    $machin->setEntreprise($locata->getClient());
                    $machin->setClientid($locata->getClientid());
                    $machin->setNomchantier($locata->getNomchantier());
                    $machin->setCodelocations($code);
                    $machin->setCodecontrat($locata->getId());
                    $em->persist($machin);

                    $locations->setEtatloc('Prêt au départ');
                    $locations->setMachineid($machin->getId());
                    $locations->setCodemachineinterne($ecode);
                    $locations->setProchainevgp($machin->getProchaineVgp());
                    $locations->setCodemachine($machin->getCodegenerique());
                    $locations->setTypemachine($machin->getDescription());
                    $locations->setEnergie($machin->getEnergie());
                    if($locations->getBrok() == 0)
                    {
                        $locations->setBrok(0);
                        $locations->setBrid(0);
                        $locations->setBruser(0);
                    }
                    if($locations->getBdok() == 0)
                    {
                        $locations->setBdok(0);
                        $locations->setBdid(0);
                        $locations->setBduser(0);
                    }
                    $em->persist($locations);
                    if(isset($machineresa))
                    {
                        foreach($machineresa as $mach)
                        {
                            $em->remove($mach);
                        }
                    }

                    //Si la machine réservée est différente de la machine du formulaire : il s'agit d'un changement de machine par la tech.
                    if(isset($machinedorigine) && $machinedorigine->getCode() != $ecode && $machinedorigine->getOriginal() == 1)
                    {
                        $machinedorigine->setCodelocations('');
                        $machinedorigine->setCodecontrat('');
                        $machinedorigine->setClientid(0);
                        $machinedorigine->setEntreprise('');
                        $machinedorigine->setNomchantier('');
                        $machinedorigine->setDebutloc('');
                        $machinedorigine->setFinloc('');
                        $machinedorigine->setEtat('Disponible');
                        $em->persist($machinedorigine);
                    }
                    elseif(isset($machinedorigine) && $machinedorigine->getOriginal() == 0 )
                    {
                        $em->remove($machinedorigine);
                    }
                }
                else
                {//echo 'yyyyyyyy';

                    return $this->redirect($this->generateUrl('bacloocrm_dispatch', array('code' => $code, 'codecont' => $codecont, 'erreur' => 2)));
                }

                $em->flush();


                // On redirige vers la page de visualisation de la fiche nouvellement créée
                return $this->redirect($this->generateUrl('bacloocrm_adispatcher'));
            }
        }

        return $this->render('BaclooCrmBundle:Crm:dispatch.html.twig', array(
            'code' => $code,
            'codecont' => $codecont,
            'machinedor' => $machinedor,
            'typemachine' => $locations->getCodemachine(),
            'erreur' => $erreur,
            'form' => $form->createView()
        ));
    }

    public function dispatchslAction($codecontrat, $machinedor, $erreur, Request $request)
    {
        $em = $this->getDoctrine()->getManager();
// echo 'machinedor'.$machinedor;
        $locata  = $em->getRepository('BaclooCrmBundle:Locata')
            ->findOneById($codecontrat);
// echo $codecontrat;
        foreach($locata->getLocationssl() as $loca)
        {//echo 'rrrrrr';echo $loca->getCodemachineinterne();echo $machinedor;
            if($loca->getCodemachineinterne() == $machinedor)
            {//echo 'tttttt';
                $code = $loca->getId();//echo $code;
                $typemachine = $loca->getTypemachine();
            }
        }
// echo $code;
        // $etat = $locationssl->getEtatloc();
        $defaultData = array();
        $form = $this->createFormBuilder($defaultData)
            ->add('codemachineinterne', 'text', array('required' => false))
            ->getForm();
        $form->handleRequest($request);
        // On vérifie qu'elle est de type POST
        if ($request->getMethod() == 'POST')
        {
            $data = $form->getData();

            // On vérifie que les valeurs entrées sont correctes
            if($form->isValid()){
                $data = $form->getData();
                $ecode =  $data['codemachineinterne'];

                if($ecode != '' or $ecode != 0)
                {
                    //On vérifie qu'une machine existe avec l'ecode saisi dans le formulaire
                    $ecodemachine = $em->getRepository('BaclooCrmBundle:Machinessl')
                        ->findOneBy(array('code'=> $ecode));

                    //On vérifie que la machine saisie dans le formulaire soit disponible
                    $machine = $em->getRepository('BaclooCrmBundle:Machinessl')
                        ->findOneBy(array('code'=> $ecode, 'etat'=> 'Disponible'));

                    //On regarde si une machine d'origine ne porte pas cet ecode
                    $machinedorigine = $em->getRepository('BaclooCrmBundle:Machinessl')
                        ->findOneBy(array('codelocations' => $code, 'original' => 1, 'code' => $machinedor, 'entreprise' => $locata->getClient()));
                    // echo 'codeloc'.$locations->getId();	echo 'ecode ori'.$machinedor;
                    //On récupère le contrat concerné
                    $locata = $em->getRepository('BaclooCrmBundle:Locata')
                        ->findOneById($codecontrat);

                    //Si il n'y a pas de machine qui porte cet ecode
                    if(empty($ecodemachine) or $ecodemachine == NULL and isset($machine))
                    {
                        return $this->redirect($this->generateUrl('bacloocrm_dispatchsl', array('codecontrat' => $codecontrat, 'machinedor' => $machinedor, 'erreur' => 2)));
                    }
                }
                //Si la machine réservée est différente de la machine du formulaire : il s'agit d'un changement de machine par la tech.
                if(isset($machinedorigine) && $machinedorigine->getCode() != $ecode && $machinedorigine->getOriginal() == 1)
                {echo 'laaaaaaa';
                    $machinedorigine->setCodelocations('');
                    $machinedorigine->setCodecontrat('');
                    $machinedorigine->setClientid(0);
                    $machinedorigine->setEntreprise('');
                    $machinedorigine->setNomchantier('');
                    $machinedorigine->setDebutloc('');
                    $machinedorigine->setFinloc('');
                    $machinedorigine->setEtat('Disponible');
                    $em->persist($machinedorigine);
                }
// echo $ecode;
                $machin = $em->getRepository('BaclooCrmBundle:Machinessl')
                    ->findOneBy(array('code'=> $ecode, 'original'=> 1));



                foreach($locata->getLocationssl() as $loca)
                {
                    if($loca->getCodemachineinterne() == $machinedor)
                    {
                        if($ecode == '' or $ecode == 0)
                        {echo 'pppppppp';
                            $em->remove($loca);
                            $locata->setBdcrecu(0);
                            $locata->setContrat(0);
                            $em->persist($locata);
                        }
                        else
                        {echo 'ici';
                            $loca->setMachineid($machin->getId());
                            $loca->setCodemachine($machin->getCodegenerique());
                            $loca->setCodemachineinterne($ecode);
                            $loca->setTypemachine($machin->getDescription());
                            $loca->setEnergie($machin->getEnergie());
                            $em->persist($loca);
                        }
                        if(isset($machin))
                        {echo 'okkkkkkk';
                            $machin->setDebutloc($loca->getDebutloc());
                            $machin->setFinloc($loca->getFinloc());
                            $machin->setEtat('Prêt au départ');
                            $machin->setEntreprise($locata->getClient());
                            $machin->setClientid($locata->getClientid());
                            $machin->setNomchantier($locata->getNomchantier());
                            $machin->setCodelocations($loca->getId());
                            $machin->setCodecontrat($locata->getId());
                            $em->persist($machin);
                            $code = $loca->getId();echo $code;
                        }
                        elseif($ecode != '' or $ecode != 0)
                        {//echo 'yyyyyyyy';
                            return $this->redirect($this->generateUrl('bacloocrm_dispatchsl', array('codecontrat' => $codecontrat, 'machinedor' => $machinedor, 'erreur' => 2)));
                        }
                    }
                }
                $em->flush();


                // On redirige vers la page de visualisation de la fiche nouvellement créée
                return $this->redirect($this->generateUrl('bacloocrm_ajouterlocation', array('ficheid' => $locata->getClientid(), 'locid' => $codecontrat)));
            }
        }

        return $this->render('BaclooCrmBundle:Crm:dispatchsl.html.twig', array(
            'code' => $code,
            'codecont' => $codecontrat,
            'machinedor' => $machinedor,
            'typemachine' => $typemachine,
            'erreur' => $erreur,
            'ficheid' => $locata->getClientid(),
            'form' => $form->createView()
        ));
    }

    public function retoursAction($erreur, $date, Request $request)
    {
        //On récupère les favoris niveau ALL
        $em = $this->getDoctrine()->getManager();
        $qrcode = 0;
        if($date == 0){$search = 0;}else{$search = 1;}
//Partie retours
        $defaultData = array();
        $form = $this->createFormBuilder($defaultData)
            ->add('date', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => false,
                'attr' => array('class' => 'date'),
            ))
            ->getForm();
        $form->handleRequest($request);
        // On vérifie qu'elle est de type POST
        if ($request->getMethod() == 'POST') {
            $data = $form->getData();
            // On vérifie que les valeurs entrées sont correctes
            if ($form->isValid()) {
                $data = $form->getData();
                $date = $data['date'];
                return $this->redirect($this->generateUrl('bacloocrm_retours', array('date' => $date)));
            }
        }
        if(!isset($erreur))
        {
            $erreur = 0;
        }
        //Calcul de la date de sprochains départs
        //Tout d'abord faut éviter les week end
        //On vérifie que demain ne soit pas un samedi ou un dimanche
        $today = date('D');
        if($date == 0)
        {
            $now = date('Y-m-d');
        }
        else
        {
            $now = $date;
        }
        if($search == 1)
        {
            $todays = date('D', strtotime($now));
            if($todays == 'Fri')
            {
                $date = date('Y-m-d', strtotime($date . "+3 days"));
            }
            elseif($todays == 'Sat')
            {
                $date = date('Y-m-d', strtotime($date . "+2 days"));
            }
            elseif($todays == 'Sun')
            {
                $date = date('Y-m-d', strtotime($date . "+1 days"));
            }
            else
            {
                $date = $now;
            }
        }
        else
        {
            if($today == 'Fri')
            {
                $date = date('Y-m-d', strtotime("+3 days"));
            }
            elseif($today == 'Sat')
            {
                $date = date('Y-m-d', strtotime("+2 days"));
            }
            elseif($today == 'Sun')
            {
                $date = date('Y-m-d', strtotime("+1 days"));
            }
            else
            {
                $date = date('Y-m-d');
            }
        }
        if($today == 'Thu')
        {
            $datelivraison = date('Y-m-d', strtotime("+5 days"));
        }
        elseif($today == 'Fri')
        {
            $datelivraison = date('Y-m-d', strtotime("+4 days"));
        }
        elseif($today == 'Sat')
        {
            $datelivraison = date('Y-m-d', strtotime("+3 days"));
        }
        else
        {
            $datelivraison = date('Y-m-d', strtotime("+3 days"));
        }

        if($search == 0)
        {
            $retours = $em->getRepository('BaclooCrmBundle:Locata')
                ->retours($now);

            $retourssl = $em->getRepository('BaclooCrmBundle:Locata')
                ->retourssl($now);
        }
        else
        {
            $retours = $em->getRepository('BaclooCrmBundle:Locata')
                ->retours2($now);

            $retourssl = $em->getRepository('BaclooCrmBundle:Locata')
                ->retourssl2($now);
        }

        $i = 0;
        foreach($retours as $ret)
        {
            foreach($ret->getLocations() as $di )
            {
                $i++;
            }
        }
        $em->clear();
//echo $now;

        foreach($retourssl as $ret)
        {//echo $ret->getId();
            foreach($ret->getLocationssl() as $di )
            {
                $i++;
            }
        }
        $em->clear();

        $retoursplanifies = $em->getRepository('BaclooCrmBundle:Locata')
            ->findByEtatloc('Retour planifié');//c'est une requete du repository

        $a = 0;
        foreach($retoursplanifies as $ret)
        {
            foreach($ret->getLocations() as $di )
            {
                $a++;
            }
        }
        $em->clear();

        $retoursplanifiessl = $em->getRepository('BaclooCrmBundle:Locata')
            ->findByEtatlocsl('Retour planifié');

        // $a = 0;
        foreach($retoursplanifiessl as $ret)
        {
            foreach($ret->getLocationssl() as $di )
            {
                $a++;
            }
        }
        $em->clear();
//Fin partie retours
//Partie Livraisons
        $livraisons = $em->getRepository('BaclooCrmBundle:Locata')
            ->livraisons($datelivraison);

        $livraisonssl = $em->getRepository('BaclooCrmBundle:Locata')
            ->livraisonssl($datelivraison);
        foreach($livraisonssl as $liv)
        {
            $locatafrs  = $em->getRepository('BaclooCrmBundle:Locatafrs')
                ->findOneBy(array('codelocatasl' => $liv->getId(), 'etatbdc' => 1));
            if(isset($locatafrs))
            {
                $liv->setNumbdcloueur($locatafrs->getId());
                $em->persist($liv);
                $em->flush();
            }
        }
// echo $datelivraison;
        //On cherche les machines réservées à passer en location ferme
        $machinesreserves = $em->getRepository('BaclooCrmBundle:Machines')
            ->findBy(array('etat'=> 'Réservé', 'original' => 0, 'debutloc' => $datelivraison));

//		if(isset($machinesreserves))
//		{
//				foreach($machinesreserves as $resa)
//				{
//					$machineclone = $em->getRepository('BaclooCrmBundle:Machines')
//						->findOneBy(array('etat'=> 'Réservé', 'original' => 0, 'debutloc' => $datelivraison, 'code' => $resa->getCode()));
//
//					$machine = $em->getRepository('BaclooCrmBundle:Machines')
//						->findOneBy(array('original' => 1, 'code' => $resa->getCode()));
//
//					$machine->setDebutloc($machineclone->getDebutloc());
//					$machine->setFinloc($machineclone->getFinloc());
//					$machine->setEtat('Prêt au départ');
//					$machine->setEntreprise($machineclone->getEntreprise());
//					$machine->setNomchantier($machineclone->getNomchantier());
//					$machine->setcodelocations($machineclone->getCodelocations());
//					$machine->setcodecontrat($machineclone->getCodecontrat());
//					$machine->setClientid($machineclone->getClientid());
//					$em->persist($machine);
//					$em->remove($machineclone);
//					$em->flush();
//				}
//		}

        $j = 0;
        foreach($livraisons as $liv)
        {
            foreach($liv->getLocations() as $di )
            {
                $j++;
            }
        }
        $em->clear();

        foreach($livraisonssl as $liv)
        {
            foreach($liv->getLocationssl() as $di )
            {
                $j++;
            }
        }
        $em->clear();
// echo $datelivraison;
        $livraisonsok = $em->getRepository('BaclooCrmBundle:Locata')
            ->findByEtatloca('Prêt pour le chargement', 'En cours de livraison', $datelivraison);
// print_r($livraisonsok);
        $livraisonsoksl = $em->getRepository('BaclooCrmBundle:Locata')
            ->findByEtatlocasl('Prêt pour le chargement', 'En cours de livraison', $datelivraison);

        $b = 0;
        foreach($livraisonsok as $ret)
        {
            foreach($ret->getLocations() as $di )
            {
                $b++;
            }
        }

        foreach($livraisonsoksl as $ret)
        {
            foreach($ret->getLocationssl() as $di )
            {
                $b++;
            }
        }
//Fin partie Livraisons
        return $this->render('BaclooCrmBundle:Crm:retours.html.twig', array(
            'retours' => $retours,
            'now' => $now,
            'erreur' => $erreur,
            'retourssl' => $retourssl,
            'retoursplanifies' => $retoursplanifies,
            'retoursplanifiessl' => $retoursplanifiessl,
            'livraisons' => $livraisons,
            'livraisonssl' => $livraisonssl,
            'livraisonsok' => $livraisonsok,
            'livraisonsoksl' => $livraisonsoksl,
            'i' => $i,
            'a' => $a,
            'j' => $j,
            'b' => $b,
            'date' => $date,
            'now' => $now,
            'qrcode' => $qrcode,
            'form' => $form->createView(),
            'datelivraison' => $datelivraison
        ));
    }

    public function repriseAction($codelocata, $codelocations, $ecode, $mode, $datereprise, $vue, Request $request)
    {//echo 'codeloc>>>'; echo $codelocations;echo 'codelocata>>>'; echo $codelocata;echo 'ecode>>>'; echo $ecode;
        $em = $this->getDoctrine()->getManager();
        $qrcode = 0;
        if($mode == 'reprise')
        {
            //Modification du statut dela machine
            $machine = $em->getRepository('BaclooCrmBundle:Machines')
                ->findOneBy(array('codelocations' => $codelocations, 'code' => $ecode ));
            // echo $codelocations;
            $locata = $em->getRepository('BaclooCrmBundle:Locata')
                ->findOneById($codelocata);

            $client = $em->getRepository('BaclooCrmBundle:Fiche')
                ->findOneById($locata->getClientid());


            if(isset($machine))
            {
                $machine->setEtat('Retour planifié');
                $machine->setEtatlog('Retour planifié');
                $em->persist($machine);
            }

            //Modification du statut de la ligne de location
            $location  = $em->getRepository('BaclooCrmBundle:Locations')
                ->findOneById($codelocations);

            if(isset($location))
            {
                $location->setEtatloc('Retour planifié');
                $location->setEtatlog('Retour planifié');
                $location->setDatereprise($datereprise);
                $em->persist($location);
                $em->flush();
            }

            //Majtable logistique
            $logis = $em->getRepository('BaclooCrmBundle:Logisrep')
                ->findOneByEtatlog('Retour planifié');

            //insertion dans la table logistique
            $logistique  = $em->getRepository('BaclooCrmBundle:Logistique')
                ->findOneBy(array('codecontrat' => $codelocata, 'materiel' => $ecode));


            if(empty($logistique))
            {
                $logistique  = new Logistique;
            }
            $logistique->setClient($location->getEntreprise());
            $logistique->setnomchantier($locata->getNomchantier());
            $logistique->setDate($datereprise);
            $logistique->setAdresse1($locata->getAdresse1());
            $logistique->setAdresse2($locata->getAdresse2());
            $logistique->setAdresse3($locata->getAdresse3());
            $logistique->setCp($locata->getCp());
            $logistique->setVille($locata->getVille());
            $logistique->setMateriel($location->getCodemachineinterne());
            $logistique->setTypemateriel($location->getTypemachine());
            $logistique->setContactchantier($locata->getContactchantier());
            $logistique->setCodecontrat($codelocata);
            $logistique->setCodelocations($codelocations);
            $logistique->setTypetransport('Reprise');
            $logistique->setEtatlog('Retour planifié');
            $em->persist($logistique);

            $em->flush();

        }
        elseif($mode == 'reprisesl')
        {
            //Modification du statut dela machinesl
            $machine = $em->getRepository('BaclooCrmBundle:Machinessl')
                ->findOneBy(array('codelocations' => $codelocations));
// echo $codelocations;

            $locata = $em->getRepository('BaclooCrmBundle:Locata')
                ->findOneById($codelocata);

            $client = $em->getRepository('BaclooCrmBundle:Fiche')
                ->findOneById($locata->getClientid());


            if(isset($machine))
            {
                $machine->setEtat('Retour planifié');
                $machine->setEtatlog('Retour planifié');
            }

            //Modification du statut de la ligne de location
            $location  = $em->getRepository('BaclooCrmBundle:Locationssl')
                ->findOneById($codelocations);

            if(isset($location))
            {
                if($location->getTransport() == 1)
                {
                    $location->setEtatloc('Retour planifié');
                    $location->setEtatlog('Retour planifié');
                    $location->setDatereprise($datereprise);
                    if(isset($machine))
                    {
                        $machine->setEtat('Retour planifié');
                        $machine->setEtatlog('Retour planifié');
                    }
                }
                else
                {
                    $location->setEtatloc('Location terminée');
                    $location->setEtatlog('Déposé en agence');
                    $location->setDatereprise($datereprise);
                    if(isset($machine))
                    {
                        $machine->setEtat('Disponible');
                        $machine->setEtatlog('');
                        $machine->setDebutloc('');
                        $machine->setFinloc('');
                        $machine->setEntreprise('');
                        $machine->setNomchantier('13');
                        $machine->setcodelocations('');
                        $machine->setcodecontrat('');
                        $machine->setClientid(0);
                    }
                }
                if(isset($machine))
                {
                    $em->persist($machine);
                }
                $em->persist($location);
                $em->flush();
            }

            if($location->getTransport() == 1)
            {
                //Majtable logistique
                $logis = $em->getRepository('BaclooCrmBundle:Logisrep')
                    ->findOneByEtatlog('Retour planifié');

                //insertion dans la table logistique
                $logistique  = $em->getRepository('BaclooCrmBundle:Logistique')
                    ->findOneBy(array('codelocations' => $codelocations, 'codecontrat' => $codelocata, 'materiel' => $ecode));

                if(!isset($logistique))
                {
                    $logistique  = new Logistique;
                }
                $logistique->setClient($location->getEntreprise());
                $logistique->setnomchantier($locata->getNomchantier());
                $logistique->setDate($datereprise);
                $logistique->setAdresse1($locata->getAdresse1());
                $logistique->setAdresse2($locata->getAdresse2());
                $logistique->setAdresse3($locata->getAdresse3());
                $logistique->setCp($locata->getCp());
                $logistique->setVille($locata->getVille());
                $logistique->setMateriel($location->getCodemachineinterne());
                $logistique->setTypemateriel($location->getTypemachine());
                $logistique->setContactchantier($locata->getContactchantier());
                $logistique->setCodecontrat($codelocata);
                $logistique->setCodelocations($codelocations);
                $logistique->setTypetransport('Reprisesl');
                $logistique->setEtatlog('Retour planifié');

                $em->persist($logistique);

                $em->flush();
            }
        }
        elseif($mode == 'livraisons')
        {

            //Modification du statut dela machine
            $machine = $em->getRepository('BaclooCrmBundle:Machines')
                ->findOneBy(array('codelocations' => $codelocations, 'code' => $ecode));
            $typeloc = 'parc';
            if(!isset($machine))
            {
                $machine = $em->getRepository('BaclooCrmBundle:Machinessl')
                    ->findOneBy(array('codelocations' => $codelocations, 'code' => $ecode));
                $typeloc = 'sl';
            }

            $locata = $em->getRepository('BaclooCrmBundle:Locata')
                ->findOneById($codelocata);
            //echo 'typeloc'.$typeloc;exit();
            if(isset($machine))
            {echo 'isset machine';
                $machine->setEtat('En location');
                $machine->setEtatlog('Livré chez le client');
            }

            $location  = $em->getRepository('BaclooCrmBundle:Locations')
                ->findOneBy(array('id' => $codelocations, 'codemachineinterne' => $ecode));

            if(!isset($location))
            {
                $location = $em->getRepository('BaclooCrmBundle:Locationssl')
                    ->findOneBy(array('id' => $codelocations, 'codemachineinterne' => $ecode));
            }

            if(isset($machine))
            {echo 'machien est set';
                $machine->setEtat('En location');
                $location->setEtatloc('En location');
                if($typeloc == 'sl')
                {
                    if($location->getTransport() == 1)
                    {
                        $location->setEtatlog('Livré chez le client');
                    }
                    else
                    {
                        $location->setEtatlog('Livré chez le client');
                    }
                }
                else
                {
                    $location->setEtatlog('Livré chez le client');
                }
            }
            $em->flush();
            $logis = $em->getRepository('BaclooCrmBundle:Logis')
                ->findOneByEtatlog('Prêt pour le chargement');

            //insertion dans la table logistique
            $logistiqua  = $em->getRepository('BaclooCrmBundle:Logistique')
                ->findOneBy(array('codelocations' => $codelocations, 'codecontrat' => $codelocata, 'materiel' => $ecode));

            if(!isset($logistiqua))
            {
                $logistique  = new Logistique;
                $logistique->setClient($location->getEntreprise());
                $logistique->setnomchantier($locata->getNomchantier());
                $logistique->setDate($datereprise);
                $logistique->setAdresse1($locata->getAdresse1());
                $logistique->setAdresse2($locata->getAdresse2());
                $logistique->setAdresse3($locata->getAdresse3());
                $logistique->setCp($locata->getCp());
                $logistique->setVille($locata->getVille());
                $logistique->setContactchantier($locata->getContactchantier());
                $logistique->setMateriel($location->getCodemachineinterne());
                $logistique->setTypemateriel($location->getTypemachine());
                $logistique->setCodecontrat($codelocata);
                $logistique->setCodelocations($codelocations);
                $logistique->setMemolog($locata->getCommentaire());
                if($typeloc = 'parc')
                {
                    $logistique->setTypetransport('Livraison');
                }
                else
                {
                    $logistique->setTypetransport('Livraisonsl');
                }
                $logistique->setEtatlog('Prêt pour le chargement');
                $logis->addLogistique($logistique);

                $em->persist($logistique);
                $em->persist($logis);
                $em->flush();
            }
            else
            {
                $logistiqua->setClient($location->getEntreprise());
                $logistiqua->setnomchantier($locata->getNomchantier());
                $logistiqua->setDate($datereprise);
                $logistiqua->setAdresse1($locata->getAdresse1());
                $logistiqua->setAdresse2($locata->getAdresse2());
                $logistiqua->setAdresse3($locata->getAdresse3());
                $logistiqua->setCp($locata->getCp());
                $logistiqua->setVille($locata->getVille());
                $logistiqua->setContactchantier($locata->getContactchantier());
                $logistiqua->setMateriel($location->getCodemachineinterne());
                $logistiqua->setTypemateriel($location->getTypemachine());
                $logistiqua->setCodecontrat($codelocata);
                $logistiqua->setCodelocations($codelocations);
                if($typeloc = 'parc')
                {
                    $logistiqua->setTypetransport('Livraison');
                }
                else
                {
                    $logistiqua->setTypetransport('Livraisonsl');
                }
                $logistiqua->setEtatlog('Prêt pour le chargement');
                $em->persist($logistiqua);
                $em->flush();
            }
        }
        $em->flush();


        if($vue === 'planning')
        {
//            return $this->redirect($this->generateUrl('bacloocrm_planning', array('openModal' => 'false', 'event_id' => 0)));
            return $this->redirect($this->generateUrl('bacloocrm_planning', array('openModal' => 'true', 'event_id' => $locata->getId())));
        }
        elseif($vue === 'planningsl')
        {
//            return $this->redirect($this->generateUrl('bacloocrm_planningsl', array('openModal' => 'false', 'event_id' => 0)));
            return $this->redirect($this->generateUrl('bacloocrm_planningsl', array('openModal' => 'true', 'event_id' => $locata->getId())));
        }
        elseif($vue === 'contrat')
        {
//            return $this->redirect($this->generateUrl('bacloocrm_planningsl', array('openModal' => 'false', 'event_id' => 0)));
//            return $this->redirect($this->generateUrl('bacloocrm_planningsl', array('openModal' => 'true', 'event_id' => $locata->getId())));
            return $this->redirect($this->generateUrl('bacloocrm_ajouterlocation', array('ficheid' => $locata->getClientid(), 'locid' => $locata->getId())));
        }
        else
        {
            // On redirige vers la page de visualisation de la fiche nouvellement créée
            return $this->redirect($this->generateUrl('bacloocrm_retours', array('vue' => $vue )));
        }

    }

    public function preparationAction($codelocations, $ecode, $mode, $vue, Request $request)
    {
        $em = $this->getDoctrine()->getManager();
        $location  = $em->getRepository('BaclooCrmBundle:Locations')
            ->findOneById($codelocations);

        // Get the query builder for the Locata entity
        $qb = $em->createQueryBuilder();
        $qb->select('l')
            ->from('BaclooCrmBundle:Locata', 'l')
            ->leftJoin('l.locations', 'loc')
            ->addSelect('loc');
        $qb->where('loc.id = :locationsId')
            ->setParameter('locationsId', $codelocations);
        $locata = $qb->getQuery()->getSingleResult();
//echo 'idd'.$locata->getId();exit();
        //Modification du statut dela machine
        if($mode == 'Inspection')
        {//echo 'ici?';echo $ecode;
            $machine = $em->getRepository('BaclooCrmBundle:Machines')
                ->findOneBy(array('code'=> $ecode, 'original'=> 1, 'codelocations' => $codelocations));
            if(isset($machine))
            {//echo 'machine?';
                //Majtable logistique
                $logistique  = $em->getRepository('BaclooCrmBundle:Logistique')
                    ->findOneBy(array('codelocations' => $codelocations, 'materiel' => $ecode));
//echo $machine->getCode();
                if(isset($logistique))
                {
                    $em->remove($logistique);
                }

                //Modification du statut de la ligne de location
                $location  = $em->getRepository('BaclooCrmBundle:Locations')
                    ->findOneById($codelocations);

                if(isset($location))
                {
                    $location->setEtatloc('Location terminée');
                    $location->setEtatlog('Location terminée');
                }
                $machine->setEtat('Inspection');
                $machine->setEtatlog('Déposé en agence');
                // $machine->setCodelocations(NULL);
                $machine->setDebutloc(NULL);
                $machine->setFinloc(NULL);
                $machine->setCodelocations(NULL);
                $machine->setCodecontrat(NULL);
                $machine->setClientid(0);
                $machine->setNomchantier('');
                $machine->setEntreprise('');
                //Majtable logistique
                $logistiquerep  = $em->getRepository('BaclooCrmBundle:Logistiquerep')
                    ->findOneBy(array('codelocations' => $codelocations, 'materiel' => $ecode));
                if(isset($logistiquerep))
                {
                    $em->remove($logistiquerep);
                }
            }
        }
        elseif($mode == 'Disponible')
        {
            $query = $em->createQuery(
                'SELECT f
				FROM BaclooCrmBundle:Machines f
				WHERE f.code = :code
				AND f.original = :original'
            );
            $query->setParameter('code', $ecode);
            $query->setParameter('original', 1);
            $machine = $query->getOneOrNullResult();

            //Majtable logistique
            $logistique  = $em->getRepository('BaclooCrmBundle:Logistique')
                ->findOneBy(array('materiel' => $ecode));
            if(isset($logistique))
            {
                $em->remove($logistique);
                $em->flush();
            }
            //Modification du statut de la ligne de location
            $location  = $em->getRepository('BaclooCrmBundle:Locations')
                ->findOneById($codelocations);

            if(isset($location))
            {
                $location->setEtatloc('Location terminée');
                $location->setEtatlog('Location terminée');
                $em->persist($location);
            }
            if(isset($machine))
            {

//                $machineclone = $em->getRepository('BaclooCrmBundle:Machines')
//                    ->findOneBy(array('code'=> $ecode, 'original' => 0, 'codelocations' => $codelocations));
//                if(isset($machineclone))
//                {
//                    $clonedebutloc = $machineclone->getDebutloc();
//                    $today = date('Y-m-d');
//                    $diff = abs(strtotime($clonedebutloc) - strtotime($today));
//                    $nbjrsdiff = $diff/86400;
//                    if($nbjrsdiff > 3)
//                    {
                        $machine->setEtat('Disponible');
                        $machine->setDebutloc('');
                        $machine->setFinloc('');
                        $machine->setEntreprise('');
                        $machine->setNomchantier('14');
                        $machine->setcodelocations('');
                        $machine->setcodecontrat('');
                        $machine->setClientid(0);
                        $em->persist($machine);
                        $em->flush();
//                    }
//                    else
//                    {
//                        $machine->setDebutloc($machineclone->getDebutloc());
//                        $machine->setFinloc($machineclone->getFinloc());
//                        $machine->setEtat('Réservé');
//                        $machine->setEntreprise($machineclone->getEntreprise());
//                        $machine->setNomchantier($machineclone->getNomchantier());
//                        $machine->setcodelocations($machineclone->getCodelocations());
//                        $machine->setcodecontrat($machineclone->getCodecontrat());
//                        $machine->setClientid($machineclone->getClientid());
//                        $em->persist($machine);
//                        $em->remove($machineclone);
//                        $em->flush();
//
//                        $location2  = $em->getRepository('BaclooCrmBundle:Locations')
//                            ->findOneById($machineclone->getCodelocations());
//                        $location2->setMachineid($machine->getId());
//                        $em->persist($location2);
//                        $em->flush();//echo 'tt'.$location2->getId();exit();
//                        $em->remove($machineclone);
//                        $em->flush();
//                    }
//                }
//                else
//                {
//                    $machine->setEtat('Disponible');
//                    $machine->setDebutloc('');
//                    $machine->setFinloc('');
//                    $machine->setEntreprise('');
//                    $machine->setNomchantier('15');
//                    $machine->setcodelocations('');
//                    $machine->setcodecontrat('');
//                    $machine->setClientid(0);
//                    $em->persist($machine);
//                }
                //Majtable logistique
                $logistiquerep  = $em->getRepository('BaclooCrmBundle:Logistiquerep')
                    ->findOneBy(array('codelocations' => $codelocations, 'materiel' => $ecode));
                if(isset($logistiquerep))
                {
                    $em->remove($logistiquerep);
                }
            }
            else
            {
                //Modification du statut de la ligne de location
                $location  = $em->getRepository('BaclooCrmBundle:Locations')
                    ->findOneById($codelocations);

                if(isset($location))
                {
                    $location->setEtatloc('Location terminée');
                    $em->persist($location);
                }
            }

        }
        elseif($mode == 'Enpanne')
        {
            $query = $em->createQuery(
                'SELECT f
				FROM BaclooCrmBundle:Machines f
				WHERE f.code = :code
				AND f.original = :original'
            );
            $query->setParameter('code', $ecode);
            $query->setParameter('original', 1);
            $machine = $query->getOneOrNullResult();

            if(isset($machine))
            {
                $machine->setEtat('En panne');
                $machine->setDebutloc('');
                $machine->setFinloc('');
                $machine->setEntreprise('');
                $machine->setNomchantier('16');
                $machine->setcodelocations('');
                $machine->setcodecontrat('');
                $machine->setClientid(0);
                $em->persist($machine);
                $em->flush();
                //Majtable logistique

                $logistique  = $em->getRepository('BaclooCrmBundle:Logistique')
                    ->findOneBy(array('codelocations' => $codelocations, 'materiel' => $ecode));

                if(isset($logistique))
                {
                    $em->remove($logistique);
                }

                //Modification du statut de la ligne de location
                $location  = $em->getRepository('BaclooCrmBundle:Locations')
                    ->findOneById($codelocations);

                if(isset($location))
                {
                    $location->setEtatloc('Location terminée');
                    $location->setEtatlog('Location terminée');
                }

                //Majtable logistique
                $logistiquerep  = $em->getRepository('BaclooCrmBundle:Logistique')
                    ->findOneBy(array('codelocations' => $codelocations, 'materiel' => $ecode));
                if(isset($logistiquerep))
                {
                    $em->remove($logistiquerep);
                }
            }
        }

        $em->flush();


        if($vue == 'planning')
        {
            return $this->redirect($this->generateUrl('bacloocrm_planning', array('openModal' => 'true', 'event_id' => $locata->getId())));
        }
        elseif($vue == 'planningsl')
        {
            return $this->redirect($this->generateUrl('bacloocrm_planningsl', array('openModal' => 'true', 'event_id' => $locata->getId())));
        }
        elseif($vue === 'contrat')
        {
            return $this->redirect($this->generateUrl('bacloocrm_ajouterlocation', array('ficheid' => $locata->getClientid(), 'locid' => $locata->getId())));
        }
        else
        {
            return $this->redirect($this->generateUrl('bacloocrm_ajouterlocation', array('ficheid' => $locata->getClientid(), 'locid' => $locata->getId(), 'erreur' => $vue)));
        }

    }

    public function modiflivraisonsAction($codecont, $codelocations, $ecode, $mode, Request $request)
    {
        $em = $this->getDoctrine()->getManager();

        //Modification du statut dela machine
        if($mode == 'annuler')
        {
            $machine = $em->getRepository('BaclooCrmBundle:Machines')
                ->findOneBy(array('code'=> $ecode, 'original'=> 1, 'codelocations' => $codelocations));
            if(!isset($machine))
            {
                $machine = $em->getRepository('BaclooCrmBundle:Machinessl')
                    ->findOneBy(array('code'=> $ecode, 'original'=> 1, 'codelocations' => $codelocations));
            }

            if(isset($machine))
            {
                $codelocata = $machine->getCodecontrat();
                $machine->setEtat('Disponible');
                $machine->setCodelocations(NULL);
                $machine->setDebutloc('');
                $machine->setFinloc('');
                $machine->setCodecontrat(NULL);
                $machine->setClientid(NULL);
                $machine->setNomchantier('');
                $machine->setEntreprise('');
                $machine->setEtatlog('');
            }

            //Modification du statut de la ligne de location
            $location  = $em->getRepository('BaclooCrmBundle:Locations')
                ->findOneBy(array('codemachineinterne'=> $ecode, 'id' => $codelocations));

            if(!isset($location))
            {
                $location  = $em->getRepository('BaclooCrmBundle:Locationssl')
                    ->findOneBy(array('codemachineinterne'=> $ecode, 'id' => $codelocations));
            }

            if(isset($location))
            {
                // $em->remove($locations);
                $location->setMachineid(0);
                $location->setCodemachineinterne('');
                $location->setEtatloc('');
                $location->setEtatlog('');
                $em->persist($location);
            }
            $locata  = $em->getRepository('BaclooCrmBundle:Locata')
                ->findOneById($codelocata);

            $locata->setBdcrecu(0);
            $locata->setContrat(0);

            //Suppression de la ligne logistique
            $logistique  = $em->getRepository('BaclooCrmBundle:Logistique')
                ->findBy(array('materiel' => $ecode, 'codelocations' => $codelocations));

            if(isset($logistique))
            {
                foreach($logistique as $logi)
                {
                    $em->remove($logi);
                }
            }
//
//            $logistiquerep  = $em->getRepository('BaclooCrmBundle:Logistiquerep')
//                ->findOneBy(array('materiel' => $ecode, 'codelocations' => $codelocations));
//
//            if(isset($logistiquerep))
//            {
//                $em->remove($logistiquerep);
//            }
//            $em->flush();
        }
        $em->flush();


        // On redirige vers la page de visualisation de la fiche nouvellement créée
        return $this->redirect($this->generateUrl('bacloocrm_retours'));

    }

    public function reportlivraisonsAction($codecont, $codelocations, $ecode, $erreur, Request $request)
    {
        $usersess = $this->get('security.context')->getToken()->getUsername();
        $em = $this->getDoctrine()->getManager();
// echo 'codelocaation'.$codelocations;echo '***';echo $ecode;
        $locations  = $em->getRepository('BaclooCrmBundle:Locations')
            ->findOneBy(array('id' => $codelocations, 'codemachineinterne' => $ecode));
        // echo 'IDX';echo $locations->getEntid();echo '<<<<';
        if(!isset($locations))
        {
            $locations  = $em->getRepository('BaclooCrmBundle:Locationssl')
                ->findOneBy(array('id' => $codelocations, 'codemachineinterne' => $ecode));
        }
        $defaultData = array();
        $form = $this->createFormBuilder($defaultData)
            ->add('du', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => false,
                'attr' => array('class' => 'date'),
            ))
            ->add('au', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => false,
                'attr' => array('class' => 'date'),
            ))
            ->getForm();
        $form->handleRequest($request);
        // On vérifie qu'elle est de type POST
        if ($request->getMethod() == 'POST')
        {
            $data = $form->getData();
            // On vérifie que les valeurs entrées sont correctes
            if($form->isValid()){
                $data = $form->getData();
                $debutloc = $data['du'];
                $finloc = $data['au'];
                $today = date('Y-m-d');

                $machin = $em->getRepository('BaclooCrmBundle:Machines')
                    ->findOneBy(array('code'=> $ecode, 'codelocations'=> $codelocations));
                $typeloc = 'parc';
                if(!isset($machin))
                {
                    $machin = $em->getRepository('BaclooCrmBundle:Machinessl')
                        ->findOneBy(array('code'=> $ecode, 'codelocations'=> $codelocations));
                    $typeloc = 'sl';
                }
                $locations->setDebutloc($debutloc);
                $locations->setFinloc($finloc);
                if($typeloc == 'parc')
                {
                    $locations->setEtatloc('Réservé');
                    $machin->setEtat('Réservé');
                }
                else
                {
                    $locations->setEtatloc('Prêt au départ');
                    $machin->setEtat('Prêt au départ');
                }
                $machin->setDebutloc($debutloc);
                $machin->setFinloc($finloc);
                $em->persist($machin);
                $em->persist($locations);
                $em->flush();

                // On redirige vers la page de visualisation de la fiche nouvellement créée
                return $this->redirect($this->generateUrl('bacloocrm_reportlivraisons', array('codecont' => $codecont, 'codelocations' => $codelocations, 'ecode' => $ecode, 'erreur' => 0)));
            }
        }
        if(!isset($erreur)){$erreur = 0;}
        // echo 'ID';echo $locations->getEntid();
        return $this->render('BaclooCrmBundle:Crm:reportlivraisons.html.twig', array(
            'codelocations' => $codelocations,
            'codecont' => $codecont,
            'ecode' => $ecode,
            'erreur' => $erreur,
            'user' => $usersess,
            'id' => $locations->getCodeclient(),
            'entreprise' => $locations->getEntreprise(),
            'du' => $locations->getdebutloc(),
            'au' => $locations->getFinloc(),
            'contrat' => 1,
            'form' => $form->createView()
        ));
    }

    public function tcardAction($mode, Request $request)
    {
        $em = $this->getDoctrine()->getManager();
        // $machines = $em->getRepository('BaclooCrmBundle:Machines')
        // ->findAll();

        $user = $this->get('security.context')->getToken()->getUsername();
        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($user);
        $roleuser = $userdetails->getRoleuser();

        $defaultData = array();
        $form = $this->createFormBuilder($defaultData)
            ->add('filtre', 'choice', array(
                'choices'   => array(
                    'all'   => 'Tout afficher',
                    'vgp'   => 'VGP à faire',
                    'maintenance' => 'Maintenance',
                ),
                'multiple'  => false,
            ))
            ->getForm();
        $form->handleRequest($request);
        if($form->isValid()) {
            $data = $form->getData();
            $mode = $data['filtre'];
            if(isset($mode) && $mode == 'vgp')
            {
                return $this->redirect($this->generateUrl('bacloocrm_tcard', array('mode' => 'vgp' )));
            }
            elseif(isset($mode) && $mode == 'maintenance')
            {
                return $this->redirect($this->generateUrl('bacloocrm_tcard', array('mode' => 'maintenance' )));
            }
            elseif(isset($mode) && $mode == 'Hors Usage')
            {
                return $this->redirect($this->generateUrl('bacloocrm_tcard', array('mode' => 'Hors Usage' )));
            }
            elseif(isset($mode) && $mode == 'Indsiponible')
            {
                return $this->redirect($this->generateUrl('bacloocrm_tcard', array('mode' => 'Indisponible' )));
            }
            elseif(isset($mode) && $mode == 'Pièce')
            {
                return $this->redirect($this->generateUrl('bacloocrm_tcard', array('mode' => 'Pièce' )));
            }
            elseif(isset($mode) && $mode == 'Vendu')
            {
                return $this->redirect($this->generateUrl('bacloocrm_tcard', array('mode' => 'Vendu' )));
            }
            elseif(isset($mode) && $mode == 'Volé')
            {
                return $this->redirect($this->generateUrl('bacloocrm_tcard', array('mode' => 'Volé' )));
            }
        }

        if($mode =='vgp')
        {
            $datevgp = date('Y-m-d', strtotime("+20 days"));
            $query = $em->createQuery(
                'SELECT f.codegenerique
				FROM BaclooCrmBundle:Machines f
				Group By f.codegenerique'
            );
            $machines = $query->getArrayResult();
            $macha = array();
            $allecodes = array();
            foreach($machines as $mach)
            {
                $m = $mach['codegenerique'];
                $query = $em->createQuery(
                    'SELECT f
				FROM BaclooCrmBundle:Machines f
				WHERE f.codegenerique = :codegenerique
				AND f.prochaineVgp <= :prochaineVgp
				Order By f.code ASC'
                );
                $query->setParameter('codegenerique', $mach['codegenerique']);
                $query->setParameter('prochaineVgp', $datevgp);
                $ecodes = $query->getResult();
                $allecodes[$m] = $ecodes;
            }

            if(empty($allecodes))
            {
                $compte = 0;
            }
            else
            {
                $compte = count(max($allecodes));
            }

        }
        elseif($mode == 'maintenance')
        {
            $datemaintenance = date('Y-m-d', strtotime("+20 days"));
            $query = $em->createQuery(
                'SELECT f.codegenerique
				FROM BaclooCrmBundle:Machines f
				Group By f.codegenerique'
            );
            $machines = $query->getArrayResult();
            $macha = array();
            $allecodes = array();
            foreach($machines as $mach)
            {
                $m = $mach['codegenerique'];
                $query = $em->createQuery(
                    'SELECT f
				FROM BaclooCrmBundle:Machines f
				WHERE f.codegenerique = :codegenerique
				AND f.prochaineRevision <= :prochaineRevision
				Order By f.code ASC'
                );
                $query->setParameter('codegenerique', $mach['codegenerique']);
                $query->setParameter('prochaineRevision', $datemaintenance);
                $ecodes = $query->getResult();
                $allecodes[$m] = $ecodes;
            }

            if(empty($allecodes))
            {
                $compte = 0;
            }
            else
            {
                $compte = count(max($allecodes));
            }
        }
        elseif($mode != 'all' and $mode != 'Location')
        {
            $datemaintenance = date('Y-m-d', strtotime("+20 days"));
            $query = $em->createQuery(
                'SELECT f.codegenerique
				FROM BaclooCrmBundle:Machines f
				Group By f.codegenerique'
            );
            $machines = $query->getArrayResult();
            $macha = array();
            $allecodes = array();
            foreach($machines as $mach)
            {
                $m = $mach['codegenerique'];
                $query = $em->createQuery(
                    'SELECT f
				FROM BaclooCrmBundle:Machines f
				WHERE f.codegenerique = :codegenerique
				AND f.etat = :etat
				Order By f.code ASC'
                );
                $query->setParameter('codegenerique', $mach['codegenerique']);
                $query->setParameter('etat', $mode);
                $ecodes = $query->getResult();
                $allecodes[$m] = $ecodes;
            }

            if(empty($allecodes))
            {
                $compte = 0;
            }
            else
            {
                $compte = count(max($allecodes));
            }
        }
        elseif($mode == 'Location')
        {
            $datemaintenance = date('Y-m-d', strtotime("+20 days"));
            $query = $em->createQuery(
                'SELECT f.codegenerique
				FROM BaclooCrmBundle:Machines f
				Group By f.codegenerique'
            );
            $machines = $query->getArrayResult();
            $macha = array();
            $allecodes = array();
            foreach($machines as $mach)
            {
                $m = $mach['codegenerique'];
                $query = $em->createQuery(
                    'SELECT f
				FROM BaclooCrmBundle:Machines f
				WHERE f.codegenerique = :codegenerique
				AND f.etat != :etat1 and f.etat != :etat2 and f.etat != :etat3 and f.etat != :etat4 and f.etat != :etat5
				Order By f.code ASC'
                );
                $query->setParameter('codegenerique', $mach['codegenerique']);
                $query->setParameter('etat1', 'Hors Usage');
                $query->setParameter('etat2', 'Indisponible');
                $query->setParameter('etat3', 'Pièce');
                $query->setParameter('etat4', 'Vendu');
                $query->setParameter('etat5', 'Volé');
                $ecodes = $query->getResult();
                $allecodes[$m] = $ecodes;
            }

            if(empty($allecodes))
            {
                $compte = 0;
            }
            else
            {
                $compte = count(max($allecodes));
            }
        }
        else
        {
            $query = $em->createQuery(
                'SELECT f.codegenerique
				FROM BaclooCrmBundle:Machines f
				Group By f.codegenerique'
            );
            $machines = $query->getArrayResult();
            $macha = array();
            $allecodes = array();
            foreach($machines as $mach)
            {
                $m = $mach['codegenerique'];
                $query = $em->createQuery(
                    'SELECT f
				FROM BaclooCrmBundle:Machines f
				WHERE f.codegenerique = :codegenerique
				Order By f.code ASC'
                );
                $query->setParameter('codegenerique', $mach['codegenerique']);
                $ecodes = $query->getResult();
                $allecodes[$m] = $ecodes;
            }

            if(empty($allecodes))
            {
                $compte = 0;
            }
            else
            {
                $compte = count(max($allecodes));
            }
        }

        $totalparc = $em->getRepository('BaclooCrmBundle:Machines')
            ->totalparc(); //echo 'totalparc : '.$totalparc;

        return $this->render('BaclooCrmBundle:Crm:tcard.html.twig', array(
            'compte' => $compte,
            'mode' => $mode,
            'totalparc' => $totalparc,
            'allecodes' => $allecodes,
            'user' => $user,
            'roleuser' => $roleuser,
            'form' => $form->createView()
        ));
    }

    public function machinesAction($machineid, Request $request)
    {//echo $machineid;
        $user = $this->get('security.context')->getToken()->getUsername();
        $today = date('Y-m-d');
        $em = $this->getDoctrine()->getManager();
        $qrcode = 0;
        $new = 0;
        if($machineid == 0)
        {
            $machine = new Machines;
            $last5loc = 0;
            $codemachine = '';
            $new = 1;
            $depenses = 0;
        }
        else
        {
            $machine  = $em->getRepository('BaclooCrmBundle:Machines')
                ->findOneById($machineid);
            $codemachine = $machine->getCode();
            $last5loc  = $em->getRepository('BaclooCrmBundle:Locata')
                ->last5loc($machineid);
        }
        $form = $this->createForm(new MachinesType(), $machine);
        $request = $this->get('request');
        if($request->getMethod() == 'POST')
        {
            $form->bind($request);
            if($form->isValid())
            {
                $em->persist($machine);
                $em->flush();

                $codemachine = $form->get('code')->getData();
                $machine  = $em->getRepository('BaclooCrmBundle:Machines')
                    ->findOneByCode($codemachine);
                $machineid = $machine->getId();

                return $this->redirect($this->generateUrl('bacloocrm_machines', array('machineid' => $machineid)));
            }
        }
    
		if($new == 0)
		{
	        //Calcul nbmois credits restants
	        $date1 = date('Y-m-d');
	        $date2 = $machine->getDatefincredit();
	
	        $ts1 = strtotime($date1);
	        $ts2 = strtotime($date2);
	
	        $year1 = date('Y', $ts1);
	        $year2 = date('Y', $ts2);
	
	        $month1 = date('m', $ts1);
	        $month2 = date('m', $ts2);
	
	        $nbmois = (($year2 - $year1) * 12) + ($month2 - $month1);//echo 'nbmois'.$nbmois;
	        $caprestantdu = ($nbmois * $machine->getCoutmensuel()) + $machine->getVr();//echo 'nbmois'.$nbmois;echo 'cmmmm'.$machine->getCoutmensuel();echo 'mvr'.$machine->getVr();echo 'restandu'.$caprestantdu;
	        $machine->setCaprestantdu($caprestantdu);
	        $em->persist($machine);
	        $em->flush();
		}

        $depenses = 0;
        if($new == 0)
        {
            foreach($machine->getDepensesmachine() as $mach)
            {
                $depenses += $mach->getTotalht();
            }
        }

        $vendas  = $em->getRepository('BaclooCrmBundle:Venda')
            ->ventesmachine($machine->getCode());
        $recettes = 0;
        if($new == 0)
        {
            foreach($vendas as $venda)
            {
                foreach($venda->getVentes() as $ven)
                {
                    if($ven->getCodemachineinterne() == $machine->getCode())
                    {
                        $recettes += $ven->getMontantvente();
                    }
                }
            }
        }

        $locatas = $em->getRepository('BaclooCrmBundle:Locata')
            ->locsmachine($machine->getCode());
        $recetteslocation = 0;
        if($new == 0)
        {
            foreach($locatas as $locata)
            {
                foreach($locata->getLocations() as $loca)
                {
                    if($loca->getCodemachineinterne() == $machine->getCode())
                    {
                        $recetteslocation += $loca->getMontantloc();
                    }
                }
            }
        }

        $documents  = $em->getRepository('BaclooCrmBundle:Document')
            ->findBy(array('codecontrat' => $machineid, 'type' => 'machine'));
        // echo '&&&&'.$machineid;
        $previous = $this->get('request')->server->get('HTTP_REFERER');
        return $this->render('BaclooCrmBundle:Crm:machines.html.twig', array('form' => $form->createView(),
            'date' => $today,
            'codemachine' => $codemachine,
			'machine' => $machine,
            'machineid' => $machineid,
            'previous' => $previous,
            'last5loc' => $last5loc,
            'qrcode' => $qrcode,
            'documents' => $documents,
			'depenses' => $depenses,
			'recettes' => $recettes,
			'recetteslocation' => $recetteslocation,
            'user' => $user));
    }

    public function qrcodeAction($codemachine)
    {
        return $this->render('BaclooCrmBundle:Crm:qrcode.html.twig', array('codemachine' => $codemachine));
    }

    public function transporteurAction($codemachine, $etatlog, $latitude, $longitude, $mode, $codelocation, Request $request)
    {
        $codemachine = $request->get('codemachine');//echo $codemachine;
        $latitude = $request->get('lat');//echo 'xxx'.$latitude;
        $longitude = $request->get('long');//echo 'yyy'.$longitude;
        $etatlog = $request->get('etatlog');//var_dump($etatlog);
        $user = $this->get('security.context')->getToken()->getUsername();
        $em = $this->getDoctrine()->getManager();
        $usersess  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($user);
        //Protect double connexion
        $session = $request->getSession();
        $sessionId = $session->getId();
        if($usersess->getLogged() != $sessionId)
        {
            return $this->redirect($this->generateUrl('fos_user_security_logout'));
        }

        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($user);
        $roleuser = $userdetails->getRoleuser();

        $machines  = $em->getRepository('BaclooCrmBundle:Machines')
            ->findOneBy(array('code'=> $codemachine, 'original'=> 1, 'codelocations' => $codelocation));
        $style = 'parc';
        if(empty($machines))
        {//echo 'machinessl';
            $machines  = $em->getRepository('BaclooCrmBundle:Machinessl')
                ->findOneBy(array('code'=> $codemachine, 'original'=> 1, 'codelocations' => $codelocation));
            $style = 'sl';
        }
        $codelocations = $codelocation;
        //echo 'codeloc'.$codelocations;echo 'ecode'.$codemachine;
        $locations  = $em->getRepository('BaclooCrmBundle:Locations')
            ->findOneBy(array('id' => $codelocations, 'codemachineinterne' => $codemachine));
// echo 'XX'.$locations->getId();echo 'yy'.$locations->getCodemachine();
        if(empty($locations))
        {//echo 'SSL';echo '<<<';
            $locations  = $em->getRepository('BaclooCrmBundle:Locationssl')
                ->findOneBy(array('id' => $codelocations, 'codemachineinterne' => $codemachine));
        }
        else{//echo 'pas empty loc parc';
        }

        //Majtable logistique
        $logistiquelivr  = $em->getRepository('BaclooCrmBundle:Logistique')
            ->findOneBy(array('codelocations' => $codelocations, 'materiel' => $codemachine));

        //Majtable logistique
        $logistiquerep  = $em->getRepository('BaclooCrmBundle:Logistique')
            ->findOneBy(array('codelocations' => $codelocations, 'materiel' => $codemachine));

        // $etatloga = (string)$etatlog;
        // echo 'xxxxxxxx'.gettype$etatloga.'xxxxxxxxxxx';
        if($etatlog == 'xxx')
        {//echo '1'.$etatlog;
        }
        elseif($etatlog == 'Livré')
        {echo 'xx2xx';
            if(isset($machines))
            {
                $machines->setEtatlog('Livré chez le client');
                $machines->setEtat('En location');
                $machines->setLatitude($latitude);
                $machines->setLongitude($longitude);
                $em->persist($machines);
            }
            $locations->setEtatlog('Livré chez le client');
            $em->persist($locations);
            if($style == 'sl')
            {
                if(isset($logistiquelivr))
                {
                    $em->remove($logistiquelivr);
                    $em->flush();
                }
            }
            else
            {
                if(isset($logistiquelivr))
                {
                    if($mode == 'qr0')
                    {//echo 'qr0';
                        $em->remove($logistiquelivr);
                        $em->flush();
                    }
                    else
                    {//echo 'remove';
                        $logistiquelivr->setEtatlog('Livré chez le client');
                        $em->remove($logistiquelivr);
                        $em->flush();
                    }
                }

            }
            $em->flush();
        }
        elseif($etatlog == 'Recupere')
        {//echo '3';
            if(isset($machines))
            {
                $machines->setEtat('Retour planifié');
                $machines->setEtatlog('En route vers agence');
                $em->persist($machines);
            }
            $locations->setEtatlog('En route vers agence');
            $em->persist($locations);
            if($style == 'sl')
            {
                if(isset($logistiquerep))
                {
                    $em->remove($logistiquerep);
                }
            }
            else
            {
                if($mode == 'qr0') {
                    $em->remove($logistiquerep);
                }
                else
                {
//                    $logis->setEtatlog('En route vers agence');
                    $em->persist($logistiquerep);
                }
            }
            $em->flush();

        }
        elseif($etatlog == 'Déposé_en_agence')
        {
            if($mode == 'qr0')
            {
                // echo 'QR00000';
                // echo $machines->getCode();
                // echo 'matos logisrep';echo $logis->getMateriel();
                if(isset($machines))
                {
                    $machines->setEtatlog('Déposé en agence');
                    $machines->setLatitude($latitude);
                    $machines->setLongitude($longitude);
                    $em->persist($machines);
                }
                $locations->setEtatlog('Déposé en agence');
                $locations->setEtatloc('Location terminée');
                $em->persist($locations);
                if(isset($logistiquerep))
                {
                    $em->remove($logistiquerep);
                }
                $em->flush();
            }
            else
            {
                if(isset($machines))
                {
                    $machines->setEtatlog('Déposé en agence');
                    $machines->setLatitude($latitude);
                    $machines->setLongitude($longitude);
                    $em->persist($machines);
                }
                $locations->setEtatlog('Déposé en agence');
                $em->persist($locations);
                $em->remove($logistiquerep);
                $em->flush();
            }
            //Réinitialisation de la table machine
            if(isset($machines))
            {
                $machines->setCodelocations(NULL);
                $machines->setCodecontrat(NULL);
                $machines->setClientid(0);
                $machines->setEntreprise(NULL);
                $machines->setNomchantier('18');
                $machines->setDebutloc(NULL);
                $machines->setFinloc(NULL);
                $machines->setEtat('Disponible');
                $em->persist($machines);
                $em->flush();
            }
        }
        elseif($etatlog == 'En_cours_de_livraison')
        {
            if(isset($machines))
            {
                $machines->setEtatlog('En cours de livraison');
                $em->persist($machines);
            }
            $locations->setEtatlog('En cours de livraison');
            $em->persist($locations);
            $logistiquelivr->setEtatlog('En cours de livraison');
            $em->persist($logistiquelivr);
            $em->flush();
        }
        // echo '***';
// echo $mode;
        // echo 'xxxxx';
        //Faire la modif sur l'état de la machine en fonction de l'état de la livraison
        if($mode == 'transporteur')
        {
            if(!isset($machines))
            {
                $machines = 0;
            }
            return $this->render('BaclooCrmBundle:Crm:transporteur.html.twig', array('codemachine' => $codemachine,
                'roleuser' => $roleuser,
                'machines' => $machines
            ));
        }
        else
        {
            if($vue == 'planning')
            {
                return $this->redirect($this->generateUrl('bacloocrm_planning'));
            }
            if($vue == 'planningsl')
            {
                return $this->redirect($this->generateUrl('bacloocrm_planningsl'));
            }
            else
            {
                return $this->redirect($this->generateUrl('bacloocrm_retours'));
            }
        }
    }

    public function mapsAction($latitude, $longitude)
    {
        return $this->render('BaclooCrmBundle:Crm:maps.html.twig', array(
            'latitude' => $latitude,
            'longitude' => $longitude
        ));
    }

    public function dispatchtransportAction($formnum)
    {
        $usersess = $this->get('security.context')->getToken()->getUsername();
        $pdfObj = $this->get("white_october.tcpdf")->create();
        $em = $this->getDoctrine()->getManager();
        $qrcode = 0;
        $logisrep = $em->getRepository('BaclooCrmBundle:Logisrep')
            ->findOneByEtatlog('Retour planifié');

        if($qrcode == 0)
        {
            $daterecup = date('Y-m-d', strtotime("-1 days"));
            $query = $em->createQuery(
                'SELECT f
				FROM BaclooCrmBundle:Logistiquerep f
				WHERE f.date <= :date'
            );
            $query->setParameter('date', $daterecup);
            $logistiquerepa  = $query->getResult();

            foreach($logistiquerepa as $logistiquerep)
            {
                $em->remove($logistiquerep);
                $em->flush();
            }

            $query = $em->createQuery(
                'SELECT f
				FROM BaclooCrmBundle:Logistique f
				WHERE f.date <= :date'
            );
            $query->setParameter('date', $daterecup);
            $logistiqueliva  = $query->getResult();

            foreach($logistiqueliva as $logistiqueliv)
            {
                $em->remove($logistiqueliv);
                $em->flush();
            }
        }

        $logis = $em->getRepository('BaclooCrmBundle:Logis')
            ->findOneByEtatlog('Prêt pour le chargement');
        // echo $logis;
        $form2 = $this->createForm(new LogisType(), $logis);
        $form1 = $this->createForm(new LogisrepType(), $logisrep);

        // On récupère la requête
        $request = $this->get('request');
        // On vérifie qu'elle est de type POST
        if ($request->getMethod() == 'POST')
        {
            if($formnum == 1)//REPRISE
            {
                $form1->bind($request);
                // On vérifie que les valeurs entrées sont correctes
                if($form1->isValid()){
                    if($qrcode == 0)
                    {
                        $logistiquerep = $form1->get('logistiquerep')->getData();
                        foreach($logistiquerep as $log)
                        {
                            $codemachine = $log->getMateriel();
                            $etatlog = $log->getEtatlog();
                            $codelocations = $log->getCodelocations();

                            //MISE A JOUR DES TABLES
                            $machine = $em->getRepository('BaclooCrmBundle:Machines')
                                ->findOneBy(array('codelocations' => $codelocations, 'code' => $codemachine));
                            if(!isset($machine))
                            {
                                $machine = $em->getRepository('BaclooCrmBundle:Machinessl')
                                    ->findOneBy(array('codelocations' => $codelocations, 'code' => $codemachine));
                                $machine->setEtat('Disponible');
                                $machine->setEtatlog('Déposé en agence');
                                $machine->setDebutloc('');
                                $machine->setFinloc('');
                                $machine->setEntreprise('');
                                $machine->setNomchantier('');
                                $machine->setcodelocations('');
                                $machine->setcodecontrat('');
                                $machine->setClientid(0);
                            }
                            else
                            {
                                $machine->setEtat('Retour planifié');
                                $machine->setEtatlog('Retour planifié');
                            }

                            $locata = $em->getRepository('BaclooCrmBundle:Locata')
                                ->findOneById($machine->getCodecontrat());

                            $location  = $em->getRepository('BaclooCrmBundle:Locations')
                                ->findOneBy(array('id' => $codelocations, 'codemachineinterne' => $machine->getCode()));

                            if(!isset($location))
                            {
                                $location = $em->getRepository('BaclooCrmBundle:Locationssl')
                                    ->findOneBy(array('id' => $codelocations, 'codemachineinterne' => $machine->getCode()));

                                $location->setEtatloc('Retour Planifié');
                                $location->setEtatlog('Retour Planifié');
                            }
                            else
                            {
                                $machine->setEtat('Retour Planifié');
                                $location->setEtatlog('Retour Planifié');
                            }
                        }
                    }
                    $em->persist($logisrep);
                    $em->flush();
                }
            }
            elseif($formnum == 2)//LIVRAISON
            {
                $form2->bind($request);
                // On vérifie que les valeurs entrées sont correctes
                if($form2->isValid()){
                    if($qrcode == 0)
                    {
                        $logistique= $form2->get('logistique')->getData();
                        foreach($logistique as $log)
                        {
                            $codemachine = $log->getMateriel();
                            $etatlog = $log->getEtatlog();
                            $codelocations = $log->getCodelocations();
                            echo 'codelocation'.$codelocations;
                            echo ' codemachine'.$codemachine;
                            //MISE A JOUR DES TABLES
                            $machine = $em->getRepository('BaclooCrmBundle:Machines')
                                ->findOneBy(array('codelocations' => $codelocations, 'code' => $codemachine));

                            if(!isset($machine))
                            {
                                $machine = $em->getRepository('BaclooCrmBundle:Machinessl')
                                    ->findOneBy(array('codelocations' => $codelocations, 'code' => $codemachine));
                            }
                            $locata = $em->getRepository('BaclooCrmBundle:Locata')
                                ->findOneById($machine->getCodecontrat());

                            if(isset($machine))
                            {
                                $machine->setEtat('En location');
                                $machine->setEtatlog('En cours de livraison');
                            }
                            $location  = $em->getRepository('BaclooCrmBundle:Locations')
                                ->findOneBy(array('id' => $codelocations, 'codemachineinterne' => $machine->getCode()));

                            if(!isset($location))
                            {
                                $location  = $em->getRepository('BaclooCrmBundle:Locationssl')
                                    ->findOneBy(array('id' => $codelocations, 'codemachineinterne' => $machine->getCode()));
                            }

                            if(isset($codelocations))
                            {
                                $location->setEtatloc('En location');
                                $location->setEtatlog('En cours de livraison');
                            }

                            //FIN MISE A JOUR DES TABLES
                        }
                    }
                    $em->persist($logis);
                    $em->flush();
                }
            }
            return $this->redirect($this->generateUrl('bacloocrm_dispatchtransport'));
        }
        $today = date('D');
        if($today == 'Fri')
        {
            $datelivraison = date('Y-m-d', strtotime("+3 days"));
        }
        elseif($today == 'Sat')
        {
            $datelivraison = date('Y-m-d', strtotime("+2 days"));
        }
        else
        {
            $datelivraison = date('Y-m-d', strtotime("+1 days"));
        }
        //Sélection des utilisateurs à affichier
        $query = $em->createQuery(
            'SELECT f
			FROM BaclooCrmBundle:logistiquerep f
			WHERE f.etatlog = :etatlog
			Group By f.user'
        );
        $query->setParameter('etatlog', 'retour planifié');
        $listuserrep = $query->getResult();

        $query = $em->createQuery(
            'SELECT f
			FROM BaclooCrmBundle:logistique f
			WHERE f.etatlog = :etatlog
			Group By f.user'
        );
        $query->setParameter('etatlog', 'Prêt pour le chargement');
        $listusers= $query->getResult();

        if(count($listuserrep) > count($listusers))
        {
            $listuser = $listuserrep;
        }
        else
        {
            $listuser = $listusers;
        }


        $now = date('Y-m-d');
        return $this->render('BaclooCrmBundle:Crm:dispatch_transport.html.twig', array(
            'today' => $now,
            'listuser' => $listuser,
            'datelivraison' => $datelivraison,
            'form1' => $form1->createView(),
            'form2' => $form2->createView()
        ));
    }

    public function dispatchtransportpdfAction($chauffeur)
    {
        $usersess = $this->get('security.context')->getToken()->getUsername();
        $pdfObj = $this->get("white_october.tcpdf")->create();
        $em = $this->getDoctrine()->getManager();
        $qrcode = 0;
        $logistiquerep = $em->getRepository('BaclooCrmBundle:Logistiquerep')
            ->findByEtatlog('Retour planifié');

        $query = $em->createQuery(
            'SELECT f
			FROM BaclooCrmBundle:logistiquerep f
			WHERE f.etatlog = :etatlog
			Group By f.user'
        );
        $query->setParameter('etatlog', 'retour planifié');
        $listuserrep = $query->getResult();

        $logistique = $em->getRepository('BaclooCrmBundle:Logistique')
            ->findByEtatlog('Prêt pour le chargement');

        $query = $em->createQuery(
            'SELECT f
			FROM BaclooCrmBundle:logistique f
			WHERE f.etatlog = :etatlog
			Group By f.user'
        );
        $query->setParameter('etatlog', 'Prêt pour le chargement');
        $listuser = $query->getResult();
        // echo $logis;

        // On récupère la requête

        $today = date('D');
        if($today == 'Fri')
        {
            $datelivraison = date('Y-m-d', strtotime("+3 days"));
        }
        elseif($today == 'Sat')
        {
            $datelivraison = date('Y-m-d', strtotime("+2 days"));
        }
        else
        {
            $datelivraison = date('Y-m-d', strtotime("+1 days"));
        }
        $now = date('Y-m-d');

        $pdf = $this->get("white_october.tcpdf")->create();

        $html = $this->renderView('BaclooCrmBundle:Crm:dispatch_transportpdf.html.twig', array(
            'logistiquerep' => $logistiquerep,
            'listuserrep' => $listuserrep,
            'logistique' => $logistique,
            'listuser' => $listuser,
            'today' => $now,
            'chauffeur' => $chauffeur,
            'datelivraison' => $datelivraison
        ));
        $pdf->SetFont('helvetica', '', 9, '', true);

        $pdf->AddPage('L', 'A4');
        $pdf->writeHTML($html, true, false, true, false, '');
        $pdf->lastPage();

        $response = new Response($pdf->Output('file.pdf'));
        $response->headers->set('Content-Type', 'application/pdf');

        return $response;
        // return $this->render('BaclooCrmBundle:Crm:dispatch_transportpdf.html.twig', array(
        // 'logistiquerep' => $logistiquerep,
        // 'logistique' => $logistique,
        // 'today' => $now,
        // 'datelivraison' => $datelivraison
        // ));
    }

    public function machinesslAction($machineid, Request $request)
    {
        $user = $this->get('security.context')->getToken()->getUsername();
        $today = date('Y-m-d');
        $em = $this->getDoctrine()->getManager();
        if($machineid == 0)
        {
            $machine = new Machinessl;
            $last5loc = 0;
        }
        else
        {
            $machine  = $em->getRepository('BaclooCrmBundle:Machinessl')
                ->findOneById($machineid);
            $codemachine = $machine->getCode();
            $last5locsl  = $em->getRepository('BaclooCrmBundle:Locata')
                ->last5locsl($machineid);
        }
        if(!isset($last5locsl)){$last5locsl = 0;}
        $form = $this->createForm(new MachinesslType(), $machine);
        $request = $this->get('request');
        if($request->getMethod() == 'POST')
        {
            $form->bind($request);
            if($form->isValid())
            {
                $em->persist($machine);
                $em->flush();

                $codemachine = $form->get('code')->getData();
                $machinessl  = $em->getRepository('BaclooCrmBundle:Machinessl')
                    ->findOneByCode($codemachine);
                $machineid = $machine->getId();

                return $this->redirect($this->generateUrl('bacloocrm_machinessl', array('machineid' => $machineid)));
            }
        }
        return $this->render('BaclooCrmBundle:Crm:machinessl.html.twig', array('form' => $form->createView(),
            'date' => $today,
            'machineid' => $machineid,
            'last5locsl' => $last5locsl,
            'user' => $user));
    }

    public function requeteloueurAction(Request $request)
    {
        // $request = $request->get('request');
        // if($request == 1){
        $search = $request->get('search');
        // $search = 'altitop';
        if(!empty($search))
        {
            $em = $this->getDoctrine()->getManager();
            $query = $em->createQuery(
                'SELECT f
					FROM BaclooCrmBundle:Fiche f
					WHERE f.raisonSociale LIKE :raison
					AND (f.typefiche = :fournisseur)
					Group By f.raisonSociale'
            );
            $query->setParameter('raison', '%'.$search.'%');
            $query->setParameter('fournisseur', 'fournisseur');
            $result = $query->getArrayResult();

            // Transformer le tableau associatif en un tableau standard
            $array = array();
            foreach ($result as $data) {
                $array[] = array("label"=>$data['raisonSociale'], "value"=>$data['id']);
            }
        }
        $response = new Response(json_encode($array));
        return $response;
        // }
    }

    public function requetemachineAction(Request $request)
    {
        // $request = $request->get('request');
        // if($request == 1){
        $search = $request->get('search');
        // $search = 'altitop';
        if(!empty($search))
        {
            $em = $this->getDoctrine()->getManager();
            $query = $em->createQuery(
                'SELECT f
					FROM BaclooCrmBundle:Machines f
					WHERE f.code LIKE :code
					AND f.original = :original
					AND f.original = :original
					Order By f.code ASC'
            );
            $query->setParameter('code', '%'.$search.'%');
            $query->setParameter('original', 1);
            $result = $query->getArrayResult();

            // Transformer le tableau associatif en un tableau standard
            $array = array();
            foreach ($result as $data) {
                $array[] = array("label"=>$data['code'], "value"=>$data['id']);
            }
        }
        $response = new Response(json_encode($array));
        return $response;
        // }
    }

    public function requete2loueurAction(Request $request)
    {
        $search = $request->get('search');
        if(!empty($search))
        {
            $em = $this->getDoctrine()->getManager();
            $query = $em->createQuery(
                'SELECT f
					FROM BaclooCrmBundle:Fiche f
					WHERE f.raisonSociale LIKE :raisonSociale
					and f.typefiche = :typefiche'
            );
            $query->setParameter('raisonSociale', '%'.$search.'%');
            $query->setParameter('typefiche', 'fournisseur');
            $result = $query->getArrayResult();

            // Transformer le tableau associatif en un tableau standard
            $array = array();
            foreach ($result as $data) {
                $array[] = array("label"=>$data['raisonSociale']);
            }
        }
        $response = new Response(json_encode($array));
        return $response;
    }

    public function ajouterlocationfrsAction($ficheid, $locid, $type, $bdctransport, $mode, $erreur, Request $request)
    {
        $objUser = $this->get('security.context')->getToken()->getUsername(); if(empty($objUser) or !isset($objUser) or $objUser == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        $em = $this->getDoctrine()->getManager();//echo 'locid'.$locid;
        $bdcid = $locid;

        $fournisseur  = $em->getRepository('BaclooCrmBundle:Fiche')
            ->findOneById($ficheid);
        $message = 0;

        if($bdcid == 0)
        {
            $locatafrs = new Locatafrs;
            $contrat = 0;
            $locatafrs->setDatecrea(date('Y-m-d'));

            $query = $em->createQuery(
                'SELECT b.compteurfac
				FROM BaclooCrmBundle:Factures b
				where b.typedoc = :bdc
				ORDER BY b.id DESC'
            )->setParameter('bdc', 'fature frs');
            $query->setMaxResults(1);
            $lastnumfact = $query->getOneOrNullResult();
            if(empty($lastnumfact) or !isset($lastnumfact) or $lastnumfact == null)
            {
                $lastnumfact = 0;//echo 'vide';
            }
            else
            {
                $lastnumfact = $query->getSingleScalarResult();//echo 'pas vide';
            }
            $numbdc = date('Y').'H'.($lastnumfact++);
            $locatafrs->setNumbdc($numbdc);
        }
        elseif(($type == 'aller' or $type == 'retour') && $bdctransport == 1)
        {//echo 'bbbbb';
            $locatafrs = new Locatafrs;
            $locatafrs->setDatecrea(date('Y-m-d'));
            $contrat = $locid;
            $locata  = $em->getRepository('BaclooCrmBundle:Locata')
                ->findOneById($locid);
            $locatafrs->setCodelocatasl($locata->getId());
            $locatafrs->setFournisseurid($fournisseur->getId());
            $locatafrs->setFournisseur($fournisseur->getRaisonSociale());
            $locatafrs->setTypes($type);
            $em->persist($locatafrs);
            $em->flush();
            if($type == 'aller')
            {
                $locata->setIdbdcaller($locatafrs->getId());
                $locatafrs->setNomchantier($locata->getNomchantier());
                $locatafrs->setAdresse1($locata->getAdresse1());
                $locatafrs->setAdresse2($locata->getAdresse2());
                $locatafrs->setAdresse3($locata->getAdresse3());
                $locatafrs->setCp($locata->getCp());
                $locatafrs->setVille($locata->getVille());
            }
            if($type == 'retour')
            {
                $locata->setIdbdcretour($locatafrs->getId());

                $loueurid = 0;
                foreach ($locata->getLocationssl() as $loc)
                {
                    if(null !== $loc->getLoueurid())
                    {
                        $loueurid = $loc->getLoueurid();
                    }
                }
                if($loueurid != 0)
                {
                    $frs  = $em->getRepository('BaclooCrmBundle:Fiche')
                        ->findOneById($loueurid);
                    $locatafrs->setNomchantier($frs->getRaisonSociale());
                    $locatafrs->setAdresse1($frs->getAdresse1());
                    $locatafrs->setAdresse2($frs->getAdresse2());
                    $locatafrs->setAdresse3($frs->getAdresse3());
                    $locatafrs->setCp($frs->getCp());
                    $locatafrs->setVille($frs->getVille());
                }
                else
                {
                    $locatafrs->setNomchantier('Dépôt FGG');
                    $locatafrs->setAdresse1('3 Av. Charles de Gaulle');
//                    $locatafrs->setAdresse2($frs->getAdresse2());
//                    $locatafrs->setAdresse3($frs->getAdresse3());
                    $locatafrs->setCp(94470);
                    $locatafrs->setVille('Boissy-Saint-Leger');
                }
            }
            $em->persist($locata);
            $em->flush();

            foreach ($locata->getLocations() as $loc)
            {
                $bdclocauto = new Locationsfrs;
                $bdclocauto->setCodeclient($locata->getClientid());
                $bdclocauto->setFournisseurid($fournisseur->getId());
                $bdclocauto->setFournisseur($fournisseur->getRaisonSociale());
                $bdclocauto->setReference('transport');
                $bdclocauto->setDebutloc($loc->getDebutloc());
                $bdclocauto->setFinloc($loc->getFinloc());
                $bdclocauto->setMensuel(false);
                $bdclocauto->setDesignation($loc->getTypemachine());
                $bdclocauto->setPu(0);
                $bdclocauto->setQuantite(1);
                $bdclocauto->setMontantht(0);
                $bdclocauto->setCodelocationsl($loc->getId());
                $bdclocauto->addLocatafr($locatafrs);
                $locatafrs->addLocationsfr($bdclocauto);
                $em->persist($bdclocauto);
                $em->flush();
            }
            foreach ($locata->getLocationssl() as $loc)
            {
                $bdclocauto = new Locationsfrs;
                $bdclocauto->setCodeclient($locata->getClientid());
                $bdclocauto->setFournisseurid($fournisseur->getId());
                $bdclocauto->setFournisseur($fournisseur->getRaisonSociale());
                $bdclocauto->setReference('transport');
                $bdclocauto->setDebutloc($loc->getDebutloc());
                $bdclocauto->setFinloc($loc->getFinloc());
                $bdclocauto->setMensuel(false);
                $bdclocauto->setDesignation($loc->getTypemachine());
                $bdclocauto->setPu(0);
                $bdclocauto->setQuantite(1);
                $bdclocauto->setMontantht(0);
                $bdclocauto->setCodelocationsl($loc->getId());
                $bdclocauto->addLocatafr($locatafrs);
                $locatafrs->addLocationsfr($bdclocauto);
                $em->persist($bdclocauto);
                $em->flush();
            }//echo '9999999'.$locatafrs->getId();
            $bdcid = $locatafrs->getId();;
        }
        else
        {
            $locatafrs  = $em->getRepository('BaclooCrmBundle:Locatafrs')
                ->findOneById($bdcid);	//echo 'ici'.$locatafrs->getId();
            $locid = 0;
            $factureid = $erreur; // on a passe factureid dans la variable erreur;
            foreach($locatafrs->getLocationsfrs() as $loca)
            {
                $locid = $loca->getId();
            }
            if($locatafrs->getSpeedachat() == 1)
            {
                return $this->redirect($this->generateUrl('bacloocrm_ajouterlocationfrsspeed', array('message' => $factureid, 'bdcid' => $locatafrs->getId(), 'locid' => $locid)));
            }
            $bdcid = $locatafrs->getId();
        }
        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($objUser);
        $userid = $userdetails->getId();
        $form = $this->createForm(new LocatafrsType(), $locatafrs);

        $today = date('Y-m-d');
        $year = date('Y');
        include('societe.php');

        //On met les locationsfrs dans un array pour controle ultérieur
        // $listeloc = array();
        // foreach ($locatafrs->getLocationsfrs() as $loc) {
        // $listeloc[] = $loc;
        // }

        $em = $this->getDoctrine()->getManager();
        $modules  = $em->getRepository('BaclooCrmBundle:Modules')
            ->findOneByUsername($objUser);

        // On récupère la requête
        $request = $this->get('request');
        // On vérifie qu'elle est de type POST
        if ($request->getMethod() == 'POST')
        {
            $form->bind($request);
            // On vérifie que les valeurs entrées sont correctes
            // $data = $form->getData();
            if ($form->isValid()){
                if($mode === 'recurrent'){
                    $locatafrs->setMode('recurrent');}
                // $locatafrs->set
                $em->persist($locatafrs);
                // $em->flush();

                $fournisseurnom = $form->get('fournisseur')->getData();echo 'XXX';echo $fournisseurnom;
                $nomchantier = $form->get('nomchantier')->getData();
                $adresse1 = $form->get('adresse1')->getData();
                $adresse2 = $form->get('adresse2')->getData();
                $adresse3 = $form->get('adresse3')->getData();
                $cp = $form->get('cp')->getData();
                $ville = $form->get('ville')->getData();
                $locationsfrs = $form->get('locationsfrs')->getData();


                //Mise à jour de la table chantier si le chantier n'existe pas
                $chantier = $em->getRepository('BaclooCrmBundle:Chantier')
                    ->findOneByNom($nomchantier);
                if(empty($chantier))
                {
                    $newchantier = new Chantier;
                    $newchantier->setNom($nomchantier);
                    $newchantier->setAdresse1($adresse1);
                    $newchantier->setAdresse2($adresse2);
                    $newchantier->setAdresse3($adresse3);
                    $newchantier->setCp($cp);
                    $newchantier->setVille($ville);
                    $em->persist($newchantier);
                    // $em->flush();
                }
                //Fin maj chantier

                $quantite = 0;
                $locationht = 0;
                $assuranceht = 0;
                $contributionverteht = 0;
                $pieceht = 0;
                $transportht = 0;
                $materielht = 0;
                $prestationht = 0;
                $autreht = 0;

                //Création du montant HT ligne par ligne
                $totalht = 0;//echo $locid;
                $assurancetotal = 0;
                $contributionvertetotal = 0;
                foreach ($form->get('locationsfrs')->getData() as $loc)
                {//echo ' EFERENCE'.$loc->getReference();	echo'debutloc';echo $loc->getDebutloc();
                    $fournisseur = $em->getRepository('BaclooCrmBundle:Fiche')
                        ->findOneById($ficheid);
                    $fournisseurnom = $fournisseur->getRaisonSociale();
                    $fournisseurid = $fournisseur->getId();
                    $quantite = $loc->getQuantite();
                    //caclcul du nbjloc pour servir les quantité pour loc eco et assert
                    if(($loc->getReference() == 'location' or $loc->getReference() == 'contributionverte' or $loc->getReference() == 'assurance') && $loc->getDebutloc() != '' && $loc->getFinloc() != '')
                    {echo '11111';
                        $dStart = $loc->getDebutloc();
                        $dEnd = $loc->getFinloc();
                        $begin = new \DateTime($dStart);
                        $end = new \DateTime($dEnd);
                        $end = $end->modify( '+1 day' );

                        $interval = DateInterval::createFromDateString('1 day');
                        $period = new DatePeriod($begin, $interval, $end);
                        $nbjloc = 0;
                        $nbjlocass = 0;

                        foreach ($period as $dt) {
                            $newformat = $dt->format("D");
                            $nbjlocass++;
                            if($loc->getFacturersamedi() == 1 && $newformat == 'Sat')
                            {//echo 'samedi';
                                $nbjloc++;
                            }
                            elseif($loc->getFacturerdimanche() == 1 && $newformat == 'Sun')
                            {//echo 'dimanche';
                                $nbjloc++;
                            }
                            elseif($newformat == 'Sat' or $newformat == 'Sun')
                            {}
                            else
                            {//echo 'autrejour';
                                $nbjloc++;
                            }
                        }
//                        $loc->setNbjlocass($nbjlocass);
                    }//echo '<br>NBJLOC'.$nbjloc;
                    if(empty($nbjloc)){$nbjloc = 0;}
                    if($loc->getReference() == 'location')
                    {echo '222222';
                        if($loc->getMensuel() == 1)
                        {echo 'aaa';
                            include('calculnbjlocmensuellebdc.php');
                            $locationht += $nbjloc*$loc->getPu()/20;echo 'LOCATIONHT'.$locationht;
                            $locationhtligne = $nbjloc*$loc->getPu()/20;
                            if((null !== $locatafrs->getCodelocatasl() && $locatafrs->getCodelocatasl() > 0) or $mode == 'recurrent')
                            {echo '&&&&&&&&';
                                $loc->setQuantite($nbjloc/20);
                            }
                        }
                        else
                        {echo 'nbjloc'.$nbjloc;
                            if($nbjloc > 0)
                            {echo 'bbb';
                                $locationht += $nbjloc*$loc->getPu();echo 'LOCATIONHT'.$locationht;
                                $locationhtligne = $nbjloc*$loc->getPu();
                                if((null !== $locatafrs->getCodelocatasl() && $locatafrs->getCodelocatasl() > 0) or (null !==$loc->getDebutloc() && null !== $loc->getFinloc()))
                                {echo'yes';
                                    $loc->setQuantite($nbjloc);
                                }else{echo 'no';}
                            }
                            else
                            {
                                $locationht += $loc->getQuantite()*$loc->getPu();echo 'LOCATIONHT'.$locationht;
                                $locationhtligne = $loc->getQuantite()*$loc->getPu();echo 'locationhtligne'.$locationhtligne;
                            }
                        }
                        $loc->setMontantht($locationhtligne);

                        //calcul de l'assurance
                        if($fournisseur->getFrsrc() == 1)
                        {
                            if($fournisseur->getUniterc() == '%')
                            {
                                if($loc->getMensuel() == 1)
                                {
                                    $assuranceunite = $loc->getPu()/20 * $fournisseur->getMontantrc()/100;
                                }
                                else
                                {
                                    $assuranceunite = $loc->getPu() * $fournisseur->getMontantrc()/100;//echo $assuranceunite;echo 'rrr'.$nbjloc;echo '<<<';
                                }
                            }
                            else
                            {
                                $assuranceunite = $fournisseur->getMontantrc();
                            }
                            if($fournisseur->getBasecalculrc() == 1)
                            {
                                $assurance = $assuranceunite;
                            }
                            elseif($fournisseur->getBasecalculeco() == 5)
                            {
                                $assurance = $assuranceunite*$nbjloc;
                            }
                            elseif($fournisseur->getBasecalculeco() == 7)
                            {
                                $assurance = $assuranceunite*$nbjlocass;
                            }

                        }
                        else//si pas d'eco
                        {
                            $assurance = 0;
                        }
                        $assurancetotal += $assurance;
                        $loc->setAssurance($assurance);
                        if($fournisseur->getFrseco() == 1)
                        {echo 'uuuuuuuuuu';
                            if($fournisseur->getUniteeco() == '%')
                            {
                                $ecopartunite = $loc->getPu() * $fournisseur->getMontanteco()/100;
                            }
                            else
                            {
                                $ecopartunite = $fournisseur->getMontanteco();
                            }
                            if($fournisseur->getBasecalculeco() == 1)
                            {
                                $contributionverte = $ecopartunite;
                                $nbjloceco = 1;
                            }
                            elseif($fournisseur->getBasecalculeco() == 5)
                            {
                                $contributionverte = $ecopartunite*$nbjloc;
                                $nbjloceco = $nbjloc;
                            }
                            elseif($fournisseur->getBasecalculeco() == 7)
                            {
                                $contributionverte = $ecopartunite*$nbjlocass;
                                $nbjloceco = $nbjlocass;
                            }
                            echo 'BBBBBBBBB';$loc->setContributionverte($contributionverte);
                        }
                        else//si pas d'eco
                        {echo 'iiiiiiiiiiiiii';
                            $contributionverte = 0;
                        }
                        $contributionvertetotal += $contributionverte;
                        $loc->setContributionverte($contributionverte);
                    }
                    elseif($loc->getReference() == 'piece')
                    {//echo '333333333';
                        if($loc->getSpeedachat() == 1)
                        {
                            if(null !== $loc->getPu() and null !== $loc->getQuantite())
                            {
                                $pieceht += $loc->getQuantite()*$loc->getPu();
                                $piecehtligne = $loc->getQuantite()*$loc->getPu();
                            }
                            else
                            {
                                $pieceht += $loc->getMontantht();
                                $piecehtligne = $loc->getMontantht();
                            }
                        }
                        else
                        {
                            $pieceht += $loc->getQuantite()*$loc->getPu();
                            $piecehtligne = $loc->getQuantite()*$loc->getPu();
                        }
                        $articles = $em->getRepository('BaclooCrmBundle:Articlesenvente')
                            ->findOneByDesignation($loc->getDesignation());
                        if(isset($articles))
                        {
                            $articles->setEnattentereception($loc->getQuantite());
                            $em->persist($articles);
                        }
                        $loc->setMontantht($piecehtligne);
                    }
                    elseif($loc->getReference() == 'transport')
                    {//echo '66666666';
                        if($loc->getSpeedachat() == 1)
                        {
                            $transportht += $loc->getMontantht();
                            $transporthtligne = $loc->getMontantht();
                        }
                        else
                        {
                            $transportht += $loc->getQuantite()*$loc->getPu();
                            $transporthtligne = $loc->getQuantite()*$loc->getPu();
                        }
                        $loc->setMontantht($transporthtligne);
                    }
                    elseif($loc->getReference() == 'materiel')
                    {//echo '777777';
                        if($loc->getSpeedachat() == 1)
                        {
                            $materielht += $loc->getMontantht();
                            $materielhtligne = $loc->getMontantht();
                        }
                        else
                        {
                            $materielht += $loc->getQuantite()*$loc->getPu();
                            $materielhtligne = $loc->getQuantite()*$loc->getPu();
                        }
                        $loc->setMontantht($materielhtligne);
                    }
                    elseif($loc->getReference() == 'prestation')
                    {echo '8888888888';
                        if($loc->getMensuel() == 1)
                        {echo 'aaa';
                            include('calculnbjlocmensuellebdc.php');
//                                $locationht += $nbjloc*$loc->getPu()/20;echo 'LOCATIONHT'.$locationht;
//                                $locationhtligne = $nbjloc*$loc->getPu()/20;
                            if((null !== $locatafrs->getCodelocatasl() && $locatafrs->getCodelocatasl() > 0) or $mode == 'recurrent')
                            {echo '&&&&&&&&';
                                $loc->setQuantite($nbjloc/20);
                            }
                        }
                        if($loc->getSpeedachat() == 1)
                        {
                            if(null !== $loc->getPu() and null !== $loc->getQuantite())
                            {
                                $prestationht += $loc->getQuantite()*$loc->getPu();
                                $prestationhtligne = $loc->getQuantite()*$loc->getPu();
                            }
                            else
                            {
                                $prestationht += $loc->getMontantht();
                                $prestationhtligne = $loc->getMontantht();
                            }
                        }
                        else
                        {
                            $prestationht += $loc->getQuantite()*$loc->getPu();
                            $prestationhtligne = $loc->getQuantite()*$loc->getPu();
                        }
                        $loc->setMontantht($prestationhtligne);
                    }
                    elseif($loc->getReference() == 'autre')
                    {echo '9999999999';
                        if($loc->getSpeedachat() == 1)
                        {
                            if(null !== $loc->getPu() and null !== $loc->getQuantite())
                            {
                                $autreht += $loc->getQuantite()*$loc->getPu();
                                $autrehtligne = $loc->getQuantite()*$loc->getPu();
                            }
                            else
                            {echo 'tttt';
                                $autreht += $loc->getMontantht();
                                $autrehtligne = $loc->getMontantht();
                            }
                        }
                        else
                        {
                            $autreht += $loc->getQuantite()*$loc->getPu();
                            $autrehtligne = $loc->getQuantite()*$loc->getPu();
                        }
                        $loc->setMontantht($autrehtligne);
                    }
                }
                $em->flush();//echo 'LOCATIONHT1X';echo $prestationht;
                foreach ($form->get('locationsfrs')->getData() as $loc)
                {//echo ' EFERENCE'.$loc->getReference();	echo'debutloc';echo $loc->getDebutloc();
                    $fournisseur = $em->getRepository('BaclooCrmBundle:Fiche')
                        ->findOneById($ficheid);
                    $fournisseurnom = $fournisseur->getRaisonSociale();
                    $fournisseurid = $fournisseur->getId();
                    //caclcul du nbjloc pour servir les quantité pour loc eco et assert
                    if(($loc->getReference() == 'location' or $loc->getReference() == 'contributionverte' or $loc->getReference() == 'assurance') && $loc->getDebutloc() != '' && $loc->getFinloc() != '')
                    {//echo '11111';
                        $dStart = $loc->getDebutloc();
                        $dEnd = $loc->getFinloc();
                        $begin = new \DateTime($dStart);
                        $end = new \DateTime($dEnd);
                        $end = $end->modify( '+1 day' );

                        $interval = DateInterval::createFromDateString('1 day');
                        $period = new DatePeriod($begin, $interval, $end);
                        $nbjloc = 0;
                        $nbjlocass = 0;

                        foreach ($period as $dt) {
                            $newformat = $dt->format("D");
                            $nbjlocass++;
                            if($loc->getFacturersamedi() == 1 && $newformat == 'Sat')
                            {//echo 'samedi';
                                $nbjloc++;
                            }
                            elseif($loc->getFacturerdimanche() == 1 && $newformat == 'Sun')
                            {//echo 'dimanche';
                                $nbjloc++;
                            }
                            elseif($newformat == 'Sat' or $newformat == 'Sun')
                            {}
                            else
                            {//echo 'autrejour';
                                $nbjloc++;
                            }
                        }
                    }//echo '<br>NBJLOC'.$nbjloc;
                    if(empty($nbjloc)){$nbjloc = 0;}

                    if($loc->getReference() == 'assurance')
                    {echo '444444444';
                        //Calcul locationht
                        if($loc->getMensuel() == 1)
                        {
                            if($nbjloc < 20)
                            {
                                $assuranceht = ($loc->getPu()/20)*$nbjloc;
                            }
                            else
                            {
                                $assuranceht = $loc->getPu();
                                $nbjloc = 20;
                                $nbjlocass = 28;
                            }
                            //PBM Locationht est faux pour assurance et contributionverte. donc ne pas renseigner le PU ok pour la quantité

                        }
                        else//Si Loyer pas mensuel
                        {
                            $location = $loc->getPu()*$nbjloc;

                            $loc->setMontantht($location);
                            $totalht += $location;
                            $loc->setPu($loc->getPu());
                            if($loc->getReference() == 'assurance')
                            {
                                if(null !== $locatafrs->getCodelocatasl() && $locatafrs->getCodelocatasl() > 0)
                                {echo 'ccc';
                                    $loc->setQuantite($nbjloc);
                                }
                            }
                            //calcul de l'assurance

                        }
                        echo 'PU'.$loc->getPu();
                        echo 'QUANTITE'.$loc->getQuantite();
                        if($assurance == 0 && $loc->getQuantite() > 0){$assurancehtligne = $loc->getPu()*$loc->getQuantite();}else{$assurancehtligne = $assurance;}
                        $loc->setPu($loc->getPu());
                        if(null !== $locatafrs->getCodelocatasl() && $locatafrs->getCodelocatasl() > 0)
                        {echo 'eee';
                            $loc->setQuantite($nbjloceco);
                        }
                        $assuranceht += $assurancehtligne;
                        $loc->setMontantht($assurancehtligne);
                        $loc->setFournisseur($fournisseurnom);
                        $loc->setFournisseurid($fournisseurid);
                    }
                    elseif($loc->getReference() == 'contributionverte')
                    {echo '5555555555';

                        //Calcul locationht
                        if($loc->getMensuel() == 1)
                        {
                            if($nbjloc < 20)
                            {echo 'yyyyyyyy';
                                $location = ($loc->getPu()/20)*$nbjloc;
                            }
                            else
                            {echo 'dddddddddda';
                                $location = $loc->getPu();
                                $nbjloc = 20;
                                $nbjlocass = 28;
                            }
                            //calcul de l'ecoparticiaption

                        }
                        else//Si Loyer pas mensuel
                        {
                            $location = $loc->getPu()*$nbjloc;

                            //calcul de l'ecoparticiaption
                            if($fournisseur->getFrseco() == 1)
                            {
                                if($fournisseur->getUniteeco() == '%')
                                {
                                    $ecopartunite = $location * $fournisseur->getMontanteco()/100;
                                }
                                else
                                {
                                    $ecopartunite = $fournisseur->getMontanteco();
                                }
                                if($fournisseur->getBasecalculeco() == 1)
                                {
                                    $contributionverte = $ecopartunite;
                                    $nbjloceco = 1;
                                }
                                elseif($fournisseur->getBasecalculeco() == 5)
                                {
                                    $contributionverte = $ecopartunite*$nbjloc;
                                    $nbjloceco = $nbjloc;
                                }
                                elseif($fournisseur->getBasecalculeco() == 7)
                                {
                                    $contributionverte = $ecopartunite*$nbjlocass;
                                    $nbjloceco = $nbjlocass;
                                }
                            }
                            else//si pas d'eco
                            {
                                $contributionverte = 0;
                            }
                            //echo 'AAAAAAAAA';$loc->setContributionverte($contributionverte);
                        }
                        //echo 'PU'.$loc->getPu();
                        //echo 'QUANTITE'.$loc->getQuantite();
                        if($contributionverte == 0 && $loc->getQuantite() > 0){$contributionvertehtligne = $loc->getPu()*$loc->getQuantite();}else{$contributionvertehtligne = $contributionverte;}
                        $loc->setPu($loc->getPu());
                        if(null !== $locatafrs->getCodelocatasl() && $locatafrs->getCodelocatasl() > 0)
                        {echo 'eee';
                            $loc->setQuantite($nbjloceco);
                        }
                        $contributionverteht += $contributionvertehtligne;
                        $loc->setMontantht($contributionvertehtligne);
                    }
                    else
                    {
                        echo 'rrrrrrrrrrrr';
                    }
                    // $loc->setCodeclient($fournisseur->getId());
                }
                $em->flush();
//echo 'LAAAAAAAA';
                $totalht = $locationht + $assuranceht + $contributionverteht + $pieceht + $transportht + $materielht + $prestationht + $autreht;
                //echo 'locationht'.$locationht;echo 'assuranceht'.$assuranceht;echo 'contributionverte'.$contributionverteht;echo 'autres'.$autreht;echo 'pieceht'.$pieceht;echo 'transportht'.$transportht;echo 'materielht'.$materielht;echo 'prestationht'.$prestationht;
                $tva = $totalht * 0.20;
                $totalttc = $totalht + $tva;
// echo $fournisseurnom;
                $locatafrs->setContributionverte($contributionvertetotal);
                $locatafrs->setAssurance($assurancetotal);
                $locatafrs->setMontantloc($totalht);
                $locatafrs->setFournisseur($fournisseurnom);
                $locatafrs->setFournisseurid($ficheid);
                $locatafrs->setDatemodif(date('Y-m-d'));
                $em->persist($locatafrs);
                $em->flush();

                $bdcid = $locatafrs->getId();


                $em->flush();
                // On redirige vers la page de visualisation de la fiche nouvellement créée
                return $this->redirect($this->generateUrl('bacloocrm_ajouterlocationfrs', array('ficheid' => $ficheid, 'locid' => $locatafrs->getId(), 'type' => $type, 'mode' => $mode, 'message' => $message )));
            }
        }

        if($bdcid > 0)
        {//echo 'laaa';
            $totalht = $locatafrs->getMontantloc();
            $grille = array();
        }
        else
        {//echo 'ici';
            $totalht = 0;
        }
        // echo $grille;

        // echo $locid;
        if($locatafrs->getCodelocatasl() > 0)
        {
            $numlocatafrs = $locatafrs->getCodelocatasl();
            if($numlocatafrs[0] == 'V')
            {
                $numlocatafrsok = substr($numlocatafrs, 2);
                $locata = $em->getRepository('BaclooCrmBundle:Venda')
                    ->findOneById($numlocatafrsok);
            }
            else
            {
                $locata = $em->getRepository('BaclooCrmBundle:Locata')
                    ->findOneById($locatafrs->getCodelocatasl());
            }
        }
        else
        {
            $locata = 0;
        }
        return $this->render('BaclooCrmBundle:Crm:nouvelle_locationfrs.html.twig', array('form' => $form->createView(),
            'date' => $today,
            'fournisseur' => $fournisseur,
            'usersociete' => $societe,
            'modules' => $modules,
            'entreprise' => $fournisseur->getRaisonSociale(),
            'typefiche' => $fournisseur->getTypefiche(),
            'id' => $ficheid,
            'erreur' => $erreur,
            'bdcid' => $bdcid,
            'mode' => $mode,
            'totalht' => $totalht,
            'locata' => $locata,
            'user' => $objUser));
    }

    public function ajouterlocationfrsspeedAction($message, $bdcid, $locid, Request $request)
    {//echo 'mmmm'.$message;echo 'bbbbb'.$bdcid;echo 'llll'.$locid;exit();
        $objUser = $this->get('security.context')->getToken()->getUsername(); if(empty($objUser) or !isset($objUser) or $objUser == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        $em = $this->getDoctrine()->getManager();//echo 'locid'.$locid;
        // $bdcid = $locid;//echo 'bdcid'.$bdcid;

        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($objUser);
        $userid = $userdetails->getId();

        $today = date('Y-m-d');
        include('societe.php');

        //On met les locationsfrs dans un array pour controle ultérieur
        // $listeloc = array();
        // foreach ($locatafrs->getLocationsfrs() as $loc) {
        // $listeloc[] = $loc;
        // }		ti

        $em = $this->getDoctrine()->getManager();

        //création du formlaire de saisie rapide
        $defaultData = array();
        $form = $this->createFormBuilder($defaultData)
            ->add('reference', 'choice', array(
                'choices'   => array(
                    'Assurances Matériels'   => 'Assurances Matériels',
                    'Assurance RCP'   => 'Assurance RCP',
                    'Consommables matériels' => 'Consommables matériels',
                    'Carburant' => 'Carburant',
                    'Carburant d entretien' => 'Carburant d entretien',
//                    'Crédit bail mobilier (structure/frais généraux)' => 'Crédit bail mobilier (structure/frais généraux)',
                    'Documentation generale'   => 'Documentation generale',
                    'Dons et pourboirs'   => 'Dons et pourboirs',
                    'Electricité - eau' => 'Electricité - eau',
                    'Entretien matériels'   => 'Entretien matériels',
//                    'Entretien mat transport'   => 'Entretien mat transport',
                    'Frais bancaires'   => 'Frais bancaires',
                    'Frais d actes (formalités)'   => 'Frais d actes (formalités)',
                    'Frais deplacements'   => 'Frais deplacements',
                    'Frais postaux'   => 'Frais postaux',
                    'Fourn administratives' => 'Fourn administratives',
                    'Honoraires comptable'   => 'Honoraires comptable',
                    'Honoraires juridique'   => 'Honoraires juridique',
                    'Location géolocalisation'   => 'Location géolocalisation',
                    'Location de matériel'   => 'Location de matériel',
                    'Maintenance informatique'   => 'Maintenance informatique',
                    'Petites fournitures et outillage' => 'Petites fournitures et outillage',
                    'Publicite-communication'   => 'Publicite-communication',
                    'Telephone'   => 'Telephone',
                ),
                'multiple'  => false,
            ))
            ->add('date', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => false,
                'read_only' => false,
                'attr' => array('class' => 'date'),
            ))
            ->add('echeance', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => true,
                'read_only' => false,
                'attr' => array('class' => 'date'),
            ))
            ->add('numfacfrs', 'text', array('required' => true))
            ->add('fournisseur', 'text', array('required' => false))
            ->add('fournisseurid', 'text', array('required' => false))
            ->add('designation', 'textarea', array('required' => true))
//			->add('pu', 'number', array('required' => false))
//			->add('quantite', 'integer', array('required' => false))
            ->add('montantht', 'number', array('required' => false))
            ->add('montantttc', 'number', array('required' => false))
//		    ->add('reglement', 'checkbox', array('required' => false))
            ->add('avoir', 'checkbox', array('required' => false))
            ->add('dejaregle', 'checkbox', array('required' => false))
            ->add('modepaiement', 'choice', array(
                'choices'   => array(
                    'vide'   => '',
                    'virement'   => 'Virement',
                    'prélèvement'   => 'Prélèvement',
                    'cheque' => 'Chèque',
                    'lcr' => 'LCR',
                    'cb' => 'CB',
                    'vad' => 'VAD',
                    'traite' => 'Traite',
                    'espece' => 'Espèce',
                    'Liquidation' => 'Liquidation',
                ),
                'multiple'  => false,
            ))
            ->getForm();
        // On récupère la requête
        // $request = $this->get('request');
        // On vérifie qu'elle est de type POST
        if ($request->getMethod() == 'POST')
        {//echo 'post';
            // $form->bind($request);
            $form->handleRequest($request);
            // On vérifie que les valeurs entrées sont correctes
            // $data = $form->getData();
            if ($form->isValid())
            {		//echo 'valide';

                // if($form2->isValid()){echo 'ttttttt';
                $data = $form->getData();
                $reference = $data['reference'];
                $fournisseurnom = $data['fournisseur'];
                $numfacfrs = $data['numfacfrs'];
                $fournisseurid = $data['fournisseurid'];
                $designation = $data['designation'];
//				$pu = $data['pu'];
//				$quantite = $data['quantite'];//echo 'CLIENT'.$client;
                $montantht = $data['montantht'];
                $montantttc = $data['montantttc'];
                $dateachat = $data['date'];
                $echeance = $data['echeance'];
                $avoir = $data['avoir'];
                $dejaregle = $data['dejaregle'];
                $modepaiement = $data['modepaiement'];
//                $reglement = $data['reglement'];

				$fournisseur  = $em->getRepository('BaclooCrmBundle:Fiche')
								->findOneBy(array('raisonSociale' => $fournisseurnom, 'typefiche' => 'fournisseur'));

                if(empty($fournisseur))
                {//echo 'empty';
                    $fournisseur = new Fiche;
                    $fournisseur->setRaisonsociale($fournisseurnom);
                    $fournisseur->setTypefiche('fournisseur');
                    $fournisseur->setUser($objUser);
                    $fournisseur->setUsersociete($societe);
                    $fournisseur->setLastmodif(new \DateTime($today));
                    $em->persist($fournisseur);
                    $em->flush();
                }

                $query = $em->createQuery(
                    'SELECT b.compteurfac
					FROM BaclooCrmBundle:Factures b
					where b.typedoc = :bdc
					ORDER BY b.compteurfac DESC'
                )->setParameter('bdc', 'facture frs');
                $query->setMaxResults(1);
                $lastnumfact = $query->getOneOrNullResult();
                if(empty($lastnumfact) or !isset($lastnumfact) or $lastnumfact == null)
                {
                    $lastnumfact = 0;//echo 'vide';
                }
                else
                {
                    $lastnumfact = $query->getSingleScalarResult();//echo 'pas vide';
                }
                if($bdcid == 0)
                {
                    $numbdc = date('Y').'H'.($lastnumfact++);
                    $locatafrs = new Locatafrs;
                    $locatafrs->setNumbdc($numbdc);
                }
                else
                {
                    $locatafrs = $em->getRepository('BaclooCrmBundle:Locatafrs')
                        ->findOneById($bdcid);
                }
                $locatafrs->setDatecrea(date('Y-m-d'));
                $locatafrs->setFournisseur($fournisseurnom);
                $locatafrs->setFournisseurid($fournisseur->getId());
                $locatafrs->setUser($objUser);
                $locatafrs->setDatemodif($today);
                $locatafrs->setDatecrea($dateachat);
                $locatafrs->setMontantloc($montantht);
                $locatafrs->setMontantttc($montantttc);
                $locatafrs->setEtatbdc(1);
                $locatafrs->setSpeedachat(1);

                $em->persist($locatafrs);
                $em->flush();

                if($locid == 0)
                {
                    $locationsfrs = new Locationsfrs;
                }
                else
                {
                    $locationsfrs = $em->getRepository('BaclooCrmBundle:Locationsfrs')
                        ->findOneById($locid);
                }
                $locationsfrs->setReference($reference);
                $locationsfrs->setFournisseurid($fournisseur->getId());
                $locationsfrs->setFournisseur($fournisseurnom);
                $locationsfrs->setDesignation($designation);
//                $locationsfrs->setPu($pu);
//                $locationsfrs->setQuantite($montantht);
                $locationsfrs->setMontantht($montantht);
                $locationsfrs->setMontantttc($montantttc);
                $locationsfrs->setSpeedachat(1);

                if($locid == 0)
                {
                    $locationsfrs->addLocatafr($locatafrs);
                    $locatafrs->addLocationsfr($locationsfrs);
                    $em->persist($locatafrs);
                }
                else
                {
                    $locationsfrs = $em->getRepository('BaclooCrmBundle:Locationsfrs')
                        ->findOneById($locid);
                }
                $em->persist($locationsfrs);
                $em->flush();

                $bdcid = $locatafrs->getId();
                $locid = $locationsfrs->getId();
//                $message = 'ok';
                include('achatsimple.php');
                if($message > 0)
                {
                    $facture  = $em->getRepository('BaclooCrmBundle:Factures')
                        ->findOneById($message);
                }
                else
                {
                    $query = $em->createQuery(
                        'SELECT u
                    FROM BaclooCrmBundle:Factures u
                    WHERE u.locatacloneid = :locatacloneid
                    AND (u.typedoc = :typedoc or u.typedoc = :typedoc1)');
                    $query->setParameter('locatacloneid', $bdcid);
                    $query->setParameter('typedoc', 'facture frs');
                    $query->setParameter('typedoc1', 'avoir frs');
                    $facture = $query->getOneOrNullResult();
                    if(isset($facture))
                    {
                        $facture = $query->getSingleResult();
                    }
                    $message = 'ok';
                }
                if($locatafrs->getSpeedachat() == 1 && isset($facture) && $facture->getReglement() == 1 && $facture->getEncompta() == 1)
                {//echo 'ici'.$numfacture;exit();
                    $numfacture = $facture->getId();
                    return $this->redirect($this->generateUrl('bacloocrm_comptadef', array('numfacture' => $numfacture, 'mode' => 'all', 'page' => 1,  'doc' => 'achatspeed', 'bdcid' => $bdcid)));
                }
                else
                {//echo 'laa'.$facture->getReglement();exit();
                    return $this->redirect($this->generateUrl('bacloocrm_ajouterlocationfrsspeed', array('message' => $message, 'bdcid' => $locatafrs->getId(), 'locid' => $locationsfrs->getId())));
                }
            }
        }//echo 'message ='.$message;
        if($message > 0)
        {
            $facture  = $em->getRepository('BaclooCrmBundle:Factures')
                ->findOneById($message);
        }
        else
        {
            $query = $em->createQuery(
                'SELECT u
                    FROM BaclooCrmBundle:Factures u
                    WHERE u.locatacloneid = :locatacloneid
                    AND (u.typedoc = :typedoc or u.typedoc = :typedoc1)');
            $query->setParameter('locatacloneid', $bdcid);
            $query->setParameter('typedoc', 'facture frs');
            $query->setParameter('typedoc1', 'avoir frs');
            $facture = $query->getOneOrNullResult();
        }
        if(!isset($facture))
        {
            $facture = 0;
            $documents = 0;
            $locatafrs = 0;
            $reference = 0;
            $designation = 0;
        }
        else
        {
            if($message > 0)
            {
            }
            else {
                $facture = $query->getSingleResult();
            }
            $documents  = $em->getRepository('BaclooCrmBundle:Document')
                ->findBy(array('codecontrat' => $facture->getId(), 'type' => 'facfrs'));
            $locatafrs  = $em->getRepository('BaclooCrmBundle:Locatafrs')
                ->findOneById($bdcid);//echo 'ttt'.$locatafrs->getId();
                $reference = 0;
                $designation = 0;
                foreach($locatafrs->getLocationsfrs() as $loca)
                {
                    $referene = $loca->getReference();
                    $designation = $loca->getDesignation();
                }
        }

        return $this->render('BaclooCrmBundle:Crm:nouvelle_locationfrsspeed.html.twig', array('form' => $form->createView(),
            'bdcid' => $bdcid,
            'locid' => $locid,
            'reference' => $reference,
            'designation' => $designation,
            'facture' => $facture,
            'documents' => $documents,
            'message' => $message));
    }


    public function modifierfacfrsAction($ficheid, $locid, $type, $bdctransport, $erreur, Request $request)
    {
        $objUser = $this->get('security.context')->getToken()->getUsername(); if(empty($objUser) or !isset($objUser) or $objUser == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        $em = $this->getDoctrine()->getManager();//echo 'locid'.$locid;
        $bdcid = $locid;//echo 'bdcid'.$bdcid;
        if($type == 1)
        {
            $locatafrs  = $em->getRepository('BaclooCrmBundle:Locatafrs')
                ->findOneById($bdcid);	//echo 'ici'.$locatafrs->getId();
            $form = $this->createForm(new LocatafrsType(), $locatafrs);
        }
        else
        {
            $locatafrs  = $em->getRepository('BaclooCrmBundle:Locatafrsclone')
                ->findOneById($bdcid);	//echo 'ici'.$locatafrs->getId();
            $form = $this->createForm(new LocatafrscloneType(), $locatafrs);
        }
        $bdcid = $locatafrs->getId();

        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($objUser);
        $userid = $userdetails->getId();

        $today = date('Y-m-d');
        $year = date('Y');
        include('societe.php');

        //On met les locationsfrs dans un array pour controle ultérieur
        // $listeloc = array();
        // foreach ($locatafrs->getLocationsfrs() as $loc) {
        // $listeloc[] = $loc;
        // }

        $em = $this->getDoctrine()->getManager();
        $modules  = $em->getRepository('BaclooCrmBundle:Modules')
            ->findOneByUsername($objUser);

        $fournisseur  = $em->getRepository('BaclooCrmBundle:Fiche')
            ->findOneById($ficheid);

        // On récupère la requête
        $request = $this->get('request');
        // On vérifie qu'elle est de type POST
        if ($request->getMethod() == 'POST')
        {
            $form->bind($request);
            // On vérifie que les valeurs entrées sont correctes
            // $data = $form->getData();
            if ($form->isValid()){
                //Création du numero dde bdc unique

                // $locatafrs->set
                $em->persist($locatafrs);
                // $em->flush();

                $fournisseurnom = $form->get('fournisseur')->getData();echo 'XXX';echo $fournisseurnom;
                $nomchantier = $form->get('nomchantier')->getData();
                $adresse1 = $form->get('adresse1')->getData();
                $adresse2 = $form->get('adresse2')->getData();
                $adresse3 = $form->get('adresse3')->getData();
                $cp = $form->get('cp')->getData();
                $ville = $form->get('ville')->getData();
                $locationsfrs = $form->get('locationsfrsclone')->getData();


                //Mise à jour de la table chantier si le chantier n'existe pas
                $chantier = $em->getRepository('BaclooCrmBundle:Chantier')
                    ->findOneByNom($nomchantier);

                //Fin maj chantier

                $quantite = 0;
                $locationht = 0;
                $assuranceht = 0;
                $contributionverteht = 0;
                $pieceht = 0;
                $transportht = 0;
                $materielht = 0;
                $prestationht = 0;
                $autreht = 0;
                $locpu = 0;

                //Création du montant HT ligne par ligne
                $totalht = 0;//echo $locid;
                if($type == 1)
                {
                    foreach ($form->get('locationsfrs')->getData() as $loc)
                    {echo ' EFERENCE'.$loc->getReference();	echo'debutloc';echo $loc->getDebutloc();
                        $fournisseur = $em->getRepository('BaclooCrmBundle:Fiche')
                            ->findOneById($ficheid);
                        $fournisseurnom = $fournisseur->getRaisonSociale();
                        $fournisseurid = $fournisseur->getId();
                        //caclcul du nbjloc pour servir les quantité pour loc eco et assert
                        if(($loc->getReference() == 'Location de matériel' or $loc->getReference() == 'Location géolocalisation' or $loc->getReference() == 'contributionverte' or $loc->getReference() == 'assurance') && $loc->getDebutloc() != '' && $loc->getFinloc() != '')
                        {echo '11111';
                            $dStart = $loc->getDebutloc();
                            $dEnd = $loc->getFinloc();
                            $begin = new \DateTime($dStart);
                            $end = new \DateTime($dEnd);
                            $end = $end->modify( '+1 day' );

                            $interval = DateInterval::createFromDateString('1 day');
                            $period = new DatePeriod($begin, $interval, $end);
                            $nbjloc = 0;
                            $nbjlocass = 0;

                            foreach ($period as $dt) {
                                $newformat = $dt->format("D");
                                $nbjlocass++;
                                if($loc->getFacturersamedi() == 1 && $newformat == 'Sat')
                                {echo 'samedi';
                                    $nbjloc++;
                                }
                                elseif($loc->getFacturerdimanche() == 1 && $newformat == 'Sun')
                                {echo 'dimanche';
                                    $nbjloc++;
                                }
                                elseif($newformat == 'Sat' or $newformat == 'Sun')
                                {}
                                else
                                {echo 'autrejour';
                                    $nbjloc++;
                                }
                            }
                        }//echo '<br>NBJLOC'.$nbjloc;
                        if(empty($nbjloc)){$nbjloc = 0;}
                        if($loc->getReference() == 'Location de matériel' or $loc->getReference() == 'Location géolocalisation')
                        {echo '222222';
                            if($loc->getMensuel() == 1)
                            {echo 'aaa';
                                include('calculnbjlocmensuellebdc.php');
                                $locationht += $nbjloc*$loc->getPu()/20;echo 'LOCATIONHT'.$locationht;
                                $locationhtligne = $nbjloc*$loc->getPu()/20;
                                if(null !== $locatafrs->getCodelocatasl() && $locatafrs->getCodelocatasl() > 0)
                                {
                                    $loc->setQuantite($nbjloc/20);
                                }
                            }
                            else
                            {echo 'nbjloc'.$nbjloc;
                                if($nbjloc > 0)
                                {echo 'bbb';
                                    $locationht += $nbjloc*$loc->getPu();echo 'LOCATIONHT'.$locationht;
                                    $locationhtligne = $nbjloc*$loc->getPu();
                                    if((null !== $locatafrs->getCodelocatasl() && $locatafrs->getCodelocatasl() > 0) or (null !==$loc->getDebutloc() && null !== $loc->getFinloc()))
                                    {echo'yes';
                                        $loc->setQuantite($nbjloc);
                                    }else{echo 'no';}
                                }
                                else
                                {
                                    $locationht += $loc->getQuantite()*$loc->getPu();echo 'LOCATIONHT'.$locationht;
                                    $locationhtligne = $loc->getQuantite()*$loc->getPu();echo 'locationhtligne'.$locationhtligne;
                                }
                            }
                            $loc->setMontantht($locationhtligne);
                        }
                        elseif($loc->getReference() == 'piece')
                        {echo '333333333';
                            $pieceht += $loc->getQuantite()*$loc->getPu();
                            $piecehtligne = $loc->getQuantite()*$loc->getPu();
                            $articles = $em->getRepository('BaclooCrmBundle:Articlesenvente')
                                ->findOneByDesignation($loc->getDesignation());
                            if(isset($articles))
                            {
                                $articles->setEnattentereception($loc->getQuantite());
                                $em->persist($articles);
                            }
                            $loc->setMontantht($piecehtligne);
                        }
                        elseif($loc->getReference() == 'assurance')
                        {echo '444444444';
                            //Calcul locationht
                            if($loc->getMensuel() == 1)
                            {
                                if($nbjloc < 20)
                                {
                                    $assuranceht = ($loc->getPu()/20)*$nbjloc;
                                }
                                else
                                {
                                    $assuranceht = $loc->getPu();
                                    $nbjloc = 20;
                                    $nbjlocass = 28;
                                }
                                //PBM Locationht est faux pour assurance et contributionverte. donc ne pas renseigner le PU ok pour la quantité
                                //calcul de l'assurance
                                if($fournisseur->getFrsrc() == 1)
                                {
                                    if($fournisseur->getUniterc() == '%')
                                    {
                                        $assuranceunite = $assuranceht * $fournisseur->getMontantrc()/100;
                                    }
                                    else
                                    {
                                        $assuranceunite = $fournisseur->getMontantrc();
                                    }
                                    if($fournisseur->getBasecalculrc() == 1)
                                    {
                                        $assurance = $assuranceunite;
                                    }
                                    elseif($fournisseur->getBasecalculeco() == 5)
                                    {
                                        $assurance = $assuranceunite*$nbjloc;
                                    }
                                    elseif($fournisseur->getBasecalculeco() == 7)
                                    {
                                        $assurance = $assuranceunite*$nbjlocass;
                                    }

                                }
                                else//si pas d'eco
                                {
                                    $assurance = 0;
                                }
                            }
                            else//Si Loyer pas mensuel
                            {echo 'loyer pas mensuel';echo 'NBJLOC'.$nbjloc;
                                $locationht = $loc->getPu()*$nbjloc;echo 'LOCATION HT'.$locationht;echo 'PUUU'.$loc->getPU();

                                $loc->setMontantht($locationht);
                                $totalht += $locationht;
                                $loc->setPu($loc->getPu());
                                if($loc->getReference() == 'assurance')
                                {
                                    if(null !== $locatafrs->getCodelocatasl() && $locatafrs->getCodelocatasl() > 0)
                                    {echo 'ccc';
                                        $loc->setQuantite($nbjloc);
                                    }
                                }
                                //calcul de l'assurance
                                if($fournisseur->getFrsrc() == 1)
                                {echo 'AUTO';
                                    if($fournisseur->getUniterc() == '%')
                                    {echo '%%%';
                                        $assuranceunite = $locationht * $fournisseur->getMontantrc()/100;echo 'ASSSURANCEUNITE'.$assuranceunite;
                                    }
                                    else
                                    {
                                        $assuranceunite = $fournisseur->getMontantrc();
                                    }
                                    if($fournisseur->getBasecalculrc() == 1)
                                    {
                                        $assurance = $assuranceunite;
                                    }
                                    elseif($fournisseur->getBasecalculrc() == 5)
                                    {
                                        $assurance = $assuranceunite*$nbjloc;
                                    }
                                    elseif($fournisseur->getBasecalculrc() == 7)
                                    {
                                        $assurance = $assuranceunite*$nbjloc;
                                    }

                                }
                                else//si pas d'eco
                                {echo 'PAS AUTO';
                                    $assurance = 0;
                                }
                            }
                            $loc->setPu($loc->getPu());echo 'ASSURANCE'.$assurance;
                            if($assurance == 0 && $loc->getQuantite() > 0){$assurancehtligne = $loc->getPu()*$loc->getQuantite();}else{$assurancehtligne = $assurance;}
                            if(null !== $locatafrs->getCodelocatasl() && $locatafrs->getCodelocatasl() > 0)
                            {echo 'ddd';
                                $loc->setQuantite($nbjlocass);
                            }
                            $assuranceht += $nbjlocass*$loc->getPu();
                            $loc->setMontantht($assurancehtligne);
                            $loc->setFournisseur($fournisseurnom);
                            $loc->setFournisseurid($fournisseurid);
                        }
                        elseif($loc->getReference() == 'contributionverte')
                        {echo '5555555555';

                            //Calcul locationht
                            if($loc->getMensuel() == 1)
                            {
                                if($nbjloc < 20)
                                {echo 'yyyyyyyy';
                                    $locationht = ($loc->getPu()/20)*$nbjloc;
                                }
                                else
                                {echo 'dddddddddda';
                                    $locationht = $loc->getPu();
                                    $nbjloc = 20;
                                    $nbjlocass = 28;
                                }
                                //calcul de l'ecoparticiaption
                                if($fournisseur->getFrseco() == 1)
                                {echo 'uuuuuuuuuu';
                                    if($fournisseur->getUniteeco() == '%')
                                    {
                                        $ecopartunite = $locationht * $fournisseur->getMontanteco()/100;
                                    }
                                    else
                                    {
                                        $ecopartunite = $fournisseur->getMontanteco();
                                    }
                                    if($fournisseur->getBasecalculeco() == 1)
                                    {
                                        $contributionverte = $ecopartunite;
                                        $nbjloceco = 1;
                                    }
                                    elseif($fournisseur->getBasecalculeco() == 5)
                                    {
                                        $contributionverte = $ecopartunite*$nbjloc;
                                        $nbjloceco = $nbjloc;
                                    }
                                    elseif($fournisseur->getBasecalculeco() == 7)
                                    {
                                        $contributionverte = $ecopartunite*$nbjlocass;
                                        $nbjloceco = $nbjlocass;
                                    }
                                }
                                else//si pas d'eco
                                {echo 'iiiiiiiiiiiiii';
                                    $contributionverte = 0;
                                }
                            }
                            else//Si Loyer pas mensuel
                            {
                                $locationht = $loc->getPu()*$nbjloc;

                                //calcul de l'ecoparticiaption
                                if($fournisseur->getFrseco() == 1)
                                {
                                    if($fournisseur->getUniteeco() == '%')
                                    {
                                        $ecopartunite = $locationht * $fournisseur->getMontanteco()/100;
                                    }
                                    else
                                    {
                                        $ecopartunite = $fournisseur->getMontanteco();
                                    }
                                    if($fournisseur->getBasecalculeco() == 1)
                                    {
                                        $contributionverte = $ecopartunite;
                                        $nbjloceco = 1;
                                    }
                                    elseif($fournisseur->getBasecalculeco() == 5)
                                    {
                                        $contributionverte = $ecopartunite*$nbjloc;
                                        $nbjloceco = $nbjloc;
                                    }
                                    elseif($fournisseur->getBasecalculeco() == 7)
                                    {
                                        $contributionverte = $ecopartunite*$nbjlocass;
                                        $nbjloceco = $nbjlocass;
                                    }echo 'YYY';
                                }
                                else//si pas d'eco
                                {echo 'XXXX';
                                    $contributionverte = 0;
                                }
                            }//echo 'nbjloceco1x'.$nbjloceco;
                            echo 'PU'.$loc->getPu();
                            echo 'QUANTITE'.$loc->getQuantite();
                            if($contributionverte == 0 && $loc->getQuantite() > 0){$contributionvertehtligne = $loc->getPu()*$loc->getQuantite();}else{$contributionvertehtligne = $contributionverte;}
                            $loc->setPu($loc->getPu());
                            if(null !== $locatafrs->getCodelocatasl() && $locatafrs->getCodelocatasl() > 0)
                            {echo 'eee';
                                $loc->setQuantite($nbjloceco);
                            }
                            $contributionverteht += $contributionvertehtligne;
                            $loc->setMontantht($contributionvertehtligne);
                        }
                        elseif($loc->getReference() == 'transport')
                        {echo '66666666';
                            $transportht += $loc->getQuantite()*$loc->getPu();
                            $transporthtligne = $loc->getQuantite()*$loc->getPu();
                            $loc->setMontantht($transporthtligne);
                        }
                        elseif($loc->getReference() == 'materiel')
                        {echo '777777';
                            $materielht += $loc->getQuantite()*$loc->getPu();
                            $materielhtligne = $loc->getQuantite()*$loc->getPu();
                            $loc->setMontantht($materielhtligne);
                        }
                        elseif($loc->getReference() == 'prestation')
                        {echo '8888888888';
                            $prestationht += $loc->getQuantite()*$loc->getPu();
                            $prestationhtligne = $loc->getQuantite()*$loc->getPu();
                            $loc->setMontantht($prestationhtligne);
                        }
                        elseif($loc->getReference() == 'autre')
                        {echo '9999999999';
                            $autreht += $loc->getQuantite()*$loc->getPu();
                            $autrehtligne = $loc->getQuantite()*$loc->getPu();
                            $loc->setMontantht($autrehtligne);
                        }
                        else
                        {echo '***********';echo $loc->getQuantite();echo $loc->getPu();
                            $autreht += $loc->getQuantite()*$loc->getPu();
                            $autrehtligne = $loc->getQuantite()*$loc->getPu();
                            $articles = $em->getRepository('BaclooCrmBundle:Articlesenvente')
                                ->findOneByDesignation($loc->getDesignation());
                            if(isset($articles))
                            {
                                $articles->setEnattentereception($loc->getQuantite());
                                $em->persist($articles);
                            }
                            $loc->setMontantht($autrehtligne);
                        }
                        // $loc->setCodeclient($fournisseur->getId());
                    }
                }
                else
                {
                    foreach ($form->get('locationsfrsclone')->getData() as $loc)
                    {echo ' EFERENCE'.$loc->getReference();	echo'debutloc';echo $loc->getDebutloc();
                        $fournisseur = $em->getRepository('BaclooCrmBundle:Fiche')
                            ->findOneById($ficheid);
                        $fournisseurnom = $fournisseur->getRaisonSociale();
                        $fournisseurid = $fournisseur->getId();
                        //caclcul du nbjloc pour servir les quantité pour loc eco et assert
                        if(($loc->getReference() == 'location' or $loc->getReference() == 'contributionverte' or $loc->getReference() == 'assurance') && $loc->getDebutloc() != '' && $loc->getFinloc() != '')
                        {echo '11111';
                            $dStart = $loc->getDebutloc();
                            $dEnd = $loc->getFinloc();
                            $begin = new \DateTime($dStart);
                            $end = new \DateTime($dEnd);
                            $end = $end->modify( '+1 day' );

                            $interval = DateInterval::createFromDateString('1 day');
                            $period = new DatePeriod($begin, $interval, $end);
                            $nbjloc = 0;
                            $nbjlocass = 0;

                            foreach ($period as $dt) {
                                $newformat = $dt->format("D");
                                $nbjlocass++;
                                if($loc->getFacturersamedi() == 1 && $newformat == 'Sat')
                                {echo 'samedi';
                                    $nbjloc++;
                                }
                                elseif($loc->getFacturerdimanche() == 1 && $newformat == 'Sun')
                                {echo 'dimanche';
                                    $nbjloc++;
                                }
                                elseif($newformat == 'Sat' or $newformat == 'Sun')
                                {}
                                else
                                {echo 'autrejour';
                                    $nbjloc++;
                                }
                            }
                        }//echo '<br>NBJLOC'.$nbjloc;
                        if(empty($nbjloc)){$nbjloc = 0;}
                        if($loc->getReference() == 'location')
                        {echo '222222';
                            if($loc->getMensuel() == 1)
                            {echo 'aaa';
                                include('calculnbjlocmensuellebdc.php');
                                $locationht += $nbjloc*$loc->getPu()/20;echo 'LOCATIONHT'.$locationht;
                                $locationhtligne = $nbjloc*$loc->getPu()/20;
                                if(null !== $locatafrs->getCodelocatasl() && $locatafrs->getCodelocatasl() > 0)
                                {
                                    $loc->setQuantite($nbjloc/20);
                                }
                            }
                            else
                            {echo 'nbjloc'.$nbjloc;
                                if($nbjloc > 0)
                                {echo 'bbb';
                                    $locationht += $nbjloc*$loc->getPu();echo 'LOCATIONHT'.$locationht;
                                    $locationhtligne = $nbjloc*$loc->getPu();
                                    if((null !== $locatafrs->getCodelocatasl() && $locatafrs->getCodelocatasl() > 0) or (null !==$loc->getDebutloc() && null !== $loc->getFinloc()))
                                    {echo'yes';
                                        $loc->setQuantite($nbjloc);
                                    }else{echo 'no';}
                                }
                                else
                                {
                                    $locationht += $loc->getQuantite()*$loc->getPu();echo 'LOCATIONHT'.$locationht;
                                    $locationhtligne = $loc->getQuantite()*$loc->getPu();echo 'locationhtligne'.$locationhtligne;
                                }
                            }
                            $loc->setMontantht($locationhtligne);
                        }
                        elseif($loc->getReference() == 'piece')
                        {echo '333333333';
                            $pieceht += $loc->getQuantite()*$loc->getPu();
                            $piecehtligne = $loc->getQuantite()*$loc->getPu();
                            $articles = $em->getRepository('BaclooCrmBundle:Articlesenvente')
                                ->findOneByDesignation($loc->getDesignation());
                            if(isset($articles))
                            {
                                $articles->setEnattentereception($loc->getQuantite());
                                $em->persist($articles);
                            }
                            $loc->setMontantht($piecehtligne);
                        }
                        elseif($loc->getReference() == 'assurance')
                        {echo '444444444';
                            //Calcul locationht
                            if($loc->getMensuel() == 1)
                            {
                                if($nbjloc < 20)
                                {
                                    $assuranceht = ($loc->getPu()/20)*$nbjloc;
                                }
                                else
                                {
                                    $assuranceht = $loc->getPu();
                                    $nbjloc = 20;
                                    $nbjlocass = 28;
                                }
                                //PBM Locationht est faux pour assurance et contributionverte. donc ne pas renseigner le PU ok pour la quantité
                                //calcul de l'assurance
                                if($fournisseur->getFrsrc() == 1)
                                {
                                    if($fournisseur->getUniterc() == '%')
                                    {
                                        $assuranceunite = $assuranceht * $fournisseur->getMontantrc()/100;
                                    }
                                    else
                                    {
                                        $assuranceunite = $fournisseur->getMontantrc();
                                    }
                                    if($fournisseur->getBasecalculrc() == 1)
                                    {
                                        $assurance = $assuranceunite;
                                    }
                                    elseif($fournisseur->getBasecalculeco() == 5)
                                    {
                                        $assurance = $assuranceunite*$nbjloc;
                                    }
                                    elseif($fournisseur->getBasecalculeco() == 7)
                                    {
                                        $assurance = $assuranceunite*$nbjlocass;
                                    }

                                }
                                else//si pas d'eco
                                {
                                    $assurance = 0;
                                }
                            }
                            else//Si Loyer pas mensuel
                            {echo 'loyer pas mensuel';echo 'NBJLOC'.$nbjloc;
                                $locationht = $loc->getPu()*$nbjloc;echo 'LOCATION HT'.$locationht;echo 'PUUU'.$loc->getPU();

                                $loc->setMontantht($locationht);
                                $totalht += $locationht;
                                $loc->setPu($loc->getPu());
                                if($loc->getReference() == 'assurance')
                                {
                                    if(null !== $locatafrs->getCodelocatasl() && $locatafrs->getCodelocatasl() > 0)
                                    {echo 'ccc';
                                        $loc->setQuantite($nbjloc);
                                    }
                                }
                                //calcul de l'assurance
                                if($fournisseur->getFrsrc() == 1)
                                {echo 'AUTO';
                                    if($fournisseur->getUniterc() == '%')
                                    {echo '%%%';
                                        $assuranceunite = $locationht * $fournisseur->getMontantrc()/100;echo 'ASSSURANCEUNITE'.$assuranceunite;
                                    }
                                    else
                                    {
                                        $assuranceunite = $fournisseur->getMontantrc();
                                    }
                                    if($fournisseur->getBasecalculrc() == 1)
                                    {
                                        $assurance = $assuranceunite;
                                    }
                                    elseif($fournisseur->getBasecalculrc() == 5)
                                    {
                                        $assurance = $assuranceunite*$nbjloc;
                                    }
                                    elseif($fournisseur->getBasecalculrc() == 7)
                                    {
                                        $assurance = $assuranceunite*$nbjloc;
                                    }

                                }
                                else//si pas d'eco
                                {echo 'PAS AUTO';
                                    $assurance = 0;
                                }
                            }
                            $loc->setPu($loc->getPu());echo 'ASSURANCE'.$assurance;
                            if($assurance == 0 && $loc->getQuantite() > 0){$assurancehtligne = $loc->getPu()*$loc->getQuantite();}else{$assurancehtligne = $assurance;}
                            if(null !== $locatafrs->getCodelocatasl() && $locatafrs->getCodelocatasl() > 0)
                            {echo 'ddd';
                                $loc->setQuantite($nbjlocass);
                            }
                            $assuranceht += $nbjlocass*$loc->getPu();
                            $loc->setMontantht($assurancehtligne);
                            $loc->setFournisseur($fournisseurnom);
                            $loc->setFournisseurid($fournisseurid);
                        }
                        elseif($loc->getReference() == 'contributionverte')
                        {echo '5555555555';

                            //Calcul locationht
                            if($loc->getMensuel() == 1)
                            {
                                if($nbjloc < 20)
                                {echo 'yyyyyyyy';
                                    $locationht = ($loc->getPu()/20)*$nbjloc;
                                }
                                else
                                {echo 'dddddddddda';
                                    $locationht = $loc->getPu();
                                    $nbjloc = 20;
                                    $nbjlocass = 28;
                                }
                                //calcul de l'ecoparticiaption
                                if($fournisseur->getFrseco() == 1)
                                {echo 'uuuuuuuuuu';
                                    if($fournisseur->getUniteeco() == '%')
                                    {
                                        $ecopartunite = $locationht * $fournisseur->getMontanteco()/100;
                                    }
                                    else
                                    {
                                        $ecopartunite = $fournisseur->getMontanteco();
                                    }
                                    if($fournisseur->getBasecalculeco() == 1)
                                    {
                                        $contributionverte = $ecopartunite;
                                        $nbjloceco = 1;
                                    }
                                    elseif($fournisseur->getBasecalculeco() == 5)
                                    {
                                        $contributionverte = $ecopartunite*$nbjloc;
                                        $nbjloceco = $nbjloc;
                                    }
                                    elseif($fournisseur->getBasecalculeco() == 7)
                                    {
                                        $contributionverte = $ecopartunite*$nbjlocass;
                                        $nbjloceco = $nbjlocass;
                                    }
                                }
                                else//si pas d'eco
                                {echo 'iiiiiiiiiiiiii';
                                    $contributionverte = 0;
                                }
                            }
                            else//Si Loyer pas mensuel
                            {
                                $locationht = $loc->getPu()*$nbjloc;

                                //calcul de l'ecoparticiaption
                                if($fournisseur->getFrseco() == 1)
                                {
                                    if($fournisseur->getUniteeco() == '%')
                                    {
                                        $ecopartunite = $locationht * $fournisseur->getMontanteco()/100;
                                    }
                                    else
                                    {
                                        $ecopartunite = $fournisseur->getMontanteco();
                                    }
                                    if($fournisseur->getBasecalculeco() == 1)
                                    {
                                        $contributionverte = $ecopartunite;
                                        $nbjloceco = 1;
                                    }
                                    elseif($fournisseur->getBasecalculeco() == 5)
                                    {
                                        $contributionverte = $ecopartunite*$nbjloc;
                                        $nbjloceco = $nbjloc;
                                    }
                                    elseif($fournisseur->getBasecalculeco() == 7)
                                    {
                                        $contributionverte = $ecopartunite*$nbjlocass;
                                        $nbjloceco = $nbjlocass;
                                    }echo 'YYY';
                                }
                                else//si pas d'eco
                                {echo 'XXXX';
                                    $contributionverte = 0;
                                }
                            }//echo 'nbjloceco1x'.$nbjloceco;
                            echo 'PU'.$loc->getPu();
                            echo 'QUANTITE'.$loc->getQuantite();
                            if($contributionverte == 0 && $loc->getQuantite() > 0){$contributionvertehtligne = $loc->getPu()*$loc->getQuantite();}else{$contributionvertehtligne = $contributionverte;}
                            $loc->setPu($loc->getPu());
                            if(null !== $locatafrs->getCodelocatasl() && $locatafrs->getCodelocatasl() > 0)
                            {echo 'eee';
                                $loc->setQuantite($nbjloceco);
                            }
                            $contributionverteht += $contributionvertehtligne;
                            $loc->setMontantht($contributionvertehtligne);
                        }
                        elseif($loc->getReference() == 'transport')
                        {echo '66666666';
                            $transportht += $loc->getQuantite()*$loc->getPu();
                            $transporthtligne = $loc->getQuantite()*$loc->getPu();
                            $loc->setMontantht($transporthtligne);
                        }
                        elseif($loc->getReference() == 'materiel')
                        {echo '777777';
                            $materielht += $loc->getQuantite()*$loc->getPu();
                            $materielhtligne = $loc->getQuantite()*$loc->getPu();
                            $loc->setMontantht($materielhtligne);
                        }
                        elseif($loc->getReference() == 'prestation')
                        {echo '8888888888';
                            $prestationht += $loc->getQuantite()*$loc->getPu();
                            $prestationhtligne = $loc->getQuantite()*$loc->getPu();
                            $loc->setMontantht($prestationhtligne);
                        }
                        elseif($loc->getReference() == 'autre')
                        {echo '9999999999';
                            $autreht += $loc->getQuantite()*$loc->getPu();
                            $autrehtligne = $loc->getQuantite()*$loc->getPu();
                            $loc->setMontantht($autrehtligne);
                        }
                        else
                        {echo '***********';echo $loc->getQuantite();echo $loc->getPu();
                            $autreht += $loc->getQuantite()*$loc->getPu();
                            $autrehtligne = $loc->getQuantite()*$loc->getPu();
                            $articles = $em->getRepository('BaclooCrmBundle:Articlesenvente')
                                ->findOneByDesignation($loc->getDesignation());
                            if(isset($articles))
                            {
                                $articles->setEnattentereception($loc->getQuantite());
                                $em->persist($articles);
                            }
                            $loc->setMontantht($autrehtligne);
                        }
                        // $loc->setCodeclient($fournisseur->getId());
                    }
                }

                $totalht = $locationht + $assuranceht + $contributionverteht + $pieceht + $transportht + $materielht + $prestationht + $autreht;
                $tva = $totalht * 0.20;
                $totalttc = $totalht + $tva;
// echo $fournisseurnom;
                $locatafrs->setMontantloc($totalht);
                $locatafrs->setFournisseur($fournisseurnom);
                $locatafrs->setFournisseurid($ficheid);
                $em->persist($locatafrs);
                $em->flush();

                $bdcid = $locatafrs->getId();


                $em->flush();

                // On redirige vers la page de visualisation de la fiche nouvellement créée
                return $this->redirect($this->generateUrl('bacloocrm_modifierfacfrs', array('ficheid' => $ficheid, 'locid' => $locatafrs->getId(), 'type' => $type )));
            }
        }

        if($bdcid > 0)
        {//echo 'laaa';
            $totalht = $locatafrs->getMontantloc();
            $grille = array();
        }
        else
        {//echo 'ici';
            $totalht = 0;
        }
        // echo $grille;

        // echo $locid;

        if($type == 1)
        {
            // On redirige vers la page de visualisation de la fiche nouvellement créée
            return $this->redirect($this->generateUrl('bacloocrm_ajouterlocationfrs', array('ficheid' => $ficheid, 'locid' => $locatafrs->getId(), 'mode' => 0 )));
        }
        else
        {
            // On redirige vers la page de visualisation de la fiche nouvellement créée
            return $this->render('BaclooCrmBundle:Crm:modifier_locationfrs.html.twig', array('form' => $form->createView(),
                'date' => $today,
                'fournisseur' => $fournisseur,
                'usersociete' => $societe,
                'modules' => $modules,
                'entreprise' => $fournisseur->getRaisonSociale(),
                'typefiche' => $fournisseur->getTypefiche(),
                'id' => $ficheid,
                'erreur' => $erreur,
                'bdcid' => $bdcid,
                'totalht' => $totalht,
                'user' => $objUser));
        }
    }

    // public function genererpdf($html)
    // {
//         //set_time_limit(30); uncomment this line according to your needs
//         // If you are not in a controller, retrieve of some way the service container and then retrieve it
//         //$pdf = $this->container->get("white_october.tcpdf")->create('vertical', PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);
    // if you are in a controlller use :
//         $pdf = $this->get("white_october.tcpdf")->create('vertical', PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);
//         $pdf->SetAuthor('Our Code World');
//         $pdf->SetTitle(('Our Code World Title'));
//         $pdf->SetSubject('Our Code World Subject');
//         $pdf->setFontSubsetting(true);
//         $pdf->SetFont('helvetica', '', 11, '', true);
//         //$pdf->SetMargins(20,20,40, true);
//         $pdf->AddPage();
//         
//         $filename = 'ourcodeworld_pdf_demo';
//         
//         $pdf->writeHTMLCell($w = 0, $h = 0, $x = '', $y = '', $html, $border = 0, $ln = 1, $fill = 0, $reseth = true, $align = '', $autopadding = true);
//         $pdf->Output($filename.".pdf",'I'); // This will output the PDF as a response directly
    // }

    public function testpdfAction()
    {
        $title_page = 'Bon de commande';
        $pdf = $this->get("white_october.tcpdf")->create();
        $html = $this->renderView('BaclooCrmBundle:Crm:testpdf.html.twig', array('texte' => 'test',
            'texte2' => 'texte plus long pour tester',
            'texte3' => 'texte3'));
        $pdf->SetCreator(PDF_CREATOR);
        $pdf->SetAuthor('Nicola Asuni');
        $pdf->SetTitle('TCPDF Example 003');
        $pdf->SetSubject('TCPDF Tutorial');
        $pdf->SetKeywords('TCPDF, PDF, example, test, guide');

        // set default header data
        $pdf->SetHeaderData(PDF_HEADER_LOGO, PDF_HEADER_LOGO_WIDTH, PDF_HEADER_TITLE, PDF_HEADER_STRING);

        // set header and footer fonts
        $pdf->setHeaderFont(Array(PDF_FONT_NAME_MAIN, '', PDF_FONT_SIZE_MAIN));
        $pdf->setFooterFont(Array(PDF_FONT_NAME_DATA, '', PDF_FONT_SIZE_DATA));

        // set default monospaced font
        $pdf->SetDefaultMonospacedFont(PDF_FONT_MONOSPACED);

        // set margins
        $pdf->SetMargins(PDF_MARGIN_LEFT, PDF_MARGIN_TOP, PDF_MARGIN_RIGHT);
        $pdf->SetHeaderMargin(PDF_MARGIN_HEADER);
        $pdf->SetFooterMargin(PDF_MARGIN_FOOTER);

        // set auto page breaks
        $pdf->SetAutoPageBreak(TRUE, PDF_MARGIN_BOTTOM);

        // set image scale factor
        $pdf->setImageScale(PDF_IMAGE_SCALE_RATIO);

        // set some language-dependent strings (optional)
        if (@file_exists(dirname(__FILE__).'/lang/eng.php')) {
            require_once(dirname(__FILE__).'/lang/eng.php');
            $pdf->setLanguageArray($l);
        }

        // ---------------------------------------------------------

        // set font
        $pdf->SetFont('helvetica', '', 11, '', true);

        $pdf->AddPage();
        $pdf->writeHTML($html, true, false, true, false, '');
        $pdf->lastPage();

        $response = new Response($pdf->Output('file.pdf'));
        $response->headers->set('Content-Type', 'application/pdf');

        return $response;
    }

    public function ajouterlocationpdfAction($ficheid, $locid, $mode, Request $request)
    {
        $objUser = $this->get('security.context')->getToken()->getUsername(); if(empty($objUser) or !isset($objUser) or $objUser == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        // if ($this->container->has('profiler'))
        // {
        // $this->container->get('profiler')->disable();
        // }
        $today = date('Y-m-d');
        $year = date('Y');
        $erreur = 0;
        $em = $this->getDoctrine()->getManager();//echo 'locid'.$locid;

        $client  = $em->getRepository('BaclooCrmBundle:Fiche')
            ->findOneById($ficheid);
        // On crée un objet Locata
        if($locid == 0)
        {
            $locata = new Locata;
            $contrat = 0;
            $bdcrecu = 0;
            $montantcarb = 0;
        }
        else
        {
            $locata  = $em->getRepository('BaclooCrmBundle:Locata')
                ->findOneById($locid);
            if($client->getAssurance() == 1 && $locata->getAssurance() == 0)
            {
                $locata->setAssurance(0);
                $em->persist($locata);
                $em->flush();
            }

            $contrat = $locata->getContrat();
            $bdcrecu = $locata->getBdcrecu();
        }
        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($objUser);
        $userid = $userdetails->getId();
        $form = $this->createForm(new LocataType(), $locata);

        $objUser = $this->get('security.context')->getToken()->getUsername(); if(empty($objUser) or !isset($objUser) or $objUser == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        $today = date('Y-m-d');
        include('societe.php');

        //On met les locations dans un array pour controle ultérieur
        // $listeloc = array();
        // foreach ($locata->getLocations() as $loc) {
        // $listeloc[] = $loc;
        // }

        $em = $this->getDoctrine()->getManager();
        $modules  = $em->getRepository('BaclooCrmBundle:Modules')
            ->findOneByUsername($objUser);

        // On récupère la requête
        $request = $this->get('request');
        // On vérifie qu'elle est de type POST
        $listedispos = array();
        $nacelle = 0;
        if($locid > 0)
        {//echo 'laaa';
            // $dstart = new \DateTime($locata->getDebutloc());
            // $dend = new \DateTime($locata->getFinloc());
            $listedispos = array();
            $listecodes = array();
            $totalht = 0;//echo $locid;
            $totaltrspaller = 0;
            $totaltrspretour = 0;
            $montantcarb = 0;
            $contributionverte = 0;
            $assurance = 0;
            $facturersamedi = $locata->getFacturersamedi();
            $facturerdimanche = $locata->getFacturerdimanche();
            $facturationferies = $locata->getFacturationferies();

            //Calcul total ht loc parc
            foreach($locata->getLocations() as $loca)
            {
                $result = substr($loca->getTypemachine(), 0, 7);
                if($result == 'Nacelle')
                {
                    $nacelle = 1;
                }
                $dstart = $loca->getDebutloc();
                $dend = $loca->getFinloc();
                $dstartok = date('Y-m-d', strtotime($dstart . ' -1 day'));
                $dendok = date('Y-m-d', strtotime($dend . ' +1 day'));
                $codemachine = $loca->getCodemachine();
                $dispos = $em->getRepository('BaclooCrmBundle:Machines')
                    ->dispos($codemachine, $dstartok, $dendok);
                // print_r($dispos);echo $codemachine;
                $i = 0;
                foreach($dispos as $disp)
                {//echo 'AAA'.($disp['code']).'AAA';
                    $dispo = $em->getRepository('BaclooCrmBundle:Machines')
                        ->dispoprecise($disp['code'], $dstart, $dend);
                    // print_r($dispo);
                    if(!empty($dispo)){$i = $i + 1;}
                }
                $listedispos[$codemachine]= count($dispos) - $i;


                //FACTURATION
                $dStart = $loca->getDebutloc();
                $dEnd = $loca->getFinloc();

                //1.Récupérer les données de la table Machines

                //2.On génère les entêtes de colonnes à partir de la fonction createplanning
                $iStart = strtotime ($dStart);//Formate une date/heure locale avec la Something is wronguration locale
                $iEnd = strtotime ($dEnd);
                if (false === $iStart || false === $iEnd) {
                    return false;
                }
                $aStart = explode ('-', $dStart);
                $aEnd = explode ('-', $dEnd);
                if (count ($aStart) !== 3 || count ($aEnd) !== 3) {
                    return false;
                }
                if (false === checkdate ($aStart[1], $aStart[2], $aStart[0]) || false === checkdate ($aEnd[1], $aEnd[2], $aEnd[0]) || $iEnd <= $iStart) {
                    // return false;
                }
                $aDates = array();
                for ($i = $iStart; $i < $iEnd + 86400; $i = strtotime ('+1 day', $i) ) {
                    $sDateToArr = strftime ('%Y-%m-%d', $i);
                    $sYear = substr ($sDateToArr, 0, 4);
                    $sMonth = substr ($sDateToArr, 5, 2);

                    if(strftime ('%Y-%m-%d', $i) != strftime ('%Y-%m-%d', $i + 86400))
                    {
                        $aDates[] = $sDateToArr;//echo '>>'.$sDateToArr;
                    }
                }
                //on calcule le nombre de jours de location
                $nbjloc = 0;
                $feries = $this->getHolidays($year);
                foreach($aDates as $dat)
                {	//echo $dat;
                    $time = strtotime($dat);
                    $newformat = date('D',strtotime($dat));
                    // echo $dat;
                    //Calcul nb jours fériés
                    $i = 0;
                    foreach($feries as $fer)
                    {
                        if(date('m-d', $fer) == date('m-d', $time))
                        {
                            if($newformat !== 'Sat' and $newformat !== 'Sun')
                            {//echo 'grrr'.$dat;echo 'fuck'.$newformat;echo 'ladate'.date('D',strtotime($dat));echo 'newformat'.$newformat;
                                $i++;
                            }
                        }
                    }
                    //Facturation WE ou pas
                    $newformat = date('D',$time);

                    if($facturersamedi == 1 && $newformat == 'Sat')
                    {
                        $nbjloc++;
                    }
                    elseif($facturerdimanche == 1 && $newformat == 'Sun')
                    {
                        $nbjloc++;
                    }
                    elseif($newformat == 'Sat' or $newformat == 'Sun')
                    {}
                    else
                    {//echo '== ajout';
                        $nbjloc++;
                    }
                    if($facturationferies == 0)
                    {
                        $nbjloc = $nbjloc-$i;
                    }
                }
                // echo 'xx'.$nbjloc.'xx';
                // echo 'hh'.$i.'hh';

                //Création du montant HT ligne par ligne


                $grille  = $em->getRepository('BaclooCrmBundle:Grille')
                    ->findByCodeclient($locata->getClientid());

                if(null !== $loca->getLoyerp1())
                {
                    $totalht += $nbjloc * $loca->getLoyerp1();
                    $totalhtloc = $nbjloc * $loca->getLoyerp1();
                    $loyer = $loca->getLoyerp1();
                }
                elseif(null !== $loca->getLoyerp2())
                {
                    $totalht += $nbjloc * $loca->getLoyerp2();
                    $totalhtloc = $nbjloc * $loca->getLoyerp2();
                    $loyer = $loca->getLoyerp2();
                }
                elseif(null !== $loca->getLoyerp3())
                {
                    $totalht += $nbjloc * $loca->getLoyerp3();
                    $totalhtloc = $nbjloc * $loca->getLoyerp3();
                    $loyer = $loca->getLoyerp3();
                }
                elseif(null !== $loca->getLoyerp4())
                {
                    $totalht += $loca->getLoyerp4();
                    $totalhtloc = $loca->getLoyerp4();
                    $loyer = $loca->getLoyerp4();
                }
                elseif(null !== $loca->getLoyermensuel())
                {
                    include('calculnbjlocamensuelle.php');
                    $loyer = $loca->getLoyermensuel()/20;
                    $totalht += $loyer * $nbjloc;
                    $totalhtloc = $loyer * $nbjloc;
                }
                if(null !== $loca->getMontantcarb() && $loca->getMontantcarb()>0)
                {
                    $montantcarb += $loca->getLitrescarb()*1.97;
                }

                $totaltrspaller += $loca->getTransportaller();
                $totaltrspretour += $loca->getTransportretour();

                if($loca->getContributionverte() == 1)
                {
                    $contributionverte += 0.0215 * $loyer * $nbjloc;
                }

                if($loca->getAssurance() == 1)
                {
                    $assurance += $totalhtloc*0.10;
                }

            }

            //Calcul totalht Sous loc
            foreach($locata->getLocationssl() as $loca)
            {
                $result = substr($loca->getTypemachine(), 0, 7);
                if($result == 'Nacelle')
                {
                    $nacelle = 1;
                }
                $dstart = $loca->getDebutloc();
                $dend = $loca->getFinloc();
                $dstartok = date('Y-m-d', strtotime($dstart . ' -1 day'));
                $dendok = date('Y-m-d', strtotime($dend . ' +1 day'));
                $codemachine = $loca->getCodemachine();
                $dispos = $em->getRepository('BaclooCrmBundle:Machinessl')
                    ->dispos($codemachine, $dstartok, $dendok, $loca->getLoueur());
                // print_r($dispos);echo $codemachine;
                $i = 0;
                foreach($dispos as $disp)
                {//echo 'AAA'.($disp['code']).'AAA';
                    $dispo = $em->getRepository('BaclooCrmBundle:Machinessl')
                        ->dispoprecise($disp['code'], $dstart, $dend, $loca->getLoueur());
                    // print_r($dispo);
                    if(!empty($dispo)){$i = $i + 1;}
                }
                $listedispos[$codemachine]= count($dispos) - $i;


                //FACTURATION
                $dStart = $loca->getDebutloc();
                $dEnd = $loca->getFinloc();

                //1.Récupérer les données de la table Machines

                //2.On génère les entêtes de colonnes à partir de la fonction createplanning
                $iStart = strtotime ($dStart);//Formate une date/heure locale avec la Something is wronguration locale
                $iEnd = strtotime ($dEnd);
                if (false === $iStart || false === $iEnd) {
                    return false;
                }
                $aStart = explode ('-', $dStart);
                $aEnd = explode ('-', $dEnd);
                if (count ($aStart) !== 3 || count ($aEnd) !== 3) {
                    return false;
                }
                if (false === checkdate ($aStart[1], $aStart[2], $aStart[0]) || false === checkdate ($aEnd[1], $aEnd[2], $aEnd[0]) || $iEnd <= $iStart) {
                    // return false;
                }
                $aDates = array();
                for ($i = $iStart; $i < $iEnd + 86400; $i = strtotime ('+1 day', $i) ) {
                    $sDateToArr = strftime ('%Y-%m-%d', $i);
                    $sYear = substr ($sDateToArr, 0, 4);
                    $sMonth = substr ($sDateToArr, 5, 2);

                    if(strftime ('%Y-%m-%d', $i) != strftime ('%Y-%m-%d', $i + 86400))
                    {
                        $aDates[] = $sDateToArr;//echo '>>'.$sDateToArr;
                    }
                }
                //on calcule le nombre de jours de location
                $nbjloc = 0;
                $feries = $this->getHolidays(date('Y'));
                foreach($aDates as $dat)
                {	//echo $dat;
                    $time = strtotime($dat);
                    $newformat = date('D',strtotime($dat));
                    // echo $dat;
                    //Calcul nb jours fériés
                    $i = 0;
                    foreach($feries as $fer)
                    {
                        if(date('m-d', $fer) == date('m-d', $time))
                        {
                            if($newformat !== 'Sat' and $newformat !== 'Sun')
                            {
                                $i++;
                            }
                        }
                    }
                    //Facturation WE ou pas
                    $newformat = date('D',$time);
                    if($locata->getFacturersamedi() == 1 && $newformat == 'Sat')
                    {
                        $nbjloc++;
                    }
                    elseif($locata->getFacturerdimanche() == 1 && $newformat == 'Sun')
                    {
                        $nbjloc++;
                    }
                    elseif($newformat == 'Sat' or $newformat == 'Sun')
                    {}
                    else
                    {////echo '== ajout';
                        $nbjloc++;
                    }
                    if($locata->getFacturationferies() == 0)
                    {
                        $nbjloc = $nbjloc-$i;
                    }
                }
                // echo 'xx'.$nbjloc.'xx';
                // echo 'hh'.$i.'hh';

                //Création du montant HT ligne par ligne


                $grille  = $em->getRepository('BaclooCrmBundle:Grille')
                    ->findByCodeclient($locata->getClientid());

                if(null !== $loca->getLoyerp1())
                {
                    $totalht += $nbjloc * $loca->getLoyerp1();
                    $totalhtloc = $nbjloc * $loca->getLoyerp1();
                    $loyer = $loca->getLoyerp1();
                }
                elseif(null !== $loca->getLoyerp2())
                {
                    $totalht += $nbjloc * $loca->getLoyerp2();
                    $totalhtloc = $nbjloc * $loca->getLoyerp2();
                    $loyer = $loca->getLoyerp2();
                }
                elseif(null !== $loca->getLoyerp3())
                {
                    $totalht += $nbjloc * $loca->getLoyerp3();
                    $totalhtloc = $nbjloc * $loca->getLoyerp3();
                    $loyer = $loca->getLoyerp3();
                }
                elseif(null !== $loca->getLoyerp4())
                {
                    $totalht += $nbjloc * $loca->getLoyerp4();
                    $totalhtloc = $nbjloc * $loca->getLoyerp4();
                    $loyer = $loca->getLoyerp4();
                }
                elseif(null !== $loca->getLoyermensuel())
                {
                    include('calculnbjlocamensuelle.php');
                    $loyer = $loca->getLoyermensuel()/20;
                    $totalht += $loyer * $nbjloc;
                    $totalhtloc = $loyer * $nbjloc;
                }

                if(null !== $loca->getMontantcarb() && $loca->getMontantcarb()>0)
                {
                    $montantcarb += $loca->getLitrescarb()*1.97;
                }

                $totaltrspaller += $loca->getTransportaller();
                $totaltrspretour += $loca->getTransportretour();

                if($loca->getContributionverte() == 1)
                {
                    $contributionverte += 0.0215 * $loyer * $nbjloc;
                }

                if($loca->getAssurance() == 1)
                {
                    $assurance += $totalhtloc*0.10;
                }

            }

            $montantvente = 0;
            $totalvente = 0;
            foreach($locata->getLocataventes() as $ven)
            {
                $montantvente = $ven->getQuantite() * $ven->getPu();
                $totalvente += $ven->getQuantite() * $ven->getPu();
                // $em->flush();
            }


            // if($locata->getRemise() > 0)
            // {
            // $totalht = $totalht - ($totalht * $locata->getRemise()/100);
            // }


            //FIN FACTURATION

        }
        else
        {//echo 'ici';
            $totalht = 0;
            $nbjloc = 0;
            $nbjlocass = 0;
            $totalvente = 0;
            $grille = array();

        }

        $machines  = $em->getRepository('BaclooCrmBundle:Machines')
            ->findAll();
        $machinessl  = $em->getRepository('BaclooCrmBundle:Machinessl')
            ->findAll();

        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($objUser);
        $roleuser = $userdetails->getRoleuser();

        if(empty($nbjloc))
        {
            $totalht = 0;
            $nbjloc = 0;
            $nbjlocass = 0;
            $totalvente = 0;
            $erreur = 3;
            $grille = array();


        }

        $pdf = $this->get("white_october.tcpdf")->create();
        if($mode == 'bdl')
        {
            $html = $this->renderView('BaclooCrmBundle:Crm:bdl.html.twig', array('form' => $form->createView(),
                'mode' => $mode,
                'date' => $today,
                'roleuser' => $roleuser,
                'client' => $client,
                'locata' => $locata,
                'contrat' => $contrat,
                'bdcrecu' => $bdcrecu,
                'usersociete' => $societe,
                'modules' => $modules,
                'machines' => $machines,
                'machinessl' => $machinessl,
                'listedispos' => $listedispos,
                'entreprise' => $client->getRaisonSociale(),
                'id' => $ficheid,
                'erreur' => $erreur,
                'locid' => $locid,
                'totalht' => $totalht,
                'montantcarb' => $montantcarb,
                'totalvente' => $totalvente,
                'nbjloc' => $nbjloc,
                'grille' => $grille,
                'user' => $objUser));
        }
        elseif($mode == 'br')
        {
            $html = $this->renderView('BaclooCrmBundle:Crm:bdl.html.twig', array('form' => $form->createView(),
                'mode' => $mode,
                'date' => $today,
                'roleuser' => $roleuser,
                'client' => $client,
                'locata' => $locata,
                'contrat' => $contrat,
                'bdcrecu' => $bdcrecu,
                'usersociete' => $societe,
                'modules' => $modules,
                'machines' => $machines,
                'machinessl' => $machinessl,
                'listedispos' => $listedispos,
                'entreprise' => $client->getRaisonSociale(),
                'id' => $ficheid,
                'erreur' => $erreur,
                'locid' => $locid,
                'totalht' => $totalht,
                'montantcarb' => $montantcarb,
                'totalvente' => $totalvente,
                'nbjloc' => $nbjloc,
                'grille' => $grille,
                'user' => $objUser));
        }
        elseif($mode == 'be')
        {
            $html = $this->renderView('BaclooCrmBundle:Crm:bdl.html.twig', array('form' => $form->createView(),
                'mode' => $mode,
                'date' => $today,
                'roleuser' => $roleuser,
                'client' => $client,
                'locata' => $locata,
                'contrat' => $contrat,
                'bdcrecu' => $bdcrecu,
                'usersociete' => $societe,
                'modules' => $modules,
                'machines' => $machines,
                'machinessl' => $machinessl,
                'listedispos' => $listedispos,
                'entreprise' => $client->getRaisonSociale(),
                'id' => $ficheid,
                'erreur' => $erreur,
                'locid' => $locid,
                'totalht' => $totalht,
                'montantcarb' => $montantcarb,
                'totalvente' => $totalvente,
                'nbjloc' => $nbjloc,
                'grille' => $grille,
                'user' => $objUser));
        }
        else
        {
            $html = $this->renderView('BaclooCrmBundle:Crm:nouvelle_locationpdf.html.twig', array('form' => $form->createView(),
                'mode' => $mode,
                'date' => $today,
                'roleuser' => $roleuser,
                'client' => $client,
                'locata' => $locata,
                'contrat' => $contrat,
                'bdcrecu' => $bdcrecu,
                'usersociete' => $societe,
                'modules' => $modules,
                'machines' => $machines,
                'machinessl' => $machinessl,
                'listedispos' => $listedispos,
                'entreprise' => $client->getRaisonSociale(),
                'id' => $ficheid,
                'erreur' => $erreur,
                'locid' => $locid,
                'totalht' => $totalht,
                'montantcarb' => $montantcarb,
                'totalvente' => $totalvente,
                'nbjloc' => $nbjloc,
                'grille' => $grille,
                'nacelle' => $nacelle,
                'user' => $objUser));
        }
        $pdf->SetFont('helvetica', '', 9, '', true);
        // set margins
        $pdf->SetMargins(13, '10', '5', '0');
        // SetMargins($left,$top,$right = -1,$keepmargins = false)
        $pdf->AddPage();

        // -- set new background ---

        // get the current page break margin
        $bMargin = $pdf->getBreakMargin();
        // get current auto-page-break mode
        $auto_page_break = $pdf->getAutoPageBreak();
        // disable auto-page-break
        $pdf->SetAutoPageBreak(false, 0);
        // set bacground image
        $img_file = K_PATH_IMAGES.'devistemplate.jpg';
        $pdf->Image($img_file, 0, 0, 210, 297, 'JPG', '', '', false, 300, '', false, false, 0);
        // restore auto-page-break status
        $pdf->SetAutoPageBreak($auto_page_break, $bMargin);
        // set the starting point for the page content
        $pdf->setPageMark();

        $pdf->writeHTML($html, true, false, true, false, '');

        $pdf->lastPage();

        $response = new Response($pdf->Output('file.pdf'));
        $response->headers->set('Content-Type', 'application/pdf');

        return $response;
    }

    public function comptaAction($vue, $mode, $page, $message, $date, $nbresult, $style, $client, Request $request)
    {
        $user = $this->get('security.context')->getToken()->getUsername();
        $objUser = $user;
        if(empty($objUser) or !isset($objUser) or $objUser == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}

        if($this->getRequest()->request->get('pagination') > 0)
        {
            $page = $this->getRequest()->request->get('pagination');
            // echo 'la page2'.$page;
        }
// $date = '2019-08-14';
// echo $date;
// echo date('Y-m-t', strtotime($date));
        $em = $this->getDoctrine()->getManager();
        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($objUser);
        $nbparpage = 30;
        $today = date('Y-m-d');
        // $session = new Session();
        // $session = $request->getSession();
        // $session->set('page', $page);
        // $page = $session->get('page');
// $date = strtotime(date('Y-m-01'));
// $d15 = strtotime('+14 days',$date);
// echo date('Y-m-d', $d15);*
// $mois15 = strtotime(date('Y-m-01', strtotime(" -1 month")));
// $m15 = strtotime('+14 days',$mois15);
// echo date('Y-m-d', $m15);

        //création du formlaire de recherche de factures
        $defaultData = array();
        $form2 = $this->createFormBuilder($defaultData)
            ->add('du', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => false,
                'attr' => array('class' => 'date'),
            ))
            ->add('au', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => false,
                'attr' => array('class' => 'date'),
            ))
            ->add('datereprise', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => false,
                'attr' => array('class' => 'date'),
            ))
            ->add('numfacture', 'text', array('required' => false))
            // ->add('clientid', 'text', array('required' => false))
            // ->add('typedoc', 'choice', array(
            // 'choices'   => array(
            // 'facture'   => 'Facture',
            // ),
            // 'multiple'  => false,
            // ))
            ->add('client', 'text', array('required' => false))
            ->add('totalttc', 'number', array('required' => false))
            ->add('ttcgroupe', 'number', array('required' => false))
            ->add('daterech', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => false,
                'read_only' => false,
                'attr' => array('class' => 'daterech'),
            ))
            ->add('dejareg', 'number', array('required' => false))
			->add('numbdcloueur', 'integer', array('required' => false))
			->add('loueur', 'text', array('required' => false))
			->add('codecontrat', 'text', array('required' => false))
            ->add('modepaiement', 'choice', array(
                'choices'   => array(
                    'vide'   => '',
                    'virement'   => 'Virement',
                    'prélèvement'   => 'Prélèvement',
                    'cheque' => 'Chèque',
                    'lcr' => 'LCR',
                    'cb' => 'CB',
                    'vad' => 'VAD',
                    'traite' => 'Traite',
                    'Trop perçu' => 'Trop perçu',
                    'espece' => 'Espèce',
                    'bao' => 'BAO',
                ),
                'multiple'  => false,
            ))
            // ->add('reglement', 'choice', array(
            // 'choices'   => array(
            // 0   => '',
            // 1   => 'Comptant',
            // 2   => '45 jours fdm',
            // ),
            // 'data' => 2,
            // 'multiple'  => false,
            // ))
            ->getForm();
        if($request->getMethod() == 'POST')
        {//echo 'post'; echo $this->getRequest()->request->get('envoyer');
            if ($this->getRequest()->request->get('recherche') == 'Rechercher')
            {//echo 'recherche';
                $form2->handleRequest($request);
                // if($form2->isValid()){echo 'ttttttt';
                $data = $form2->getData();
                $du = $data['du'];
                $au = $data['au'];
                $daterech = $data['daterech'];
                $dejareg = $data['dejareg'];
                // $clientid = $data['clientid'];
                $client = $data['client'];//echo 'CLIENT'.$client;
                $numfacture = $data['numfacture'];//echo 'CLIENT'.$client;
				$codecontrat = $data['codecontrat'];
				$numbdcloueur = $data['numbdcloueur'];
				$loueur = $data['loueur'];
				$datereprise = $data['datereprise'];
                $totalttc1 = $data['totalttc'];//echo 'CLIENT'.$client;
                $ttcgroupe1 = $data['ttcgroupe'];//echo 'CLIENT'.$client;
                $modepaiement = $data['modepaiement'];//echo 'CLIENT'.$client;
                // $reglement = $data['reglement'];
                // $typedoc = $data['typedoc'];
                // $datecrea = $data['datecrea'];
                $session = new Session();
                $session = $request->getSession();

                // définit et récupère des attributs de session
                $session->set('du', $du);
                $session->set('au', $au);
                $session->set('client', $client);
                $session->set('numfacture', $numfacture);
                $session->set('totalttc', $totalttc1);
                $session->set('ttcgroupe', $ttcgroupe1);
                $session->set('modepaiement', $modepaiement);
                $session->set('daterech', $daterech);
                $session->set('dejareg', $dejareg);			
				$session->set('codecontrat', $codecontrat);
				$session->set('numbdcloueur', $numbdcloueur);
                $session->set('loueur', $loueur);
                $session->set('datereprise', $datereprise);
                // }
            }
            elseif ($this->getRequest()->request->get('maj') == 'Enregistrer')
            {//echo 'maj';

            }
        }
        $session = $request->getSession();
        if(null !== $session->get('du'))
        {
            $du = $session->get('du');
        }
        if(null !== $session->get('au'))
        {
            $au = $session->get('au');
        }
        if(null !== $session->get('client'))
        {
            $client = $session->get('client');
        }
        if(null !== $session->get('numfacture'))
        {
            $numfacture = $session->get('numfacture');
        }
        if(null !== $session->get('totalttc'))
        {
            $totalttc = $session->get('totalttc');
        }
        if(null !== $session->get('ttcgroupe'))
        {
            $ttcgroupe = $session->get('ttcgroupe');
        }
        if(null !== $session->get('modepaiement'))
        {
            $modepaiement = $session->get('modepaiement');
        }
        if(null !== $session->get('dejareg'))
        {
            $dejareg = $session->get('dejareg');
        }
        if(null !== $session->get('codecontrat'))
        {
            $codecontrat = $session->get('codecontrat');
        }
        if(null !== $session->get('numbdcloueur'))
        {
            $numbdcloueur = $session->get('numbdcloueur');
        }
        if(null !== $session->get('datereprise'))
        {
            $datereprise = $session->get('datereprise');
        }
        if(null !== $session->get('loueur'))
        {
            $loueur = $session->get('loueur');
        }
        if(null !== $session->get('daterech'))
        {
            $daterech = $session->get('daterech');
        }
        // echo 'la sessin daterech'.$session->get('daterech');

        if(!isset($du))
        {
            $du = 0;
        }
        if(!isset($au))
        {
            $au = 0;
        }
        if(!isset($clientid))
        {
            $clientid = 0;
        }
        if(!isset($client))
        {
            $client = 0;
        }
        if(!isset($reglement))
        {
            $reglement = 0;
        }
        elseif($reglement == 666)
        {
            $reglement = 0;
        }
        if(!isset($typedoc))
        {
            $typedoc = 0;
        }
        if(!isset($numfacture))
        {
            $numfacture = 0;
        }
        if(!isset($datecrea))
        {
            $datecrea = 0;
        }
        if(!isset($totalttc))
        {
            $totalttc = 0;
        }
        if(!isset($ttcgroupe))
        {
            $ttcgroupe = 0;
        }
        if(!isset($modepaiement))
        {
            $modepaiement = 0;
        }
        if(!isset($daterech))
        {
            // echo 'datrech00000'.$daterech;
            $daterech = 0;
        }
        if(!isset($codecontrat))
        {
            $codecontrat = 0;
        }
        if(!isset($numbdcloueur))
        {
            $numbdcloueur = 0;
        }
        if(!isset($datereprise))
        {
            $datereprise = 0;
        }
        if(!isset($loueur))
        {
            $loueur = 0;
        }
        else
        {
            // echo 'datechoookkkkXXXXXXX'.$daterech;
        }
        if(!isset($dejareg))
        {
            $dejareg = 0;
        }
        // echo 'aaaaaaaaaaaa'.$dejareg;

// echo 'MOOOODE'.$mode;echo 'CLIENNNN'.$client;echo 'NUmfacture'.$numfacture;echo 'modepaiement'.$modepaiement;echo 'TOTALTTC'.$totalttc;
        $em = $this->getDoctrine()
            ->getManager()
            ->getRepository('BaclooCrmBundle:Factures');
//        $facture = $em->listefactures($vue, $mode, $numfacture, $client, $totalttc, $ttcgroupe, $modepaiement, $nbparpage, $page, $daterech, $dejareg, $codecontrat, $numbdcloueur, $loueur, $datereprise);
        $em = $this->getDoctrine()->getManager();
        if($style === 'encompta')
        {
            $facture = $em->getRepository('BaclooCrmBundle:Factures')
                ->listefacturesencompta($vue, $mode, $numfacture, $client, $totalttc, $ttcgroupe, $modepaiement, $nbparpage, $page, $daterech, $dejareg, $codecontrat, $numbdcloueur, $loueur, $datereprise);
            //foreach($facture as $fact){echo $fact->getNumfacture();}
        }
        else
        {
            $facture = $em->getRepository('BaclooCrmBundle:Factures')
                ->listefactures($vue, $mode, $numfacture, $client, $totalttc, $ttcgroupe, $modepaiement, $nbparpage, $page, $daterech, $dejareg, $codecontrat, $numbdcloueur, $loueur, $datereprise);
//            foreach($facture as $fact){echo '<br>'.$fact->getCodecomptableclient();}
        }

        $query = $em->createQuery(
            'SELECT u.codegroupe
			FROM BaclooCrmBundle:Factures u
			WHERE u.codegroupe >= :codegroupe
			ORDER BY u.codegroupe DESC'
        )->setParameter('codegroupe', 0)
            ->setMaxResults(1);
        $codeg = $query->getResult();
        if(isset($codeg) && !empty($codeg))
        {
            $codeg = $query->getSingleScalarResult();
        }
        else
        {
            $codeg = 0;
        }
        // echo 'nextcode'.$codeg;
        $nextcodegroupe = $codeg + 1;
        // echo 'nextcodegroupe'.$nextcodegroupe;

        $moisprecedent = date('m', strtotime(" -1 month"));
        $findumois = date('Y-m-t');
        // echo '-5'.date('Y-m-d', strtotime($findumois. '-5 days'));
        if(strtotime(date('Y-m-d')) >= strtotime(date('Y-m-d', strtotime($findumois. '-5 days'))) && strtotime(date('Y-m-d')) <= strtotime(date('Y-m-t')))
        {
            $show = 1;
        }
        else
        {
            $show = 0;
        }

        // $em->clear();

        $moisprecedent = date('m', strtotime(" -1 month"));

        // echo 'bb'.$reglement.'bb';
        // echo $mode;
        $em = $this->getDoctrine()->getManager();
        $ttesfacturesimpayees  = $em->getRepository('BaclooCrmBundle:Factures')
            ->ttesfacturesimpayees();

        $ttesfacturesimpayeesnonechues  = $em->getRepository('BaclooCrmBundle:Factures')
            ->ttesfacturesimpayeesnonechues();

        $ttesfacturesechues  = $em->getRepository('BaclooCrmBundle:Factures')
            ->ttesfacturesechues();

        if($vue == 'achats')
        {
            $ttesfacturesimpayees  = $em->getRepository('BaclooCrmBundle:Factures')
                ->ttesfacturesimpayeesfrs();//echo $ttesfacturesimpayees;

            $ttesfacturesimpayeesnonechues  = $em->getRepository('BaclooCrmBundle:Factures')
                ->ttesfacturesimpayeesnonechuesfrs();

            $ttesfacturesechues  = $em->getRepository('BaclooCrmBundle:Factures')
                ->ttesfacturesechuesfrs();
        }

        if($vue == 'achats')
        {
            return $this->render('BaclooCrmBundle:Crm:comptaachats.html.twig', array('factures' => $facture,
                'form2' => $form2->createView(),
                'user' => $user,
                'userdetails' => $userdetails,
                'mode' => $mode,
                'vue' => $vue,
                'message' => $message,
                'date' => $date,
                'du' => $du,
                'au' => $au,
                'show' => $show,
                // 'clientid' => $clientid,
                'client' => $client,
                // 'reglement' => $reglement,
                'typedoc' => $typedoc,
                'numfacture' => $numfacture,
                'totalttc' => $totalttc,
                'ttcgroupe' => $ttcgroupe,
                'modepaiement' => $modepaiement,
                'datecrea' => $datecrea,
                'moisprecedent' => $moisprecedent,
                'ttesfacturesimpayees' => $ttesfacturesimpayees,
                'ttesfacturesimpayeesnonechues' => $ttesfacturesimpayeesnonechues,
                'ttesfacturesechues' => $ttesfacturesechues,
                'nextcodegroupe' => $nextcodegroupe,
                'dejareg' => $dejareg,
                'daterech' => $daterech,
                'style' => $style,
                'nombrePage' => ceil(count($facture)/$nbparpage),
                'page'	  	  => $page
            ));
        }
        else
        {
            return $this->render('BaclooCrmBundle:Crm:compta.html.twig', array('factures' => $facture,
                'form2' => $form2->createView(),
                'user' => $user,
                'userdetails' => $userdetails,
                'mode' => $mode,
                'vue' => $vue,
                'message' => $message,
                'date' => $date,
                'du' => $du,
                'au' => $au,
                'show' => $show,
                // 'clientid' => $clientid,
                'client' => $client,
                // 'reglement' => $reglement,
                'typedoc' => $typedoc,
                'numfacture' => $numfacture,
                'totalttc' => $totalttc,
                'ttcgroupe' => $ttcgroupe,
                'modepaiement' => $modepaiement,
                'datecrea' => $datecrea,
                'moisprecedent' => $moisprecedent,
                'ttesfacturesimpayees' => $ttesfacturesimpayees,
                'ttesfacturesimpayeesnonechues' => $ttesfacturesimpayeesnonechues,
                'ttesfacturesechues' => $ttesfacturesechues,
                'nextcodegroupe' => $nextcodegroupe,
                'dejareg' => $dejareg,
				'codecontrat' => $codecontrat,
                'daterech' => $daterech,
                'style' => $style,
                'nombrePage' => ceil(count($facture)/$nbparpage),
                'page'	  	  => $page
            ));
        }
    }

    public function comptadefAction($numfacture, $mode, $page, $doc, $bdcid, Request $request)
    {
        $em = $this->getDoctrine()->getManager();//echo 'regle';exit();
        $facture = $em->getRepository('BaclooCrmBundle:Factures')
            ->findOneById($numfacture);
        if($facture->getNumfacture() == 'En attente')
        {
            $mois = date('m',strtotime($facture->getDatecrea()));
            $annee = date('y',strtotime($facture->getDatecrea()));
            //Faut d'abord voir s'il existe des factures pour le mois en question
             $facture->setMontantdejareg(0);
            $query = $em->createQuery(
                'SELECT b
								FROM BaclooCrmBundle:Factures b
								WHERE b.typedoc != :typedoc
                                and b.compteurfac > :compteurfac
                                and b.compteurfac != :compteurfac2
								ORDER BY b.compteurfac DESC'
            )->setMaxResults(1);
            $query->setParameter('typedoc', 'bon de commande');
            $query->setParameter('compteurfac', 0);
            $query->setParameter('compteurfac2', 99999);
            // $lastnumfact = $query->getResult();
            // if(empty($lastnumfact)){$lastnum = 0;}
            // else{foreach($lastnumfact as $last){$lastnum = $last['id'];}}
            $lastnumfacture = $query->getOneOrNullResult();
            if(!empty($lastnumfacture) or isset($lastnumfacture) or $lastnumfacture != null)
            {echo 'lax';
                $lastnumfacture = $query->getSingleResult();//echo 'pas vide';echo $lastnumfacture->getId();exit();
//                $mois = $lastnumfacture->getMois();
                $lastnumfact = $lastnumfacture->getCompteurfac();
            }
            else
            {
                exit('Mauvais numéro de facture');
            }
            $lastnumfact = $lastnumfact+1;//echo 'lllll'.$lastnumfact;exit();
            $numfact = str_pad($lastnumfact, 3, "0", STR_PAD_LEFT);
            if($doc == 'locations')
            {
                $numfacture = $annee.$mois.$numfact;
            }
            else
            {
                $numfacture = $annee.$mois.'V'.$numfact;
            }

            $facture->setNumfacture($numfacture);
            $facture->setCompteurfac($lastnumfact);
//            $facture->setDatecrea($date('Y-m-d'));
            $em->persist($facture);
            $em->flush();
        }
        $codecontrat = $facture->getLocatacloneid();
        $clientid = $facture->getClientid();
        echo ' CODeCONtrAtX';echo $facture->getCodelocata();echo $facture->getLocatacloneid();
        $locata = $em->getRepository('BaclooCrmBundle:Locataclone')
            ->findOneById($codecontrat);

        $venda = $em->getRepository('BaclooCrmBundle:Venda')
            ->findOneById($codecontrat);

        $typeachat = 'nok';
        if($facture->getCodelocata() == 'H-'.$facture->getLocatacloneid())
        {echo 'normal';
            $locatafrs = $em->getRepository('BaclooCrmBundle:Locatafrs')
                ->findOneById($codecontrat);
            $typeachat = 'normal';
        }
        else
        {echo 'sous loc';
            $locatafrs = $em->getRepository('BaclooCrmBundle:Locatafrsclone')
                ->findOneById($codecontrat);
            $typeachat = 'sous loc';
        }
        // echo 'codecontrat'.$codecontrat;

        $machines = $em->getRepository('BaclooCrmBundle:Machines')
            ->findAll();

        $machinessl = $em->getRepository('BaclooCrmBundle:Machinessl')
            ->findAll();

        // $facture  = $em->getRepository('BaclooCrmBundle:Factures')
        // ->findOneByNumfacture($numfacture);

        $clients  = $em->getRepository('BaclooCrmBundle:Fiche')
            ->findOneById($clientid);
//echo 'ttttt';echo $this->getRequest()->request->get('definitif');
        $client = $clients;
        include('facturationmensuelledefinitive.php');
        $facture->setSelection(0);
        $em->flush();

        if($doc == 'locations' or $doc == 'ventes')
        {
            return $this->redirect($this->generateUrl('bacloocrm_compta', array('vue' => 'locations', 'page' => $page, 'mode' => $mode)));
        }
        elseif($doc == 'achats')
        {
            return $this->redirect($this->generateUrl('bacloocrm_compta', array('vue' => 'achats', 'page' => $page, 'mode' => $mode)));
        }
        elseif($doc == 'achatspeed')
        {
            return $this->redirect($this->generateUrl('bacloocrm_ajouterlocationfrsspeed', array('bdcid' => $bdcid, 'message' => $facture->getId())));
        }
        else
        {
            return $this->redirect($this->generateUrl('bacloocrm_compta', array('vue' => 'locations', 'page' => $page, 'mode' => $mode)));
        }
    }

    public function facturestableauAction($factureid, $facture, $page, $mode, $numfacture, $modepaiement, $totalttc, $client, $vue, $style, Request $request)
    {//echo 'ttc1x'.$totalttc;
        $objUser = $this->get('security.context')->getToken()->getUsername();
        $today = date('Y-m-d');
        $em = $this->getDoctrine()->getManager();
        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($objUser);

        //création du formlaire dans la liste des articles
        $defaultData2 = array();

        $form = $this->createFormBuilder($defaultData2)
            ->add('numfacture', 'text', array('required' => false))
            ->add('numfacfrs', 'text', array('required' => false))
            ->add('echeance', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => false,
                'read_only' => false,
                'attr' => array('class' => 'echeance'),
            ))
            ->add('datecrea', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => false,
                'read_only' => false,
                'attr' => array('class' => 'datecrea'),
            ))
//		->add('reglement', 'checkbox', array('required' => false))
            ->add('montantreg', 'number', array('required' => false))
            ->add('datepaiement', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => false,
                'read_only' => false,
                'attr' => array('class' => 'datepaiement'),
            ))
            ->add('modepaiement', 'choice', array(
                'choices'   => array(
                    'vide'   => '',
                    'virement'   => 'Virement',
                    'prélèvement'   => 'Prélèvement',
                    'cheque' => 'Chèque',
                    'lcr' => 'LCR',
                    'cb' => 'CB',
                    'vad' => 'VAD',
                    'traite' => 'Traite',
                    'espece' => 'Espèce',
                    'Liquidation' => 'Liquidation',
                ),
                'multiple'  => false,
            ))
            ->add('commentaire','textarea', array('required' => false))
            ->add('commentairefrs','textarea', array('required' => false))
            ->add('montantdejareg', 'number', array('required' => false))
            ->add('encaisse', 'choice', array(
                'choices'   => array(
                    'pas encaisse'   => 'Pas encaissé',
                    'encaisse'   => 'Encaissé',
                ),
                'multiple'  => false,
            ))
            ->add('codegroupe', 'integer', array('required' => false))
            ->add('ttcgroupe', 'number', array('required' => false))
//            ->add('compteurfac', 'number', array('required' => false))
            ->add('mois', 'text', array('required' => false))
            ->add('annee', 'integer', array('required' => false,'max_length' => 4))
            ->add('totalht', 'number', array('required' => false))
            ->add('totalttc', 'number', array('required' => false))
            ->add('montantavoir', 'number', array('required' => false))
            ->add('avoir', 'checkbox', array('required' => false))
            ->add('acompte', 'number', array('required' => false))
            ->getForm();

        $facture = $em->getRepository('BaclooCrmBundle:Factures')
            ->findOneById($factureid);

        if($request->getMethod() == 'POST')
        {
            if($this->getRequest()->request->get('save') == 'Enregistrer')
            {
                $form->handleRequest($request);
                $data = $form->getData();
                $datecrea = $data['datecrea'];
                $echeance = $data['echeance'];
                $numfacture = $data['numfacture'];
                $numfacfrs = $data['numfacfrs'];
                //			$reglement = $data['reglement'];
                $montantreg = $data['montantreg'];
                $datepaiement = $data['datepaiement'];
                $modepaiement = $data['modepaiement'];
                $montantdejareg = $data['montantdejareg'];
                $commentaire = $data['commentaire'];
                $commentairefrs = $data['commentairefrs'];
                $encaisse = $data['encaisse'];
                $totalht = $data['totalht'];
                $totalttc = $data['totalttc'];
                $montantavoir = $data['montantavoir'];
                $avoir = $data['avoir'];
                $acompte = $data['acompte'];
//                $compteurfac = $data['compteurfac'];
                $mois = $data['mois'];
                $annee = $data['annee'];
                if($facture->getCodegroupe() > 0 && !empty($codegroupe))
                {
                    $codegroupe = $facture->getCodegroupe();
                }
                else
                {
                    $codegroupe = $data['codegroupe'];
                }
                // if($form->isValid()){echo '+++++';
                //echo 'NUMFACT';echo $numfacture;

                $client = $em->getRepository('BaclooCrmBundle:Fiche')
                    ->findOneById($facture->getClientid());
                //Passer directement l'écriture de réglement ici afin de solder le compte client
                //et créditer le compte banque
                if($montantdejareg == $facture->getTotalttc() + $facture->getMontantavoir() + $facture->getAcompte()){$reglement = 1;}else{$reglement = 0;}
                // $facture->setReglement($reglement);
                $facture->setMontantreg(0);
                $facture->setNumfacfrs($numfacfrs);
                $facture->setDatecrea($datecrea);
                $facture->setEcheance($echeance);
                $facture->setDatepaiement($datepaiement);
                $facture->setModepaiement($modepaiement);
                $facture->setCommentaire($commentaire);
                $facture->setCommentairefrs($commentairefrs);
                $facture->setEncaisse($encaisse);
                $facture->setMontantdejareg($montantdejareg+$montantreg);
                $facture->setCodegroupe($codegroupe);
                $facture->setTtcgroupe($montantdejareg+$montantreg);
                if($vue == 'achats') {
                    $facture->setTotalht($totalht);
                    $facture->setTotalttc($totalttc);
                }
                $facture->setMontantavoir($montantavoir);
                $facture->setAvoir($avoir);
                $facture->setAcompte($acompte);
                if($acompte >= 0 and $facture->getCodelocata() != 'V-'.$facture->getLocatacloneid())
                {
                    $locataclone = $em->getRepository('BaclooCrmBundle:Locataclone')
                        ->findOneById($facture->getLocatacloneid());
                    $locataclone->setAcompte($acompte);
                    $em->persist($locataclone);
                }
                $facture->setMois(date('m', strtotime($datecrea)));
                $mois = date('m', strtotime($datecrea));
                $facture->setAnnee(date('y', strtotime($datecrea)));
//                $numfact = str_pad($compteurfac, 3, "0", STR_PAD_LEFT);//echo 'numfact******';echo $numfact;
//                if($facture->getTypedoc() == 'avoir')
//                {
//                    $numfacture = $annee.$mois.$numfact;
//                }
//                else
//                {
//                    $numfacture = $annee.$mois.$numfact;
//                }
//                $facture->setCompteurfac($compteurfac);
//                if($facture->getNumfacture() != 'En attente')
//                {
//                    $facture->setMois($mois);
//                    $facture->setAnnee($annee);
//                    $facture->setNumfacture($numfacture);
//                }
                $em->persist($facture);
                $em->flush();

                if($facture->getCodegroupe() > 0 && $vue == 'achats')
                {
                    $facturesgroupe = $em->getRepository('BaclooCrmBundle:Factures')
                        ->findByCodegroupe($facture->getCodegroupe());

                    foreach ($facturesgroupe as $groupir)
                    {
                        $groupir->setNumfacfrs($numfacfrs);
                        $groupir->setDatepaiement($datepaiement);
                        $groupir->setModepaiement($modepaiement);
                        $groupir->setCommentaire($commentaire);
                        $groupir->setCommentairefrs($commentairefrs);
                        $groupir->setEncaisse($encaisse);
                        $groupir->setMontantdejareg($groupir->getTotalttc());
                        $groupir->setCodegroupe($codegroupe);
                        $em->persist($groupir);
                    }
                    $em->flush();
                }
                elseif($facture->getCodegroupe() > 0 && $vue != 'achats')
                {
                    $facturesgroupe = $em->getRepository('BaclooCrmBundle:Factures')
                        ->findByCodegroupe($facture->getCodegroupe());

                    foreach ($facturesgroupe as $facture)
                    {
                        $facture->setEncaisse($encaisse);
                        $em->persist($facture);
                        if($encaisse == 'encaisse')
                        {
                            //On enregistre un paiement par virement
                            //On crédite 512
                            $banque = new Afacturer;
                            $banque->setDate($today);
                            $banque->setJournal('ODR');
                            $banque->setCompte(512);
                            $banque->setDebit($facture->getTotalttc());
                            $banque->setCredit(0);
                            $banque->setLibelle($facture->getClient());
                            $banque->setPiece($numfacture);
                            $banque->setEcheance($facture->getEcheance());
                            $banque->setAnalytique('Reglement client');
                            $banque->setModepaiement($facture->getModepaiement());
                            $banque->setCodegroupe($facture->getCodegroupe());
                            $em->persist($banque);
                            $em->persist($facture);
                            $em->flush();

                            $compteclient = '411'.str_pad($facture->getClientid(), 3, "0", STR_PAD_LEFT);;
                            //On débit le bon 411
                            $clientok = new Afacturer;
                            $clientok->setDate($today);
                            $clientok->setJournal('ODR');
                            $clientok->setCompte(511);
                            $clientok->setDebit(0);
                            $clientok->setCredit($facture->getTotalttc());
                            $clientok->setLibelle($facture->getClient());
                            $clientok->setPiece($numfacture);
                            $clientok->setEcheance($facture->getEcheance());
                            $clientok->setAnalytique('Reglement client');
                            $clientok->setModepaiement($facture->getModepaiement());
                            $clientok->setCodegroupe($facture->getCodegroupe());
                            $em->persist($clientok);

//                        $facture->setMontantreg(0);
                            $em->persist($facture);
                            $em->flush();
                        }
                    }
                    $em->flush();

                }

                $facturesgroupe = $em->getRepository('BaclooCrmBundle:Factures')
                    ->findByCodegroupe($codegroupe);

                $ttcgroupe = 0;
                foreach($facturesgroupe as $factagroupe)
                {
                    //un premier tour pour remplir ttcgroupe
                    $ttcgroupe += $factagroupe->getMontantdejareg();
                }

                foreach($facturesgroupe as $factagroupe)
                {
                    //un deuxième tour pour remplir le ttcgroupe de chaque membre
                    $factagroupe->setTtcgroupe($ttcgroupe);
                    $em->persist($factagroupe);
                }
                $em->flush();
                //echo '1';echo $fac->getNumfacture();
                //Avant de passer l'écriture on vérifie qua ça n'a pas déjà été fait

                // $facture->setMontantdejareg($totalreg + $facture->getMontantreg());echo 'totalreg'.$totalreg;

                if($facture->getMontantdejareg() > 0 and round(($facture->getMontantdejareg() + $facture->getMontantavoir() + $facture->getAcompte()),2) == $facture->getTotalttc()) {
                    echo '22222';
                    if (($facture->getModepaiement() == 'cheque' or $facture->getModepaiement() == 'lcr') and $facture->getEncaisse() == 'pas encaisse')
                    {echo '3333';
                        if ($facture->getCodegroupe() > 0) {
                            $factures = $em->getRepository('BaclooCrmBundle:Factures')
                                ->findByCodegroupe($facture->getCodegroupe());
                            foreach ($factures as $facturex) {
                                $facturex->setReglement(0);
                                //On enregistre un paiement par virement
                                //On crédite 512
                                $banque = new Afacturer;
                                $banque->setDate($today);
                                $banque->setJournal('ODR');
                                $banque->setCompte(511);
                                $banque->setDebit($facturex->getTotalttc());
                                $banque->setCredit(0);
                                $banque->setLibelle($facturex->getClient());
                                $banque->setPiece($facturex->getNumfacture());
                                $banque->setEcheance($facturex->getEcheance());
                                $banque->setAnalytique('Reglement client');
                                $banque->setModepaiement($facturex->getModepaiement());
                                $banque->setCodegroupe($facturex->getCodegroupe());
                                $em->persist($banque);
                                $em->persist($facturex);
                            }
                            $em->flush();
                        }
                        else
                        {echo '4444';
                            $facture->setReglement(0);
                            //On enregistre un paiement par virement
                            //On crédite 512
                            $banque = new Afacturer;
                            $banque->setDate($today);
                            $banque->setJournal('ODR');
                            $banque->setCompte(511);
                            $banque->setDebit($facture->getTotalttc());
                            $banque->setCredit(0);
                            $banque->setLibelle($facture->getClient());
                            $banque->setPiece($numfacture);
                            $banque->setEcheance($facture->getEcheance());
                            $banque->setAnalytique('Reglement client');
                            $banque->setModepaiement($facture->getModepaiement());
                            $banque->setCodegroupe($facture->getCodegroupe());
                            $em->persist($banque);
                        }

                        $compteclient = '411'.str_pad($facture->getClientid(), 3, "0", STR_PAD_LEFT);;
                        //On débit le bon 411
                        $clientok = new Afacturer;
                        $clientok->setDate($today);
                        $clientok->setJournal('VT');
                        $clientok->setCompte($compteclient);
                        $clientok->setDebit(0);
                        $clientok->setCredit($facture->getTotalttc());
                        $clientok->setLibelle($facture->getClient());
                        $clientok->setPiece($numfacture);
                        $clientok->setEcheance($facture->getEcheance());
                        $clientok->setAnalytique('Reglement client');
                        $clientok->setModepaiement($facture->getModepaiement());
                        $em->persist($clientok);

                        $facture->setMontantreg(0);
                        $em->persist($facture);
                        $em->flush();
                    }
                    elseif (($facture->getModepaiement() == 'cheque' or $facture->getModepaiement() == 'lcr') and $facture->getEncaisse() == 'encaisse')
                    {
                        if ($facture->getCodegroupe() > 0) {
                            $factures = $em->getRepository('BaclooCrmBundle:Factures')
                                ->findByCodegroupe($facture->getCodegroupe());
                            foreach ($factures as $facturex) {
                                $facturex->setReglement(1);
                                $facturex->setEncaisse('encaisse');
                            }
                            //On enregistre un paiement par virement
                            //On crédite 512

                            //Avant de saisir les écritures on vérifie qu'elle n'aient pas déjà été saisies
                            $journalori = $em->getRepository('BaclooCrmBundle:Afacturer')
                                ->findOneBy(array('compte'=>512, 'debit'=>$ttcgroupe, 'codegroupe'=>$facture->getCodegroupe()));
                            if(!isset($journalori))
                            {
                                $banque = new Afacturer;
                                $banque->setDate($today);
                                $banque->setJournal('ODR');
                                $banque->setCompte(512);
                                $banque->setDebit($ttcgroupe);
                                $banque->setCredit(0);
                                $banque->setLibelle($facture->getClient());
                                $banque->setPiece('Reglements multiples');
                                $banque->setEcheance($facture->getEcheance());
                                $banque->setAnalytique('Reglement client');
                                $banque->setModepaiement($facture->getModepaiement());
                                $banque->setCodegroupe($facture->getCodegroupe());
                                $em->persist($banque);
                                $em->persist($facturex);
                                $em->flush();

                                $compteclient = '411'.str_pad($facture->getClientid(), 3, "0", STR_PAD_LEFT);;
                                //On débit le bon 411
                                $clientok = new Afacturer;
                                $clientok->setDate($today);
                                $clientok->setJournal('ODR');
                                $clientok->setCompte(511);
                                $clientok->setDebit(0);
                                $clientok->setCredit($ttcgroupe);
                                $clientok->setLibelle($facture->getClient());
                                $clientok->setPiece($numfacture);
                                $clientok->setEcheance($facture->getEcheance());
                                $clientok->setAnalytique('Reglement client');
                                $clientok->setModepaiement($facture->getModepaiement());
                                $clientok->setCodegroupe($facture->getCodegroupe());
                                $em->persist($clientok);
                            }

//                        $facture->setMontantreg(0);
                            $em->persist($facture);
                            $em->flush();
                        }
                        elseif ($facture->getTypedoc() == 'facture frs')
                        {//echo '4';
                            //						$facture->setMontantdejareg($montantdejareg + $facture->getMontantreg());
                            //On enregistre le paiement du fournisseur par virement
                            //On debite 512
//                        $banque = new Afacturer;
//                        $banque->setDate($today);
//                        $banque->setJournal('ACH');
//                        $banque->setCompte(512);
//                        $banque->setDebit(0);
//                        $banque->setCredit($montantreg);
//                        $banque->setLibelle($facture->getClient());
//                        $banque->setPiece($facture->getNumfacfrs());
//                        $banque->setEcheance($facture->getEcheance());
//                        $banque->setAnalytique('Reglement fournisseur');
//                        $em->persist($banque);
//                        $em->flush();
//
//                        $compteclient = '401'.$facture->getClientid();
//                        //On crédite le bon 401
//                        $clientok = new Afacturer;
//                        $clientok->setDate($today);
//                        $clientok->setJournal('ACH');
//                        $clientok->setCompte($compteclient);
//                        $clientok->setDebit($montantreg);
//                        $clientok->setCredit(0);
//                        $clientok->setLibelle($facture->getClient());
//                        $clientok->setPiece($facture->getNumfacfrs());
//                        $clientok->setEcheance($facture->getEcheance());
//                        $clientok->setAnalytique('Reglement fournisseur');
//                        $em->persist($clientok);

                            $facture->setMontantreg(0);
                            $em->flush();
                        }
                    }
                    elseif ($facture->getModepaiement() != 'cheque' or $facture->getModepaiement() != 'lcr')
                    {
                        $facture->setReglement(1);
                        if($facture->getModepaiement() == 'Liquidation')
                        {
                            $journalori = $em->getRepository('BaclooCrmBundle:Afacturer')
                                ->findOneBy(array('credit'=>$totalttc, 'piece'=>$facture->getNumfacture()));
                            if(!isset($journalori))
                            {
                                //On enregistre un paiement par virement
                                //On débite 654
                                $banque = new Afacturer;
                                $banque->setDate($today);
                                $banque->setJournal('VT');
                                $banque->setCompte(654);
                                $banque->setDebit($facture->getTotalht());
                                $banque->setCredit(0);
                                $banque->setLibelle($facture->getClient());
                                $banque->setPiece($numfacture);
                                $banque->setEcheance($facture->getEcheance());
                                $banque->setAnalytique('Irrecouvrable');
                                $banque->setModepaiement($facture->getModepaiement());
                                $banque->setCodegroupe($facture->getCodegroupe());
                                $em->persist($banque);
                                $em->flush();

                                //On débite 4457100
                                $tva = new Afacturer;
                                $tva->setDate($today);
                                $tva->setJournal('VT');
                                $tva->setCompte(4457100);
                                $tva->setDebit($facture->getTotalttc() - $facture->getTotalht());
                                $tva->setCredit(0);
                                $tva->setLibelle($facture->getClient());
                                $tva->setPiece($numfacture);
                                $tva->setEcheance($facture->getEcheance());
                                $tva->setAnalytique('Irrecouvrable');
                                $tva->setModepaiement($facture->getModepaiement());
                                $tva->setCodegroupe($facture->getCodegroupe());
                                $em->persist($tva);
                                $em->flush();

                                $compteclient = '411'.str_pad($facture->getClientid(), 3, "0", STR_PAD_LEFT);;
                                //On débit le bon 411
                                $clientok = new Afacturer;
                                $clientok->setDate($today);
                                $clientok->setJournal('VT');
                                $clientok->setCompte($compteclient);
                                $clientok->setDebit(0);
                                $clientok->setCredit($facture->getTotalttc());
                                $clientok->setLibelle($facture->getClient());
                                $clientok->setPiece($numfacture);
                                $clientok->setEcheance($facture->getEcheance());
                                $clientok->setAnalytique('Irrecouvrable');
                                $clientok->setModepaiement($facture->getModepaiement());
                                $clientok->setCodegroupe($facture->getCodegroupe());
                                $em->persist($clientok);

//                        $facture->setMontantreg(0);
                                $em->persist($facture);
                                $em->flush();
                            }
                        }
                        else
                        {
                            $journalori = $em->getRepository('BaclooCrmBundle:Afacturer')
                                ->findOneBy(array('compte'=>512, 'debit'=>$totalttc, 'piece'=>$facture->getNumfacture()));
                            if(!isset($journalori))
                            {
                                //On enregistre un paiement par virement
                                //On crédite 512
                                $banque = new Afacturer;
                                $banque->setDate($today);
                                $banque->setJournal('ODR');
                                $banque->setCompte(512);
                                $banque->setDebit($facture->getTotalttc());
                                $banque->setCredit(0);
                                $banque->setLibelle($facture->getClient());
                                $banque->setPiece($numfacture);
                                $banque->setEcheance($facture->getEcheance());
                                $banque->setAnalytique('Reglement client');
                                $banque->setModepaiement($facture->getModepaiement());
                                $banque->setCodegroupe($facture->getCodegroupe());
                                $em->persist($banque);
                                $em->flush();

                                $compteclient = '411'.str_pad($facture->getClientid(), 3, "0", STR_PAD_LEFT);;
                                //On débit le bon 411
                                $clientok = new Afacturer;
                                $clientok->setDate($today);
                                $clientok->setJournal('ODR');
                                $clientok->setCompte($compteclient);
                                $clientok->setDebit(0);
                                $clientok->setCredit($facture->getTotalttc());
                                $clientok->setLibelle($facture->getClient());
                                $clientok->setPiece($numfacture);
                                $clientok->setEcheance($facture->getEcheance());
                                $clientok->setAnalytique('Reglement client');
                                $clientok->setModepaiement($facture->getModepaiement());
                                $clientok->setCodegroupe($facture->getCodegroupe());
                                $em->persist($clientok);

//                        $facture->setMontantreg(0);
                                $em->persist($facture);
                                $em->flush();
                            }
                        }
                    }
                }
                else
                {
                    if($facture->getReglement() == 1){$reglement = 1;}else{$reglement = 0;}
                    $facture->setReglement($reglement);
                }

                if($facture->getTypedoc() == 'avoir'){$facture->setReglement(1);}
                $em->persist($facture);
                $em->flush();
                if($vue == 'achats')
                {
                    return $this->redirect($this->generateUrl('bacloocrm_compta', array('vue' => 'achats', 'page' => $page, 'mode' => $mode, 'style' => '0')));
                }
                else
                {
                    return $this->redirect($this->generateUrl('bacloocrm_compta', array('vue' => 'locations', 'page' => $page, 'mode' => $mode, 'style' => $style)));
                }
            }
            elseif($this->getRequest()->request->get('pay') == 'regler')
            {echo 'ttc2x'.$totalttc;
                $facture = $em->getRepository('BaclooCrmBundle:Factures')
                    ->findOneById($factureid);
                $form->handleRequest($request);
                $data = $form->getData();
                $datecrea = $data['datecrea'];
                $echeance = $data['echeance'];
                $numfacture = $data['numfacture'];
//                $reglement = $data['reglement'];
                $montantreg = $facture->getTotalttc()-$facture->getMontantdejareg()-$facture->getMontantavoir()-$facture->getAcompte();
                $datepaiement = $data['datepaiement'];
                $modepaiement = $data['modepaiement'];
                $montantdejareg = $data['montantdejareg'];
                $commentaire = $data['commentaire'];
                $encaisse = 'encaisse';
                $codegroupe = $data['codegroupe'];
                if(empty($datepaiement)){$datepaiement = date('Y-m-d');}
                // if($form->isValid()){echo '+++++';
//echo 'NUMFACT';echo $numfacture;

//			$afacturer = $em->getRepository('BaclooCrmBundle:Afacturer')
//							->findByReference($numfacture);
//			if(isset($afacturer))
//            {
//                foreach($afacturer as $afac)
//                {
//                    $afac->setCodegroupe($codegroupe);
//                    $em->persist($afac);
//                }
//            }
                $client = $em->getRepository('BaclooCrmBundle:Fiche')
                    ->findOneById($facture->getClientid());
                //mide à jour des date datemodif pour coller au ca factures
                if($mode == 'achats')
                {
                    $locataclone = $em->getRepository('BaclooCrmBundle:Locatafrsclone')
                        ->findOneById($facture->getLocatacloneid());
                    if(isset($locataclone))
                    {//echo 'ici';echo $datecrea;
                        $locataclone->setDatemodif($datecrea);
                        $em->persist($locataclone);
                    }else{echo 'mauvais';}
                }
                else
                {
                    $locataclone = $em->getRepository('BaclooCrmBundle:Locataclone')
                        ->findOneById($facture->getLocatacloneid());
                    if(isset($locataclone))
                    {//echo 'ici';echo $datecrea;
                        $locataclone->setDatemodif($datecrea);
                        $em->persist($locataclone);
                    }else{echo 'mauvais';}
                }
                //Passer directement l'écriture de réglement ici afin de solder le compte client
                //et créditer le compte banque
//                if($montantdejareg == $facture->getTotalttc() - $facture->getMontantavoir()){$reglement = 1;}else{$reglement = 0;}
                // $facture->setReglement($reglement);
                $facture->setMontantreg(0);
                $facture->setDatecrea($datecrea);
                $facture->setEcheance($echeance);
                $facture->setDatepaiement($datepaiement);
                $facture->setModepaiement($modepaiement);
                $facture->setCommentaire($commentaire);
                $facture->setEncaisse($encaisse);
                $facture->setMontantdejareg($montantdejareg+$montantreg);
                $facture->setCodegroupe($codegroupe);
                $facture->setTtcgroupe($montantdejareg+$montantreg);
                $em->persist($facture);
                $em->flush();
                $facturesgroupe = $em->getRepository('BaclooCrmBundle:Factures')
                    ->findByCodegroupe($codegroupe);

                $ttcgroupe = 0;
                foreach($facturesgroupe as $factagroupe)
                {
                    //un premier tour pour remplir ttcgroupe
                    $ttcgroupe += $factagroupe->getMontantdejareg();
                }

                foreach($facturesgroupe as $factagroupe)
                {
                    //un deuxième tour pour remplir le ttcgroupe de chaque membre
                    $factagroupe->setTtcgroupe($ttcgroupe);
                    $em->persist($factagroupe);
                }
                $em->flush();
                //echo '1';echo $fac->getNumfacture();
                //Avant de passer l'écriture on vérifie qua ça n'a pas déjà été fait

                // $facture->setMontantdejareg($totalreg + $facture->getMontantreg());echo 'totalreg'.$totalreg;
                echo 'rrrr'.round(($facture->getMontantdejareg() + $facture->getMontantavoir()),2);echo 'ttc'.$facture->getTotalttc();
                if($facture->getMontantdejareg() > 0 and round(($facture->getMontantdejareg() + $facture->getMontantavoir()),2) == $facture->getTotalttc())
                {echo '22222';
                    if(($facture->getModepaiement() == 'cheque' or $facture->getModepaiement() == 'lcr') and $facture->getEncaisse() == 'encaisse' )
                    {	echo 'cheque';
                        $facture->setReglement(1);
                    }
                    else
                    {echo 'pas cheque';
                        $facture->setReglement(1);
                    }
                    if($facture->getTypedoc() == 'facture' or $facture->getTypedoc() == 'facture frs')
                    {echo '3';
                        //On enregistre un paiement par virement
                        //On crédite 512
//						$banque = new Afacturer;
//						$banque->setDate($today);
//						$banque->setJournal('VEN');
//						$banque->setAuxiliaire(512);
//						$banque->setDebit($montantreg);
//						$banque->setCredit(0);
//						$banque->setLibelle('Reglement client');
//						$banque->setReference($numfacture);
////						$banque->setEcheance($facture->getEcheance());
//						$banque->setGeneral(512);
//						$em->persist($banque);
//						$em->flush();
//
//						$compteclient = $client->getNewid();
//						//On débit le bon 411
//						$clientok = new Afacturer;
//						$clientok->setDate($today);
//						$clientok->setJournal('VEN');
//						$clientok->setAuxiliaire($client->getId());
//						$clientok->setDebit(0);
//						$clientok->setCredit($montantreg);
//						$clientok->setLibelle('Reglement client');
//						$clientok->setReference($numfacture);
////						$clientok->setEcheance($facture->getEcheance());
//						$clientok->setGeneral($compteclient);
//						$em->persist($clientok);

                        $facture->setMontantreg(0);
                        $em->persist($facture);
                        $em->flush();

                    }
                }
                else
                {echo '0000';
                    $facture->setReglement(0);
                }

                //maj des autres factures du groupe
                if($facture->getTypedoc() == 'avoir'){$facture->setReglement(1);}
                $em->persist($facture);
                $em->flush();
//            echo 'codegroupe>'.$codegroupe;echo 'ence>'.$facture->getEncaisse();echo 'regl='.$facture->getReglement();
                if(isset($codegroupe) && $codegroupe > 0 && $facture->getEncaisse() == 'encaisse' && $facture->getReglement() == 1)
                {
                    $facturex = $em->getRepository('BaclooCrmBundle:Factures')
                        ->findByCodegroupe($codegroupe);
                    if(!empty($facturex))
                    {
                        $ttcgroupe =  0;
                        foreach($facturex as $fac)
                        {
                            $fac->setDatepaiement($facture->getDatepaiement());
                            $fac->setModepaiement($facture->getModepaiement());
                            $fac->setEncaisse($facture->getEncaisse());
                            $fac->setReglement(1);
                            $fac->setMontantdejareg($fac->gettotalttc()-$fac->getMontantavoir());
                            $ttcgroupe += $fac->gettotalttc();
                            $em->persist($fac);
                            $em->flush();

                            if(($fac->getModepaiement() == 'cheque' or $fac->getModepaiement() == 'lcr') and $fac->getEncaisse() == 'encaisse' )
                            {	echo 'cheque';
                                $fac->setReglement(1);
                            }
                            elseif($fac->getModepaiement() != 'cheque' or $fac->getModepaiement() != 'lcr')
                            {echo 'pas cheque';
                                $fac->setReglement(1);
                            }
                            if($fac->getTypedoc() == 'facture')
                            {echo '3';

                                $fac->setMontantreg(0);
                                $em->persist($facture);
                                $em->flush();

                            }
                        }
                        foreach($facturex as $fac)
                        {
                            $fac->setTtcgroupe($ttcgroupe);
                            $em->persist($fac);
                        }
                        $em->flush();
                    }
                }echo 'ttc3x'.$totalttc;
                if (($facture->getModepaiement() == 'cheque' or $facture->getModepaiement() == 'lcr') and $facture->getEncaisse() == 'pas encaisse')
                {
                    if ($facture->getCodegroupe() > 0) {
                        $factures = $em->getRepository('BaclooCrmBundle:Factures')
                            ->findByCodegroupe($facture->getCodegroupe());
                        foreach ($factures as $facturex) {
                            $facturex->setReglement(0);
                            //On enregistre un paiement par virement
                            //On crédite 512
                            $banque = new Afacturer;
                            $banque->setDate($today);
                            $banque->setJournal('ODR');
                            $banque->setCompte(511);
                            $banque->setDebit($facturex->getTotalttc());
                            $banque->setCredit(0);
                            $banque->setLibelle($facturex->getClient());
                            $banque->setPiece($facturex->getNumfacture());
                            $banque->setEcheance($facturex->getEcheance());
                            $banque->setAnalytique('Reglement client');
                            $banque->setModepaiement($facturex->getModepaiement());
                            $banque->setCodegroupe($facturex->getCodegroupe());
                            $em->persist($banque);
                            $em->persist($facturex);
                        }
                        $em->flush();
                    } else {
                        $facture->setReglement(0);
                        //On enregistre un paiement par virement
                        //On crédite 512
                        $banque = new Afacturer;
                        $banque->setDate($today);
                        $banque->setJournal('ODR');
                        $banque->setCompte(511);
                        $banque->setDebit($facture->getTotalttc());
                        $banque->setCredit(0);
                        $banque->setLibelle($facture->getClient());
                        $banque->setPiece($numfacture);
                        $banque->setEcheance($facture->getEcheance());
                        $banque->setAnalytique('Reglement client');
                        $banque->setModepaiement($facture->getModepaiement());
                        $banque->setCodegroupe($facture->getCodegroupe());
                        $em->persist($banque);
                    }

                    $compteclient = '411'.str_pad($facture->getClientid(), 3, "0", STR_PAD_LEFT);;
                    //On débit le bon 411
                    $clientok = new Afacturer;
                    $clientok->setDate($today);
                    $clientok->setJournal('ODR');
                    $clientok->setCompte($compteclient);
                    $clientok->setDebit(0);
                    $clientok->setCredit($facture->getTotalttc());
                    $clientok->setLibelle($facture->getClient());
                    $clientok->setPiece($numfacture);
                    $clientok->setEcheance($facture->getEcheance());
                    $clientok->setAnalytique('Reglement client');
                    $clientok->setModepaiement($facture->getModepaiement());
                    $em->persist($clientok);

                    $facture->setMontantreg(0);
                    $em->persist($facture);
                    $em->flush();
                }
                elseif (($facture->getModepaiement() == 'cheque' or $facture->getModepaiement() == 'lcr') and $facture->getEncaisse() == 'encaisse')
                {
                    if ($facture->getCodegroupe() > 0) {echo 'iiiii';
                        $factures = $em->getRepository('BaclooCrmBundle:Factures')
                            ->findByCodegroupe($facture->getCodegroupe());
                        foreach ($factures as $facturex) {
                            $facturex->setReglement(1);
                            $facturex->setEncaisse('encaisse');
                        }
                        //On enregistre un paiement par virement
                        //On crédite 512
                        $banque = new Afacturer;
                        $banque->setDate($today);
                        $banque->setJournal('ODR');
                        $banque->setCompte(512);
                        $banque->setDebit($facture->getTotalttc());
                        $banque->setCredit(0);
                        $banque->setLibelle($facture->getClient());
                        $banque->setPiece($numfacture);
                        $banque->setEcheance($facture->getEcheance());
                        $banque->setAnalytique('Reglement client');
                        $banque->setModepaiement($facture->getModepaiement());
                        $banque->setCodegroupe($facture->getCodegroupe());
                        $em->persist($banque);
                        $em->persist($facturex);
                        $em->flush();

                        $compteclient = '411'.str_pad($facture->getClientid(), 3, "0", STR_PAD_LEFT);;
                        //On débit le bon 411
                        $clientok = new Afacturer;
                        $clientok->setDate($today);
                        $clientok->setJournal('ODR');
                        $clientok->setCompte(511);
                        $clientok->setDebit(0);
                        $clientok->setCredit($facture->getTotalttc());
                        $clientok->setLibelle($facture->getClient());
                        $clientok->setPiece($numfacture);
                        $clientok->setEcheance($facture->getEcheance());
                        $clientok->setAnalytique('Reglement client');
                        $clientok->setModepaiement($facture->getModepaiement());
                        $clientok->setCodegroupe($facture->getCodegroupe());
                        $em->persist($clientok);

//                        $facture->setMontantreg(0);
                        $em->persist($facture);
                        $em->flush();
                    }  elseif ($facture->getTypedoc() == 'facture frs') {echo '4';
                        //						$facture->setMontantdejareg($montantdejareg + $facture->getMontantreg());
                        //On enregistre le paiement du fournisseur par virement
                        //On debite 512
//                        $banque = new Afacturer;
//                        $banque->setDate($today);
//                        $banque->setJournal('ACH');
//                        $banque->setCompte(512);
//                        $banque->setDebit(0);
//                        $banque->setCredit($montantreg);
//                        $banque->setLibelle($facture->getClient());
//                        $banque->setPiece($facture->getNumfacfrs());
//                        $banque->setEcheance($facture->getEcheance());
//                        $banque->setAnalytique('Reglement fournisseur');
//                        $em->persist($banque);
//                        $em->flush();
//
//                        $compteclient = '401'.$facture->getClientid();
//                        //On crédite le bon 401
//                        $clientok = new Afacturer;
//                        $clientok->setDate($today);
//                        $clientok->setJournal('ACH');
//                        $clientok->setCompte($compteclient);
//                        $clientok->setDebit($montantreg);
//                        $clientok->setCredit(0);
//                        $clientok->setLibelle($facture->getClient());
//                        $clientok->setPiece($facture->getNumfacfrs());
//                        $clientok->setEcheance($facture->getEcheance());
//                        $clientok->setAnalytique('Reglement fournisseur');
//                        $em->persist($clientok);

                        $facture->setMontantreg(0);
                        $em->flush();
                    }
                }
                elseif (($facture->getModepaiement() != 'cheque' or $facture->getModepaiement() != 'lcr') and ($facture->getTypedoc() == 'facture' or $facture->getTypedoc() == 'avoir'))
                {
                    $facture->setReglement(1);
                    if($facture->getModepaiement() == 'Liquidation' and $totalttc > 0)
                    {
                        $journalori = $em->getRepository('BaclooCrmBundle:Afacturer')
                            ->findOneBy(array('credit'=>$totalttc, 'piece'=>$facture->getNumfacture()));
                        if(!isset($journalori))
                        {//echo 'iciciiiii'.$facture->getModepaiement();exit();
                            //On enregistre un paiement par virement
                            //On débite 654
                            $banque = new Afacturer;
                            $banque->setDate($today);
                            $banque->setJournal('VT');
                            $banque->setCompte(654);
                            $banque->setDebit($facture->getTotalht());
                            $banque->setCredit(0);
                            $banque->setLibelle($facture->getClient());
                            $banque->setPiece($numfacture);
                            $banque->setEcheance($facture->getEcheance());
                            $banque->setAnalytique('Irrecouvrable');
                            $banque->setModepaiement($facture->getModepaiement());
                            $banque->setCodegroupe($facture->getCodegroupe());
                            $em->persist($banque);
                            $em->flush();

                            //On débite 4457100
                            $tva = new Afacturer;
                            $tva->setDate($today);
                            $tva->setJournal('VT');
                            $tva->setCompte(4457100);
                            $tva->setDebit($facture->getTotalttc() - $facture->getTotalht());
                            $tva->setCredit(0);
                            $tva->setLibelle($facture->getClient());
                            $tva->setPiece($numfacture);
                            $tva->setEcheance($facture->getEcheance());
                            $tva->setAnalytique('Irrecouvrable');
                            $tva->setModepaiement($facture->getModepaiement());
                            $tva->setCodegroupe($facture->getCodegroupe());
                            $em->persist($tva);
                            $em->flush();

                            $compteclient = '411'.str_pad($facture->getClientid(), 3, "0", STR_PAD_LEFT);;
                            //On débit le bon 411
                            $clientok = new Afacturer;
                            $clientok->setDate($today);
                            $clientok->setJournal('VT');
                            $clientok->setCompte($compteclient);
                            $clientok->setDebit(0);
                            $clientok->setCredit($facture->getTotalttc());
                            $clientok->setLibelle($facture->getClient());
                            $clientok->setPiece($numfacture);
                            $clientok->setEcheance($facture->getEcheance());
                            $clientok->setAnalytique('Irrecouvrable');
                            $clientok->setModepaiement($facture->getModepaiement());
                            $clientok->setCodegroupe($facture->getCodegroupe());
                            $em->persist($clientok);

//                        $facture->setMontantreg(0);
                            $em->persist($facture);
                            $em->flush();
                        }
                    }
                    else
                    {//echo 'else'.$totalttc;exit();
                        $journalori = $em->getRepository('BaclooCrmBundle:Afacturer')
                            ->findOneBy(array('compte'=>512, 'debit'=>$totalttc, 'piece'=>$facture->getNumfacture()));
                        if(!isset($journalori))
                        {
                            //On enregistre un paiement par virement
                            //On crédite 512
                            $banque = new Afacturer;
                            $banque->setDate($today);
                            $banque->setJournal('ODR');
                            $banque->setCompte(512);
                            $banque->setDebit($facture->getTotalttc());
                            $banque->setCredit(0);
                            $banque->setLibelle($facture->getClient());
                            $banque->setPiece($numfacture);
                            $banque->setEcheance($facture->getEcheance());
                            $banque->setAnalytique('Reglement client');
                            $banque->setModepaiement($facture->getModepaiement());
                            $banque->setCodegroupe($facture->getCodegroupe());
                            $em->persist($banque);
                            $em->flush();

                            $compteclient = '411'.str_pad($facture->getClientid(), 3, "0", STR_PAD_LEFT);;
                            //On débit le bon 411
                            $clientok = new Afacturer;
                            $clientok->setDate($today);
                            $clientok->setJournal('ODR');
                            $clientok->setCompte($compteclient);
                            $clientok->setDebit(0);
                            $clientok->setCredit($facture->getTotalttc());
                            $clientok->setLibelle($facture->getClient());
                            $clientok->setPiece($numfacture);
                            $clientok->setEcheance($facture->getEcheance());
                            $clientok->setAnalytique('Reglement client');
                            $clientok->setModepaiement($facture->getModepaiement());
                            $clientok->setCodegroupe($facture->getCodegroupe());
                            $em->persist($clientok);

//                        $facture->setMontantreg(0);
                            $em->persist($facture);
                            $em->flush();
                        }
                    }
                }
                if($vue == 'achats')
                {
                    return $this->redirect($this->generateUrl('bacloocrm_compta', array('vue' => 'achats', 'page' => $page, 'mode' => $mode, 'style' => '0')));
                }
                else
                {
                    return $this->redirect($this->generateUrl('bacloocrm_compta', array('vue' => 'locations', 'page' => $page, 'mode' => $mode, 'style' => $style)));
                }
            }
        }

        if($vue == 'achats')
        {
            $documents  = $em->getRepository('BaclooCrmBundle:Document')
                ->findBy(array('codecontrat' => $facture->getId(), 'type' => 'facfrs'));
            return $this->render('BaclooCrmBundle:Crm:compta_tableauachats.html.twig', array('form' => $form->createView(),
                'facture' => $facture,
                'userdetails' => $userdetails,
                'documents' => $documents,
                'page' => $page,
                'totalttc' => $totalttc,
                'vue' => $vue,
                'style' => $style,
                // 'search' => $search,
                'mode' => $mode
            ));
        }
        else
        {
            $documents  = $em->getRepository('BaclooCrmBundle:Document')
                ->findBy(array('codecontrat' => $facture->getId(), 'type' => 'facfrssl'));
            $locatafrs = $em->getRepository('BaclooCrmBundle:Locatafrs')
                ->findOneById($facture->getNumbdcloueur());
            if(empty($locatafrs)){$locatafrs = 0;}
//            if(!empty($locatafrs))
//            {
//                $facturefrs = $em->getRepository('BaclooCrmBundle:Factures')
//                    ->findBy(array('typedoc' => 'facture frs', 'locatacloneid' => $locatafrs->getId()));
//            }
//            else
//            {
//                $facturefrs = 0;
//            }

            return $this->render('BaclooCrmBundle:Crm:compta_tableau.html.twig', array('form' => $form->createView(),
                'facture' => $facture,
//                'facturefrs' => $facturefrs,
                'locatafrs' => $locatafrs,
                'documents' => $documents,
                'factureid' => $factureid,
                'userdetails' => $userdetails,
                'page' => $page,
                'vue' => $vue,
                'style' => $style,
                // 'search' => $search,
                'mode' => $mode
            ));
        }
    }

    public function envoyerfactureAction($numfacture, $mode, $page, $relance, Request $request)
    {//echo 'isi';
        $em = $this->getDoctrine()->getManager();
        $facture = $em->getRepository('BaclooCrmBundle:Factures')
            ->findOneByNumfacture($numfacture);
        $facturesechues = $em->getRepository('BaclooCrmBundle:Factures')
            ->facturesechues($facture->getClientid());

        $codecontrat = $facture->getLocatacloneid();
        $clientid = $facture->getClientid();
        if($facture->getCodelocata() == 'V-'.$codecontrat)
        {
            $locata = $em->getRepository('BaclooCrmBundle:Venda')
                ->findOneById($codecontrat);
            $type = 'vente';
        }
        elseif($facture->getCodelocata() == 'H-'.$codecontrat)
        {
            $locata = $em->getRepository('BaclooCrmBundle:Locatafrsclone')
                ->findOneById($codecontrat);
            $type = 'achat';
        }
        else
        {
            $locata = $em->getRepository('BaclooCrmBundle:Locataclone')
                ->findOneById($codecontrat);
            $type = 'loc';
        }
        // echo 'codecontrat'.$codecontrat;

        if($mode == 'avoir')
        {
            $facturedor = $em->getRepository('BaclooCrmBundle:Factures')
                ->findOneBy(array('locatacloneid' => $facture->getLocatacloneid(), 'typedoc' => 'facture', 'chantier' =>  $facture->getChantier()));
        }
        else
        {
            $facturedor = 0;
        }
// echo 'addresse1'; echo $clients->getAdresse1();
// echo '----'.$selection.'----';echo $facture->getClient();
//        echo 'relancce'.$relance;exit();
        $clients  = $em->getRepository('BaclooCrmBundle:Fiche')
            ->findOneById($clientid);
        foreach($clients->getBcontacts() as $contact)
        {
//            echo 'contactid';echo $contact->getId();
//            echo 'RECOIT';echo $contact->getRecoitfact();
            if($contact->getRecoitfact() == 1)
            {//echo 'icic';
                $facturesaimprimer[] = $locata;
//                $client[] = $clients;
                // Récupération du service
                $pdf = $this->get("white_october.tcpdf")->create();
                if($relance == 0)
                {
                    if($type == 'vente')
                    {
                        $html = $this->renderView('BaclooCrmBundle:Crm:impression_facturesventepdf.html.twig', array(
                            'locata' => $locata,
                            'mode' => 'facture',
                            'numfacture' => $numfacture,
                            'facture' => $facture,
                            'facturedor' => $facturedor,
                            'clients' => $clients,
                            'type' => $type
                        ));
                    }
                    else
                    {
                        $html = $this->renderView('BaclooCrmBundle:Crm:impression_facturespdf.html.twig', array(
                            'locata' => $locata,
                            'mode' => 'facture',
                            'numfacture' => $numfacture,
                            'facture' => $facture,
                            'facturedor' => $facturedor,
                            'clients' => $clients,
                            'type' => $type
                        ));
                    }
                    $pdf->SetFont('helvetica', '', 9, '', true);
                    // set margins
                    $pdf->SetMargins(13, '10', '5', '0');
                    $pdf->AddPage();

                    // -- set new background ---

                    // get the current page break margin
                    $bMargin = $pdf->getBreakMargin();
                    // get current auto-page-break mode
                    $auto_page_break = $pdf->getAutoPageBreak();
                    // disable auto-page-break
                    $pdf->SetAutoPageBreak(false, 0);
                    // set bacground image
                    $img_file = K_PATH_IMAGES.'devistemplate.jpg';
                    $pdf->Image($img_file, 0, 0, 210, 297, 'JPG', '', '', false, 300, '', false, false, 0);
                    // restore auto-page-break status
                    $pdf->SetAutoPageBreak($auto_page_break, $bMargin);
                    // set the starting point for the page content
                    $pdf->setPageMark();

                    $pdf->writeHTML($html, true, false, true, false, '');
                    $pdf->lastPage();
                    $pdf_as_string = new Response($pdf->Output('facture.pdf', 'S')); // $pdf is a TCPDF instance
                    // $pdf_as_string = $response->headers->set('Content-Type', 'application/pdf');
                }
                $mailer = $this->get('mailer');

                if($relance == 0)
                {
//                    var_dump(get_class($mailer));
                    if (method_exists($mailer, 'send')) {
                        echo 'Le service mailer a une méthode send.';
                    }
//                    echo 'ici';exit();
                    $message = \Swift_Message::newInstance()
                        ->setSubject('FGG Locations : Votre dernière facture (n°'.$numfacture.')')
                        ->setFrom(array('bacloo@bacloo.fr' => 'Ne pas répondre FGG Location'))
                        ->setTo($contact->getEmail())
                        // ->setTo('ringuetjm@gmail.com')
                        ->setBody($this->renderView('BaclooCrmBundle:Crm:facture_email.html.twig', array('nom' => $contact->getNom(),
                            'prenom' => $contact->getPrenom(),
                            'civilite'	=> $contact->getCivilite()
                        )))
                        ->setContentType("text/html");
                    $attachment = \Swift_Attachment::newInstance($pdf_as_string, 'facture.pdf', 'application/pdf');
                    $message->attach($attachment);
                    $sent = $mailer->send($message);

                    if ($sent)
                    {
                        $facture->setDaterelance1(date('Y-m-d'));
                    }


                    $message = \Swift_Message::newInstance()
                        ->setSubject('FGG Locations : Votre dernière facture (n°'.$numfacture.')')
                        ->setFrom(array('bacloo@bacloo.fr' => 'Ne pas répondre FGG Location'))
                        ->setTo('info@fgglocation.fr')
                        // ->setTo('ringuetjm@gmail.com')
                        ->setBody($this->renderView('BaclooCrmBundle:Crm:facture_email.html.twig', array('nom' => $contact->getNom(),
                            'prenom' => $contact->getPrenom(),
                            'civilite'	=> $contact->getCivilite()
                        )))
                        ->setContentType("text/html");
                    $attachment = \Swift_Attachment::newInstance($pdf_as_string, 'facture.pdf', 'application/pdf');
                    $message->attach($attachment);
                    $mailer->send($message);
                }
                elseif($relance == 1)
                {
                    $message = \Swift_Message::newInstance()
                        ->setSubject('FGG Location : Relance facture 1')
                        ->setFrom(array('bacloo@bacloo.fr' => 'Ne pas répondre FGG Location'))
                        ->setTo($contact->getEmail())
                        // ->setTo('ringuetjm@gmail.com')
                        ->setBody($this->renderView('BaclooCrmBundle:Crm:facture_email1.html.twig', array('nom' => $contact->getNom(),
                            'prenom' => $contact->getPrenom(),
                            'facturesechues' => $facturesechues,
                            'civilite'	=> $contact->getCivilite()
                        )))
                        ->setContentType("text/html");
                    // $attachment = \Swift_Attachment::newInstance($pdf_as_string, 'facture.pdf', 'application/pdf');
                    // $message->attach($attachment);
                    $sent = $mailer->send($message);

                    if ($sent)
                    {
                        foreach($facturesechues as $fact)
                        {
                            $fact->setDaterelance2(date('Y-m-d'));
                            $em->persist($fact);
                        }
                    }

                    //copie
                    $message = \Swift_Message::newInstance()
                        ->setSubject('FGG Location : Relance facture 1')
                        ->setFrom(array('bacloo@bacloo.fr' => 'Ne pas répondre FGG Location'))
                        ->setTo('info@fgglocation.fr')
                        // ->setTo('ringuetjm@gmail.com')
                        ->setBody($this->renderView('BaclooCrmBundle:Crm:facture_email1.html.twig', array('nom' => $contact->getNom(),
                            'prenom' => $contact->getPrenom(),
                            'facturesechues' => $facturesechues,
                            'civilite'	=> $contact->getCivilite()
                        )))
                        ->setContentType("text/html");
                    // $attachment = \Swift_Attachment::newInstance($pdf_as_string, 'facture.pdf', 'application/pdf');
                    // $message->attach($attachment);
                    $mailer->send($message);
                }
                elseif($relance == 2)
                {
                    $message = \Swift_Message::newInstance()
                        ->setSubject('FGG Location : Relance facture 2')
                        ->setFrom(array('bacloo@bacloo.fr' => 'Ne pas répondre FGG Location'))
                        ->setTo($contact->getEmail())
                        // ->setTo('ringuetjm@gmail.com')
                        ->setBody($this->renderView('BaclooCrmBundle:Crm:facture_email2.html.twig', array('nom' => $contact->getNom(),
                            'prenom' => $contact->getPrenom(),
                            'facturesechues' => $facturesechues,
                            'civilite'	=> $contact->getCivilite()
                        )))
                        ->setContentType("text/html");
                    // $attachment = \Swift_Attachment::newInstance($pdf_as_string, 'facture.pdf', 'application/pdf');
                    // $message->attach($attachment);
                    $sent = $mailer->send($message);

                    if ($sent)
                    {
                        foreach($facturesechues as $fact)
                        {
                            $fact->setDaterelance2(date('Y-m-d'));
                            $em->persist($fact);
                        }
                    }

                    //Copie
                    $message = \Swift_Message::newInstance()
                        ->setSubject('FGG Location : Relance facture 2')
                        ->setFrom(array('bacloo@bacloo.fr' => 'Ne pas répondre FGG Location'))
                        ->setTo('info@fgglocation.fr')
                        // ->setTo('ringuetjm@gmail.com')
                        ->setBody($this->renderView('BaclooCrmBundle:Crm:facture_email2.html.twig', array('nom' => $contact->getNom(),
                            'prenom' => $contact->getPrenom(),
                            'facturesechues' => $facturesechues,
                            'civilite'	=> $contact->getCivilite()
                        )))
                        ->setContentType("text/html");
                    // $attachment = \Swift_Attachment::newInstance($pdf_as_string, 'facture.pdf', 'application/pdf');
                    // $message->attach($attachment);
                    $mailer->send($message);
                }
            }
        }
//        $relance1 = $facture->getDaterelance1();
//        $relance2 = $facture->getDaterelance2();
//        $relance3 = $facture->getDaterelance3();


        $em->persist($facture);
        $em->flush();

        return $this->redirect($this->generateUrl('bacloocrm_compta', array('vue' => 'locations', 'page' => $page, 'mode' => $mode)));
    }

    public function facturationAction($codecontrat, $vue, $mode)
    {//echo 'VUUUUE'.$vue;echo 'MODA'.$mode;
        if($vue == 'achats')
        {
            include('prefacturationmensuelleachats.php');
        }
        else
        {
//            include('prefacturationmensuelle.php');
            include('prefacturationmensuelleDynamique.php');
        }
        if(!isset($message)){$message = 0;}
        if(!isset($date)){$date = 0;}
        return $this->redirect($this->generateUrl('bacloocrm_compta', array('vue' => $vue, 'mode' => 'all', 'message' => $message, 'date' => $date)));
    }

    // public function facturationdefAction($codecontrat, $vue)
    // {
    // include('facturationmensuelledefinitive.php');
    // if(!isset($message)){$message = 0;}
    // if(!isset($date)){$date = 0;}
    // return $this->redirect($this->generateUrl('bacloocrm_compta', array('vue' => $vue, 'mode' => 'all', 'message' => $message, 'date' => $date)));
    // }

    public function echangesAction($ecode, $locid, $typeloc, $message, Request $request)
    {//echo $ecode;echo $typeloc;
        $usersess = $this->get('security.context')->getToken()->getUsername();
        $em = $this->getDoctrine()->getManager();
        $now = date('Y-m-d');
        $defaultData = array();
        $form = $this->createFormBuilder($defaultData)
            ->add('newmateriel', 'text', array('required' => true))
            ->add('transportaller', 'integer', array('required' => true))
            ->add('transportretour', 'integer', array('required' => true))
            ->add('bdcrecu', 'checkbox', array('required' => false))
            ->add('numbdc', 'text', array('required' => false))
            ->getForm();
// echo $typeloc;echo $ecode;
        $typelocorigine = $typeloc;
        //on cherche une dispo
        if($typeloc == 'parc')
        {
            $oldmat = $em->getRepository('BaclooCrmBundle:Machines')
                ->findOneBy(array('code'=>$ecode, 'original' => 1));
            $codegenerique = $oldmat->getCodegenerique();
            $codelocations = $oldmat->getCodelocations();
            $debutloc = $oldmat->getDebutloc();
            $finloc = $oldmat->getFinloc();
// echo $codegenerique;
            $machine = $em->getRepository('BaclooCrmBundle:Machines')
                ->unedispo($codegenerique, $debutloc, $finloc);
// echo $debutloc;
// echo $finloc;
// print_r($machine);
            if(!empty($machine))
            {//echo '55555';
                foreach($machine as $mach)
                {
                    $ecodenewmat = $mach['code'];//echo '1111';
                }
                // $message = 0;
            }
            else
            {//echo '44444';
                if($machine != 'sl')
                {
                    $message = 1;//Pas de machine de parc dispo
                    $ecodenewmat = null;//echo '22222';
                }
                else
                {
                    $message = 2; //Pas de sous loc dispo
                    $ecodenewmat = null;//echo '33333';
                }
            }
        }
        else
        {
            $oldmat = $em->getRepository('BaclooCrmBundle:Machinessl')
                ->findOneBy(array('code'=>$ecode, 'original' => 1));
            $codegenerique = $oldmat->getCodegenerique();
            $codelocations = $oldmat->getCodelocations();
            $debutloc = $oldmat->getDebutloc();
            $finloc = $oldmat->getFinloc();
// echo $codegenerique;
            $machine = $em->getRepository('BaclooCrmBundle:Machinessl')
                ->unedispo($codegenerique, $debutloc, $finloc, $oldmat->getLoueur());

            if(!empty($machine))
            {//echo '55555';
                foreach($machine as $mach)
                {
                    $ecodenewmat = $mach['code'];//echo '1111';
                }
                // $message = 0;
            }
            else
            {//echo '44444';
                if($machine == 'sl')
                {
                    $message = 1;////Pas de machine sous-location dispo mais on met un autre modèle
                    $ecodenewmat = null;//echo '22222';
                }
                else
                {
                    $message = 2; //Pas de sous loc dispo
                    $ecodenewmat = null;//echo '33333';
                }
            }
        }

        $form->handleRequest($request);
        if($form->isValid()) {
            $data = $form->getData();
            $newmateriel = $data['newmateriel'];
            $transportaller = $data['transportaller'];
            $transportretour = $data['transportretour'];
            $bdcrecu = $data['bdcrecu'];
            $numbdc = $data['numbdc'];
// echo 'newmatos'.$newmateriel;
// echo 'locid'.$locid;
// echo 'typeloc'.$typeloc;
            //Controle avant modif
            if($typeloc == 'parc')
            {
                $dejaenr = $em->getRepository('BaclooCrmBundle:Locata')
                    ->dejaenr($newmateriel, $locid);
            }
            else
            {
                $dejaenr = $em->getRepository('BaclooCrmBundle:Locata')
                    ->dejaenrsl($newmateriel, $locid);
            }
            if(empty($dejaenr))
            {
                //On créée une nouvelle location pour ce nouveau matos
                $locata = $em->getRepository('BaclooCrmBundle:Locata')
                    ->findOneById($oldmat->getCodecontrat());
                //Calcul de demain
                $today = date('D');
                if($today == 'Fri')
                {
                    $demain = date('Y-m-d', strtotime("+3 days"));
                }
                elseif($today == 'Sat')
                {
                    $demain = date('Y-m-d', strtotime("+2 days"));
                }
                else
                {
                    $demain = date('Y-m-d', strtotime("+1 days"));
                }

                if($typeloc == 'parc')
                {//echo 'ECODE'.$ecode;
                    $oldmat  = $em->getRepository('BaclooCrmBundle:Machines')
                        ->findOneBy(array('code'=>$ecode, 'original' => 1));
                    $codegenerique = $oldmat->getCode();
                    $codelocations = $oldmat->getCodelocations();
                    $debutloc = $oldmat->getDebutloc();
                    $finloc = $oldmat->getFinloc();

                    $newmat  = $em->getRepository('BaclooCrmBundle:Machines')
                        ->findOneBy(array('code'=>$newmateriel, 'original' => 1));
                    if(!isset($newmat))
                    {
                        $newmat  = $em->getRepository('BaclooCrmBundle:Machinessl')
                            ->findOneBy(array('code'=>$newmateriel, 'original' => 1));
                        $typeloc = 'sl';
                    }
                    if(isset($newmat))
                    {
                        //On recopie les données de l'ancien matos dans le nouveau
                        $newmat->setCodecontrat($oldmat->getCodecontrat());
                        $newmat->setClientid($oldmat->getClientid());
                        $newmat->setEntreprise($oldmat->getEntreprise());
                        $newmat->setNomchantier($oldmat->getNomchantier());
                        if(strtotime($demain) > strtotime($oldmat->getFinloc()))
                        {
                            $newmat->setDebutloc($oldmat->getFinloc());
                        }
                        else
                        {
                            $newmat->setDebutloc($demain);
                        }
                        $newmat->setFinloc($oldmat->getFinloc());
                        $newmat->setEtat('Prêt au départ');
                        $newmat->setEtatlog('Prêt pour le chargement');
                        $em->persist($newmat);

                        foreach ($locata->getLocations() as $loc)
                        {
                            if($loc->getCodemachineinterne() == $ecode && $loc->getId() == $oldmat->getCodelocations())
                            {
                                //On recopie ces nouvelles données dans la nouvelle location pour le nouveau matos
                                if($typeloc == 'parc')
                                {
                                    $locatio  = $em->getRepository('BaclooCrmBundle:Locations')
                                        ->findOneBy(array('codemachineinterne' => $ecode, 'id' => $oldmat->getCodelocations()));
                                    $locations = clone $locatio;
                                }
                                else
                                {
                                    $locatio  = $em->getRepository('BaclooCrmBundle:Locations')
                                        ->findOneBy(array('codemachineinterne' => $ecode, 'id' => $oldmat->getCodelocations()));
                                    $locations = new Locationssl;
                                    $locations->setCodeclient($loc->getCodeclient());
                                    $locations->setEntreprise($loc->getEntreprise());
                                    $locations->setLoyerp1($loc->getLoyerp1());
                                    $locations->setLoyerp2($loc->getLoyerp2());
                                    $locations->setLoyerp3($loc->getLoyerp3());
                                    $locations->setLoyerp4($loc->getLoyerp4());
                                    $locations->setLoyermensuel($loc->getLoyermensuel());
                                    $locations->setContributionverte($loc->getContributionverte());
                                    $locations->setAssurance($loc->getAssurance());
                                    $locations->setTransportaller($loc->getTransportaller());
                                    $locations->setTransportretour($loc->getTransportretour());
                                    $locations->setTransportretour($loc->getTransportretour());
                                    $locations->setLitrescarb($loc->getLitrescarb());
                                    $locations->setCloture($loc->getCloture());
                                    $locations->setLoueur($newmat->getLoueur());
                                }
                                $locations->setCodemachineinterne($newmateriel);
                                $locations->setMachineid($newmat->getId());
                                $locations->setTypemachine($newmat->getDescription());
                                $locations->setCodemachine($newmat->getCodegenerique());
                                $locations->setCodeclient($loc->getCodeclient());
                                $locations->setEtatloc('Prêt au départ');
                                $locations->setEtatlog('Prêt pour le chargement');
                                $locations->setEnergie($newmat->getEnergie());
                                $locations->setBrok(0);
                                $locations->setBdok(0);
                                $locations->setBrid(0);
                                $locations->setBdid(0);
                                $locations->setBruser(0);
                                $locations->setBduser(0);
                                //Démarrage de la loc du nouveau matos à demain
                                if(strtotime($demain) > strtotime($loc->getFinloc()))
                                {
                                    $locations->setDebutloc($loc->getFinloc());
                                }
                                else
                                {
                                    $locations->setDebutloc($demain);
                                }
                                $locations->setFinloc($loc->getFinloc());
                                $nbjlocadeduire = 0;
                                $nbjloc = 0;
                                $nbjlocass = 0;
                                $iStart = strtotime ($demain);//Formate une date/heure locale avec la Something is wronguration locale
                                $iEnd = strtotime ($loc->getFinloc());
                                if (false === $iStart || false === $iEnd) {
                                    // return false;
                                }
                                $aStart = explode ('-', $demain);
                                $aEnd = explode ('-', $loc->getFinloc());
                                if (count ($aStart) !== 3 || count ($aEnd) !== 3) {
                                    // return false;
                                }
                                // if (false === checkdate ($aStart[1], $aStart[2], $aStart[0]) || false === checkdate ($aEnd[1], $aEnd[2], $aEnd[0]) || $iEnd <= $iStart) {
                                // return false;
                                // }

                                $jour50 = $loc->getJour50();
                                $jour100 = $loc->getJour100();
                                $aDates = array();
                                for ($i = $iStart; $i <= $iEnd; $i = $i + 86400 ) {
                                    $sDateToArr = strftime ('%Y-%m-%d', $i);
                                    $sYear = substr ($sDateToArr, 0, 4);
                                    $sMonth = substr ($sDateToArr, 5, 2);

                                    if(strftime ('%Y-%m-%d', $i) != strftime ('%Y-%m-%d', $i + 86400))
                                    {
                                        $aDates[] = $sDateToArr;//echo '>>'.$sDateToArr;
                                    }
                                }

                                //on calcule le nombre de jours de location
                                $feries = $this->getHolidays($year);
                                foreach($aDates as $dat)
                                {	echo $dat;
                                    $time = strtotime($dat);
                                    $newformat = date('D',strtotime($dat));
                                    // echo $dat;
                                    //Calcul nb jours fériés
                                    $i = 0;
                                    foreach($feries as $fer)
                                    {
                                        if(date('m-d', $fer) == date('m-d', $time))
                                        {
                                            if($newformat !== 'Sat' and $newformat !== 'Sun')
                                            {
                                                $i++;
                                            }
                                        }
                                    }
                                    //Facturation WE ou pas
                                    $newformat = date('D',$time);

                                    if($facturersamedi == 1 && $newformat == 'Sat')
                                    {
                                        $nbjloc++;
                                    }
                                    elseif($facturerdimanche == 1 && $newformat == 'Sun')
                                    {
                                        $nbjloc++;
                                    }
                                    elseif($newformat == 'Sat' or $newformat == 'Sun')
                                    {}
                                    else
                                    {//echo '== ajout';
                                        $nbjloc++;
                                    }
                                    if($facturationferies == 0)
                                    {
                                        $nbjloc = $nbjloc-$i;
                                    }
                                }
                                //nb jour pour les assurances car 7/7
                                foreach($aDates as $dat)
                                {
                                    $nbjlocass++;
                                }
                                $locations->setNbjloc($nbjloc);
                                $locations->setNbjlocass($nbjlocass);
                                $locations->addLocatum($locata);
                                if($typeloc == 'sl')
                                {
                                    $locata->addLocationssl($locations);
                                }
                                else
                                {
                                    $locata->addLocation($locations);
                                }
                                $em->persist($locations);
                                $em->flush();
                                //On stoppe la location de l'ancien matos à aujourd'hui
                                $locatio->setFinloc($now);

                                $nbjlocadeduire = 0;
                                $nbjloc = 0;
                                $nbjlocass = 0;
                                $iStart = strtotime ($locatio->getDebutloc());//Formate une date/heure locale avec la Something is wronguration locale
                                $iEnd = strtotime ($now);
                                if (false === $iStart || false === $iEnd) {
                                    // return false;
                                }
                                $aStart = explode ('-', $locatio->getDebutloc());
                                $aEnd = explode ('-', $now);
                                if (count ($aStart) !== 3 || count ($aEnd) !== 3) {
                                    // return false;
                                }
                                // if (false === checkdate ($aStart[1], $aStart[2], $aStart[0]) || false === checkdate ($aEnd[1], $aEnd[2], $aEnd[0]) || $iEnd <= $iStart) {
                                // return false;
                                // }

                                $jour50 = $loc->getJour50();
                                $jour100 = $loc->getJour100();
                                $aDates = array();
                                for ($i = $iStart; $i < $iEnd + 86400; $i = strtotime ('+1 day', $i) ) {
                                    $sDateToArr = strftime ('%Y-%m-%d', $i);
                                    $sYear = substr ($sDateToArr, 0, 4);
                                    $sMonth = substr ($sDateToArr, 5, 2);

                                    if(strftime ('%Y-%m-%d', $i) != strftime ('%Y-%m-%d', $i + 86400))
                                    {
                                        $aDates[] = $sDateToArr;//echo '>>'.$sDateToArr;
                                    }
                                }

                                //on calcule le nombre de jours de location
                                $feries = $this->getHolidays($year);
                                foreach($aDates as $dat)
                                {	echo $dat;
                                    $time = strtotime($dat);
                                    $newformat = date('D',strtotime($dat));
                                    // echo $dat;
                                    //Calcul nb jours fériés
                                    $i = 0;
                                    foreach($feries as $fer)
                                    {
                                        if(date('m-d', $fer) == date('m-d', $time))
                                        {
                                            if($newformat !== 'Sat' and $newformat !== 'Sun')
                                            {
                                                $i++;
                                            }
                                        }
                                    }
                                    //Facturation WE ou pas
                                    $newformat = date('D',$time);

                                    if($facturersamedi == 1 && $newformat == 'Sat')
                                    {
                                        $nbjloc++;
                                    }
                                    elseif($facturerdimanche == 1 && $newformat == 'Sun')
                                    {
                                        $nbjloc++;
                                    }
                                    elseif($newformat == 'Sat' or $newformat == 'Sun')
                                    {}
                                    else
                                    {//echo '== ajout';
                                        $nbjloc++;
                                    }
                                    if($facturationferies == 0)
                                    {
                                        $nbjloc = $nbjloc-$i;
                                    }
                                }
                                //nb jour pour les assurances car 7/7
                                foreach($aDates as $dat)
                                {
                                    $nbjlocass++;
                                }
                                $locatio->setNbjloc($nbjloc);
                                $locatio->setNbjlocass($nbjlocass);
                                $locatio->setFinloc($now);
                                $em->persist($locatio);
                                $em->flush();

                                //On met l'ancien matos en retour planifié et finloc à today
                                $oldmat->setFinloc($now);
                                $newmat->setCodelocations($locations->getId());
                                $em->flush();
                            }
                        }
                        $message = 5;//Echange effectué ajout dans la table échange
                        $echange = new Echanges;
                        $echange->setDate($demain);
                        $echange->setClientId($locata->getClientid());
                        $echange->setClient($locata->getClient());
                        $echange->setChantierid($locata->getChantierid());
                        $echange->setChantier($locata->getNomchantier());
                        $echange->setCp($locata->getCp());
                        $echange->setMaterielinitial($codegenerique);
                        $echange->setMaterielremplacement($newmateriel);
                        $echange->setUser($usersess);
                        $echange->setTypeloc($typeloc);
                        $echange->setCodecontrat($locid);
                        $em->persist($echange);
                        $em->flush();
                        // echo 'OK ECHANGE';
                    }
                    else
                    {
                        $message = 3;//Machine sélectionnée pas dispo
                    }
                }
                else
                {echo 'on est sl';echo $ecode;
                    $oldmat  = $em->getRepository('BaclooCrmBundle:Machinessl')
                        ->findOneByCode($ecode);
                    $codegenerique = $oldmat->getCode();
                    $codelocations = $oldmat->getCodelocations();
                    $debutloc = $oldmat->getDebutloc();
                    $finloc = $oldmat->getFinloc();
                    //Calcul de demain
                    $today = date('D');
                    if($today == 'Fri')
                    {
                        $demain = date('Y-m-d', strtotime("+3 days"));
                    }
                    elseif($today == 'Sat')
                    {
                        $demain = date('Y-m-d', strtotime("+2 days"));
                    }
                    else
                    {
                        $demain = date('Y-m-d', strtotime("+1 days"));
                    }
                    echo 'newmat'.$newmateriel;
                    $newmat  = $em->getRepository('BaclooCrmBundle:Machinessl')
                        ->findOneBy(array('code'=>$newmateriel, 'original' => 1));
                    if(!isset($newmat))
                    {
                        $newmat  = $em->getRepository('BaclooCrmBundle:Machines')
                            ->findOneBy(array('code'=>$newmateriel, 'original' => 1));
                        $typeloc = 'parc';
                    }
                    if(isset($newmat))
                    {
                        //On recopie les données de l'ancien matos dans le nouveau
                        $newmat->setCodecontrat($oldmat->getCodecontrat());
                        $newmat->setClientid($oldmat->getClientid());
                        $newmat->setEntreprise($oldmat->getEntreprise());
                        $newmat->setNomchantier($oldmat->getNomchantier());
                        if(strtotime($demain) > strtotime($oldmat->getFinloc()))
                        {
                            $newmat->setDebutloc($oldmat->getFinloc());
                        }
                        else
                        {
                            $newmat->setDebutloc($demain);
                        };
                        $newmat->setFinloc($oldmat->getFinloc());
                        $newmat->setEtat('Prêt au départ');
                        $newmat->setEtatlog('Prêt pour le chargement');
                        $em->persist($newmat);
                        $em->flush();
                        echo 'nouveau matos'.$newmat->getCode();echo 'typeloc'.$typeloc;
                        foreach ($locata->getLocationssl() as $loc)
                        {
                            if($loc->getCodemachineinterne() == $ecode && $loc->getId() == $oldmat->getCodelocations())
                            {
                                //On recopie ces nouvelles données dans la nouvelle location pour le nouveau matos
                                if($typeloc == 'sl')
                                {
                                    $locatio  = $em->getRepository('BaclooCrmBundle:Locationssl')
                                        ->findOneBy(array('codemachineinterne' => $ecode, 'id' => $oldmat->getCodelocations()));
                                    $locations = clone $locatio;
                                }
                                else
                                {
                                    $locatio  = $em->getRepository('BaclooCrmBundle:Locationssl')
                                        ->findOneBy(array('codemachineinterne' => $ecode, 'id' => $oldmat->getCodelocations()));
                                    $locations = new Locations;
                                    $locations->setCodeclient($loc->getCodeclient());
                                    $locations->setEntreprise($loc->getEntreprise());
                                    $locations->setLoyerp1($loc->getLoyerp1());
                                    $locations->setLoyerp2($loc->getLoyerp2());
                                    $locations->setLoyerp3($loc->getLoyerp3());
                                    $locations->setLoyerp4($loc->getLoyerp4());
                                    $locations->setLoyermensuel($loc->getLoyermensuel());
                                    $locations->setContributionverte($loc->getContributionverte());
                                    $locations->setAssurance($loc->getAssurance());
                                    $locations->setTransportaller($loc->getTransportaller());
                                    $locations->setTransportretour($loc->getTransportretour());
                                    $locations->setTransportretour($loc->getTransportretour());
                                    $locations->setLitrescarb($loc->getLitrescarb());
                                    $locations->setCloture($loc->getCloture());
                                }
                                $locations->setCodemachineinterne($newmateriel);
                                $locations->setMachineid($newmat->getId());
                                $locations->setTypemachine($newmat->getDescription());
                                $locations->setCodemachine($newmat->getCodegenerique());
                                $locations->setCodeclient($loc->getCodeclient());
                                $locations->setEtatloc('Prêt au départ');
                                $locations->setEtatlog('Prêt pour le chargement');
                                $locations->setEnergie($newmat->getEnergie());
                                //Démarrage de la loc du nouveau matos à demain
                                if(strtotime($demain) > strtotime($loc->getFinloc()))
                                {
                                    $locations->setDebutloc($loc->getFinloc());
                                }
                                else
                                {
                                    $locations->setDebutloc($demain);
                                }
                                $locations->setFinloc($loc->getFinloc());
                                $nbjlocadeduire = 0;
                                $nbjloc = 0;
                                $nbjlocass = 0;
                                $iStart = strtotime ($demain);//Formate une date/heure locale avec la Something is wronguration locale
                                $iEnd = strtotime ($loc->getFinloc());
                                if (false === $iStart || false === $iEnd) {
                                    // return false;
                                }
                                $aStart = explode ('-', $demain);
                                $aEnd = explode ('-', $loc->getFinloc());
                                if (count ($aStart) !== 3 || count ($aEnd) !== 3) {
                                    // return false;
                                }
                                // if (false === checkdate ($aStart[1], $aStart[2], $aStart[0]) || false === checkdate ($aEnd[1], $aEnd[2], $aEnd[0]) || $iEnd <= $iStart) {
                                // return false;
                                // }

                                $jour50 = $loc->getJour50();
                                $jour100 = $loc->getJour100();
                                $aDates = array();
                                for ($i = $iStart; $i <= $iEnd; $i = $i + 86400 ) {
                                    $sDateToArr = strftime ('%Y-%m-%d', $i);
                                    $sYear = substr ($sDateToArr, 0, 4);
                                    $sMonth = substr ($sDateToArr, 5, 2);

                                    if(strftime ('%Y-%m-%d', $i) != strftime ('%Y-%m-%d', $i + 86400))
                                    {
                                        $aDates[] = $sDateToArr;//echo '>>'.$sDateToArr;
                                    }
                                }

                                //on calcule le nombre de jours de location
                                $feries = $this->getHolidays($year);
                                foreach($aDates as $dat)
                                {	echo $dat;
                                    $time = strtotime($dat);
                                    $newformat = date('D',strtotime($dat));
                                    // echo $dat;
                                    //Calcul nb jours fériés
                                    $i = 0;
                                    foreach($feries as $fer)
                                    {
                                        if(date('m-d', $fer) == date('m-d', $time))
                                        {
                                            if($newformat !== 'Sat' and $newformat !== 'Sun')
                                            {
                                                $i++;
                                            }
                                        }
                                    }
                                    //Facturation WE ou pas
                                    $newformat = date('D',$time);

                                    if($facturersamedi == 1 && $newformat == 'Sat')
                                    {
                                        $nbjloc++;
                                    }
                                    elseif($facturerdimanche == 1 && $newformat == 'Sun')
                                    {
                                        $nbjloc++;
                                    }
                                    elseif($newformat == 'Sat' or $newformat == 'Sun')
                                    {}
                                    else
                                    {//echo '== ajout';
                                        $nbjloc++;
                                    }
                                    if($facturationferies == 0)
                                    {
                                        $nbjloc = $nbjloc-$i;
                                    }
                                }
                                //nb jour pour les assurances car 7/7
                                foreach($aDates as $dat)
                                {
                                    $nbjlocass++;
                                }
                                $locations->setNbjloc($nbjloc);
                                $locations->setNbjlocass($nbjlocass);
                                $locations->addLocatum($locata);
                                $em->persist($locations);
                                $em->flush();
                                $newmat->setCodelocations($locations->getId());
                                if($typeloc == 'sl')
                                {
                                    $locata->addLocationssl($locations);
                                }
                                else
                                {
                                    $locata->addLocation($locations);
                                }

                                //On stoppe la location de l'ancien matos à aujourd'hui
                                $locatio->setFinloc($now);

                                $nbjlocadeduire = 0;
                                $nbjloc = 0;
                                $nbjlocass = 0;
                                $iStart = strtotime ($locatio->getDebutloc());//Formate une date/heure locale avec la Something is wronguration locale
                                $iEnd = strtotime ($now);
                                if (false === $iStart || false === $iEnd) {
                                    // return false;
                                }
                                $aStart = explode ('-', $locatio->getDebutloc());
                                $aEnd = explode ('-', $now);
                                if (count ($aStart) !== 3 || count ($aEnd) !== 3) {
                                    // return false;
                                }
                                // if (false === checkdate ($aStart[1], $aStart[2], $aStart[0]) || false === checkdate ($aEnd[1], $aEnd[2], $aEnd[0]) || $iEnd <= $iStart) {
                                // return false;
                                // }

                                $jour50 = $loc->getJour50();
                                $jour100 = $loc->getJour100();
                                $aDates = array();
                                for ($i = $iStart; $i <= $iEnd; $i = $i + 86400 ) {
                                    $sDateToArr = strftime ('%Y-%m-%d', $i);
                                    $sYear = substr ($sDateToArr, 0, 4);
                                    $sMonth = substr ($sDateToArr, 5, 2);

                                    if(strftime ('%Y-%m-%d', $i) != strftime ('%Y-%m-%d', $i + 86400))
                                    {
                                        $aDates[] = $sDateToArr;//echo '>>'.$sDateToArr;
                                    }
                                }

                                //on calcule le nombre de jours de location
                                $feries = $this->getHolidays($year);
                                foreach($aDates as $dat)
                                {	echo $dat;
                                    $time = strtotime($dat);
                                    $newformat = date('D',strtotime($dat));
                                    // echo $dat;
                                    //Calcul nb jours fériés
                                    $i = 0;
                                    foreach($feries as $fer)
                                    {
                                        if(date('m-d', $fer) == date('m-d', $time))
                                        {
                                            if($newformat !== 'Sat' and $newformat !== 'Sun')
                                            {
                                                $i++;
                                            }
                                        }
                                    }
                                    //Facturation WE ou pas
                                    $newformat = date('D',$time);

                                    if($facturersamedi == 1 && $newformat == 'Sat')
                                    {
                                        $nbjloc++;
                                    }
                                    elseif($facturerdimanche == 1 && $newformat == 'Sun')
                                    {
                                        $nbjloc++;
                                    }
                                    elseif($newformat == 'Sat' or $newformat == 'Sun')
                                    {}
                                    else
                                    {//echo '== ajout';
                                        $nbjloc++;
                                    }
                                    if($facturationferies == 0)
                                    {
                                        $nbjloc = $nbjloc-$i;
                                    }
                                }
                                //nb jour pour les assurances car 7/7
                                foreach($aDates as $dat)
                                {
                                    $nbjlocass++;
                                }
                                $locatio->setNbjloc($nbjloc);
                                $locatio->setNbjlocass($nbjlocass);
                                $locatio->setFinloc($now);
                                $em->persist($locatio);
                                $em->flush();
                            }
                        }
                        $oldmat->setFinloc($now);
                        $em->flush();
                        $message = 5;//Echange effectué ajout dans la table échange
                    }
                    else
                    {
                        $message = 3;//Machine sélectionnée pas dispo
                    }
                }
                //Ajout Vente Transport échange
                $venda = new Venda;
                $venda->setDate($now);
                $venda->setClientid($locata->getClientid());
                $venda->setClient($locata->getClient());
                $venda->setUser($usersess);
                $venda->setOffreencours(1);
                $venda->setBdcrecu($bdcrecu);
                $venda->setNumbdc($numbdc);
                $em->persist($venda);

                $description  = 'Livraison du matériel  '.$newmat->getCode().' lors de l\'échange avec '.$oldmat->getCode();
                $vente = new Ventes;
                $vente->setDate($now);
                $vente->setUser($usersess);
                $vente->setRefarticle('trsp');
                $vente->setDescription($description);
                $vente->setQuantite(1);
                $vente->setPu($transportaller);
                $vente->setMontantvente($transportaller);
                $vente->addvenda($venda);
                $venda->addVente($vente);
                $em->persist($vente);
                $em->flush();

                $description  = 'Reprise du matériel  '.$oldmat->getCode().' lors de l\'échange avec '.$newmat->getCode();
                $vente = new Ventes;
                $vente->setDate($now);
                $vente->setUser($usersess);
                $vente->setRefarticle('trsp');
                $vente->setDescription($description);
                $vente->setQuantite(1);
                $vente->setPu($transportaller);
                $vente->setMontantvente($transportaller);
                $vente->addvenda($venda);
                $venda->addVente($vente);
                $em->persist($vente);
                $em->flush();
                //Fin ajout vente transport échange
            }
            // else
            // {
            // $message = 4;
            // }
            return $this->redirect($this->generateUrl('bacloocrm_echanges', array('ecode' => $ecode, 'locid' => $locid, 'typeloc' => $typelocorigine, 'message' => $message)));
        }
        $previous = $this->get('request')->server->get('HTTP_REFERER');
        return $this->render('BaclooCrmBundle:Crm:echanges.html.twig', array('form' => $form->createView(),
            'ecodenewmat' => $ecodenewmat,
            'codelocations' => $codelocations,
            'ecodeancienmat' => $ecode,
            'message' => $message,
            'previous' => $previous,
            'ficheid' => $oldmat->getClientid(),
            'locid' => $oldmat->getCodecontrat(),
            'typeloc' => $typeloc
        ));
    }


    public function echangespdfAction($ecode, $locid, $typeloc, Request $request)
    {
        $usersess = $this->get('security.context')->getToken()->getUsername();
        $em = $this->getDoctrine()->getManager();
        $now = date('Y-m-d');
        $defaultData = array();
        $form = $this->createFormBuilder($defaultData)
            ->add('newmateriel', 'text', array('required' => true))
            ->add('transportaller', 'integer', array('required' => true))
            ->add('transportretour', 'integer', array('required' => true))
            ->add('bdcrecu', 'checkbox', array('required' => false))
            ->add('numbdc', 'text', array('required' => false))
            ->getForm();
// echo $typeloc;
        //on cherche une dispo
        if($typeloc == 'parc')
        {
            $oldmat = $em->getRepository('BaclooCrmBundle:Machines')
                ->findOneByCode($ecode);
            $codegenerique = $oldmat->getCodegenerique();
            $codelocations = $oldmat->getCodelocations();
            $debutloc = $oldmat->getDebutloc();
            $finloc = $oldmat->getFinloc();
// echo $codegenerique;
            $machine = $em->getRepository('BaclooCrmBundle:Machines')
                ->unedispo($codegenerique, $debutloc, $finloc);
// echo $debutloc;
// echo $finloc;
// print_r($machine);
            if(!empty($machine))
            {//echo '55555';
                foreach($machine as $mach)
                {
                    $ecodenewmat = $mach['code'];//echo '1111';
                }
                $message = 0;
            }
            else
            {//echo '44444';
                if($machine != 'sl')
                {
                    $message = 1;//Pas de machine de parc dispo
                    $ecodenewmat = null;//echo '22222';
                }
                else
                {
                    $message = 2; //Pas de sous loc dispo
                    $ecodenewmat = null;//echo '33333';
                }
            }
        }
        else
        {
            $oldmat = $em->getRepository('BaclooCrmBundle:Machinessl')
                ->findOneByCode($ecode);
            $codegenerique = $oldmat->getCode();
            $codelocations = $oldmat->getCodelocations();
            $debutloc = $oldmat->getDebutloc();
            $finloc = $oldmat->getFinloc();
// echo $codegenerique;
            $machine = $em->getRepository('BaclooCrmBundle:Machinessl')
                ->unedispo($codegenerique, $debutloc, $finloc, $oldmat->getLoueur());

            if(!empty($machine))
            {//echo '55555';
                foreach($machine as $mach)
                {
                    $ecodenewmat = $mach['code'];//echo '1111';
                }
                $message = 0;
            }
            else
            {//echo '44444';
                if($machine != 'sl')
                {
                    $message = 1;//Pas de machine de parc dispo
                    $ecodenewmat = null;//echo '22222';
                }
                else
                {
                    $message = 2; //Pas de sous loc dispo
                    $ecodenewmat = null;//echo '33333';
                }
            }
        }

        $form->handleRequest($request);
        return $this->render('BaclooCrmBundle:Crm:echanges.html.twig', array('form' => $form->createView(),
            'ecodenewmat' => $ecodenewmat,
            'codelocations' => $codelocations,
            'ecodeancienmat' => $ecode,
            'message' => $message,
            'ficheid' => $oldmat->getClientid(),
            'locid' => $oldmat->getCodecontrat(),
            'typeloc' => $typeloc
        ));
    }

    public function transfertsAction($ecode, $typeloc, $codelocations, $codecontrat, $message, Request $request)
    {
        $usersess = $this->get('security.context')->getToken()->getUsername();
        $today = date('Y-m-d');
        $em = $this->getDoctrine()->getManager();
        //On recupère le bon codelocations
        if($codelocations == 0)
        {
            $locatacodeloc = $em->getRepository('BaclooCrmBundle:Locata')
                ->recupcodeloc($ecode, $typeloc, $codecontrat);
            // print_r($locatacodeloc);
            foreach($locatacodeloc as $locat)
            {
                $codelocations = $locat['c_id'];
            }
        }
        //On recupère les infos de l'ancien chantier
        $locata = $em->getRepository('BaclooCrmBundle:Locata')
            ->findOneById($codecontrat);

        //On dessine notre formulaire indépendant
        $defaultData = array();
        $form = $this->createFormBuilder($defaultData)
            ->add('date', 'text', array('required' => true))
            ->add('chantierid', 'integer', array('required' => true))
            ->add('transportaller', 'integer', array('required' => true))
            ->add('nomchantier', 'text', array('required' => true))
            ->add('adresse1', 'text', array('required' => false))
            ->add('adresse2', 'text', array('required' => false))
            ->add('adresse3', 'text', array('required' => false))
            ->add('cp', 'integer', array('required' => true))
            ->add('ville', 'text', array('required' => true))
            ->add('demandeur', 'text', array('required' => true))
            ->add('contact', 'text', array('required' => true))
            ->add('bdcrecu', 'checkbox', array('required' => false))
            ->add('numbdc', 'text', array('required' => false))
            ->getForm();

        $form->handleRequest($request);
        if($form->isValid()) {
            $data = $form->getData();
            $date = $data['date'];
            $demandeur = $data['demandeur'];
            $contact = $data['contact'];
            $newchantier = $data['nomchantier'];
            $newadresse1 = $data['adresse1'];
            $newadresse2 = $data['adresse2'];
            $newadresse3 = $data['adresse3'];
            $newcp = $data['cp'];
            $newville = $data['ville'];
            $transportaller = $data['transportaller'];
            $bdcrecu = $data['bdcrecu'];
            $numbdc = $data['numbdc'];

            //On regarde si le nouveau chantier existe déjà dans la table chantier
            $chantier = $em->getRepository('BaclooCrmBundle:Chantier')
                ->findOneByNom($newchantier);

            //Si new chantier n'existe pas alors on l'insere dans la table chanter et on flush pour avoir l'id
            if(empty($chantier))
            {
                $nouveauchantier = new Chantier;
                $nouveauchantier->setNom($newchantier);
                $nouveauchantier->setAdresse1($newadresse1);
                $nouveauchantier->setAdresse2($newadresse2);
                $nouveauchantier->setAdresse3($newadresse3);
                $nouveauchantier->setCp($newcp);
                $nouveauchantier->setVille($newville);
                $em->persist($nouveauchantier);
                $em->flush();

                $chantier = $em->getRepository('BaclooCrmBundle:Chantier')
                    ->findOneByNom($newchantier);
            }

            //On regarde si le nouveau transfert existe déjà dans la table transferts
            $newtransfert = $em->getRepository('BaclooCrmBundle:Transferts')
                ->findOneBy(array('clientid' => $locata->getClientid(), 'ecode' => $ecode, 'codecontrat' => $codecontrat));
            if(empty($newtransfert))
            {
                //On écrit les informations du transfère dans la table transfert
                $transfert = new Transferts;
                $transfert->setDate($date);
                $transfert->setEcode($ecode);
                $transfert->setChantierid($locata->getChantierid());
                $transfert->setClientid($locata->getClientid());
                $transfert->setClient($locata->getClient());
                $transfert->setOldnomchantier($locata->getNomchantier());
                $transfert->setOldadresse1($locata->getAdresse1());
                $transfert->setOldadresse2($locata->getAdresse2());
                $transfert->setOldadresse3($locata->getAdresse3());
                $transfert->setOldcp($locata->getCp());
                $transfert->setOldville($locata->getVille());
                $transfert->setNewnomchantier($newchantier);
                $transfert->setNewadresse1($newadresse1);
                $transfert->setNewadresse2($newadresse2);
                $transfert->setNewadresse3($newadresse3);
                $transfert->setNewcp($newcp);
                $transfert->setNewville($newville);
                $transfert->setTransportaller($transportaller);
                $transfert->setDemandeur($demandeur);
                $transfert->setContact($contact);
                $transfert->setCodecontrat($codecontrat);
                $transfert->setTypeloc($typeloc);
                $transfert->setUser($usersess);
                $em->persist($transfert);
                $em->flush();

                //On insere le nom du nouveau chantier dans la table locata
                $locata->setChantierid($chantier->getId());
                $locata->setNomchantier($newchantier);
                $locata->setAdresse1($newadresse1);
                $locata->setAdresse2($newadresse2);
                $locata->setAdresse3($newadresse3);
                $locata->setCp($newcp);
                $locata->setVille($newville);
                $em->persist($locata);

                //On insere le nom du nouveau chantier dans la table machines
                $machine = $em->getRepository('BaclooCrmBundle:Machines')
                    ->findOneBy(array('code' => $ecode, 'original' => 1));
                $machine->setNomchantier($newchantier);
                $machine->setEtat('Prêt au départ');
                $machine->setEtatlog('Prêt pour le chargement');

                //On modifie le statut de la livraison
                $locations = $em->getRepository('BaclooCrmBundle:Locations')
                    ->findOneByid($codelocations);
                $locations->setEtatloc('Prêt au départ');
                $locations->setEtatlog('Prêt pour le chargement');
                $em->flush();

                //Ajout Vente Transport transfert
                $venda = new Venda;
                $venda->setDate($now);
                $venda->setClientid($locata->getClientid());
                $venda->setClient($locata->getClient());
                $venda->setUser($usersess);
                $venda->setOffreencours(1);
                $venda->setBdcrecu($bdcrecu);
                $venda->setNumbdc($numbdc);
                $em->persist($venda);

                $description  = 'Transfert de '.$locata->getNomchantier().' à '.$newchantier;
                $vente = new Ventes;
                $vente->setDate($now);
                $vente->setUser($usersess);
                $vente->setRefarticle('trsp');
                $vente->setDescription($description);
                $vente->setQuantite(1);
                $vente->setPu($transportaller);
                $vente->setMontantvente($transportaller);
                $vente->addvenda($venda);
                $venda->addVente($vente);
                $em->persist($vente);
                $em->flush();
                //Fin ajout vente transport transfert
                return $this->redirect($this->generateUrl('bacloocrm_transferts', array('ecode' => $ecode, 'typeloc' => $typeloc, 'codelocations' => $codelocations, 'codecontrat' => $codecontrat, 'message' => 1)));
            }
            return $this->redirect($this->generateUrl('bacloocrm_transferts', array('ecode' => $ecode, 'typeloc' => $typeloc, 'codelocations' => $codelocations, 'codecontrat' => $codecontrat, 'message' => 2)));
        }

        return $this->render('BaclooCrmBundle:Crm:transferts.html.twig', array('form' => $form->createView(),
            'nomoldchantier' => $locata->getNomchantier(),
            'codelocations' => $codelocations,
            'codecontrat' => $codecontrat,
            'typeloc' => $typeloc,
            'date' => $today,
            'client' => $locata->getClient(),
            'clientid' => $locata->getClientid(),
            'message' => $message,
            'ecode' => $ecode
        ));
    }


    public function transfertspdfAction($ecode, $typeloc, $codelocations, $codecontrat, $message, Request $request)
    {
        $usersess = $this->get('security.context')->getToken()->getUsername();
        $today = date('Y-m-d');
        $em = $this->getDoctrine()->getManager();
        //On recupère le bon codelocations
        if($codelocations == 0)
        {
            $locatacodeloc = $em->getRepository('BaclooCrmBundle:Locata')
                ->recupcodeloc($ecode, $typeloc, $codecontrat);
            // print_r($locatacodeloc);
            foreach($locatacodeloc as $locat)
            {
                $codelocations = $locat['c_id'];
            }
        }
        //On recupère les infos de l'ancien chantier
        $locata = $em->getRepository('BaclooCrmBundle:Locata')
            ->findOneById($codecontrat);

        //On dessine notre formulaire indépendant
        $defaultData = array();
        $form = $this->createFormBuilder($defaultData)
            ->add('date', 'text', array('required' => true))
            ->add('chantierid', 'integer', array('required' => true))
            ->add('transportaller', 'integer', array('required' => true))
            ->add('nomchantier', 'text', array('required' => true))
            ->add('adresse1', 'text', array('required' => false))
            ->add('adresse2', 'text', array('required' => false))
            ->add('adresse3', 'text', array('required' => false))
            ->add('cp', 'integer', array('required' => true))
            ->add('ville', 'text', array('required' => true))
            ->add('demandeur', 'text', array('required' => true))
            ->add('contact', 'text', array('required' => true))
            ->add('bdcrecu', 'checkbox', array('required' => false))
            ->add('numbdc', 'text', array('required' => false))
            ->getForm();

        $pdf = $this->get("white_october.tcpdf")->create();

        $html = $this->renderView('BaclooCrmBundle:Crm:transferts.html.twig', array('form' => $form->createView(),
            'nomoldchantier' => $locata->getNomchantier(),
            'codelocations' => $codelocations,
            'codecontrat' => $codecontrat,
            'typeloc' => $typeloc,
            'date' => $today,
            'client' => $locata->getClient(),
            'clientid' => $locata->getClientid(),
            'message' => $message,
            'ecode' => $ecode
        ));
        $pdf->SetFont('helvetica', '', 9, '', true);
        $pdf->AddPage();
        $pdf->writeHTML($html, true, false, true, false, '');
        $pdf->lastPage();

        $response = new Response($pdf->Output('file.pdf'));
        $response->headers->set('Content-Type', 'application/pdf');

        return $response;
    }

    public function ventesAction($ficheid, $vendaid, $mode)
    {
        $user = $this->get('security.context')->getToken()->getUsername(); if(empty($user) or !isset($user) or $user == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        $em = $this->getDoctrine()->getManager();
        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($user);
        $today = date('Y-m-d');

        $client  = $em->getRepository('BaclooCrmBundle:Fiche')
            ->findOneById($ficheid);

        if($vendaid == 0)
        {
            $venda = new Venda;
            $totalvente = 0;
            $bdcrecu = 0;
        }
        else
        {
            $venda = $em->getRepository('BaclooCrmBundle:Venda')
                ->findOneById($vendaid);
            $bdcrecu = $venda->getBdcrecu();
            //FACTURATION
            $montantvente = 0;
            $totalvente = 0;
            foreach($venda->getVentes() as $ven)
            {
                $montantvente = $ven->getQuantite() * $ven->getPu();
                $totalvente += $ven->getQuantite() * $ven->getPu();
            }

            //FIN FACTURATION
        }
        $form = $this->createForm(new VendaType(), $venda);
        $request = $this->get('request');
        if ($request->getMethod() == 'POST')
        {
            $form->bind($request);
            if($form->isValid()){
                $montantvente = 0;
                $totalvente = 0;
                foreach($form->get('ventes')->getData() as $ven)
                {echo  $ven->getPu();;
                    $montantvente = $ven->getQuantite() * $ven->getPu();
                    $totalvente += $ven->getQuantite() * $ven->getPu();

                    $ven->setMontantvente($montantvente);
                    $em->persist($ven);
                    $em->flush();
                }echo 'totalvete'.$totalvente;
                $venda->setMontantvente($totalvente);
                $em->persist($venda);
                if ($mode === 'acompte') {//echo 'ici';exit();
                    $venda->setBdcrecu(1);
//                    $venda->setCodelocata($codelocata);
                    $venda->setOffreencours(1);
                    $venda->setUser($user);
                }//echo 'laa'.$mode;exit();
                $em->flush();
                $facture = $em->getRepository('BaclooCrmBundle:Factures')
                    ->findOneByCodelocata('V-'.$venda->getId());

                if(isset($facture))
                {
                    $facture->setTotalht($venda->getMontantvente());
                    if($client->getTypeclient() == 'export' or $venda->getSanstva() == 1)
                    {
                        $facture->setTotalttc($venda->getMontantvente());
                    }
                    else
                    {
                        $facture->setTotalttc($venda->getMontantvente() * 1.2);
                    }
                    $em->persist($facture);
                    $em->flush();
                }

                if($vendaid == 0)
                {
                    $vendaid = $venda->getId();
                }
                else
                {
                    $facture = $em->getRepository('BaclooCrmBundle:Factures')
                        ->findOneByCodelocata('V-'.$venda->getId());

                    if(isset($facture))
                    {
                        $facture->setTotalht($venda->getMontantvente());
                        if($client->getTypeclient() == 'export' or $venda->getSanstva() == 1)
                        {
                            $facture->setTotalttc($venda->getMontantvente());
                        }
                        else
                        {
                            $facture->setTotalttc($venda->getMontantvente() * 1.2);
                        }
                        $em->persist($facture);
                        $em->flush();
                    }
                }
// echo 'BDC RECU'.$venda->getBdcrecu();
                if($venda->getBdcrecu() == 1)
                {
                    $venda = $em->getRepository('BaclooCrmBundle:Venda')
                        ->findOneById($venda->getId());
                    $codecontrat = 'V-'.$venda->getId();
                    $facturemois = $em->getRepository('BaclooCrmBundle:Factures')
                        ->facturesmois($codecontrat);
//echo $codecontrat;
// print_r($facturemois);
                    $totalht = 0;//echo $locid;
                    $venteslignes = 0;
                    $entretienlignes = 0;
                    $transportlignes = 0;
                    $annexeslignes = 0;
                    $assurancelignes = 0;
                    $descriptionvente = array();
                    $descriptionentretien = array();
                    $descriptiontransport = array();
                    $descriptionannexe = array();

                    if($venda->getBdcrecu() == 1)
                    {
                        foreach($venda->getVentes() as $loca)
                        {
                            //Nous récupérons et formatons les différentes dates
                            // $finloc = strtotime ($loca->getFinloc());
                            // $finlocsec = strtotime ($loca->getFinloc());
                            // $dStart = $loca->getDebutloc();
                            // $dStartsec = strtotime ($loca->getDebutloc());
                            // $dEnd = $loca->getFinloc();

                            //Si date début antérieure au début du mois >> date début = début mois
                            // if($dStartsec <= $debutmoissec)
                            // {
                            // $dStart = $debutmois;
                            // }
                            //Si date fin posterieure à fin du mois >> date début = début mois
                            // if($finlocsec >= $finmoissec)
                            // {
                            // $dEnd = $finmois;
                            // }
                            //Création du montant HT de la ligne
                            if(null == $loca->getQuantite())
                            {
                                $quantite = 1;
                            }
                            else
                            {
                                $quantite = $loca->getQuantite();
                            }
                            $montantligne = $loca->getPu() * $quantite;
                            $totalht += $montantligne;

                            // $client = $em->getRepository('BaclooCrmBundle:Venda')
                            // ->findOneById($venda->getClientid());
                            //On affecte chaque ligne à sa famille
                            if($loca->getCodifvente() == 'vente')
                            {
                                $venteslignes += $montantligne;
                                $descriptionvente[] = $loca->getDescription();
                            }
                            elseif($loca->getCodifvente() == 'entretien')
                            {
                                $entretienlignes += $montantligne;
                                $descriptionentretien[] = $loca->getDescription();
                            }
                            elseif($loca->getCodifvente() == 'transport')
                            {
                                $transportlignes += $montantligne;
                                $descriptiontransport[] = $loca->getDescription();
                            }
                            elseif($loca->getCodifvente() == 'annexes')
                            {
                                $annexeslignes += $montantligne;
                                $descriptionannexe[] = $loca->getDescription();
                            }
                            elseif($loca->getCodifvente() == 'remise')
                            {
                            }
                            elseif($loca->getCodifvente() == 'assurance')
                            {
                                $assurancelignes += $montantligne;
                            }
                            //Fin affectation ligne à sa famille

                            $loca->setMontantvente($montantligne);
                            $em->persist($loca);
                            //$articles->getStockenr() = le stock avant l'enregistrement de la vente
                            $articles = $em->getRepository('BaclooCrmBundle:Articlesenvente')
                                ->findOneBy(array('reffrs' => $loca->getRefarticle(), 'designation' => $loca->getDescription()));

                        }
                        $compteclient = '411'.str_pad($venda->getClientid(), 3, "0", STR_PAD_LEFT);
// echo 'CODECONTRAT'.$codecontrat;
                        //Avant de saisir les écritures on vérifie qu'elle n'aient pas déjà été saisies
                        $facture = $em->getRepository('BaclooCrmBundle:Factures')
                            ->findOneByCodelocata($codecontrat);
                        if(!isset($facture))
                        {
                            $new = 1;
                            $facture = new Factures;
                            $facture->setMontantdejareg(0);
                            $query = $em->createQuery(
                                'SELECT b.compteurfac
								FROM BaclooCrmBundle:Factures b
								ORDER BY b.id DESC'
                            )->setMaxResults(1);
                            $lastnumfact = $query->getOneOrNullResult();
                            if(empty($lastnumfact) or !isset($lastnumfact) or $lastnumfact == null)
                            {
                                $lastnumfact = 0;//echo 'vide';
                            }
                            else
                            {
                                $lastnumfact = $query->getSingleScalarResult();//echo 'pas vide';
                            }
//							$numfacture = date('Y').'V'.$lastnumfact++;
//Ajout à la table factures
                            // $facta = $em->getRepository('BaclooCrmBundle:Facta')
                            // ->findOneByControle('1234');


                            $client = $em->getRepository('BaclooCrmBundle:Fiche')
                                ->findOneById($venda->getClientid());

                            if($client->getDelaireglement() == 1)
                            {
                                $next45 = $today;
                            }
                            elseif($client->getDelaireglement() == 2)
                            {
                                $next45a = date('Y-m-d', strtotime('+45 days'));
                                $next45 = date('Y-m-t', strtotime($next45a));
                            }
                            elseif($client->getDelaireglement() == 3)
                            {
                                $next45a = date('Y-m-d', strtotime('+45 days'));
                                $next45 = date('Y-m-t', strtotime($next45a));
                            }
                            else
                            {
                                $next45 = $today;
                            }
                            if($venda->getRemise() > 0)
                            {
                                $totalhtfac = $venda->getMontantvente() - ($venda->getMontantvente() * $venda->getRemise()/100);
                            }
                            else
                            {
                                $totalhtfac = $venda->getMontantvente();
                            }
                            // echo 'Echeance'.$next45;
                            $tva20 = $totalhtfac * 0.20;
                            $totalttc = $totalhtfac + $tva20;

                            $facture->setNumfacture('En attente');
                            $facture->setCodelocata('V-'.$venda->getId());
                            $facture->setClientid($venda->getClientid());
                            $facture->setClient($venda->getClient());
                            $facture->setTotalht($totalhtfac);
                            if($client->getTypeclient() == 'export' or $venda->getSanstva() == 1)
                            {
                                $facture->setTotalttc($totalhtfac);
                            }
                            else
                            {
                                $facture->setTotalttc($totalhtfac * 1.2);
                            }
                            $facture->setEcheance($next45);
                            $facture->setChantier($venda->getClient());
                            $facture->setReglement(0);
                            $facture->setDatepaiement('');
                             $facture->setModepaiement($client->getTypepaiement());
                            $facture->setTypedoc('facture');
                            $facture->setDatecrea($today);
                            $facture->setCompteurfac(99999);
                            $facture->setUser($venda->getUser());
                            if ($mode === 'acompte') {
                                $facture->setSelection(1);
                                $facture->setCommentaire('Acompte');
                            }
                            $facture->setLocatacloneid($venda->getId());
                            $facture->setAnnee(date('y'));
                            $facture->setMois(date('m'));
                            if($new == 1)
                            {
                                $facture->addFiche($client);
                                $client->addFacture($facture);
                            }
                            $em->persist($venda);
                            $em->persist($facture);
                            $em->persist($client);
                            $em->flush();
                            //Fin ajout table factures
                        }
                    }
                    else{echo 'faut pas enregistrer les ventes';}
                }
                return $this->redirect($this->generateUrl('bacloocrm_ventes', array('ficheid' => $ficheid, 'vendaid' => $vendaid, 'mode' => $mode)));
            }
        }
        $factures = $em->getRepository('BaclooCrmBundle:Factures')
            ->findOneByCodelocata('V-'.$vendaid);
//echo 'ttoto';
        if(isset($factures)){$afac = 'ok';$numfacture = $factures->getNumfacture();$idfac = $factures->getId();}else{$afac = 'nok';$numfacture = 0;$idfac = 0;}
        //echo 'NUMFACTURE';echo $numfacture;
        return $this->render('BaclooCrmBundle:Crm:nouvelle_vente.html.twig', array('form' => $form->createView(),
            'date' => $today,
            'mode' => $mode,
            'vendaid' => $vendaid,
            'afac' => $afac,
            'client' => $client,
            'totalvente' => $totalvente,
            'bdcrecu' => $bdcrecu,
            'userdetails' => $userdetails,
            'idfac' => $idfac,
            'numfacture' => $numfacture,
            'user' => $user
        ));
    }

    public function ventespdfAction($ficheid, $mode, $vendaid, Request $request)
    {
        $user = $this->get('security.context')->getToken()->getUsername(); if(empty($user) or !isset($user) or $user == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        $em = $this->getDoctrine()->getManager();
        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($user);
        $today = date('Y-m-d');

        $client  = $em->getRepository('BaclooCrmBundle:Fiche')
            ->findOneById($ficheid);

        if($vendaid == 0)
        {
            $venda = new Venda;
            $totalvente = 0;
            $bdcrecu = 0;
        }
        else
        {
            $venda = $em->getRepository('BaclooCrmBundle:Venda')
                ->findOneById($vendaid);
            $bdcrecu = $venda->getBdcrecu();
            //FACTURATION
            $montantvente = 0;
            $totalvente = 0;
            foreach($venda->getVentes() as $ven)
            {
                $montantvente = $ven->getQuantite() * $ven->getPu();
                $totalvente += $ven->getQuantite() * $ven->getPu();

                $ven->setMontantvente($montantvente);
                $em->persist($ven);
                $em->flush();
            }
            $venda->setMontantvente($totalvente);
            $em->persist($venda);
            $em->flush();
            //FIN FACTURATION
        }

        $pdf = $this->get("white_october.tcpdf")->create();

        $html = $this->renderView('BaclooCrmBundle:Crm:nouvelle_ventepdf.html.twig', array('date' => $today,
            'vendaid' => $vendaid,
            'client' => $client,
            'totalvente' => $totalvente,
            'bdcrecu' => $bdcrecu,
            'venda' => $venda,
            'mode' => $mode,
            'userdetails' => $userdetails,
            'user' => $user
        ));
        $pdf->SetFont('helvetica', '', 9, '', true);
        // set margins
        $pdf->SetMargins(13, '10', '5', '0');
        // SetMargins($left,$top,$right = -1,$keepmargins = false)
        $pdf->AddPage();

        // -- set new background ---

        // get the current page break margin
        $bMargin = $pdf->getBreakMargin();
        // get current auto-page-break mode
        $auto_page_break = $pdf->getAutoPageBreak();
        // disable auto-page-break
        $pdf->SetAutoPageBreak(false, 0);
        // set bacground image
        $img_file = K_PATH_IMAGES.'devistemplate.jpg';
        $pdf->Image($img_file, 0, 0, 210, 297, 'JPG', '', '', false, 300, '', false, false, 0);
        // restore auto-page-break status
        $pdf->SetAutoPageBreak($auto_page_break, $bMargin);
        // set the starting point for the page content
        $pdf->setPageMark();

        $pdf->writeHTML($html, true, false, true, false, '');
        $pdf->lastPage();

        $response = new Response($pdf->Output('file.pdf'));
        $response->headers->set('Content-Type', 'application/pdf');

        return $response;
    }
	
	public function avoirlocAction($locid, $message, $numavoir, $numfacture, Request $request)
	{
		$usersess = $this->get('security.context')->getToken()->getUsername();
		$today = date('Y-m-d');
//echo 'numavoir'.$numavoir;
//echo 'numfacture'.$numfacture;

		$em = $this->getDoctrine()->getManager();
		if($numfacture === 0)
		{
			$lavoir = $em->getRepository('BaclooCrmBundle:Factures')
				->findOneByNumfacture($numavoir);
			$lafacturedor = $em->getRepository('BaclooCrmBundle:Factures')
				->findOneBy(array('locatacloneid' => $lavoir->getLocatacloneid(), 'typedoc' => 'facture'));
			$numfacture = $lafacturedor->getNumfacture();
		}
		$locata = $em->getRepository('BaclooCrmBundle:Locataclone')
			->findOneById($locid);

		$numfacturedor = $numfacture;
// echo $locid;
// echo $locata->getId();
// echo $locata->getClientid();
		//On dessine notre formulaire indépendant
		$defaultData = array();
		$form = $this->createFormBuilder($defaultData)
			->add('avoirtotal', 'checkbox', array('required' => false))
			->add('montantavoirpartiel', 'number', array('required' => false))
			->add('commentaire', 'textarea', array('required' => true))
			->getForm();

		$form->handleRequest($request);
		if($form->isValid()) {
			$data = $form->getData();
			$avoirtotal = $data['avoirtotal'];
			$montantavoirpartiel = $data['montantavoirpartiel'];
			$commentaire = $data['commentaire'];
			$client = $em->getRepository('BaclooCrmBundle:Fiche')
						->findOneById($locata->getClientid());

			//On calcul les montants dont on aura besoin
			if($avoirtotal == 1)
			{
				//Si avoir Total

				//On débite le compte assurance si assurance facturé
				if($locata->getAssurance() == 1)
				{
					$totalhthorsass = $locata->getMontantloc() + $locata->getContributionverte() + $locata->getTransportaller() + $locata->getTransportretour() + $locata->getMontantcarb() + $locata->getMontantlocavente();
					$assurance = $locata->getAssurance();
					$totalht = $totalhthorsass + $assurance;
				}
				else
				{
					$assurance = 0;
					$totalht = $locata->getMontantloc() + $locata->getContributionverte() + $locata->getAssurance() + $locata->getTransportaller() + $locata->getTransportretour() + $locata->getMontantcarb() + $locata->getMontantlocavente();
				}
				if($client->getTypeclient() == 'france')
				{
					$tva = $totalht * 0.20;
					$totalttc = $totalht + $tva;
				}
				else
				{
					$tva = 0;
					$totalttc = $totalht;
				}
			}
			else
			{
				//Si avoir partiel
				$totalht = $montantavoirpartiel;

				if($client->getTypeclient() == 'france')
				{
					$tva = $montantavoirpartiel*0.20;
					$totalttc = $totalht + $tva;
				}
				else
				{
					$tva = 0;
					$totalttc = $totalht + $tva;
				}

				if($locata->getAssurance() == 1)
				{
					$totalhthorsass = $totalht/1.1;
					$assurance = $totalht - $totalhthorsass;
				}
				else
				{
					$totalhthorsass = $totalht;
					$assurance = 0;
				}
			}

			if($numavoir == 0)
			{	echo 'ici';
				$facture = new Factures;
                $facture->setMontantdejareg(0);
				$new = 1;
                $mois = date('m');
                $annee = date('y');
                //Faut d'abord voir s'il existe des factures pour le mois en question
                $facture->setMontantdejareg(0);
                $query = $em->createQuery(
                    'SELECT b
								FROM BaclooCrmBundle:Factures b
								WHERE b.typedoc != :typedoc
                                and b.compteurfac > :compteurfac
                                and b.compteurfac != :compteurfac2
								ORDER BY b.compteurfac DESC'
                )->setMaxResults(1);
                $query->setParameter('typedoc', 'bon de commande');
                $query->setParameter('compteurfac', 0);
                $query->setParameter('compteurfac2', 99999);
                // $lastnumfact = $query->getResult();
                // if(empty($lastnumfact)){$lastnum = 0;}
                // else{foreach($lastnumfact as $last){$lastnum = $last['id'];}}
                $lastnumfacture = $query->getOneOrNullResult();
                if(!empty($lastnumfacture) or isset($lastnumfacture) or $lastnumfacture != null)
                {echo 'lax';
                    $lastnumfacture = $query->getSingleResult();//echo 'pas vide';echo $lastnumfacture->getId();exit();
//                $mois = $lastnumfacture->getMois();
                    $lastnumfact = $lastnumfacture->getCompteurfac();
                }
                else
                {
                    exit('Mauvais numéro de facture');
                }
                $lastnumfact = $lastnumfact+1;//echo 'lllll'.$lastnumfact;exit();

                $today = date('Y-m-d');
                $mois = date('m',strtotime($today));
                $annee = date('y',strtotime($today));

                $numfact = str_pad($lastnumfact, 3, "0", STR_PAD_LEFT);

                $numfacture = 'A'.$annee.$mois.$numfact;
            }
            else
            {echo 'laaaa';
                $facture = $em->getRepository('BaclooCrmBundle:Factures')
                    ->findOneByNumfacture($numavoir);
                $numfacture = $numavoir;
                $new = 0;
            }

            //avant de passer les écritures on vérifie qu'elles n'existent pas deja dans le journalori
            $compteclient = '411'.str_pad($locata->getClientid(), 3, "0", STR_PAD_LEFT);
            $journalori = $em->getRepository('BaclooCrmBundle:Afacturer')
                ->findOneBy(array('compte'=>$compteclient, 'credit'=>$totalttc, 'piece'=>$locata->getId()));

            //Si opréation déjà passée alerter l'utilisateur et bloquer sinon passer
            if(!empty($journalori))
            {
                $message = 1; //Vous avez déjà passé cette écriture le ...
                return $this->redirect($this->generateUrl('bacloocrm_avoirloc', array('locid' => $locata->getId(), 'message' => $message)));
            }
            else
            {
                //On passe les écritures

                //On débite le compte 700 utilisé
                $ftotalht = new Afacturer;
                $ftotalht->setDate($today);
                $ftotalht->setJournal('VT');
                if($client->getTypeclient() == 'france')
                {
                    $ftotalht->setCompte(706100);
                }
                elseif($client->getTypeclient() == 'ue')
                {
                    $ftotalht->setCompte(706110);
                }
                elseif($client->getTypeclient() == 'export')
                {
                    $ftotalht->setCompte(706115);
                }else{$ftotalht->setCompte(9999999);}
                $ftotalht->setDebit($totalht);
                $ftotalht->setCredit(0);
                $ftotalht->setLibelle('Avoir sur facture n°'.$numfacture);
                $ftotalht->setPiece($numfacture);
                $ftotalht->setEcheance(date('Y-m-d'));
                $ftotalht->setAnalytique('Loc');
                $em->persist($ftotalht);

                //On débite le compte assurance si assurance facturé
                if($locata->getAssurance() == 1)
                {
                    $fassurance= new Afacturer;
                    $fassurance->setDate($today);
                    $fassurance->setJournal('VT');
                    if($client->getTypeclient() == 'france')
                    {
                        $fassurance->setCompte(706200);
                        $fassurance->setLibelle('Assurance France');
                    }
                    elseif($client->getTypeclient() == 'ue')
                    {
                        $fassurance->setCompte(706201);
                        $fassurance->setLibelle('Assurance UE');
                    }
                    elseif($client->getTypeclient() == 'export')
                    {
                        $fassurance->setCompte(706202);
                        $fassurance->setLibelle('Assurance Export');
                    }
                    $fassurance->setDebit($assurance);
                    $fassurance->setCredit(0);
                    $fassurance->setPiece($numfacture);
                    $fassurance->setEcheance(date('Y-m-d', strtotime("+45 days")));
                    $fassurance->setAnalytique('Assurance');
                    $em->persist($fassurance);
                }

                //On débite le compte TVA si client france
                if($client->getTypeclient() == 'france')
                {
                    $ftva = new Afacturer;
                    $ftva->setDate($today);
                    $ftva->setJournal('VT');
                    $ftva->setCompte(445710);
                    $ftva->setDebit($tva);
                    $ftva->setCredit(0);
                    $ftva->setLibelle('TVA collectée');
                    $ftva->setPiece($numfacture);
                    $ftva->setEcheance(date('Y-m-d'));
                    $ftva->setAnalytique('Tva');
                    $em->persist($ftva);
                }

                //On crédite 411
                $afacturer = new Afacturer;
                $afacturer->setDate($today);
                $afacturer->setJournal('VT');
                $afacturer->setCompte($compteclient);
                $afacturer->setDebit(0);
                if($client->getTypeclient() != 'france')
                {
                    $afacturer->setCredit($totalht);
                }
                else
                {
                    $afacturer->setCredit($totalttc);
                }
                $afacturer->setLibelle($locata->getClient());
                $afacturer->setPiece($numfacture);
                $afacturer->setEcheance(date('Y-m-d', strtotime("+45 days")));
                $afacturer->setAnalytique('Client');
                $em->persist($afacturer);
                $em->flush();
            }
            //Ajout à la table factures
            // $facta = $em->getRepository('BaclooCrmBundle:Facta')
            // ->findOneByControle('1234');



            $client = $em->getRepository('BaclooCrmBundle:Fiche')
                ->findOneById($locata->getClientid());
            if($client->getDelaireglement() == 1)
            {
                $next45 = $locata->getDatemodif();
            }
            elseif($client->getDelaireglement() == 2)
            {
                $date = date('Y-m-t');
                $next45 = date('Y-m-d', strtotime($date . '+45 days'));
            }
            elseif($client->getDelaireglement() == 3)
            {
                $next45 = date('Y-m-d', strtotime($locata->getDatemodif() . '+30 days'));
            }

            $facture->setNumfacture($numfacture);
            $facture->setCodelocata($locata->getOldid());
            $facture->setClientid($locata->getClientid());
            $facture->setClient($locata->getClient());
            $facture->setTotalht($totalht);
            $facture->setTotalttc($totalttc);
            $facture->setEncompta(1);
            if($client->getTypeclient() != 'france')
            {
                $afacturer->setCredit($totalht);
            }
            else
            {
                $afacturer->setCredit($totalttc);
            }
            $facture->setEcheance($next45);
            // $facture->setDebutloc($locata->getDebutloc());
            // $facture->setFinloc($locata->getFinloc());
            $facture->setChantier($locata->getNomchantier());
            $facture->setReglement(1);
            $facture->setDatepaiement('');
            $facture->setModepaiement('');
            $facture->setTypedoc('avoir');
            $facture->setDatecrea($today);
            if($numavoir == 0)
            {
                $facture->setCompteurfac($lastnumfact++);
            }
            else
            {echo 'laaaa';
                $facture->setCompteurfac($facture->getCompteurfac());
            }
            $facture->setUser($locata->getUser());
            $facture->setLocatacloneid($locata->getId());
            $facture->setAnnee(date('y'));
            $facture->setMois(date('m'));
            $facture->setCommentaire($commentaire);
            if($numavoir == 0)
            {
                // $facture->addFactum($facta);
                // $facta->addFacture($facture);
            }
            if($avoirtotal == 1)
            {
                $facturedor = $em->getRepository('BaclooCrmBundle:Factures')
                    ->findOneByNumfacture($numfacturedor);
                $facturedor->setReglement(1);
                $facturedor->setMontantavoir($totalttc);
                $facturedor->setCommentaire('Facture annulée par l\'avoir n°'.$numavoir);
                $em->persist($facturedor);
            }
            else
            {
                $facturedor = $em->getRepository('BaclooCrmBundle:Factures')
                    ->findOneByNumfacture($numfacturedor);
                $facturedor->setMontantavoir($totalttc);
                $facturedor->setCommentaire('Avoir n°'.$numavoir.' réalisé pour un montant de ttc de '.$totalttc.' €');
                $em->persist($facturedor);
            }
            if($new == 1)
            {
                $facture->addFiche($client);
                $client->addFacture($facture);
            }
            $em->persist($facture);
            $em->persist($client);
            $em->flush();
            //Fin ajout table factures

            return $this->redirect($this->generateUrl('bacloocrm_avoirloc', array('locid' => $locata->getId(), 'numavoir'=> $numavoir, 'numfacture' => $numfacture, 'message' => 2)));//Avoir enregistré
        }
        if($numavoir == 0)
        {
            $avoirtotal = 0;
            $montantavoirpartiel = 0;
            $commentaire = 0;
        }
        else
        {
            // echo 'numavoir'.$numavoir;
            $avoir = $em->getRepository('BaclooCrmBundle:Factures')
                ->findOneByNumfacture($numavoir);
// echo $avoir->getTotalht();
            $facturedor = $em->getRepository('BaclooCrmBundle:Factures')
                ->findOneBy(array('locatacloneid' => $avoir->getLocatacloneid(), 'typedoc' => 'facture', 'chantier' =>  $avoir->getChantier()));
            if($avoir->getTotalht() == $facturedor->getTotalht())
            {
                $avoirtotal = 1;
                $montantavoirpartiel = $avoir->getTotalht();
                $commentaire = $avoir->getCommentaire();
            }
            else
            {
                $avoirtotal = 0;
                $montantavoirpartiel = $avoir->getTotalht();
                $commentaire = $avoir->getCommentaire();
            }
// echo $commentaire;
// echo $avoirtotal;
        }
        $previous = $this->get('request')->server->get('HTTP_REFERER');
        return $this->render('BaclooCrmBundle:Crm:avoirloc.html.twig', array('form' => $form->createView(),
            'locata' => $locata,
            'message' => $message,
            'previous' => $previous,
            'avoirtotal' => $avoirtotal,
            'montantavoirpartiel' => $montantavoirpartiel,
            'commentaire' => $commentaire,
            'numavoir' => $numavoir,
            'numfacture' => $numfacture,
            'ficheid' => $locata->getClientid()
        ));
    }

    public function avoirventesAction($vendaid, $message, $numavoir, $numfacture, Request $request)
    {//echo $numavoir;
        $usersess = $this->get('security.context')->getToken()->getUsername();
        $today = date('Y-m-d');
        $em = $this->getDoctrine()->getManager();
        $numfacturedor = $numfacture;

        //On recupère les infos de la vente
        $venda = $em->getRepository('BaclooCrmBundle:Venda')
            ->findOneById($vendaid);

        //On dessine notre formulaire indépendant
        $defaultData = array();
        $form = $this->createFormBuilder($defaultData)
            ->add('avoirtotal', 'checkbox', array('required' => false))
            ->add('montantavoirpartiel', 'number', array('required' => false))
            ->add('commentaire', 'textarea', array('required' => true))
            ->add('vente', 'number', array('required' => false))
            ->add('entretien', 'number', array('required' => false))
            ->add('transport', 'number', array('required' => false))
            ->add('assurance', 'number', array('required' => false))
            ->add('paa', 'number', array('required' => false))
            ->getForm();

        $form->handleRequest($request);
        if($form->isValid()) {
            $data = $form->getData();
            $avoirtotal = $data['avoirtotal'];
            $montantavoirpartiel = $data['montantavoirpartiel'];
            $commentaire = $data['commentaire'];
            $venteht = $data['vente'];
            $entretienht = $data['entretien'];
            $transportht = $data['transport'];
            $assuranceht = $data['assurance'];
            $paaht = $data['paa'];
            $client = $em->getRepository('BaclooCrmBundle:Fiche')
                ->findOneById($venda->getClientid());

            if($numavoir == 0)
            {
                echo 'ici';
                $facture = new Factures;
                $facture->setMontantdejareg(0);
                $new = 1;
                $mois = date('m');
                $annee = date('y');
                //Faut d'abord voir s'il existe des factures pour le mois en question
                $facture->setMontantdejareg(0);
                $query = $em->createQuery(
                    'SELECT b
                        FROM BaclooCrmBundle:Factures b
                        WHERE b.typedoc != :typedoc
                        and b.compteurfac > :compteurfac
                        and b.compteurfac != :compteurfac2
                        ORDER BY b.compteurfac DESC'
                )->setMaxResults(1);
                $query->setParameter('typedoc', 'bon de commande');
                $query->setParameter('compteurfac', 0);
                $query->setParameter('compteurfac2', 99999);
                // $lastnumfact = $query->getResult();
                // if(empty($lastnumfact)){$lastnum = 0;}
                // else{foreach($lastnumfact as $last){$lastnum = $last['id'];}}
                $lastnumfacture = $query->getOneOrNullResult();
                if(!empty($lastnumfacture) or isset($lastnumfacture) or $lastnumfacture != null)
                {echo 'lax';
                    $lastnumfacture = $query->getSingleResult();//echo 'pas vide';echo $lastnumfacture->getId();exit();
//                $mois = $lastnumfacture->getMois();
                    $lastnumfact = $lastnumfacture->getCompteurfac();
                }
                else
                {
                    exit('Mauvais numéro de facture');
                }
                $lastnumfact = $lastnumfact+1;//echo 'lllll'.$lastnumfact;exit();

                $today = date('Y-m-d');
                $mois = date('m',strtotime($today));
                $annee = date('y',strtotime($today));

                $numfact = str_pad($lastnumfact, 3, "0", STR_PAD_LEFT);
                $numfacture = 'A'.$annee.$mois.$numfact;
            }
            else
            {
                $facture = $em->getRepository('BaclooCrmBundle:Factures')
                    ->findOneByNumfacture($numavoir);
                $numfacture = $numavoir;
                $lastnumfact = $facture->getCompteurfac();
                $new = 0;//echo 'laa'.$numfacture;exit();
            }

            $numavoir = $numfacture;
            //On calcul les montant dont on aura besoin
            if(isset($avoirtotal) && $avoirtotal == 1)
            {
                //Si avoir Total
                $totalht = $venda->getMontantvente();
                if($client->getTypeclient() == 'france')
                {
                    //Faire une boucle pour recup montantht chaque compte 7
                    $venteht = 0;
                    $entretienht = 0;
                    $transportht = 0;
                    $assuranceht = 0;
                    $paaht = 0;
                    foreach($venda->getVentes() as $vente)
                    {
                        if($vente->getCodifvente() == 'vente')
                        {
                            $venteht += $vente->getMontantvente();
                        }
                        if($vente->getCodifvente() == 'entretien')
                        {
                            $entretienht += $vente->getMontantvente();
                        }
                        if($vente->getCodifvente() == 'transport')
                        {
                            $transportht += $vente->getMontantvente();
                        }
                        if($vente->getCodifvente() == 'annexes')
                        {
                            $paaht += $vente->getMontantvente();
                        }
                        if($vente->getCodifvente() == 'assurance')
                        {
                            $assuranceht += $vente->getMontantvente();
                        }
                        $tva = $totalht * 0.20;
                        $totalttc = $totalht + $tva;
                    }
                }
                else
                {
                    $tva = 0;
                    $venteht = $venteht;
                    $entretienht = $entretienht;
                    $transportht = $transportht;
                    $assuranceht = $assuranceht;
                    $paaht = $paaht;
                    $totalttc = $totalht;
                }
            }
            else
            {
                //Si avoir partiel
                $totalht = $venteht + $entretienht + $transportht + $assuranceht + $paaht;
                if($client->getTypeclient() == 'france')
                {
                    $totalttc = $totalht*1.2;
                    $tva = $totalttc - $totalht;
                    $ventettc = $venteht*1.2;
                    $entretienttc = $entretienht*1.2;
                    $transportttc = $transportht*1.2;
                    $assurancettc = $assuranceht*1.2;
                    $paattc = $paaht*1.2;
                }
                else
                {
                    $totalttc = $totalht;
                    $tva = 0;
                    $venteht = $venteht;
                    $entretienht = $entretienht;
                    $transportht = $transportht;
                    $assuranceht = $assuranceht;
                    $paaht = $paaht;
                }
            }

            //avant de passer les écritures on vérifie qu'elles n'existent pas deja dans le journalori
            $compteclient = '411'.str_pad($venda->getClientid(), 3, "0", STR_PAD_LEFT);
            $journalori = $em->getRepository('BaclooCrmBundle:Afacturer')
                ->findOneBy(array('compte'=>$compteclient, 'credit'=>$totalttc, 'piece'=>'V-'.$venda->getId()));

            //Si opréation déjà passée alerter l'utilisateur et bloquer sinon passer
            if(!empty($journalori))
            {
                $message = 1; //Vous avez déjà passé cette écriture le ...
                return $this->redirect($this->generateUrl('bacloocrm_avoirventes', array('vendaid' => $venda->getId(), 'message' => $message)));
            }
            else
            {
                $venteht1 = 0;
                $entretienht1 = 0;
                $transportht1 = 0;
                $assuranceht1 = 0;
                $paaht1 = 0;
                //On récupère les montants ht de chaque compte 7
                foreach($venda->getVentes() as $vente)
                {
                    if($vente->getCodifvente() == 'vente')
                    {
                        $venteht1 += $vente->getMontantvente();
                    }
                    if($vente->getCodifvente() == 'entretien')
                    {
                        $entretienht1 += $vente->getMontantvente();
                    }
                    if($vente->getCodifvente() == 'transport')
                    {
                        $transportht1 += $vente->getMontantvente();
                    }
                    if($vente->getCodifvente() == 'annexes')
                    {
                        $paaht1 += $vente->getMontantvente();
                    }
                    if($vente->getCodifvente() == 'assurance')
                    {
                        $assuranceht1 += $vente->getMontantvente();
                    }
                }
                //On passe les écritures

                //On débite le compte 700 utilisé
                //On débite le compte vente 707
                if(isset($venteht) && $venteht > 0 && isset($venteht1))
                {
                    if($venteht <= ($totalht))
                    {
                        $ventes = new Afacturer;
                        $ventes->setDate($today);
                        $ventes->setJournal('VT');
                        if($client->getTypeclient() == 'france')
                        {
                            $ventes->setCompte(707100);
                        }
                        elseif($client->getTypeclient() == 'ue')
                        {
                            $ventes->setCompte(707110);
                        }
                        elseif($client->getTypeclient() == 'export' or $venda->getSanstva() == 1)
                        {
                            $ventes->setCompte(707115);
                        }else{$ventes->setCompte(9999999);}
                        $ventes->setDebit($venteht);
                        $ventes->setCredit(0);
                        $ventes->setLibelle($venda->getClient());
                        $ventes->setPiece($numavoir);
                        $ventes->setEcheance(date('Y-m-d'));
                        $ventes->setAnalytique('Vente');
                        $em->persist($ventes);
                    }
                    else
                    {
                        return $this->redirect($this->generateUrl('bacloocrm_avoirventes', array('vendaid' => $venda->getId(), 'message' => 3)));//Le montant saisi ne doit pas être supérieur au montant ci-dessus.(montant d'origine)
                    }
                }

                //on débite le compte entretien 706
                if(isset($entretienht) && $entretienht > 0 && isset($entretienht1))
                {
                    if($entretienht <= ($totalht))
                    {
                        $entretien = new Afacturer;
                        $entretien->setDate($today);
                        $entretien->setJournal('VT');
                        if($client->getTypeclient() == 'france')
                        {
                            $entretien->setCompte(706220);
                        }
                        elseif($client->getTypeclient() == 'ue')
                        {
                            $entretien->setCompte(706221);
                        }
                        elseif($client->getTypeclient() == 'export')
                        {
                            $entretien->setCompte(706222);
                        }else{$entretien->setCompte(9999999);}
                        $entretien->setDebit($entretienht);
                        $entretien->setCredit(0);
                        $entretien->setLibelle($venda->getClient());
                        $entretien->setPiece($numavoir);
                        $entretien->setEcheance(date('Y-m-d'));
                        $entretien->setAnalytique('Entretien');
                        $em->persist($entretien);
                    }
                    else
                    {
                        return $this->redirect($this->generateUrl('bacloocrm_avoirventes', array('vendaid' => $venda->getId(), 'message' => 3)));//Le montant saisi ne doit pas être supérieur au montant ci-dessus.(montant d'origine)
                    }
                }

                //On débite le compte transport 706
                if(isset($transportht) && $transportht > 0 && isset($transportht1))
                {
                    if($transportht <= ($totalht))
                    {
                        $transport = new Afacturer;
                        $transport->setDate($today);
                        $transport->setJournal('VT');
                        if($client->getTypeclient() == 'france')
                        {
                            $transport->setCompte(706210);
                        }
                        elseif($client->getTypeclient() == 'ue')
                        {
                            $transport->setCompte(706211);
                        }
                        elseif($client->getTypeclient() == 'export' or $venda->getSanstva() == 1)
                        {
                            $transport->setCompte(706212);
                        }else{$transport->setCompte(9999999);}
                        $transport->setDebit($transportht);
                        $transport->setCredit(0);
                        $transport->setLibelle($venda->getClient());
                        $transport->setPiece($numavoir);
                        $transport->setEcheance(date('Y-m-d'));
                        $transport->setAnalytique('transport');
                        $em->persist($transport);
                    }
                    else
                    {
                        return $this->redirect($this->generateUrl('bacloocrm_avoirventes', array('vendaid' => $venda->getId(), 'message' => 3)));//Le montant saisi ne doit pas être supérieur au montant ci-dessus.(montant d'origine)
                    }
                }

                //On débite le compte assurance si assurance facturé
                if(isset($assuranceht) && $assuranceht  > 0 && isset($assuranceht1) && $assuranceht <= ($totalht))
                {
                    $fassurance= new Afacturer;
                    $fassurance->setDate($today);
                    $fassurance->setJournal('VT');
                    if($client->getTypeclient() == 'france')
                    {
                        $fassurance->setCompte(706200);
                        $fassurance->setLibelle('Assurance France');
                    }
                    elseif($client->getTypeclient() == 'ue')
                    {
                        $fassurance->setCompte(706201);
                        $fassurance->setLibelle('Assurance UE');
                    }
                    elseif($client->getTypeclient() == 'export' or $venda->getSanstva() == 1)
                    {
                        $fassurance->setCompte(706202);
                        $fassurance->setLibelle('Assurance Export');
                    }
                    $fassurance->setDebit($assuranceht);
                    $fassurance->setCredit(0);
                    $fassurance->setPiece($numavoir);
                    $fassurance->setEcheance(date('Y-m-d', strtotime("+45 days")));
                    $fassurance->setAnalytique('Assurance');
                    $em->persist($fassurance);
                    $em->flush();
                }

                //On débite le compte TVA si client france
                if($client->getTypeclient() == 'france')
                {
                    $ftva = new Afacturer;
                    $ftva->setDate($today);
                    $ftva->setJournal('VT');
                    $ftva->setCompte(445710);
                    $ftva->setDebit($tva);
                    $ftva->setCredit(0);
                    $ftva->setLibelle('TVA collectée');
                    $ftva->setPiece($numavoir);
                    $ftva->setEcheance(date('Y-m-d'));
                    $ftva->setAnalytique('Tva');
                    $em->persist($ftva);
                    $em->flush();
                }

                //On crédite 411
                $afacturer = new Afacturer;
                $afacturer->setDate($today);
                $afacturer->setJournal('VT');
                $afacturer->setCompte($compteclient);
                $afacturer->setDebit(0);
                if($client->getTypeclient() != 'france')
                {
                    $afacturer->setCredit($totalht);
                }
                else
                {
                    $afacturer->setCredit($totalttc);
                }
                $afacturer->setLibelle($venda->getClient());
                $afacturer->setPiece($numavoir);
                $afacturer->setEcheance(date('Y-m-d', strtotime("+45 days")));
                $afacturer->setAnalytique('Client');
                $em->persist($afacturer);

                //Ajout à la table factures
                // $facta = $em->getRepository('BaclooCrmBundle:Facta')
                // ->findOneByControle('1234');
// echo 'uuuuuuuuuuuu';

                $client = $em->getRepository('BaclooCrmBundle:Fiche')
                    ->findOneById($venda->getClientid());
                if($client->getDelaireglement() == 1)
                {
                    $next45 = $venda->getDate();
                }
                elseif($client->getDelaireglement() == 2)
                {
                    $date = date('Y-m-t');
                    $next45 = date('Y-m-d', strtotime($date . '+45 days'));
                }
                elseif($client->getDelaireglement() == 3)
                {
                    $date = date('Y-m-t', strtotime($venda->getDate()));
                    $next45 = date('Y-m-d', strtotime($date . '+30 days'));
                }

                $facture->setNumfacture($numfacture);
                $facture->setCodelocata('V-'.$venda->getId());
                $facture->setClientid($venda->getClientid());
                $facture->setClient($venda->getClient());
                $facture->setTotalht($totalht);
                $facture->setTotalttc($totalttc);
                $facture->setEcheance($next45);
                $facture->setChantier($venda->getClient());
                $facture->setReglement(1);
                $facture->setEncompta(1);
                $facture->setCommentaire($commentaire);
                $facture->setDatepaiement(date('Y-m-d'));
                $facture->setModepaiement('');
                $facture->setTypedoc('avoir');
                $facture->setDatecrea($today);
                $facture->setCompteurfac($lastnumfact);
                $facture->setAnnee(date('y'));
                $facture->setMois(date('m'));
                $facture->setUser($venda->getUser());
                $facture->setLocatacloneid($venda->getId());

                if($new == 1)
                {
                    $facture->addFiche($client);
                    $client->addFacture($facture);
                }

                if($avoirtotal == 1)
                {
                    $facturedor = $em->getRepository('BaclooCrmBundle:Factures')
                        ->findOneByNumfacture($numfacturedor);
                    $facturedor->setReglement(1);
                    $facturedor->setMontantavoir($totalttc);
                    $facturedor->setCommentaire('Facture annulée par l\'avoir n°'.$numavoir);
                    $em->persist($facturedor);
                    $em->flush();
                }
                else
                {echo 'numfacturedor'.$numfacturedor;
                    $facturedor = $em->getRepository('BaclooCrmBundle:Factures')
                        ->findOneByNumfacture($numfacturedor);
                    $facturedor->setMontantavoir($totalttc);
                    $facturedor->setCommentaire('Avoir n°'.$numavoir.' réalisé pour un montant de ttc de '.$totalttc.' €');
                    $em->persist($facturedor);
                    $em->flush();
                }
                $em->persist($facture);
                $em->persist($client);
                $em->flush();
                //Fin ajout table factures
            }
            return $this->redirect($this->generateUrl('bacloocrm_avoirventes', array('vendaid' => $vendaid, 'message' => 2, 'numavoir' => $numavoir, 'numfacture' => $numfacture)));//Avoir enregistré
        }

        if($numavoir == 0)
        {
            $avoirtotal = 0;
            $montantavoirpartiel = 0;
            $commentaire = 0;
        }
        else
        {
            // echo 'numavoir'.$numavoir;
            $avoir = $em->getRepository('BaclooCrmBundle:Factures')
                ->findOneByNumfacture($numavoir);
// echo $avoir->getTotalht();
            $facturedor = $em->getRepository('BaclooCrmBundle:Factures')
                ->findOneBy(array('locatacloneid' => $avoir->getLocatacloneid(), 'typedoc' => 'facture', 'chantier' =>  $avoir->getChantier()));
            if($avoir->getTotalht() == $facturedor->getTotalht())
            {
                $avoirtotal = 1;
                $montantavoirpartiel = $avoir->getTotalht();
                $commentaire = $avoir->getCommentaire();
            }
            else
            {
                $avoirtotal = 0;
                $montantavoirpartiel = $avoir->getTotalht();
                $commentaire = $avoir->getCommentaire();
            }
// echo $commentaire;
// echo $avoirtotal;
        }
        $previous = $this->get('request')->server->get('HTTP_REFERER');
        return $this->render('BaclooCrmBundle:Crm:avoirventes.html.twig', array('form' => $form->createView(),
            'venda' => $venda,
            'message' => $message,
            'previous' => $previous,
            'avoirtotal' => $avoirtotal,
            'montantavoirpartiel' => $montantavoirpartiel,
            'commentaire' => $commentaire,
            'numavoir' => $numavoir,
            'numfacture' => $numfacture,
            'ficheid' => $venda->getClientid(),
            'message' => $message
        ));
    }

    public function proformaAction($codecontrat, $mode, $message)
    {
        $usersess = $this->get('security.context')->getToken()->getUsername();
        $today = date('Y-m-d');
        $em = $this->getDoctrine()->getManager();

        //nous établissons 2 modes : prévisualisation, avanceacompta
        //Prévisualisation : pour un client qui veut une proforma sans paiement d'avanceacompta
        //Prévisualisation : client en paiement d'avance dont les ecritures ont deja été passées
        //avanceacompta : client en paiement d'avance pour lequel il faut passer les écritures
// echo $codecontrat;
        //On regarde dans les factures si deja compta
        $factures = $em->getRepository('BaclooCrmBundle:Factures')
            ->findOneByCodelocata($codecontrat);

        $locata = $em->getRepository('BaclooCrmBundle:Locata')
            ->findOneById($codecontrat);

        //On récupère les infos client
        $client = $em->getRepository('BaclooCrmBundle:Fiche')
            ->findOneById($locata->getClientid());

        if(isset($factures) && $mode == 'previsualisation')
        {
            //Redirection vers la prévisualisation de la facture
            return $this->redirect($this->generateUrl('bacloocrm_ajouterlocationpdf', array('ficheid' => $client->getId(), 'locid' => $codecontrat, 'mode' => 'proforma')));
        }
        elseif(!isset($factures) && $mode == 'previsualisation')
        {
            //Redirection vers la prévisualisation de la facture
            return $this->redirect($this->generateUrl('bacloocrm_ajouterlocationpdf', array('ficheid' => $client->getId(), 'locid' => $codecontrat, 'mode' => 'proforma')));
        }
        elseif(!isset($factures) && $client->getDelaireglement() == 1 && $mode == 'avanceacompta')
        {
            //Passage des écritures et prévisualisation de la facture
            include('facturationcomptantloc.php');
            $message = 1; //Création proforma ok
            return $this->redirect($this->generateUrl('bacloocrm_proforma', array('codecontrat' => $codecontrat, 'mode' => 'all', 'message' => $message, 'date' => $today)));
        }
        return $this->render('BaclooCrmBundle:Crm:proforma.html.twig', array(
            'message' => $message,
            'ficheid' => $client->getId(),
            'locid' => $codecontrat
        ));
    }

    public function impressionfacturesAction($codecontrat, $clientid, $numlocatavente, $mode, $numfacture)
    {
        $em = $this->getDoctrine()->getManager();
        // echo $numlocatavente;
        // echo 'codecontrat'.$codecontrat;
        $clients  = $em->getRepository('BaclooCrmBundle:Fiche')
            ->findOneById($clientid);

        $machines = $em->getRepository('BaclooCrmBundle:Machines')
            ->findAll();

        $machinessl = $em->getRepository('BaclooCrmBundle:Machinessl')
            ->findAll();

        $facture  = $em->getRepository('BaclooCrmBundle:Factures')
            ->findOneById($numfacture);
        $numfacture = $facture->getNumfacture();
        if($numlocatavente[0] == 'V')
        {//echo 'iiiiu';
            // $codelocata = substr($codelocata, 2); //On envlève le V-
            $locata = $em->getRepository('BaclooCrmBundle:Venda')
                ->findOneByid($codecontrat);
            $type = 'vente';

            if($mode == 'avoir')
            {//echo 'ici';
                $facturedor = $em->getRepository('BaclooCrmBundle:Factures')
                    ->findOneBy(array('locatacloneid' => $facture->getLocatacloneid(), 'typedoc' => 'facture', 'chantier' =>  $facture->getChantier()));
            }
            else
            {//echo 'laaaa';
                $facturedor = 0;
            }
        }
        else
        {//echo 'tttt';
            $locata = $em->getRepository('BaclooCrmBundle:Locataclone')
                ->findOneByid($codecontrat);
            $type = 'loc';

            if($mode == 'avoir')
            {//echo 'ici';
                $facturedor = $em->getRepository('BaclooCrmBundle:Factures')
                    // ->findOneByCodelocata($facture->getLocatacloneid());
                    ->findOneBy(array('locatacloneid' => $facture->getLocatacloneid(), 'typedoc' => 'facture', 'chantier' =>  $facture->getChantier()));
            }
            else
            {//echo 'laaaa';
                $facturedor = 0;
            }
        }

        // foreach($machines as $machine)
        // {echo 'ooooooooo';echo $machine->getCode();

        // }
        // $facturesaimprimer = $locata;
        $client = $clients;
        // $em->persist($facta);
        // $em->flush();


        // print_r($facturesaimprimer);
        // foreach($facturesaimprimer as $loca)
        // {//echo 'ooooooooo';
        // echo $loca->getClient();
        // foreach($loca->getLocationsclone() as $loc)
        // {//echo 'xxxxxxxxxxxxxxxxxxxxxxxxx';
        // echo $loc->getTypemachine();
        // }
        // }
        $pdf = $this->get("white_october.tcpdf")->create();
        if($type == 'loc')
        {
            $html = $this->renderView('BaclooCrmBundle:Crm:impression_facturespdf.html.twig', array(
                'locata' => $locata,
                'mode' => $mode,
                'machines' => $machines,
                'machinessl' => $machinessl,
                'numfacture' => $numfacture,
                'facture' => $facture,
                'facturedor' => $facturedor,
                'clients' => $client
            ));
        }
        else
        {
            $html = $this->renderView('BaclooCrmBundle:Crm:impression_facturesventepdf.html.twig', array(
                'locata' => $locata,
                'mode' => $mode,
                'machines' => $machines,
                'machinessl' => $machinessl,
                'numfacture' => $numfacture,
                'facture' => $facture,
                'facturedor' => $facturedor,
                'clients' => $client
            ));

        }
        $pdf->SetFont('helvetica', '', 9, '', true);
        // set margins
        $pdf->SetMargins(13, '10', '5', '0');
        $pdf->AddPage();

        // -- set new background ---

        // get the current page break margin
        $bMargin = $pdf->getBreakMargin();
        // get current auto-page-break mode
        $auto_page_break = $pdf->getAutoPageBreak();
        // disable auto-page-break
        $pdf->SetAutoPageBreak(false, 0);
        // set bacground image
        $img_file = K_PATH_IMAGES.'devistemplate.jpg';
        $pdf->Image($img_file, 0, 0, 210, 297, 'JPG', '', '', false, 300, '', false, false, 0);
        // restore auto-page-break status
        $pdf->SetAutoPageBreak($auto_page_break, $bMargin);
        // set the starting point for the page content
        $pdf->setPageMark();

        $pdf->writeHTML($html, true, false, true, false, '');
        $pdf->lastPage();

        $response = new Response($pdf->Output('file.pdf'));
        $response->headers->set('Content-Type', 'application/pdf');

        return $response;
    }

    public function impressionbdcAction($codecontrat, $clientid, $mode)
    {
        $em = $this->getDoctrine()->getManager();

        $locatafrs = $em->getRepository('BaclooCrmBundle:Locatafrs')
            ->findOneByid($codecontrat);

        // echo 'codecontrat'.$codecontrat;
        $clients  = $em->getRepository('BaclooCrmBundle:Fiche')
            ->findOneById($clientid);


        $pdf = $this->get("white_october.tcpdf")->create();
        if($mode == 'facture')
        {
            $html = $this->renderView('BaclooCrmBundle:Crm:impression_bdc.html.twig', array(
                'locatafrs' => $locatafrs,
                'mode' => 'facture',
                'clients' => $clients
            ));
        }
        else
        {
            $html = $this->renderView('BaclooCrmBundle:Crm:impression_bdc.html.twig', array(
                'locatafrs' => $locatafrs,
                'mode' => 'bdc',
                'clients' => $clients
            ));
        }
        $pdf->SetFont('helvetica', '', 9, '', true);
        // set margins
        $pdf->SetMargins(13, '10', '5', '0');
        $pdf->AddPage();

        // -- set new background ---

        // get the current page break margin
        $bMargin = $pdf->getBreakMargin();
        // get current auto-page-break mode
        $auto_page_break = $pdf->getAutoPageBreak();
        // disable auto-page-break
        $pdf->SetAutoPageBreak(false, 0);
        // set bacground image
        $img_file = K_PATH_IMAGES.'bdctemplate.jpg';
        $pdf->Image($img_file, 0, 0, 210, 297, 'JPG', '', '', false, 300, '', false, false, 0);
        // restore auto-page-break status
        $pdf->SetAutoPageBreak($auto_page_break, $bMargin);
        // set the starting point for the page content
        $pdf->setPageMark();

        $pdf->writeHTML($html, true, false, true, false, '');
        $pdf->lastPage();

        $response = new Response($pdf->Output('file.pdf'));
        $response->headers->set('Content-Type', 'application/pdf');

        return $response;
    }

    public function impressionbdccomptaAction($codecontrat, $clientid, $mode)
    {
        $em = $this->getDoctrine()->getManager();
//echo 'codecontrat'.$codecontrat;echo $mode;
        if($mode == 'contrat')
        {
            $locatafrs = $em->getRepository('BaclooCrmBundle:Locatafrs')
                ->findOneByid($codecontrat);
            $type = 'normal';
        }
        else
        {
            $facture = $em->getRepository('BaclooCrmBundle:Factures')
                ->findOneBy(array('locatacloneid' => $codecontrat, 'typedoc' => 'facture frs'));
//echo 'H'.$facture->getLocatacloneid();	echo '===='.$facture->getCodelocata();
            if('H-'.$facture->getLocatacloneid() == $facture->getCodelocata())
            {//echo 'normal';
                $type = 'normal';
                $locatafrs = $em->getRepository('BaclooCrmBundle:Locatafrs')
                    ->findOneByid($codecontrat);
            }
            else
            {//echo 'clone';
                $type = 'clone';
                $locatafrs = $em->getRepository('BaclooCrmBundle:Locatafrsclone')
                    ->findOneByid($codecontrat);
            }
        }//echo 'type'.$type;
        // echo 'codecontrat'.$codecontrat;
        $clients  = $em->getRepository('BaclooCrmBundle:Fiche')
            ->findOneById($clientid);


        $pdf = $this->get("white_october.tcpdf")->create();

        // $moisdevis = date("m", strtotime($locatafrs->getDatecrea()));
        // $anneedevis = date("Y", strtotime($locatafrs->getDatecrea()));
        // $lastnumbdc = str_pad($facture->getCompteurfac(), 4, "0", STR_PAD_LEFT);

        if($mode != 'contrat')
        {
            $html = $this->renderView('BaclooCrmBundle:Crm:impression_bdccompta.html.twig', array(
                'locatafrs' => $locatafrs,
                'mode' => $mode,
                // 'moisdevis' => $moisdevis,
                // 'anneedevis' => $anneedevis,
                // 'compteurbdc' => $lastnumbdc,
                'clients' => $clients,
                'type' => $type
            ));
        }
        else
        {
            $html = $this->renderView('BaclooCrmBundle:Crm:impression_bdccompta.html.twig', array(
                'locatafrs' => $locatafrs,
                'mode' => 'bdc',
                // 'moisdevis' => $moisdevis,
                // 'anneedevis' => $anneedevis,
                // 'compteurbdc' => $lastnumbdc,
                'clients' => $clients,
                'type' => $type
            ));
        }
        $pdf->SetFont('helvetica', '', 9, '', true);
        // set margins
        $pdf->SetMargins(13, '10', '5', '0');
        $pdf->AddPage();

        // -- set new background ---

        // get the current page break margin
        $bMargin = $pdf->getBreakMargin();
        // get current auto-page-break mode
        $auto_page_break = $pdf->getAutoPageBreak();
        // disable auto-page-break
        $pdf->SetAutoPageBreak(false, 0);
        // set bacground image
        $img_file = K_PATH_IMAGES.'bdctemplate.jpg';
        $pdf->Image($img_file, 0, 0, 210, 297, 'JPG', '', '', false, 300, '', false, false, 0);
        // restore auto-page-break status
        $pdf->SetAutoPageBreak($auto_page_break, $bMargin);
        // set the starting point for the page content
        $pdf->setPageMark();

        $pdf->writeHTML($html, true, false, true, false, '');
        $pdf->lastPage();

        $response = new Response($pdf->Output('file.pdf'));
        $response->headers->set('Content-Type', 'application/pdf');

        return $response;
    }


    public function impressionbdcfacAction($codecontrat, $clientid, $mode)
    {
        $em = $this->getDoctrine()->getManager();

        $locatafrs = $em->getRepository('BaclooCrmBundle:Locatafrsclone')
            ->findOneByid($codecontrat);

        // echo 'codecontrat'.$codecontrat;
        $clients  = $em->getRepository('BaclooCrmBundle:Fiche')
            ->findOneById($clientid);


        $pdf = $this->get("white_october.tcpdf")->create();
        if($mode == 'facture')
        {
            $html = $this->renderView('BaclooCrmBundle:Crm:impression_bdcfac.html.twig', array(
                'locatafrs' => $locatafrs,
                'mode' => 'facture',
                'clients' => $clients
            ));
        }
        else
        {
            $html = $this->renderView('BaclooCrmBundle:Crm:impression_bdcfac.html.twig', array(
                'locatafrs' => $locatafrs,
                'mode' => 'bdc',
                'clients' => $clients
            ));
        }
        $pdf->SetFont('helvetica', '', 9, '', true);
        // set margins
        $pdf->SetMargins(5, '10', '5', '0');
        $pdf->AddPage();

        // -- set new background ---

        // get the current page break margin
        $bMargin = $pdf->getBreakMargin();
        // get current auto-page-break mode
        $auto_page_break = $pdf->getAutoPageBreak();
        // disable auto-page-break
        $pdf->SetAutoPageBreak(false, 0);
        // set bacground image
        $img_file = K_PATH_IMAGES.'bdctemplate.jpg';
        $pdf->Image($img_file, 0, 0, 210, 297, 'JPG', '', '', false, 300, '', false, false, 0);
        // restore auto-page-break status
        $pdf->SetAutoPageBreak($auto_page_break, $bMargin);
        // set the starting point for the page content
        $pdf->setPageMark();

        $pdf->writeHTML($html, true, false, true, false, '');
        $pdf->lastPage();

        $response = new Response($pdf->Output('file.pdf'));
        $response->headers->set('Content-Type', 'application/pdf');

        return $response;
    }

    public function impressiongrilleAction($ficheid, $mode)
    {
        $em = $this->getDoctrine()->getManager();
        if($mode == 'parc')
        {//echo 'ici';
            $grille = $em->getRepository('BaclooCrmBundle:Grille')
                ->findBy(array('codeclient' => $ficheid),array('typemachine' => 'ASC'));
        }
        else
        {//echo 'sl';
            $grille = $em->getRepository('BaclooCrmBundle:Grillesl')
                ->findBy(array('codeclient' => $ficheid),array('id' => 'ASC'));
        }
// print_r($grille);
        $client  = $em->getRepository('BaclooCrmBundle:Fiche')
            ->findOneById($ficheid);
        $annee = date('Y');


        $pdf = $this->get("white_october.tcpdf")->create();
        $html = $this->renderView('BaclooCrmBundle:Crm:impressiongrille.html.twig', array(
            'grille' => $grille,
            'annee' => $annee,
            'client'=> $client
        ));

        $pdf->SetFont('helvetica', '', 9, '', true);
        // set margins
        $pdf->SetMargins(5, '10', '5', '0');
        $pdf->AddPage();

        // -- set new background ---

        // get the current page break margin
        $bMargin = $pdf->getBreakMargin();
        // get current auto-page-break mode
        $auto_page_break = $pdf->getAutoPageBreak();
        // disable auto-page-break
        $pdf->SetAutoPageBreak(false, 0);
        // set bacground image
        $img_file = K_PATH_IMAGES.'grilletemplate.jpg';
        $pdf->Image($img_file, 0, 0, 210, 297, 'JPG', '', '', false, 300, '', false, false, 0);
        // restore auto-page-break status
        $pdf->SetAutoPageBreak($auto_page_break, $bMargin);
        // set the starting point for the page content
        $pdf->setPageMark();

        $pdf->writeHTML($html, true, false, true, false, '');
        $pdf->lastPage();

        $response = new Response($pdf->Output('file.pdf'));
        $response->headers->set('Content-Type', 'application/pdf');

        return $response;
    }


    public function sitewebAction()
    {
        $reponse = 'coco';
        return $this->render('BaclooCrmBundle:Crm:siteweb.html.twig');
    }

    public function modifierfactureAction($ficheid, $locid, $erreur, Request $request)
    {
        $objUser = $this->get('security.context')->getToken()->getUsername(); if(empty($objUser) or !isset($objUser) or $objUser == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        // echo 'erreur'.$erreur;
        // if ($this->container->has('profiler'))
        // {
        // $this->container->get('profiler')->disable();
        // }
        $today = date('Y-m-d');
        $year = date('Y');
        // $erreur = 0;
        $em = $this->getDoctrine()->getManager();//echo 'locid'.$locid;

        $client  = $em->getRepository('BaclooCrmBundle:Fiche')
            ->findOneById($ficheid);
        $fiche = $client;
        $totalht = 0;//echo $locid;
        $totaltrspaller = 0;//echo $locid;
        $totaltrspretour = 0;//echo $locid;
        $contributionverte = 0;//echo $locid;
        $assurance = 0;//echo $locid;
        $montantcarb = 0;

        // On crée un objet Locata
        $locata  = $em->getRepository('BaclooCrmBundle:Locataclone')
            ->findOneById($locid);
        if($client->getAssurance() == 1 && $locata->getAssurance() == 0)
        {
            $locata->setAssurance(0);
            $em->persist($locata);
        }

        $prixcarburant = $locata->getPrixcarb();
        $prixgnr = $locata->getPrixgnr();

        $contrat = $locata->getContrat();
        $bdcrecu = $locata->getBdcrecu();

        if(null == $locata->getChantierid())
        {
            $chantier = $em->getRepository('BaclooCrmBundle:Chantier')
                ->findOneByNom($locata->getNomchantier());

            if(!empty($chantier))
            {
                $chantierid = $chantier->getId();
                $locata->setChantierid($chantierid);
            }
        }
        $em->flush();

        $objUser = $this->get('security.context')->getToken()->getUsername(); if(empty($objUser) or !isset($objUser) or $objUser == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        $em = $this->getDoctrine()->getManager();
        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($objUser);
        $userid = $userdetails->getId();
        $form = $this->createForm(new LocatacloneType(), $locata);
        $today = date('Y-m-d');
        include('societe.php');

        //On met les locations dans un array pour controle ultérieur
        // $listeloc = array();
        // foreach ($locata->getLocationsclone() as $loc) {
        // $listeloc[] = $loc;
        // }

        $em = $this->getDoctrine()->getManager();
        $modules  = $em->getRepository('BaclooCrmBundle:Modules')
            ->findOneByUsername($objUser);
// echo 'WWWWWWWWWWWWWWWWWWWWWWWWW';
        // On récupère la requête
        $request = $this->get('request');
        // On vérifie qu'elle est de type POST
        // echo $request->getMethod();

        if ($request->getMethod() == 'POST')
        {//echo 'YYYYYYYYYYYYYYY';
            $form->bind($request);
            // On vérifie que les valeurs entrées sont correctes
            // $data = $form->getData();

                //Création du numero d'offre unique
                echo 'loooogique';
                //Création du numero de contrat unique
                // $data = $form->getData();
                $facturersamedi = $form->get('facturersamedi')->getData();
                $facturerdimanche = $form->get('facturerdimanche')->getData();
                $facturationferies = $form->get('facturationferies')->getData();
                if($facturersamedi == 1)
                {
                    $locata->setFacturersamedi(1);
                }
                elseif($facturersamedi == 0)
                {

                    $locata->setFacturersamedi(0);
                }
                if($facturerdimanche == 1)
                {
                    $locata->setFacturerdimanche(1);
                }
                elseif($facturerdimanche == 0)
                {
                    $locata->setFacturerdimanche(0);
                }

                $rempli = 0;
                foreach($form->get('locationsclone')->getData() as $loc)
                {
                    if(null !== $loc->getCodemachine())
                    {
                        $rempli++;
                    }
                }
                foreach($form->get('locationsslclone')->getData() as $loc)
                {
                    if(null !== $loc->getCodemachine())
                    {
                        $rempli++;
                    }
                }




                // $debutloc = $form->get('debutloc')->getData();
                // $finloc = $form->get('finloc')->getData();
                $entreprise = $form->get('client')->getData();
                $nomchantier = $form->get('nomchantier')->getData();
                $adresse1 = $form->get('adresse1')->getData();
                $adresse2 = $form->get('adresse2')->getData();
                $adresse3 = $form->get('adresse3')->getData();
                $cp = $form->get('cp')->getData();
                $ville = $form->get('ville')->getData();
                $bdcrecu = $form->get('bdcrecu')->getData();
                $contrat = $form->get('contrat')->getData();
                $offreencours = $form->get('offreencours')->getData();
                $refusee = $form->get('offrerefusee')->getData();
                $locations = $form->get('locationsclone')->getData();


                $em->persist($locata);
                $em->flush();

                //Mise à jour de la table chantier si le chantier n'existe pas
                $chantier = $em->getRepository('BaclooCrmBundle:Chantier')
                    ->findOneByNom($nomchantier);
                if(empty($chantier))
                {
                    $newchantier = new Chantier;
                    $newchantier->setNom($nomchantier);
                    $newchantier->setAdresse1($adresse1);
                    $newchantier->setAdresse2($adresse2);
                    $newchantier->setAdresse3($adresse3);
                    $newchantier->setCp($cp);
                    $newchantier->setVille($ville);
                    $em->persist($newchantier);
                    // $em->flush();
                }
                //Fin maj chantier

                //FACTURATION

                //Création du montant HT ligne par ligne
                $totalht = 0;//echo $locid;
                $totaltrspaller = 0;
                $totaltrspretour = 0;
                $contributionverte = 0;
                $montantcarb1 = 0;
                $assurance = 0;

                //Calcul totalht locations parc
                foreach($form->get('locationsclone')->getData() as $loc)
                {
                    $nbjlocadeduire = 0;
                    $nbjloc = 0;
                    $nbjlocass = 0;
                    $debutloc = $loc->getDebutloc();//echo $debutloc;
                    $finloc = $loc->getFinloc();//echo $finloc;
                    $dStart = $debutloc;
                    $dEnd = $finloc;

                    //mettre le if sur debutloc ou finloc et si <= date du jour >>>> redirect !
                    if($debutloc <= $today && $loc->getEtatloc() != 'Location terminée')
                    {
                        $this->redirect($request->server->get('HTTP_REFERER'));
                    }
                    // fin redirect
                    //1.Récupérer les données de la table Machines

                    //2.On génère les entêtes de colonnes à partir de la fonction createplanning
                    $iStart = strtotime ($dStart);//Formate une date/heure locale avec la Something is wronguration locale
                    $iEnd = strtotime ($dEnd);
                    if (false === $iStart || false === $iEnd) {
                        // return false;
                    }
                    $aStart = explode ('-', $dStart);
                    $aEnd = explode ('-', $dEnd);
                    if (count ($aStart) !== 3 || count ($aEnd) !== 3) {
                        // return false;
                    }
                    // if (false === checkdate ($aStart[1], $aStart[2], $aStart[0]) || false === checkdate ($aEnd[1], $aEnd[2], $aEnd[0]) || $iEnd <= $iStart) {
                    // return false;
                    // }

                    $jour50 = $loc->getJour50();
                    $jour100 = $loc->getJour100();

                    $aDates = array();
                    for ($i = $iStart; $i <= $iEnd; $i = $i + 86400 ) {
                        $sDateToArr = strftime ('%Y-%m-%d', $i);
                        $sYear = substr ($sDateToArr, 0, 4);
                        $sMonth = substr ($sDateToArr, 5, 2);
                        $aDates[] = $sDateToArr;
                    }

                    //on calcule le nombre de jours de location
                    $feries = $this->getHolidays($year);
                    foreach($aDates as $dat)
                    {
                        $time = strtotime($dat);
                        $newformat = date('D',strtotime($dat));
                        // echo $dat;
                        //Calcul nb jours fériés
                        $i = 0;
                        foreach($feries as $fer)
                        {
                            if(date('m-d', $fer) == date('m-d', $time))
                            {
                                if($newformat !== 'Sat' and $newformat !== 'Sun')
                                {//echo 'grrr'.$dat;echo 'fuck'.$newformat;echo 'ladate'.date('D',strtotime($dat));echo 'newformat'.$newformat;
                                    $i++;
                                }
                            }
                        }
                        //Facturation WE ou pas
                        $newformat = date('D',$time);

                        if($facturersamedi == 1 && $newformat == 'Sat')
                        {
                            $nbjloc++;
                        }
                        elseif($facturerdimanche == 1 && $newformat == 'Sun')
                        {
                            $nbjloc++;
                        }
                        elseif($newformat == 'Sat' or $newformat == 'Sun')
                        {}
                        else
                        {////echo '== ajout';
                            $nbjloc++;
                        }
                        if($facturationferies == 0)
                        {
                            $nbjloc = $nbjloc-$i;
                        }
                    }


                    //nb jour pour les assurances car 7/7
                    foreach($aDates as $dat)
                    {
                        $nbjlocass++;
                    }
                    $jour50 = $loc->getJour50();
                    $jour100 = $loc->getJour100();

                    if(isset($jour50))
                    {
                        $nbjlocadeduire += $jour50*0.5;//nb jours corrigé
                    }
                    if(isset($jour100))
                    {
                        $nbjlocadeduire += $jour100;//nb jours corrigé
                    }
// echo $nbjloc;
                    $nbjloc += $nbjlocadeduire;
                    $nbjlocass += $nbjlocadeduire;
// echo '***';
// echo $nbjlocadeduire;
// echo 'HHHHH'.$nbjloc;
                    if(null !== $loc->getLoyerp1())
                    {
                        $loyer = $loc->getLoyerp1();
                        if($loc->getRemise() > 0)
                        {
                            $loyer = $loyer - ($loyer*($loc->getRemise()/100));
                        }
                        $totalht += $nbjloc * $loyer;
                        $totalhtloc = $nbjloc * $loyer;
                        $totalhtlocass = $nbjlocass * $loyer;
                    }
                    elseif(null !== $loc->getLoyerp2())
                    {
                        $loyer = $loc->getLoyerp2();
                        if($loc->getRemise() > 0)
                        {
                            $loyer = $loyer - ($loyer*($loc->getRemise()/100));
                        }
                        $totalht += $nbjloc * $loyer;
                        $totalhtloc = $nbjloc * $loyer;
                        $totalhtlocass = $nbjlocass * $loyer;
                    }
                    elseif(null !== $loc->getLoyerp3())
                    {
                        $loyer = $loc->getLoyerp3();
                        if($loc->getRemise() > 0)
                        {
                            $loyer = $loyer - ($loyer*($loc->getRemise()/100));
                        }
                        $totalht += $nbjloc * $loyer;
                        $totalhtloc = $nbjloc * $loyer;
                        $totalhtlocass = $nbjlocass * $loyer;
                    }
                    elseif(null !== $loc->getLoyerp4())
                    {
                        $loyer = $loc->getLoyerp4();
                        if($loc->getRemise() > 0)
                        {
                            $loyer = $loyer - ($loyer*($loc->getRemise()/100));
                        }
                        $totalht += $nbjloc * $loyer;
                        $totalhtloc = $nbjloc * $loyer;
                        $totalhtlocass = $nbjlocass * $loyer;
                    }
                    elseif(null !== $loc->getLoyermensuel())
                    {
                        include('calculnbjlocmensuellemodiffac.php');	echo 'nbjloc'.$nbjloc;
                        $loyer = $loc->getLoyermensuel()/20;
                        if($loc->getRemise() > 0)
                        {
                            $loyer = $loyer - ($loyer*($loc->getRemise()/100));
                        }
                        $nbjloc = $nbjloc + $nbjlocadeduire;
                        $totalht += $loyer * $nbjloc;
                        $totalhtloc = $loyer * $nbjloc;
                        $totalhtlocass = ($loyer) * $nbjlocass;
                    }
                    if(!isset($loyer))
                    {
                        $loyer = 0;
                        $totalht += $loyer * $nbjloc;
                        $totalhtloc = $loyer * $nbjloc;
                        $totalhtlocass = ($loyer) * $nbjlocass;
                    }
                    echo 'loyer';echo $loyer;
                    $totaltrspaller += $loc->getTransportaller();
                    $totaltrspretour += $loc->getTransportretour();

                    if($loc->getContributionverte() == 1)
                    {
                        $contributionverte += 0.0215 * $loyer * $nbjloc;
                    }

                    if($loc->getAssurance() == 1)
                    {
                        $assurance += $totalhtlocass*0.10;
                    }echo 'nbjlocjm'.$nbjloc;
                    if($loc->getEnergie() == 'GNR' or $loc->getEnergie() == 'hybride')
                    {
                        $prixcarburant = $prixgnr;
                    }
                    $montantcarb1 += $loc->getLitrescarb()*$prixcarburant;
                    $loc->setMontantcarb($loc->getLitrescarb()*$prixcarburant);
                    $loc->setMontantloc($totalhtloc);echo 'nbjlocjm3'.$nbjloc;
                    $loc->setNbjloc($nbjloc);
                    $loc->setNbjlocass($nbjlocass);
                    $em->persist($loc);
                    $em->flush();
                }

                //Calcul total ht sous loc
                foreach ($form->get('locationsslclone')->getData() as $loc)
                {	//echo 'yyyyyyyyyy';
                    $nbjlocadeduire = 0;
                    $nbjloc = 0;
                    $nbjlocass = 0;
                    $debutloc = $loc->getDebutloc();//echo $debutloc;
                    $finloc = $loc->getFinloc();//echo $finloc;
                    $dStart = $debutloc;
                    $dEnd = $finloc;
                    echo 'DSTART'.$dStart;
                    echo 'dEnd'.$dEnd;
                    //mettre le if sur debutloc ou finloc et si <= date du jour >>>> redirect !
                    if($debutloc <= $today && $loc->getEtatloc() != 'Location terminée')
                    {
                        $this->redirect($request->server->get('HTTP_REFERER'));
                    }
                    // fin redirect
                    //1.Récupérer les données de la table Machines

                    //2.On génère les entêtes de colonnes à partir de la fonction createplanning
                    $iStart = strtotime ($dStart);//Formate une date/heure locale avec la Something is wronguration locale
                    $iEnd = strtotime ($dEnd);
                    if (false === $iStart || false === $iEnd) {
                        // return false;
                    }
                    $aStart = explode ('-', $dStart);
                    $aEnd = explode ('-', $dEnd);
                    if (count ($aStart) !== 3 || count ($aEnd) !== 3) {
                        // return false;
                    }
                    // if (false === checkdate ($aStart[1], $aStart[2], $aStart[0]) || false === checkdate ($aEnd[1], $aEnd[2], $aEnd[0]) || $iEnd <= $iStart) {
                    // return false;
                    // }

                    $jour50 = $loc->getJour50();
                    $jour100 = $loc->getJour100();

                    $aDates = array();
                    for ($i = $iStart; $i <= $iEnd; $i = $i + 86400 ) {
                        $sDateToArr = strftime ('%Y-%m-%d', $i);
                        $sYear = substr ($sDateToArr, 0, 4);
                        $sMonth = substr ($sDateToArr, 5, 2);

                        if(strftime ('%Y-%m-%d', $i) != strftime ('%Y-%m-%d', $i + 86400))
                        {
                            $aDates[] = $sDateToArr;//echo '>>'.$sDateToArr;
                        }
                    }

                    $feries = $this->getHolidays($year);
                    foreach($aDates as $dat)
                    {	//echo $dat;
                        $time = strtotime($dat);
                        $newformat = date('D',strtotime($dat));
                        // echo $dat;
                        //Calcul nb jours fériés
                        $i = 0;
                        foreach($feries as $fer)
                        {
                            if(date('m-d', $fer) == date('m-d', $time))
                            {
                                if($newformat !== 'Sat' and $newformat !== 'Sun')
                                {//echo 'grrr'.$dat;echo 'fuck'.$newformat;echo 'ladate'.date('D',strtotime($dat));echo 'newformat'.$newformat;
                                    $i++;
                                }
                            }
                        }
                        //Facturation WE ou pas
                        $newformat = date('D',$time);

                        if($facturersamedi == 1 && $newformat == 'Sat')
                        {
                            $nbjloc++;
                        }
                        elseif($facturerdimanche == 1 && $newformat == 'Sun')
                        {
                            $nbjloc++;
                        }
                        elseif($newformat == 'Sat' or $newformat == 'Sun')
                        {}
                        else
                        {////echo '== ajout';
                            $nbjloc++;
                        }
                        if($facturationferies == 0)
                        {
                            $nbjloc = $nbjloc-$i;
                        }
                        $nbjlocass++;
                    }
                    if($loc->getLoyermensuel()>0)
                    {echo 'LOYER MENSUEL';
                        if($nbjloc < 20)
                        {
                            $loyer = $loc->getLoyermensuel()/20;
                            if($loc->getRemise() > 0)
                            {
                                $loyer = $loyer - ($loyer*($loc->getRemise()/100));
                            }
                        }
                        else
                        {
                            $nbjloc = 20;
                            $loyer = ($loc->getLoyermensuel()/20);
                            if($loc->getRemise() > 0)
                            {
                                $loyer = $loyer - ($loyer*($loc->getRemise()/100));
                            }
                        }
                    }
                    echo '$nbjlocass'.$nbjlocass;
                    $jour50 = $loc->getJour50();
                    $jour100 = $loc->getJour100();
                    if(isset($jour50))
                    {
                        $nbjlocadeduire += $jour50*0.5;//nb jours corrigé
                    }
                    if(isset($jour100))
                    {
                        $nbjlocadeduire += $jour100;//nb jours corrigé
                    }
                    echo 'nbjloc'.$nbjloc;
                    $nbjloc += $nbjlocadeduire;
                    $nbjlocass += $nbjlocadeduire;
                    echo '***';
                    echo $nbjlocadeduire;
                    echo 'HHHHH'.$nbjloc;
                    $totalhtloc = 0;
                    if(null !== $loc->getLoyerp1())
                    {
                        $loyer = $loc->getLoyerp1();
                        if($loc->getRemise() > 0)
                        {
                            $loyer = $loyer - ($loyer*($loc->getRemise()/100));
                        }
                        $totalht += $nbjloc * $loyer;
                        $totalhtloc = $nbjloc * $loyer;
                        $totalhtlocass = $nbjlocass * $loyer;
                    }
                    elseif(null !== $loc->getLoyerp2())
                    {
                        $loyer = $loc->getLoyerp2();
                        if($loc->getRemise() > 0)
                        {
                            $loyer = $loyer - ($loyer*($loc->getRemise()/100));
                        }
                        $totalht += $nbjloc * $loyer;
                        $totalhtloc = $nbjloc * $loyer;
                        $totalhtlocass = $nbjlocass * $loyer;
                    }
                    elseif(null !== $loc->getLoyerp3())
                    {
                        $loyer = $loc->getLoyerp3();
                        if($loc->getRemise() > 0)
                        {
                            $loyer = $loyer - ($loyer*($loc->getRemise()/100));
                        }
                        $totalht += $nbjloc * $loyer;
                        $totalhtloc = $nbjloc * $loyer;
                        $totalhtlocass = $nbjlocass * $loyer;
                    }
                    elseif(null !== $loc->getLoyerp4())
                    {
                        $loyer = $loc->getLoyerp4();
                        if($loc->getRemise() > 0)
                        {
                            $loyer = $loyer - ($loyer*($loc->getRemise()/100));
                        }
                        $totalht += $nbjloc * $loyer;
                        $totalhtloc = $nbjloc * $loyer;
                        $totalhtlocass = $nbjlocass * $loyer;
                    }
                    elseif(null !== $loc->getLoyermensuel())
                    {
                        include('calculnbjlocmensuellemodiffac.php');	echo 'nbjloc'.$nbjloc;
                        $loyer = $loc->getLoyermensuel()/20;
                        if($loc->getRemise() > 0)
                        {
                            $loyer = $loyer - ($loyer*($loc->getRemise()/100));
                        }
                        $nbjloc = $nbjloc + $nbjlocadeduire;
                        $totalht += $loyer * $nbjloc;
                        $totalhtloc = $loyer * $nbjloc;
                        $totalhtlocass = ($loyer) * $nbjlocass;
                    }

                    //echo '$totalhtlocass1'.$totalhtlocass;	echo 'nbjlocmensuelded'.$nbjloc;echo 'nbjlocadeduire'.$nbjlocadeduire;
                    $totaltrspaller += $loc->getTransportaller();
                    $totaltrspretour += $loc->getTransportretour();

                    if($loc->getContributionverte() == 1)
                    {
                        $contributionverte += 0.0215 * $loyer * $nbjloc;
                    }

                    if($loc->getAssurance() == 1)
                    {
                        $assurance += $totalhtlocass*0.10;
                    }
                    if($loc->getEnergie() == 'GNR' or $loc->getEnergie() == 'hybride')
                    {
                        $prixcarburant = $prixgnr;
                    }
                    $montantcarb1 += $loc->getLitrescarb()*$prixcarburant;
                    $loc->setMontantcarb($loc->getLitrescarb()*$prixcarburant);
                    $loc->setMontantloc($totalhtloc);
                    $loc->setNbjloc($nbjloc);
                    $loc->setNbjlocass($nbjlocass);
                    $em->persist($loc);
                    $em->flush();
                }

                $montantvente = 0;
                $totalvente = 0;
                foreach($form->get('locataventesclone')->getData() as $ven)
                {
                    $montantvente = $ven->getQuantite() * $ven->getPu();
                    $totalvente += $ven->getQuantite() * $ven->getPu();

                    $ven->setMontantvente($montantvente);
                    $em->persist($ven);
                    $em->flush();
                }

                // if($locata->getRemise() > 0)
                // {
                // $totalht = $totalht - ($totalht * $locata->getRemise()/100);
                // }
// echo $totalht;

                $locata->setTransportaller($totaltrspaller);
                $locata->setTransportretour($totaltrspretour);
                $locata->setAssurance($assurance);
                $locata->setContributionverte($contributionverte);
                $locata->setMontantlocavente($totalvente);
                $locata->setMontantloc($totalht);
                $facture  = $em->getRepository('BaclooCrmBundle:Factures')
                    ->findOneBy(array('codelocata'=>$locata->getOldid(), 'locatacloneid'=> $locata->getId(), 'typedoc'=> 'facture'));
                echo ' CARB '.$montantcarb;
                $totalhtfac = $totalht + $locata->getTransportaller() + $locata->getTransportretour() + $locata->getAssurance() + $contributionverte + $montantcarb1 + $totalvente - ($totalht*$locata->getRemise()/100);
                echo 'TOTALHTFACT'.$totalhtfac;
                $facture->setTotalht($totalhtfac);
                if($client->getTypeclient() == 'export')
                {
                    $facture->setTotalttc($totalhtfac);
                }
                else
                {
                    $facture->setTotalttc($totalhtfac * 1.2);
                }
                $locata->setMontantloc($totalht);
                $locata->setMontantcarb($montantcarb1);
                if($locata->getAlerte() == 'oui')
                {
                    $facture->setAlerte(1);
                }
                else
                {
                    $facture->setAlerte(0);
                }
                //$locata->setContributionverte($contributionverte);
                $locata->setDatemodif($facture->getDatecrea());
                $em->persist($locata);
                $em->persist($facture);
                $em->flush();
                //FIN FACTURATION
//echo 'rrrrrrrrrrrrrr';
                //MAJ de la table machine lorsqu'on reçoit un BDC pour réserver


//                if($contrat == 1 && $offreencours == 1)
//                {
//                    // echo 'contrat ok offre ok';
//                    echo ' TOTALHTDDDd'.$totalht;
//                    $locata  = $em->getRepository('BaclooCrmBundle:Locataclone')
//                        ->findOneById($locata->getId());
//                    // $totalht = 0;
//                    $montantcarb = 0;
//                    //$contributionverte = 0;
//                    if(null !== $locata->getLocationsclone())
//                    {
//// echo 'xxx';echo $loc->getId().'-';echo $nbjloc;echo 'xxx';
//
//                        //Partie locations parc
//                        foreach ($locata->getLocationsclone() as $loc)
//                        {
//                            $jour50 = $loc->getJour50();
//                            $jour100 = $loc->getJour100();
//                            if($loc->getEtatloc() != 'Location terminée')
//                            {
//                                //Insertion du code location à la machine
//                                $codelocations = $loc->getId();//echo $codelocations;
//                                $debutloc = $loc->getDebutloc();
//                                $finloc = $loc->getFinloc();
//                                // echo $codelocationssl;
//                                //On vérifie si une becane est déjà réservée sur cet ecode
//                                $locations = $em->getRepository('BaclooCrmBundle:Locations')
//                                    ->findOneById($codelocations);
//                                if(isset($locations) && null == $locations->getCodemachineinterne())
//                                {
//                                    $debutlocok = date('Y-m-d', strtotime($debutloc . ' -1 day'));
//                                    $finlocok = date('Y-m-d', strtotime($finloc . ' +1 day'));
//                                    $machin = $em->getRepository('BaclooCrmBundle:Machines')
//                                        ->unedispo($loc->getCodemachine(),$debutlocok, $finlocok);
//                                    if(!empty($machin))
//                                    {
//                                        foreach($machin as $mach)
//                                        {
//                                            $code = $mach['code'];
//                                            $etat = $mach['etat'];
//                                            $energie = $mach['energie'];
//                                            $machineid = $mach['id'];
//                                            $machinedef = $em->getRepository('BaclooCrmBundle:Machines')
//                                                ->dispoprecisenot($loc->getCodemachine(),$debutlocok, $finlocok);
//
//                                            if($etat == 'Disponible')
//                                            {
//                                                break;
//                                            }
//                                        }
//                                        if(empty($code))
//                                        {
//                                            foreach($machin as $mach)
//                                            {
//                                                $code = $mach['code'];
//                                                $etat = $mach['etat'];
//                                                $energie = $mach['energie'];
//                                                $machineid = $mach['id'];
//                                                $machinedef = $em->getRepository('BaclooCrmBundle:Machines')
//                                                    ->dispoprecisenot($code, $debutlocok, $finlocok);
//
//                                                if(empty($machinedef))
//                                                {
//                                                    break;
//                                                }
//                                            }
//                                        }
//
//                                        //MAJ table Locations suite réservation
//                                        $resaloc = $em->getRepository('BaclooCrmBundle:Locations')
//                                            ->findOneById($codelocations);
//                                        $resaloc->setEtatloc('Réservé');
//                                        $resaloc->setCodemachineinterne($code);
//                                        $resaloc->setEnergie($energie);
//                                        $resaloc->setMachineid($machineid);
//                                        $em->persist($resaloc);
//                                        $em->flush();
//
//                                        if(empty($machinedef))
//                                        {
//                                            break;
//                                        }
//                                    }
//                                }
//                                else
//                                {}
//                            }
//                            $montantcarb += $loc->getMontantcarb();
//                            foreach ($locata->getLocationsclone() as $loc)
//                            {
//                                if($loc->getCodemachineinterne() == '' OR $loc->getCodemachineinterne() == NULL )
//                                {//echo 'iciiiiiiii';
//                                    $locata->setContrat(0);
//                                    $em->persist($locata);
//                                    $em->flush();
//                                    //return $this->redirect($this->generateUrl('bacloocrm_ajouterlocation', array('ficheid' => $ficheid, 'locid' => $locid, 'erreur' => 2 )));
//                                }
//                                else
//                                {
//                                    //echo 'laaaaaaaaaaaaaa';
//                                }
//                            }
//                            $montantloclocatafrs = 0;
//                            foreach ($locata->getLocationsclone() as $loc)
//                            {
//                                //Insertion du code location à la machine
//                                $codelocationssl = $loc->getId();
//                                // echo $codelocationssl;
//
//                                if($loc->getEtatlog() == 'Livré chez le client' or $loc->getEtatlog() == 'Déposé en agence')
//                                {}
//                                else
//                                {
//
//                                }
//                                // $em->persist($loc);
//                                // $em->flush();
//                                $montantlocactu = 0;
//                                $nbjlocadeduire = 0;
//                                //On récupère le loyer
//                                if(null !== $loc->getLoyerp1())
//                                {
//                                    $loyer = $loc->getLoyerp1();
//                                }
//                                elseif(null !== $loc->getLoyerp2())
//                                {
//                                    $loyer = $loc->getLoyerp2();
//                                }
//                                elseif(null !== $loc->getLoyerp3())
//                                {
//                                    $loyer = $loc->getLoyerp3();
//                                }
//                                elseif(null !== $loc->getLoyerp4())
//                                {
//                                    $loyer = $loc->getLoyerp4();
//                                }
//                                elseif(null !== $loc->getLoyermensuel())
//                                {echo 'BIEN LA';
//                                    // $nbjloc = $loc->getNbjloc();
//                                    // include('calculnbjlocmensuellemodiffac.php');echo 'NBJLOCO contrat '.$nbjloc;
//                                    $loyer = $loc->getLoyermensuel()/20;
//
//                                }
//                                if($jour50 != 0)
//                                {
//                                    $nbjlocadeduire += $jour50*0.5;//nb jours corrigé
//                                }
//                                if($jour100 != 0)
//                                {
//                                    $nbjlocadeduire += $jour100;//nb jours corrigé
//
//                                }	//??
//                                $montantlocactu = $loyer * ($nbjloc + $nbjlocadeduire);
//                                //$loc->setMontantloc($montantlocactu);
//                                // $loc->setNbjloc($nbjloc + $nbjlocadeduire);
//                                $em->persist($loc);
//                                $em->flush();
//                                echo ' CARBLOC '.$montantcarb;
//                                $nbjloc += $nbjlocadeduire;
//                                $nbjlocass += $nbjlocadeduire;
//                                // $totalht += $nbjloc * $loyer;
//                                if($loc->getContributionverte() == 1)
//                                {
//                                    //$contributionverte += ($nbjlocass*$loyer)*0.0215;
//
//                                }
//
//                            }
//                        }
//                    }
//                    //Partie sous-locations
//
//                    foreach ($locata->getLocationsslclone() as $loc)
//                    {//echo 'laaaaaaaaxxx';
//                        $jour50 = $loc->getJour50();
//                        $jour100 = $loc->getJour100();
//                        $machine = $em->getRepository('BaclooCrmBundle:Machinessl')
//                            ->findOneBy(array('codegenerique'=> $loc->getCodemachine(), 'loueur'=> $loc->getLoueur()));
//
//// echo 'ZZZZZZZZZZZZZZZZZZZ';
//                        $debutloc = $loc->getDebutloc();
//                        $finloc = $loc->getFinloc();
//                        // On crée un objet Locatasl
//                        if(empty($machine) && $loc->getTransport() == 1)
//                        {
//                            //return $this->redirect($this->generateUrl('bacloocrm_ajouterlocation', array('ficheid' => $ficheid, 'locid' => $locid, 'erreur' => 1 )));
//                        }
//                        if(null == $loc->getCodemachineinterne())
//                        {
//                            $nbdemachines = 0;
//                            foreach ($locata->getLocationsslclone() as $loc)
//                            {
//                                if($loc->getTransport() == 1)
//                                {
//                                    $nbdemachines++;
//                                }
//                            }
//
//                            $nbmachinesdispo = 0;
//                            foreach ($locata->getLocationsslclone() as $loc)
//                            {
//                                //Insertion du code location à la machine
//                                $codelocations = $loc->getId();
//                                // echo $codelocations;
//                                if($loc->getTransport() == 1)
//                                {
//
//                                    $machine = $em->getRepository('BaclooCrmBundle:Machinessl')
//                                        ->findOneBy(array('codegenerique'=> $loc->getCodemachine(), 'loueur'=> $loc->getLoueur()));
//
//                                    // On crée un objet Locatasl
//                                    if(!empty($machine))
//                                    {
//                                        $nbmachinesdispo++;
//                                    }
//                                }
//                            }
//                            // echo 'XXXXXXXXXXXXXX';
//                            // echo 'nbdemachines'.$nbdemachines;
//                            // echo 'nbmachinesdispo'.$nbmachinesdispo;
//                            if($nbdemachines != $nbmachinesdispo)
//                            {
//                                $em->clear();
//                                //return $this->redirect($this->generateUrl('bacloocrm_ajouterlocation', array('ficheid' => $ficheid, 'locid' => $locid, 'erreur' => 1 )));
//                            }
//
//                            foreach ($locata->getLocationsslclone() as $loc)
//                            {
//                                //Insertion du code location à la machine
//                                $codelocations = $loc->getId();
//                                // echo $codelocations;
//                                $debutloc = $loc->getDebutloc();
//                                $finloc = $loc->getFinloc();
//                                $debutlocok = date('Y-m-d', strtotime($debutloc . ' -1 day'));
//                                $finlocok = date('Y-m-d', strtotime($finloc . ' +1 day'));
//                                $machin = $em->getRepository('BaclooCrmBundle:Machinessl')
//                                    ->unedispo($loc->getCodemachine(),$debutloc, $finloc, $loc->getLoueur());
//
//                                if(!empty($machin))
//
//                                {echo 'yyyy';
//
//
//                                    foreach($machin as $mach)
//                                    {
//                                        $code = $mach['code'];
//                                        $etat = $mach['etat'];
//                                        $energie = $mach['energie'];
//                                        $machineid = $mach['id'];
//                                        $machinedef = $em->getRepository('BaclooCrmBundle:Machinessl')
//                                            ->dispoprecisenot($loc->getCodemachine(),$debutlocok, $finlocok, $loc->getLoueur());
//
//                                        if($etat == 'Disponible')
//                                        {
//                                            break;
//                                        }
//                                    }
//
//                                    if(empty($code))
//                                    {echo '333';
//                                        foreach($machin as $mach)
//                                        {
//                                            $code = $mach['code'];
//                                            $etat = $mach['etat'];
//                                            $energie = $mach['energie'];
//                                            $machineid = $mach['id'];
//                                            $machinedef = $em->getRepository('BaclooCrmBundle:Machinessl')
//                                                ->dispoprecisenot($code, $debutlocok, $finlocok, $loc->getLoueur());
//
//                                            if(empty($machinedef))
//                                            {
//                                                break;
//                                            }
//                                        }
//                                    }
//                                    //MAJ table Locations suite réservation
//                                    $resaloc = $em->getRepository('BaclooCrmBundle:Locationssl')
//                                        ->findOneById($codelocations);
////                                    $resaloc->setEtatloc('Réservé');
//                                    if(!isset($code))
//                                    {
//                                        //return $this->redirect($this->generateUrl('bacloocrm_ajouterlocation', array('ficheid' => $ficheid, 'locid' => $locid, 'erreur' => 7 )));
//                                    }
//                                    else
//                                    {
//                                        $resaloc->setCodemachineinterne($code);
//                                    }
////                                    $resaloc->setEnergie($energie);
////                                    $resaloc->setMachineid($machineid);
//                                    $em->persist($resaloc);
//                                    $em->flush();
//
//                                }
//                                else
//                                {echo 'ajouuuuuuuuuuuuuuuuuuuuut2';echo $loc->getCodemachineinterne();
//                                    if(null == $loc->getCodemachineinterne())
//                                    {
//                                        //return $this->redirect($this->generateUrl('bacloocrm_ajouterlocation', array('ficheid' => $ficheid, 'locid' => $locid, 'erreur' => 2 )));
//                                    }
//                                }
//                            }
//                        }
//
//                        //Faire un if pour le cas d'un refus de l'offre alors qu'un BDC a été émis
//                        //Il faut donc supprimer la machine réservée en fonction du codelocation et du code origine
//                        if(isset($refusee) && $refusee == 1)
//                        {
//                            $machine = $em->getRepository('BaclooCrmBundle:Machinessl')
//                                ->findOneBy(array('code'=> $code, 'codelocations' => $codelocations));
//                            //Si machine originale on fait un update
//
//                            $refusloc = $em->getRepository('BaclooCrmBundle:Locationssl')
//                                ->findOneById($codelocations);
//                            $refusloc->setEtatloc('Refusé');$refusloc->setEtatlog('Refusé');
//                            $em->persist($refusloc);
//                            $em->flush();
//
//
//                        }
//                    }
//
//
//                    foreach ($locata->getLocationsslclone() as $loc)
//                    {
//                        if($loc->getCodemachineinterne() == '' OR $loc->getCodemachineinterne() == NULL )
//                        {//echo 'iciiiiiiii';
//                            $locata->setContrat(0);
//                            $em->persist($locata);
//                            $em->flush();
//                            //return $this->redirect($this->generateUrl('bacloocrm_ajouterlocation', array('ficheid' => $ficheid, 'locid' => $locid, 'erreur' => 2 )));
//                        }
//                        else
//                        {
//                            //echo 'laaaaaaaaaaaaaa';
//                        }
//                    }
//                    $montantloclocatafrs = 0;
//                    foreach ($locata->getLocationsslclone() as $loc)
//                    {
//                        //Insertion du code location à la machine
//                        $codelocationssl = $loc->getId();
//                        // echo $codelocationssl;
//
//                        if($loc->getEtatlog() == 'Livré chez le client' or $loc->getEtatlog() == 'Déposé en agence')
//                        {}
//                        else
//                        {
//
//                        }
//                        // $em->persist($loc);
//                        // $em->flush();
//                        $montantlocactu = 0;
//                        $nbjlocadeduire = 0;
//                        //On récupère le loyer
//                        if(null !== $loc->getLoyerp1())
//                        {
//                            $loyer = $loc->getLoyerp1();
//                        }
//                        elseif(null !== $loc->getLoyerp2())
//                        {
//                            $loyer = $loc->getLoyerp2();
//                        }
//                        elseif(null !== $loc->getLoyerp3())
//                        {
//                            $loyer = $loc->getLoyerp3();
//                        }
//                        elseif(null !== $loc->getLoyerp4())
//                        {
//                            $loyer = $loc->getLoyerp4();
//                        }
//                        elseif(null !== $loc->getLoyermensuel())
//                        {
//                            $nbjloc = $loc->getNbjloc();
//                            include('calculnbjlocmensuelle.php');
//                            $loyer = $loc->getLoyermensuel()/20;
//
//                        }echo 'AAAAAAAAAAAAA';echo $jour100;
//                        if($jour50 != 0)
//                        {
//                            $nbjlocadeduire += $jour50*0.5;//nb jours corrigé
//                        }
//                        if($jour100 != 0)
//                        {echo 'JOUR100X'.$jour100;
//                            $nbjlocadeduire += $jour100;//nb jours corrigé
//
//                        }
//                        echo 'LOCADEDUIRE'.$nbjlocadeduire;$a = $nbjloc + $nbjlocadeduire; echo 'aaaaaaaaaaaaaaa'.$a;
//                        // $nbjloc = $loc->getNbjloc();	//??
//                        $montantlocactu = $loyer * ($nbjloc + $nbjlocadeduire);
//                        $montantcarb += $loc->getMontantcarb();
//                        //$loc->setMontantloc($montantlocactu);
//                        // $loc->setNbjloc($nbjloc + $nbjlocadeduire);
//                        $em->persist($loc);
//                        $em->flush();
//
//                        $nbjloc += $nbjlocadeduire;echo 'NBJLOCDER'.$nbjloc;
//                        $nbjlocass += $nbjlocadeduire;
//                        //$totalht += $nbjloc * $loyer;
//                        if($loc->getContributionverte() == 1)
//                        {
//                            //$contributionverte += ($nbjlocass*$loyer)*0.0215;
//
//                        }
//
//                    }echo 'assurance'.$locata->getAssurance();
//                    $facture  = $em->getRepository('BaclooCrmBundle:Factures')
//                        ->findOneBy(array('locatacloneid'=> $locata->getId(), 'typedoc'=> 'facture'));
//                    echo ' CARB '.$montantcarb;
//                    $totalhtfac = $totalht + $locata->getTransportaller() + $locata->getTransportretour() + $locata->getAssurance() + $contributionverte + $montantcarb + $totalvente - ($totalht*$locata->getRemise()/100);
//                    echo 'TOTALHTFACT'.$totalhtfac;
//                    $facture->setTotalht($totalhtfac);
//                    if($client->getTypeclient() == 'export')
//                    {
//                        $facture->setTotalttc($totalhtfac);
//                    }
//                    else
//                    {
//                        $facture->setTotalttc($totalhtfac * 1.2);
//                    }
//                    $locata->setMontantloc($totalht);
//                    $locata->setMontantcarb($montantcarb);
//                    if($locata->getAlerte() == 'oui')
//                    {
//                        $facture->setAlerte(1);
//                    }
//                    else
//                    {
//                        $facture->setAlerte(0);
//                    }
//                    //$locata->setContributionverte($contributionverte);
//                    $em->persist($locata);
//                    $em->persist($facture);
//                    $em->flush();
//                }echo 'zzzzzzzzzzz'.$contributionverte	;
//                if(isset($refusee) && $refusee == 1 && $offreencours == 1)
//                {
//                    foreach ($locata->getLocationsclone() as $loc)
//                    {
//                        //Insertion du code location à la machine
//                        $codelocations = $loc->getId();
//                        $debutloc = $loc->getDebutloc();
//                        $finloc = $loc->getFinloc();
//                        $code = $loc->getCodemachineinterne();
//                        // echo $codelocations;
//                    }
//                    foreach ($locata->getLocationsslclone() as $loc)
//                    {
//                        //Insertion du code location à la machine
//                        $codelocations = $loc->getId();
//                        $debutloc = $loc->getDebutloc();
//                        $finloc = $loc->getFinloc();
//                        $code = $loc->getCodemachineinterne();
//                        // echo $codelocations;
//
//                        $refusloc = $em->getRepository('BaclooCrmBundle:Locationssl')
//                            ->findOneById($codelocations);
//                        $refusloc->setEtatloc('Refusé');$refusloc->setEtatlog('Refusé');
//                        $refusloc->setContrat(0);
//                        $em->persist($refusloc);
//                        // $em->flush();
//                    }
//                }
                // echo 'ttttt';echo $locid;
                $em->persist($locata);
                $em->flush();
                //Fin maj table machine
                // $em = $this->getDoctrine()->getManager();
                if($locid == 0)
                {
                    $result = $em->getRepository('BaclooCrmBundle:Locataclone')
                        ->findOneBy(array('clientid' => $client->getId(), 'datemodif' => $today, 'nomchantier' => $nomchantier, 'user' => $objUser), array('id' => 'DESC'));

                    $locid = $result->getId();
                }
                if(!isset($erreur)){$erreur = 0;}
                // On redirige vers la page de visualisation de la fiche nouvellement créée
                return $this->redirect($this->generateUrl('bacloocrm_modifierfacture', array('ficheid' => $ficheid, 'locid' => $locid, 'erreur' => $erreur)));

        }
        $listedispos = array();
        if($locid > 0)
        {//echo 'laaa';
            $grille  = $em->getRepository('BaclooCrmBundle:Grille')
                ->findByCodeclient($locata->getClientid());

            $factures = $em->getRepository('BaclooCrmBundle:Factures')
                ->findOneBy(array('locatacloneid'=> $locid, 'typedoc'=> 'facture'));

            $totalht = $locata->getMontantloc();
            $assurance = $locata->getAssurance();
            $contributionverte = $locata->getContributionverte();
            $montantcarb = $locata->getMontantcarb();
            $montantvente = 0;
            $totalvente = 0;
            foreach($locata->getLocataventesclone() as $ven)
            {
                $montantvente = $ven->getQuantite() * $ven->getPu();
                $totalvente += $ven->getQuantite() * $ven->getPu();
                // $em->flush();
            }
        }
        else
        {//echo 'ici';
            $totalht = 0;
            $nbjloc = 0;
            $nbjlocass = 0;
            $totalvente = 0;
            $grille = array();
        }//echo 'TOTALHTAAAa'.$totalht;

        $factures = $em->getRepository('BaclooCrmBundle:Factures')
            ->findOneByCodelocata($locid);
        if(isset($factures)){$afac = 'ok';}else{$afac = 'nok';}
        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($objUser);
        $roleuser = $userdetails->getRoleuser();
        // echo $grille;

        //On regarde dans les factures si deja compta
        if(isset($factures))
        {
            $proforma = 'ok';
        }
        else
        {
            if($client->getDelaireglement() == 1)
            {
                $proforma = 'nok';
            }
            else
            {
                $proforma = 'ok';
            }

        }
// echo 'totalhtfacFIN'.$facture->getTotalht();echo 'bumfact'.$facture->getNumfacture();
        return $this->render('BaclooCrmBundle:Crm:modifier_facture.html.twig', array('form' => $form->createView(),
            'date' => $today,
            'roleuser' => $roleuser,
            'client' => $client,
            'contrat' => $contrat,
            'bdcrecu' => $bdcrecu,
            'usersociete' => $societe,
            'modules' => $modules,
            'listedispos' => $listedispos,
            'entreprise' => $client->getRaisonSociale(),
            'id' => $ficheid,
            'erreur' => $erreur,
            'locid' => $locid,
            'totalht' => $totalht,
            'montantlocavente' => $totalvente,
            'assurance' => $assurance,
            'contributionverte' => $contributionverte,
            'montantcarb' => $montantcarb,
            'grille' => $grille,
            'afac' => $afac,
            'proforma' => $proforma,
            'user' => $objUser));
    }

    public function removefactureAction($numfacture, $locatacloneid, $type)
    {
        $em = $this->getDoctrine()->getManager();
        $previous = $this->get('request')->server->get('HTTP_REFERER');

        $facture  = $em->getRepository('BaclooCrmBundle:Factures')
            ->findOneByNumfacture($numfacture);
        if($type == 'location')
        {
            $locataclone  = $em->getRepository('BaclooCrmBundle:Locataclone')
                ->findOneById($locatacloneid);

            $locata = $em->getRepository('BaclooCrmBundle:Locataclone')
                ->findOneById($facture->getCodelocata());
            if(isset($locataclone))
            {
                $locatadorigineid = $locataclone->getOldid();

                foreach($locataclone->getLocationsclone() as $loca)
                {
                    $locationsid = $loca->getOldid();
                    $locations = $em->getRepository('BaclooCrmBundle:Locations')
                        ->findOneById($locationsid);
                    $locations->setCloture(0);
                    $em->persist($locations);
                    $em->remove($loca);
                    $em->flush();
                }

                foreach($locataclone->getLocationsslclone() as $locas)
                {
                    $locationsid = $locas->getOldid();
                    $locations = $em->getRepository('BaclooCrmBundle:Locationssl')
                        ->findOneById($locationsid);
                    $locations->setCloture(0);
                    $em->persist($locations);
                    $em->remove($locas);
                    $em->flush();
                }
                $em->remove($locataclone);

                $afacturer  = $em->getRepository('BaclooCrmBundle:Afacturer')
                    ->findByPiece($numfacture);
                if(isset($afacturer))
                {
                    foreach($afacturer as $afac)
                    {
                        $em->remove($afac);
                        $em->flush();
                    }
                }
            }
        }
        elseif($type == 'vente')
        {echo 'vente';echo $locatacloneid;
            $venda  = $em->getRepository('BaclooCrmBundle:Venda')
                ->findOneById($locatacloneid);

            if(isset($venda))
            {
                $venda->setBdcrecu(0);
                $em->persist($venda);
                $em->flush();

                $afacturer  = $em->getRepository('BaclooCrmBundle:Afacturer')
                    ->findByPiece($numfacture);
                if(isset($afacturer))
                {
                    foreach($afacturer as $afac)
                    {
                        $em->remove($afac);
                        $em->flush();
                    }
                }
            }
        }
        $facture->setClientid(0);
        $facture->setClient('Erreur logiciel');
        $facture->setEcheance('');
        $facture->setDatepaiement('');
        $facture->setTotalht(0);
        $facture->setTotalttc(0);
        $facture->setEncompta(0);
        $facture->setCodelocata(0);
        $facture->setLocatacloneid(0);
        $facture->setReglement(1);
        $facture->setMontantdejareg(0);
        $em->persist($facture);
        $em->flush();
        return $this->redirect($this->generateUrl('bacloocrm_compta', array('vue' => 'locations')));
    }

    public function removefacturedefAction($numfacture, $locatacloneid, $type)
    {
        $em = $this->getDoctrine()->getManager();
        $previous = $this->get('request')->server->get('HTTP_REFERER');

        $facture  = $em->getRepository('BaclooCrmBundle:Factures')
            ->findOneById($numfacture);
        $mode = $facture->getTypedoc();
        if($type == 'location')
        {
            $locataclone  = $em->getRepository('BaclooCrmBundle:Locataclone')
                ->findOneById($locatacloneid);
            if(isset($locataclone))
            {
                $locatadorigineid = $locataclone->getOldid();

                $locatadorigine  = $em->getRepository('BaclooCrmBundle:Locata')
                    ->findOneById($locatadorigineid);

                foreach($locataclone->getLocationsclone() as $loca)
                {
                    $em->remove($loca);
                    // $em->flush();
                }

                foreach($locatadorigine->getLocations() as $locat)
                {
                    $locationsid = $locat->getId();
                    $locations = $em->getRepository('BaclooCrmBundle:Locations')
                        ->findOneById($locationsid);
                    $locations->setCloture(0);
                    $em->persist($locations);
                }

                foreach($locataclone->getLocationsslclone() as $locas)
                {
                    $em->remove($locas);
                    // $em->flush();
                }

                foreach($locatadorigine->getLocationssl() as $locast)
                {
                    $locationsid = $locast->getId();echo 'LOCATIONSID '.$locationsid;
                    $locations = $em->getRepository('BaclooCrmBundle:Locationssl')
                        ->findOneById($locationsid);
                    $locations->setCloture(0);
                    $em->persist($locations);
                }
                $em->remove($locataclone);
                $afacturer  = $em->getRepository('BaclooCrmBundle:Afacturer')
                    ->findByPiece($numfacture);
                if(isset($afacturer))
                {
                    foreach($afacturer as $afac)
                    {
                        $em->remove($afac);
                        $em->flush();
                    }
                }
            }
            $em->remove($facture);
            $em->remove($locataclone);
            $em->flush();
        }
        elseif($type == 'vente')
        {echo 'vente';echo $locatacloneid;
            $venda  = $em->getRepository('BaclooCrmBundle:Venda')
                ->findOneById($locatacloneid);

            if(isset($venda))
            {
                $venda->setBdcrecu(0);
                $em->persist($venda);
                $em->flush();

                $afacturer  = $em->getRepository('BaclooCrmBundle:Afacturer')
                    ->findByPiece($numfacture);
                if(isset($afacturer))
                {
                    foreach($afacturer as $afac)
                    {
                        $em->remove($afac);
                        $em->flush();
                    }
                }
            }
            $em->remove($facture);
            $em->flush();
        }
        elseif($facture->getTypedoc() == 'facture frs')
        {
            if($facture->getAchatsimple() == 1)
            {
                $locatadorigineid = $facture->getLocatacloneid();

                $locatadorigine  = $em->getRepository('BaclooCrmBundle:Locatafrs')
                    ->findOneById($locatadorigineid);

                $locatadorigine->setEtatbdc(0);
                $em->persist($locatadorigine);
                foreach($locatadorigine->getLocationsfrs() as $locat)
                {//echo 'fait la cloture';
                    $locationsid = $locat->getId();
                    $locationsfrs = $em->getRepository('BaclooCrmBundle:Locationsfrs')
                        ->findOneById($locationsid);
                    $locationsfrs->setCloture(0);
                    $em->persist($locationsfrs);
                }
                $afacturer  = $em->getRepository('BaclooCrmBundle:Afacturer')
                    ->findByPiece($facture->getNumfacfrs());
                if(isset($afacturer))
                {
                    foreach($afacturer as $afac)
                    {
                        $em->remove($afac);
                        $em->flush();
                    }
                }
                $em->remove($facture);
                $em->flush();
            }
            else
            {
                $locatafrsclone  = $em->getRepository('BaclooCrmBundle:Locatafrsclone')
                    ->findOneById($locatacloneid);
                if(isset($locatafrsclone))
                {
                    $locatadorigineid = $locatafrsclone->getOldid();

                    $locatadorigine  = $em->getRepository('BaclooCrmBundle:Locatafrs')
                        ->findOneById($locatadorigineid);

                    foreach($locatafrsclone->getLocationsfrsclone() as $loca)
                    {
                        $em->remove($loca);
                        // $em->flush();
                    }

                    foreach($locatadorigine->getLocationsfrs() as $locat)
                    {echo 'fait la cloture';
                        $locationsid = $locat->getId();
                        $locationsfrs = $em->getRepository('BaclooCrmBundle:Locationsfrs')
                            ->findOneById($locationsid);
                        $locationsfrs->setCloture(0);
                        $em->persist($locationsfrs);
                    }

                    $em->remove($locatafrsclone);
//                    $afacturer  = $em->getRepository('BaclooCrmBundle:Afacturer')
//                        ->findByPiece($facture->getNumfacfrs());
//                    if(isset($afacturer))
//                    {
//                        foreach($afacturer as $afac)
//                        {
//                            $em->remove($afac);
//                            $em->flush();
//                        }
//                    }
                    $em->remove($locatafrsclone);
                }
            }

            $em->remove($facture);
            $em->flush();
        }
        elseif($facture->getTypedoc() == 'avoir frs')
        {

            $afacturer  = $em->getRepository('BaclooCrmBundle:Afacturer')
                ->findByPiece($facture->getNumfacfrs());
            if(isset($afacturer))
            {
                foreach($afacturer as $afac)
                {
                    $em->remove($afac);
                    $em->flush();
                }
            }

            $facturedorigine  = $em->getRepository('BaclooCrmBundle:Factures')
                ->findOneByLocatacloneid($locatacloneid);
            $facturedorigine->setMontantavoir(0);
            $facturedorigine->setReglement(0);

            $em->persist($facturedorigine);
            $em->remove($facture);
            $em->flush();
        }
        if($mode == 'facture')
        {echo 'ici'.$mode;
            return $this->redirect($this->generateUrl('bacloocrm_compta', array('vue' => 'locations')));
        }
        else
        {echo 'laaa'.$mode;
            return $this->redirect($this->generateUrl('bacloocrm_compta', array('vue' => 'achats')));
        }
    }

    public function recupfactureAction($numfacture, $locatacloneid, $vue, $mode, $page, Request $request)
    {
        $em = $this->getDoctrine()->getManager();
        $previous = $this->get('request')->server->get('HTTP_REFERER');

        $facture  = $em->getRepository('BaclooCrmBundle:Factures')
            ->findOneByNumfacture($numfacture);

        $codelocata = $facture->getCodelocata();
        if($codelocata[0] == 'V')
        {
            $typefact = 'vente';
        }
        else
        {
            $typefact = 'location';
        }

        $afacturer = $em->getRepository('BaclooCrmBundle:Afacturer')
            ->findByPiece($locatacloneid);
        if(empty($afacturer))
        {
            $afacturer  = $em->getRepository('BaclooCrmBundle:Afacturer')
                ->findByPiece($numfacture);
        }

        $locataclone  = $em->getRepository('BaclooCrmBundle:Locataclone')
            ->findOneById($locatacloneid);

        // $locatadorigineid = $locataclone->getOldid();

        foreach($afacturer as $afact)
        {
            // echo 'id afact'; echo $afact->getId();
            $afactu = $em->getRepository('BaclooCrmBundle:Afacturer')
                ->findOneById($afact->getId());

            $em->remove($afactu);
        }

        if($typefact == 'location')
        {
            foreach($locataclone->getLocationsclone() as $locas)
            {
                $locas->setDef(0);
                // $em->persist($locas);
            }

            foreach($locataclone->getLocationsslclone() as $locass)
            {
                $locass->setDef(0);
                // $em->persist($locass);
            }
        }
        $facture->setEncompta(0);
        // $em->persist($facture());
        $em->flush();
        return $this->redirect($this->generateUrl('bacloocrm_compta', array('vue' => 'locations', 'mode' => $mode, 'page' => $page)));

    }


    public function recupfacturefrsAction($numfacture, $locatacloneid, $vue, $mode, $page, Request $request)
    {
        $em = $this->getDoctrine()->getManager();
        $previous = $this->get('request')->server->get('HTTP_REFERER');

        $facture  = $em->getRepository('BaclooCrmBundle:Factures')
            ->findOneById($numfacture);

        $codelocata = $facture->getCodelocata();
        if($codelocata == 'H-'.$facture->getLocatacloneid())
        {
            $typefact = 'achat simple';
        }
        else
        {
            $typefact = 'achat recurrent';
        }

        $afacturer = $em->getRepository('BaclooCrmBundle:Afacturer')
            ->findByPiece($locatacloneid);
        if(empty($afacturer))
        {
            $afacturer  = $em->getRepository('BaclooCrmBundle:Afacturer')
                ->findByPiece($facture->getNumfacfrs());
        }

        $locataclone  = $em->getRepository('BaclooCrmBundle:Locatafrsclone')
            ->findOneById($locatacloneid);

        // $locatadorigineid = $locataclone->getOldid();

        foreach($afacturer as $afact)
        {
            // echo 'id afact'; echo $afact->getId();
            $afactu = $em->getRepository('BaclooCrmBundle:Afacturer')
                ->findOneById($afact->getId());

            $em->remove($afactu);
        }

        if($typefact == 'achat recurrent')
        {
            foreach($locataclone->getLocationsfrsclone() as $locas)
            {
                $locas->setDef(0);
                // $em->persist($locas);
            }

//            foreach($locataclone->getLocationsfrs() as $locass)
//            {
//                $locass->setDef(0);
//                // $em->persist($locass);
//            }
        }
        $facture->setEncompta(0);
        // $em->persist($facture());
        $em->flush();
        return $this->redirect($this->generateUrl('bacloocrm_compta', array('vue' => 'achats', 'mode' => $mode, 'page' => $page)));
    }

    public function remettreenlocAction($locataid, $ecode)
    {
        $em = $this->getDoctrine()->getManager();
        $previous = $this->get('request')->server->get('HTTP_REFERER');

        $locata  = $em->getRepository('BaclooCrmBundle:Locata')
            ->findOneById($locataid);
        $erreur = 0;
        foreach($locata->getLocations() as $loca)
        {//echo 'location';echo $loca->getCodemachineinterne();
            if($loca->getCodemachineinterne() == $ecode)
            {
                $loca->setEtatloc('En location');
                $loca->setEtatlog('Livré chez le client');
                $loca->setCloture(0);

                $machines = $em->getRepository('BaclooCrmBundle:Machines')
                    ->findOneBy(array('code' => $loca->getCodemachineinterne(), 'original' => 1));

                if(isset($machines))
                {
                    echo ' LA MACHINE'.$machines->getCode();
                    $machines->setCodelocations($loca->getId());
                    $machines->setCodecontrat($locataid);
                    $machines->setClientid($loca->getCodeclient());
                    $machines->setEntreprise($loca->getEntreprise());
                    $machines->setNomchantier($locata->getNomchantier());
                    $machines->setDebutloc($loca->getDebutloc());
                    $machines->setFinloc($loca->getFinloc());
                    $machines->setEtat('En location');
                    $machines->setEtatlog('Livré chez le client');
                    $em->persist($machines);
                    $em->persist($loca);

                    $locationsclone = $em->getRepository('BaclooCrmBundle:Locationsclone')
                        ->findBy(array('oldid' => $loca->getId()));
                    if(isset($locationsclone))
                    {
                        foreach($locationsclone as $loco)
                        {
                            $loco->setEtatloc('En location');
                            $loco->setCloture(0);
                            $em->persist($loco);
                        }
                    }
                    $logistique  = $em->getRepository('BaclooCrmBundle:Logistiquerep')
                        ->findOneBy(array('codelocations' => $loca->getId(), 'codecontrat' => $locataid, 'materiel' => $ecode));
                    if(isset($logistique))
                    {
                        $em->remove($logistique);
                    }
                    $em->flush();
                }
                else
                {
                    $erreur = 8;
                }
            }
        }

        foreach($locata->getLocationssl() as $loca)
        {
            if($loca->getCodemachineinterne() == $ecode)
            {
                $loca->setEtatloc('En location');
                $loca->setEtatlog('Livré chez le client');
                $loca->setCloture(0);

                $machines  = $em->getRepository('BaclooCrmBundle:Machinessl')
                    ->findOneBy(array('code' => $loca->getCodemachineinterne(), 'original' => 1));
                if(!isset($machine))
                {
                    $machines = new Machinessl;
                }
                $machines->setCode($loca->getCodemachineinterne());
                $machines->setCodegenerique($loca->getCodemachine());
                $machines->setDescription($loca->getTypemachine());
                $machines->setDebutloc($loca->getDebutloc());
                $machines->setFinloc($loca->getFinloc());
                $machines->setEtat('En location');
                $machines->setEntreprise($locata->getClient());
                $machines->setNomchantier($locata->getNomchantier());
                $machines->setcodelocations($loca->getId());
                $machines->setcodecontrat($locata->getId());
                $machines->setClientid($locata->getClientid());
                $machines->setLoueur($loca->getLoueur());
                $machines->setOriginal(1);

                $em->persist($loca);
                $em->persist($machines);
                $em->flush();

                $loca->setMachineid($machines->getId());
                $em->persist($loca);
                $em->flush();

                $locationsslclone = $em->getRepository('BaclooCrmBundle:Locationsslclone')
                    ->findBy(array('oldid' => $loca->getId()));
                if(isset($locationsslclone))
                {
                    foreach($locationsslclone as $loco)
                    {
                        $loco->setEtatloc('En location');
                        $loco->setCloture(0);
                        $em->persist($loco);
                    }
                }
                $logistique  = $em->getRepository('BaclooCrmBundle:Logistiquerep')
                    ->findOneBy(array('codelocations' => $loca->getId(), 'codecontrat' => $locataid, 'materiel' => $ecode));
                if(isset($logistique))
                {
                    $em->remove($logistique);
                }
                $em->flush();
            }
        }

        $fiche = $em->getRepository('BaclooCrmBundle:Fiche')
            ->findOneById($locata->getClientid());

        return $this->redirect($this->generateUrl('bacloocrm_ajouterlocation', array('ficheid' => $fiche->getId(), 'locid' => $locataid, 'erreur' => $erreur)));

    }

    public function removebdcAction($numfacture, $locatacloneid)
    {//$id = id ligne partenaire
        $em = $this->getDoctrine()->getManager();
        $previous = $this->get('request')->server->get('HTTP_REFERER');

        $facture  = $em->getRepository('BaclooCrmBundle:Factures')
            ->findOneByNumfacture($numfacture);

        $locatafrsclone  = $em->getRepository('BaclooCrmBundle:Locatafrsclone')
            ->findOneById($locatacloneid);

        foreach($locatafrsclone->getLocationsfrsclone() as $loca)
        {
            $locationsid = $loca->getOldid();
            $locations = $em->getRepository('BaclooCrmBundle:Locationsfrs')
                ->findOneById($locationsid);
            $locations->setCloture(0);
            $em->remove($loca);
        }
        $em->remove($facture);
        $em->remove($locatafrsclone);
        $em->flush();
        return $this->redirect($this->generateUrl('bacloocrm_compta', array('vue' => 'achats')));
    }

    public function removebdcficheAction($locid)
    {//$id = id ligne partenaire
        $em = $this->getDoctrine()->getManager();

        $locatafrs = $em->getRepository('BaclooCrmBundle:Locatafrs')
            ->findOneById($locid);

        $ficheid = $locatafrs->getFournisseurid();
        foreach($locatafrs->getLocationsfrs() as $loca)
        {
            $em->remove($loca);
        }
        $em->remove($locatafrs);
        $em->flush();
        return $this->redirect($this->generateUrl('bacloocrm_voir', array('id' => $ficheid)));
    }

    public function requete1achatAction(Request $request)
    {
        $search = $request->get('search');
        if(!empty($search))
        {
            $em = $this->getDoctrine()->getManager();
            $query = $em->createQuery(
                'SELECT f
					FROM BaclooCrmBundle:Articlesenvente f
					WHERE f.designation LIKE :designation'
            );
            $query->setParameter('designation', '%'.$search.'%');
            $result = $query->getArrayResult();

            // Transformer le tableau associatif en un tableau standard
            $array = array();
            foreach ($result as $data) {
                $array[] = array("value"=>$data['prixdachat'],"label"=>$data['designation'],"id"=>$data['reffrs']);
            }
        }
        $response = new Response(json_encode($array));
        return $response;
    }

    public function requete2achatAction(Request $request)
    {
        $search = $request->get('search');
        if(!empty($search))
        {
            $em = $this->getDoctrine()->getManager();
            $query = $em->createQuery(
                'SELECT f
					FROM BaclooCrmBundle:Articlesenvente f
					WHERE f.reffrs LIKE :reffrs'
            );
            $query->setParameter('reffrs', '%'.$search.'%');
            $result = $query->getArrayResult();

            // Transformer le tableau associatif en un tableau standard
            $array = array();
            foreach ($result as $data) {
                $array[] = array("value"=>$data['prixdachat'],"label"=>$data['reffrs'],"id"=>$data['designation']);
            }
        }
        $response = new Response(json_encode($array));
        return $response;
    }

    public function statfiAction($dStart, $dEnd, Request $request)
    {
        $defaultData = array();
        // $dStart = 0;
        // $dEnd = 0;
        $form = $this->createFormBuilder($defaultData)
            ->add('du', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => false,
                'attr' => array('class' => 'date'),
            ))
            ->add('au', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => false,
                'attr' => array('class' => 'date'),
            ))
            ->getForm();
        if($request->getMethod() == 'POST') {//echo 'VALIDE';
            $form->handleRequest($request);
            $data = $form->getData();//var_dump($data);
            if(isset($data['du']))
            {
                $dStart = $data['du'];
            }
            if(isset($data['au']))
            {
                $dEnd = $data['au'];
            }
            return $this->redirect($this->generateUrl('bacloocrm_statsvendeurs', array('dstart' => $dStart, 'dend' => $dEnd)));
        }
// echo 'dend '.$dEnd;
        if($dStart == 0)
        {
            $dStart = date('Y-m-d', strtotime("-6 months"));
        }

        if($dEnd == 0)
        {
            $dEnd = date('Y-m-d');
        }
// echo $dStart;
        // $dEnd = '2018-11-30';

        //1.Récupérer les données de la table Faccture
        $em = $this->getDoctrine()->getManager();

        $today = date('Y-m-d');
        $prev12 = date('Y-m-d', strtotime("-12 months"));
        $ca  = $em->getRepository('BaclooCrmBundle:Factures')
            ->last12mca3($dStart, $dEnd);

        $canr = $em->getRepository('BaclooCrmBundle:Factures')
            ->last12mcanr2($dStart, $dEnd);

        $catf= $em->getRepository('BaclooCrmBundle:Factures')
            ->last12mcatf($dStart, $dEnd);
        // print_r($catf);
        $caavoirs = $em->getRepository('BaclooCrmBundle:Factures')
            ->last12mavoirs($dStart, $dEnd);

        $caloc = $em->getRepository('BaclooCrmBundle:Locataclone')
            ->caloc($dStart, $dEnd);

        $catransport = $em->getRepository('BaclooCrmBundle:Locataclone')
            ->catransport($dStart, $dEnd);

        $cacontributionverte = $em->getRepository('BaclooCrmBundle:Locataclone')
            ->cacontributionverte($dStart, $dEnd);

        $caassurance = $em->getRepository('BaclooCrmBundle:Locataclone')
            ->caassurance($dStart, $dEnd);

        $cacarburant = $em->getRepository('BaclooCrmBundle:Locataclone')
            ->cacarburant($dStart, $dEnd);

        $calocavente = $em->getRepository('BaclooCrmBundle:Locataclone')
            ->calocavente($dStart, $dEnd);

        $cavente = $em->getRepository('BaclooCrmBundle:Factures')
            ->cavente($dStart, $dEnd);

        $statachats = $em->getRepository('BaclooCrmBundle:Locatafrs')
            ->statachats($dStart, $dEnd);
// echo '$$$$$$'.print_r($ca);	echo '<<<<<';
        //2.On génère les entêtes de colonnes à partir de la fonction createplanning
        $iStart = strtotime ($dStart);//Formate une date/heure locale avec la Something is wronguration locale
        $iEnd = strtotime ($dEnd);
        if (false === $iStart || false === $iEnd) {
            // return false;
        }
        $aStart = explode ('-', $dStart);
        $aEnd = explode ('-', $dEnd);
        if (count ($aStart) !== 3 || count ($aEnd) !== 3) {
            // return false;
        }
        // if (false === checkdate ($aStart[1], $aStart[2], $aStart[0]) || false === checkdate ($aEnd[1], $aEnd[2], $aEnd[0]) || $iEnd <= $iStart) {
        // return false;
        // }
        for ($i = $iStart; $i < $iEnd + 86400; $i = strtotime ('+1 day', $i) ) {
            $sDateToArr = strftime ('%Y-%m-%d', $i);
            $sYear = substr ($sDateToArr, 0, 4);
            $sMonth = substr ($sDateToArr, 5, 2);
            $aDates[$sYear][$sMonth][] = $sDateToArr;
        }

        $nbannee = 0;
        $nbmoisparannee = 0;
        //Calcule le nombre de jours dans le mois
        $annee1 = date("Y", strtotime($dStart));
        $anneef = date("Y", strtotime($dStart));
        $anneefin = $anneef + 1;

        //Boucle parcours tableau année, mois, jours.
        //Celle-ci renvoie le nombre de  jours du premier mois m1
        $m11 = 1;
        foreach($aDates as $annee => $moiss)
        {
            foreach($moiss as $date => $mois)
            {
                if($m11 == 1)//si on est en m1 on procède sinon break
                {
                    foreach($mois as $dat)
                    {
                        $m11++;
                    }
                }
                else
                {
                    break;
                }
            }

        }
        $m1 = $m11-1;
        //Calcul du nb total de mois $m
        $m = 0;
        foreach($aDates as $annee => $moiss)
        {
            foreach($moiss as $date => $mois)
            {
                $m++;
            }

        }

        //Calcul du nb total d'années $a
        $an = 0;
        foreach($aDates as $annee => $moiss)
        {
            $an++;
        }
// echo $m;
        //Celle-ci renvoie le nombre de jours du dernier mois mm
        $mm = 0;
        $compteurm = 1;
        foreach($aDates as $annee => $moiss)
        {
            foreach($moiss as $date => $mois)
            {
                if($compteurm == $m)//si on est le dernier mois
                {
                    foreach($mois as $dat)
                    {
                        $mm++;
                    }
                }
                else
                {}
                $compteurm++;
            }

        }

        //Celle-ci renvoie le nombre de jours de la première année $a1
        $a11 = 1;
        foreach($aDates as $annee => $moiss)
        {
            if($a11 == 1)//si on est en a1 on procède sinon break
            {
                foreach($moiss as $date => $mois)
                {
                    foreach($mois as $dat)
                    {
                        $a11++;
                    }
                }
            }
            else
            {
                break;
            }
        }
        $a1 = $a11-1;
        //Fonction qui calcule le nombre de jours dans l'année
        function cal_days_in_year($year){
            $days=0;
            for($month=1;$month<=12;$month++){
                $days = $days + cal_days_in_month(CAL_GREGORIAN,$month,$year);
            }
            return $days;
        }
        //Celle-ci renvoie le nombre de jours de la dernière année $aa
        $aa = 0;
        $compteura = 1;//echo '$an'.$an;
        foreach($aDates as $annee => $moiss)
        {
            if($compteura == $an)//si on est en end ernière année on calcule le nb de jours $aa
            {
                foreach($moiss as $date => $mois)
                {
                    foreach($mois as $dat)
                    {
                        $aa++;
                    }
                }
            }
            elseif($compteura > $an)
            {
                break;
            }
            $compteura++;
        }//echo 'aa'.$aa;echo 'compteura'.$compteura;
        // echo 'www'.$mm.'www';
        // $mm = 0; //Compteur de mois qui s'incrémente de 1 afin de faire un compte indépendant des mois.
        $nbjrparmois = 0;
        $i = 1; //Compteur pour premier mois
        $a = 1; //Compteur pour la première année
        $nbmois = array();
        $nbjannee = array();
        foreach($aDates as $annee => $moiss)
        {
            //Calculer le nombre d'années
            // echo $annee;
            if($a == 1)//Si on est en première année
            {
                $nbjannee[] = $a1;//nb de jours de la première année
            }
            elseif($a == $an)
            {
                $nbjannee[] = $aa;
            }
            else
            {
                $nbjannee[] = cal_days_in_year($annee);
            }
            foreach($moiss as $date => $mois)
            {
                if($i == 1)//on est au premier mois
                {
                    //nb jours mois courant
                    $nbmois[] = $m1;
                }
                elseif($i == $m)//Si on est  le dernier mois de la période on met le nb de jours
                {
                    //nb de jours du dernier mois
                    $nbmois[] = $mm;
                }
                else
                {
                    //Pour les autres mois
                    $nbmois[] = cal_days_in_month(CAL_GREGORIAN, $date, $annee);
                }
                $i++;
            }
            $a++;
        }
// partie calcul ca loc
        $dEnda = date('Y-m-d');
        $dEnda2 = date('Y-m-t');
        // $dStart = '2018-10-31';
        $dStarta = date('Y-m-d', strtotime("-20 days"));
        $dStarta2 = date('Y-m-01');
        // $dEnd = '2018-11-30';

        $calocjour = $em->getRepository('BaclooCrmBundle:Locata')
            ->statloc($dStarta, $dEnda);

        $calocjourtest = $em->getRepository('BaclooCrmBundle:Locataclone')
            ->statloc($dStarta, $dEnda);

        $today = date('Y-m-d');
        $caloctoday = $em->getRepository('BaclooCrmBundle:Locata')
            ->statloctoday($today, $today);

        $debmois = date('Y-m-01');
        $fimois = date('Y-m-t');
        $calocmois = $em->getRepository('BaclooCrmBundle:Locataclone')
            ->statlocmois($debmois, $fimois);
// echo 'caaaaa'; echo $caloctoday;
        $cahorslocjour = $em->getRepository('BaclooCrmBundle:Locataclone')
            ->statloccarb($dStarta, $dEnda);

        $caventejour = $em->getRepository('BaclooCrmBundle:Venda')
            ->caventejour($dStarta, $dEnda);
// var_dump($calocjour);

        include('nbjourscamois.php');
        //2.On génère les entêtes de colonnes à partir de la fonction createplanning
        $iStart = strtotime ($dStarta);//Formate une date/heure locale avec la Something is wronguration locale
        $iEnd = strtotime ($dEnda);
        if (false === $iStart || false === $iEnd) {
            return false;
        }
        $aStart = explode ('-', $dStarta);
        $aEnd = explode ('-', $dEnda);
        if (count ($aStart) !== 3 || count ($aEnd) !== 3) {
            return false;
        }
        if (false === checkdate ($aStart[1], $aStart[2], $aStart[0]) || false === checkdate ($aEnd[1], $aEnd[2], $aEnd[0]) || $iEnd <= $iStart) {
            // return false;
        }
        for ($i = $iStart; $i < $iEnd + 86400; $i = strtotime ('+1 day', $i) ) {
            $sDateToArra = strftime ('%Y-%m-%d', $i);
            $sYear = substr ($sDateToArra, 0, 4);
            $sMonth = substr ($sDateToArra, 5, 2);
            $aDatesa[$sYear][$sMonth][] = $sDateToArra;
        }

        $nbanneea = 0;
        $nbmoisparanneea = 0;
        //Calcule le nombre de jours dans le mois
        $annee1 = date("Y", strtotime($dStart));
        $anneef = date("Y", strtotime($dStart));
        $anneefin = $anneef + 1;

        //Boucle parcours tableau année, mois, jours.
        //Celle-ci renvoie le nombre de  jours du premier mois m1
        $m11a = 1;
        foreach($aDatesa as $anneea => $moissa)
        {
            foreach($moissa as $datea => $moisa)
            {
                if($m11a == 1)//si on est en m1 on procède sinon break
                {
                    foreach($moisa as $data)
                    {
                        $m11a++;
                    }
                }
                else
                {
                    break;
                }
            }

        }
        $m1a = $m11a-1;
        //Calcul du nb total de mois $m
        $ma = 0;
        foreach($aDatesa as $anneea => $moissa)
        {
            foreach($moissa as $datea => $moisa)
            {
                $ma++;
            }

        }

        //Calcul du nb total d'années $a
        $ana = 0;
        foreach($aDatesa as $anneea => $moissa)
        {
            $ana++;
        }
// echo $ma;
        //Celle-ci renvoie le nombre de jours du dernier mois mm
        $mma = 0;
        $compteurma = 1;
        foreach($aDatesa as $anneea => $moissa)
        {
            foreach($moissa as $datea => $moisa)
            {
                if($compteurma == $ma)//si on est le dernier mois
                {
                    foreach($moisa as $data)
                    {
                        $mma++;
                    }
                }
                else
                {}
                $compteurma++;
            }

        }

        //Celle-ci renvoie le nombre de jours de la première année $a1
        $a11a = 1;
        foreach($aDatesa as $anneea => $moissa)
        {
            if($a11a == 1)//si on est en a1 on procède sinon break
            {
                foreach($moissa as $datea => $moisa)
                {
                    foreach($moisa as $data)
                    {
                        $a11a++;
                    }
                }
            }
            else
            {
                break;
            }
        }
        $a1a = $a11a-1;
        //Fonction qui calcule le nombre de jours dans l'année


        //Celle-ci renvoie le nombre de jours de la dernière année $aa
        $aaa = 0;
        $compteuraa = 1;
        foreach($aDatesa as $anneea => $moissa)
        {
            if($compteuraa == $ana)//si on est en end ernière année on calcule le nb de jours $aa
            {
                foreach($moissa as $datea => $moisa)
                {
                    foreach($moisa as $data)
                    {
                        $aaa++;
                    }
                }
            }
            else
            {
                break;
            }
            $compteuraa++;
        }
        // echo 'www'.$mm.'www';
        // $mma = 0; //Compteur de mois qui s'incrémente de 1 afin de faire un compte indépendant des mois.
        $nbjrparmoisa = 0;
        $ia = 1; //Compteur pour premier mois
        $aa = 1; //Compteur pour la première année
        $nbmoisaa = array();
        $nbjanneeaa = array();
        foreach($aDatesa as $anneea => $moissa)
        {
            //Calculer le nombre d'années
            // echo $anneea;
            if($aa == 1)//Si on est en première année
            {
                $nbjanneea[] = $a1a;//nb de jours de la première année
            }
            elseif($aa == $ana)
            {
                $nbjanneea[] = $aa;
            }
            else
            {
                $nbjanneea[] = cal_days_in_year($anneea);
            }
            foreach($moissa as $datea => $moisa)
            {
                if($ia == 1)//on est au premier mois
                {
                    //nb jours mois courant
                    $nbmoisa[] = $m1a;
                }
                elseif($ia == $ma)//Si on est  le dernier mois de la période on met le nb de jours
                {
                    //nb de jours du dernier mois
                    $nbmoisa[] = $mma;
                }
                else
                {
                    //Pour les autres mois
                    $nbmoisa[] = cal_days_in_month(CAL_GREGORIAN, $datea, $anneea);
                }
                $ia++;
            }
            $aa++;
        }

        $nblocparc = $em->getRepository('BaclooCrmBundle:Locata')
            ->nblocparc(); //echo 'nblocparc : '.$nblocparc;
        // $nblocparc = count($nblocparca);
// echo $nblocparc;
        $totalparc = $em->getRepository('BaclooCrmBundle:Machines')
            ->totalparc(); //echo 'totalparc : '.$totalparc;

        $nblocsl = $em->getRepository('BaclooCrmBundle:Locata')
            ->nblocparcsl(); //echo 'nblocsl : '.$nblocsl;
        // $nblocsl = count($nblocsla);
// echo $nblocsl;
        if($totalparc > 0)
        {
            $txocupp = ($nblocparc/$totalparc)*100;
        }
        else
        {
            $txocupp = 0;
        }

        //NB de départs
        $today = date('D');

        if($today == 'Fri')
        {
            $datelivraison = date('Y-m-d', strtotime("+3 days"));
        }
        elseif($today == 'Sat')
        {
            $datelivraison = date('Y-m-d', strtotime("+2 days"));
        }
        else
        {
            $datelivraison = date('Y-m-d', strtotime("+1 days"));
        }
        $livraisonsok = $em->getRepository('BaclooCrmBundle:Locata')
            ->findByEtatloca2('Prêt pour le chargement', 'En cours de livraison', $datelivraison);//echo $datelivraison;
        // print_r($livraisonsok);
        $livraisonsoksl = $em->getRepository('BaclooCrmBundle:Locata')
            ->findByEtatlocasl2('Prêt pour le chargement', 'En cours de livraison', $datelivraison);

        $b = 0;
        foreach($livraisonsok as $ret)
        {
            foreach($ret->getLocations() as $di )
            {
                if($di->getDebutloc() == $datelivraison)
                {
                    $b++;
                }
            }
        }

        foreach($livraisonsoksl as $ret)
        {
            foreach($ret->getLocationssl() as $di )
            {
                if($di->getDebutloc() == $datelivraison)
                {
                    $b++;
                }
            }
        }
        //Fin nb de départs

        //Nb de retours
        $now = date('Y-m-d');
        if($today == 'Fri')
        {
            $date = date('Y-m-d', strtotime("+3 days"));
        }
        elseif($today == 'Sat')
        {
            $date = date('Y-m-d', strtotime("+2 days"));
        }
        elseif($today == 'Sun')
        {
            $date = date('Y-m-d', strtotime("+1 days"));
        }
        else
        {
            $date = date('Y-m-d');
        }

        $retours = $em->getRepository('BaclooCrmBundle:Locata')
            ->retours($now);

        $i = 0;
        foreach($retours as $ret)
        {
            foreach($ret->getLocations() as $di )
            {
                if($di->getFinloc() == $now)
                {
                    $i++;
                }
            }
        }

        $retourssl = $em->getRepository('BaclooCrmBundle:Locata')
            ->retourssl($now);

        foreach($retourssl as $ret)
        {
            foreach($ret->getLocationssl() as $di )
            {
                if($di->getFinloc() == $now)
                {
                    $i++;
                }
            }
        }
        $commerciaux = array('Bureau', 'Cobilas');
        $cacommerciaux  = $em->getRepository('BaclooCrmBundle:Factures')
            ->last12mca3commerciaux($dStart, $dEnd);//print_r($cacommerciaux);
        //redressement des datemodif locataclone
        $locataclones = $em->getRepository('BaclooCrmBundle:Locataclone')
            ->locatacloneamodifier();//var_dump($locataclones);exit();

        foreach ($locataclones as $locataclone)
        {
            if ($locataclone instanceof Locataclone)
            {
                // traitement de l'entité Locataclone

                $facture = $em->getRepository('BaclooCrmBundle:Factures')
                    ->findOneBy(array('typedoc' => 'facture', 'locatacloneid' => $locataclone->getId()));

                if (isset($facture)) {//echo 'iiddd'.$locataclone->getAdresse1();
                    $locataclone->setDatemodif($facture->getDatecrea());
                    $em->persist($locataclone);
                }
            }
        }

        $em->flush();
        //Fin redressement
        return $this->render('BaclooCrmBundle:Crm:statfi.html.twig', array(
            'retours' => $i,
            'departs' => $b,
            'nblocparc' => $nblocparc,
            'totalparc' => $totalparc,
            'nblocsl' => $nblocsl,
            'txocupp' => $txocupp,
            'today' => $today,
            'dates' => $aDates,
            'datesa' => $aDatesa,
            'datesa2' => $aDatesa2,
            'dstart' => $dStart,
            'dstarta' => $dStarta,
            'dstarta2' => $dStarta2,
            'dend' => $dEnd,
            'denda' => $dEnda,
            'ca' => $ca,
            'cacommerciaux' => $cacommerciaux,
            'caloc' => $caloc,
            'catransport' => $catransport,
            'cacontributionverte' => $cacontributionverte,
            'caassurance' => $caassurance,
            'cacarburant' => $cacarburant,
            'calocavente' => $calocavente,
            'cavente' => $cavente,
            'canr' => $canr,
            'catf' => $catf,
            'statachats' => $statachats,
            'caavoirs' => $caavoirs,
            'caventejour' => $caventejour,
            'calocjour' => $calocjour,
            'calocjourtest' => $calocjourtest,
            'calocmois' => $calocmois,
            'cahorslocjour' => $cahorslocjour,
            'caloctoday' => $caloctoday,
            'ansa' => $ana,
            'ans' => $an,
            // 'commerciaux' => $commerciaux,
            'nbjannee' => $nbjannee,
            'nbjanneea' => $nbjanneea,
            'form' => $form->createView(),
            'nbmois' => $nbmois,
            'nbmoisa' => $nbmoisa,
            'commerciaux' => $commerciaux
        ));
    }

    public function statcomAction(Request $request)
    {//$id = id ligne partenaire
        include('societe.php');
        $nomsociete = $societe;
        $session = new Session();
        $session = $request->getSession();
        $usersess = $this->get('security.context')->getToken()->getUsername();
        $em = $this->getDoctrine()->getManager();
        $user  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($usersess);

        // echo 'testfichespipe'.$testfichespipe;
        //Protect double connexion
        $session = $request->getSession();
        $sessionId = $session->getId();
        // echo $sessionId;
        // echo 'xxxxx'.$user->getLogged();
        // echo '  '.$user->getUsername();
        if($user->getLogged() != $sessionId)
        {
            return $this->redirect($this->generateUrl('fos_user_security_logout'));
        }
        //Fin protect double connexion

        // if($user->getRoleuser() != 'admin' && $user->getUsersociete() != null)
        if($user->getRoleuser() != 'admin' && $user->getUsersociete() != $societe)
        {
            $societe = $user->getNomrep();
            // $url = 'http://127.0.0.1/symfony2/web/b/lamiecaline/web/app_dev.php/login';
            $url = 'https://www.bacloo.fr/b/'.$societe.'/web/app.php';
            return $this->redirect($url);
        }

        if($user->getRoleuser() == 'admin' && $user->getUsersociete() != $societe)
        {
            $societe = $user->getNomrep();
            // $url = 'http://127.0.0.1/symfony2/web/b/lamiecaline/web/app_dev.php/login';
            $url = 'https://www.bacloo.fr/b/'.$societe.'/web/app.php';
            return $this->redirect($url);
        }


        //Ici on met à jour la société au cas l'admin aurait créé sont Bacloo perso après avoir importé son fichier
        // if($user->getRoleuser() == 'admin')
        // {
        // $fiches = $em->getRepository('BaclooCrmBundle:Fiche')
        // ->findBy(array('user' => $usersess, 'usersociete' => NULL));
        // if(isset($fiche) && $fiches->getUsersociete() != $societe)
        // {
        // $fichesok = $em->getRepository('BaclooCrmBundle:Fiche')
        // ->find($usersess);
        // foreach($fichesok as $fiche)
        // {
        // set_time_limit(300);
        // $fiche->setUsersociete($societe);
        // $em->persist($fiche);
        // }
        // $em->flush();
        // }

        // }

        if($user->getRoleuser() != 'admin'){$useracc = $usersess;}
        if(isset($useracc))
        {
            if($useracc == 'societe')
            {
                //On calcule critères
                $i = 1;
                $em = $this->getDoctrine()->getManager();
                $listuser = $em->getRepository('BaclooUserBundle:User')
                    ->findBy(array('usersociete' => $societe));
                foreach($listuser as $listu)
                {
                    ${'choix'.$i++} = $listu->getUsername();
                }
                //echo 'choix1'.$choix1;
                $critere = array($usersess);

                for($j=1;$j<$i;$j++)
                {
                    ${'critere'.$j} = array(${"choix".$j});
                    $critere = array_merge(${'critere'.$j},$critere);
                }
                $usersessok = $critere;
            }
            else
            {
                $usersessok = $useracc;
            }
        }
        else
        {
            $usersessok = $usersess;
        }

        if($usersess == 'anon.')
        {
            return $this->redirect($this->generateUrl('fos_user_security_login'));
        }

        $em = $this->getDoctrine()->getManager();
        $user  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($usersess);
// echo '111'.$usersess;
        if($user->getRoleuser() != 'admin')
        {
            $userdetails  = $em->getRepository('BaclooUserBundle:User')
                ->findOneBy(array('roleuser'=> 'admin', 'usersociete' => $societe));
            // $usersess = $userdetails->getUsername();
        }
// echo '222'.$usersess;
        $query = $em->createQuery(
            'SELECT u.id
					FROM BaclooUserBundle:User u
					WHERE u.username = :username'
        )->setParameter('username', $usersess);
        $uid = $query->getSingleScalarResult();
        //On regarde si l'utilisateur connecté est déja entegistré dnas la table userpipe
        $userpipe = $em->getRepository('BaclooCrmBundle:Userpipe')
            ->findOneByUserid($uid);

        //On récupère les pipelines de l'utilisateur connecté
        $em2 = $this->getDoctrine()
            ->getManager()
            ->getRepository('BaclooCrmBundle:Pipeline');
        $pipe = $em2->findByUsername($usersess);

        $pipe_zero = $em->getRepository('BaclooCrmBundle:Pipeline')
            ->findByPipeorder(0);

        //On récupère les userpipe du user connecté
        $em2 = $this->getDoctrine()
            ->getManager()
            ->getRepository('BaclooCrmBundle:Userpipe');
        $userpipa = $em2->findOneByUserid($uid);

        if(empty($userpipa))
        {
            // echo 'pppppppooo'.$uid;
            $userpipe = new userpipe();
            $userpipe->setUserid($uid);
            $em = $this->getDoctrine()->getManager();
            $em->persist($userpipe);
            $em->flush();

            $em2 = $this->getDoctrine()
                ->getManager()
                ->getRepository('BaclooCrmBundle:Userpipe');
            $userpipo = $em2->findOneByUserid($uid);

            $pipe0 = new pipeline();
            $pipe0->setUserid($uid);
            $pipe0->setUsername($usersess);
            $pipe0->setPipename('---------');
            $pipe0->setPipeorder(0);
            $pipe0->addUserpipe($userpipo);
            $userpipo->addPipeline($pipe0);
            $em->persist($pipe0);
            $em->persist($userpipo);
            $em->flush();

            $pipe0 = new pipeline();
            $pipe0->setUserid($uid);
            $pipe0->setUsername($usersess);
            $pipe0->setPipename('Devis fait');
            $pipe0->setPipeorder(1);
            $pipe0->addUserpipe($userpipo);
            $userpipo->addPipeline($pipe0);
            $em->persist($pipe0);
            $em->persist($userpipo);
            $em->flush();

            $pipe0 = new pipeline();
            $pipe0->setUserid($uid);
            $pipe0->setUsername($usersess);
            $pipe0->setPipename('Affaires signées');
            $pipe0->setPipeorder(2);
            $pipe0->setRealise(true);
            $pipe0->addUserpipe($userpipo);
            $userpipo->addPipeline($pipe0);
            $em->persist($pipe0);
            $em->persist($userpipo);
            $em->flush();

            $pipe0 = new pipeline();
            $pipe0->setUserid($uid);
            $pipe0->setUsername($usersess);
            $pipe0->setPipename('Affaires perdues');
            $pipe0->setPipeorder(3);
            $pipe0->setPerdu(true);
            $pipe0->setExclusion(true);
            $pipe0->addUserpipe($userpipo);
            $userpipo->addPipeline($pipe0);
            $em->persist($pipe0);
            $em->persist($userpipo);
            $em->flush();
        }
        else
        {
            $pipe_zero = $em->getRepository('BaclooCrmBundle:Pipeline')
                ->findByPipeorder(0);
            if(empty($pipe_zero))
            {
                $em2 = $this->getDoctrine()
                    ->getManager()
                    ->getRepository('BaclooCrmBundle:Userpipe');
                $userpipo = $em2->findOneByUserid($uid);

                $pipe0 = new pipeline();
                $pipe0->setUserid($uid);
                $pipe0->setUsername($usersess);
                $pipe0->setPipename('---------');
                $pipe0->setPipeorder(0);
                $pipe0->addUserpipe($userpipo);
                $userpipo->addPipeline($pipe0);
                $em->persist($pipe0);
                $em->persist($userpipo);
                $em->flush();
            }
        }

        $query = $em->createQuery(
            'SELECT p
				FROM BaclooCrmBundle:Pipeline p
				WHERE p.username = :username
				AND p.pipeorder > :pipeorder
				ORDER BY p.pipeorder ASC'
        )->setParameter('username', $usersess)
            ->setParameter('pipeorder', 0);

        $pipeselect = $query->getResult();

        $nbpipe = count($pipeselect);
        if($nbpipe == 0){$nbpipe = 1;}
        $offset = round(12/$nbpipe, 0, PHP_ROUND_HALF_DOWN);

        $today = date('Y-m-d');
        $prev30 = date('Y-m-d', strtotime("-29 days"));

        if(is_array($usersessok) == 1)
        {
            $fichespipe = $em->getRepository('BaclooCrmBundle:Fiche')
                ->createpiplinearray($usersessok);

            $em = $this->getDoctrine()->getManager();
            $nbevents  = $em->getRepository('BaclooCrmBundle:Fiche')
                ->last30eventarray($usersessok, $today, $prev30);

            $capotbefore  = $em->getRepository('BaclooCrmBundle:Fiche')
                ->before30capotarray($usersess, $prev30);
            if(empty($capotbefore)){$capotbefore = 0;}
            // echo 'capotbefore'.$capotbefore;
            $carealbefore  = $em->getRepository('BaclooCrmBundle:Fiche')
                ->before30carealarray($usersess, $prev30);
            if(empty($carealbefore)){$carealbefore = 0;}

            $caperdubefore  = $em->getRepository('BaclooCrmBundle:Fiche')
                ->before30caperduarray($usersess, $prev30);
            if(empty($caperdubefore)){$caperdubefore = 0;}

            $cachart  = $em->getRepository('BaclooCrmBundle:Ca')
                ->last30caarray($usersess, $today, $prev30);
        }
        else
        {
            $fichespipe = $em->getRepository('BaclooCrmBundle:Fiche')
                ->createpipline($usersessok);

            $em = $this->getDoctrine()->getManager();
            $nbevents  = $em->getRepository('BaclooCrmBundle:Fiche')
                ->last30event($usersessok, $today, $prev30);

            $capotbefore  = $em->getRepository('BaclooCrmBundle:Fiche')
                ->before30capot($usersessok, $prev30);
            if(empty($capotbefore)){$capotbefore = 0;}
            // echo 'capotbefore'.$capotbefore;
            $carealbefore  = $em->getRepository('BaclooCrmBundle:Fiche')
                ->before30careal($usersessok, $prev30);
            if(empty($carealbefore)){$carealbefore = 0;}

            $caperdubefore  = $em->getRepository('BaclooCrmBundle:Fiche')
                ->before30caperdu($usersessok, $prev30);
            if(empty($caperdubefore)){$caperdubefore = 0;}

            $cachart  = $em->getRepository('BaclooCrmBundle:Ca')
                ->last30ca($usersessok, $today, $prev30);
        }

        if(empty($fichespipe))
        {
            $testfichespipe = 0;
            $ca_pot = 0;
            $aff_pot = 0;
            $nbperdu = 0;
            $ca_perdu = 0;
            $nbrealise = 0;
            $ca_realise = 0;
        }
        else
        {
            $testfichespipe = 1;
            $ca_pot = 0;
            $aff_pot = 0;
            $nbperdu = 0;
            $ca_perdu = 0;
            $nbrealise = 0;
            $ca_realise = 0;
            foreach($fichespipe as $fp)
            {
                if($fp->getPipeline()->getExclusion() == 0)
                {
                    $ca_pot = $ca_pot + $fp->getPotentiel();
                }
                if($fp->getPipeline()->getRealise() == 1)
                {
                    $ca_realise = $ca_realise + $fp->getPotentiel();
                }
                if($fp->getPipeline()->getPerdu() == 1)
                {
                    $ca_perdu = $ca_perdu + $fp->getPotentiel();
                }
            }
        }



        $userdetails = $user;



//Gros check des modules
        $credits = $userdetails->getCredits();

        $listmodalerte = 0;// pour lister les modules en alerte expiration
        $comptemodalerte = 0;// pour compter les modules en  alerte
        $listmodarret = 0;// pour lister les modules en alerte expiration
        $comptemodarret = 0;// pour compter les modules en  alerte

        $modules  = $em->getRepository('BaclooCrmBundle:Modules')
            ->findOneByUsername($usersess);
        // echo $usersess;
        $moda = $em->getRepository('BaclooCrmBundle:Moda')
            ->findOneBySociete('1234');

        if(empty($moda))
        {
            $moda = new moda();
            $moda->setSociete('1234');
            $em = $this->getDoctrine()->getManager();
            $em->persist($moda);
        }

        $userprix = 3;
        if(empty($modules))
        {//echo 'oooooooooooooooooooooooo';
            if($user->getRoleuser() == 'admin')
            {//echo 'sssssssssssssssssss';
                $modules = new Modules();
                $modules->setUserprix($userprix);
                $modules->setUserdebut(date('d/m/Y'));
                $modules->setUserexpiration('illimité');
                $modules->setBbuseractivation(1);
                $modules->setUsersociete($nomsociete);
                $modules->setModule1('Partage rapide des fiches');
                $modules->setModule1prix(1);
                $modules->setModule1debut(date('25/12/2016'));
                $modules->setModule1expiration('15/01/2017');
                $modules->setModule1activation(0);
                $modules->setModule2('Pipeline des ventes');
                $modules->setModule2prix(2);
                $modules->setModule2debut(date('30/11/2016'));
                $modules->setModule2expiration('31/12/2016');
                $modules->setModule2activation(0);
                $modules->setModule3('Bloc devis et commandes');
                $modules->setModule3prix(1);
                $modules->setModule3debut(date('30/11/2016'));
                $modules->setModule3expiration('31/12/2017');
                $modules->setModule3activation(0);
                $modules->setModule4('Recherche avancée');
                $modules->setModule4prix(1);
                $modules->setModule4debut(date('25/12/2016'));
                $modules->setModule4expiration('15/01/2017');
                $modules->setModule4activation(0);
                $modules->setModule5('Synchronisation avec agenda');
                $modules->setModule5prix(1);
                $modules->setModule5debut(date('30/11/2016'));
                $modules->setModule5expiration('31/12/2020');
                $modules->setModule5activation(0);
                $modules->setModule6('Fiches fournisseurs');
                $modules->setModule6prix(1);
                $modules->setModule6debut(date('25/12/2016'));
                $modules->setModule6expiration('15/01/2017');
                $modules->setModule6activation(0);
                $modules->setModule7('Google Docs');
                $modules->setModule7prix(1);
                $modules->setModule7debut(date('25/12/2016'));
                $modules->setModule7expiration('15/01/2017');
                $modules->setModule7activation(0);
                $modules->setModule8('Collègues : Partage de fiches');
                $modules->setModule8prix(0);
                $modules->setModule8debut(date('30/11/2016'));
                $modules->setModule8expiration('31/12/2020');
                $modules->setModule8activation(1);
                $modules->setModule9('Annuaire');
                $modules->setModule9prix(45);
                $modules->setModule9debut(date('25/12/2016'));
                $modules->setModule9expiration('15/01/2017');
                $modules->setModule9activation(0);
                $modules->setModule10('Bacloo Illimité');
                $modules->setModule10prix(3);
                $modules->setModule10debut(date('25/12/2016'));
                $modules->setModule10expiration('15/01/2017');
                $modules->setModule10activation(1);
                $modules->setModule11('Speed menu');
                $modules->setModule11prix(1);
                $modules->setModule11debut(date('25/12/2016'));
                $modules->setModule11expiration('15/01/2017');
                $modules->setModule11activation(1);
                $modules->setModule11('Compte-rendu activité');
                $modules->setModule12prix(1);
                $modules->setModule12debut(date('25/12/2016'));
                $modules->setModule12expiration('15/01/2017');
                $modules->setModule12activation(0);
                $modules->setUserid($user->getId());
                $modules->setUsername($usersess);
                // $modules->setUsersociete();
                $modules->addModa($moda);
                $moda->addModule($modules);
                $em->persist($modules);
                $em->persist($moda);
                $em->flush();
            }
            else
            {
                $modules = new Modules();
                $modules->setUserprix($userprix);
                $modules->setUserdebut(date('d/m/Y'));
                $modules->setUserexpiration('illimité');
                $modules->setBbuseractivation(0);
                $modules->setUsersociete($nomsociete);
                $modules->setUserid($user->getId());
                $modules->setUsername($usersess);
                $modules->setModule1('Partage rapide des fiches');
                $modules->setModule1prix(1);
                $modules->setModule1debut(date('25/12/2016'));
                $modules->setModule1expiration('15/01/2017');
                $modules->setModule1activation(0);
                $modules->setModule2('Pipeline des ventes');
                $modules->setModule2prix(2);
                $modules->setModule2debut(date('25/12/2016'));
                $modules->setModule2expiration('15/01/2017');
                $modules->setModule2activation(0);
                $modules->setModule3('Bloc devis et commandes');
                $modules->setModule3prix(1);
                $modules->setModule3debut(date('25/12/2016'));
                $modules->setModule3expiration('15/01/2017');
                $modules->setModule3activation(0);
                $modules->setModule4('Recherche avancée');
                $modules->setModule4prix(1);
                $modules->setModule4debut(date('25/12/2016'));
                $modules->setModule4expiration('15/01/2017');
                $modules->setModule4activation(0);
                $modules->setModule5('Synchronisation avec agenda');
                $modules->setModule5prix(1);
                $modules->setModule5debut(date('25/12/2016'));
                $modules->setModule5expiration('15/01/2017');
                $modules->setModule5activation(0);
                $modules->setModule6('Fiches fournisseurs');
                $modules->setModule6prix(1);
                $modules->setModule6debut(date('25/12/2016'));
                $modules->setModule6expiration('15/01/2017');
                $modules->setModule6activation(0);
                $modules->setModule7('Google Docs');
                $modules->setModule7prix(1);
                $modules->setModule7debut(date('25/12/2016'));
                $modules->setModule7expiration('15/01/2017');
                $modules->setModule7activation(0);
                $modules->setModule8('Collègues : Partage de fiches');
                $modules->setModule8prix(1);
                $modules->setModule8debut(date('25/12/2016'));
                $modules->setModule8expiration('15/01/2017');
                $modules->setModule8activation(0);
                $modules->setModule9('Annuaire');
                $modules->setModule9prix(45);
                $modules->setModule9debut(date('25/12/2016'));
                $modules->setModule9expiration('15/01/2017');
                $modules->setModule9activation(0);
                $modules->setModule10('Bacloo Illimité');
                $modules->setModule10prix(3);
                $modules->setModule10debut(date('25/12/2016'));
                $modules->setModule10expiration('15/01/2017');
                $modules->setModule10activation(0);
                $modules->setModule11('Speed menu');
                $modules->setModule11prix(1);
                $modules->setModule11debut(date('25/12/2016'));
                $modules->setModule11expiration('15/01/2017');
                $modules->setModule11activation(0);
                $modules->setModule12('Compte-rendu activité');
                $modules->setModule12prix(1);
                $modules->setModule12debut(date('25/12/2016'));
                $modules->setModule12expiration('15/01/2017');
                $modules->setModule12activation(0);
                // $modules->setUsersociete();
                $modules->addModa($moda);
                $moda->addModule($modules);
                $em->persist($modules);
                $em->persist($moda);
                $em->flush();
            }
        }
//Controle validité de tous les moduels

        $modulesuser  = $em->getRepository('BaclooCrmBundle:Modules')
            ->findOneByUsername($usersess);

        if($modulesuser->getBbuseractivation() == 0 && $user->getRoleuser() != 'admin')
        {
            // $request->getSession()
            // ->getFlashBag()
            // ->add('fail', 'Votre compte n\'a pas encore été activé par l\'administrateur');
            return $this->redirect($this->generateUrl('fos_user_security_logout'));
        }


        include('checkmodule1.php');
        include('checkmodule2.php');
        include('checkmodule3.php');
        include('checkmodule4.php');
        include('checkmodule5.php');
        include('checkmodule6.php');
        include('checkmodule7.php');
        include('checkmodule8.php');
        include('checkmodule9.php');
        include('checkmodule10.php');
        include('checkmodule11.php');
        include('checkmodule12.php');

        $today = date('Y-m-d');

// echo 'aaaa'.$listmodalerte;
// echo 'arret'.$comptemodarret;
// echo 'alerte'.$comptemodalerte;

        if($comptemodarret != 0 && $comptemodalerte != 0 && $modules->getDatemailalerte() <> $today)
        {
// echo 'xxxxxxx';
            //envoyer un mail à l'admin  indiquant que module désactivé faute de crédits
            // Récupération du service
            $mailer = $this->get('mailer');

            $message = \Swift_Message::newInstance()
                ->setSubject($userdetails->getPrenom(). ' : '.$comptemodarret.' modules en arrêt et '.$comptemodalerte.' modules qui s\'arrêtent dans 5 jours')
                ->setFrom(array('bacloo@bacloo.fr' => 'Bacloo CRM'))
                ->setTo($userdetails->getEmail())
                ->setBody($this->renderView('BaclooCrmBundle:Crm:bbalerte_user.html.twig', array('prenom'	=> $userdetails->getPrenom(),
                    'user'	=> $usersess,
                    'comptemodarret'	=> $comptemodarret,
                    'comptemodalerte'	=> $comptemodalerte,
                    'mode' => 'module'
                )))
            ;
            $mailer->send($message);

            $mailer = $this->get('mailer');

            $message = \Swift_Message::newInstance()
                ->setSubject($userdetails->getPrenom(). ' : '.$comptemodarret.' modules en arrêt et '.$comptemodalerte.' modules qui s\'arrêtent dans 5 jours')
                ->setFrom(array('bacloo@bacloo.fr' => 'Bacloo CRM'))
                ->setTo('ringuetjm@gmail.com')
                ->setBody($this->renderView('BaclooCrmBundle:Crm:bbalerte_user.html.twig', array('prenom'	=> $userdetails->getPrenom(),
                    'user'	=> $usersess,
                    'comptemodarret'	=> $comptemodarret,
                    'comptemodalerte'	=> $comptemodalerte,
                    'mode' => 'module'
                )))
            ;
            $mailer->send($message);

            // $modules->setDatemailalerte($today);
            // $modules->setDatemailarret($today);

            // Fin partie envoi mail
        }
        elseif($comptemodarret > 0 && $comptemodalerte < 1 && $modules->getDatemailarret() <> $today)
        {
//echo 'b'.$listmodalerte;
            //envoyer un mail à l'admin  indiquant que module désactivé faute de crédits
            // Récupération du service
            $mailer = $this->get('mailer');

            $message = \Swift_Message::newInstance()
                ->setSubject($userdetails->getPrenom(). ' : '.$comptemodarret.' modules en arrêt')
                ->setFrom(array('bacloo@bacloo.fr' => 'Bacloo CRM'))
                ->setTo($userdetails->getEmail())
                ->setBody($this->renderView('BaclooCrmBundle:Crm:bbalerte_user.html.twig', array('prenom'	=> $userdetails->getPrenom(),
                    'user'	=> $usersess,
                    'comptemodarret'	=> $comptemodarret,
                    'mode' => 'modules_arret'
                )))
            ;
            $mailer->send($message);

            $mailer = $this->get('mailer');

            $message = \Swift_Message::newInstance()
                ->setSubject($userdetails->getPrenom(). ' : '.$comptemodarret.' modules en arrêt')
                ->setFrom(array('bacloo@bacloo.fr' => 'Bacloo CRM'))
                ->setTo('ringuetjm@gmail.com')
                ->setBody($this->renderView('BaclooCrmBundle:Crm:bbalerte_user.html.twig', array('prenom'	=> $userdetails->getPrenom(),
                    'user'	=> $usersess,
                    'comptemodarret'	=> $comptemodarret,
                    'mode' => 'modules_arret'
                )))
            ;
            $mailer->send($message);

            $modules->setDatemailalerte($today);
            $modules->setDatemailarret($today);

            // Fin partie envoi mail
        }
        elseif($comptemodarret < 1 && $comptemodalerte > 0 && $modules->getDatemailalerte() <> $today)
        {
// echo 'c'.$listmodalerte;
            //envoyer un mail à l'admin  indiquant que module désactivé faute de crédits
            // Récupération du service
            // $mailer = $this->get('mailer');

            // $message = \Swift_Message::newInstance()
            // ->setSubject($userdetails->getPrenom(). ' : '.$comptemodalerte.' modules qui s arrêtent dans 5 jours '.$listmodalerte)
            // ->setFrom(array('bacloo@bacloo.fr' => 'Bacloo CRM'))
            // ->setTo($userdetails->getEmail())
            // ->setBody($this->renderView('BaclooCrmBundle:Crm:bbalerte_user.html.twig', array('prenom'	=> $userdetails->getPrenom(),
            // 'user'	=> $usersess,
            // 'comptemodalerte'	=> $comptemodalerte,
            // 'mode' => 'modules_alerte'
            // )))
            // ;
            // $mailer->send($message);

            // $mailer = $this->get('mailer');

            // $message = \Swift_Message::newInstance()
            // ->setSubject($userdetails->getPrenom(). ' : '.$comptemodalerte.'modules qui s arrêtent dans 5 jours '.$listmodalerte)
            // ->setFrom(array('bacloo@bacloo.fr' => 'Bacloo CRM'))
            // ->setTo('ringuetjm@gmail.com')
            // ->setBody($this->renderView('BaclooCrmBundle:Crm:bbalerte_user.html.twig', array('prenom'	=> $userdetails->getPrenom(),
            // 'user'	=> $usersess,
            // 'comptemodalerte'	=> $comptemodalerte,
            // 'mode' => 'modules_alerte'
            // )))
            // ;
            // $mailer->send($message);

            // $modules->setDatemailalerte($today);
            // $modules->setDatemailarret($today);

            // Fin partie envoi mail
        }
        $em->flush();
//Fin controle sur tous les modules

        $em = $this->getDoctrine()->getManager();
        $query = $em->createQuery(
            'SELECT u
			FROM BaclooUserBundle:User u
			WHERE u.username = :username'
        )->setParameter('username', $usersess);
        $userdetail = $query->getSingleResult();
        $actvise= $userdetail->getActvise();
        $tabtags = $userdetail->getTags();

        $activisse = str_replace(", ", ",", $actvise);
        $actv	   = explode(",", $activisse);
        if(empty($actv) && !isset($actv)){$actv = array(0);}
        // si tags, on sort les prospects correspondants qu'on stock dans $fiche (instance de Fiche)
        $tagss = str_replace(", ", ",", $tabtags);
        $tags = explode(",", $tagss);
        if(empty($tags) && !isset($tags)){$tags = array(0);}
// echo 'taaags';print_r($tags);
// echo 'actv';print_r($actv);
        if(empty($actvise) && empty($tabtags))
        {//echo 'ici';
            $i = 0;
        }
        else
        {
            // echo 'la';
            $session = $request->getSession();
            $refresh = $session->get('countprospot');
            if(!empty($refresh))
            {
                //ne pas faire le refresh
                // echo 'sessiopr';
                $i = $refresh;
            }
            else
            {
                //Lancer la requête
                // echo 'calcpr';
                $em = $this->getDoctrine()
                    ->getManager()
                    ->getRepository('BaclooCrmBundle:Prospot');
                $prospotaa = $em->findBy(array(
                    'user'=>$usersess,
                    'voir'=>0));

                $em = $this->getDoctrine()->getManager();
                $listintfiche2  = $em->getRepository('BaclooCrmBundle:interresses')
                    ->findByUsername($usersess);
                $i  = count($listintfiche2);
                $i += count($prospotaa);
                //maj la valeur prospot en session
                $session->set('countprospot', $i);
            }

        }
// echo 'iiiiiiiiii'.$i;
        $refreshfv = $this->get('session')->get('countfv');
        if(isset($refreshfv))
        {
            //ne pas faire le refresh
            $nbfiche = $refreshfv;
        }
        else
        {
            //Lancer la requête
            $em = $this->getDoctrine()
                ->getManager();
            $query = $em->createQuery(
                'SELECT COUNT(i.id) as nbfiche
				FROM BaclooCrmBundle:Fichesvendables i
				WHERE i.vendeur = :vendeur'
            );
            $query->setParameter('vendeur', $usersess);

            $nbfiche = $query->getOneOrNullResult();

            //maj la valeur fichesvendables en session
            $this->get('session')->set('countfv', $nbfiche);

        }
        $nblocparc = $em->getRepository('BaclooCrmBundle:Locata')
            ->nblocparc(); //echo 'nblocparc : '.$nblocparc;
        // $nblocparc = count($nblocparca);
// echo $nblocparc;
        $totalparc = $em->getRepository('BaclooCrmBundle:Machines')
            ->totalparc(); //echo 'totalparc : '.$totalparc;

        $nblocsl = $em->getRepository('BaclooCrmBundle:Locata')
            ->nblocparcsl(); //echo 'nblocsl : '.$nblocsl;

        $devisnonvadparc = $em->getRepository('BaclooCrmBundle:Locata')
            ->devisnonvadparc(); //echo 'devisnonvadparc : '.count($devisnonvadparc);
        $devisnonval = count($devisnonvadparc);

        foreach($devisnonvadparc as $devisnonvadp)
        {
            //echo $devisnonvadp->getClient();
        }

        $devisnonvadsl = $em->getRepository('BaclooCrmBundle:Locata')
            ->devisnonvadsl(); //echo 'devisnonvadsl : '.count($devisnonvadsl);

        $devisnonvalsl = count($devisnonvadsl);

        $dispogenerale = $em->getRepository('BaclooCrmBundle:Machines')
            ->findByEtat('Disponible'); //echo 'dispogenerale : '.count($dispogenerale);
        $dispogene = count($dispogenerale);

        $modules  = $em->getRepository('BaclooCrmBundle:Modules')
            ->findOneByUsername($usersess);

        $offresdumois  = $em->getRepository('BaclooCrmBundle:Locata')
            ->offresdumois();
        $nboffresmois = count($offresdumois);
        $listedispos = array();
        $dstart = new \DateTime(date('Y-m-d'));
        $dend = new \DateTime(date('Y-m-d'));
        $listedispos = array();
        $listecodes = array();

        $gamme = $em->getRepository('BaclooCrmBundle:Machines')
            ->gamme();

        foreach($gamme as $gam)
        {
            $codemachine = $gam['codegenerique'];
            $dispos = $em->getRepository('BaclooCrmBundle:Machines')
                ->dispoparc($codemachine, $dstart, $dend);
            // print_r($dispos);
            // $i = 0;
            // foreach($dispos as $dispo)
            // {//echo 'AAA'.($dispo['code']).'AAA';
            // $dispo = $em->getRepository('BaclooCrmBundle:Machines')
            // ->dispopreciseparc($dispo['code'], $dstart, $dend);
            ////echo 'xxx'.$dispo.'xxx';
            // if(!empty($dispo)){$i = $i + 1;};
            // }

            $listedispos[$codemachine]= count($dispos);
        }


//STATS users
        // ON sort la liste des users concernés
        $query = $em->createQuery(
            'SELECT f.username
				FROM BaclooUserBundle:User f
				WHERE f.roleuser = :hdc
				OR f.roleuser = :admin
				OR f.roleuser = :commercial'
        );
        $query->setParameter('hdc', 'hdc');
        $query->setParameter('admin', 'admin');
        $query->setParameter('commercial', 'commercial');
        $listusers = $query->getResult();
        // print_r($listusers);
        //On prépare le tableau
        $statsusers = array();
        $du = new \DateTime("first day of January");//echo $du->format('Y-m-d');
        foreach($listusers as $list)
        {
            $infos = array();
            // echo $list['username'];
            $infos['user'] = $list['username'];
            $countoffres = $em->getRepository('BaclooCrmBundle:Locata')
                ->countoffres($du, $list['username']);
            $infos['countoffres'] = $countoffres;

            $countcontrats= $em->getRepository('BaclooCrmBundle:Locata')
                ->countcontrats($du, $list['username']);
            $infos['countcontrats'] = $countcontrats;

            $caoffres = $em->getRepository('BaclooCrmBundle:Locata')
                ->caoffres($du, $list['username']);
            $infos['caoffres'] = $caoffres;

            $cacontrats= $em->getRepository('BaclooCrmBundle:Locata')
                ->cacontrats($du, $list['username']);
            $infos['cacontrats'] = $cacontrats;

            $statsusers[] = $infos;

            $vgpafaire = $em->getRepository('BaclooCrmBundle:Machines')
                ->vgpafaire(); //echo 'devisnonvadparc : '.count($devisnonvadparc);
            $nbvgpafaire = count($vgpafaire);
            // print_r($infos);
        }
        // print_r($statsusers);
//FIN stats users
        if($nbpipe > 3 && $modules->getModule2activation() == 0){$nbpipe = 3;}
        $offset = round(12/$nbpipe, 0, PHP_ROUND_HALF_DOWN);
        return $this->render('BaclooCrmBundle:Crm:statcom.html.twig', array(
            'prospot' => $i,
            'datevgp' => $datevgp = date('Y-m-d', strtotime("+35 days")),
            'vgpafaire' => $vgpafaire,
            'nbvgpafaire' => $nbvgpafaire,
            'testfichespipe' => $testfichespipe,
            'fichespipe' => $fichespipe,
            'pipeselect' => $pipeselect,
            'offset' => $offset,
            'nbpipe' => $nbpipe,
            'prev30' => $prev30,
            'nbevents' => $nbevents,
            'cachart' => $cachart,
            'capotbefore' => $capotbefore,
            'caperdubefore' => $caperdubefore,
            'carealbefore' => $carealbefore,
            'ca_pot' => $ca_pot,
            'aff_pot' => $aff_pot,
            'nbperdu' => $nbperdu,
            'ca_perdu' => $ca_perdu,
            'module2activation' => $modules->getModule2activation(),
            'ca_realise' => $ca_realise,
            'nbrealise' => $nbrealise,
            'societe' => $societe,
            'usersessok' => $usersessok,
            'user' => $usersess,
            'listedispos' => $listedispos,
            'roleuser' => $user->getRoleuser(),
            'type' => 'accueil',
            'nblocparc' => $nblocparc,
            'totalparc' => $totalparc,
            'nblocsl' => $nblocsl,
            'devisnonvadparc' => $devisnonvadparc,
            'devisnonval' => $devisnonval,
            'devisnonvadsl' => $devisnonvadsl,
            'devisnonvalsl' => $devisnonvalsl,
            'dispogene' => $dispogene,
            'nboffresmois' => $nboffresmois,
            'statsusers' => $statsusers,
            'nbfiche' => $nbfiche
        ));
    }

    public function accueilAction($dstart, $dend, Request $request)
    {//$id = id ligne partenaire
        $usersess = $this->get('security.context')->getToken()->getUsername(); if(empty($usersess) or !isset($usersess) or $usersess == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}//Récupère le nom d'utilisateur
        $em = $this->getDoctrine()->getManager();
        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($usersess);

        include('societe.php');
        $nomsociete = $societe;
        $session = new Session();
        $session = $request->getSession();
        $usersess = $this->get('security.context')->getToken()->getUsername();
        $em = $this->getDoctrine()->getManager();
        $user  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($usersess);

        // echo 'testfichespipe'.$testfichespipe;
        //Protect double connexion
        $session = $request->getSession();
        $sessionId = $session->getId();
        // echo $sessionId;
        // echo 'xxxxx'.$user->getLogged();
        // echo '  '.$user->getUsername();
        if($user->getLogged() != $sessionId)
        {
            return $this->redirect($this->generateUrl('fos_user_security_logout'));
        }
        //Fin protect double connexion

        // if($user->getRoleuser() != 'admin' && $user->getUsersociete() != null)
        if($user->getRoleuser() != 'admin' && $user->getUsersociete() != $societe)
        {
            $societe = $user->getNomrep();
            // $url = 'http://127.0.0.1/symfony2/web/b/lamiecaline/web/app_dev.php/login';
            $url = 'https://www.bacloo.fr/b/'.$societe.'/web/app.php';
            return $this->redirect($url);
        }

        if($user->getRoleuser() == 'admin' && $user->getUsersociete() != $societe)
        {
            $societe = $user->getNomrep();
            // $url = 'http://127.0.0.1/symfony2/web/b/lamiecaline/web/app_dev.php/login';
            $url = 'https://www.bacloo.fr/b/'.$societe.'/web/app.php';
            return $this->redirect($url);
        }

        if($user->getRoleuser() == 'technicien')
        {
            return $this->redirect($this->generateUrl('bacloocrm_adispatcher'));
        }
        // if($user->getRoleuser() == 'technicien')
        // {
        // return $this->redirect($this->generateUrl('bacloocrm_tcard'));
        // }

        //Ici on met à jour la société au cas l'admin aurait créé sont Bacloo perso après avoir importé son fichier
        // if($user->getRoleuser() == 'admin')
        // {
        // $fiches = $em->getRepository('BaclooCrmBundle:Fiche')
        // ->findBy(array('user' => $usersess, 'usersociete' => NULL));
        // if(isset($fiche) && $fiches->getUsersociete() != $societe)
        // {
        // $fichesok = $em->getRepository('BaclooCrmBundle:Fiche')
        // ->find($usersess);
        // foreach($fichesok as $fiche)
        // {
        // set_time_limit(300);
        // $fiche->setUsersociete($societe);
        // $em->persist($fiche);
        // }
        // $em->flush();
        // }

        // }
        $defaultData = array();
        $form = $this->createFormBuilder($defaultData)
            ->add('du', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => false,
                'attr' => array('class' => 'date'),
            ))
            ->add('au', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => false,
                'attr' => array('class' => 'date'),
            ))
            ->getForm();//echo $request->getMethod();
        if($request->getMethod() == 'POST') {// 'VALIDE';
            $form->handleRequest($request);
            $data = $form->getData();//var_dump($data);
            if(isset($data['du']))
            {//echo 'aaa';
                $dstart = $data['du'];
            }
            if(isset($data['au']))
            {
                $dend = $data['au'];
            }
            $search = 1;
        }
// echo 'dend '.$dEnd;
        if($dstart == 0)
        {
            $dstart = date('Y-m-d', strtotime("-6 months"));
        }

        if($dend == 0)
        {
            $dend = date('Y-m-d');
        }

        if($user->getRoleuser() != 'admin'){$useracc = $usersess;}
        if(isset($useracc))
        {
            if($useracc == 'societe')
            {
                //On calcule critères
                $i = 1;
                $em = $this->getDoctrine()->getManager();
                $listuser = $em->getRepository('BaclooUserBundle:User')
                    ->findBy(array('usersociete' => $societe));
                foreach($listuser as $listu)
                {
                    ${'choix'.$i++} = $listu->getUsername();
                }
                //echo 'choix1'.$choix1;
                $critere = array($usersess);

                for($j=1;$j<$i;$j++)
                {
                    ${'critere'.$j} = array(${"choix".$j});
                    $critere = array_merge(${'critere'.$j},$critere);
                }
                $usersessok = $critere;
            }
            else
            {
                $usersessok = $useracc;
            }
        }
        else
        {
            $usersessok = $usersess;
        }

        if($usersess == 'anon.')
        {
            return $this->redirect($this->generateUrl('fos_user_security_login'));
        }

        $em = $this->getDoctrine()->getManager();
        $user  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($usersess);
// echo '111'.$usersess;
        if($user->getRoleuser() != 'admin')
        {
            $userdetails  = $em->getRepository('BaclooUserBundle:User')
                ->findOneBy(array('roleuser'=> 'admin', 'usersociete' => $societe));
            // $usersess = $userdetails->getUsername();
        }
// echo '222'.$usersess;
        $query = $em->createQuery(
            'SELECT u.id
					FROM BaclooUserBundle:User u
					WHERE u.username = :username'
        )->setParameter('username', $usersess);
        $uid = $query->getSingleScalarResult();
        //On regarde si l'utilisateur connecté est déja entegistré dnas la table userpipe
        $userpipe = $em->getRepository('BaclooCrmBundle:Userpipe')
            ->findOneByUserid($uid);

        //On récupère les pipelines de l'utilisateur connecté
        $em2 = $this->getDoctrine()
            ->getManager()
            ->getRepository('BaclooCrmBundle:Pipeline');
        $pipe = $em2->findByUsername($usersess);

        $pipe_zero = $em->getRepository('BaclooCrmBundle:Pipeline')
            ->findByPipeorder(0);

        //On récupère les userpipe du user connecté
        $em2 = $this->getDoctrine()
            ->getManager()
            ->getRepository('BaclooCrmBundle:Userpipe');
        $userpipa = $em2->findOneByUserid($uid);

        if(empty($userpipa))
        {
            // echo 'pppppppooo'.$uid;
            $userpipe = new userpipe();
            $userpipe->setUserid($uid);
            $em = $this->getDoctrine()->getManager();
            $em->persist($userpipe);
            $em->flush();

            $em2 = $this->getDoctrine()
                ->getManager()
                ->getRepository('BaclooCrmBundle:Userpipe');
            $userpipo = $em2->findOneByUserid($uid);

            $pipe0 = new pipeline();
            $pipe0->setUserid($uid);
            $pipe0->setUsername($usersess);
            $pipe0->setPipename('---------');
            $pipe0->setPipeorder(0);
            $pipe0->addUserpipe($userpipo);
            $userpipo->addPipeline($pipe0);
            $em->persist($pipe0);
            $em->persist($userpipo);
            $em->flush();

            $pipe0 = new pipeline();
            $pipe0->setUserid($uid);
            $pipe0->setUsername($usersess);
            $pipe0->setPipename('Devis fait');
            $pipe0->setPipeorder(1);
            $pipe0->addUserpipe($userpipo);
            $userpipo->addPipeline($pipe0);
            $em->persist($pipe0);
            $em->persist($userpipo);
            $em->flush();

            $pipe0 = new pipeline();
            $pipe0->setUserid($uid);
            $pipe0->setUsername($usersess);
            $pipe0->setPipename('Affaires signées');
            $pipe0->setPipeorder(2);
            $pipe0->setRealise(true);
            $pipe0->addUserpipe($userpipo);
            $userpipo->addPipeline($pipe0);
            $em->persist($pipe0);
            $em->persist($userpipo);
            $em->flush();

            $pipe0 = new pipeline();
            $pipe0->setUserid($uid);
            $pipe0->setUsername($usersess);
            $pipe0->setPipename('Affaires perdues');
            $pipe0->setPipeorder(3);
            $pipe0->setPerdu(true);
            $pipe0->setExclusion(true);
            $pipe0->addUserpipe($userpipo);
            $userpipo->addPipeline($pipe0);
            $em->persist($pipe0);
            $em->persist($userpipo);
            $em->flush();
        }
        else
        {
            $pipe_zero = $em->getRepository('BaclooCrmBundle:Pipeline')
                ->findByPipeorder(0);
            if(empty($pipe_zero))
            {
                $em2 = $this->getDoctrine()
                    ->getManager()
                    ->getRepository('BaclooCrmBundle:Userpipe');
                $userpipo = $em2->findOneByUserid($uid);

                $pipe0 = new pipeline();
                $pipe0->setUserid($uid);
                $pipe0->setUsername($usersess);
                $pipe0->setPipename('---------');
                $pipe0->setPipeorder(0);
                $pipe0->addUserpipe($userpipo);
                $userpipo->addPipeline($pipe0);
                $em->persist($pipe0);
                $em->persist($userpipo);
                $em->flush();
            }
        }

        $query = $em->createQuery(
            'SELECT p
				FROM BaclooCrmBundle:Pipeline p
				WHERE p.username = :username
				AND p.pipeorder > :pipeorder
				ORDER BY p.pipeorder ASC'
        )->setParameter('username', $usersess)
            ->setParameter('pipeorder', 0);

        $pipeselect = $query->getResult();

        $nbpipe = count($pipeselect);
        if($nbpipe == 0){$nbpipe = 1;}
        $offset = round(12/$nbpipe, 0, PHP_ROUND_HALF_DOWN);

        $today = date('Y-m-d');
        $prev30 = date('Y-m-d', strtotime("-29 days"));

        if(is_array($usersessok) == 1)
        {
            $fichespipe = $em->getRepository('BaclooCrmBundle:Fiche')
                ->createpiplinearray($usersessok);

            $em = $this->getDoctrine()->getManager();
            $nbevents  = $em->getRepository('BaclooCrmBundle:Fiche')
                ->last30eventarray($usersessok, $today, $prev30);

            $capotbefore  = $em->getRepository('BaclooCrmBundle:Fiche')
                ->before30capotarray($usersess, $prev30);
            if(empty($capotbefore)){$capotbefore = 0;}
            // echo 'capotbefore'.$capotbefore;
            $carealbefore  = $em->getRepository('BaclooCrmBundle:Fiche')
                ->before30carealarray($usersess, $prev30);
            if(empty($carealbefore)){$carealbefore = 0;}

            $caperdubefore  = $em->getRepository('BaclooCrmBundle:Fiche')
                ->before30caperduarray($usersess, $prev30);
            if(empty($caperdubefore)){$caperdubefore = 0;}

            $cachart  = $em->getRepository('BaclooCrmBundle:Ca')
                ->last30caarray($usersess, $today, $prev30);
        }
        else
        {
            $fichespipe = $em->getRepository('BaclooCrmBundle:Fiche')
                ->createpipline($usersessok);

            $em = $this->getDoctrine()->getManager();
            $nbevents  = $em->getRepository('BaclooCrmBundle:Fiche')
                ->last30event($usersessok, $today, $prev30);

            $capotbefore  = $em->getRepository('BaclooCrmBundle:Fiche')
                ->before30capot($usersessok, $prev30);
            if(empty($capotbefore)){$capotbefore = 0;}
            // echo 'capotbefore'.$capotbefore;
            $carealbefore  = $em->getRepository('BaclooCrmBundle:Fiche')
                ->before30careal($usersessok, $prev30);
            if(empty($carealbefore)){$carealbefore = 0;}

            $caperdubefore  = $em->getRepository('BaclooCrmBundle:Fiche')
                ->before30caperdu($usersessok, $prev30);
            if(empty($caperdubefore)){$caperdubefore = 0;}

            $cachart  = $em->getRepository('BaclooCrmBundle:Ca')
                ->last30ca($usersessok, $today, $prev30);
        }

        if(empty($fichespipe))
        {
            $testfichespipe = 0;
            $ca_pot = 0;
            $aff_pot = 0;
            $nbperdu = 0;
            $ca_perdu = 0;
            $nbrealise = 0;
            $ca_realise = 0;
        }
        else
        {
            $testfichespipe = 1;
            $ca_pot = 0;
            $aff_pot = 0;
            $nbperdu = 0;
            $ca_perdu = 0;
            $nbrealise = 0;
            $ca_realise = 0;
            foreach($fichespipe as $fp)
            {
                if($fp->getPipeline()->getExclusion() == 0)
                {
                    $ca_pot = $ca_pot + $fp->getPotentiel();
                }
                if($fp->getPipeline()->getRealise() == 1)
                {
                    $ca_realise = $ca_realise + $fp->getPotentiel();
                }
                if($fp->getPipeline()->getPerdu() == 1)
                {
                    $ca_perdu = $ca_perdu + $fp->getPotentiel();
                }
            }
        }



        $userdetails = $user;



//Gros check des modules
        $credits = $userdetails->getCredits();

        $listmodalerte = 0;// pour lister les modules en alerte expiration
        $comptemodalerte = 0;// pour compter les modules en  alerte
        $listmodarret = 0;// pour lister les modules en alerte expiration
        $comptemodarret = 0;// pour compter les modules en  alerte

        $modules  = $em->getRepository('BaclooCrmBundle:Modules')
            ->findOneByUsername($usersess);
        // echo $usersess;
        $moda = $em->getRepository('BaclooCrmBundle:Moda')
            ->findOneBySociete('1234');

        if(empty($moda))
        {
            $moda = new moda();
            $moda->setSociete('1234');
            $em = $this->getDoctrine()->getManager();
            $em->persist($moda);
        }

        $userprix = 3;
        if(empty($modules))
        {//echo 'oooooooooooooooooooooooo';
            if($user->getRoleuser() == 'admin')
            {//echo 'sssssssssssssssssss';
                $modules = new Modules();
                $modules->setUserprix($userprix);
                $modules->setUserdebut(date('d/m/Y'));
                $modules->setUserexpiration('illimité');
                $modules->setBbuseractivation(1);
                $modules->setUsersociete($nomsociete);
                $modules->setModule1('Partage rapide des fiches');
                $modules->setModule1prix(1);
                $modules->setModule1debut(date('25/12/2016'));
                $modules->setModule1expiration('15/01/2017');
                $modules->setModule1activation(0);
                $modules->setModule2('Pipeline des ventes');
                $modules->setModule2prix(2);
                $modules->setModule2debut(date('30/11/2016'));
                $modules->setModule2expiration('31/12/2016');
                $modules->setModule2activation(0);
                $modules->setModule3('Bloc devis et commandes');
                $modules->setModule3prix(1);
                $modules->setModule3debut(date('30/11/2016'));
                $modules->setModule3expiration('31/12/2017');
                $modules->setModule3activation(0);
                $modules->setModule4('Recherche avancée');
                $modules->setModule4prix(1);
                $modules->setModule4debut(date('25/12/2016'));
                $modules->setModule4expiration('15/01/2017');
                $modules->setModule4activation(0);
                $modules->setModule5('Synchronisation avec agenda');
                $modules->setModule5prix(1);
                $modules->setModule5debut(date('30/11/2016'));
                $modules->setModule5expiration('31/12/2020');
                $modules->setModule5activation(0);
                $modules->setModule6('Fiches fournisseurs');
                $modules->setModule6prix(1);
                $modules->setModule6debut(date('25/12/2016'));
                $modules->setModule6expiration('15/01/2017');
                $modules->setModule6activation(0);
                $modules->setModule7('Google Docs');
                $modules->setModule7prix(1);
                $modules->setModule7debut(date('25/12/2016'));
                $modules->setModule7expiration('15/01/2017');
                $modules->setModule7activation(0);
                $modules->setModule8('Collègues : Partage de fiches');
                $modules->setModule8prix(0);
                $modules->setModule8debut(date('30/11/2016'));
                $modules->setModule8expiration('31/12/2020');
                $modules->setModule8activation(1);
                $modules->setModule9('Annuaire');
                $modules->setModule9prix(45);
                $modules->setModule9debut(date('25/12/2016'));
                $modules->setModule9expiration('15/01/2017');
                $modules->setModule9activation(0);
                $modules->setModule10('Bacloo Illimité');
                $modules->setModule10prix(3);
                $modules->setModule10debut(date('25/12/2016'));
                $modules->setModule10expiration('15/01/2017');
                $modules->setModule10activation(1);
                $modules->setModule11('Speed menu');
                $modules->setModule11prix(1);
                $modules->setModule11debut(date('25/12/2016'));
                $modules->setModule11expiration('15/01/2017');
                $modules->setModule11activation(1);
                $modules->setModule11('Compte-rendu activité');
                $modules->setModule12prix(1);
                $modules->setModule12debut(date('25/12/2016'));
                $modules->setModule12expiration('15/01/2017');
                $modules->setModule12activation(0);
                $modules->setUserid($user->getId());
                $modules->setUsername($usersess);
                // $modules->setUsersociete();
                $modules->addModa($moda);
                $moda->addModule($modules);
                $em->persist($modules);
                $em->persist($moda);
                $em->flush();
            }
            else
            {
                $modules = new Modules();
                $modules->setUserprix($userprix);
                $modules->setUserdebut(date('d/m/Y'));
                $modules->setUserexpiration('illimité');
                $modules->setBbuseractivation(0);
                $modules->setUsersociete($nomsociete);
                $modules->setUserid($user->getId());
                $modules->setUsername($usersess);
                $modules->setModule1('Partage rapide des fiches');
                $modules->setModule1prix(1);
                $modules->setModule1debut(date('25/12/2016'));
                $modules->setModule1expiration('15/01/2017');
                $modules->setModule1activation(0);
                $modules->setModule2('Pipeline des ventes');
                $modules->setModule2prix(2);
                $modules->setModule2debut(date('25/12/2016'));
                $modules->setModule2expiration('15/01/2017');
                $modules->setModule2activation(0);
                $modules->setModule3('Bloc devis et commandes');
                $modules->setModule3prix(1);
                $modules->setModule3debut(date('25/12/2016'));
                $modules->setModule3expiration('15/01/2017');
                $modules->setModule3activation(0);
                $modules->setModule4('Recherche avancée');
                $modules->setModule4prix(1);
                $modules->setModule4debut(date('25/12/2016'));
                $modules->setModule4expiration('15/01/2017');
                $modules->setModule4activation(0);
                $modules->setModule5('Synchronisation avec agenda');
                $modules->setModule5prix(1);
                $modules->setModule5debut(date('25/12/2016'));
                $modules->setModule5expiration('15/01/2017');
                $modules->setModule5activation(0);
                $modules->setModule6('Fiches fournisseurs');
                $modules->setModule6prix(1);
                $modules->setModule6debut(date('25/12/2016'));
                $modules->setModule6expiration('15/01/2017');
                $modules->setModule6activation(0);
                $modules->setModule7('Google Docs');
                $modules->setModule7prix(1);
                $modules->setModule7debut(date('25/12/2016'));
                $modules->setModule7expiration('15/01/2017');
                $modules->setModule7activation(0);
                $modules->setModule8('Collègues : Partage de fiches');
                $modules->setModule8prix(1);
                $modules->setModule8debut(date('25/12/2016'));
                $modules->setModule8expiration('15/01/2017');
                $modules->setModule8activation(0);
                $modules->setModule9('Annuaire');
                $modules->setModule9prix(45);
                $modules->setModule9debut(date('25/12/2016'));
                $modules->setModule9expiration('15/01/2017');
                $modules->setModule9activation(0);
                $modules->setModule10('Bacloo Illimité');
                $modules->setModule10prix(3);
                $modules->setModule10debut(date('25/12/2016'));
                $modules->setModule10expiration('15/01/2017');
                $modules->setModule10activation(0);
                $modules->setModule11('Speed menu');
                $modules->setModule11prix(1);
                $modules->setModule11debut(date('25/12/2016'));
                $modules->setModule11expiration('15/01/2017');
                $modules->setModule11activation(0);
                $modules->setModule12('Compte-rendu activité');
                $modules->setModule12prix(1);
                $modules->setModule12debut(date('25/12/2016'));
                $modules->setModule12expiration('15/01/2017');
                $modules->setModule12activation(0);
                // $modules->setUsersociete();
                $modules->addModa($moda);
                $moda->addModule($modules);
                $em->persist($modules);
                $em->persist($moda);
                $em->flush();
            }
        }
//Controle validité de tous les moduels

        $modulesuser  = $em->getRepository('BaclooCrmBundle:Modules')
            ->findOneByUsername($usersess);

        if($modulesuser->getBbuseractivation() == 0 && $user->getRoleuser() != 'admin')
        {
            // $request->getSession()
            // ->getFlashBag()
            // ->add('fail', 'Votre compte n\'a pas encore été activé par l\'administrateur');
            return $this->redirect($this->generateUrl('fos_user_security_logout'));
        }


        include('checkmodule1.php');
        include('checkmodule2.php');
        include('checkmodule3.php');
        include('checkmodule4.php');
        include('checkmodule5.php');
        include('checkmodule6.php');
        include('checkmodule7.php');
        include('checkmodule8.php');
        include('checkmodule9.php');
        include('checkmodule10.php');
        include('checkmodule11.php');
        include('checkmodule12.php');

        $today = date('Y-m-d');

// echo 'aaaa'.$listmodalerte;
// echo 'arret'.$comptemodarret;
// echo 'alerte'.$comptemodalerte;

        if($comptemodarret != 0 && $comptemodalerte != 0 && $modules->getDatemailalerte() <> $today)
        {
// echo 'xxxxxxx';
            //envoyer un mail à l'admin  indiquant que module désactivé faute de crédits
            // Récupération du service
            $mailer = $this->get('mailer');

            $message = \Swift_Message::newInstance()
                ->setSubject($userdetails->getPrenom(). ' : '.$comptemodarret.' modules en arrêt et '.$comptemodalerte.' modules qui s\'arrêtent dans 5 jours')
                ->setFrom(array('bacloo@bacloo.fr' => 'Bacloo CRM'))
                ->setTo($userdetails->getEmail())
                ->setBody($this->renderView('BaclooCrmBundle:Crm:bbalerte_user.html.twig', array('prenom'	=> $userdetails->getPrenom(),
                    'user'	=> $usersess,
                    'comptemodarret'	=> $comptemodarret,
                    'comptemodalerte'	=> $comptemodalerte,
                    'mode' => 'module'
                )))
            ;
            $mailer->send($message);

            $mailer = $this->get('mailer');

            $message = \Swift_Message::newInstance()
                ->setSubject($userdetails->getPrenom(). ' : '.$comptemodarret.' modules en arrêt et '.$comptemodalerte.' modules qui s\'arrêtent dans 5 jours')
                ->setFrom(array('bacloo@bacloo.fr' => 'Bacloo CRM'))
                ->setTo('ringuetjm@gmail.com')
                ->setBody($this->renderView('BaclooCrmBundle:Crm:bbalerte_user.html.twig', array('prenom'	=> $userdetails->getPrenom(),
                    'user'	=> $usersess,
                    'comptemodarret'	=> $comptemodarret,
                    'comptemodalerte'	=> $comptemodalerte,
                    'mode' => 'module'
                )))
            ;
            $mailer->send($message);

            // $modules->setDatemailalerte($today);
            // $modules->setDatemailarret($today);

            // Fin partie envoi mail
        }
        elseif($comptemodarret > 0 && $comptemodalerte < 1 && $modules->getDatemailarret() <> $today)
        {
//echo 'b'.$listmodalerte;
            //envoyer un mail à l'admin  indiquant que module désactivé faute de crédits
            // Récupération du service
            $mailer = $this->get('mailer');

            $message = \Swift_Message::newInstance()
                ->setSubject($userdetails->getPrenom(). ' : '.$comptemodarret.' modules en arrêt')
                ->setFrom(array('bacloo@bacloo.fr' => 'Bacloo CRM'))
                ->setTo($userdetails->getEmail())
                ->setBody($this->renderView('BaclooCrmBundle:Crm:bbalerte_user.html.twig', array('prenom'	=> $userdetails->getPrenom(),
                    'user'	=> $usersess,
                    'comptemodarret'	=> $comptemodarret,
                    'mode' => 'modules_arret'
                )))
            ;
            $mailer->send($message);

            $mailer = $this->get('mailer');

            $message = \Swift_Message::newInstance()
                ->setSubject($userdetails->getPrenom(). ' : '.$comptemodarret.' modules en arrêt')
                ->setFrom(array('bacloo@bacloo.fr' => 'Bacloo CRM'))
                ->setTo('ringuetjm@gmail.com')
                ->setBody($this->renderView('BaclooCrmBundle:Crm:bbalerte_user.html.twig', array('prenom'	=> $userdetails->getPrenom(),
                    'user'	=> $usersess,
                    'comptemodarret'	=> $comptemodarret,
                    'mode' => 'modules_arret'
                )))
            ;
            $mailer->send($message);

            $modules->setDatemailalerte($today);
            $modules->setDatemailarret($today);

            // Fin partie envoi mail
        }
        elseif($comptemodarret < 1 && $comptemodalerte > 0 && $modules->getDatemailalerte() <> $today)
        {
// echo 'c'.$listmodalerte;
            //envoyer un mail à l'admin  indiquant que module désactivé faute de crédits
            // Récupération du service
            // $mailer = $this->get('mailer');

            // $message = \Swift_Message::newInstance()
            // ->setSubject($userdetails->getPrenom(). ' : '.$comptemodalerte.' modules qui s arrêtent dans 5 jours '.$listmodalerte)
            // ->setFrom(array('bacloo@bacloo.fr' => 'Bacloo CRM'))
            // ->setTo($userdetails->getEmail())
            // ->setBody($this->renderView('BaclooCrmBundle:Crm:bbalerte_user.html.twig', array('prenom'	=> $userdetails->getPrenom(),
            // 'user'	=> $usersess,
            // 'comptemodalerte'	=> $comptemodalerte,
            // 'mode' => 'modules_alerte'
            // )))
            // ;
            // $mailer->send($message);

            // $mailer = $this->get('mailer');

            // $message = \Swift_Message::newInstance()
            // ->setSubject($userdetails->getPrenom(). ' : '.$comptemodalerte.'modules qui s arrêtent dans 5 jours '.$listmodalerte)
            // ->setFrom(array('bacloo@bacloo.fr' => 'Bacloo CRM'))
            // ->setTo('ringuetjm@gmail.com')
            // ->setBody($this->renderView('BaclooCrmBundle:Crm:bbalerte_user.html.twig', array('prenom'	=> $userdetails->getPrenom(),
            // 'user'	=> $usersess,
            // 'comptemodalerte'	=> $comptemodalerte,
            // 'mode' => 'modules_alerte'
            // )))
            // ;
            // $mailer->send($message);

            // $modules->setDatemailalerte($today);
            // $modules->setDatemailarret($today);

            // Fin partie envoi mail
        }
        $em->flush();

        $modules  = $em->getRepository('BaclooCrmBundle:Modules')
            ->findOneByUsername($usersess);
        if($nbpipe > 3 && $modules->getModule2activation() == 0){$nbpipe = 3;}

        // if($user->getTypeuser() == 'entreprise' && $avant == 'http://127.0.0.1/symfony2/web/app_dev.php/login')
        if($user->getTypeuser() == 'entreprise' && $avant == 'https://www.bacloo.fr/login')
        {
            return $this->redirect($this->generateUrl('bacloocrm_bb'));
            // echo 'YYYYYYYYY'.$avant;
        }
        return $this->render('BaclooCrmBundle:Crm:accueil.html.twig', array(
            'userdetails'=> $userdetails,
            'dstart'=> $dstart,
            'dend'=> $dend
        ));
    }

    Public function comptadefrattrapageAction()
    {
        $em = $this->getDoctrine()->getManager();
        $facture  = $em->getRepository('BaclooCrmBundle:Factures')
            ->findAll();
        foreach($facture as $fact)
        {
            $mystring = $fact->getCodelocata();
            $findme   = 'H';
            $pos = strpos($mystring, $findme);
//            if($pos === false)
//            {
//                $selection = $fact->getSelection();//echo '+++'.$selection.'+++';
//                $codecontrat = $fact->getLocatacloneid();
//                $clientid = $fact->getClientid();
//                $numfacture = $fact->getNumfacture();
//                echo 'CODeCONtrAt';echo $fact->getCodelocata();
//                echo 'CODeCONtrAtV';echo $fact->getLocatacloneid();
//                if($fact->getCodelocata() == 'V-'.$fact->getLocatacloneid())
//                {
//                    $doc = 'ventes';
//                    $venda = $em->getRepository('BaclooCrmBundle:Venda')
//                        ->findOneById($codecontrat);
//                }
//                else
//                {
//                    $doc = 'locations';
//                    $locata = $em->getRepository('BaclooCrmBundle:Locataclone')
//                        ->findOneById($codecontrat);
//                }
//                $typeachat = 'nok';
//                if($fact->getCodelocata() == 'H-'.$fact->getLocatacloneid())
//                {
//                    $locatafrs = $em->getRepository('BaclooCrmBundle:Locatafrs')
//                        ->findOneById($codecontrat);
//                    $typeachat = 'normal';
//                    $doc = 'achat';//echo 'YYYYYYYYYYYYYYY';
//                }
//                else
//                {
//                    $locatafrs = $em->getRepository('BaclooCrmBundle:Locatafrsclone')
//                        ->findOneById($codecontrat);
//                    $typeachat = 'sousloc';
//                    // echo 'VVVVVVVVVVVVVVV';
//                }
//                echo 'codecontrat'.$codecontrat;
//
//                $machines = $em->getRepository('BaclooCrmBundle:Machines')
//                    ->findAll();
//
//                $machinessl = $em->getRepository('BaclooCrmBundle:Machinessl')
//                    ->findAll();
//
//                $facture  = $em->getRepository('BaclooCrmBundle:Factures')
//                    ->findOneByNumfacture($numfacture);
//
//                $clients  = $em->getRepository('BaclooCrmBundle:Fiche')
//                    ->findOneById($clientid);
//                //echo 'ttttt';echo $this->getRequest()->request->get('definitif');
//
//                echo ' XXXX'.$doc;
//                if($doc == 'ventes' or $doc == 'locations' and $fact->getTotalttc() > 0)
//                {//echo 'on def';
//                    include('facturationmensuelledefinitivehard.php');
//                    $fact->setSelection(0);
//                    $em->flush();
//                }
//            }
//            else
//            {
                echo 'ACHAT';
                $selection = $fact->getSelection();//echo '+++'.$selection.'+++';
                $codecontrat = $fact->getLocatacloneid();
                $clientid = $fact->getClientid();
                $numfacture = $fact->getNumfacture();
                echo 'CODeCONtrAt';echo $fact->getCodelocata();
                echo 'CODeCONtrAtV';echo $fact->getLocatacloneid();
//                if($fact->getCodelocata() == 'V-'.$fact->getLocatacloneid())
//                {
//                    $doc = 'ventes';
//                    $venda = $em->getRepository('BaclooCrmBundle:Venda')
//                        ->findOneById($codecontrat);
//                }
//                else
//                {
//                    $doc = 'locations';
//                    $locata = $em->getRepository('BaclooCrmBundle:Locataclone')
//                        ->findOneById($codecontrat);
//                }
                $typeachat = 'nok';
                if($fact->getCodelocata() == 'H-'.$fact->getLocatacloneid())
                {
                    $locatafrs = $em->getRepository('BaclooCrmBundle:Locatafrs')
                        ->findOneById($codecontrat);
                    $typeachat = 'normal';
                    $doc = 'achat';//echo 'YYYYYYYYYYYYYYY';
                }
                else
                {
                    $locatafrs = $em->getRepository('BaclooCrmBundle:Locatafrsclone')
                        ->findOneById($codecontrat);
                    $typeachat = 'sousloc';
                    $doc = 'achat';// echo 'VVVVVVVVVVVVVVV';
                }
                echo 'codecontrat'.$codecontrat;

                $machines = $em->getRepository('BaclooCrmBundle:Machines')
                    ->findAll();

                $machinessl = $em->getRepository('BaclooCrmBundle:Machinessl')
                    ->findAll();

                $facture  = $em->getRepository('BaclooCrmBundle:Factures')
                    ->findOneByNumfacture($numfacture);

                $clients  = $em->getRepository('BaclooCrmBundle:Fiche')
                    ->findOneById($clientid);
                //echo 'ttttt';echo $this->getRequest()->request->get('definitif');

//                echo ' XXXX'.$doc;
//                if($doc == 'ventes' or $doc == 'locations' and $fact->getTotalttc() > 0)
//                {//echo 'on def';
                    include('facturationmensuelledefinitivehard.php');
                    $fact->setSelection(0);
                    $em->flush();
//                }
//            }
        }
        return $this->redirect($this->generateUrl('bacloocrm_compta', array('vue' => 'locations')));
    }

    Public function removemachineAction($ecode, $typeloc, $codecontrat)
    {
        $em = $this->getDoctrine()->getManager();
        if($typeloc == 'parc')
        {
            $machine  = $em->getRepository('BaclooCrmBundle:Machines')
                ->findOneBy(array('code' => $ecode, 'codecontrat' => $codecontrat));

            $locata = $em->getRepository('BaclooCrmBundle:Locata')
                ->findOneById($codecontrat);

            if(!isset($machine))
            {
                foreach($locata->getLocations() as $locat)
                {
                    if($locat->getCodemachineinterne() == $ecode)
                    {
                        $codelocation = $locat->getId();
                    }
                }
                $locations  = $em->getRepository('BaclooCrmBundle:Locations')
                    ->findOneById($codelocation);
            }
            else
            {
                $codelocation = $machine->getCodelocations();
                $locations  = $em->getRepository('BaclooCrmBundle:Locations')
                    ->findOneById($codelocation);
                if($machine->getOriginal() == 0)
                {
                    $em->remove($machine);
                }
                else
                {
                    $machine->setEtat('Disponible');
                    $machine->setDebutloc('');
                    $machine->setFinloc('');
                    $machine->setEntreprise('');
                    $machine->setNomchantier('');
                    $machine->setcodelocations('');
                    $machine->setcodecontrat('');
                    $machine->setClientid(0);
                    $em->persist($machine);
                }
            }
            $locations  = $em->getRepository('BaclooCrmBundle:Locations')
                ->findOneById($codelocation);

            $ficheid = $locations->getCodeclient();



            // $em->remove($locations);
            $locations->setMachineid(0);
            $locations->setCodemachineinterne('');
            $locations->setEtatloc('');
            $locations->setEtatlog('');
            $em->persist($locations);

            $locata->setBdcrecu(0);
            $locata->setContrat(0);
            $em->persist($locata);

            $logistiqueliv  = $em->getRepository('BaclooCrmBundle:Logistique')
                ->findOneBy(array('codelocations' => $codelocation, 'codecontrat' => $codecontrat, 'materiel' => $ecode));
            if(!empty($logistiqueliv))
            {
                $em->remove($logistiqueliv);
            }

            $logistique  = $em->getRepository('BaclooCrmBundle:Logistiquerep')
                ->findOneByMateriel($ecode);

            if(isset($logistique))
            {
                $em->remove($logistique);
            }
            $em->flush();
        }
        elseif($typeloc == 'sl')
        {
            $machine  = $em->getRepository('BaclooCrmBundle:Machinessl')
                ->findOneBy(array('id' => $ecode, 'codecontrat' => $codecontrat));
            $locata = $em->getRepository('BaclooCrmBundle:Locata')
                ->findOneById($codecontrat);
            $locatafrs = $em->getRepository('BaclooCrmBundle:Locatafrs')
                ->findOneByCodelocatasl($codecontrat);
            if(isset($locatafrs))
            {
                foreach($locatafrs->getLocationsfrs() as $loco)
                {
                    $em->remove($loco);
                }
            }

            if(!isset($machine))
            {
                foreach($locata->getLocationssl() as $locat)
                {
                    if($locat->getCodemachineinterne() == $ecode)
                    {
                        $codelocation = $locat->getId();
                    }
                }
            }
            else
            {
                $codelocation = $machine->getCodelocations();
                if($machine->getOriginal() == 0)
                {
                    $em->remove($machine);
                }
                else
                {
                    $machine->setEtat('Disponible');
                    $machine->setDebutloc('');
                    $machine->setFinloc('');
                    $machine->setEntreprise('');
                    $machine->setNomchantier('');
                    $machine->setcodelocations('');
                    $machine->setcodecontrat('');
                    $machine->setClientid(0);
                    $em->persist($machine);
                }
            }
            $locations  = $em->getRepository('BaclooCrmBundle:Locationssl')
                ->findOneById($codelocation);

            $ficheid = $locations->getCodeclient();

            // $em->remove($locations);
            $locations->setMachineid(0);
            $locations->setCodemachineinterne('');
            $locations->setEtatloc('');
            $locations->setEtatlog('');
            $em->persist($locations);

            $locata->setBdcrecu(0);
            $locata->setContrat(0);
            $em->persist($locata);

            $logistiqueliv  = $em->getRepository('BaclooCrmBundle:Logistique')
                ->findOneBy(array('codelocations' => $codelocation, 'codecontrat' => $codecontrat, 'materiel' => $ecode));
            if(!empty($logistiqueliv))
            {
                $em->remove($logistiqueliv);
            }

            $logistique  = $em->getRepository('BaclooCrmBundle:Logistiquerep')
                ->findOneByMateriel($ecode);

            if(isset($logistique))
            {
                $em->remove($logistique);
            }
            $em->flush();
        }
        return $this->redirect($this->generateUrl('bacloocrm_ajouterlocation', array('ficheid' => $ficheid, 'locid' => $codecontrat )));
    }

    public function removecontratAction($id, $codecontrat, $mode)
    {
        //$id  = fiche id
        //$raison = raison sociale de l'E
        //Mode permet de savoir s'il s'agit d'un contrat de vente ou de location
        $em = $this->getDoctrine()->getManager();
        $previous = $this->get('request')->server->get('HTTP_REFERER');

        if($mode == 'location')
        {
            $contrat  = $em->getRepository('BaclooCrmBundle:Locata')
                ->findOneById($codecontrat);

            $facture  = $em->getRepository('BaclooCrmBundle:Factures')
                ->findOneByCodelocata($codecontrat);

            if(empty($facture))
            {
                if($contrat->getContrat() != 1 && $contrat->getBdcrecu() != 1)
                {
                    if(null !== $contrat->getLocations())
                    {
                        foreach($contrat->getLocations() as $loca)
                        {
                            $em->remove($loca);
                        }
                    }

                    if(null !== $contrat->getLocationssl())
                    {
                        foreach($contrat->getLocationssl() as $loca)
                        {
                            $em->remove($loca);
                        }
                    }
                    $em->remove($contrat);
                    $em->flush();
                }
                elseif($contrat->getContrat() == 1 or $contrat->getBdcrecu() == 1)
                {
                    if(null !== $contrat->getLocations())
                    {
                        foreach($contrat->getLocations() as $loca)
                        {
                            if(null !== $loca->getCodemachineinterne())
                            {
                                $machine = $em->getRepository('BaclooCrmBundle:Machines')
                                    ->findOneBy(array('code' => $loca->getCodemachineinterne(), 'codecontrat' => $codecontrat));

                                if(isset($machine) && $machine->getOriginal() == 0)
                                {
                                    $em->remove($machine);
                                }
                                elseif(isset($machine) && $machine->getOriginal() == 1)
                                {
                                    $machine->setCodelocations(NULL);
                                    $machine->setCodecontrat(NULL);
                                    $machine->setClientid(0);
                                    $machine->setEntreprise(NULL);
                                    $machine->setNomchantier(NULL);
                                    $machine->setDebutloc(NULL);
                                    $machine->setFinloc(NULL);
                                    $machine->setEtat('Disponible');
                                    $em->persist($machine);
                                }

                                $logistique = $em->getRepository('BaclooCrmBundle:Logistique')
                                    ->findOneBy(array('materiel' => $loca->getCodemachineinterne(), 'codecontrat' => $codecontrat));
                                if(!empty($logistique)){$em->remove($logistique);}

                                $logistiquerep = $em->getRepository('BaclooCrmBundle:Logistiquerep')
                                    ->findOneBy(array('materiel' => $loca->getCodemachineinterne(), 'codecontrat' => $codecontrat));
                                if(!empty($logistiquerep)){$em->remove($logistiquerep);}
                            }
                            $em->remove($loca);
                        }
                    }

                    if(null !== $contrat->getLocationssl())
                    {
                        foreach($contrat->getLocationssl() as $loca)
                        {
                            if(null !== $loca->getCodemachineinterne())
                            {
                                $machine = $em->getRepository('BaclooCrmBundle:Machinessl')
                                    ->findOneBy(array('code' => $loca->getCodemachineinterne(), 'codecontrat' => $codecontrat));

                                if(isset($machine))
                                {
                                    $machine->setCodelocations(NULL);
                                    $machine->setCodecontrat(NULL);
                                    $machine->setClientid(0);
                                    $machine->setEntreprise(NULL);
                                    $machine->setNomchantier(NULL);
                                    $machine->setDebutloc(NULL);
                                    $machine->setFinloc(NULL);
                                    $machine->setEtat('Disponible');
                                    $em->persist($machine);
                                }

                                $logistique = $em->getRepository('BaclooCrmBundle:Logistique')
                                    ->findOneBy(array('materiel' => $loca->getCodemachineinterne(), 'codecontrat' => $codecontrat));
                                if(!empty($logistique)){$em->remove($logistique);}

                                $logistiquerep = $em->getRepository('BaclooCrmBundle:Logistiquerep')
                                    ->findOneBy(array('materiel' => $loca->getCodemachineinterne(), 'codecontrat' => $codecontrat));
                                if(!empty($logistiquerep)){$em->remove($logistiquerep);}
                            }
                            $em->remove($loca);
                        }
                    }
                    $em->remove($contrat);
                    $em->flush();
                }
            }
            else
            {
                $erreur = 1;
                return $this->redirect($this->generateUrl('bacloocrm_erreur', array('id' => $id, 'erreur' => $erreur)));
            }
        }
        elseif($mode == 'vente')
        {
            $venda = $em->getRepository('BaclooCrmBundle:Venda')
                ->findOneByid($codecontrat);

            $facture = $em->getRepository('BaclooCrmBundle:Factures')
                ->findOneBycodelocata('V-'.$codecontrat);

            if(!isset($facture))
            {
                $em->remove($venda);
                $em->flush();
            }
            else
            {
                $erreur = 1;
                return $this->redirect($this->generateUrl('bacloocrm_erreur', array('id' => $id, 'erreur' => $erreur)));
            }
        }
        return $this->redirect($this->generateUrl('bacloocrm_voir', array('id' => $id)));
    }

    public function erreurAction($id, $erreur)
    {
        return $this->render('BaclooCrmBundle:Crm:erreur.html.twig', array(
            'id' => $id,
            'erreur'  => $erreur
        ));
    }

    public function dropzoneAction($codecontrat, $type, Request $request)
    {echo 'xxxxx'.$codecontrat;
        $output = array('uploaded' => false);
        // get the file from the request object
        $file = $request->files->get('file');
        // generate a new filename (safer, better approach)
        // To use original filename, $fileName = $this->file->getClientOriginalName();
        $fileName = $file->getClientOriginalName();
        // Note: While using $file->guessExtension(), sometimes the MIME-guesser may fail silently for improperly encoded files. It is recommended to use a fallback for such cases if you know what file extensions are expected. (You can loop-over the allowed file extensions or even hard-code it if you expect only a particular type of file extension.)

        // set your uploads directory
        $uploadDir = $this->get('kernel')->getRootDir() . '/../web/uploads/'.$type.'/'.$codecontrat.'/';
        if (!file_exists($uploadDir) && !is_dir($uploadDir)) {
            mkdir($uploadDir, 0775, true);
        }
        if ($file->move($uploadDir, $fileName)) {
            // get entity manager
            $em = $this->getDoctrine()->getManager();

            // create and set this mediaEntity
            $document = new Document();
            $document->setNom($fileName);
            $document->setCodecontrat($codecontrat);
            $document->setType($type);

            // save the uploaded filename to database
            $em->persist($document);
            $em->flush();
            $output['uploaded'] = true;
            $output['fileName'] = $fileName;
        }
        // return new JsonResponse($output);
        if($type == 'machine')
        {
            return $this->redirect($this->generateUrl('bacloocrm_machines', array('machineid' => $codecontrat)));
        }
        elseif($type == 'fiche')
        {
            return $this->redirect($this->generateUrl('bacloocrm_voir', array('id' => $codecontrat)));
        }
        elseif($type == 'facfrssl')
        {
            return $this->redirect($this->generateUrl('bacloocrm_compta', array('vue' => 'locations')));
        }
        elseif($type == 'facfrs')
        {
            return $this->redirect($this->generateUrl('bacloocrm_compta', array('vue' => 'achats')));
        }
        elseif($type == 'contrat')
        {
            $contrat  = $em->getRepository('BaclooCrmBundle:Locata')
                ->findOneById($codecontrat);
            return $this->redirect($this->generateUrl('bacloocrm_ajouterlocation', array('ficheid' => $contrat->getClientid(), 'locid' => $codecontrat)));
        }
    }

    public function dropzoneimageAction($codecontrat, $type, Request $request)
    {//echo 'xxxxx'.$codecontrat;
        $output = array('uploaded' => false);
        // get the file from the request object
        $file = $request->files->get('file');
        // generate a new filename (safer, better approach)
        // To use original filename, $fileName = $this->file->getClientOriginalName();
        $fileName = $file->getClientOriginalName();
        // Note: While using $file->guessExtension(), sometimes the MIME-guesser may fail silently for improperly encoded files. It is recommended to use a fallback for such cases if you know what file extensions are expected. (You can loop-over the allowed file extensions or even hard-code it if you expect only a particular type of file extension.)

        // set your uploads directory
        $uploadDir = $this->get('kernel')->getRootDir() . '/../web/uploads/'.$type.'/'.$codecontrat.'/';
        if (!file_exists($uploadDir) && !is_dir($uploadDir)) {
            mkdir($uploadDir, 0775, true);
        }
        if ($file->move($uploadDir, $fileName)) {
            // get entity manager
            $em = $this->getDoctrine()->getManager();

            $doca  = $em->getRepository('BaclooCrmBundle:Doca')
                ->findOneBy(array('typedoc' => $type, 'iddoc' => $codecontrat));
            if(!isset($doca) or empty($doca))
            {
                $doca = new Doca;
                $doca->setTypedoc($type);
                $doca->setIddoc($codecontrat);
            }

            // create and set this mediaEntity
            $document = new Document();
            $document->setNom($fileName);
            $document->setCodecontrat($codecontrat);
            $document->setType($type);
            $document->addDoca($doca);
            $doca->addDocument($document);

            // save the uploaded filename to database
            $em->persist($document);
            $em->persist($doca);
            $em->flush();
            $output['uploaded'] = true;
            $output['fileName'] = $fileName;
        }
        // return new JsonResponse($output);
        if($type == 'machine')
        {
            return $this->redirect($this->generateUrl('bacloocrm_machines', array('machineid' => $codecontrat)));
        }
        elseif($type == 'fiche')
        {
            return $this->redirect($this->generateUrl('bacloocrm_voir', array('id' => $codecontrat)));
        }
        elseif($type == 'facfrssl')
        {
            return $this->redirect($this->generateUrl('bacloocrm_compta', array('vue' => 'locations')));
        }
        elseif($type == 'facfrs')
        {
            return $this->redirect($this->generateUrl('bacloocrm_compta', array('vue' => 'achats')));
        }
        elseif($type == 'contrat' or $type == 'bi')
        {
            $contrat  = $em->getRepository('BaclooCrmBundle:Venda')
                ->findOneById($codecontrat);
            return $this->redirect($this->generateUrl('bacloocrm_ventes', array('ficheid' => $contrat->getClientid(), 'vendaid' => $codecontrat)));
        }
        elseif($type == 'bd')
        {
            $bd  = $em->getRepository('BaclooCrmBundle:Bondepart')
                ->findOneById($codecontrat);
            $location  = $em->getRepository('BaclooCrmBundle:Locations')
                ->findOneByBdid($codecontrat);
            return $this->redirect($this->generateUrl('bacloocrm_bondepart', array('bondepartid' => $bd->getId(), 'codelocation' => $location->getId())));
        }
        elseif($type == 'br')
        {
            $br  = $em->getRepository('BaclooCrmBundle:Bonretour')
                ->findOneById($codecontrat);
            $location  = $em->getRepository('BaclooCrmBundle:Locations')
                ->findOneByBrid($codecontrat);
            return $this->redirect($this->generateUrl('bacloocrm_bonretour', array('bonretourid' => $br->getId(), 'codelocation' => $location->getId())));
        }
    }

    public function testdropAction($codecontrat)
    {
        $em = $this->getDoctrine()->getManager();
        $documents  = $em->getRepository('BaclooCrmBundle:Document')
            ->findByCodecontrat($codecontrat);
        return $this->render('BaclooCrmBundle:Crm:dropzone.html.twig', array('documents'	=> $documents));
    }

    public function deleteResourceAction($codecontrat, Request $request){
        $output = array('deleted' => false, 'error' => false);
        $mediaID = $request->get('id');
        $fileName = $request->get('fileName');
        $em = $this->getDoctrine()->getManager();
        $media = $em->find('BaclooCrmBundle:Document', $mediaID);
        if ($fileName && $media && $media instanceof Document) {
            $uploadDir = $this->get('kernel')->getRootDir() . '/../web/uploads/';
            $output['deleted'] = unlink($uploadDir.$fileName);
            if ($output['deleted']) {
                // delete linked Document
                $em = $this->getDoctrine()->getManager();
                $em->remove($media);
                $em->flush();
            }
        } else {
            $output['error'] = 'Missing/Incorrect Media ID and/or FileName';
        }
        return new JsonResponse($output);
    }

    public function removedocumentAction($iddoc, $codecontrat, $type, Request $request)
    {//$id = id ligne partenaire
        $em = $this->getDoctrine()->getManager();
        $previous = $this->get('request')->server->get('HTTP_REFERER');
// echo 'iddoc'.$iddoc;echo 'type'.$type;echo 'codecontrat'.$codecontrat;
        $document  = $em->getRepository('BaclooCrmBundle:Document')
            ->findOneBy(array('id' => $iddoc, 'type' => $type));

        $nomfichier = $document->getNom();
        $fs = new Filesystem();

        if($type == 'machine')
        {
            $fs->remove($this->get('kernel')->getRootDir().'/../web/uploads/machine/'.$codecontrat.'/'.$nomfichier);
            $em->remove($document);
            $em->flush();
            return $this->redirect($this->generateUrl('bacloocrm_machines', array('machineid' => $codecontrat)));
        }
        elseif($type == 'fiche')
        {
            $em->remove($document);
            $em->flush();
            $fs->remove($this->get('kernel')->getRootDir().'/../web/uploads/fiche/'.$codecontrat.'/'.$nomfichier);
            return $this->redirect($this->generateUrl('bacloocrm_voir', array('id' => $codecontrat)));
        }
        elseif($type == 'facfrs')
        {
            $em->remove($document);
            $em->flush();
            $fs->remove($this->get('kernel')->getRootDir().'/../web/uploads/facfrs/'.$codecontrat.'/'.$nomfichier);
            return $this->redirect($this->generateUrl('bacloocrm_compta', array('vue' => 'achats')));
        }
        elseif($type == 'facfrssl')
        {
            $em->remove($document);
            $em->flush();
            $fs->remove($this->get('kernel')->getRootDir().'/../web/uploads/facfrssl/'.$codecontrat.'/'.$nomfichier);
            return $this->redirect($this->generateUrl('bacloocrm_compta', array('vue' => 'locations')));
        }
        elseif($type == 'contrat')
        {
            $em->remove($document);
            $em->flush();
            $fs->remove($this->get('kernel')->getRootDir().'/../web/uploads/contrat/'.$codecontrat.'/'.$nomfichier);
            $contrat  = $em->getRepository('BaclooCrmBundle:Locata')
                ->findOneById($codecontrat);
            return $this->redirect($this->generateUrl('bacloocrm_ajouterlocation', array('ficheid' => $contrat->getClientid(), 'locid' => $codecontrat)));
        }
        elseif($type == 'bi')
        {
            $em->remove($document);
            $em->flush();
            $fs->remove($this->get('kernel')->getRootDir().'/../web/uploads/bi/'.$codecontrat.'/'.$nomfichier);
            $contrat  = $em->getRepository('BaclooCrmBundle:Venda')
                ->findOneById($codecontrat);
            return $this->redirect($this->generateUrl('bacloocrm_ventes', array('ficheid' => $contrat->getClientid(), 'vendaid' => $codecontrat, 'typevente' => 'bi')));
        }
        elseif($type == 'bd')
        {
            $em->remove($document);
            $em->flush();
            $fs->remove($this->get('kernel')->getRootDir().'/../web/uploads/bd/'.$codecontrat.'/'.$nomfichier);
            $bd  = $em->getRepository('BaclooCrmBundle:Bondepart')
                ->findOneById($codecontrat);
            $location  = $em->getRepository('BaclooCrmBundle:Locations')
                ->findOneBybdid($codecontrat);
            return $this->redirect($this->generateUrl('bacloocrm_bondepart', array('bondepartid' => $codecontrat, 'codelocation' => $location->getId())));
        }
        elseif($type == 'br')
        {
            $em->remove($document);
            $em->flush();
            $fs->remove($this->get('kernel')->getRootDir().'/../web/uploads/br/'.$codecontrat.'/'.$nomfichier);
            $br  = $em->getRepository('BaclooCrmBundle:Bonretour')
                ->findOneById($codecontrat);
            $location  = $em->getRepository('BaclooCrmBundle:Locations')
                ->findOneBybrid($codecontrat);
            return $this->redirect($this->generateUrl('bacloocrm_bonretour', array('bonretourid' => $codecontrat, 'codelocation' => $location->getId())));
        }
    }

    public function listerelanceAction(Request $request)
    {
        $em = $this->getDoctrine()->getManager();
        $listerelance = $em->getRepository('BaclooCrmBundle:Factures')
            ->listerelance();

        $pdf = $this->get("white_october.tcpdf")->create();
        $html = $this->renderView('BaclooCrmBundle:Crm:listerelance.html.twig', array('listerelance' => $listerelance));
        $pdf->SetFont('helvetica', '', 9, '', true);

        $pdf->AddPage('L', 'A4');
        $pdf->writeHTML($html, true, false, true, false, '');
        $pdf->lastPage();

        $response = new Response($pdf->Output('file.pdf'));
        $response->headers->set('Content-Type', 'application/pdf');

        return $response;
    }

    public function caCsvAction($dStart, $dEnd)
    {
        $response = new StreamedResponse();
        $response->setCallback(function() {
            $handle = fopen('php://output', 'w+');

            // Add the header of the CSV file
            fputcsv($handle, ['Mois', 'CA'],';');

            $em = $this->getDoctrine()->getManager();

            $results  = $em->getRepository('BaclooCrmBundle:Factures')
                ->last12mca3($dStart, $dEnd);

            foreach($results as $c) {
                fputcsv(
                    $handle, // The file pointer
                    [$c->getDatemodif(), $c->getCareal()], // The fields
                    ';' // The delimiter
                );
            }

            fclose($handle);
        });

        $response->setStatusCode(200);
        $response->headers->set('Content-Type', 'text/csv; charset=utf-8');
        $response->headers->set('Content-Disposition','attachment; filename="export.csv"');

        return $response;

    }

    function foldersizeAction()
    {
        $dir = 'uploads/';
        $bytes = 0;
        $iterator = new RecursiveIteratorIterator(new RecursiveDirectoryIterator($dir));
        foreach ($iterator as $i)
        {
            $bytes += $i->getSize();
        }
        return $this->render('BaclooCrmBundle:Crm:foldersize.html.twig', array(
            'size' => $bytes
        ));
    }

    public function camensuelclientsdetailleAction($mode, $page, $search, $dStart, $dEnd,  $client, Request $request)
    {
        $nbparpage = 30;
        $defaultData = array();
        $form = $this->createFormBuilder($defaultData)
            ->add('du', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => false,
                'attr' => array('class' => 'date'),
            ))
            ->add('au', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => false,
                'attr' => array('class' => 'date'),
            ))
            ->add('client', 'text', array('required' => false))
            ->getForm();
        if($request->getMethod() == 'POST') {//echo 'VALIDE';
            $form->handleRequest($request);
            $data = $form->getData();//var_dump($data);
            if(isset($data['du']))
            {
                $dStart = $data['du'];
            }
            if(isset($data['au']))
            {
                $dEnd = $data['au'];
            }
            if(isset($data['client']))
            {
                $client = $data['client'];
            }
            $search = 1;
        }
// echo 'dend '.$dEnd;
        if($dStart == 0)
        {
            $dStart = date('Y-m-d', strtotime("-6 months"));
        }

        if($dEnd == 0)
        {
            $dEnd = date('Y-m-d');
        }
// echo 'DDTARTREPO'.$dStart;
// echo 'DENDREPO'.$dEnd;
        // $dEnd = '2018-11-30';
// echo 'search'.$search;
        //1.Récupérer les données de la table Faccture
        $em = $this->getDoctrine()->getManager();

        $today = date('Y-m-d');
        $prev12 = date('Y-m-d', strtotime("-6 months"));
        $ca  = $em->getRepository('BaclooCrmBundle:Locataclone')
            ->camensueldet($search, $dStart, $dEnd, $client);
        $caarray  = $em->getRepository('BaclooCrmBundle:Locataclone')
            ->camensuelarrayclientdet($search, $nbparpage, $page, $dStart, $dEnd, $client);
        $artica = $em->getRepository('BaclooCrmBundle:Locataclone')
            ->camensuelarrayclienttotaldet($dStart, $dEnd, $client, $search);
        $avoirsclients = $em->getRepository('BaclooCrmBundle:Factures')
            ->avoirsclients($dStart, $dEnd, $client, $search);

        // print_r($nbjannee);
        $commerciaux = array();
        foreach($caarray as $comm)
        {
            $commerciaux[]=$comm->getClient();
        }
        // foreach($ca as $con)
        // {
        // if($con->getClient() =='AIRESS')
        // {
        // echo $con->getClient();echo '>>';echo $con->getDatemodif();echo '>>';echo $con->getMontantloc();echo '<br>';
        // }
        // }
        // print_r($commerciaux);
        // foreach($commerciaux as $com)
        // {
        // echo 'XXXXXXXXXX';echo $com;
        // }
        // echo $i;
        // print_r($nbmois);
        //aDates contient nos entêtes de colonnes
        return $this->render('BaclooCrmBundle:Crm:camensuelclientsdetaille.html.twig', array(
            'search' => $search,
            'dstart' => $dStart,
            'dend' => $dEnd,
            'ca' => $ca,
            'avoirsclients' => $avoirsclients,
            'nombrePage' => ceil(count($artica)/$nbparpage),
            'commerciaux' => $commerciaux,
            'form' => $form->createView(),
            'page' => $page,
            'mode' => $mode
        ));
    }

    public function camensuelclientsAction($mode, $page, $search, $dStart, $dEnd,  $client, Request $request)
    {
        $nbparpage = 30;
        $defaultData = array();
        $form = $this->createFormBuilder($defaultData)
            ->add('du', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => false,
                'attr' => array('class' => 'date'),
            ))
            ->add('au', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => false,
                'attr' => array('class' => 'date'),
            ))
            ->add('client', 'text', array('required' => false))
            ->getForm();
        if($request->getMethod() == 'POST') {//echo 'VALIDE';
            $form->handleRequest($request);
            $data = $form->getData();//var_dump($data);
            if(isset($data['du']))
            {
                $dStart = $data['du'];
            }
            if(isset($data['au']))
            {
                $dEnd = $data['au'];
            }
            if(isset($data['client']))
            {
                $client = $data['client'];
            }
            $search = 1;
        }
// echo 'dend '.$dEnd;
        if($dStart == 0)
        {
            $dStart = date('Y-m-d', strtotime("-6 months"));
        }

        if($dEnd == 0)
        {
            $dEnd = date('Y-m-d');
        }
// echo $dStart;
        // $dEnd = '2018-11-30';
// echo 'search'.$search;
        //1.Récupérer les données de la table Faccture
        $em = $this->getDoctrine()->getManager();

        $today = date('Y-m-d');
        $prev12 = date('Y-m-d', strtotime("-6 months"));
        $ca  = $em->getRepository('BaclooCrmBundle:Locataclone')
            ->camensuel($search, $dStart, $dEnd, $client);
        $caarray  = $em->getRepository('BaclooCrmBundle:Locataclone')
            ->camensuelarrayclient($search, $nbparpage, $page, $dStart, $dEnd, $client);
        $artica = $em->getRepository('BaclooCrmBundle:Locataclone')
            ->camensuelarrayclienttotal($dStart, $dEnd, $client, $search);
// var_dump($ca);
// echo '$$$$$$'.print_r($ca);	echo '<<<<<';
        //2.On génère les entêtes de colonnes à partir de la fonction createplanning
        $iStart = strtotime ($dStart);//Formate une date/heure locale avec la Something is wronguration locale
        $iEnd = strtotime ($dEnd);
        if (false === $iStart || false === $iEnd) {
            // return false;
        }
        $aStart = explode ('-', $dStart);
        $aEnd = explode ('-', $dEnd);
        if (count ($aStart) !== 3 || count ($aEnd) !== 3) {
            // return false;
        }
        // if (false === checkdate ($aStart[1], $aStart[2], $aStart[0]) || false === checkdate ($aEnd[1], $aEnd[2], $aEnd[0]) || $iEnd <= $iStart) {
        // return false;
        // }
        for ($i = $iStart; $i < $iEnd + 86400; $i = strtotime ('+1 day', $i) ) {
            $sDateToArr = strftime ('%Y-%m-%d', $i);
            $sYear = substr ($sDateToArr, 0, 4);
            $sMonth = substr ($sDateToArr, 5, 2);
            $aDates[$sYear][$sMonth][] = $sDateToArr;
        }

        $nbannee = 0;
        $nbmoisparannee = 0;
        //Calcule le nombre de jours dans le mois
        $annee1 = date("Y", strtotime($dStart));
        $anneef = date("Y", strtotime($dStart));
        $anneefin = $anneef + 1;

        //Boucle parcours tableau année, mois, jours.
        //Celle-ci renvoie le nombre de  jours du premier mois m1
        $m11 = 1;
        foreach($aDates as $annee => $moiss)
        {
            foreach($moiss as $date => $mois)
            {
                if($m11 == 1)//si on est en m1 on procède sinon break
                {
                    foreach($mois as $dat)
                    {
                        $m11++;
                    }
                }
                else
                {
                    break;
                }
            }

        }
        $m1 = $m11-1;
        //Calcul du nb total de mois $m
        $m = 0;
        foreach($aDates as $annee => $moiss)
        {
            foreach($moiss as $date => $mois)
            {
                $m++;
            }

        }

        //Calcul du nb total d'années $a
        $an = 0;
        foreach($aDates as $annee => $moiss)
        {
            $an++;
        }
// echo $m;
        //Celle-ci renvoie le nombre de jours du dernier mois mm
        $mm = 0;
        $compteurm = 1;
        foreach($aDates as $annee => $moiss)
        {
            foreach($moiss as $date => $mois)
            {
                if($compteurm == $m)//si on est le dernier mois
                {
                    foreach($mois as $dat)
                    {
                        $mm++;
                    }
                }
                else
                {}
                $compteurm++;
            }

        }

        //Celle-ci renvoie le nombre de jours de la première année $a1
        $a11 = 1;
        foreach($aDates as $annee => $moiss)
        {
            if($a11 == 1)//si on est en a1 on procède sinon break
            {
                foreach($moiss as $date => $mois)
                {
                    foreach($mois as $dat)
                    {
                        $a11++;
                    }
                }
            }
            else
            {
                break;
            }
        }
        $a1 = $a11-1;
        //Fonction qui calcule le nombre de jours dans l'année
        function cal_days_in_year($year){
            $days=0;
            for($month=1;$month<=12;$month++){
                $days = $days + cal_days_in_month(CAL_GREGORIAN,$month,$year);
            }
            return $days;
        }
        //Celle-ci renvoie le nombre de jours de la dernière année $aa
        $aa = 0;
        $compteura = 1;//echo '$an'.$an;
        foreach($aDates as $annee => $moiss)
        {
            if($compteura == $an)//si on est en end ernière année on calcule le nb de jours $aa
            {
                foreach($moiss as $date => $mois)
                {
                    foreach($mois as $dat)
                    {
                        $aa++;
                    }
                }
            }
            elseif($compteura > $an)
            {
                break;
            }
            $compteura++;
        }//echo 'aa'.$aa;echo 'compteura'.$compteura;
        // echo 'www'.$mm.'www';
        // $mm = 0; //Compteur de mois qui s'incrémente de 1 afin de faire un compte indépendant des mois.
        $nbjrparmois = 0;
        $i = 1; //Compteur pour premier mois
        $a = 1; //Compteur pour la première année
        $nbmois = array();
        $nbjannee = array();
        foreach($aDates as $annee => $moiss)
        {
            //Calculer le nombre d'années
            // echo $annee;
            if($a == 1)//Si on est en première année
            {
                $nbjannee[] = $a1;//nb de jours de la première année
            }
            elseif($a == $an)
            {
                $nbjannee[] = $aa;
            }
            else
            {
                $nbjannee[] = cal_days_in_year($annee);
            }
            foreach($moiss as $date => $mois)
            {
                if($i == 1)//on est au premier mois
                {
                    //nb jours mois courant
                    $nbmois[] = $m1;
                }
                elseif($i == $m)//Si on est  le dernier mois de la période on met le nb de jours
                {
                    //nb de jours du dernier mois
                    $nbmois[] = $mm;
                }
                else
                {
                    //Pour les autres mois
                    $nbmois[] = cal_days_in_month(CAL_GREGORIAN, $date, $annee);
                }
                $i++;
            }
            $a++;
        }
        // print_r($nbjannee);
        $commerciaux = array();
        foreach($caarray as $comm)
        {
            $commerciaux[]=$comm->getClient();
        }
        // foreach($ca as $con)
        // {
        // if($con->getClient() =='AIRESS')
        // {
        // echo $con->getClient();echo '>>';echo $con->getDatemodif();echo '>>';echo $con->getMontantloc();echo '<br>';
        // }
        // }
        // print_r($commerciaux);
        // foreach($commerciaux as $com)
        // {
        // echo 'XXXXXXXXXX';echo $com;
        // }
        // echo $i;
        // print_r($nbmois);
        //aDates contient nos entêtes de colonnes
        return $this->render('BaclooCrmBundle:Crm:camensuelclients.html.twig', array(
            'dates' => $aDates,
            'dstart' => $dStart,
            'dend' => $dEnd,
            'search' => $search,
            'ca' => $ca,
            'nombrePage' => ceil(count($artica)/$nbparpage),
            'ans' => $an,
            'commerciaux' => $commerciaux,
            'nbjannee' => $nbjannee,
            'form' => $form->createView(),
            'page' => $page,
            'mode' => $mode,
            'nbmois' => $nbmois
        ));
    }

    public function camensuelmachinesAction($mode, $page, $search, $dStart, $dEnd, Request $request)
    {
        $nbparpage = 30;
        $defaultData = array();
        $form = $this->createFormBuilder($defaultData)
            ->add('du', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => false,
                'attr' => array('class' => 'date'),
            ))
            ->add('au', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => false,
                'attr' => array('class' => 'date'),
            ))
            ->getForm();
        if($request->getMethod() == 'POST') {//echo 'VALIDE';
            $form->handleRequest($request);
            $data = $form->getData();//var_dump($data);
            if(isset($data['du']))
            {
                $dStart = $data['du'];
            }
            if(isset($data['au']))
            {
                $dEnd = $data['au'];
            }
        }
// echo 'dend '.$dEnd;
        if($dStart == 0)
        {
            $dStart = date('Y-m-d', strtotime("-6 months"));
        }

        if($dEnd == 0)
        {
            $dEnd = date('Y-m-d');
        }
// echo $dStart;
        // $dEnd = '2018-11-30';
// echo 'search'.$search;
        //1.Récupérer les données de la table Faccture
        $em = $this->getDoctrine()->getManager();

        $today = date('Y-m-d');
        $prev12 = date('Y-m-d', strtotime("-6 months"));
        $ca  = $em->getRepository('BaclooCrmBundle:Locationsclone')
            ->camensuel($search, $dStart, $dEnd);
        $caarray  = $em->getRepository('BaclooCrmBundle:Locationsclone')
            ->camensuelarrayclient($search, $nbparpage, $page, $dStart, $dEnd);
        $artica = $em->getRepository('BaclooCrmBundle:Locationsclone')
            ->camensuelarrayclienttotal($dStart, $dEnd);
// var_dump($ca);
// echo '$$$$$$'.print_r($ca);	echo '<<<<<';
        //2.On génère les entêtes de colonnes à partir de la fonction createplanning
        $iStart = strtotime ($dStart);//Formate une date/heure locale avec la Something is wronguration locale
        $iEnd = strtotime ($dEnd);
        if (false === $iStart || false === $iEnd) {
            // return false;
        }
        $aStart = explode ('-', $dStart);
        $aEnd = explode ('-', $dEnd);
        if (count ($aStart) !== 3 || count ($aEnd) !== 3) {
            // return false;
        }
        // if (false === checkdate ($aStart[1], $aStart[2], $aStart[0]) || false === checkdate ($aEnd[1], $aEnd[2], $aEnd[0]) || $iEnd <= $iStart) {
        // return false;
        // }
        for ($i = $iStart; $i < $iEnd + 86400; $i = strtotime ('+1 day', $i) ) {
            $sDateToArr = strftime ('%Y-%m-%d', $i);
            $sYear = substr ($sDateToArr, 0, 4);
            $sMonth = substr ($sDateToArr, 5, 2);
            $aDates[$sYear][$sMonth][] = $sDateToArr;
        }

        $nbannee = 0;
        $nbmoisparannee = 0;
        //Calcule le nombre de jours dans le mois
        $annee1 = date("Y", strtotime($dStart));
        $anneef = date("Y", strtotime($dStart));
        $anneefin = $anneef + 1;

        //Boucle parcours tableau année, mois, jours.
        //Celle-ci renvoie le nombre de  jours du premier mois m1
        $m11 = 1;
        foreach($aDates as $annee => $moiss)
        {
            foreach($moiss as $date => $mois)
            {
                if($m11 == 1)//si on est en m1 on procède sinon break
                {
                    foreach($mois as $dat)
                    {
                        $m11++;
                    }
                }
                else
                {
                    break;
                }
            }

        }
        $m1 = $m11-1;
        //Calcul du nb total de mois $m
        $m = 0;
        foreach($aDates as $annee => $moiss)
        {
            foreach($moiss as $date => $mois)
            {
                $m++;
            }

        }

        //Calcul du nb total d'années $a
        $an = 0;
        foreach($aDates as $annee => $moiss)
        {
            $an++;
        }
// echo $m;
        //Celle-ci renvoie le nombre de jours du dernier mois mm
        $mm = 0;
        $compteurm = 1;
        foreach($aDates as $annee => $moiss)
        {
            foreach($moiss as $date => $mois)
            {
                if($compteurm == $m)//si on est le dernier mois
                {
                    foreach($mois as $dat)
                    {
                        $mm++;
                    }
                }
                else
                {}
                $compteurm++;
            }

        }

        //Celle-ci renvoie le nombre de jours de la première année $a1
        $a11 = 1;
        foreach($aDates as $annee => $moiss)
        {
            if($a11 == 1)//si on est en a1 on procède sinon break
            {
                foreach($moiss as $date => $mois)
                {
                    foreach($mois as $dat)
                    {
                        $a11++;
                    }
                }
            }
            else
            {
                break;
            }
        }
        $a1 = $a11-1;
        //Fonction qui calcule le nombre de jours dans l'année
        function cal_days_in_year($year){
            $days=0;
            for($month=1;$month<=12;$month++){
                $days = $days + cal_days_in_month(CAL_GREGORIAN,$month,$year);
            }
            return $days;
        }
        //Celle-ci renvoie le nombre de jours de la dernière année $aa
        $aa = 0;
        $compteura = 1;//echo '$an'.$an;
        foreach($aDates as $annee => $moiss)
        {
            if($compteura == $an)//si on est en end ernière année on calcule le nb de jours $aa
            {
                foreach($moiss as $date => $mois)
                {
                    foreach($mois as $dat)
                    {
                        $aa++;
                    }
                }
            }
            elseif($compteura > $an)
            {
                break;
            }
            $compteura++;
        }//echo 'aa'.$aa;echo 'compteura'.$compteura;
        // echo 'www'.$mm.'www';
        // $mm = 0; //Compteur de mois qui s'incrémente de 1 afin de faire un compte indépendant des mois.
        $nbjrparmois = 0;
        $i = 1; //Compteur pour premier mois
        $a = 1; //Compteur pour la première année
        $nbmois = array();
        $nbjannee = array();
        foreach($aDates as $annee => $moiss)
        {
            //Calculer le nombre d'années
            // echo $annee;
            if($a == 1)//Si on est en première année
            {
                $nbjannee[] = $a1;//nb de jours de la première année
            }
            elseif($a == $an)
            {
                $nbjannee[] = $aa;
            }
            else
            {
                $nbjannee[] = cal_days_in_year($annee);
            }
            foreach($moiss as $date => $mois)
            {
                if($i == 1)//on est au premier mois
                {
                    //nb jours mois courant
                    $nbmois[] = $m1;
                }
                elseif($i == $m)//Si on est  le dernier mois de la période on met le nb de jours
                {
                    //nb de jours du dernier mois
                    $nbmois[] = $mm;
                }
                else
                {
                    //Pour les autres mois
                    $nbmois[] = cal_days_in_month(CAL_GREGORIAN, $date, $annee);
                }
                $i++;
            }
            $a++;
        }
        // print_r($nbjannee);
        $commerciaux = array();
        foreach($caarray as $comm)
        {
            $commerciaux[]=$comm->getCodemachineinterne();
        }
        // foreach($ca as $con)
        // {
        // if($con->getClient() =='AIRESS')
        // {
        // echo $con->getClient();echo '>>';echo $con->getDatemodif();echo '>>';echo $con->getMontantloc();echo '<br>';
        // }
        // }
        // print_r($commerciaux);
        // foreach($commerciaux as $com)
        // {
        // echo 'XXXXXXXXXX';echo $com;
        // }
        // echo $i;
        // print_r($nbmois);
        //aDates contient nos entêtes de colonnes
        return $this->render('BaclooCrmBundle:Crm:camensuelmachines.html.twig', array(
            'dates' => $aDates,
            'dstart' => $dStart,
            'dend' => $dEnd,
            'search' => $search,
            'ca' => $ca,
            'nombrePage' => ceil(count($artica)/$nbparpage),
            'ans' => $an,
            'commerciaux' => $commerciaux,
            'nbjannee' => $nbjannee,
            'form' => $form->createView(),
            'page' => $page,
            'mode' => $mode,
            'nbmois' => $nbmois
        ));
    }

    public function camensueltypemachinesAction($mode, $page, $search, $dStart, $dEnd, Request $request)
    {
        $nbparpage = 60;
        $defaultData = array();
        $form = $this->createFormBuilder($defaultData)
            ->add('du', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => false,
                'attr' => array('class' => 'date'),
            ))
            ->add('au', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => false,
                'attr' => array('class' => 'date'),
            ))
            ->getForm();
        if($request->getMethod() == 'POST') {//echo 'VALIDE';
            $form->handleRequest($request);
            $data = $form->getData();//var_dump($data);
            if(isset($data['du']))
            {
                $dStart = $data['du'];
            }
            if(isset($data['au']))
            {
                $dEnd = $data['au'];
            }
        }
// echo 'dend '.$dEnd;
        if($dStart == 0)
        {
            $dStart = date('Y-m-d', strtotime("-6 months"));
        }

        if($dEnd == 0)
        {
            $dEnd = date('Y-m-d');
        }
// echo $dStart;
        // $dEnd = '2018-11-30';
// echo 'search'.$search;
        //1.Récupérer les données de la table Faccture
        $em = $this->getDoctrine()->getManager();

        $today = date('Y-m-d');
        $prev12 = date('Y-m-d', strtotime("-6 months"));
        $ca  = $em->getRepository('BaclooCrmBundle:Locationsclone')
            ->camensueltype($search, $dStart, $dEnd);
        $caarray  = $em->getRepository('BaclooCrmBundle:Locationsclone')
            ->camensuelarrayclienttype($search, $nbparpage, $page, $dStart, $dEnd);
        $artica = $em->getRepository('BaclooCrmBundle:Locationsclone')
            ->camensuelarraycodemachine($dStart, $dEnd);
// var_dump($ca);
// echo '$$$$$$'.print_r($ca);	echo '<<<<<';
        //2.On génère les entêtes de colonnes à partir de la fonction createplanning
        $iStart = strtotime ($dStart);//Formate une date/heure locale avec la Something is wronguration locale
        $iEnd = strtotime ($dEnd);
        if (false === $iStart || false === $iEnd) {
            // return false;
        }
        $aStart = explode ('-', $dStart);
        $aEnd = explode ('-', $dEnd);
        if (count ($aStart) !== 3 || count ($aEnd) !== 3) {
            // return false;
        }
        // if (false === checkdate ($aStart[1], $aStart[2], $aStart[0]) || false === checkdate ($aEnd[1], $aEnd[2], $aEnd[0]) || $iEnd <= $iStart) {
        // return false;
        // }
        for ($i = $iStart; $i < $iEnd + 86400; $i = strtotime ('+1 day', $i) ) {
            $sDateToArr = strftime ('%Y-%m-%d', $i);
            $sYear = substr ($sDateToArr, 0, 4);
            $sMonth = substr ($sDateToArr, 5, 2);
            $aDates[$sYear][$sMonth][] = $sDateToArr;
        }

        $nbannee = 0;
        $nbmoisparannee = 0;
        //Calcule le nombre de jours dans le mois
        $annee1 = date("Y", strtotime($dStart));
        $anneef = date("Y", strtotime($dStart));
        $anneefin = $anneef + 1;

        //Boucle parcours tableau année, mois, jours.
        //Celle-ci renvoie le nombre de  jours du premier mois m1
        $m11 = 1;
        foreach($aDates as $annee => $moiss)
        {
            foreach($moiss as $date => $mois)
            {
                if($m11 == 1)//si on est en m1 on procède sinon break
                {
                    foreach($mois as $dat)
                    {
                        $m11++;
                    }
                }
                else
                {
                    break;
                }
            }

        }
        $m1 = $m11-1;
        //Calcul du nb total de mois $m
        $m = 0;
        foreach($aDates as $annee => $moiss)
        {
            foreach($moiss as $date => $mois)
            {
                $m++;
            }

        }

        //Calcul du nb total d'années $a
        $an = 0;
        foreach($aDates as $annee => $moiss)
        {
            $an++;
        }
// echo $m;
        //Celle-ci renvoie le nombre de jours du dernier mois mm
        $mm = 0;
        $compteurm = 1;
        foreach($aDates as $annee => $moiss)
        {
            foreach($moiss as $date => $mois)
            {
                if($compteurm == $m)//si on est le dernier mois
                {
                    foreach($mois as $dat)
                    {
                        $mm++;
                    }
                }
                else
                {}
                $compteurm++;
            }

        }

        //Celle-ci renvoie le nombre de jours de la première année $a1
        $a11 = 1;
        foreach($aDates as $annee => $moiss)
        {
            if($a11 == 1)//si on est en a1 on procède sinon break
            {
                foreach($moiss as $date => $mois)
                {
                    foreach($mois as $dat)
                    {
                        $a11++;
                    }
                }
            }
            else
            {
                break;
            }
        }
        $a1 = $a11-1;
        //Fonction qui calcule le nombre de jours dans l'année
        function cal_days_in_year($year){
            $days=0;
            for($month=1;$month<=12;$month++){
                $days = $days + cal_days_in_month(CAL_GREGORIAN,$month,$year);
            }
            return $days;
        }
        //Celle-ci renvoie le nombre de jours de la dernière année $aa
        $aa = 0;
        $compteura = 1;//echo '$an'.$an;
        foreach($aDates as $annee => $moiss)
        {
            if($compteura == $an)//si on est en end ernière année on calcule le nb de jours $aa
            {
                foreach($moiss as $date => $mois)
                {
                    foreach($mois as $dat)
                    {
                        $aa++;
                    }
                }
            }
            elseif($compteura > $an)
            {
                break;
            }
            $compteura++;
        }//echo 'aa'.$aa;echo 'compteura'.$compteura;
        // echo 'www'.$mm.'www';
        // $mm = 0; //Compteur de mois qui s'incrémente de 1 afin de faire un compte indépendant des mois.
        $nbjrparmois = 0;
        $i = 1; //Compteur pour premier mois
        $a = 1; //Compteur pour la première année
        $nbmois = array();
        $nbjannee = array();
        foreach($aDates as $annee => $moiss)
        {
            //Calculer le nombre d'années
            // echo $annee;
            if($a == 1)//Si on est en première année
            {
                $nbjannee[] = $a1;//nb de jours de la première année
            }
            elseif($a == $an)
            {
                $nbjannee[] = $aa;
            }
            else
            {
                $nbjannee[] = cal_days_in_year($annee);
            }
            foreach($moiss as $date => $mois)
            {
                if($i == 1)//on est au premier mois
                {
                    //nb jours mois courant
                    $nbmois[] = $m1;
                }
                elseif($i == $m)//Si on est  le dernier mois de la période on met le nb de jours
                {
                    //nb de jours du dernier mois
                    $nbmois[] = $mm;
                }
                else
                {
                    //Pour les autres mois
                    $nbmois[] = cal_days_in_month(CAL_GREGORIAN, $date, $annee);
                }
                $i++;
            }
            $a++;
        }
        // print_r($nbjannee);
        $commerciaux = array();
        foreach($caarray as $comm)
        {
            $commerciaux[]=$comm['codemachine'];
        }
        // foreach($ca as $con)
        // {
        // if($con->getClient() =='AIRESS')
        // {
        // echo $con->getClient();echo '>>';echo $con->getDatemodif();echo '>>';echo $con->getMontantloc();echo '<br>';
        // }
        // }
        // print_r($commerciaux);
        // foreach($commerciaux as $com)
        // {
        // echo 'XXXXXXXXXX';echo $com;
        // }
        // echo $i;
        // print_r($nbmois);
        //aDates contient nos entêtes de colonnes
        return $this->render('BaclooCrmBundle:Crm:camensueltypemachines.html.twig', array(
            'dates' => $aDates,
            'dstart' => $dStart,
            'dend' => $dEnd,
            'search' => $search,
            'ca' => $ca,
            'nombrePage' => ceil(count($artica)/$nbparpage),
            'ans' => $an,
            'commerciaux' => $commerciaux,
            'nbjannee' => $nbjannee,
            'form' => $form->createView(),
            'page' => $page,
            'mode' => $mode,
            'nbmois' => $nbmois
        ));
    }

    public function camensueltypemachinesslAction($mode, $page, $search, $dStart, $dEnd, Request $request)
    {
        $nbparpage = 100;
        $defaultData = array();
        $form = $this->createFormBuilder($defaultData)
            ->add('du', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => false,
                'attr' => array('class' => 'date'),
            ))
            ->add('au', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => false,
                'attr' => array('class' => 'date'),
            ))
            ->getForm();
        if($request->getMethod() == 'POST') {//echo 'VALIDE';
            $form->handleRequest($request);
            $data = $form->getData();//var_dump($data);
            if(isset($data['du']))
            {
                $dStart = $data['du'];
            }
            if(isset($data['au']))
            {
                $dEnd = $data['au'];
            }
        }
// echo 'dend '.$dEnd;
        if($dStart == 0)
        {
            $dStart = date('Y-m-d', strtotime("-6 months"));
        }

        if($dEnd == 0)
        {
            $dEnd = date('Y-m-d');
        }
// echo $dStart;
        // $dEnd = '2018-11-30';
// echo 'search'.$search;
        //1.Récupérer les données de la table Faccture
        $em = $this->getDoctrine()->getManager();

        $today = date('Y-m-d');
        $prev12 = date('Y-m-d', strtotime("-6 months"));
        $ca  = $em->getRepository('BaclooCrmBundle:Locationsslclone')
            ->camensueltype($search, $dStart, $dEnd);
        $caarray  = $em->getRepository('BaclooCrmBundle:Locationsslclone')
            ->camensuelarrayclienttype($search, $nbparpage, $page, $dStart, $dEnd);
        $artica = $em->getRepository('BaclooCrmBundle:Locationsslclone')
            ->camensuelarraycodemachine($dStart, $dEnd);
// var_dump($ca);
// echo '$$$$$$'.print_r($ca);	echo '<<<<<';
        //2.On génère les entêtes de colonnes à partir de la fonction createplanning
        $iStart = strtotime ($dStart);//Formate une date/heure locale avec la Something is wronguration locale
        $iEnd = strtotime ($dEnd);
        if (false === $iStart || false === $iEnd) {
            // return false;
        }
        $aStart = explode ('-', $dStart);
        $aEnd = explode ('-', $dEnd);
        if (count ($aStart) !== 3 || count ($aEnd) !== 3) {
            // return false;
        }
        // if (false === checkdate ($aStart[1], $aStart[2], $aStart[0]) || false === checkdate ($aEnd[1], $aEnd[2], $aEnd[0]) || $iEnd <= $iStart) {
        // return false;
        // }
        for ($i = $iStart; $i < $iEnd + 86400; $i = strtotime ('+1 day', $i) ) {
            $sDateToArr = strftime ('%Y-%m-%d', $i);
            $sYear = substr ($sDateToArr, 0, 4);
            $sMonth = substr ($sDateToArr, 5, 2);
            $aDates[$sYear][$sMonth][] = $sDateToArr;
        }

        $nbannee = 0;
        $nbmoisparannee = 0;
        //Calcule le nombre de jours dans le mois
        $annee1 = date("Y", strtotime($dStart));
        $anneef = date("Y", strtotime($dStart));
        $anneefin = $anneef + 1;

        //Boucle parcours tableau année, mois, jours.
        //Celle-ci renvoie le nombre de  jours du premier mois m1
        $m11 = 1;
        foreach($aDates as $annee => $moiss)
        {
            foreach($moiss as $date => $mois)
            {
                if($m11 == 1)//si on est en m1 on procède sinon break
                {
                    foreach($mois as $dat)
                    {
                        $m11++;
                    }
                }
                else
                {
                    break;
                }
            }

        }
        $m1 = $m11-1;
        //Calcul du nb total de mois $m
        $m = 0;
        foreach($aDates as $annee => $moiss)
        {
            foreach($moiss as $date => $mois)
            {
                $m++;
            }

        }

        //Calcul du nb total d'années $a
        $an = 0;
        foreach($aDates as $annee => $moiss)
        {
            $an++;
        }
// echo $m;
        //Celle-ci renvoie le nombre de jours du dernier mois mm
        $mm = 0;
        $compteurm = 1;
        foreach($aDates as $annee => $moiss)
        {
            foreach($moiss as $date => $mois)
            {
                if($compteurm == $m)//si on est le dernier mois
                {
                    foreach($mois as $dat)
                    {
                        $mm++;
                    }
                }
                else
                {}
                $compteurm++;
            }

        }

        //Celle-ci renvoie le nombre de jours de la première année $a1
        $a11 = 1;
        foreach($aDates as $annee => $moiss)
        {
            if($a11 == 1)//si on est en a1 on procède sinon break
            {
                foreach($moiss as $date => $mois)
                {
                    foreach($mois as $dat)
                    {
                        $a11++;
                    }
                }
            }
            else
            {
                break;
            }
        }
        $a1 = $a11-1;
        //Fonction qui calcule le nombre de jours dans l'année
        function cal_days_in_year($year){
            $days=0;
            for($month=1;$month<=12;$month++){
                $days = $days + cal_days_in_month(CAL_GREGORIAN,$month,$year);
            }
            return $days;
        }
        //Celle-ci renvoie le nombre de jours de la dernière année $aa
        $aa = 0;
        $compteura = 1;//echo '$an'.$an;
        foreach($aDates as $annee => $moiss)
        {
            if($compteura == $an)//si on est en end ernière année on calcule le nb de jours $aa
            {
                foreach($moiss as $date => $mois)
                {
                    foreach($mois as $dat)
                    {
                        $aa++;
                    }
                }
            }
            elseif($compteura > $an)
            {
                break;
            }
            $compteura++;
        }//echo 'aa'.$aa;echo 'compteura'.$compteura;
        // echo 'www'.$mm.'www';
        // $mm = 0; //Compteur de mois qui s'incrémente de 1 afin de faire un compte indépendant des mois.
        $nbjrparmois = 0;
        $i = 1; //Compteur pour premier mois
        $a = 1; //Compteur pour la première année
        $nbmois = array();
        $nbjannee = array();
        foreach($aDates as $annee => $moiss)
        {
            //Calculer le nombre d'années
            // echo $annee;
            if($a == 1)//Si on est en première année
            {
                $nbjannee[] = $a1;//nb de jours de la première année
            }
            elseif($a == $an)
            {
                $nbjannee[] = $aa;
            }
            else
            {
                $nbjannee[] = cal_days_in_year($annee);
            }
            foreach($moiss as $date => $mois)
            {
                if($i == 1)//on est au premier mois
                {
                    //nb jours mois courant
                    $nbmois[] = $m1;
                }
                elseif($i == $m)//Si on est  le dernier mois de la période on met le nb de jours
                {
                    //nb de jours du dernier mois
                    $nbmois[] = $mm;
                }
                else
                {
                    //Pour les autres mois
                    $nbmois[] = cal_days_in_month(CAL_GREGORIAN, $date, $annee);
                }
                $i++;
            }
            $a++;
        }
        // print_r($nbjannee);
        $commerciaux = array();
        foreach($caarray as $comm)
        {
            $commerciaux[]=$comm['codemachine'];
        }
        // foreach($ca as $con)
        // {
        // if($con->getClient() =='AIRESS')
        // {
        // echo $con->getClient();echo '>>';echo $con->getDatemodif();echo '>>';echo $con->getMontantloc();echo '<br>';
        // }
        // }
        // print_r($commerciaux);
        // foreach($commerciaux as $com)
        // {
        // echo 'XXXXXXXXXX';echo $com;
        // }
        // echo $i;
        // print_r($nbmois);
        //aDates contient nos entêtes de colonnes
        return $this->render('BaclooCrmBundle:Crm:camensueltypemachinessl.html.twig', array(
            'dates' => $aDates,
            'dstart' => $dStart,
            'dend' => $dEnd,
            'search' => $search,
            'ca' => $ca,
            'nombrePage' => ceil(count($artica)/$nbparpage),
            'ans' => $an,
            'commerciaux' => $commerciaux,
            'nbjannee' => $nbjannee,
            'form' => $form->createView(),
            'page' => $page,
            'mode' => $mode,
            'nbmois' => $nbmois
        ));
    }

    public function speedfacAction($codelocations, $ecode)
    {
        $em = $this->getDoctrine()->getManager();

        $locations  = $em->getRepository('BaclooCrmBundle:Locations')
            ->findOneBy(array('id' => $codelocations, 'codemachineinterne' => $ecode));
        if(!isset($locations))
        {
            $locations  = $em->getRepository('BaclooCrmBundle:Locationssl')
                ->findOneBy(array('id' => $codelocations, 'codemachineinterne' => $ecode));
        }
        $machine  = $em->getRepository('BaclooCrmBundle:Machines')
            ->findOneByCode($ecode);
        if(!isset($locations))
        {
            $machine  = $em->getRepository('BaclooCrmBundle:Machinessl')
                ->findOneByCode($ecode);
        }

        if(isset($locations))
        {
            $locations->setEtatloc('Location terminée');
            $locations->setEtatlog('En attente de récup.');
            $em->persist($locations);
        }

        if(isset($machine))
        {
            $machine->setEtat('Location terminée');
            $machine->setEtatlog('En attente de récup.');
            $em->persist($machine);
        }
        $em->flush();

        if($vue == 'planning')
        {
            return $this->redirect($this->generateUrl('bacloocrm_planning'));
        }
        if($vue == 'planningsl')
        {
            return $this->redirect($this->generateUrl('bacloocrm_planningsl'));
        }
        else
        {
            return $this->redirect($this->generateUrl('bacloocrm_retours'));
        }
    }

    public function validation1Action($numfacture, $vue, $mode, $page)
    {
        $em = $this->getDoctrine()->getManager();
        $facture = $em->getRepository('BaclooCrmBundle:Factures')
            ->findOneById($numfacture);
        $facture->setValidation1(1);
        $facture->setValidation2(1);
        if($facture->getCodegroupe() > 0)
        {
            $facturesgroupe = $em->getRepository('BaclooCrmBundle:Factures')
                ->findByCodegroupe($facture->getCodegroupe());

            foreach ($facturesgroupe as $groupir)
            {
                $groupir->setValidation1(1);
                $groupir->setValidation2(1);
                $em->persist($groupir);
            }
        }
        $em->flush();
        return $this->redirect($this->generateUrl('bacloocrm_compta', array('vue' => $vue, 'mode' => $mode, 'page' => $page)));
    }

    public function devalidation1Action($numfacture, $vue, $mode, $page)
    {
        $em = $this->getDoctrine()->getManager();
        $facture = $em->getRepository('BaclooCrmBundle:Factures')
            ->findOneById($numfacture);
        $facture->setValidation1(0);
        $em->flush();
        return $this->redirect($this->generateUrl('bacloocrm_compta', array('vue' => $vue, 'mode' => $mode, 'page' => $page)));
    }

    public function validation2Action($numfacture, $vue, $mode, $page)
    {
        $em = $this->getDoctrine()->getManager();
        $facture = $em->getRepository('BaclooCrmBundle:Factures')
            ->findOneByNumfacfrs($numfacture);
        $facture->setValidation2(1);
        $em->flush();
        return $this->redirect($this->generateUrl('bacloocrm_compta', array('vue' => $vue, 'mode' => $mode, 'page' => $page)));
    }

    public function devalidation2Action($numfacture, $vue, $mode, $page)
    {
        $em = $this->getDoctrine()->getManager();
        $facture = $em->getRepository('BaclooCrmBundle:Factures')
            ->findOneByNumfacfrs($numfacture);
        $facture->setValidation2(0);
        $em->flush();
        return $this->redirect($this->generateUrl('bacloocrm_compta', array('vue' => $vue, 'mode' => $mode, 'page' => $page)));
    }

    private function getTimeDiff($dtime, $atime)
    {
        $nextDay = $dtime > $atime ? 1 : 0;
        $dep = explode(':', $dtime);
        $arr = explode(':', $atime);
        $diff = abs(mktime($dep[0], $dep[1], 0, date('n'), date('j'), date('y')) - mktime($arr[0], $arr[1], 0, date('n'), date('j') + $nextDay, date('y')));
        $hours = floor($diff / (60 * 60));
        $mins = floor(($diff - ($hours * 60 * 60)) / (60));
        $secs = floor(($diff - (($hours * 60 * 60) + ($mins * 60))));
        if (strlen($hours) < 2) {
            $hours = "0" . $hours;
        }
        if (strlen($mins) < 2) {
            $mins = "0" . $mins;
        }
        if (strlen($secs) < 2) {
            $secs = "0" . $secs;
        }
        return $hours . ':' . $mins;
    }

    public static function getHolidays($year = null)
    {
        if ($year === null)
        {
            $year = intval(strftime('%Y'));
        }

        $easterDate = easter_date($year);
        $easterDay = date('j', $easterDate);
        $easterMonth = date('n', $easterDate);
        $easterYear = date('Y', $easterDate);

        $holidays = array(
            // Jours feries fixes
            mktime(0, 0, 0, 1, 1, $year),// 1er janvier
            mktime(0, 0, 0, 5, 1, $year),// Fete du travail
            mktime(0, 0, 0, 5, 8, $year),// Victoire des allies
            mktime(0, 0, 0, 7, 14, $year),// Fete nationale
            mktime(0, 0, 0, 8, 15, $year),// Assomption
            mktime(0, 0, 0, 11, 1, $year),// Toussaint
            mktime(0, 0, 0, 11, 11, $year),// Armistice
            mktime(0, 0, 0, 12, 25, $year),// Noel

            // Jour feries qui dependent de paques
            mktime(0, 0, 0, $easterMonth, $easterDay + 1, $easterYear),// Lundi de paques
            mktime(0, 0, 0, $easterMonth, $easterDay + 39, $easterYear),// Ascension
            mktime(0, 0, 0, $easterMonth, $easterDay + 50, $easterYear), // Pentecote
        );

        sort($holidays);

        return $holidays;
    }

    public function speedclientAction(Request $request)
    {
        $defaultData = array();
        $form2 = $this->createFormBuilder($defaultData)
            ->add('cliento', 'text', array('required' => false))
            ->getForm();
        $form2->handleRequest($request);
        $message = 0;
        if($request->getMethod() == 'POST')
        {
            $data = $form2->getData();
            $client = $data['cliento'];
            $em = $this->getDoctrine()->getManager();
            $fiche = $em->getRepository('BaclooCrmBundle:Fiche')
                ->findOneByRaisonSociale($client);
            if(!empty($fiche))
            {
                return $this->redirect($this->generateUrl('bacloocrm_voir', array('id' => $fiche->getId())));
            }
            else
            {
                return $this->redirect($this->generateUrl('bacloocrm_search'));
            }
        }
        return $this->render('BaclooCrmBundle:Crm:speedclient.html.twig', array(
            'form2' => $form2->createView(),
            'message' => $message
        ));
    }

    public function speedcontratAction(Request $request)
    {
        $defaultData = array();
        $form3 = $this->createFormBuilder($defaultData)
            ->add('contrat', 'text', array('required' => false))
            ->getForm();
        $form3->handleRequest($request);
        $message = 0;
        if ($form3->isValid()) {
            $data = $form3->getData();
            $contrat = $data['contrat'];
            $em = $this->getDoctrine()->getManager();
            if($contrat[0] == 'V' or $contrat[0] == 'v')
            {
                $typenum = 'vente';
                $codevenda = substr($contrat, 2); //On envlève le V-
                $locata = $em->getRepository('BaclooCrmBundle:Venda')
                    ->findOneById($codevenda);
                if(!empty($locata))
                {
                    return $this->redirect($this->generateUrl('bacloocrm_ventes', array('ficheid' => $locata->getClientid(), 'vendaid' => $locata->getId())));
                }
                else
                {
                    return $this->redirect($this->generateUrl('bacloocrm_search'));
                }
            }
            else
            {
                $typenum = 'location';
                $locata = $em->getRepository('BaclooCrmBundle:Locata')
                    ->findOneById($contrat);
                if(!empty($locata))
                {
                    return $this->redirect($this->generateUrl('bacloocrm_ajouterlocation', array('ficheid' => $locata->getClientid(), 'locid' => $locata->getId() )));
                }
                else
                {
                    return $this->redirect($this->generateUrl('bacloocrm_search'));
                }
            }
        }
        return $this->render('BaclooCrmBundle:Crm:speedcontrat.html.twig', array(
            'form3' 		  => $form3->createView(),
            'message' => $message
        ));
    }

    public function requete2entrepriseAction(Request $request)
    {
        // $request = $request->get('request');
        // if($request == 1){
        $search = $request->get('search');
        // $search = 'altitop';
        if(!empty($search))
        {
            $em = $this->getDoctrine()->getManager();
            $query = $em->createQuery(
                'SELECT f
					FROM BaclooCrmBundle:Fiche f
					WHERE f.raisonSociale LIKE :raison
					Group By f.raisonSociale'
            );
            $query->setParameter('raison', '%'.$search.'%');
            $result = $query->getArrayResult();

            // Transformer le tableau associatif en un tableau standard
            $array = array();
            foreach ($result as $data) {
                $array[] = array("label"=>$data['raisonSociale']);
            }
        }
        $response = new Response(json_encode($array));
        return $response;
        // }
    }

    public function requete2entreprise2Action(Request $request)
    {
        // $request = $request->get('request');
        // if($request == 1){
        $search = $request->get('search');
        $codemachine = $request->get('codemachine');
//        $codemachine = 'CT6G';
//        $search = 'cc';
        if(!empty($search))
        {
            $em = $this->getDoctrine()->getManager();
            $query = $em->createQuery(
                'SELECT f
					FROM BaclooCrmBundle:Fiche f
					WHERE f.raisonSociale LIKE :raison
					AND f.statutcompte = :statutcompte
					AND f.typefiche = :typefiche
					Group By f.raisonSociale'
            );
            $query->setParameter('raison', '%'.$search.'%');
            $query->setParameter('statutcompte', 0);
            $query->setParameter('typefiche', 'client');
            $result = $query->getArrayResult();

            // Transformer le tableau associatif en un tableau standard
            $array = array();
            foreach ($result as $data) {
                $query = $em->createQuery(
                    'SELECT f
					FROM BaclooCrmBundle:Grille f
					WHERE f.codemachineinterne = :codemachineinterne
					AND f.codeclient = :codeclient'
                );
                $query->setParameter('codemachineinterne', $codemachine);
                $query->setParameter('codeclient', $data['id']);
                $grille = $query->getOneOrNullResult();

                if(isset($grille) and $grille->getLoyerp1() > 0)
                {//echo '<br>000idd'.$data['id'];echo $data['raisonSociale'];
                    $array[] = array("label"=>$data['raisonSociale'], "p1"=>$grille->getLoyerp1(), "p2"=>$grille->getLoyerp2(), "p3"=>$grille->getLoyerp3(), "p4"=>$grille->getLoyerp4(), "p5"=>$grille->getLoyermensuel());
                }
                else
                {//echo '<br>okokkidd'.$data['id'];echo $data['raisonSociale'];
                    $array[] = array("label"=>$data['raisonSociale'], "p1"=>0, "p2"=>0, "p3"=>0, "p4"=>0, "p5"=>0);
                }
            }
        }
        $response = new Response(json_encode($array));
        return $response;
        // }
    }

    public function litrescarbAction($codelocation, $litrescarb, Request $request)
    {
        $em = $this->getDoctrine()->getManager();

        $defaultData = array();
        $form = $this->createFormBuilder($defaultData)
            ->add('litrescarb', 'number', array('required' => true))
            ->add('codelocation', 'integer', array('required' => false))
            ->getForm();
        $form->handleRequest($request);
        // On vérifie qu'elle est de type POST
        if ($request->getMethod() == 'POST')
        {
            // On vérifie que les valeurs entrées sont correctes
            if($form->isValid()) {
                $data = $form->getData();
                $litrescarb = $data['litrescarb'];
                $codelocation = $data['codelocation'];
                $location = $em->getRepository('BaclooCrmBundle:Locations')
                    ->findOneById($codelocation);
                $location->setLitrescarb($litrescarb);
                $em->persist($location);
                $em->flush();

                return $this->redirect($this->generateUrl('bacloocrm_adispatcher'));
            }

        }
        return $this->render('BaclooCrmBundle:Crm:litrescarb.html.twig', array(
            'form' => $form->createView(),
            'codelocation' => $codelocation,
            'litrescarb' => $litrescarb
        ));
    }

    public function extraitcompteformAction($clientid, $du, $au, Request $request)
    {
        $em = $this->getDoctrine()->getManager();
        $listerelance = $em->getRepository('BaclooCrmBundle:Factures')
            ->extraitcompte($clientid, $du, $au);
        $fiche = $em->getRepository('BaclooCrmBundle:Fiche')
            ->findOneById($clientid);

        $defaultData = array();
        $form4 = $this->createFormBuilder($defaultData)
            ->add('du', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => false,
                'attr' => array('class' => 'date'),
            ))
            ->add('au', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => false,
                'attr' => array('class' => 'date'),
            ))
            ->getForm();
        if ($request->getMethod() == 'POST') {
            $form4->handleRequest($request);
            $data = $form4->getData();
            $du = $data['du'];
            $au = $data['au'];

            return $this->redirect($this->generateUrl('bacloocrm_extraitcompte', array('clientid' => $clientid, 'du' => $du, 'au' => $au)));
        }
        if ($du == 0 and $au == 0) {
            $year = date('Y') - 3;
            $du = date($year . '-01-01');
            $au = date('Y-m-d');
        }
        return $this->render('BaclooCrmBundle:Crm:extraitcompteform.html.twig', array(
            'form4' => $form4->createView(),
            'du' => $du,
            'au' => $au,
            'clientid' => $clientid
        ));
    }

    public function extraitcompteAction($clientid, $du, $au, Request $request)
    {
        $em = $this->getDoctrine()->getManager();
        $listerelance = $em->getRepository('BaclooCrmBundle:Factures')
            ->extraitcompte($clientid, $du, $au);
        $fiche = $em->getRepository('BaclooCrmBundle:Fiche')
            ->findOneById($clientid);

        if($du == 0 and $au == 0)
        {
            $year = date('Y') - 3;
            $du = date($year.'-01-01');
            $au = date('Y-m-d');
        }

        $pdf = $this->get("white_october.tcpdf")->create();
        $html = $this->renderView('BaclooCrmBundle:Crm:extraitcompte.html.twig', array(
            'listerelance' => $listerelance,
            'du' => $du,
            'au' => $au,
            'client' => $fiche->getRaisonSociale()
        ));
        $pdf->SetFont('helvetica', '', 9, '', true);

        $pdf->AddPage('P', 'A4');

        // -- set new background ---

        // get the current page break margin
        $bMargin = $pdf->getBreakMargin();
        // get current auto-page-break mode
        $auto_page_break = $pdf->getAutoPageBreak();
        // disable auto-page-break
        $pdf->SetAutoPageBreak(false, 0);
        // set bacground image
        $img_file = K_PATH_IMAGES.'grilletemplate.jpg';
        $pdf->Image($img_file, 0, 0, 210, 297, 'JPG', '', '', false, 300, '', false, false, 0);
        // restore auto-page-break status
        $pdf->SetAutoPageBreak($auto_page_break, $bMargin);
        // set the starting point for the page content
        $pdf->setPageMark();
        $pdf->writeHTML($html, true, false, true, false, '');
        $pdf->lastPage();

        $response = new Response($pdf->Output('file.pdf'));
        $response->headers->set('Content-Type', 'application/pdf');

        return $response;
    }

    public function extraitcomptem1Action()
    {
        $em = $this->getDoctrine()->getManager();
        $listerelance = $em->getRepository('BaclooCrmBundle:Factures')
            ->extraitcomptem1();

        $pdf = $this->get("white_october.tcpdf")->create();
        $html = $this->renderView('BaclooCrmBundle:Crm:extraitcomptem1.html.twig', array(
            'listerelance' => $listerelance
        ));
        $pdf->SetFont('helvetica', '', 9, '', true);

        $pdf->AddPage('L', 'A4');

        // -- set new background ---

        // get the current page break margin
        $bMargin = $pdf->getBreakMargin();
        // get current auto-page-break mode
        $auto_page_break = $pdf->getAutoPageBreak();
        // disable auto-page-break
        $pdf->SetAutoPageBreak(false, 0);
        // set bacground image
        $img_file = K_PATH_IMAGES.'grilletemplate.jpg';
        $pdf->Image($img_file, 0, 0, 210, 297, 'JPG', '', '', false, 300, '', false, false, 0);
        // restore auto-page-break status
        $pdf->SetAutoPageBreak($auto_page_break, $bMargin);
        // set the starting point for the page content
        $pdf->setPageMark();
        $pdf->writeHTML($html, true, false, true, false, '');
        $pdf->lastPage();

        $response = new Response($pdf->Output('file.pdf'));
        $response->headers->set('Content-Type', 'application/pdf');

        return $response;
    }

    public function camensuelfrsAction($mode, $page, $search, $dStart, $dEnd,  $client, Request $request)
    {
        $nbparpage = 60;
        $defaultData = array();
        $form = $this->createFormBuilder($defaultData)
            ->add('du', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => false,
                'attr' => array('class' => 'date'),
            ))
            ->add('au', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => false,
                'attr' => array('class' => 'date'),
            ))
            ->add('fournisseur', 'text', array('required' => false))
            ->getForm();
        if($request->getMethod() == 'POST') {//echo 'VALIDE';
            $form->handleRequest($request);
            $data = $form->getData();//var_dump($data);
            if(isset($data['du']))
            {
                $dStart = $data['du'];
            }
            if(isset($data['au']))
            {
                $dEnd = $data['au'];
            }
            if(isset($data['fournisseur']))
            {
                $client = $data['fournisseur'];
            }
            $search = 1;
        }
// echo 'dend '.$dEnd;
        if($dStart == 0)
        {
            $dStart = date('Y-m-d', strtotime("-6 months"));
        }

        if($dEnd == 0)
        {
            $dEnd = date('Y-m-d');
        }
// echo $dStart;
        // $dEnd = '2018-11-30';
// echo 'search'.$search;
        //1.Récupérer les données de la table Faccture
        $em = $this->getDoctrine()->getManager();

        $today = date('Y-m-d');
        $prev12 = date('Y-m-d', strtotime("-6 months"));
        $ca = $em->getRepository('BaclooCrmBundle:Locatafrs')
            ->cafrs($dStart, $dEnd);
//foreach ($ca as $cafrs)
//{
//foreach ($cafrs->getLocationsfrs() as $couille) {
//    echo $couille->getFournisseur();
//}
//}exit();
        $caclientsl  = $em->getRepository('BaclooCrmBundle:Locata')
            ->camensuelclientsl($search, $dStart, $dEnd, $client);

        $caarray  = $em->getRepository('BaclooCrmBundle:Locatafrs')
            ->camensuelarrayclient($search, $nbparpage, $page, $dStart, $dEnd, $client);

        $artica = $em->getRepository('BaclooCrmBundle:Locatafrs')
            ->camensuelarrayclienttotal($dStart, $dEnd, $client, $search);
// var_dump($ca);
// echo '$$$$$$'.print_r($ca);	echo '<<<<<';
        //2.On génère les entêtes de colonnes à partir de la fonction createplanning
        $iStart = strtotime ($dStart);//Formate une date/heure locale avec la Something is wronguration locale
        $iEnd = strtotime ($dEnd);
        if (false === $iStart || false === $iEnd) {
            // return false;
        }
        $aStart = explode ('-', $dStart);
        $aEnd = explode ('-', $dEnd);
        if (count ($aStart) !== 3 || count ($aEnd) !== 3) {
            // return false;
        }
        // if (false === checkdate ($aStart[1], $aStart[2], $aStart[0]) || false === checkdate ($aEnd[1], $aEnd[2], $aEnd[0]) || $iEnd <= $iStart) {
        // return false;
        // }
        for ($i = $iStart; $i < $iEnd + 86400; $i = strtotime ('+1 day', $i) ) {
            $sDateToArr = strftime ('%Y-%m-%d', $i);
            $sYear = substr ($sDateToArr, 0, 4);
            $sMonth = substr ($sDateToArr, 5, 2);
            $aDates[$sYear][$sMonth][] = $sDateToArr;
        }

        $nbannee = 0;
        $nbmoisparannee = 0;
        //Calcule le nombre de jours dans le mois
        $annee1 = date("Y", strtotime($dStart));
        $anneef = date("Y", strtotime($dStart));
        $anneefin = $anneef + 1;

        //Boucle parcours tableau année, mois, jours.
        //Celle-ci renvoie le nombre de  jours du premier mois m1
        $m11 = 1;
        foreach($aDates as $annee => $moiss)
        {
            foreach($moiss as $date => $mois)
            {
                if($m11 == 1)//si on est en m1 on procède sinon break
                {
                    foreach($mois as $dat)
                    {
                        $m11++;
                    }
                }
                else
                {
                    break;
                }
            }

        }
        $m1 = $m11-1;
        //Calcul du nb total de mois $m
        $m = 0;
        foreach($aDates as $annee => $moiss)
        {
            foreach($moiss as $date => $mois)
            {
                $m++;
            }

        }

        //Calcul du nb total d'années $a
        $an = 0;
        foreach($aDates as $annee => $moiss)
        {
            $an++;
        }
// echo $m;
        //Celle-ci renvoie le nombre de jours du dernier mois mm
        $mm = 0;
        $compteurm = 1;
        foreach($aDates as $annee => $moiss)
        {
            foreach($moiss as $date => $mois)
            {
                if($compteurm == $m)//si on est le dernier mois
                {
                    foreach($mois as $dat)
                    {
                        $mm++;
                    }
                }
                else
                {}
                $compteurm++;
            }

        }

        //Celle-ci renvoie le nombre de jours de la première année $a1
        $a11 = 1;
        foreach($aDates as $annee => $moiss)
        {
            if($a11 == 1)//si on est en a1 on procède sinon break
            {
                foreach($moiss as $date => $mois)
                {
                    foreach($mois as $dat)
                    {
                        $a11++;
                    }
                }
            }
            else
            {
                break;
            }
        }
        $a1 = $a11-1;
        //Fonction qui calcule le nombre de jours dans l'année
        function cal_days_in_year($year){
            $days=0;
            for($month=1;$month<=12;$month++){
                $days = $days + cal_days_in_month(CAL_GREGORIAN,$month,$year);
            }
            return $days;
        }
        //Celle-ci renvoie le nombre de jours de la dernière année $aa
        $aa = 0;
        $compteura = 1;//echo '$an'.$an;
        foreach($aDates as $annee => $moiss)
        {
            if($compteura == $an)//si on est en end ernière année on calcule le nb de jours $aa
            {
                foreach($moiss as $date => $mois)
                {
                    foreach($mois as $dat)
                    {
                        $aa++;
                    }
                }
            }
            elseif($compteura > $an)
            {
                break;
            }
            $compteura++;
        }//echo 'aa'.$aa;echo 'compteura'.$compteura;
        // echo 'www'.$mm.'www';
        // $mm = 0; //Compteur de mois qui s'incrémente de 1 afin de faire un compte indépendant des mois.
        $nbjrparmois = 0;
        $i = 1; //Compteur pour premier mois
        $a = 1; //Compteur pour la première année
        $nbmois = array();
        $nbjannee = array();
        foreach($aDates as $annee => $moiss)
        {
            //Calculer le nombre d'années
            // echo $annee;
            if($a == 1)//Si on est en première année
            {
                $nbjannee[] = $a1;//nb de jours de la première année
            }
            elseif($a == $an)
            {
                $nbjannee[] = $aa;
            }
            else
            {
                $nbjannee[] = cal_days_in_year($annee);
            }
            foreach($moiss as $date => $mois)
            {
                if($i == 1)//on est au premier mois
                {
                    //nb jours mois courant
                    $nbmois[] = $m1;
                }
                elseif($i == $m)//Si on est  le dernier mois de la période on met le nb de jours
                {
                    //nb de jours du dernier mois
                    $nbmois[] = $mm;
                }
                else
                {
                    //Pour les autres mois
                    $nbmois[] = cal_days_in_month(CAL_GREGORIAN, $date, $annee);
                }
                $i++;
            }
            $a++;
        }
        // print_r($nbjannee);
        $commerciaux = array();
        foreach($caarray as $comm)
        {
            $commerciaux[]=$comm->getFournisseur();
        }
        // foreach($ca as $con)
        // {
        // if($con->getClient() =='AIRESS')
        // {
        // echo $con->getClient();echo '>>';echo $con->getDatemodif();echo '>>';echo $con->getMontantloc();echo '<br>';
        // }
        // }
        // print_r($commerciaux);
        // foreach($commerciaux as $com)
        // {
        // echo 'XXXXXXXXXX';echo $com;
        // }
        // echo $i;
        // print_r($nbmois);
        //aDates contient nos entêtes de colonnes
        return $this->render('BaclooCrmBundle:Crm:camensuelfrs.html.twig', array(
            'dates' => $aDates,
            'dstart' => $dStart,
            'dend' => $dEnd,
            'search' => $search,
            'ca' => $ca,
            'caclientsl' => $caclientsl,
            'nombrePage' => ceil(count($artica)/$nbparpage),
            'ans' => $an,
            'commerciaux' => $commerciaux,
            'nbjannee' => $nbjannee,
            'form' => $form->createView(),
            'page' => $page,
            'mode' => $mode,
            'nbmois' => $nbmois
        ));
    }

//    public function admin2Action()
//    {
//        $em = $this->getDoctrine()->getManager();
//        $locata = $em->getRepository('BaclooCrmBundle:Locata')
//            ->locatamoisdertoday();
//        $factures = $em->getRepository('BaclooCrmBundle:Factures')
//            ->facturesmoisdertoday();
//
//        return $this->render('BaclooCrmBundle:Crm:admin2.html.twig', array(
//            'locata' => $locata,
//            'factures' => $factures
//        ));
//    }

    public function admin2Action()
    {
        $connection = $this->getDoctrine()->getConnection();

        $endDate = new \DateTime('last day of last month');

        $startDate = (clone $endDate)->modify('-6 months')->modify('first day of this month');

        $startStr = $startDate->format('Y-m-d');
        $endStr = $endDate->format('Y-m-d');

        $sql = "
        SELECT l.id AS locata_id, loc.debutloc, loc.finloc, loc.etatloc, l.clientid
        FROM Locata l
        JOIN locata_locations ll ON ll.locata_id = l.id
        JOIN Locations loc ON loc.id = ll.locations_id
        WHERE l.contrat = 1
          AND (
            STR_TO_DATE(loc.finloc, '%Y-%m-%d') >= :start
            AND STR_TO_DATE(loc.debutloc, '%Y-%m-%d') <= :end
          )
          AND NOT EXISTS (
            SELECT 1
            FROM Factures f
            WHERE f.codelocata = l.id
              AND STR_TO_DATE(f.datecrea, '%Y-%m-%d') BETWEEN :start AND :end
          )  
        GROUP BY l.id
    ";

        $results = $connection->fetchAll($sql, [
            'start' => $startStr,
            'end' => $endStr
        ]);

        return $this->render('BaclooCrmBundle:Crm:contrats_non_factures.html.twig', [
            'results' => $results,
            'start' => $startStr,
            'end' => $endStr
        ]);
    }

    public function camensuelfrsdetailleAction($mois, $fournisseur, Request $request)
    {
        $nbparpage = 30;
        $defaultData = array();
        $form = $this->createFormBuilder($defaultData)
            ->add('date', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => false,
                'attr' => array('class' => 'date'),
            ))
            ->add('fournisseur', 'text', array('required' => false))
            ->getForm();
        if($request->getMethod() == 'POST') {//echo 'VALIDE';
            $form->handleRequest($request);
            $data = $form->getData();//var_dump($data);
            if(isset($data['date']))
            {
                $mois = $data['date'];
                $mois = date("Ym",strtotime($mois));
            }
            if(isset($data['fournisseur']))
            {
                $fournisseur = $data['fournisseur'];
            }
            $search = 1;
        }
// echo 'dend '.$dEnd;
        if($mois == 0)
        {
            $mois = date('Ym');
        }
// echo $dStart;
        // $dEnd = '2018-11-30';
// echo 'search'.$search;
        //1.Récupérer les données de la table Faccture
        $em = $this->getDoctrine()->getManager();

        $ca = $em->getRepository('BaclooCrmBundle:Locatafrs')
            ->cafrsdetaille($mois, $fournisseur);//echo 'frs0'.$fournisseur;
//foreach ($ca as $cafrs)
//{echo 'frs1'.$cafrs->getFournisseur();
//foreach ($cafrs->getLocationsfrs() as $couille) {
//    echo 'frs2'.$couille->getFournisseur();
//}
//}exit();
        $caclientsl = $em->getRepository('BaclooCrmBundle:Locata')
            ->camensuelclientsldet($mois, $fournisseur);

        //2.On génère les entêtes de colonnes à partir de la fonction createplanning

        return $this->render('BaclooCrmBundle:Crm:camensuelfrsdetaille.html.twig', array(
            'mois' => $mois,
            'ca' => $ca,
            'caclientsl' => $caclientsl,
            'fournisseur' => $fournisseur,
            'form' => $form->createView()
        ));
    }

    public function listedevisAction($vue, $mode, $page, $message, $date, $nbresult, $style, $compteclient, Request $request)
    {
        $user = $this->get('security.context')->getToken()->getUsername();
        $objUser = $user;
        if(empty($objUser) or !isset($objUser) or $objUser == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}

        if($this->getRequest()->request->get('pagination') > 0)
        {
            $page = $this->getRequest()->request->get('pagination');
        }
//        else
//        {
//            $page = 1;
//        }
// $date = '2019-08-14';
// echo $date;
// echo date('Y-m-t', strtotime($date));
        $em = $this->getDoctrine()->getManager();
        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($objUser);
        $nbparpage = 50;
        $today = date('Y-m-d');
        // $session = new Session();
        // $session = $request->getSession();
        // $session->set('page', $page);
        // $page = $session->get('page');
// $date = strtotime(date('Y-m-01'));
// $d15 = strtotime('+14 days',$date);
// echo date('Y-m-d', $d15);*
// $mois15 = strtotime(date('Y-m-01', strtotime(" -1 month")));
// $m15 = strtotime('+14 days',$mois15);
// echo date('Y-m-d', $m15);

//        $em->flush();
        //création du formlaire de recherche de factures
        $defaultData = array();
        $form2 = $this->createFormBuilder($defaultData)
            ->add('du', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => false,
                'attr' => array('class' => 'date'),
            ))
            ->add('au', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => false,
                'attr' => array('class' => 'date'),
            ))
            ->add('user', 'choice', array(
                'choices'   => array(
                    'Non attribué'   => '',
                    'Bureau'   => 'Buerau',
                    'Cobilas'   => 'Cobilas',
                ),
                'multiple'  => false,
            ))
            ->add('ville', 'text', array('required' => false))
            ->add('totalttc', 'number', array('required' => false))
            ->add('echeance', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => false,
                'attr' => array('class' => 'date'),
            ))
            ->add('numfacture', 'text', array('required' => false))
            // ->add('clientid', 'text', array('required' => false))
            // ->add('typedoc', 'choice', array(
            // 'choices'   => array(
            // 'facture'   => 'Facture',
            // ),
            // 'multiple'  => false,
            // ))
            ->add('client', 'text', array('required' => false))
            ->add('ville', 'text', array('required' => false))
            ->add('cp', 'number', array('required' => false))
            ->add('ttcgroupe', 'number', array('required' => false))
            ->add('daterech', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => false,
                'read_only' => false,
                'attr' => array('class' => 'daterech'),
            ))
            ->add('dejareg', 'number', array('required' => false))
            ->add('modepaiement', 'choice', array(
                'choices'   => array(
                    'vide'   => '',
                    'virement'   => 'Virement',
                    'cheque' => 'Chèque',
                    'cb' => 'CB',
                    'cpt' => 'CPT',
                    'lcr' => 'L.C.R',
                    'Trop perçu' => 'Trop perçu',
                    'prélèvement' => 'Prélèvement',
                    'Liquidation' => 'Liquidation',
                ),
                'multiple'  => false,
            ))
            // ->add('reglement', 'choice', array(
            // 'choices'   => array(
            // 0   => '',
            // 1   => 'Comptant',
            // 2   => '45 jours fdm',
            // ),
            // 'data' => 2,
            // 'multiple'  => false,
            // ))
            ->getForm();

        $session = new Session();
        $session = $request->getSession();
//        $ville = $compteclient;
//        $session->set('ville', $ville);
        if($request->getMethod() == 'POST')
        {//echo 'post'; echo $this->getRequest()->request->get('envoyer');
            if ($this->getRequest()->request->get('recherche') == 'Rechercher')
            {//echo 'recherche';
                $form2->handleRequest($request);
                // if($form2->isValid()){echo 'ttttttt';
                $data = $form2->getData();
                $du = $data['du'];
                $au = $data['au'];
                $echeance = $data['echeance'];
                $daterech = $data['daterech'];
                $dejareg = $data['dejareg'];
                // $clientid = $data['clientid'];
                $client = $data['client'];//echo 'CLIENT'.$client;
                $ville = $data['ville'];//echo 'CLIENT'.$ville;
                $suivipar = $data['user'];//echo 'CLIENT'.$suivipar;
                $numfacture = $data['numfacture'];//echo 'CLIENT'.$client;
                $cp1 = $data['cp'];//echo 'CLIENT'.$client;
                $ttcgroupe1 = $data['ttcgroupe'];//echo 'CLIENT'.$client;
                $modepaiement = $data['modepaiement'];//echo 'CLIENT'.$client;
                // $reglement = $data['reglement'];
                // $typedoc = $data['typedoc'];
                // $datecrea = $data['datecrea'];
                $session = new Session();
                $session = $request->getSession();

                // définit et récupère des attributs de session
                $session->set('du', $du);
                $session->set('au', $au);
                $session->set('echeance', $echeance);
                $session->set('client', $client);
                $session->set('ville', $ville);
                $session->set('suivipar', $suivipar);
                $session->set('numfacture', $numfacture);
                $session->set('cp', $cp1);
                $session->set('ttcgroupe', $ttcgroupe1);
                $session->set('modepaiement', $modepaiement);
                $session->set('daterech', $daterech);
                $session->set('dejareg', $dejareg);
                // }
            }
            elseif ($this->getRequest()->request->get('maj') == 'Enregistrer')
            {//echo 'maj';

            }
        }

        $session = $request->getSession();
        if(null !== $session->get('du'))
        {
            $du = $session->get('du');
        }
        else
        {
            $du = 0;
        }
        if(null !== $session->get('au'))
        {
            $au = $session->get('au');
        }
        else
        {
            $au = 0;
        }
        if(null !== $session->get('echeance'))
        {
            $echeance = $session->get('echeance');
        }
        else
        {
            $echeance = 0;
        }
        if(null !== $session->get('client'))
        {
            $client = $session->get('client');
        }
        if(null !== $session->get('ville'))
        {
            $ville = $session->get('ville');
        }
        if(null !== $session->get('suivipar'))
        {
            $suivipar = $session->get('suivipar');
        }
        if(null !== $session->get('numfacture'))
        {
            $numfacture = $session->get('numfacture');
        }
        if(null !== $session->get('cp'))
        {
            $cp = $session->get('cp');
        }
        if(null !== $session->get('ttcgroupe'))
        {
            $ttcgroupe = $session->get('ttcgroupe');
        }
        if(null !== $session->get('modepaiement'))
        {
            $modepaiement = $session->get('modepaiement');
        }
        if(null !== $session->get('dejareg'))
        {
            $dejareg = $session->get('dejareg');
        }
        if(null !== $session->get('daterech'))
        {
            $daterech = $session->get('daterech');
        }
        // echo 'la sessin daterech'.$session->get('daterech');

        if($du == ''or !isset($du) or $mode == 'all')
        {
            $du = 0;
        }
        if($au == '' or !isset($au) or $mode == 'all')
        {
            $au = 0;
        }
        if($echeance == '' or !isset($echeance))
        {
            $echeance = 0;
        }
        if(!isset($clientid))
        {
            $clientid = 0;
        }
        if(!isset($client))
        {
            $client = 0;
        }
        if(!isset($ville))
        {
            $ville = 0;
        }
        if(!isset($suivipar) or $mode == 'all')
        {
            $suivipar = 0;
        }
        if(!isset($reglement))
        {
            $reglement = 0;
        }
        elseif($reglement == 666)
        {
            $reglement = 0;
        }
        if(!isset($typedoc))
        {
            $typedoc = 0;
        }
        if(!isset($numfacture))
        {
            $numfacture = 0;
        }
        if(!isset($datecrea))
        {
            $datecrea = 0;
        }
        if(!isset($cp))
        {
            $cp = 0;
        }
        if(!isset($ttcgroupe))
        {
            $ttcgroupe = 0;
        }
        if(!isset($modepaiement))
        {
            $modepaiement = 0;
        }
        if(!isset($daterech))
        {
            // echo 'datrech00000'.$daterech;
            $daterech = 0;
        }
        else
        {
            // echo 'datechoookkkkXXXXXXX'.$daterech;
        }
        if(!isset($dejareg))
        {
            $dejareg = 0;
        }
        //echo 'aaaaaaaaaaaa'.$ville;
// echo 'MOOOODE'.$mode;echo 'CLIENNNN'.$client;echo 'NUmfacture'.$numfacture;echo 'modepaiement'.$modepaiement;echo 'cp'.$cp;
//echo 'MOOOODE'.$mode;echo 'CLIENNNN'.$client;echo 'NUmfacture'.$numfacture;echo 'modepaiement'.$modepaiement;echo 'cp'.$cp;
            $em = $this->getDoctrine()->getManager();

            $devis = $em->getRepository('BaclooCrmBundle:Locata')
                    ->listedevis($vue, $mode, $client, $cp, $nbparpage, $page, $ville, $suivipar, $du, $au);

            $devisfaits = $em->getRepository('BaclooCrmBundle:Locata')
                ->devisfaits($du, $au, $suivipar, $nbparpage, $page);
            $nbdevisfaits = count($devisfaits);
            $devis = $devisfaits;

            $devisacceptes = $em->getRepository('BaclooCrmBundle:Locata')
                ->devisacceptes($du, $au, $suivipar);
            $nbdevisacceptes = count($devisacceptes);

            $devissanssuite = $em->getRepository('BaclooCrmBundle:Locata')
                ->devissanssuite($du, $au, $suivipar);
            $nbdevissanssuite = count($devissanssuite);

            $devisencours = $em->getRepository('BaclooCrmBundle:Locata')
                ->devisencours($du, $au, $suivipar);
            $nbdevisencours = count($devisencours);
            if($style === 'encours')
            {
                $devis = $devisencours;
            }
            elseif($style === 'accepte')
            {
                $devis = $devisacceptes;
            }
            elseif($style === 'sanssuite')
            {
                $devis = $devissanssuite;
            }

        return $this->render('BaclooCrmBundle:Crm:listedevis.html.twig', array(
            'factures' => $devis,
            'form2' => $form2->createView(),
            'user' => $user,
            'userdetails' => $userdetails,
            'mode' => $mode,
            'vue' => $vue,
            'message' => $message,
            'date' => $date,
            'du' => $du,
            'au' => $au,
            'echeance' => $echeance,
            // 'clientid' => $clientid,
            'client' => $client,
            'ville' => $ville,
            'suivipar' => $suivipar,
            // 'reglement' => $reglement,
            'typedoc' => $typedoc,
            'numfacture' => $numfacture,
            'cp' => $cp,
            'ttcgroupe' => $ttcgroupe,
            'modepaiement' => $modepaiement,
            'datecrea' => $datecrea,
            'devisfaits' => $devisfaits,
            'devisacceptes' => $devisacceptes,
            'devissanssuite' => $devissanssuite,
            'dejareg' => $dejareg,
            'daterech' => $daterech,
            'nbdevisfaits' => $nbdevisfaits,
            'nbdevisacceptes' => $nbdevisacceptes,
            'nbdevissanssuite' => $nbdevissanssuite,
            'nbdevisencours' => $nbdevisencours,
            'style' => $style,
            'nombrePage' => ceil(count($devis)/$nbparpage),
            'page'	  	  => $page
        ));
    }

    public function affecterreglementAction($clientid, $mode, $style, $reset, Request $request)
    {
        $em = $this->getDoctrine()->getManager();
        //On récupère les factures et avoirs en attente de paiement de ce client
        $factures = $em->getRepository('BaclooCrmBundle:Factures')
            ->apayer($clientid);

        //On récupère le troppercu
        $client = $em->getRepository('BaclooCrmBundle:Fiche')
            ->findOneById($clientid);
        $entreprise = $client->getRaisonsociale();
        $troppercu = $client->getTroppercu();

        if($reset == 1)
        {
            $regla = $em->getRepository('BaclooCrmBundle:Regla')
                ->findAll();
            foreach($regla as $regle)
            {
                $em->remove($regle);
            }

            $reglement = $em->getRepository('BaclooCrmBundle:Reglement')
                ->findAll();
            foreach($reglement as $reglemen)
            {
                $em->remove($reglemen);
            }
            $em->flush();
        }

        $regla = $em->getRepository('BaclooCrmBundle:Regla')
            ->findOneByClientid($clientid);

        if(!isset($regla) && empty($regla))
        {
            //On remplit regla et reglatype
            $regla = new Regla;
            $regla->setClientid($clientid);
            $regla->setClient($client->getRaisonsociale());
            $regla->setTroppercu($troppercu);
            $regla->setDatepaiment(date('Y-m-d'));
            $regla->setModepaiement($client->getTypepaiement());

            //Remplissage de reglement
            foreach($factures as $fac)
            {
                $reglo = new Reglement;
                $reglo->setNumfacture($fac->getNumfacture());
                $reglo->setTotalttc($fac->getTotalttc());
                $reglo->setTypedoc($fac->getTypedoc());
                $reglo->setEcheance($fac->getEcheance());
                $reglo->setMontantavoir($fac->getMontantavoir());
                $reglo->setEcheance($fac->getEcheance());
                $reglo->addRegla($regla);
                $regla->addReglement($reglo);
                $em->persist($reglo);
            }
            $em->persist($regla);
            $em->flush();
        }

        $regla = $em->getRepository('BaclooCrmBundle:Regla')
            ->findOneByClientid($clientid);
        //On créée le formulaire
        $form = $this->createForm(new ReglaType(), $regla);
        // On récupère la requête
        $request = $this->get('request');
        // On vérifie qu'elle est de type POST
        if ($request->getMethod() == 'POST')
        {
            $form->bind($request);
            if ($form->isValid()){
                if($this->getRequest()->request->get('controle') == 'Controler')
                {
                    $montantimpute = 0;
                    foreach($form->get('reglement')->getData() as $regle)
                    {
                        if($regle->getSelection() == 1)
                        {echo 'rrrrrrrrrrrr';
                            if($regle->getTypedoc() == 'facture')
                            {
                                if($regle->getTroppercu() == 1)
                                {
                                    if($regla->getTroppercu()-$regle->getTotalttc()-$regle->getMontantavoir()-$regle->getEscompte() > 0)//trop perçu > montant facture
                                    {
                                        $regla->setTroppercu($regla->getTroppercu()-$regle->getTotalttc()-$regle->getMontantavoir()-$regle->getEscompte());
                                        $regle->setMontanttroppercu($regle->getTotalttc()-$regle->getMontantavoir()-$regle->getEscompte());
                                        $regle->setAimputer(0);
//                                        $regle->setRestedu(0);
                                        $imputation = 0;
                                    }
                                    elseif($regla->getTroppercu()-$regle->getTotalttc()-$regle->getMontantavoir()-$regle->getEscompte() == 0)//trop percu = montant facture
                                    {
                                        $regla->setTroppercu(0);
                                        $regle->setMontanttroppercu($regle->getTotalttc()-$regle->getMontantavoir()-$regle->getEscompte());
                                        $regle->setAimputer(0);
//                                        $regle->setRestedu(0);
                                        $imputation = 0;
                                    }
                                    elseif($regla->getTroppercu()-$regle->getTotalttc()-$regle->getMontantavoir()-$regle->getEscompte() < 0)//trop percu < montant facture
                                    {
                                        $regle->setMontanttroppercu($regla->getTroppercu());
                                        $regle->setAimputer($regle->getTotalttc()-$regle->getMontantavoir()-$regle->getEscompte()-$regla->getTroppercu());
//                                        $regle->setRestedu(0);
                                        $imputation = $regle->getTotalttc()-$regle->getMontantavoir()-$regle->getEscompte()-$regla->getTroppercu();//echo 'montantimpute'.$regla->getTroppercu();
                                        $regla->setTroppercu(0);
//                                        $regle->setAimputer($regle->getTotalttc()-$regle->getMontantavoir()-$regle->getMontanttroppercu());
//                                        $regle->setRestedu(0);
//                                        $imputation = $regle->getTotalttc()-$regle->getMontantavoir()-$regle->getMontanttroppercu();
                                    }
                                    $montantimpute += $imputation;
                                }
                                else
                                {
                                    $montantimpute += $regle->getTotalttc()-($regle->getMontantavoir()+$regle->getEscompte()+$regle->getMontanttroppercu());
                                    $regle->setAimputer($regle->getTotalttc()-($regle->getMontantavoir()+$regle->getEscompte()+$regle->getMontanttroppercu()));
                                    $em->persist($regle);
                                }
                            }
                            elseif($regle->getTypedoc() == 'avoir')
                            {//echo $regle->getNumfacture();echo 'aaa'.$regle->getRegler();if($regle->getRegler() === true){echo 'ok';}else{echo 'naaaa';}exit();
                                $em->persist($regle);
                                $em->flush();
                                $avoir = $em->getRepository('BaclooCrmBundle:Reglement')
                                    ->findOneByNumfacture($regle->getNumfacture());//echo $avoir->getNumfacture(); $avoir->getTypedoc(); echo $avoir->getTotalttc();echo 'aaaa'.$avoir->getRegler();exit();
                                if($avoir->getRegler() == 0)
                                {//echo $avoir->getNumfacture();echo 'icic merde'.$regler->getRegler();exit();
                                    $regle->setRegler(1);
                                    $regla->setMontantreg($regla->getMontantreg() + $regle->getTotalttc());
                                }
                            }

                        }
                        else
                        {
                            $regle->setTroppercu(0);
                            $regle->setRestedu(0);
//                            $regle->setRegler(0);
                            $regle->setAimputer(0);
                            $em->persist($regle);
                            $em->flush();
                            $avoir = $em->getRepository('BaclooCrmBundle:Reglement')
                                ->findOneByNumfacture($regle->getNumfacture());
                            if($avoir->getTypedoc() == 'facture' && $avoir->getMontanttroppercu() > 0)
                            {
                                $regla->setTroppercu($regla->getTroppercu()+$avoir->getMontanttroppercu());
                            }
                            if($regle->getTypedoc() == 'avoir' && $avoir->getRegler() == 1)
                            {//echo 'sel'.$regle->getSelection();exit();
                                $regla->setMontantreg($regla->getMontantreg() - $regle->getTotalttc());
                                $avoir->setRegler(0);
                            }
                            elseif($regle->getTypedoc() == 'avoir')
                            {
                                //echo 'trop nul';exit();
                            }
                            $avoir->setMontanttroppercu(0);
                            $em->persist($avoir);
                            $em->persist($client);
                            $em->flush();
                        }
                    }
                    $regla->setMontantimpute($montantimpute);
                    $em->persist($regla);
                    $em->flush();
                    $regla->setSolde($regla->getMontantreg()-$regla->getMontantimpute());
                    $em->persist($regla);
                    $em->flush();
                    $client->setTroppercu($regla->getTroppercu());

                    $em->persist($client);

                    $groupefactures = $em->getRepository('BaclooCrmBundle:Factures')
                        ->findByClientid($client->getId());
                    foreach($groupefactures as $groupe)
                    {
                        $groupe->setTroppercu($regla->getTroppercu());
                        $em->persist($groupe);
                    }
                    $em->flush();
                    return $this->redirect($this->generateUrl('bacloocrm_affecterreglement', array('clientid' => $clientid, 'mode' => $mode, 'style' => $style)));
                }
                elseif($this->getRequest()->request->get('save') == 'Enregistrer')
                {
                    $restaimputer = $form->get('montantreg')->getData();
                    $montantimpute = 0;
                    //on récupère le prochain codegroupe libre
                    $query = $em->createQuery(
                        'SELECT u.codegroupe
                        FROM BaclooCrmBundle:Factures u
                        WHERE u.codegroupe >= :codegroupe
                        AND u.typedoc = :typedoc
                        ORDER BY u.codegroupe DESC'
                    )->setParameter('codegroupe', 0)
                        ->setParameter('typedoc', 'facture')
                        ->setMaxResults(1);
                    $codeg = $query->getOneOrNullResult();
                    if(isset($codeg))
                    {
                        $codeg = $query->getSingleScalarResult();
                    }
                    else
                    {
                        $codeg = 0;
                    }
                    $nextcodegroupe = $codeg + 1;
                    $em->persist($regla);
                    $em->flush();

                    $totalgroupe = 0;
                    foreach($regla->getReglement() as $reglo)
                    {
                        if($reglo->getSelection() == 1)
                        {
                            $montantimpute += $reglo->getTotalttc();
                            $restaimputerprec = $restaimputer;
                            $restaimputer = round($restaimputer, 2) - round($reglo->getAimputer(), 2);
                            //Enregistrement des paiements pour chaque facture
                            $facturereglee = $em->getRepository('BaclooCrmBundle:Factures')
                                ->findOneByNumfacture($reglo->getNumfacture());
                            if($facturereglee->getTypedoc() == 'facture')
                            {
                                $facturereglee->setDatepaiement($regla->getDatepaiment());
                                $totalgroupe += $reglo->getTotalttc();
                                if($regla->getUsetroppercu() == 1 and $regla->getTroppercu() > 0 and $reglo->gettroppercu() == 1)
                                {
                                    if($regla->getTroppercu()-$facturereglee->getTotalttc() > 0)
                                    {
                                        $client->setTroppercu($regla->getTroppercu()-$facturereglee->getTotalttc());

                                        $facturereglee->setTroppercu($regla->getTroppercu()-$facturereglee->getTotalttc());
                                    }
                                    else
                                    {
                                        $client->setTroppercu(0);

                                        $facturereglee->setTroppercu($regla->getTroppercu());
                                    }
                                }
                                if($restaimputer < 0 )
                                {echo 'rest'.$restaimputer;//exit();
                                    $facturereglee->setMontantdejareg($reglo->getAimputer());
                                    $facturereglee->setReglement(0);
                                }
                                else
                                {
                                    $facturereglee->setMontantdejareg($reglo->getAimputer());
                                    $facturereglee->setReglement(1);
                                }
                                $facturereglee->setModepaiement($regla->getModepaiement());
                            }
                            elseif($facturereglee->getTypedoc() == 'avoir')
                            {
                                $totalgroupe = $totalgroupe-$reglo->getTotalttc();
                                $facturereglee->setReglement(1);
                            }
                            $facturereglee->setCodegroupe($nextcodegroupe);
                            $em->persist($facturereglee);
                            $em->flush();
                            if($facturereglee->getReglement() == 0 and $facturereglee->getMontantdejareg() + $facturereglee->getMontantavoir() == $facturereglee->getTotalttc())
                            {
                                $facturereglee->setReglement(1);
                            }
                            $em->persist($facturereglee);
                            $em->flush();
                            $facture = $facturereglee;
                            if(($facture->getModepaiement() == 'cheque' or $facture->getModepaiement() == 'lcr') and ($facture->getEncaisse() == 'pas encaisse' or $facture->getEncaisse() == '' or null === $facture->getEncaisse()))
                            {
                                if($facture->getCodegroupe() > 0)
                                {
                                    $facture->setReglement(0);
                                    $facture->setEncaisse('Pas encaisse');
                                    //On enregistre un paiement par virement
                                    //On débite 511
                                    $banque = new Afacturer;
                                    $banque->setDate($facture->getDatepaiement());
                                    $banque->setJournal('ODR');
                                    $banque->setCompte(511);
                                    $banque->setDebit($facture->getMontantdejareg());
                                    $banque->setCredit(0);
                                    $banque->setLibelle($facture->getClient());
                                    $banque->setPiece($facture->getNumfacture());
                                    $banque->setEcheance($facture->getEcheance());
                                    $banque->setAnalytique('Reglement client');
                                    $banque->setModepaiement($facture->getModepaiement());
                                    $banque->setCodegroupe($facture->getCodegroupe());
                                    $em->persist($banque);
                                    $em->persist($facture);
                                    $em->flush();
                                }
                                else
                                {
                                    $facture->setReglement(0);
                                    //On enregistre un paiement par virement
                                    //On débite 511
                                    $banque = new Afacturer;
                                    $banque->setDate($facture->getDatepaiement());
                                    $banque->setJournal('ODR');
                                    $banque->setCompte(511);
                                    $banque->setDebit($facture->getMontantdejareg());
                                    $banque->setCredit(0);
                                    $banque->setLibelle($facture->getClient());
                                    $banque->setPiece($facture->getNumfacture());
                                    $banque->setEcheance($facture->getEcheance());
                                    $banque->setAnalytique('Reglement client');
                                    $banque->setModepaiement($facture->getModepaiement());
                                    $banque->setCodegroupe($facture->getCodegroupe());
                                    $em->persist($banque);
                                }

//                                $facture->setMontantreg(0);
                                $em->persist($facture);
                                $em->flush();
                            }
                            else {
                                $facture->setReglement(1);
                                if($facture->getModepaiement() == 'Liquidation')
                                {
                                    $today = date('Y-m-d');
                                    $numfacture = $facture->getNumfacture();
                                    $journalori = $em->getRepository('BaclooCrmBundle:Afacturer')
                                        ->findOneBy(array('credit'=>$facture->getTotalttc(), 'piece'=>$facture->getNumfacture()));
                                    if(!isset($journalori))
                                    {
                                        //On enregistre un paiement par virement
                                        //On débite 654
                                        $banque = new Afacturer;
                                        $banque->setDate($today);
                                        $banque->setJournal('VT');
                                        $banque->setCompte(654);
                                        $banque->setDebit($facture->getTotalht());
                                        $banque->setCredit(0);
                                        $banque->setLibelle($facture->getClient());
                                        $banque->setPiece($numfacture);
                                        $banque->setEcheance($facture->getEcheance());
                                        $banque->setAnalytique('Irrecouvrable');
                                        $banque->setModepaiement($facture->getModepaiement());
                                        $banque->setCodegroupe($facture->getCodegroupe());
                                        $em->persist($banque);
                                        $em->flush();

                                        //On débite 4457100
                                        $tva = new Afacturer;
                                        $tva->setDate($today);
                                        $tva->setJournal('VT');
                                        $tva->setCompte(4457100);
                                        $tva->setDebit($facture->getTotalttc() - $facture->getTotalht());
                                        $tva->setCredit(0);
                                        $tva->setLibelle($facture->getClient());
                                        $tva->setPiece($numfacture);
                                        $tva->setEcheance($facture->getEcheance());
                                        $tva->setAnalytique('Irrecouvrable');
                                        $tva->setModepaiement($facture->getModepaiement());
                                        $tva->setCodegroupe($facture->getCodegroupe());
                                        $em->persist($tva);
                                        $em->flush();

//                        $facture->setMontantreg(0);
                                        $em->persist($facture);
                                        $em->flush();
                                    }
                                }
                                else
                                {
                                    $facture->setEncaisse('encaisse');
                                    $em->persist($facture);
                                    //On débite 512
                                    $banque = new Afacturer;
                                    $banque->setDate($facture->getDatepaiement());
                                    $banque->setJournal('ODR');
                                    $banque->setCompte(512);
                                    $banque->setDebit($facture->getMontantdejareg());
                                    $banque->setCredit(0);
                                    $banque->setLibelle($facture->getClient());
                                    $banque->setPiece($facture->getNumfacture());
                                    $banque->setEcheance($facture->getEcheance());
                                    $banque->setAnalytique('Reglement client');
                                    $banque->setModepaiement($facture->getModepaiement());
                                    $banque->setCodegroupe($facture->getCodegroupe());
                                    $em->persist($banque);
                                }
                            }
                        }
                    }

                    $em->persist($client);
                    $em->flush();
                    //maj totalgroupe
                    $facturereglee2 = $em->getRepository('BaclooCrmBundle:Factures')
                        ->findByCodegroupe($nextcodegroupe);
                    foreach($facturereglee2 as $fac)
                    {
                        $fac->setTtcgroupe($totalgroupe);
                        $em->persist($fac);
                    }

                    //maj eventuel trop perçu
                    if($regla->getSolde() >= 0)
                    {
                        $client->setTroppercu($client->getTroppercu()+$regla->getSolde());

                        $em->persist($client);
                    }
                    foreach($regla->getReglement() as $reglo)
                    {
                        $em->remove($reglo);
                    }
                    $compteclient = '411'.$facture->getClientid();
                    //On débit le bon 411
                    $clientok = new Afacturer;
                    $clientok->setDate($facture->getDatepaiement());
                    $clientok->setJournal('VT');
                    $clientok->setCompte($compteclient);
                    $clientok->setDebit(0);
                    $clientok->setCredit($facture->getTtcgroupe());
                    $clientok->setLibelle($facture->getClient());
                    $clientok->setPiece('Multiple factures');
                    $clientok->setEcheance($facture->getEcheance());
                    $clientok->setAnalytique('Reglement client');
                    $clientok->setModepaiement($facture->getModepaiement());
                    $clientok->setCodegroupe($facture->getCodegroupe());
                    $em->persist($clientok);

                    $facture->setMontantreg(0);
                    $em->persist($facture);
                    $em->remove($regla);
                    $em->flush();
                    return $this->redirect($this->generateUrl('bacloocrm_compta', array('vue' => 'locations', 'page' => 1, 'mode' => $mode, 'style' => $style)));
                }
                elseif($this->getRequest()->request->get('Ferme') == 'Fermer')
                {
                    $em->persist($regla);
                    $em->flush();


                    foreach($regla->getReglement() as $reglo)
                    {
                        $em->remove($reglo);
                    }
                    $em->remove($regla);
                    $em->flush();

                    return $this->redirect($this->generateUrl('bacloocrm_compta', array('vue' => 'locations', 'page' => 1, 'mode' => $mode, 'style' => $style)));
                }
            }
        }
        return $this->render('BaclooCrmBundle:Crm:affecterreglement.html.twig', array(
            'form' => $form->createView(),
            'clientid' => $clientid,
            'client' => $entreprise,
            'mode' => $mode,
            'style' => $style
        ));
    }

    public function utilisertroppercuAction($factureid, $vue, $mode, $page, $style)
    {//$id = id ligne partenaire
        $em = $this->getDoctrine()->getManager();
        $facture = $em->getRepository('BaclooCrmBundle:Factures')
            ->findOneByid($factureid);

        $fiche = $em->getRepository('BaclooCrmBundle:Fiche')
            ->findOneByid($facture->getClientid());

//        if($facture->getCodegroupe() > 0)
//        {
//            $troppercu = $facture->getTroppercu();
//            $groupefactures = $em->getRepository('BaclooCrmBundle:Factures')
//                ->findByCodegroupe($facture->getCodegroupe());
//            $ttcgroupe = 0;
//            foreach($groupefactures as $groupe)
//            {
//                $ttcgroupe += $groupe->getTotalttc();
//            }
//            $ttcgroupe = $ttcgroupe-$troppercu;
//
//            if($ttcgroupe < 0)
//            {
//                $troppercu = $ttcgroupe*(-1);
//                $ttcgroupe = 0;
//            }
//            if($ttcgroupe == 0)
//            {
//                $troppercu = 0;
//                $ttcgroupe = 0;
//            }
//            else
//            {
//                $troppercu = 0;
//            }
//
//            $groupefactures = $em->getRepository('BaclooCrmBundle:Factures')
//                ->findByClient($facture->getClient());
//            foreach($groupefactures as $groupe)
//            {
//                $groupe->setTtcgroupe($ttcgroupe);
//                $groupe->setTroppercu($troppercu);
//                $em->persist($groupe);
//            }
//            $fiche->setTroppercu($troppercu);
//            $em->persist($fiche);
//            $em->flush();
//        }
//        else
//        {
        $troppercu = $facture->getTroppercu();
        if($facture->getCodegroupe() > 0)
        {
            $groupefactures = $em->getRepository('BaclooCrmBundle:Factures')
                ->findByCodegroupe($facture->getCodegroupe());
            $ttcgroupe = 0;
            foreach($groupefactures as $groupe)
            {
                $ttcgroupe += $groupe->getTotalttc();
            }
            $ttcgroupe = $ttcgroupe-$troppercu;
        }
        if($facture->getTotalttc() >= $troppercu)
        {
            $avanceapplique = $troppercu;
        }
        else
        {
            $avanceapplique = $facture->getTotalttc();
        }
        $facture->setTroppercuapplique($avanceapplique);
        if($facture->getReglement() == 1)
        {
            $reglementfacture = 0;
        }
        else
        {
            $reglementfacture = $facture->getTotalttc()-$troppercu-$facture->getMontantdejareg();
        }
        if($reglementfacture < 0)
        {
            $troppercu = $reglementfacture*(-1);
            $facture->setMontantdejareg($facture->getTotalttc());
            $facture->setReglement(1);
            $facture->setDatepaiement(date('Y-m-d'));
            $facture->setTroppercu($troppercu);
            $facture->setModepaiement('Trop perçu');
            if($facture->getCodegroupe() > 0)
            {
                $groupefactures = $em->getRepository('BaclooCrmBundle:Factures')
                    ->findByCodegroupe($facture->getCodegroupe());
                foreach($groupefactures as $groupe)
                {
                    $groupe->setTtcgroupe($ttcgroupe);
                    $groupe->setTroppercu($troppercu);
                    $em->persist($groupe);
                }
            }
             $fiche->setTroppercu($troppercu);

            $reglementfacture = 0;
        }
        elseif($reglementfacture == 0)
        {
            $troppercu = 0;
            $facture->setMontantdejareg($facture->getTotalttc());
            $facture->setReglement(1);
            $facture->setDatepaiement(date('Y-m-d'));
            $facture->setTroppercu($troppercu);
            $facture->setModepaiement('Trop perçu');
            if($facture->getCodegroupe() > 0)
            {
                $groupefactures = $em->getRepository('BaclooCrmBundle:Factures')
                    ->findByCodegroupe($facture->getCodegroupe());
                foreach($groupefactures as $groupe)
                {
                    $groupe->setTtcgroupe($ttcgroupe);
                    $groupe->setTroppercu($troppercu);
                    $em->persist($groupe);
                }
            }
            $fiche->setTroppercu($troppercu);

        }
        else
        {
            $facture->setMontantdejareg($troppercu);
            $facture->setReglement(0);
            $facture->setDatepaiement(date('Y-m-d'));
            $troppercu = 0;
            $facture->setTroppercu($troppercu);
            $facture->setModepaiement('Trop perçu');
            if($facture->getCodegroupe() > 0)
            {
                $groupefactures = $em->getRepository('BaclooCrmBundle:Factures')
                    ->findByCodegroupe($facture->getCodegroupe());
                foreach($groupefactures as $groupe)
                {
                    $groupe->setTtcgroupe($ttcgroupe);
                    $groupe->setTroppercu($troppercu);
                    $em->persist($groupe);
                }
            }
            $fiche->setTroppercu($troppercu);

        }

        $groupefactures = $em->getRepository('BaclooCrmBundle:Factures')
            ->findByClient($facture->getClient());
        foreach($groupefactures as $groupe)
        {
            $groupe->setTroppercu($troppercu);
            $em->persist($groupe);
        }
        $em->persist($facture);
        $em->persist($fiche);
        $em->flush();
//        }
        return $this->redirect($this->generateUrl('bacloocrm_compta', array('mode' => $mode, 'page' => $page, 'page' => $page, 'vue' => 'locations', 'style' => $style)));
    }

    public function hafsaAction()
    {
        $appPath1 = $this->container->getParameter('kernel.root_dir');
        $hafsa = 'homepages/39/d785691378/htdocs/bacloo/web/b/demolocs/web/img/hafsa.jpg ';
        return $this->render('BaclooCrmBundle:Crm:hafsa.html.twig', array('hafsa' => $hafsa));
    }

    public function relancerepriseAction($codelocata, $codelocation, $mode, Request $request)
    {
        $em = $this->getDoctrine()->getManager();
        if($mode == 'parc')
        {
            $location = $em->getRepository('BaclooCrmBundle:Locations')
                ->findOneById($codelocation);
        }
        elseif($mode == 'sl')
        {
            $location = $em->getRepository('BaclooCrmBundle:Locationssl')
                ->findOneById($codelocation);
        }

        $locata = $em->getRepository('BaclooCrmBundle:Locata')
            ->findOneById($codelocata);
        if(null !== $locata->getDestinatairedevis())
        {
            $destinataire = $locata->getDestinatairedevis();
        }
        else
        {
            $destinataire = 'non';
        }
        $fiche = $em->getRepository('BaclooCrmBundle:Fiche')
            ->findOneById($location->getCodeclient());
        $defaultData = array();
        $form = $this->createFormBuilder($defaultData)
            ->add('email', 'textarea', array('required' => true))
            ->getForm();
        $form->handleRequest($request);
        // On vérifie qu'elle est de type POST
        if ($request->getMethod() == 'POST')
        {
            // On vérifie que les valeurs entrées sont correctes
            if($form->isValid()) {
                $data = $form->getData();
                $email = $data['email'];
                if($destinataire == 'non')
                {
                    $locata->setDestinatairedevis($email);
                    $em->persist($locata);
                }

                $mailer = $this->get('mailer');
                $message = \Swift_Message::newInstance()
                    ->setSubject('FGG Locations : Fin de location '.$location->getTypemachine().'')
                    ->setFrom(array('info@fgglocation.fr' => 'FGG Location'))
                    ->setTo($email)
                    ->setReplyTo('info@fgglocation.fr')
                    // ->setTo('ringuetjm@gmail.com')
                    ->setBody($this->renderView('BaclooCrmBundle:Crm:reprise_email.html.twig', array(
                        'locata' => $locata,
                        'location' => $location
                    )))
                    ->setContentType("text/html");
                $mailer->send($message);
                if ($mailer->send($message))
                {
                    $location->setDaterelancereprise(new \DateTime('now'));
                    $em->persist($location);
                    $em->flush();
                }
                else
                {
                    echo "Failed\n";
                }

                //Envoi copie du message
                $message = \Swift_Message::newInstance()
                    ->setSubject('FGG Location : Relance fin de location '.$locata->getClient().' envoyée à '.$email)
                    ->setFrom(array('info@fgglocation.fr' => 'FGG Location'))
                    ->setTo('info@fgglocation.fr')
                    // ->setTo('ringuetjm@gmail.com')
                    ->setBody($this->renderView('BaclooCrmBundle:Crm:reprise_email.html.twig', array(
                        'locata' => $locata,
                        'location' => $location
                    )))
                    ->setContentType("text/html");
                $mailer->send($message);
                return $this->redirect($this->generateUrl('bacloocrm_retours'));
            }

        }
        return $this->render('BaclooCrmBundle:Crm:relancereprise.html.twig', array(
            'form' => $form->createView(),
            'codelocata' => $codelocata,
            'codelocation' => $codelocation,
            'mode' => $mode,
            'date' => $location->getDaterelancereprise(),
            'email' => $destinataire
        ));
    }

    public function avoirachatnormalAction($vendaid, $message, $numavoir, $numfacture, Request $request)
    {//echo $numavoir;
        $usersess = $this->get('security.context')->getToken()->getUsername();
        $today = date('Y-m-d');
        $em = $this->getDoctrine()->getManager();
        // echo 'numfacture'.$numfacture;
        if($numfacture == 0)
        {
            $facturedorigine = $em->getRepository('BaclooCrmBundle:Factures')
                ->findOneByLocatacloneid($vendaid);
            $numfacture = $facturedorigine->getNumfacture();
        }
        $numfacturedor = $numfacture;

        //On recupère les infos de la vente
        $venda = $em->getRepository('BaclooCrmBundle:Locatafrs')
            ->findOneById($vendaid);
        $client = $em->getRepository('BaclooCrmBundle:Fiche')
            ->findOneById($venda->getFournisseurid());
        $ficheid = $venda->getFournisseurid();

        //On dessine notre formulaire indépendant
        $defaultData = array();
        $form = $this->createFormBuilder($defaultData)
            ->add('avoirtotal', 'checkbox', array('required' => false))
            ->add('montantavoirpartiel', 'number', array('required' => false))
            ->add('commentaire', 'textarea', array('required' => true))
            ->add('location', 'number', array('required' => false))
            ->add('transport', 'number', array('required' => false))
            ->add('assurance', 'number', array('required' => false))
            ->add('contributionverte', 'number', array('required' => false))
            ->add('piece', 'number', array('required' => false))
            ->add('materiel', 'number', array('required' => false))
            ->add('prestation', 'number', array('required' => false))
            ->add('autre', 'number', array('required' => false))
            ->getForm();

        $form->handleRequest($request);
        if($form->isValid()) {
            $data = $form->getData();
            $avoirtotal = $data['avoirtotal'];
            $montantavoirpartiel = $data['montantavoirpartiel'];
            $commentaire = $data['commentaire'];
            $locationttc = $data['location'];
            $transportttc = $data['transport'];
            $assurancettc = $data['assurance'];
            $contributionvertettc = $data['contributionverte'];
            $piecettc = $data['piece'];
            $materielttc = $data['materiel'];
            $prestationttc = $data['prestation'];
            $autrettc = $data['autre'];
            $client = $em->getRepository('BaclooCrmBundle:Fiche')
                ->findOneById($venda->getFournisseurid());

            //On calcul les montant dont on aura besoin
            if(isset($avoirtotal) && $avoirtotal == 1)
            {
                //Si avoir Total
                $totalht = $venda->getMontantloc();
                if($client->getTypeclient() == 'france')
                {
                    //Faire une boucle pour recup montantht chaque compte 7

                    foreach($venda->getLocationsfrs() as $vente)
                    {
                        if($vente->getReference() == 'location')
                        {                    $locationht = 0;
                            $transportht = 0;
                            $assuranceht = 0;
                            $contributionverteht = 0;
                            $pieceht = 0;
                            $materielht = 0;
                            $prestationht = 0;
                            $autreht = 0;
                            $locationht += $vente->getMontantvente();
                        }
                        if($vente->getReference() == 'transport')
                        {
                            $transportht += $vente->getMontantvente();
                        }
                        if($vente->getReference() == 'assurance')
                        {
                            $assuranceht += $vente->getMontantvente();
                        }
                        if($vente->getReference() == 'contributionverte')
                        {
                            $contributionverteht += $vente->getMontantvente();
                        }
                        if($vente->getReference() == 'piece')
                        {
                            $pieceht += $vente->getMontantvente();
                        }
                        if($vente->getReference() == 'materiel')
                        {
                            $materielht += $vente->getMontantvente();
                        }
                        if($vente->getReference() == 'prestation')
                        {
                            $prestationht += $vente->getMontantvente();
                        }
                        if($vente->getReference() == 'autre')
                        {
                            $autreht += $vente->getMontantvente();
                        }
                        $tva = $totalht * 0.20;
                        $totalttc = $totalht + $tva;
                    }
                }
                else
                {
                    $tva = 0;
                    $totalttc = $venda->getMontantloc();
                    $totalht = $venda->getMontantloc();
                }
            }
            else
            {
                //Si avoir partiel
                $totalttc = $locationttc + $transportttc + $assurancettc + $contributionvertettc + $piecettc + $materielttc + $prestationttc + $autrettc;
                if($client->getTypeclient() == 'france')
                {
//                    $totalttc = $totalht*1.2;
//                    $tva = $totalttc - $totalht;
//                    $locationttc = $locationht*1.2;
//                    $transportttc = $entretienht*1.2;
//                    $assurancettc = $transportht*1.2;
//                    $contributionvertettc = $assuranceht*1.2;
//                    $pecettc = $paaht*1.2;
//                    $materielttc = $paaht*1.2;
//                    $prestationttc = $paaht*1.2;
//                    $autrettc = $paaht*1.2;
                }
                else
                {
                    $tva = 0;
                    $locationht = $locationttc/1.2;
                    $transportht = $transportttc/1.2;
                    $assuranceht = $assurancettc/1.2;
                    $contributionverteht = $contributionvertettc/1.2;
                    $pieceht = $piecettc/1.2;
                    $materielht = $materielttc/1.2;
                    $prestationht = $prestationttc/1.2;
                    $autreht = $autrettc/1.2;
                    $totalttc = $venda->getMontantloc();
                    $totalht = $venda->getMontantloc();
                }
            }

            //avant de passer les écritures on vérifie qu'elles n'existent pas deja dans le journalori
            $compteclient = '401';
            $journalori = $em->getRepository('BaclooCrmBundle:Afacturer')
                ->findOneBy(array('credit'=>$totalttc, 'piece'=> $numavoir));

            //Si opréation déjà passée alerter l'utilisateur et bloquer sinon passer
            if(!empty($journalori))
            {
                $message = 1; //Vous avez déjà passé cette écriture le ...
                return $this->redirect($this->generateUrl('bacloocrm_avoirventes', array('vendaid' => $venda->getId(), 'message' => $message)));
            }
            else
            {
                $locationht1 = 0;
                $transportht1 = 0;
                $assuranceht1 = 0;
                $contributionverteht1 = 0;
                $pieceht1 = 0;
                $materielht1 = 0;
                $prestationht1 = 0;
                $autreht1 = 0;
                //On récupère les montants ht de chaque compte 7
                foreach($venda->getLocationsfrs() as $vente)
                {
                    if($vente->getMontantht() > 0)
                    {
                        $montantht = $vente->getMontantht();
                    }
                    else
                    {
                        $montantht = $vente->getMontantttc()/1.2;
                    }

                    if($vente->getReference() == 'location')
                    {
                        $locationht1 += $montantht;
                    }
                    if($vente->getReference() == 'transport')
                    {
                        $transportht1 += $montantht;
                    }
                    if($vente->getReference() == 'assurance')
                    {
                        $assuranceht1 += $montantht;
                    }
                    if($vente->getReference() == 'contributionverte')
                    {
                        $contributionverteht1 += $montantht;
                    }
                    if($vente->getReference() == 'piece')
                    {
                        $pieceht1 += $montantht;
                    }
                    if($vente->getReference() == 'materiel')
                    {
                        $materielht1 += $montantht;
                    }
                    if($vente->getReference() == 'prestation')
                    {
                        $prestationht1 += $montantht;
                    }
                    if($vente->getReference() == 'autre')
                    {
                        $autreht1 += $montantht;
                    }
                    $tva = $totalht * 0.20;
                    $totalttc = $totalht + $tva;
                }
                //On passe les écritures

                //On crédite le compte 700 utilisé
                //On crédite le compte vente 707
                if(isset($locationht) && $locationht > 0 && isset($locationht1))
                {
                    if($locationht <= ($totalht))
                    {
                        $locations = new Afacturer;
                        $locations->setDate($today);
                        $locations->setJournal('ACH');
                        if($client->getTypeclient() == 'france')
                        {
                            $locations->setCompte(6135);
                        }
                        elseif($client->getTypeclient() == 'ue')
                        {
                            $locations->setCompte(6135);
                        }
                        elseif($client->getTypeclient() == 'export' or $venda->getSanstva() == 1)
                        {
                            $locations->setCompte(6135);
                        }else{$locations->setCompte(6135);}
                        $locations->setDebit(0);
                        $locations->setCredit($locationht);
                        $locations->setLibelle($venda->getClient());
                        $locations->setPiece($numavoir);
                        $locations->setEcheance(date('Y-m-d'));
                        $locations->setAnalytique('location');
                        $em->persist($locations);
                    }
                    else
                    {
                        return $this->redirect($this->generateUrl('bacloocrm_avoirlocations', array('vendaid' => $venda->getId(), 'message' => 3)));//Le montant saisi ne doit pas être supérieur au montant ci-dessus.(montant d'origine)
                    }
                }

                //On crédite le compte transport 6241
                if(isset($transportht) && $transportht > 0 && isset($transportht1))
                {
                    if($transportht <= ($totalht))
                    {
                        $transport = new Afacturer;
                        $transport->setDate($today);
                        $transport->setJournal('ACH');
                        if($client->getTypeclient() == 'france')
                        {
                            $transport->setCompte(6241);
                        }
                        elseif($client->getTypeclient() == 'ue')
                        {
                            $transport->setCompte(6241);
                        }
                        elseif($client->getTypeclient() == 'export')
                        {
                            $transport->setCompte(6241);
                        }else{$transport->setCompte(6241);}
                        $transport->setDebit(0);
                        $transport->setCredit($transportht);
                        $transport->setLibelle($venda->getClient());
                        $transport->setPiece($numavoir);
                        $transport->setEcheance(date('Y-m-d'));
                        $transport->setAnalytique('transport');
                        $em->persist($transport);
                    }
                    else
                    {
                        return $this->redirect($this->generateUrl('bacloocrm_avoirventes', array('vendaid' => $venda->getId(), 'message' => 3)));//Le montant saisi ne doit pas être supérieur au montant ci-dessus.(montant d'origine)
                    }
                }

                //On crédite le compte assurance si assurance facturé
                if(isset($assuranceht) && $assuranceht  > 0 && isset($assuranceht1) && $assuranceht <= ($totalht))
                {
                    $fassurance= new Afacturer;
                    $fassurance->setDate($today);
                    $fassurance->setJournal('ACH');
                    if($client->getTypeclient() == 'france')
                    {
                        $fassurance->setCompte(604);
                        $fassurance->setLibelle('Assurance France');
                    }
                    elseif($client->getTypeclient() == 'ue')
                    {
                        $fassurance->setCompte(604);
                        $fassurance->setLibelle('Assurance UE');
                    }
                    elseif($client->getTypeclient() == 'export')
                    {
                        $fassurance->setCompte(604);
                        $fassurance->setLibelle('Assurance Export');
                    }
                    $fassurance->setDebit(0);
                    $fassurance->setCredit($assuranceht);
                    $fassurance->setPiece($numavoir);
                    $fassurance->setEcheance(date('Y-m-d', strtotime("+45 days")));
                    $fassurance->setAnalytique('Assurance');
                    $em->persist($fassurance);
                    $em->flush();
                }

                //on crédite le compte entretien 611
                if(isset($contributionverteht) && $contributionverteht > 0 && isset($contributionverteht1))
                {
                    if($contributionverteht <= ($totalht))
                    {
                        $contributionverte = new Afacturer;
                        $contributionverte->setDate($today);
                        $contributionverte->setJournal('ACH');
                        if($client->getTypeclient() == 'france')
                        {
                            $contributionverte->setCompte(611);
                        }
                        elseif($client->getTypeclient() == 'ue')
                        {
                            $contributionverte->setCompte(611);
                        }
                        elseif($client->getTypeclient() == 'export')
                        {
                            $contributionverte->setCompte(611);
                        }else{$contributionverte->setCompte(611);}
                        $contributionverte->setDebit(0);
                        $contributionverte->setCredit($contributionverteht);
                        $contributionverte->setLibelle($venda->getClient());
                        $contributionverte->setPiece($numavoir);
                        $contributionverte->setEcheance(date('Y-m-d'));
                        $contributionverte->setAnalytique('contributionverte');
                        $em->persist($contributionverte);
                    }
                    else
                    {
                        return $this->redirect($this->generateUrl('bacloocrm_avoirventes', array('vendaid' => $venda->getId(), 'message' => 3)));//Le montant saisi ne doit pas être supérieur au montant ci-dessus.(montant d'origine)
                    }
                }

                //on crédite le compte entretien 607
                if(isset($pieceht) && $pieceht > 0 && isset($pieceht1))
                {
                    if($pieceht <= ($totalht))
                    {
                        $piece = new Afacturer;
                        $piece->setDate($today);
                        $piece->setJournal('ACH');
                        if($client->getTypeclient() == 'france')
                        {
                            $piece->setCompte(607);
                        }
                        elseif($client->getTypeclient() == 'ue')
                        {
                            $piece->setCompte(607);
                        }
                        elseif($client->getTypeclient() == 'export')
                        {
                            $piece->setCompte(607);
                        }else{$piece->setCompte(607);}
                        $piece->setDebit(0);
                        $piece->setCredit($pieceht);
                        $piece->setLibelle($venda->getClient());
                        $piece->setPiece($numavoir);
                        $piece->setEcheance(date('Y-m-d'));
                        $piece->setAnalytique('piece');
                        $em->persist($piece);
                    }
                    else
                    {
                        return $this->redirect($this->generateUrl('bacloocrm_avoirventes', array('vendaid' => $venda->getId(), 'message' => 3)));//Le montant saisi ne doit pas être supérieur au montant ci-dessus.(montant d'origine)
                    }
                }

                //on crédite le compte entretien 607
                if(isset($materielht) && $materielht > 0 && isset($materielht1))
                {
                    if($materielht <= ($totalht))
                    {
                        $materiel = new Afacturer;
                        $materiel->setDate($today);
                        $materiel->setJournal('ACH');
                        if($client->getTypeclient() == 'france')
                        {
                            $materiel->setCompte(607);
                        }
                        elseif($client->getTypeclient() == 'ue')
                        {
                            $materiel->setCompte(607);
                        }
                        elseif($client->getTypeclient() == 'export')
                        {
                            $materiel->setCompte(607);
                        }else{$materiel->setCompte(607);}
                        $materiel->setDebit(0);
                        $materiel->setCredit($materielht);
                        $materiel->setLibelle($venda->getClient());
                        $materiel->setmateriel($numavoir);
                        $materiel->setEcheance(date('Y-m-d'));
                        $materiel->setAnalytique('materiel');
                        $em->persist($materiel);
                    }
                    else
                    {
                        return $this->redirect($this->generateUrl('bacloocrm_avoirventes', array('vendaid' => $venda->getId(), 'message' => 3)));//Le montant saisi ne doit pas être supérieur au montant ci-dessus.(montant d'origine)
                    }
                }

                //on crédite le compte entretien 604
                if(isset($prestationht) && $prestationht > 0 && isset($prestationht1))
                {
                    if($prestationht <= ($totalht))
                    {
                        $prestation = new Afacturer;
                        $prestation->setDate($today);
                        $prestation->setJournal('ACH');
                        if($client->getTypeclient() == 'france')
                        {
                            $prestation->setCompte(604);
                        }
                        elseif($client->getTypeclient() == 'ue')
                        {
                            $prestation->setCompte(604);
                        }
                        elseif($client->getTypeclient() == 'export')
                        {
                            $prestation->setCompte(604);
                        }else{$prestation->setCompte(604);}
                        $prestation->setDebit(0);
                        $prestation->setCredit($prestationht);
                        $prestation->setLibelle($venda->getClient());
                        $prestation->setprestation($numavoir);
                        $prestation->setEcheance(date('Y-m-d'));
                        $prestation->setAnalytique('prestation');
                        $em->persist($prestation);
                    }
                    else
                    {
                        return $this->redirect($this->generateUrl('bacloocrm_avoirventes', array('vendaid' => $venda->getId(), 'message' => 3)));//Le montant saisi ne doit pas être supérieur au montant ci-dessus.(montant d'origine)
                    }
                }

                //on crédite le compte entretien 607
                if(isset($autreht) && $autreht > 0 && isset($autreht1))
                {
                    if($autreht <= ($totalht))
                    {
                        $autre = new Afacturer;
                        $autre->setDate($today);
                        $autre->setJournal('ACH');
                        if($client->getTypeclient() == 'france')
                        {
                            $autre->setCompte(607);
                        }
                        elseif($client->getTypeclient() == 'ue')
                        {
                            $autre->setCompte(607);
                        }
                        elseif($client->getTypeclient() == 'export')
                        {
                            $autre->setCompte(607);
                        }else{$autre->setCompte(607);}
                        $autre->setDebit(0);
                        $autre->setCredit($autreht);
                        $autre->setLibelle($venda->getFournisseur());
                        $autre->setPiece($numavoir);
                        $autre->setEcheance(date('Y-m-d'));
                        $autre->setAnalytique('autre');
                        $em->persist($autre);
                    }
                    else
                    {
                        return $this->redirect($this->generateUrl('bacloocrm_avoirventes', array('vendaid' => $venda->getId(), 'message' => 3)));//Le montant saisi ne doit pas être supérieur au montant ci-dessus.(montant d'origine)
                    }
                }

                //On crédite le compte TVA si client france
                if($client->getTypeclient() == 'france')
                {
                    $ftva = new Afacturer;
                    $ftva->setDate($today);
                    $ftva->setJournal('ACH');
                    $ftva->setCompte(44566);
                    $ftva->setDebit(0);
                    $ftva->setCredit($tva);
                    $ftva->setLibelle('TVA collectée');
                    $ftva->setPiece($numavoir);
                    $ftva->setEcheance(date('Y-m-d'));
                    $ftva->setAnalytique('Tva');
                    $em->persist($ftva);
                    $em->flush();
                }

                //On debite 401
                $afacturer = new Afacturer;
                $afacturer->setDate($today);
                $afacturer->setJournal('ACH');
                $afacturer->setCompte($compteclient);
                $afacturer->setCredit(0);
                if($client->getTypeclient() != 'france')
                {
                    $afacturer->setDebit($totalht);
                }
                else
                {
                    $afacturer->setDebit($totalttc);
                }
                $afacturer->setLibelle($venda->getFournisseur());
                $afacturer->setPiece($numavoir);
                $afacturer->setEcheance(date('Y-m-d', strtotime("+45 days")));
                $afacturer->setAnalytique('Fournisseur');
                $em->persist($afacturer);

                //Ajout à la table factures
// echo 'uuuuuuuuuuuu';
                if($numavoir == 0)
                {	//echo 'ici';
                    $facture = new Factures;

                    $query = $em->createQuery(
                        'SELECT b.compteurfac
					FROM BaclooCrmBundle:Factures b
					WHERE b.typedoc != :typedoc1
					AND b.typedoc != :typedoc2
					ORDER BY b.id DESC'
                    )->setMaxResults(1);
                    $query->setParameter('typedoc1', 'facture frs');
                    $query->setParameter('typedoc2', 'avoir frs');
                    $lastnumfact = $query->getOneOrNullResult();
                    if(empty($lastnumfact) or !isset($lastnumfact) or $lastnumfact == null)
                    {
                        $lastnumfact = 0;//echo 'vide';
                    }
                    else
                    {
                        $lastnumfact = $query->getSingleScalarResult();//echo 'pas vide';
                    }
                    $numfacture = date('Y').($lastnumfact++);
                }
                else
                {
                    $facture = $em->getRepository('BaclooCrmBundle:Factures')
                        ->findOneByNumfacture($numavoir);
                    $numfacture = $numavoir;
                    $lastnumfact = $facture->getCompteurfac();
                }


                $afacturer->setPiece($numfacture);
                if($client->getTypeclient() == 'france')
                {
                    $ftva->setPiece($numfacture);
                }
                if(isset($assuranceht) && $assuranceht  > 0 && isset($assuranceht1) && $assuranceht <= ($totalht))
                {
                    $fassurance->setPiece($numfacture);
                }
                if(isset($transportht) && $transportht > 0 && isset($transportht1))
                {
                    if($transportht <= ($totalht))
                    {
                        $transport->setPiece($numfacture);
                    }
                }
                if(isset($contributionverteht) && $contributionverteht > 0 && isset($contributionverteht1))
                {
                    if($contributionverteht <= ($totalht))
                    {
                        $contributionverte->setPiece($numfacture);
                    }
                }
                if(isset($materielht) && $materielht > 0 && isset($materielht1))
                {
                    if($materielht <= ($totalht))
                    {
                        $materiel->setPiece($numfacture);
                    }
                }
                if(isset($prestationht) && $prestationht > 0 && isset($prestationht1))
                {
                    if($prestationht <= ($totalht))
                    {
                        $prestation->setPiece($numfacture);
                    }
                }
                if(isset($autreht) && $autreht > 0 && isset($autreht1))
                {
                    if($autreht <= ($totalht))
                    {
                        $autre->setPiece($numfacture);
                    }
                }

                $client = $em->getRepository('BaclooCrmBundle:Fiche')
                    ->findOneById($venda->getFournisseurid());
                if($client->getDelaireglement() == 1)
                {
                    $next45 = $venda->getDate();
                }
                elseif($client->getDelaireglement() == 2)
                {
                    $next45 = date('Y-m-d', strtotime($venda->getDate() . '+45 days'));
                }
                elseif($client->getDelaireglement() == 3)
                {
                    $date = date('Y-m-t', strtotime($venda->getDate()));
                    $next45 = date('Y-m-d', strtotime($date . '+30 days'));
                }
                else
                {
                    $next45 = date('Y-m-d');
                }

                $facture->setNumfacture($numfacture);
                $facture->setCodelocata('H-'.$venda->getId());
                $facture->setClientid($venda->getFournisseurid());
                $facture->setClient($venda->getFournisseur());
                $facture->setTotalht($totalht);
                $facture->setTotalttc($totalttc);
                $facture->setEcheance($next45);
                $facture->setChantier($venda->getFournisseur());
                $facture->setReglement(1);
                $facture->setEncompta(1);
                $facture->setCommentaire($commentaire);
                $facture->setDatepaiement(date('Y-m-d'));
                $facture->setModepaiement('');
                $facture->setTypedoc('avoir frs');
                $facture->setDatecrea($today);
                $facture->setCompteurfac($lastnumfact);
                $facture->setUser($venda->getUser());
                $facture->setLocatacloneid($venda->getId());

                if($numavoir == 0)
                {
                    // $facture->addFactum($facta);
                    // $facta->addFacture($facture);
                }

                if($avoirtotal == 1)
                {
                    $facturedor = $em->getRepository('BaclooCrmBundle:Factures')
                        ->findOneByNumfacture($numfacturedor);
                    $facturedor->setReglement(1);
                    $facturedor->setMontantavoir($facturedor->getMontantavoir() + $totalttc);
                    $facturedor->setCommentaire('Facture annulée par l\'avoir n°'.$numavoir);
                    $em->persist($facturedor);
                    $em->flush();
                }
                else
                {echo 'numfacturedor'.$numfacturedor;
                    $facturedor = $em->getRepository('BaclooCrmBundle:Factures')
                        ->findOneByNumfacture($numfacturedor);
                    $facturedor->setMontantavoir($facturedor->getMontantavoir() + $totalttc);
                    $facturedor->setCommentaire('Avoir n°'.$numavoir.' réalisé pour un montant de ttc de '.$totalttc.' €');
                    $em->persist($facturedor);
                    $em->flush();
                }
                $em->persist($facture);
                $em->flush();
                //Fin ajout table factures
            }
            return $this->redirect($this->generateUrl('bacloocrm_avoirachatnormal', array('vendaid' => $vendaid, 'message' => 2, 'numavoir' => $numavoir, 'numfacture' => $numfacture)));//Avoir enregistré
        }

        if($numavoir == 0)
        {
            $avoirtotal = 0;
            $montantavoirpartiel = 0;
            $commentaire = 0;
        }
        else
        {
            //echo 'numavoir'.$numavoir;
            $avoir = $em->getRepository('BaclooCrmBundle:Factures')
                ->findOneByNumfacture($numavoir);
            // echo $avoir->getTotalht();
            $facturedor = $em->getRepository('BaclooCrmBundle:Factures')
                ->findOneBy(array('locatacloneid' => $avoir->getLocatacloneid(), 'typedoc' => 'facture frs'));
            if($avoir->getTotalht() == $facturedor->getTotalht())
            {
                $avoirtotal = 1;
                $montantavoirpartiel = $avoir->getTotalht();
                $commentaire = $avoir->getCommentaire();
            }
            else
            {
                $avoirtotal = 0;
                $montantavoirpartiel = $avoir->getTotalht();
                $commentaire = $avoir->getCommentaire();
            }
// echo $commentaire;
// echo $avoirtotal;
        }
        $previous = $this->get('request')->server->get('HTTP_REFERER');//echo $mode;
        return $this->render('BaclooCrmBundle:Crm:avoirachatnormal.html.twig', array('form' => $form->createView(),
            'venda' => $venda,
            'message' => $message,
            'previous' => $previous,
            'avoirtotal' => $avoirtotal,
            'montantavoirpartiel' => $montantavoirpartiel,
            'commentaire' => $commentaire,
            'numavoir' => $numavoir,
            'numfacture' => $numfacture,
            'ficheid' => $ficheid,
            'message' => $message
        ));
    }

    public function removemachineparcAction($id, $check)
    {//$id = id ligne partenaire
        $em = $this->getDoctrine()->getManager();
        $previous = $this->get('request')->server->get('HTTP_REFERER');

        if($check == '0')
        {
            return $this->render('BaclooCrmBundle:Crm:removemachineparc.html.twig', array('id' => $id,
                'previous' => $previous,
                'check' => 1));
        }
        elseif($check == 'ok')
        {
            $machine  = $em->getRepository('BaclooCrmBundle:Machines')
                ->findOneByid($id);
            $em->remove($machine);
            $em->flush();
			return $this->redirect($this->generateUrl('bacloocrm_tcard', array('mode' => 'all', 'entite' => 'Locamia')));
        }
    }

    public function liberermachineparcAction($id, $check)
    {
        $em = $this->getDoctrine()->getManager();
        $previous = $this->get('request')->server->get('HTTP_REFERER');

        if($check == '0')
        {
            return $this->render('BaclooCrmBundle:Crm:liberermachineparc.html.twig', array('id' => $id,
                'previous' => $previous,
                'check' => 1));
        }
        elseif($check == 'ok')
        {
            $machine  = $em->getRepository('BaclooCrmBundle:Machines')
                ->findOneByid($id);
            if($machine->getOriginal() == 1)
            {
                $machine->setEtat('Disponible');
                $machine->setDebutloc('');
                $machine->setFinloc('');
                $machine->setEntreprise('');
                $machine->setNomchantier('');
                $machine->setcodelocations('');
                $machine->setcodecontrat('');
                $machine->setClientid(0);
                $em->persist($machine);
            }
            else
            {
                $em->remove($machine);
            }
            $em->flush();
            return $this->redirect($this->generateUrl('bacloocrm_planning', array('mode' => 'machines')));
        }
    }

    public function copiefactureAction($factureid, $mode, Request $request)
    {
        $usersess = $this->get('security.context')->getToken()->getUsername();
        $em = $this->getDoctrine()->getManager();

        $defaultData = array();
        $form = $this->createFormBuilder($defaultData)
            ->add('entreprise', 'text', array('required' => false))
            ->add('entrepriseid', 'text', array('required' => false))
            ->getForm();
        $form->handleRequest($request);

        if($form->isValid()) {
            $data = $form->getData();
            $entreprise = $data['entreprise'];
            $entrepriseid = $data['entrepriseid'];

            $facture = $em->getRepository('BaclooCrmBundle:Factures')
                ->findOneByid($factureid);
            $facture->setClientid($entrepriseid);
            $facture->setClient($entreprise);
            $em->persist($facture);
            $em->flush();

            if($facture->getCodelocata() == 'V-'.$facture->getLocatacloneid())
            {
                //C'est une vente
                $venda = $em->getRepository('BaclooCrmBundle:Venda')
                    ->findOneByid($facture->getLocatacloneid());
                $venda->setClientid($entrepriseid);
                $venda->setClient($entreprise);
                $em->persist($venda);
                $em->flush();
            }
            else
            {
                //C'est une lcoation
                $locataclone = $em->getRepository('BaclooCrmBundle:Locataclone')
                    ->findOneByid($facture->getLocatacloneid());
                $locataclone->setClientid($entrepriseid);
                $locataclone->setClient($entreprise);
                $em->persist($locataclone);
                $em->flush();

                foreach ($locataclone->getLocationsclone() as $loco)
                {
                    $loco->setEntreprise($entreprise);
                    $loco->setCodeclient($entrepriseid);
                    $em->persist($loco);
                    $em->flush();
                }
                foreach ($locataclone->getLocationsslclone() as $loca)
                {
                    $loca->setEntreprise($entreprise);
                    $loca->setCodeclient($entrepriseid);
                    $em->persist($loca);
                    $em->flush();
                }
                if($mode != 'quefac')
                {
                    $locata = $em->getRepository('BaclooCrmBundle:Locata')
                        ->findOneByid($facture->getCodelocata());
                    $locata->setClientid($entrepriseid);
                    $locata->setClient($entreprise);
                    $em->persist($locata);
                    $em->flush();

                    foreach ($locata->getLocations() as $loco)
                    {
                        $loco->setEntreprise($entreprise);
                        $loco->setCodeclient($entrepriseid);
                        $em->persist($loco);
                        $em->flush();
                    }
                    foreach ($locata->getLocationssl() as $loca)
                    {
                        $loca->setEntreprise($entreprise);
                        $loca->setCodeclient($entrepriseid);
                        $em->persist($loca);
                        $em->flush();
                    }
                }
            }
            return $this->redirect($this->generateUrl('bacloocrm_compta'));
        }
        $previous = $this->get('request')->server->get('HTTP_REFERER');
        return $this->render('BaclooCrmBundle:Crm:copiefacture.html.twig', array('form' => $form->createView(),
            'previous' => $previous,
            'mode' => $mode,
            'factureid' => $factureid
        ));
    }

	public function requeteentrepriseAction(Request $request)
	{
		// $request = $request->get('request');
		// if($request == 1){
			$search = $request->get('search');
			// $search = 'altitop';
			if(!empty($search))
			{
				$em = $this->getDoctrine()->getManager();
				$query = $em->createQuery(
					'SELECT f
					FROM BaclooCrmBundle:Fiche f
					WHERE f.raisonSociale LIKE :raison
					AND (f.typefiche = :client or f.typefiche = :client2)
					Group By f.raisonSociale'
				);
				$query->setParameter('raison', '%'.$search.'%');
				$query->setParameter('client', 'client');
				$query->setParameter('client2', 'prospect');
				$result = $query->getArrayResult();

				// Transformer le tableau associatif en un tableau standard
				$array = array();
				foreach ($result as $data) {
					$array[] = array("label"=>$data['raisonSociale'], "value"=>$data['id']);
				}
			}
		$response = new Response(json_encode($array));
		return $response;
		// }
	}

    Public function removemachinelogAction($id, $mode, $chauffeur)
    {
        $em = $this->getDoctrine()->getManager();
        $machine  = $em->getRepository('BaclooCrmBundle:Logistique')
            ->findOneById($id);

        if(isset($machine))
        {
            $em->remove($machine);
            $em->flush();
        }
        return $this->redirect($this->generateUrl('bacloocrm_dispatchtransport', array('chauffeur' => $chauffeur)));
    }

    public function requetemarqueAction(Request $request)
    {
        $search = $request->get('search');
        if (!empty($search)) {
            $em = $this->getDoctrine()->getManager();
            $query = $em->createQuery(
                'SELECT f
					FROM BaclooCrmBundle:Machines f
					WHERE f.marque LIKE :marque
					Group By f.marque'
            );
            $query->setParameter('marque', '%' . $search . '%');
            $result = $query->getArrayResult();

            // Transformer le tableau associatif en un tableau standard
            $array = array();
            foreach ($result as $data) {
                $array[] = array("label" => $data['marque']);
            }
        }
        $response = new Response(json_encode($array));
        return $response;
    }

    public function requetetypeAction(Request $request)
    {
        $search = $request->get('search');
        if (!empty($search)) {
            $em = $this->getDoctrine()->getManager();
            $query = $em->createQuery(
                'SELECT f
					FROM BaclooCrmBundle:Machines f
					WHERE f.type LIKE :type
					Group By f.type'
            );
            $query->setParameter('type', '%' . $search . '%');
            $result = $query->getArrayResult();

            // Transformer le tableau associatif en un tableau standard
            $array = array();
            foreach ($result as $data) {
                $array[] = array("label" => $data['type']);
            }
        }
        $response = new Response(json_encode($array));
        return $response;
    }

    public function requetenumserieAction(Request $request)
    {
        $search = $request->get('search');
        if (!empty($search)) {
            $em = $this->getDoctrine()->getManager();
            $query = $em->createQuery(
                'SELECT f
					FROM BaclooCrmBundle:Machines f
					WHERE f.numserie LIKE :numserie
					Group By f.numserie'
            );
            $query->setParameter('numserie', '%' . $search . '%');
            $result = $query->getArrayResult();

            // Transformer le tableau associatif en un tableau standard
            $array = array();
            foreach ($result as $data) {
                $array[] = array("label" => $data['numserie']);
            }
        }
        $response = new Response(json_encode($array));
        return $response;
    }

    public function requetenumparcAction(Request $request)
    {
        $search = $request->get('search');
        if (!empty($search)) {
            $em = $this->getDoctrine()->getManager();
            $query = $em->createQuery(
                'SELECT f
					FROM BaclooCrmBundle:Machines f
					WHERE f.code LIKE :numparc
					Group By f.numparc'
            );
            $query->setParameter('numparc', '%' . $search . '%');
            $result = $query->getArrayResult();

            // Transformer le tableau associatif en un tableau standard
            $array = array();
            foreach ($result as $data) {
                $array[] = array("label" => $data['code']);
            }
        }
        $response = new Response(json_encode($array));
        return $response;
    }

    public function requete2contactAction(Request $request)
    {
        $search = $request->get('search');
        $entreprise = $request->get('entreprise');
        if (!empty($search)) {
            $em = $this->getDoctrine()->getManager();
            $query = $em->createQuery(
                'SELECT f
					FROM BaclooCrmBundle:Bcontacts f
					WHERE (f.email LIKE :email)
					AND f.entreprise = :entreprise'
            );
            $query->setParameter('email', '%' . $search . '%');
            $query->setParameter('entreprise', $entreprise);
            $result = $query->getArrayResult();

            // Transformer le tableau associatif en un tableau standard
            $array = array();
            foreach ($result as $data) {
                $array[] = array("label" => $data['email']);
            }
        }
        $response = new Response(json_encode($array));
        return $response;
    }

    public function voirbase64Action($id)
    {
        $em = $this->getDoctrine()->getManager();
        $documents  = $em->getRepository('BaclooCrmBundle:Document')
            ->findOneById($id);
        return $this->render('BaclooCrmBundle:Crm:voirbase64.html.twig', array(
            'base64' => $documents->getBase64()
        ));
    }

    public function listebiAction($vue, $mode, $page, $message, $date, $nbresult, $style, $compteclient, Request $request)
    {
        $user = $this->get('security.context')->getToken()->getUsername();
        $objUser = $user;
        if(empty($objUser) or !isset($objUser) or $objUser == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}

        if($this->getRequest()->request->get('pagination') > 0)
        {
            $page = $this->getRequest()->request->get('pagination');
        }
//        else
//        {
//            $page = 1;
//        }
// $date = '2019-08-14';
// echo $date;
// echo date('Y-m-t', strtotime($date));
        $em = $this->getDoctrine()->getManager();
        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($objUser);
        $nbparpage = 50;
        $today = date('Y-m-d');
        // $session = new Session();
        // $session = $request->getSession();
        // $session->set('page', $page);
        // $page = $session->get('page');
// $date = strtotime(date('Y-m-01'));
// $d15 = strtotime('+14 days',$date);
// echo date('Y-m-d', $d15);*
// $mois15 = strtotime(date('Y-m-01', strtotime(" -1 month")));
// $m15 = strtotime('+14 days',$mois15);
// echo date('Y-m-d', $m15);

//        $em->flush();
        //création du formlaire de recherche de factures
        $defaultData = array();
        $form2 = $this->createFormBuilder($defaultData)
            ->add('du', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => false,
                'attr' => array('class' => 'date'),
            ))
            ->add('au', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => false,
                'attr' => array('class' => 'date'),
            ))
            ->add('user', 'choice', array(
                'choices'   => array(
                    'Tous'   => 'Tous',
                    'Cédtech'   => 'Cédtech',
                    'Denis'   => 'Denis',
                    'Sofian'   => 'Sofian',
                ),
                'multiple'  => false,
            ))
            ->add('ville', 'text', array('required' => false))
            ->add('totalttc', 'number', array('required' => false))
            ->add('echeance', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => false,
                'attr' => array('class' => 'date'),
            ))
            ->add('numfacture', 'text', array('required' => false))
            // ->add('clientid', 'text', array('required' => false))
            // ->add('typedoc', 'choice', array(
            // 'choices'   => array(
            // 'facture'   => 'Facture',
            // ),
            // 'multiple'  => false,
            // ))
            ->add('client', 'text', array('required' => false))
            ->add('ville', 'text', array('required' => false))
            ->add('cp', 'number', array('required' => false))
            ->add('ttcgroupe', 'number', array('required' => false))
            ->add('daterech', 'date', array('widget' => 'single_text',
                'input' => 'string',
                'format' => 'dd/MM/yyyy',
                'required' => false,
                'read_only' => false,
                'attr' => array('class' => 'daterech'),
            ))
            ->add('dejareg', 'number', array('required' => false))
            ->add('modepaiement', 'choice', array(
                'choices'   => array(
                    'vide'   => '',
                    'virement'   => 'Virement',
                    'cheque' => 'Chèque',
                    'cb' => 'CB',
                    'cpt' => 'CPT',
                    'lcr' => 'L.C.R',
                    'Trop perçu' => 'Trop perçu',
                    'prélèvement' => 'Prélèvement',
                ),
                'multiple'  => false,
            ))
            // ->add('reglement', 'choice', array(
            // 'choices'   => array(
            // 0   => '',
            // 1   => 'Comptant',
            // 2   => '45 jours fdm',
            // ),
            // 'data' => 2,
            // 'multiple'  => false,
            // ))
            ->getForm();

        $session = new Session();
        $session = $request->getSession();
//        $ville = $compteclient;
//        $session->set('ville', $ville);
        if($request->getMethod() == 'POST')
        {//echo 'post'; echo $this->getRequest()->request->get('envoyer');
            if ($this->getRequest()->request->get('recherche') == 'Rechercher')
            {//echo 'recherche';
                $form2->handleRequest($request);
                // if($form2->isValid()){echo 'ttttttt';
                $data = $form2->getData();
                $du = $data['du'];
                $au = $data['au'];
                $echeance = $data['echeance'];
                $daterech = $data['daterech'];
                $dejareg = $data['dejareg'];
                // $clientid = $data['clientid'];
                $client = $data['client'];//echo 'CLIENT'.$client;
                $ville = $data['ville'];//echo 'CLIENT'.$ville;
                $suivipar = $data['user'];//echo 'CLIENT'.$suivipar;
                $numfacture = $data['numfacture'];//echo 'CLIENT'.$client;
                $cp1 = $data['cp'];//echo 'CLIENT'.$client;
                $ttcgroupe1 = $data['ttcgroupe'];//echo 'CLIENT'.$client;
                $modepaiement = $data['modepaiement'];//echo 'CLIENT'.$client;
                // $reglement = $data['reglement'];
                // $typedoc = $data['typedoc'];
                // $datecrea = $data['datecrea'];
                $session = new Session();
                $session = $request->getSession();

                // définit et récupère des attributs de session
                $session->set('du', $du);
                $session->set('au', $au);
                $session->set('echeance', $echeance);
                $session->set('client', $client);
                $session->set('ville', $ville);
                $session->set('suivipar', $suivipar);
                $session->set('numfacture', $numfacture);
                $session->set('cp', $cp1);
                $session->set('ttcgroupe', $ttcgroupe1);
                $session->set('modepaiement', $modepaiement);
                $session->set('daterech', $daterech);
                $session->set('dejareg', $dejareg);
                // }
            }
            elseif ($this->getRequest()->request->get('maj') == 'Enregistrer')
            {//echo 'maj';

            }
        }

        $session = $request->getSession();
        if(null !== $session->get('du'))
        {
            $du = $session->get('du');
        }
        else
        {
            $du = 0;
        }
        if(null !== $session->get('au'))
        {
            $au = $session->get('au');
        }
        else
        {
            $au = 0;
        }
        if(null !== $session->get('echeance'))
        {
            $echeance = $session->get('echeance');
        }
        else
        {
            $echeance = 0;
        }
        if(null !== $session->get('client'))
        {
            $client = $session->get('client');
        }
        if(null !== $session->get('ville'))
        {
            $ville = $session->get('ville');
        }
        if(null !== $session->get('suivipar'))
        {
            $suivipar = $session->get('suivipar');
        }
        if(null !== $session->get('numfacture'))
        {
            $numfacture = $session->get('numfacture');
        }
        if(null !== $session->get('cp'))
        {
            $cp = $session->get('cp');
        }
        if(null !== $session->get('ttcgroupe'))
        {
            $ttcgroupe = $session->get('ttcgroupe');
        }
        if(null !== $session->get('modepaiement'))
        {
            $modepaiement = $session->get('modepaiement');
        }
        if(null !== $session->get('dejareg'))
        {
            $dejareg = $session->get('dejareg');
        }
        if(null !== $session->get('daterech'))
        {
            $daterech = $session->get('daterech');
        }
        // echo 'la sessin daterech'.$session->get('daterech');

        if($du == ''or !isset($du) or $mode == 'all')
        {
            $du = 0;
        }
        if($au == '' or !isset($au) or $mode == 'all')
        {
            $au = 0;
        }
        if($echeance == '' or !isset($echeance))
        {
            $echeance = 0;
        }
        if(!isset($clientid))
        {
            $clientid = 0;
        }
        if(!isset($client))
        {
            $client = 0;
        }
        if(!isset($ville))
        {
            $ville = 0;
        }
        if(!isset($suivipar) or $mode == 'all')
        {
            $suivipar = 0;
        }
        if(!isset($reglement))
        {
            $reglement = 0;
        }
        elseif($reglement == 666)
        {
            $reglement = 0;
        }
        if(!isset($typedoc))
        {
            $typedoc = 0;
        }
        if(!isset($numfacture))
        {
            $numfacture = 0;
        }
        if(!isset($datecrea))
        {
            $datecrea = 0;
        }
        if(!isset($cp))
        {
            $cp = 0;
        }
        if(!isset($ttcgroupe))
        {
            $ttcgroupe = 0;
        }
        if(!isset($modepaiement))
        {
            $modepaiement = 0;
        }
        if(!isset($daterech))
        {
            // echo 'datrech00000'.$daterech;
            $daterech = 0;
        }
        else
        {
            // echo 'datechoookkkkXXXXXXX'.$daterech;
        }
        if(!isset($dejareg))
        {
            $dejareg = 0;
        }
//        echo 'aaaaaaaaaaaa'.$ville;exit();
// echo 'MOOOODE'.$mode;echo 'CLIENNNN'.$client;echo 'NUmfacture'.$numfacture;echo 'modepaiement'.$modepaiement;echo 'cp'.$cp;
//echo 'MOOOODE'.$mode;echo 'CLIENNNN'.$client;echo 'NUmfacture'.$numfacture;echo 'modepaiement'.$modepaiement;echo 'cp'.$cp;
        $em = $this->getDoctrine()->getManager();

//            $devis = $em->getRepository('BaclooCrmBundle:Locata')
//                    ->listedevis($vue, $mode, $client, $cp, $nbparpage, $page, $ville, $suivipar, $du, $au);

//            $devisfaits = $em->getRepository('BaclooCrmBundle:Locata')
//                ->devisfaits($du, $au, $suivipar);
//            $nbdevisfaits = count($devis);
//
//            $devisacceptes = $em->getRepository('BaclooCrmBundle:Locata')
//                ->devisacceptes($du, $au, $suivipar);
//            $nbdevisacceptes = count($devisacceptes);
//
//            $devissanssuite = $em->getRepository('BaclooCrmBundle:Locata')
//                ->devissanssuite($du, $au, $suivipar);
//            $nbdevissanssuite = count($devissanssuite);
//            if($userdetails->getRoleuser() == 'technicien')
//            {
//                $suivipar = $user;
//            }
        $devisencours = $em->getRepository('BaclooCrmBundle:Venda')
            ->biencours($mode, $du, $au, $suivipar, $client, $cp, $ville);
        $nbdevisencours = count($devisencours);
        $devis = $devisencours;


        return $this->render('BaclooCrmBundle:Crm:listebi.html.twig', array('factures' => $devis,
            'form2' => $form2->createView(),
            'user' => $user,
            'userdetails' => $userdetails,
            'mode' => $mode,
            'vue' => $vue,
            'message' => $message,
            'date' => $date,
            'du' => $du,
            'au' => $au,
            'echeance' => $echeance,
            // 'clientid' => $clientid,
            'client' => $client,
            'ville' => $ville,
            'suivipar' => $suivipar,
            // 'reglement' => $reglement,
            'typedoc' => $typedoc,
            'numfacture' => $numfacture,
            'cp' => $cp,
            'ttcgroupe' => $ttcgroupe,
            'modepaiement' => $modepaiement,
            'datecrea' => $datecrea,
//            'devisfaits' => $devisfaits,
//            'devisacceptes' => $devisacceptes,
//            'devissanssuite' => $devissanssuite,
            'dejareg' => $dejareg,
            'daterech' => $daterech,
//            'nbdevisfaits' => $nbdevisfaits,
//            'nbdevisacceptes' => $nbdevisacceptes,
//            'nbdevissanssuite' => $nbdevissanssuite,
            'nbdevisencours' => $nbdevisencours,
            'style' => $style,
            'nombrePage' => ceil(count($devis)/$nbparpage),
            'page'	  	  => $page
        ));
    }

    public function bondepartAction($bondepartid, $codelocation, Request $request)
    {//echo 'bd'.$bondepartid;
        $user = $this->get('security.context')->getToken()->getUsername(); if(empty($user) or !isset($user) or $user == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        $em = $this->getDoctrine()->getManager();
// echo 'machinedor'.$machinedor;
        if($bondepartid == 0)
        {
            $bondepart = new Bondepart;
            $doca = new Doca;
            $bondepart->setDate(date('Y-m-d'));
            $bondepart->setHeure(date('H:i'));
            $bondepart->setUser($user);
        }
        else
        {
            $bondepart= $em->getRepository('BaclooCrmBundle:Bondepart')
                ->findOneById($bondepartid);
            $bondepartid = $bondepart->getId();
        }
        $location = $em->getRepository('BaclooCrmBundle:Locations')
            ->findOneById($codelocation);
        $machine = $em->getRepository('BaclooCrmBundle:Machines')
            ->findOneById($location->getMachineid());
        //creation du formulaire
        $form = $this->createForm(new BondepartType(), $bondepart);
        // On récupère la requête
        $request = $this->get('request');
        if ($request->getMethod() == 'POST')
        {
            $form->bind($request);
            // On vérifie que les valeurs entrées sont correctes
            // $data = $form->getData();
            if ($form->isValid())
            {
                $bondepart->setEcode($machine->getCode());
                $bondepart->setDescription($machine->getDescription());
                $bondepart->setCodelocation($location->getId());
                $bondepart->setCodecontrat($machine->getCodecontrat());
                $em->persist($bondepart);
                $em->flush();
                $location->setBdid($bondepart->getId());
                $location->setBdok(1);
                $location->setBduser($user);
                $machine->setHorametre($bondepart->getHorametre());
//                $location->setLitrescarb($bondepart->getNiveaucarb())
                $em->persist($location);
                $em->persist($machine);
                $em->flush();
            }

            return $this->redirect($this->generateUrl('bacloocrm_bondepart', array('bondepartid' => $bondepart->getId(), 'codelocation' => $codelocation)));
        }//echo 'bd2'.$bondepartid;exit();
        $documents  = $em->getRepository('BaclooCrmBundle:Document')
            ->findBy(array('codecontrat' => $bondepartid, 'type' => 'bd'));
        return $this->render('BaclooCrmBundle:Crm:bondepart.html.twig', array('form' => $form->createView(),
            'bondepartid' => $bondepartid,
            'machine' => $machine,
            'documents' => $documents,
            'clientid' => $location->getCodeclient(),
            'codelocation' => $codelocation
        ));
    }

    public function bonretourAction($bonretourid, $codelocation, Request $request)
    {
        $user = $this->get('security.context')->getToken()->getUsername(); if(empty($user) or !isset($user) or $user == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        $em = $this->getDoctrine()->getManager();
// echo 'machinedor'.$machinedor;
        if($bonretourid == 0)
        {
            $bonretour = new Bonretour;
            $doca = new Doca;
            $bonretour->setDate(date('Y-m-d'));
            $bonretour->setHeure(date('H:i'));
            $bonretour->setUser($user);
        }
        else
        {
            $bonretour= $em->getRepository('BaclooCrmBundle:Bonretour')
                ->findOneById($bonretourid);
            $bonretourid = $bonretour->getId();
        }
        $location = $em->getRepository('BaclooCrmBundle:Locations')
            ->findOneById($codelocation);
        $machine = $em->getRepository('BaclooCrmBundle:Machines')
            ->findOneById($location->getMachineid());
        //creation du formulaire
        $form = $this->createForm(new BonretourType(), $bonretour);
        // On récupère la requête
        $request = $this->get('request');
        if ($request->getMethod() == 'POST')
        {
            $form->bind($request);
            // On vérifie que les valeurs entrées sont correctes
            // $data = $form->getData();
            if ($form->isValid())
            {
                $bonretour->setEcode($machine->getCode());
                $bonretour->setDescription($machine->getDescription());
                $bonretour->setCodelocation($location->getId());
                $bonretour->setCodecontrat($machine->getCodecontrat());
                $em->persist($bonretour);
                $em->flush();
                $location->setBrid($bonretour->getId());
                $location->setBrok(1);
                $location->setBruser($user);
                $machine->setHorametre($bonretour->getHorametre());
                $location->setLitrescarb($bonretour->getNiveaucarb());
                $em->persist($location);
                $em->persist($machine);
                $em->flush();
            }

            return $this->redirect($this->generateUrl('bacloocrm_bonretour', array('bonretourid' => $bonretour->getId(), 'codelocation' => $codelocation)));
        }
        $documents  = $em->getRepository('BaclooCrmBundle:Document')
            ->findBy(array('codecontrat' => $bonretourid, 'type' => 'br'));
        return $this->render('BaclooCrmBundle:Crm:bonretour.html.twig', array('form' => $form->createView(),
            'bonretourid' => $bonretourid,
            'machine' => $machine,
            'documents' => $documents,
            'clientid' => $location->getCodeclient(),
            'codelocation' => $codelocation
        ));
    }

	public function clonagecontratAction($vendaid)
    {
        $usersess = $this->get('security.context')->getToken()->getUsername();
        $em = $this->getDoctrine()->getManager();
        $locata = $em->getRepository('BaclooCrmBundle:Locata')
            ->findOneByid($vendaid);
        $newlocata= new Locata;
        $newlocata->setDatemodif(date('Y-m-d'));
        $newlocata->setChantierid($locata->getChantierid());
        $newlocata->setNomchantier($locata->getNomchantier());
        $newlocata->setAdresse1($locata->getAdresse1());
        $newlocata->setAdresse2($locata->getAdresse2());
        $newlocata->setAdresse3($locata->getAdresse3());
        $newlocata->setCp($locata->getCp());
        $newlocata->setVille($locata->getVille());
        $newlocata->setClientid($locata->getClientid());
        $newlocata->setClient($locata->getClient());
        $newlocata->setUser($usersess);
        $newlocata->setAcheteur($locata->getAcheteur());
        $newlocata->setContactchantier($locata->getContactchantier());
        $newlocata->setDebutloc($locata->getDebutloc());
        $newlocata->setFinloc($locata->getFinloc());
        $newlocata->setContributionverte($locata->getContributionverte());
        $newlocata->setAssurance($locata->getAssurance());
        $newlocata->setOffreencours(1);
        $newlocata->setTransportaller($locata->getTransportaller());
        $newlocata->setTransportretour($locata->getTransportretour());
        $newlocata->setMontantloc($locata->getMontantloc());
        $newlocata->setMontantlocavente($locata->getMontantlocavente());
//        $newlocata->setPrixcarb($locata->getPrixcarb());
        //$newlocata->setSuivipar($locata->getSuivipar());
        $em->persist($newlocata);
        $em->flush();

        foreach ($locata->getLocations() as $loca) {
            if(null !== $loca->getCodemachine())
            {
                $location = clone $loca;
                $location->setCodemachineinterne('');
                $location->setMachineid(0);
                $location->setCloture(0);
                $location->setEtatloc('');
                $location->setEtatlog('');
                $location->setDatereprise('');
                $location->setBrok(0);
                $location->setBdok(0);
                $location->setBrid(0);
                $location->setBdid(0);
                $location->setBruser(0);
                $location->setBduser(0);
                $location->addLocatum($newlocata);
                $newlocata->addLocation($location);
                $em->persist($location);
                $em->persist($newlocata);
                $em->flush();
            }
        }

        foreach ($locata->getLocationssl() as $loca) {
            if(null !== $loca->getCodemachine()) {
                $location = clone $loca;
                $location->setCodemachineinterne('');
                $location->setMachineid(0);
                $location->setCloture(0);
                $location->setEtatloc('');
                $location->setEtatlog('');
                $location->addLocatum($newlocata);
                $newlocata->addLocationssl($location);
                $em->persist($location);
                $em->persist($newlocata);
                $em->flush();
            }
        }

        foreach ($locata->getLocataventes() as $loca) {
            if(null !== $loca->getDescription()) {
                $locatav = clone $loca;
                $locatav->addLocatum($newlocata);
                $newlocata->addLocatavente($locatav);
                $em->persist($locatav);
                $em->persist($newlocata);
                $em->flush();
            }
        }

        return $this->redirect($this->generateUrl('bacloocrm_ajouterlocation', array('ficheid' => $newlocata->getClientid(), 'locid' => $newlocata->getId())));
    }

    public function clonagecontratautreAction($vendaid, Request $request)
    {
        $usersess = $this->get('security.context')->getToken()->getUsername();
        $em = $this->getDoctrine()->getManager();

        $defaultData = array();
        $form = $this->createFormBuilder($defaultData)
            ->add('entreprise', 'text', array('required' => false))
            ->add('entrepriseid', 'text', array('required' => false))
            ->add('vendaid', 'text', array('required' => false))
            ->getForm();
        $form->handleRequest($request);

        if($form->isValid()) {
            $data = $form->getData();
            $entreprise = $data['entreprise'];
            $entrepriseid = $data['entrepriseid'];

            $locata = $em->getRepository('BaclooCrmBundle:Locata')
                ->findOneByid($vendaid);//echo 'ooooo';echo $venda->getId();
            $newlocata= new Locata;
            $newlocata->setDatemodif(date('Y-m-d'));
            $newlocata->setChantierid($locata->getChantierid());
            $newlocata->setNomchantier($locata->getNomchantier());
            $newlocata->setAdresse1($locata->getAdresse1());
            $newlocata->setAdresse2($locata->getAdresse2());
            $newlocata->setAdresse3($locata->getAdresse3());
            $newlocata->setCp($locata->getCp());
            $newlocata->setVille($locata->getVille());
            $newlocata->setClientid($entrepriseid);
            $newlocata->setClient($entreprise);
            $newlocata->setUser($usersess);
            $newlocata->setAcheteur($locata->getAcheteur());
            $newlocata->setContactchantier($locata->getContactchantier());
            $newlocata->setDebutloc($locata->getDebutloc());
            $newlocata->setFinloc($locata->getFinloc());
            $newlocata->setContributionverte($locata->getContributionverte());
            $newlocata->setAssurance($locata->getAssurance());
            $newlocata->setOffreencours(1);
            $newlocata->setTransportaller($locata->getTransportaller());
            $newlocata->setTransportretour($locata->getTransportretour());
            $newlocata->setMontantloc($locata->getMontantloc());
            $newlocata->setMontantlocavente($locata->getMontantlocavente());
            $newlocata->setPrixcarb($locata->getPrixcarb());
            //$newlocata->setSuivipar($locata->getSuivipar());
            $em->persist($newlocata);
            $em->flush();
            if(null !== $locata->getLocations())
            {
                foreach($locata->getLocations() as $loca)
                {
                    $location = clone $loca;
                    $location->setCodemachineinterne('');
                    $location->setMachineid(0);
                    $location->setCloture(0);
                    $location->setEtatloc('');
                    $location->setEtatlog('');
                    $location->setDatereprise('');
                    $location->setBrok(0);
                    $location->setBdok(0);
                    $location->setBrid(0);
                    $location->setBdid(0);
                    $location->setBruser(0);
                    $location->setBduser(0);
                    $location->setEntreprise($entreprise);
                    $location->setCodeclient($entrepriseid);
                    $location->addLocatum($newlocata);
                    $newlocata->addLocation($location);
                    $em->persist($location);
                    $em->persist($newlocata);
                    $em->flush();
                }

            }
            if(null !== $locata->getLocationssl())
            {
                foreach($locata->getLocationssl() as $loca)
                {
                    $location = clone $loca;
                    $location->setCodemachineinterne('');
                    $location->setMachineid(0);
                    $location->setCloture(0);
                    $location->setEtatloc('');
                    $location->setEtatlog('');
                    $location->setEntreprise($entreprise);
                    $location->setCodeclient($entrepriseid);
                    $location->addLocatum($newlocata);
                    $newlocata->addLocationssl($location);
                    $em->persist($location);
                    $em->persist($newlocata);
                    $em->flush();
                }

            }

            foreach ($locata->getLocataventes() as $loca) {
                if(null !== $loca->getDescription()) {
                    $locatav = clone $loca;
                    $locatav->addLocatum($newlocata);
                    $newlocata->addLocatavente($locatav);
                    $em->persist($locatav);
                    $em->persist($newlocata);
                    $em->flush();
                }
            }
            return $this->redirect($this->generateUrl('bacloocrm_ajouterlocation', array('ficheid' => $entrepriseid, 'locid' => $newlocata->getId())));
        }
        $previous = $this->get('request')->server->get('HTTP_REFERER');
        return $this->render('BaclooCrmBundle:Crm:clonagecontratautre.html.twig', array('form' => $form->createView(),
            'previous' => $previous,
            'vendaid' => $vendaid
        ));
    }

    public function bondepartpdfAction($ficheid, $bdid, $codecontrat, $codelocation, Request $request)
    {
        $user = $this->get('security.context')->getToken()->getUsername(); if(empty($user) or !isset($user) or $user == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        $em = $this->getDoctrine()->getManager();
        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($user);
        $today = date('Y-m-d');

        $client  = $em->getRepository('BaclooCrmBundle:Fiche')
            ->findOneById($ficheid);

        $locata = $em->getRepository('BaclooCrmBundle:Locata')
            ->findOneById($codecontrat);

        $bondepart = $em->getRepository('BaclooCrmBundle:Bondepart')
            ->findOneById($bdid);

        $machine = $em->getRepository('BaclooCrmBundle:Machines')
            ->findOneBy(array('code' => $bondepart->getEcode(), 'original' => 1));

        $pdf = $this->get("white_october.tcpdf")->create();
        $pdf->SetFont('helvetica', '', 9, '', true);
        // set margins
        $pdf->SetMargins(13, '10', '5', '0');
        // SetMargins($left,$top,$right = -1,$keepmargins = false)
        $pdf->AddPage();
        $document  = $em->getRepository('BaclooCrmBundle:Document')
            ->findBy(array('codecontrat' => $bondepart->getId(), 'type' => 'bd'));

        $html = $this->renderView('BaclooCrmBundle:Crm:bdpdf.html.twig', array('date' => $today,
            'bdid' => $bdid,
            'client' => $client,
            'bondepart' => $bondepart,
            'locata' => $locata,
            'machine' => $machine,
            'document' => $document,
            'userdetails' => $userdetails,
            'user' => $user
        ));
        // set bacground image

        $img_base64_encoded = $bondepart->getSigned();
        $img = base64_decode(preg_replace('#^data:image/[^;]+;base64,#', '', $img_base64_encoded));
        $pdf->Image("@".$img, 11, 235, 50, 35);
//            $img_file = K_PATH_IMAGES.'bitemplate.jpg';

        // -- set new background ---
        // get the current page break margin
        $bMargin = $pdf->getBreakMargin();
        // get current auto-page-break mode
        $auto_page_break = $pdf->getAutoPageBreak();
        // disable auto-page-break
        $pdf->SetAutoPageBreak(false, 0);
//        $pdf->Image($img_file, 0, 0, 210, 297, 'JPG', '', '', false, 300, '', false, false, 0);
        // restore auto-page-break status
        $pdf->SetAutoPageBreak($auto_page_break, $bMargin);
        // set the starting point for the page content
        $pdf->setPageMark();

        $pdf->writeHTML($html, true, false, true, false, '');

        $pdf->lastPage();

        $response = new Response($pdf->Output('bd.pdf', 'I'));
        $response->headers->set('Content-Type', 'application/pdf');

        return $response;
    }

    public function bonretourpdfAction($ficheid, $brid, $codecontrat, $codelocation, Request $request)
    {
        $user = $this->get('security.context')->getToken()->getUsername(); if(empty($user) or !isset($user) or $user == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        $em = $this->getDoctrine()->getManager();
        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($user);
        $today = date('Y-m-d');

        $client  = $em->getRepository('BaclooCrmBundle:Fiche')
            ->findOneById($ficheid);

        $locata = $em->getRepository('BaclooCrmBundle:Locata')
            ->findOneById($codecontrat);

        $location = $em->getRepository('BaclooCrmBundle:Locations')
            ->findOneById($codelocation);

        $bonretour = $em->getRepository('BaclooCrmBundle:Bonretour')
            ->findOneById($brid);

        $bondepart = $em->getRepository('BaclooCrmBundle:Bondepart')
            ->findOneByCodelocation($codelocation);

        $machine = $em->getRepository('BaclooCrmBundle:Machines')
            ->findOneBy(array('code' => $location->getCodemachineinterne(), 'original' => 1));

        $pdf = $this->get("white_october.tcpdf")->create();
        $pdf->SetFont('helvetica', '', 9, '', true);
        // set margins
        $pdf->SetMargins(13, '10', '5', '0');
        // SetMargins($left,$top,$right = -1,$keepmargins = false)
        $pdf->AddPage();
        $document  = $em->getRepository('BaclooCrmBundle:Document')
            ->findBy(array('codecontrat' => $bonretour->getId(), 'type' => 'br'));

        $html = $this->renderView('BaclooCrmBundle:Crm:brpdf.html.twig', array('date' => $today,
            'brid' => $brid,
            'client' => $client,
            'bonretour' => $bonretour,
            'locata' => $locata,
            'machine' => $machine,
            'document' => $document,
            'userdetails' => $userdetails,
            'user' => $user
        ));
        // set bacground image

        $img_base64_encoded = $bonretour->getSigned();
        $img = base64_decode(preg_replace('#^data:image/[^;]+;base64,#', '', $img_base64_encoded));
        $pdf->Image("@".$img, 11, 235, 100, 35);
//            $img_file = K_PATH_IMAGES.'bitemplate.jpg';

        // -- set new background ---
        // get the current page break margin
        $bMargin = $pdf->getBreakMargin();
        // get current auto-page-break mode
        $auto_page_break = $pdf->getAutoPageBreak();
        // disable auto-page-break
        $pdf->SetAutoPageBreak(false, 0);
//        $pdf->Image($img_file, 0, 0, 210, 297, 'JPG', '', '', false, 300, '', false, false, 0);
        // restore auto-page-break status
        $pdf->SetAutoPageBreak($auto_page_break, $bMargin);
        // set the starting point for the page content
        $pdf->setPageMark();

        $pdf->writeHTML($html, true, false, true, false, '');

        $pdf->lastPage();

        $response = new Response($pdf->Output('br.pdf', 'I'));
        $response->headers->set('Content-Type', 'application/pdf');

        return $response;
    }

    public function reequilibragefacAction()
    {
        $du = date('Y-m-01', strtotime(" -1 month"));//Debut mois précédent
        $au = date('Y-m-t', strtotime(" -1 month"));
//        $du = '2023-02-01';//Debut mois précédent
//        $au = '2023-02-28';
        $em = $this->getDoctrine()->getManager();

        //ONrécupère les factures à facturer
        $factures = $em->getRepository('BaclooCrmBundle:Factures')
            ->facturesafacturer($du, $au);

        //foreach($factures as $facture){echo '<br>'.$facture->getNumfacture();}exit();
        //On comptare avec le journal
        foreach($factures as $facture)
        {
            $codecontrat = $facture->getLocatacloneid();
            $query = $em->createQuery(
                'SELECT b
	                FROM BaclooCrmBundle:Afacturer b
	                WHERE b.piece = :piece
	                and (b.compte like :compte or b.compte like :comptefrs)
	                and b.analytique != :analytique'
            );
            $query->setParameter('piece', $facture->getNumfacture());
            $query->setParameter('compte', '%411%');
            $query->setParameter('comptefrs', '%401%');
            $query->setParameter('analytique', 'Reglement client');
            $journal = $query->getResult();
            //Ya t il une ou plusieurs écritures ?
            $nbecriture = 0;
            $pasegal = 0;
            foreach($journal as $jour)
            {//if($facture->getNumfacture() == '20226078'){echo '<br>'.$jour->getPiece();}
                $nbecriture++;
                if(($jour->getDebit() > 0 and $jour->getDebit() != $facture->getTotalttc()) or ($jour->getCredit() > 0 and $jour->getCredit() != $facture->getTotalttc()))
                {
                    $pasegal++;
                }
            }

            if($nbecriture > 1 or $pasegal > 0)//si plusieurs écritures = doublon, donc on vire tout
            {
                $query = $em->createQuery(
                    'SELECT b
	                FROM BaclooCrmBundle:Afacturer b
	                WHERE b.piece = :piece
	                and b.analytique != :analytique'
                );
                $query->setParameter('piece', $facture->getNumfacture());
                $query->setParameter('analytique', 'Reglement client');
                $journalasuppr = $query->getResult();
                foreach($journalasuppr as $journalas)
                {
                    $em->remove($journalas);
                    $em->flush();
                }
                $nbecriture = 0;
            }
            if($nbecriture == 0 or $nbecriture > 1 or $pasegal > 0)//si pas d'écriture et doublonc
            {
                $client  = $em->getRepository('BaclooCrmBundle:Fiche')
                    ->findOneById($facture->getClientid());
                $clients = $client;
                //On repasse l'écriture
                //déterminer s'il s'agit de vente, location, avoir ou achat
                if($facture->getCodelocata() == 'V-'.$facture->getLocatacloneid())
                {
                    $codecontrat = $facture->getLocatacloneid();
                    $doc = 'ventes';
                    if($facture->getTypedoc() == 'avoir')
                    {
                        $doc = 'avoir';
                    }
                    $venda = $em->getRepository('BaclooCrmBundle:Venda')
                        ->findOneById($facture->getLocatacloneid());
                }
                else
                {
                    if($facture->getTypedoc() == 'facture')
                    {
                        $doc = 'locations';
                        $codecontrat = $facture->getLocatacloneid();
                        $locata = $em->getRepository('BaclooCrmBundle:Locataclone')
                            ->findOneById($codecontrat);
                    }
                    elseif($facture->getTypedoc() == 'avoir')
                    {
                        $doc = 'avoir';
                    }
                    elseif($facture->getCodelocata() == 'H-'.$facture->getLocatacloneid())
                    {
                        $codecontrat = $facture->getLocatacloneid();
                        $locatafrs = $em->getRepository('BaclooCrmBundle:Locatafrs')
                            ->findOneById($codecontrat);
                        $typeachat = 'normal';
                        $doc = 'achat';//echo 'YYYYYYYYYYYYYYY';
                    }
                    elseif($facture->getCodelocata() != 'H-'.$facture->getLocatacloneid() and $facture->getTypedoc() == 'facture frs')
                    {
                        $codecontrat = $facture->getLocatacloneid();
                        $locatafrs = $em->getRepository('BaclooCrmBundle:Locatafrsclone')
                            ->findOneById($codecontrat);
                        $typeachat = 'sousloc';
                        $doc = 'achat';// echo 'VVVVVVVVVVVVVVV';
                    }
                    elseif($facture->getTypedoc() == 'avoir frs')
                    {
                        $typeachat = 'avoir frs';
                        $doc = 'avoir frs';// echo 'VVVVVVVVVVVVVVV';
                    }
                }
                $fact = $facture;
                $facture->setEncompta(0);
                $em->persist($facture);
                $em->flush();
                include('facturationmensuelledefinitive.php');
            }
            //pas d'écriture
            //l'écriture est unique

            //le montant de 411 est-il égale au ttc de la facture ?
            //On récupère les nouvelles écritures
            $query = $em->createQuery(
                'SELECT b
	                FROM BaclooCrmBundle:Afacturer b
	                WHERE b.piece = :piece
	                and b.analytique != :analytiquex'
            );
            $query->setParameter('piece', $facture->getNumfacture());
            $query->setParameter('analytiquex', 'Reglement client');
            $journal2 = $query->getResult();

            //ON comptabilise debit et crédit
            $debit = 0;
            $credit = 0;
            foreach($journal2 as $journal)
            {
                if($journal->getDebit() > 0)
                {
                    $debit += $journal->getDebit();
                }
                elseif($journal->getCredit() > 0)
                {
                    $credit += $journal->getCredit();
                }
            }
            if($debit - $credit > 1 or $debit - $credit < -1)//écriture déséquiliblrée
            {
                $client  = $em->getRepository('BaclooCrmBundle:Fiche')
                    ->findOneById($facture->getClientid());
                $clients = $client;
                //Si écriture déséquilibrée on supprime les lignes
                $query = $em->createQuery(
                    'SELECT b
                FROM BaclooCrmBundle:Afacturer b
                WHERE b.piece = :piece
                and b.analytique != :analytique'
                );
                $query->setParameter('piece', $facture->getNumfacture());
                $query->setParameter('analytique', 'Reglement client');
                $journalasuppr = $query->getResult();
                foreach($journalasuppr as $journalas)
                {
                    $em->remove($journalas);
                    $em->flush();
                }

                //On repasse l'écriture
                //déterminer s'il s'agit de vente, location, avoir ou achat
                if($facture->getCodelocata() == 'V-'.$facture->getLocatacloneid())
                {
                    $doc = 'ventes';
                    $venda = $em->getRepository('BaclooCrmBundle:Venda')
                        ->findOneById($facture->getLocatacloneid());
                }
                else
                {
                    if($facture->getTypedoc() == 'facture')
                    {
                        $doc = 'locations';
                        $locata = $em->getRepository('BaclooCrmBundle:Locataclone')
                            ->findOneById($codecontrat);
                    }
                    elseif($facture->getTypedoc() == 'avoir')
                    {
                        $doc = 'avoir';
                    }
                    elseif($facture->getCodelocata() == 'H-'.$facture->getLocatacloneid())
                    {
                        $locatafrs = $em->getRepository('BaclooCrmBundle:Locatafrs')
                            ->findOneById($codecontrat);
                        $typeachat = 'normal';
                        $doc = 'achat';//echo 'YYYYYYYYYYYYYYY';
                    }
                    elseif($facture->getCodelocata() != 'H-'.$facture->getLocatacloneid() and $facture->getTypedoc() == 'facture frs')
                    {
                        $locatafrs = $em->getRepository('BaclooCrmBundle:Locatafrsclone')
                            ->findOneById($codecontrat);
                        $typeachat = 'sousloc';
                        $doc = 'achat';// echo 'VVVVVVVVVVVVVVV';
                    }
                    elseif($facture->getTypedoc() == 'avoir frs')
                    {
                        $typeachat = 'avoir frs';
                        $doc = 'avoir frs';// echo 'VVVVVVVVVVVVVVV';
                    }//echo 'doc'.$facture->getTypedoc();exit();
                }
                $fact = $facture;
                $facture->setEncompta(0);
                $em->persist($facture);
                $em->flush();
                include('facturationmensuelledefinitive.php');
            }
        }
//        return $this->redirect($this->generateUrl('bacloocrm_comptadef', array('numfacture' => $numfacture, 'mode' => 'all', 'page' => 1,  'doc' => 'achatspeed', 'bdcid' => $bdcid)));
        return $this->redirect($this->generateUrl('avro_csv_export_export', array('alias' => 'afacturer', 'user' => 'VT', 'dstart' => 0, 'dend' => 0)));
    }

    public function reequilibragefacachatAction()
    {
        $du = '2022-09-01';//Debut mois précédent
        $au = date('Y-m-t', strtotime(" -1 month"));
        $em = $this->getDoctrine()->getManager();

        //ONrécupère les factures à facturer
        $factures = $em->getRepository('BaclooCrmBundle:Factures')
            ->facturesafacturerachat($du, $au);

        //foreach($factures as $facture){echo '<br>'.$facture->getNumfacfrs();}exit();
        //On comptare avec le journal
        foreach($factures as $facture)
        {
            $codecontrat = $facture->getLocatacloneid();
            $query = $em->createQuery(
                'SELECT b
	                FROM BaclooCrmBundle:Afacturer b
	                WHERE b.piece = :piece
	                and (b.compte like :comptefrs)
	                and b.analytique != :analytique'
            );
            $query->setParameter('piece', $facture->getNumfacfrs());
            $query->setParameter('comptefrs', '%401%');
            $query->setParameter('analytique', 'Reglement client');
            $journal = $query->getResult();
            //Ya t il une ou plusieurs écritures ?
            $nbecriture = 0;
            $pasegal = 0;
            foreach($journal as $jour)
            {//if($facture->getNumfacfrs() == '20226078'){echo '<br>'.$jour->getPiece();}
                $nbecriture++;
                if(($jour->getDebit() >= 0 and $jour->getDebit() != $facture->getTotalttc()) or ($jour->getCredit() >= 0 and $jour->getCredit() != $facture->getTotalttc()))
                {
                    $pasegal++;
                }
            }

            if($nbecriture > 1 or $pasegal > 0)//si plusieurs écritures = doublon, donc on vire tout
            {
                $query = $em->createQuery(
                    'SELECT b
	                FROM BaclooCrmBundle:Afacturer b
	                WHERE b.piece = :piece
	                and b.analytique != :analytique'
                );
                $query->setParameter('piece', $facture->getNumfacfrs());
                $query->setParameter('analytique', 'Reglement client');
                $journalasuppr = $query->getResult();
                foreach($journalasuppr as $journalas)
                {
                    $em->remove($journalas);
                    $em->flush();
                }
            }
            if($nbecriture == 0 or $nbecriture > 1 or $pasegal > 0)//si pas d'écriture et doublonc
            {
                $client  = $em->getRepository('BaclooCrmBundle:Fiche')
                    ->findOneById($facture->getClientid());
                $clients = $client;
                //On repasse l'écriture
                //déterminer s'il s'agit de vente, location, avoir ou achat
                if($facture->getCodelocata() == 'V-'.$facture->getLocatacloneid())
                {
                    $codecontrat = $facture->getLocatacloneid();
                    $doc = 'ventes';
                    $venda = $em->getRepository('BaclooCrmBundle:Venda')
                        ->findOneById($facture->getLocatacloneid());
                }
                else
                {
                    if($facture->getTypedoc() == 'facture')
                    {
                        $doc = 'locations';
                        $codecontrat = $facture->getLocatacloneid();
                        $locata = $em->getRepository('BaclooCrmBundle:Locataclone')
                            ->findOneById($codecontrat);
                    }
                    elseif($facture->getTypedoc() == 'avoir')
                    {
                        $doc = 'avoir';
                    }
                    elseif($facture->getCodelocata() == 'H-'.$facture->getLocatacloneid())
                    {
                        $codecontrat = $facture->getLocatacloneid();
                        $locatafrs = $em->getRepository('BaclooCrmBundle:Locatafrs')
                            ->findOneById($codecontrat);
                        $typeachat = 'normal';
                        $doc = 'achat';//echo 'YYYYYYYYYYYYYYY';
                    }
                    elseif($facture->getCodelocata() != 'H-'.$facture->getLocatacloneid() and $facture->getTypedoc() == 'facture frs')
                    {
                        $codecontrat = $facture->getLocatacloneid();
                        $locatafrs = $em->getRepository('BaclooCrmBundle:Locatafrsclone')
                            ->findOneById($codecontrat);
                        $typeachat = 'sousloc';
                        $doc = 'achat';// echo 'VVVVVVVVVVVVVVV';
                    }
                    elseif($facture->getTypedoc() == 'avoir frs')
                    {
                        $typeachat = 'avoir frs';
                        $doc = 'avoir frs';// echo 'VVVVVVVVVVVVVVV';
                    }
                }
                $fact = $facture;
                $facture->setEncompta(0);
                $em->persist($facture);
                $em->flush();
                include('facturationmensuelledefinitive.php');
            }
            //pas d'écriture
            //l'écriture est unique

            //le montant de 411 est-il égale au ttc de la facture ?
            //On récupère les nouvelles écritures
            $query = $em->createQuery(
                'SELECT b
	                FROM BaclooCrmBundle:Afacturer b
	                WHERE b.piece = :piece
	                and b.analytique != :analytiquex'
            );
            $query->setParameter('piece', $facture->getNumfacfrs());
            $query->setParameter('analytiquex', 'Reglement client');
            $journal2 = $query->getResult();

            //ON comptabilise debit et crédit
            $debit = 0;
            $credit = 0;
            foreach($journal2 as $journal)
            {
                if($journal->getDebit() > 0)
                {
                    $debit += $journal->getDebit();
                }
                elseif($journal->getCredit() > 0)
                {
                    $credit += $journal->getCredit();
                }
            }
            if($debit - $credit > 1 or $debit - $credit < -1)//écriture déséquiliblrée
            {
                $client  = $em->getRepository('BaclooCrmBundle:Fiche')
                    ->findOneById($facture->getClientid());
                $clients = $client;
                //Si écriture déséquilibrée on supprime les lignes
                $query = $em->createQuery(
                    'SELECT b
                FROM BaclooCrmBundle:Afacturer b
                WHERE b.piece = :piece
                and b.analytique != :analytique'
                );
                $query->setParameter('piece', $facture->getNumfacfrs());
                $query->setParameter('analytique', 'Reglement client');
                $journalasuppr = $query->getResult();
                foreach($journalasuppr as $journalas)
                {
                    $em->remove($journalas);
                    $em->flush();
                }

                //On repasse l'écriture
                //déterminer s'il s'agit de vente, location, avoir ou achat
                if($facture->getCodelocata() == 'V-'.$facture->getLocatacloneid())
                {
                    $doc = 'ventes';
                    $venda = $em->getRepository('BaclooCrmBundle:Venda')
                        ->findOneById($facture->getLocatacloneid());
                }
                else
                {
                    if($facture->getTypedoc() == 'facture')
                    {
                        $doc = 'locations';
                        $locata = $em->getRepository('BaclooCrmBundle:Locataclone')
                            ->findOneById($codecontrat);
                    }
                    elseif($facture->getTypedoc() == 'avoir')
                    {
                        $doc = 'avoir';
                    }
                    elseif($facture->getCodelocata() == 'H-'.$facture->getLocatacloneid())
                    {
                        $locatafrs = $em->getRepository('BaclooCrmBundle:Locatafrs')
                            ->findOneById($codecontrat);
                        $typeachat = 'normal';
                        $doc = 'achat';//echo 'YYYYYYYYYYYYYYY';
                    }
                    elseif($facture->getCodelocata() != 'H-'.$facture->getLocatacloneid() and $facture->getTypedoc() == 'facture frs')
                    {
                        $locatafrs = $em->getRepository('BaclooCrmBundle:Locatafrsclone')
                            ->findOneById($codecontrat);
                        $typeachat = 'sousloc';
                        $doc = 'achat';// echo 'VVVVVVVVVVVVVVV';
                    }
                    elseif($facture->getTypedoc() == 'avoir frs')
                    {
                        $typeachat = 'avoir frs';
                        $doc = 'avoir frs';// echo 'VVVVVVVVVVVVVVV';
                    }//echo 'doc'.$facture->getTypedoc();exit();
                }
                $fact = $facture;
                $facture->setEncompta(0);
                $em->persist($facture);
                $em->flush();
                include('facturationmensuelledefinitive.php');
            }
        }
//        return $this->redirect($this->generateUrl('bacloocrm_comptadef', array('numfacture' => $numfacture, 'mode' => 'all', 'page' => 1,  'doc' => 'achatspeed', 'bdcid' => $bdcid)));
        return $this->redirect($this->generateUrl('avro_csv_export_export', array('alias' => 'afacturer', 'user' => 'ACH', 'dstart' => 0, 'dend' => 0)));
    }

    public function mettreenlocationAction($codelocation)
    {
        $em = $this->getDoctrine()->getManager();
        $location = $em->getRepository('BaclooCrmBundle:Locations')
            ->findOneByid($codelocation);

        $location->setEtatloc('En location');
        $location->setEtatlog('Déposé en agence');
        $em->persist($location);

        $machine = $em->getRepository('BaclooCrmBundle:Machines')
            ->findOneByid($location->getMachineid());
        $machine->setEtat('En location');
        $machine->setEtatlog('Livré chez le client');
        $em->persist($machine);
        $em->flush();

        return $this->redirect($this->generateUrl('bacloocrm_adispatcher'));
    }

    public function oklogAction($codelocations, $ecode)
    {
        $em = $this->getDoctrine()->getManager();

        $locations  = $em->getRepository('BaclooCrmBundle:Locations')
            ->findOneBy(array('id' => $codelocations, 'codemachineinterne' => $ecode));
        if(!isset($locations))
        {
            $locations  = $em->getRepository('BaclooCrmBundle:Locationssl')
                ->findOneBy(array('id' => $codelocations, 'codemachineinterne' => $ecode));
        }

        if(isset($locations))
        {
            $locations->setOklog(1);
            $em->persist($locations);
            $em->flush();
        }

        return $this->redirect($this->generateUrl('bacloocrm_retours'));
    }

    //location dépuis le planning 
    public function locationsmodalecomAction(Request $request){
        $user = $this->get('security.context')->getToken()->getUsername(); if(empty($user) or !isset($user) or $user == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        $em = $this->getDoctrine()->getManager();
        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($user);
        $today = date('Y-m-d');


        //données venant de la requete ajax
        $debut= $request->get('eventStart');
        $fin = $request->get('eventEnd');
        $fin = date('Y-m-d', strtotime($fin . ' -1 day'));
        $idResource = $request->get('eventResourceId');//echo 'id redss'.$idResource;
//        $idResource = 'P303';

         $m = $em->getRepository('BaclooCrmBundle:Machines')
             ->findOneBy(array('code' => $idResource, 'original' => 1));

        $listeDesComposantsParDefautRoulottes = $em->getRepository('BaclooCrmBundle:ComposantsRoulotte')
            ->findAll();
        //initialisation du contrat
        $contrat = 0;

        $locata = new Locata;
		$locata->setDatecrea(date('Y-m-d'));
		$locata->setClientid(0);
        $locata->setClient('Raison sociale');
		$locata->setOffreencours(1);
//        $locata->setNomchantier('Ras');
//        $locata->setAdresse1('Ras');
		$locata->setUser($user);
        $locata->setFacturersamedi(true);
        $locata->setFacturerdimanche(true);
        $locata->setFacturationferies(true);
        $locata->setCommentaire('Participation à la gestion des déchets - compris dans le tarif de la prestation de la vidange');

        foreach ($listeDesComposantsParDefautRoulottes as $component) {
            $locatavente = new LocataVentes();
//                $locatavente->setRefArticle($component->getRefArticle());
            $locatavente->setDescription($component->getDescription());
            $locatavente->setQuantite($component->getQuantite());
            $locatavente->setPu($component->getPu());
            $locatavente->setUser($user);
            // Ajoutez d'autres propriétés si nécessaire
            $locata->addLocatavente($locatavente);
        }

        $location = new Locations;
        $location->setDebutloc($debut);
        $location->setFinloc($fin);
        $location->setCodeclient(0);
        $location->setEntreprise("Raison sociale");
        $location->setCodemachine($m->getCodegenerique());
        $location->setMachineid($m->getId());
        $location->setCodemachineinterne($m->getCode());
        $location->setProchainevgp($m->getProchaineVgp());
        $location->setTypemachine($m->getDescription());
        $location->setAssurance(true);
        $location->setBdid(0);
        $location->setBrid(0);
//        if($m->getEnergie() == 'electrique')
//        {
//            $location->setForfaitcharge(true);
//        }
//        else
//        {
//            $location->setForfaitcharge(false);
//        }
        $location->addLocatum($locata);
        $locata->addLocation($location);

        $em->persist($locata);
        $em->persist($location);
        $em->flush();

        $grille  = $em->getRepository('BaclooCrmBundle:Grille')
            ->findOneBy(array('codeclient' => 2, 'codemachineinterne' => $m->getCodegenerique()));

        if(isset($grille))
        {
            $location->setLoyerp1b($grille->getLoyerp1());
            $location->setLoyerp2b($grille->getLoyerp2());
            $location->setLoyerp3b($grille->getLoyerp3());
            $location->setLoyerp4b($grille->getLoyerp4());
            $location->setLoyermensuelb($grille->getLoyerp1());
            $em->persist($location);
            $em->flush();
        }

        $form = $this->createForm(new LocataType(), $locata);
        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($user);
        $roleuser = $userdetails->getRoleuser();
        if($locata->getClient() == 'Raison sociale')
        {
            $entreprise = 'Raison sociale';
            $client = 0;
            $clientassurance = 0;
        }
        else
        {
            $entreprise = $locata->getClient();
            $client  = $em->getRepository('BaclooCrmBundle:Fiche')
                ->findOneById($locata->getClientid());
            $clientassurance = $client->getAssurance();
        }
        $documents  = $em->getRepository('BaclooCrmBundle:Document')
            ->findBy(array('codecontrat' => $locata->getId(), 'type' => 'contrat'));

        return $this->render('BaclooCrmBundle:Crm:nouvelle_locationmodaleok.html.twig', array(
            'form' => $form->createView(),
            'user' => $user,
            'roleuser' => $roleuser,
            'entreprise' => $entreprise,
            'clientassurance' => $clientassurance,
            'grille' => $grille,
            'id' => $locata->getClientid(),
            'clientid' => $locata->getClientid(),
            'date' => date('Y-m-d'),
            'contrat' =>  $contrat,
            'locaid' =>$locata->getId(),
            'locid' =>$locata->getId(),
            'documents' => $documents,
            'codemachine' => $m->getCodegenerique(),
            'montantcarb' => 0,
            'typeplanning' => 'planning',
            'detail' => 'NON'
        ));
    }

    public function locationsmodalecomslAction(Request $request){
        $user = $this->get('security.context')->getToken()->getUsername(); if(empty($user) or !isset($user) or $user == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        $em = $this->getDoctrine()->getManager();
        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($user);
        $today = date('Y-m-d');


        //données venant de la requete ajax
        $debut= $request->get('eventStart');
        $fin = $request->get('eventEnd');
        $fin = date('Y-m-d', strtotime($fin . ' -1 day'));
        $idResource = $request->get('eventResourceId');//echo 'id redss'.$idResource;
//        $idResource = 'A16EG025';

         $m = $em->getRepository('BaclooCrmBundle:Machinessl')
             ->findOneBy(array('code' => $idResource, 'original' => 1));

        //initialisation du contrat
        $contrat = 0;

        $locata = new Locata;
		$locata->setDatecrea(date('Y-m-d'));
		$locata->setClientid(0);
        $locata->setClient('Raison sociale');
		$locata->setOffreencours(1);
//        $locata->setNomchantier('Ras');
//        $locata->setAdresse1('Ras');
		$locata->setUser($user);


        $location = new Locationssl;
        $location->setDebutloc($debut);
        $location->setFinloc($fin);
        $location->setCodeclient(0);
        $location->setEntreprise("Raison sociale");
        $location->setCodemachine($m->getCodegenerique());
        $location->setMachineid($m->getId());
        $location->setCodemachineinterne($m->getCode());
        $location->setTypemachine($m->getDescription());
        $location->setAssurance(true);
        $location->addLocatum($locata);
        $locata->addLocationssl($location);

        $em->persist($locata);
        $em->persist($location);
        $em->flush();

        $form = $this->createForm(new LocataType(), $locata);
        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($user);
        $roleuser = $userdetails->getRoleuser();
        if($locata->getClient() == 'Raison sociale')
        {
            $entreprise = 'Raison sociale';
            $client = 0;
            $clientassurance = 0;
        }
        else
        {
            $entreprise = $locata->getClient();
            $client  = $em->getRepository('BaclooCrmBundle:Fiche')
                ->findOneById($locata->getClientid());
            $clientassurance = $client->getAssurance();
        }

        $grille  = $em->getRepository('BaclooCrmBundle:Grille')
            ->findByCodeclient($locata->getClientid());

        $locatafrs = $em->getRepository('BaclooCrmBundle:Locatafrs')
            ->findByCodelocatasl($locata->getId());

        $documents  = $em->getRepository('BaclooCrmBundle:Document')
            ->findBy(array('codecontrat' => $locata->getId(), 'type' => 'contrat'));

        return $this->render('BaclooCrmBundle:Crm:nouvelle_locationmodaleok.html.twig', array(
            'form' => $form->createView(),
            'user' => $user,
            'roleuser' => $roleuser,
            'entreprise' => $entreprise,
            'clientassurance' => $clientassurance,
            'grille' => $grille,
            'id' => $locata->getClientid(),
            'clientid' => $locata->getClientid(),
            'date' => date('Y-m-d'),
            'contrat' =>  $contrat,
            'locaid' =>$locata->getId(),
            'locid' =>$locata->getId(),
            'locatafrs' => $locatafrs,
            'documents' => $documents,
            'montantcarb' => 0,
            'typeplanning' => 'planningsl',
            'detail' => 'NON'
        ));
    }
    
    public function majeventAction(Request $request)
    {
        $em = $this->getDoctrine()->getManager();
//        $eventData = $request->request->all();
        $defaultData = array();

        $debut= $request->get('eventStart');//echo 'rrrr'.date('d/m/Y',strtotime($eventStart));
        $fin = $request->get('eventEnd');//echo 'xxxxxx'.$eventEnd;        $defaultData = array();
        $chauffeur = $request->get('eventResourceTitle');//echo 'xxxxxx'.$eventEnd;        $defaultData = array();
        $id = $request->get('eventResourceId');//echo 'xxxxxx'.$eventEnd;        $defaultData = array();

        
        $form = $this->createFormBuilder($defaultData)
                ->add('debut', 'text', array('required' => false))
                ->add('fin', 'text', array('required' => false))
                ->add('chauffeur', 'text', array('required' => false))
                ->add('id', 'text', array('required' => false))
                ->add('raisonSociale','text',array('required' => true))
                ->add('nomchantier', 'text',array('required' => true))
                ->add('adresse1', 'text', array('required' => false))
                ->add('clientid','number',array('required' => false))
//                ->add('titre', 'text', array('required' => false))
            ->getForm();
        $form->handleRequest($request);
        // On vérifie qu'elle est de type POST
        if ($request->getMethod() == 'POST')
        {//echo 'icic';exit();
            $data = $form->getData();
            $debut =  $data['debut'];
            $fin =  $data['fin'];
            $chauffeur =  $data['chauffeur'];
            $id =  $data['id'];
//            $titre  =  $data['titre'];
            $event  = $em->getRepository('BaclooCrmBundle:Event')
                ->findOneById(36);
            $event->setEventDate($debut);
            $event->setEntreprise($fin);
            $event->setUser($chauffeur);
            $event->setEventComment($id);
            $event->setCp($id);
            $em->persist($event);
            $em->flush();

            $event  = $em->getRepository('BaclooCrmBundle:Event')
                ->findAll();
            $events = array();
            foreach($event as $even)
            {
                $events['title'] = 'Le titre';
                $events['start'] = $even->getEventDate();
                $events['end'] = $even->getEntreprise();
                $events['resource'] = $even->getEventComment();
            }

            return $this->redirect($this->generateUrl('bacloocrm_planningtest'));
        }



        return $this->render('BaclooCrmBundle:Crm:formdeplanning.html.twig', array(
            'form' => $form->createView(),
            'debut' => $debut,
            'fin' => $fin,
            'id' => $id,
            'chauffeur' => $chauffeur
        ));
    }

    public function sendeventAction(Request $request)
    {
        $em = $this->getDoctrine()->getManager();
//

        $event  = $em->getRepository('BaclooCrmBundle:Event')
            ->findAll();
        $events = array();
        foreach ($event as $even) {
            $eventData = array();
            $eventData['id'] = $even->getId();
            $eventData['title'] = 'Le titre';
            $eventData['start'] = $even->getEventDate();
            $eventData['end'] = $even->getEntreprise();
            $eventData['resourceId'] = $even->getEventComment();

            $events[] = $eventData;
        }

        return new JsonResponse($events);
    }

    //fonction permettant de charger les évenement de location
    public function sendeventsAction(Request $request){
        $em = $this->getDoctrine()->getManager();

        $locations = array();

        $locata = $em->getRepository('BaclooCrmBundle:Locata')
            ->locplanningparc();
         foreach($locata as $loc){
            $eventsData = array();
            foreach($loc->getLocations() as $location){
                if ($loc->getContrat() == 0) {
                    // $eventsData['idlocation'] = $location->getId();
                    $eventsData['id'] = $loc->getId();
                    $eventsData['title'] = $location->getEntreprise();
                    $eventsData['start'] = $location->getDebutloc();
                    $eventsData['end'] = date('Y-m-d', strtotime($location->getFinloc() . ' +1 day'));
//                    $eventsData['end'] = $location->getFinloc();
                    $eventsData['resourceId'] = $location->getCodemachineinterne();
                    $eventsData['color'] = '#5cb85c';
                    $eventsData['description'] = 'contrat n° : '.$loc->getId().' - '.$loc->getVille();
                    $locations[] = $eventsData;
                }
                elseif($location->getEtatloc() == "Réservé"){
                    $eventsData['id'] = $loc->getId();
                    $eventsData['title'] = $location->getEntreprise();
                    $eventsData['start'] = $location->getDebutloc();
                    $eventsData['end'] = date('Y-m-d', strtotime($location->getFinloc() . ' +1 day'));
//                    $eventsData['end'] = $location->getFinloc();
                    $eventsData['resourceId'] = $location->getCodemachineinterne();
                    $eventsData['color'] = 'pink';
                    $eventsData['description'] = 'contrat n° : '.$loc->getId().' - '.$loc->getVille();
                    $locations[] = $eventsData;
                }
                elseif($location->getEtatloc() == "En location"){
                    $eventsData['id'] = $loc->getId();
                    $eventsData['title'] = $location->getEntreprise();
                    $eventsData['start'] = $location->getDebutloc();
                    $eventsData['end'] = date('Y-m-d', strtotime($location->getFinloc() . ' +1 day'));
//                    $eventsData['end'] = $location->getFinloc();
                    $eventsData['resourceId'] = $location->getCodemachineinterne();
                    $eventsData['color'] = 'orange';
                    $eventsData['description'] = 'contrat n° : '.$loc->getId().' - '.$loc->getVille();
                    $locations[] = $eventsData;
                }
                elseif($location->getEtatloc() == "Location terminée" and ($location->getEtatlog() == "Déposé en agence" or $location->getEtatlog() == "Location terminée")){
                    $eventsData['id'] = $loc->getId();
                    $eventsData['title'] = $location->getEntreprise();
                    $eventsData['start'] = $location->getDebutloc();
                    $eventsData['end'] = date('Y-m-d', strtotime($location->getFinloc() . ' +1 day'));
//                    $eventsData['end'] = $location->getFinloc();
                    $eventsData['resourceId'] = $location->getCodemachineinterne();
                    $eventsData['color'] = '#75627D';
                    $eventsData['description'] = 'contrat n° : '.$loc->getId().' - '.$loc->getVille();
                    $locations[] = $eventsData;
                }
                elseif($location->getEtatlog() == "Prêt pour le chargement" or $location->getEtatloc() == "Prêt au départ"){
                    $eventsData['id'] = $loc->getId();
                    $eventsData['title'] = $location->getEntreprise();
                    $eventsData['start'] = $location->getDebutloc();
                    $eventsData['end'] = date('Y-m-d', strtotime($location->getFinloc() . ' +1 day'));
//                    $eventsData['end'] = $location->getFinloc();
                    $eventsData['resourceId'] = $location->getCodemachineinterne();
                    $eventsData['color'] = '#FFCC91';
                    $eventsData['description'] = 'contrat n° : '.$loc->getId().' - '.$loc->getVille();
                    $locations[] = $eventsData;
                }
                elseif($location->getEtatlog() == "Retour planifié" ){
                    $eventsData['id'] = $loc->getId();
                    $eventsData['title'] = $location->getEntreprise();
                    $eventsData['start'] = $location->getDebutloc();
                    $eventsData['end'] = date('Y-m-d', strtotime($location->getFinloc() . ' +1 day'));
//                    $eventsData['end'] = $location->getFinloc();
                    $eventsData['resourceId'] = $location->getCodemachineinterne();
                    $eventsData['color'] = '#B26FFF';
                    $eventsData['description'] = 'contrat n° : '.$loc->getId().' - '.$loc->getVille();
                    $locations[] = $eventsData;
                }
                elseif($location->getEtatloc() == "" and $loc->getContrat() == 1){
                    $eventsData['id'] = $loc->getId();
                    $eventsData['title'] = $location->getEntreprise();
                    $eventsData['start'] = $location->getDebutloc();
                    $eventsData['end'] = date('Y-m-d', strtotime($location->getFinloc() . ' +1 day'));
//                    $eventsData['end'] = $location->getFinloc();
                    $eventsData['resourceId'] = $location->getCodemachineinterne();
                    $eventsData['color'] = 'pink';
                    $eventsData['description'] = 'contrat n° : '.$loc->getId().' - '.$loc->getVille();
                    $locations[] = $eventsData;
                }
            }

         }
        return new JsonResponse($locations);
    }

    //fonction permettant d'envoyer les resources au fullcalendar
    public function sendressourcesAction($codemachine, Request $request)
    {
        $em = $this->getDoctrine()->getManager();
        if($codemachine != 'tout' and $codemachine != '0')
        {
//            $machiness  = $em->getRepository('BaclooCrmBundle:Machines')
//                ->findByCodegenerique($codemachine);
            $query = $em->createQuery(
                'SELECT f
				FROM BaclooCrmBundle:Machines f
				WHERE f.codegenerique = :codegenerique
				AND f.etat != :etat1 and f.etat != :etat2 and f.etat != :etat3 and f.etat != :etat4 and f.etat != :etat5
				Order By f.code ASC'
            );
            $query->setParameter('codegenerique',$codemachine);
            $query->setParameter('etat1', 'Hors Usage');
            $query->setParameter('etat2', 'Indisponible');
            $query->setParameter('etat3', 'Pièce');
            $query->setParameter('etat4', 'Vendu');
            $query->setParameter('etat5', 'Volé');
            $machiness = $query->getResult();
        }
        else
        {
//            $machiness = $em->getRepository('BaclooCrmBundle:Machines')
//                ->findAll();
            $query = $em->createQuery(
                'SELECT f
				FROM BaclooCrmBundle:Machines f
				WHERE f.etat != :etat1 and f.etat != :etat2 and f.etat != :etat3 and f.etat != :etat4 and f.etat != :etat5
				Order By f.code ASC'
            );
            $query->setParameter('etat1', 'Hors Usage');
            $query->setParameter('etat2', 'Indisponible');
            $query->setParameter('etat3', 'Pièce');
            $query->setParameter('etat4', 'Vendu');
            $query->setParameter('etat5', 'Volé');
            $machiness = $query->getResult();
        }
        $machines = array();
        foreach($machiness as $machine){
            $ressourceData = array();
            $ressourceData['id'] = $machine->getCode();
            $ressourceData['title'] = $machine->getCode();
            $machines[] = $ressourceData;
        }
        
        return new JsonResponse($machines);
    }


    //fonction permettant de charger les évenement de location
    public function sendeventsslAction(Request $request){
        $em = $this->getDoctrine()->getManager();
        $locations = array();

        $locata = $em->getRepository('BaclooCrmBundle:Locata')
            ->locplanningsl();
         foreach($locata as $loc){
            $eventsData = array();
            foreach($loc->getLocationssl() as $location){
                if ($loc->getContrat() == 0) {
                    // $eventsData['idlocation'] = $location->getId();
                    $eventsData['id'] = $loc->getId();
                    $eventsData['title'] = $location->getEntreprise();
                    $eventsData['start'] = $location->getDebutloc();
                    $eventsData['end'] = date('Y-m-d', strtotime($location->getFinloc() . ' +1 day'));
//                    $eventsData['end'] = $location->getFinloc();
                    $eventsData['resourceId'] = $location->getCodemachineinterne();
                    $eventsData['color'] = '#5cb85c';
                    $eventsData['description'] = 'contrat n° : '.$loc->getId().' - '.$loc->getVille();
                    $locations[] = $eventsData;
                }
                elseif($location->getEtatloc() == "Réservé"){
                    $eventsData['id'] = $loc->getId();
                    $eventsData['title'] = $location->getEntreprise();
                    $eventsData['start'] = $location->getDebutloc();
                    $eventsData['end'] = date('Y-m-d', strtotime($location->getFinloc() . ' +1 day'));
//                    $eventsData['end'] = $location->getFinloc();
                    $eventsData['resourceId'] = $location->getCodemachineinterne();
                    $eventsData['color'] = 'pink';
                    $eventsData['description'] = 'contrat n° : '.$loc->getId().' - '.$loc->getVille();
                    $locations[] = $eventsData;
                }
                elseif($location->getEtatloc() == "En location" and $location->getEtatlog() == "Livré chez le client"){
                    $eventsData['id'] = $loc->getId();
                    $eventsData['title'] = $location->getEntreprise();
                    $eventsData['start'] = $location->getDebutloc();
                    $eventsData['end'] = date('Y-m-d', strtotime($location->getFinloc() . ' +1 day'));
//                    $eventsData['end'] = $location->getFinloc();
                    $eventsData['resourceId'] = $location->getCodemachineinterne();
                    $eventsData['color'] = 'orange';
                    $eventsData['description'] = 'contrat n° : '.$loc->getId().' - '.$loc->getVille();
                    $locations[] = $eventsData;
                }
                elseif($location->getEtatloc() == "Location terminée"){
                    $eventsData['id'] = $loc->getId();
                    $eventsData['title'] = $location->getEntreprise();
                    $eventsData['start'] = $location->getDebutloc();
                    $eventsData['end'] = date('Y-m-d', strtotime($location->getFinloc() . ' +1 day'));
//                    $eventsData['end'] = $location->getFinloc();
                    $eventsData['resourceId'] = $location->getCodemachineinterne();
                    $eventsData['color'] = '#75627D';
                    $locations[] = $eventsData;
                }
                elseif($location->getEtatlog() == "Prêt pour le chargement"){
                    $eventsData['id'] = $loc->getId();
                    $eventsData['title'] = $location->getEntreprise();
                    $eventsData['start'] = $location->getDebutloc();
                    $eventsData['end'] = date('Y-m-d', strtotime($location->getFinloc() . ' +1 day'));
//                    $eventsData['end'] = $location->getFinloc();
                    $eventsData['resourceId'] = $location->getCodemachineinterne();
                    $eventsData['color'] = '#FFCC91';
                    $eventsData['description'] = 'contrat n° : '.$loc->getId().' - '.$loc->getVille();
                    $locations[] = $eventsData;
                }
                elseif($location->getEtatloc() == "Retour planifié"){
                    $eventsData['id'] = $loc->getId();
                    $eventsData['title'] = $location->getEntreprise();
                    $eventsData['start'] = $location->getDebutloc();
                    $eventsData['end'] = date('Y-m-d', strtotime($location->getFinloc() . ' +1 day'));
//                    $eventsData['end'] = $location->getFinloc();
                    $eventsData['resourceId'] = $location->getCodemachineinterne();
                    $eventsData['color'] = '#B26FFF';
                    $eventsData['description'] = 'contrat n° : '.$loc->getId().' - '.$loc->getVille();
                    $locations[] = $eventsData;
                }
                elseif($location->getEtatloc() == "" and $loc->getContrat() == 1){
                    $eventsData['id'] = $loc->getId();
                    $eventsData['title'] = $location->getEntreprise();
                    $eventsData['start'] = $location->getDebutloc();
                    $eventsData['end'] = date('Y-m-d', strtotime($location->getFinloc() . ' +1 day'));
//                    $eventsData['end'] = $location->getFinloc();
                    $eventsData['resourceId'] = $location->getCodemachineinterne();
                    $eventsData['color'] = 'pink';
                    $eventsData['description'] = 'contrat n° : '.$loc->getId().' - '.$loc->getVille();
                    $locations[] = $eventsData;
                }
            }

         }
        return new JsonResponse($locations);
    }

    //fonction permettant d'envoyer les resources au fullcalendar
    public function sendressourcesslAction($codemachine, Request $request)
    {
        $em = $this->getDoctrine()->getManager();
        if($codemachine != 'tout' and $codemachine != '0')
        {
            $query = $em->createQuery(
                'SELECT f
			FROM BaclooCrmBundle:Machinessl f
			WHERE f.etat != :etat
			AND f.codemachine = :codemachine
			Order by f.code ASC'
            );
            $query->setParameter('etat', 'Disponible');
            $query->setParameter('codemachine', $codemachine);
            $machiness = $query->getResult();
        }
        else
        {
//            $machiness = $em->getRepository('BaclooCrmBundle:Machinessl')
//                ->findAll();
            $query = $em->createQuery(
                'SELECT f
			FROM BaclooCrmBundle:Machinessl f
			WHERE f.etat != :etat
			Order by f.code ASC'
            );
            $query->setParameter('etat', 'Disponible');
            $machiness = $query->getResult();
        }
        $machines = array();
        foreach($machiness as $machine){
            $ressourceData = array();
            $ressourceData['id'] = $machine->getCode();
            $ressourceData['title'] = $machine->getCode();
            $ressourceData['loueur'] = $machine->getLoueur();
            $machines[] = $ressourceData;
        }
        
        return new JsonResponse($machines);
    }

    public function locationsmodalecomokAction($locataid, Request $request)
    {
//        exit('laaarr');
        $user = $this->get('security.context')->getToken()->getUsername(); if(empty($user) or !isset($user) or $user == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        $em = $this->getDoctrine()->getManager();

        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($user);
        $today = date('Y-m-d');

        if(!isset($locataid) or empty($locataid))
        {
            $locataid = $request->get('eventResourceId');
        }

//         die($locataid);
        
        $locata = $em->getRepository('BaclooCrmBundle:Locata')
        ->findOneById($locataid);//echo 'locataid'.$locata->getClientid();
       // $locata->setContrat();
        $locata->setUser($user);
       
        //$bdcrecu = $venda->getBdcrecu();

        $form = $this->createForm(new LocataType(), $locata);
        $request = $this->get('request');

        if ($request->getMethod() == 'POST')
        {//echo 'ici';exit();
             //initialisatiion de la variable qui vas contenier l'id de la locations
                $idlocation = 0;
                $debut = 0;
                $fin =0;
                $idloc = 0;
                $code = "ras"; //code machine
            $form->bind($request);

            if($form->isValid()){
                $em->flush();

            //gestion des sous locations
            foreach($locata->getLocations() as $loc){
                $idlocation = $loc->getId();
                $code = $loc->getCodemachineinterne();
                $debut = $loc->getDebutloc();
                $fin = $loc->getFinloc();
            }
            // die($code);
            //gérer la fiche cleint
            //on vérifie d'abord si il existe
                if(null === $form->get('client')->getData())
                {
                    $client = $em->getRepository('BaclooCrmBundle:Fiche')
                        ->findOneByRaisonSociale($form->get('client')->getData());
                }
                else
                {
                    $client = $em->getRepository('BaclooCrmBundle:Fiche')
                        ->findOneByRaisonSociale($locata->getClient());
                }
            if(isset($client)){
                $locata->setClient($client->getRaisonSociale());
                $locata->setClientid($client->getId());
                //ajouter les adresse
                $locata->setAdresse1($form->get('adresse1')->getData());
                $locata->setAdresse2($form->get('adresse2')->getData());
                $locata->setAdresse3($form->get('adresse3')->getData());
                $locata->setCp($form->get('cp')->getData());
                $locata->setVille($form->get('ville')->getData());
            }
            else{

                $client = new Fiche;
                $client->setRaisonSociale($form->get('client')->getData());
                $client->setAdresse1($form->get('adresse1')->getData());
                $client->setAdresse2($form->get('adresse2')->getData());
                $client->setAdresse3($form->get('adresse3')->getData());
                $client->setCp($form->get('cp')->getData());
                $client->setVille($form->get('ville')->getData());
                $em->persist($client);
                $em->flush();
                $locata->setClientid($client->getId());
                $locata->setClient($form->get('client')->getData());
                 //ajouter les adresse
                 $locata->setAdresse1($form->get('adresse1')->getData());
                 $locata->setAdresse2($form->get('adresse2')->getData());
                 $locata->setAdresse3($form->get('adresse3')->getData());
                 $locata->setCp($form->get('cp')->getData());
                 $locata->setVille($form->get('ville')->getData());
            }

            //on vérifie égalementsi le chantier existe
            $chantier = $em->getRepository('BaclooCrmBundle:Chantier')
            ->findOneByNom($form->get('nomchantier')->getData());
            if(isset($chantier)){

                $locata->setChantierid($chantier->getId());
                $locata->setNomchantier($chantier->getNom());
            }
            else{

                $chantier = new Chantier;
                $chantier->setNom($form->get('nomchantier')->getData());
                $chantier->setAdresse1($form->get('adresse1')->getData());
                $chantier->setAdresse2($form->get('adresse2')->getData());
                $chantier->setAdresse3($form->get('adresse3')->getData());
                $chantier->setCp($form->get('cp')->getData());
                $chantier->setVille($form->get('ville')->getData());
                $em->persist($chantier);
                $em->flush();
                $locata->setChantierid($chantier->getId());
                $locata->setNomchantier($chantier->getNom());
            }
            //persister la location corespondante a locata
            $machine = $em->getRepository('BaclooCrmBundle:Machines')
                ->findOneByCode($code);
            $location = $em->getRepository('BaclooCrmBundle:Locations')->findOneById($idlocation);
            $location->setCodeclient($client->getId());
            $location->setEntreprise($form->get('client')->getData());
            $location->setMachineid($machine->getId());
            $location->setCodemachine($machine->getcodegenerique());
            $location->setCodemachineinterne($machine->getCode());
            $location->setTypemachine($machine->getDescription());
            $location->setContributionverte(TRUE);
        }

        // $locata->addLocation($location);
        $em->persist($locata);
        $em->flush();
        $mode ="machines";

        return $this->redirect($this->generateUrl('bacloocrm_planning', array('mode' => $mode, 'openModal' => 'true')));
    }
       
        // var_dump($a);
        // die();      

       // var_dump($nomclient, $numbdc, $nomchantier, $adresse1,  $cp, $ville);
    //    die($locataid); 
    // var_dump($locata->getClientid());
   // die();
        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($user);
        $roleuser = $userdetails->getRoleuser();
        if($locata->getClient() == 'Raison sociale')
        {
            $entreprise = 'Raison sociale';
            $client = 0;
            $clientassurance = 0;
        }
        else
        {//echo 'icicicii'.$locata->getClientid();
            $entreprise = $locata->getClient();
            $client  = $em->getRepository('BaclooCrmBundle:Fiche')
                ->findOneById($locata->getClientid());
            $clientassurance = $client->getAssurance();
        }
        if($locataid > 0)
        {
            $grille  = $em->getRepository('BaclooCrmBundle:Grille')
                ->findByCodeclient($locata->getClientid());
        }
        else
        {
            $grille = array();
        }

        $locatafrs = $em->getRepository('BaclooCrmBundle:Locatafrs')
            ->findByCodelocatasl($locataid);
        $documents  = $em->getRepository('BaclooCrmBundle:Document')
            ->findBy(array('codecontrat' => $locataid, 'type' => 'contrat'));

        $moisdevis = date("m", strtotime($locata->getDatecrea()));
        $anneedevis = date("Y", strtotime($locata->getDatecrea()));

       return $this->render('BaclooCrmBundle:Crm:nouvelle_locationmodaleok.html.twig', array(
           'form' => $form->createView(),
           'user' => $user,
           'roleuser' => $roleuser,
           'entreprise' => $entreprise,
           'clientassurance' => $clientassurance,
           'grille' => $grille,
           'id' => $locata->getClientid(),
           'date' => date('Y-m-d'),
           'locaid' => $locataid,
           'locid' => $locataid,
           'locatafrs' => $locatafrs,
           'documents' => $documents,
           'moisdevis' => $moisdevis,
           'anneedevis' => $anneedevis,
           'contrat' => $locata->getContrat(),
           'clientid' => $locata->getClientid(),
           'montantcarb' => 0,
           'typeplanning' => 'planning',
           'detail' => 'OUI'
    ));
    }

    public function locationsmodalecomokslAction($locataid, Request $request)
    {
        //exit('laaarr');
        $user = $this->get('security.context')->getToken()->getUsername(); if(empty($user) or !isset($user) or $user == 'anon.'){return $this->redirect($this->generateUrl('fos_user_security_login'));}
        $em = $this->getDoctrine()->getManager();

        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($user);
        $today = date('Y-m-d');

        if(!isset($locataid) or empty($locataid))
        {
            $locataid = $request->get('eventResourceId');
        }

//         die($locataid);

        $locata = $em->getRepository('BaclooCrmBundle:Locata')
        ->findOneById($locataid);//echo 'locataid'.$locata->getClientid();
       // $locata->setContrat();
        $locata->setUser($user);

        //$bdcrecu = $venda->getBdcrecu();

        $form = $this->createForm(new LocataType(), $locata);
        $request = $this->get('request');

        if ($request->getMethod() == 'POST')
        {
             //initialisatiion de la variable qui vas contenier l'id de la locations
                $idlocation = 0;
                $debut = 0;
                $fin =0;
                $idloc = 0;
                $code = "ras"; //code machine
            $form->bind($request);

            if($form->isValid()){
                $em->flush();

            //gestion des sous locations
            foreach($locata->getLocationssl() as $loc){
                $idlocation = $loc->getId();
                $code = $loc->getCodemachineinterne();
                $debut = $loc->getDebutloc();
                $fin = $loc->getFinloc();
            }
            // die($code);
            //gérer la fiche cleint
            //on vérifie d'abord si il existe
                if(null === $form->get('client')->getData())
                {
                    $client = $em->getRepository('BaclooCrmBundle:Fiche')
                        ->findOneByRaisonSociale($form->get('client')->getData());
                }
                else
                {
                    $client = $em->getRepository('BaclooCrmBundle:Fiche')
                        ->findOneByRaisonSociale($locata->getClient());
                }
            if(isset($client)){
                $locata->setClient($client->getRaisonSociale());
                $locata->setClientid($client->getId());
                //ajouter les adresse
                $locata->setAdresse1($form->get('adresse1')->getData());
                $locata->setAdresse2($form->get('adresse2')->getData());
                $locata->setAdresse3($form->get('adresse3')->getData());
                $locata->setCp($form->get('cp')->getData());
                $locata->setVille($form->get('ville')->getData());
            }
            else{

                $client = new Fiche;
                $client->setRaisonSociale($form->get('client')->getData());
                $client->setAdresse1($form->get('adresse1')->getData());
                $client->setAdresse2($form->get('adresse2')->getData());
                $client->setAdresse3($form->get('adresse3')->getData());
                $client->setCp($form->get('cp')->getData());
                $client->setVille($form->get('ville')->getData());
                $em->persist($client);
                $em->flush();
                $locata->setClientid($client->getId());
                $locata->setClient($form->get('client')->getData());
                 //ajouter les adresse
                 $locata->setAdresse1($form->get('adresse1')->getData());
                 $locata->setAdresse2($form->get('adresse2')->getData());
                 $locata->setAdresse3($form->get('adresse3')->getData());
                 $locata->setCp($form->get('cp')->getData());
                 $locata->setVille($form->get('ville')->getData());
            }

            //on vérifie égalementsi le chantier existe
            $chantier = $em->getRepository('BaclooCrmBundle:Chantier')
            ->findOneByNom($form->get('nomchantier')->getData());
            if(isset($chantier)){

                $locata->setChantierid($chantier->getId());
                $locata->setNomchantier($chantier->getNom());
            }
            else{

                $chantier = new Chantier;
                $chantier->setNom($form->get('nomchantier')->getData());
                $chantier->setAdresse1($form->get('adresse1')->getData());
                $chantier->setAdresse2($form->get('adresse2')->getData());
                $chantier->setAdresse3($form->get('adresse3')->getData());
                $chantier->setCp($form->get('cp')->getData());
                $chantier->setVille($form->get('ville')->getData());
                $em->persist($chantier);
                $em->flush();
                $locata->setChantierid($chantier->getId());
                $locata->setNomchantier($chantier->getNom());
            }
            //persister la location corespondante a locata
            $machine = $em->getRepository('BaclooCrmBundle:Machinessl')
                ->findOneByCode($code);
            $location = $em->getRepository('BaclooCrmBundle:Locationssl')->findOneById($idlocation);
            $location->setCodeclient($client->getId());
            $location->setEntreprise($form->get('client')->getData());
            $location->setMachineid($machine->getId());
            $location->setCodemachine($machine->getcodegenerique());
            $location->setCodemachineinterne($machine->getCode());
            $location->setTypemachine($machine->getDescription());
            $location->setContributionverte(TRUE);
        }

        // $locata->addLocation($location);
        $em->persist($locata);
        $em->flush();
        $mode ="machines";

        return $this->redirect($this->generateUrl('bacloocrm_planning', array('mode' => $mode)));
    }

        // var_dump($a);
        // die();

       // var_dump($nomclient, $numbdc, $nomchantier, $adresse1,  $cp, $ville);
    //    die($locataid);
    // var_dump($locata->getClientid());
   // die();
        $userdetails  = $em->getRepository('BaclooUserBundle:User')
            ->findOneByUsername($user);
        $roleuser = $userdetails->getRoleuser();
        if($locata->getClient() == 'Raison sociale')
        {
            $entreprise = 'Raison sociale';
            $client = 0;
            $clientassurance = 0;
        }
        else
        {//echo 'icicicii'.$locata->getClientid();
            $entreprise = $locata->getClient();
            $client  = $em->getRepository('BaclooCrmBundle:Fiche')
                ->findOneById($locata->getClientid());
            $clientassurance = $client->getAssurance();
        }

        $grille  = $em->getRepository('BaclooCrmBundle:Grille')
            ->findByCodeclient($locata->getClientid());

        $locatafrs = $em->getRepository('BaclooCrmBundle:Locatafrs')
            ->findByCodelocatasl($locataid);

        $documents  = $em->getRepository('BaclooCrmBundle:Document')
            ->findBy(array('codecontrat' => $locataid, 'type' => 'contrat'));

       return $this->render('BaclooCrmBundle:Crm:nouvelle_locationmodaleok.html.twig', array(
           'form' => $form->createView(),
           'user' => $user,
           'roleuser' => $roleuser,
           'entreprise' => $entreprise,
           'clientassurance' => $clientassurance,
           'grille' => $grille,
           'id' => $locata->getClientid(),
           'date' => date('Y-m-d'),
           'locaid' => $locataid,
           'locid' => $locataid,
           'locatafrs' => $locatafrs,
           'documents' => $documents,
           'contrat' => $locata->getContrat(),
           'clientid' => $locata->getClientid(),
           'montantcarb' => 0,
           'typeplanning' => 'planningsl',
           'detail' => 'OUI'
    ));
    }

//eventRisize && enventDrop
    public function updatecomAction(Request $request){
    $em = $this->getDoctrine()->getManager();
    // Récupérer le contenu de la requête POST (JSON)
    $content = $request->getContent();

    // Décoder la chaîne JSON pour obtenir un tableau associatif
    $data = json_decode($content, true);

    // Récupérer la valeur de la variable locataid
    $locataid = $data['locataid'];
//    $locataid = 163;
    $newid = $data['newId'];//Nouvel ecode
    $codemachine = 'Ras';
    $codemachineserve = 'Ras';
    if($newid == "NON"){
        $codemachine = $data['codeinterne'];//Ancien ecode
        $codemachineserve = $codemachine;
    }
    else{
        $codemachine = $data['newId'];
        $codemachineserve = $data['codeinterne'];
    }

    $debut = $data['debutloc'];
    $fin = $data['finloc'];
//    $fin = '2023-04-24';echo 'fin111'.$fin;
//    $finloc = date('Y-m-d', strtotime($fin . ' -1 day'));
//    echo 'fin'.$fin;exit();
//    die('fin'.$fin);

    $locata = $em->getRepository('BaclooCrmBundle:Locata')
    ->findOneById($locataid);
    $idlocation = 0;
    $etatloc = "RAS";
    foreach($locata->getLocations() as $location){
        if($location->getCodemachineinterne() == $codemachine){
            $idlocation = $location->getId();
            $etatloc = $location->getEtatloc();
        } 
    }


    $locations = $em->getRepository('BaclooCrmBundle:Locations')
    ->findOneById($idlocation);
  
    //On récupère les infos de l'ancienne pour la libérer
    $anciennemachine =  $em->getRepository('BaclooCrmBundle:Machines')
    ->findOneByCode($codemachineserve);
  
    //On récupère les infos de la nouvelle machine pour la mettre à jour
    $machine =  $em->getRepository('BaclooCrmBundle:Machines')
    ->findOneByCode($codemachineserve);

    //On hydrate la nouvelle machine
        $machine->setEtat('Disponible');
        $machine->setDebutloc($debut);
        $machine->setFinloc($fin);
//        $machine->setFinloc(date('Y-m-d', strtotime($fin . ' -1 day')));
        $machine->setEntreprise($anciennemachine->getEntreprise());
        $machine->setNomchantier($anciennemachine->getNomchantier());
        $machine->setcodelocations($anciennemachine->getCodelocations());
        $machine->setcodecontrat($anciennemachine->getCodecontrat());
        $machine->setClientid($anciennemachine->getClientid());
        $em->persist($machine);

    //On libère l'ancienne machine en la rendant disponible
        $anciennemachine->setEtat('Disponible');
        $anciennemachine->setDebutloc('');
        $anciennemachine->setFinloc('');
        $anciennemachine->setEntreprise('');
        $anciennemachine->setNomchantier('');
        $anciennemachine->setcodelocations('');
        $anciennemachine->setcodecontrat('');
        $anciennemachine->setClientid(0);
        $em->persist($anciennemachine);
    
//    if($etatloc == "Location terminée"){
//        $etatloc = "Location terminée";
//    }
//    elseif($etatloc == "En location"){
//        $etatloc = "En location";
//    }
//    else{
        $locations->setDebutloc($debut);
        $locations->setFinloc($fin);
        $locations->setCodemachineinterne($codemachineserve);
        $locations->setCodemachine($machine->getCodegenerique());
        $locations->setMachineid($machine->getId());
//    }
    $etatloc = $locations->getEtatloc();
    $em->persist($locations);
    $em->flush();

    // Retourner la valeur de locataid sous forme de JSON
    $response = new Response(json_encode(
        [
            'locataid' => $locata->getId(),
            'codeinterne' => $codemachine,
            'debutloc' => $debut,
//            'finloc' => $fin,
            'finloc' => date('Y-m-d', strtotime($fin . ' -1 day')),
            'locationId' => $locations->getId(),
            'etatloc' => $etatloc
        ]
    ));
  //  $response->headers->set('Content-Type', 'application/json');
    return $response;
    }

//eventRisize && enventDrop
    public function updatecomslAction(Request $request){
    $em = $this->getDoctrine()->getManager();
    // Récupérer le contenu de la requête POST (JSON)
    $content = $request->getContent();

    // Décoder la chaîne JSON pour obtenir un tableau associatif
    $data = json_decode($content, true);

    // Récupérer la valeur de la variable locataid
    $locataid = $data['locataid'];
//    $locataid = 163;
    $newid = $data['newId'];//Nouvel ecode
    $codemachine = 'Ras';
    $codemachineserve = 'Ras';
    if($newid == "NON"){
        $codemachine = $data['codeinterne'];//Ancien ecode
        $codemachineserve = $codemachine;
    }
    else{
        $codemachine = $data['newId'];
        $codemachineserve = $data['codeinterne'];
    }

    $debut = $data['debutloc'];
    $fin = $data['finloc'];
//    $fin = '2023-04-24';echo 'fin111'.$fin;
//    $fin = date('Y-m-d', strtotime($fin . ' -1 day'));
//    echo 'fin'.$fin;exit();
//    die('fin'.$fin);

    $locata = $em->getRepository('BaclooCrmBundle:Locata')
    ->findOneById($locataid);
    $idlocation = 0;
    $etatloc = "RAS";
    foreach($locata->getLocationssl() as $location){
        if($location->getCodemachineinterne() == $codemachine){
            $idlocation = $location->getId();
            $etatloc = $location->getEtatloc();
        }
    }


    $locations = $em->getRepository('BaclooCrmBundle:Locationssl')
    ->findOneById($idlocation);

    //On récupère les infos de l'ancienne pour la libérer
    $anciennemachine =  $em->getRepository('BaclooCrmBundle:Machinessl')
    ->findOneByCode($codemachineserve);

    //On récupère les infos de la nouvelle machine pour la mettre à jour
    $machine =  $em->getRepository('BaclooCrmBundle:Machinessl')
    ->findOneByCode($codemachineserve);

    //On hydrate la nouvelle machine
        $machine->setEtat('Disponible');
        $machine->setDebutloc($debut);
        $machine->setFinloc($fin);
//        $machine->setFinloc(date('Y-m-d', strtotime($fin . ' -1 day')));
        $machine->setEntreprise($anciennemachine->getEntreprise());
        $machine->setNomchantier($anciennemachine->getNomchantier());
        $machine->setcodelocations($anciennemachine->getCodelocations());
        $machine->setcodecontrat($anciennemachine->getCodecontrat());
        $machine->setClientid($anciennemachine->getClientid());
        $em->persist($machine);

    //On libère l'ancienne machine en la rendant disponible
        $anciennemachine->setEtat('Disponible');
        $anciennemachine->setDebutloc('');
        $anciennemachine->setFinloc('');
        $anciennemachine->setEntreprise('');
        $anciennemachine->setNomchantier('');
        $anciennemachine->setcodelocations('');
        $anciennemachine->setcodecontrat('');
        $anciennemachine->setClientid(0);
        $em->persist($anciennemachine);

//    if($etatloc == "Location terminée"){
//        $etatloc = "Location terminée";
//    }
//    elseif($etatloc == "En location"){
//        $etatloc = "En location";
//    }
//    else{
        $locations->setDebutloc($debut);
        $locations->setFinloc($fin);
        $locations->setCodemachineinterne($codemachineserve);
        $locations->setCodemachine($machine->getCodegenerique());
        $locations->setMachineid($machine->getId());
//    }
    $etatloc = $locations->getEtatloc();
    $em->persist($locations);
    $em->flush();
//exit();
    // Retourner la valeur de locataid sous forme de JSON
    $response = new Response(json_encode(
        [
            'locataid' => $locata->getId(),
            'codeinterne' => $codemachine,
            'debutloc' => $debut,
//            'finloc' => $fin,
            'finloc' => date('Y-m-d', strtotime($fin . ' -1 day')),
            'locationId' => $locations->getId(),
            'etatloc' => $etatloc
        ]
    ));
  //  $response->headers->set('Content-Type', 'application/json');
    return $response;
//        return $this->redirect($this->generateUrl('bacloocrm_planningsl'));
    }

}