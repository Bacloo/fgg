<?php
use Bacloo\CrmBundle\Entity\Factures;
use Bacloo\CrmBundle\Entity\Afacturer;

	foreach($locatafrs->getLocationsfrs() as $loca)
	{
		//Création du montant HT de la ligne
		if(null == $loca->getQuantite())
		{
			$quantite = 1;
		}
		else
		{
			$quantite = $loca->getQuantite();
		}echo 'speee'.$loca->getSpeedachat() ;
		if($loca->getSpeedachat() == 1)
        {
            $montantligne = $loca->getMontantht();
            $totalht += $montantligne;
        }
		else
        {
            $montantligne = $loca->getPu() * $quantite;
            $totalht += $montantligne;

        }
		$client = $em->getRepository('BaclooCrmBundle:Fiche')
					->findOneById($locatafrs->getFournisseurid());					
		//On affecte chaque ligne à sa famille
		if($loca->getReference() == 'assurance')
		{
			$assurancelignes += $montantligne;
			$descriptionlocation[] = $loca->getDesignation();
		}
		elseif($loca->getReference() == 'piece')
		{
			$piecelignes += $montantligne;
			$descriptionpiece[] = $loca->getDesignation();
		}
		elseif($loca->getReference() == 'transport')
		{
			$transportlignes += $montantligne;
			$descriptiontransport[] = $loca->getDesignation();
		}
		elseif($loca->getReference() == 'materiel')
		{
			$materiellignes += $montantligne;
			$descriptionmateriel[] = $loca->getDesignation();
		}
		elseif($loca->getReference() == 'autre')
		{
			$autrelignes += $montantligne;
			$descriptionautre[] = $loca->getDesignation();
		}
		elseif($loca->getReference() == 'prestation')
		{
			$prestationlignes += $montantligne;
            $descriptionpresta[] = $loca->getDesignation();
		}
        $loca->setCloture(1);
    }
		//Fin affectation ligne à sa famille
//echo '>>>'.$montantligne;exit();
		$loca->setMontantht($montantligne);
		$em->persist($loca);
		$montantloc = $montantligne;
		$transportbdc = $transportlignes;
		$assurance = $assurancelignes;
		$totalhtfac = $totalht;
//		$totalhtfac = $montantloc + $transportbdc + $assurance;
		$totalttc = $totalhtfac*1.2;
		$contributionverte = 0;

	
	//Ajout à la table factures

//		$facture = new Factures;
//
//		$query = $em->createQuery(
//			'SELECT b.compteurfac
//			FROM BaclooCrmBundle:Factures b
//			WHERE b.typedoc = :typedoc or b.typedoc = :typedoc2
//			ORDER BY b.id DESC'
//		)->setMaxResults(1);
//		$query->setParameter('typedoc', 'facture frs');
//		$query->setParameter('typedoc2', 'avoir frs');
//		$lastnumfact = $query->getOneOrNullResult();
//		if(empty($lastnumfact) or !isset($lastnumfact) or $lastnumfact == null)
//		{
//			$lastnumfact = 0;//echo 'vide';
//		}
//		else
//		{
//			$lastnumfact = $query->getSingleScalarResult();//echo 'pas vide';
//		}
//		$numfacture = date('Y').'H'.($lastnumfact++);
//
//		$client = $em->getRepository('BaclooCrmBundle:Fiche')
//		 ->findOneById($locatafrs->getFournisseurid());
//
//        $today = date('Y-m-d');
//		if($client->getDelaireglement() == 1)
//		{
//			$next45 = $today;
//		}
//		elseif($client->getDelaireglement() == 2)
//		{
//			$next45 = date('Y-m-d', strtotime($today . '+45 days'));
//		}
//		elseif($client->getDelaireglement() == 3)
//		{
//			$next45 = date('Y-m-d', strtotime($today . '+30 days'));
//		}
//		else
//		{
//			$next45 = $today;
//		}
//		if(isset($locatafrs)){$id = $locatafrs->getId();}else{$id = 0;}
//		$facture->setNumfacture($numfacture);
//		$facture->setCodelocata('H-'.$locatafrs->getId());
//		$facture->setClientid($locatafrs->getFournisseurid());
//		$facture->setClient($locatafrs->getFournisseur());
//		$facture->setTotalht($totalht);
//		$facture->setTotalttc($totalttc);
//		$facture->setEcheance($next45);
//		$facture->setChantier($locatafrs->getFournisseur());
//		$facture->setReglement(0);
//		$facture->setDatepaiement('');
//		$facture->setModepaiement('');
//		$facture->setTypedoc('facture frs');
//		$facture->setLocatacloneid($id);
//        $facture->setDatecrea($locatafrs->getDatemodif());
//        $facture->setEcheance($next45);
//		$facture->setCompteurfac($lastnumfact);
//		$facture->setUser($locatafrs->getUser());
//        $facture->setAchatsimple(1);
		// $facture->addFactum($facta);
//		$facta->addFacture($facture);
//		$em->persist($facture);
		$em->flush();
		
		$comptefrs = '401'.$locatafrs->getFournisseurid();
		
//		$totalhtfac = $montantloc + $transportbdc + $contributionverte + $assurance;
//		$tva20 = $totalhtfac * 0.20;
//		$totalttc = $totalhtfac + $tva20;//echo 'totalhtfac'.$totalhtfac;
	
		//Avant de saisir les écritures on vérifie qu'elle n'aient pas déjà été saisies
		$journalori = $em->getRepository('BaclooCrmBundle:Factures')
						->findOneBy(array('clientid'=>$locatafrs->getFournisseurid(), 'codelocata'=>'H-'.$locatafrs->getId()));

		$ii = 0;
		if(isset($journalori))//Si le bdc a deja été cloner on regarde si les locations du mois l'ont été
		{//echo 'ori set';
			// foreach($journalori as $loco)//PAS DE FOREACH ICI CAR ON EST SUR UN OBKET
			// {echo 'BBBBBBBB';
				$time=strtotime($journalori->getDatecrea());
				$moisclone=date("F",$time);
				$anneeclone=date("Y",$time);
//echo '$moiscourant'.$moiscourant;echo ' vs $moisclone'.$moisclone;						
				$moiscourant=date("F");
				$anneecourante=date("Y");
				if($moisclone == $moiscourant && $anneeclone == $anneecourante)
				{
					$ii++;//existe deja
				}
			// }		
		}
		else
		{//echo 'ori pas set';
			$ii = 0;
		}
        echo '$comptefrs'.$locatafrs->getFournisseurid(); echo 'codelocata'.'H-'.$locatafrs->getId();  	echo 'ii'.$ii;

        $query = $em->createQuery(
            'SELECT b.compteurfac
                    FROM BaclooCrmBundle:Factures b
                    WHERE b.typedoc = :typedoc or b.typedoc = :typedoc2
                    ORDER BY b.id DESC'
        )->setMaxResults(1);
        $query->setParameter('typedoc', 'facture frs');
        $query->setParameter('typedoc2', 'avoir frs');
        $lastnumfact = $query->getOneOrNullResult();
        if(empty($lastnumfact) or !isset($lastnumfact) or $lastnumfact == null)
        {
            $lastnumfact = 0;//echo 'vide';
        }
        else
        {
            $lastnumfact = $query->getSingleScalarResult();//echo 'pas vide';
        }
        $numfacture = date('Y').'H'.($lastnumfact++);
		
		if($ii == 0)
		{//echo '?????';							

        //Ajout à la table factures
//					$facta = $em->getRepository('BaclooCrmBundle:Facta')
//								->findOneByControle('1234');
            $facture = new Factures;

            $client = $em->getRepository('BaclooCrmBundle:Fiche')
             ->findOneById($locatafrs->getFournisseurid());
            if($client->getDelaireglement() == 1)
            {
                $next45 = $today;
            }
            elseif($client->getDelaireglement() == 2)
            {
                $next45 = date('Y-m-d', strtotime($today . '+45 days'));
            }
            elseif($client->getDelaireglement() == 3)
            {
                $next45 = date('Y-m-d', strtotime($today . '+30 days'));
            }
            else
            {
                $next45 = $today;
            }

            $client = $em->getRepository('BaclooCrmBundle:Fiche')
                ->findOneById($locatafrs->getFournisseurid());

            //On regarde si ce fournisseur fait des factures groupées
            $facgroupees = $client->getFacturesgroupees();
            if($facgroupees == 1)
            {
                //On regarde si des factures du même fournisseur et du même mois sont disponibles
                $query = $em->createQuery(
                    'SELECT f
				FROM BaclooCrmBundle:Factures f
				WHERE YEARMONTH(f.datecrea) = :datefac
				AND f.client = :client'
                );
                $query->setParameter('datefac', date("Ym"));
                $query->setParameter('client', $client->getRaisonsociale());
                $codegroupe = $query->getResult();
                if (empty($codegroupe) or !isset($codegroupe) or $codegroupe == null) {
                    $codegroupe = 0;//echo 'vide';
                }
                else
                {
                    foreach($codegroupe as $codeg)
                    {
                        $codegroupe = $codeg->getCodegroupe();//echo 'pas vide';
                    }
                }

                //Si oui on récupere le code groupe pour l'affecter
                if(isset($codegroupe) && $codegroupe > 0)
                {
                    $facture->setCodegroupe($codegroupe);
                }
                else//Si non on prend lecode groupe dispo et l'affecte à notre facture
                {
                    $query = $em->createQuery(
                        'SELECT u.codegroupe
                FROM BaclooCrmBundle:Factures u
                WHERE u.codegroupe >= :codegroupe
                ORDER BY u.codegroupe DESC'
                    )->setParameter('codegroupe', 0)
                        ->setMaxResults(1);
                    $codeg = $query->getSingleScalarResult();
                    // echo 'nextcode'.$codeg;
                    $nextcodegroupe = $codeg + 1;//echo 'cggg'.$nextcodegroupe;exit();
                    $facture->setCodegroupe($nextcodegroupe);
                    $facture->setTtcgroupe($facture->getCodegroupe() + $totalttc);
                }
            }
                    if(isset($locatafrs)){$id = $locatafrs->getId();}else{$id = 0;}
                    $facture->setNumfacture($numfacture);;
					$facture->setCodelocata('H-'.$locatafrs->getId());
					$facture->setClientid($locatafrs->getFournisseurid());
					$facture->setClient($locatafrs->getFournisseur());
					$facture->setTotalht($totalhtfac);
					$facture->setTotalttc($totalttc);
					$facture->setEcheance($next45);
					$facture->setChantier($locatafrs->getFournisseur());
					$facture->setReglement(0);
					$facture->setEncompta(0);
					$facture->setDatepaiement('');
					$facture->setModepaiement('');
					$facture->setTypedoc('facture frs');
					$facture->setLocatacloneid($id);
                    $facture->setDatecrea($locatafrs->getDatemodif());
                    $facture->setEcheance($next45);
                    $facture->setAchatsimple(1);
                     $facture->setUser($locatafrs->getUser());
					// $facture->addFactum($facta);
//					$facta->addFacture($facture);
					$em->persist($facture);
					$em->flush();
				//Fin ajout table factures					
		}
						