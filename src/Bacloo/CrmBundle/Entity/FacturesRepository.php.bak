<?php

namespace Bacloo\CrmBundle\Entity;
use DoctrineExtensions\Query\Mysql\Month;

use Doctrine\ORM\EntityRepository;
use Doctrine\ORM\Tools\Pagination\Paginator;

/**
 * FacturesRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class FacturesRepository extends \Doctrine\ORM\EntityRepository
{
	public function facturesmois($codecontrat)
	{
		$qb = $this->createQueryBuilder('f');
		// $qb->where('c.etatloc = :etatloc and s.etatloc = :etatloc')	
		$qb->where('f.codelocata = :codelocata')	
		->setParameter('codelocata', $codecontrat)		
		->groupBy('f.id');					
		return $qb->getQuery()->getScalarResult();
	}
	
    public function last12mca($dStart, $dEnd)
    {
		$qb = $this->createQueryBuilder('c');
        $qb->select('SUM(c.totalht) as careal, c.user, c.totalht, YEARMONTH(c.datepaiement) as datepaiement'); 
        $qb->where('c.reglement = :reglement')
              ->setParameter('reglement', 1)
		   ->andWhere('YEARMONTH(c.datepaiement) <= :today')
		   ->setParameter('today', date('Ym',strtotime($dEnd)))
            ->andWhere('c.encompta = :encompta')
            ->setParameter('encompta', 1)
		   ->groupBy('c.user')
		   ->addgroupBy('datepaiement')
		   ->orderBy('datepaiement');
                 
        return $qb->getQuery()->getArrayResult();
    }
	
    public function last12mca3($dStart, $dEnd)//Pour calculer le CA du mois
    {
		$qb = $this->createQueryBuilder('c');
        $qb->select('SUM(c.totalht) as careal, c.user, c.totalht, c.typedoc, YEARMONTH(c.datecrea) as datecrea'); 
        $qb->where('YEARMONTH(c.datecrea) <= :today')
		   ->setParameter('today', date('Ym',strtotime($dEnd)))
		   ->andWhere('YEARMONTH(c.datecrea) >= :dtsart')
		   ->setParameter('dtsart', date('Ym',strtotime($dStart)))
		   ->andWhere('c.typedoc = :typedoc')
		   ->setParameter('typedoc', 'facture')
            ->andWhere('c.encompta = :encompta')
            ->setParameter('encompta', 1)
		   ->groupBy('datecrea')
		   ->orderBy('datecrea');
                 
        return $qb->getQuery()->getArrayResult();
    }
	
    public function last12mca3commerciaux($dStart, $dEnd)//Pour calculer le CA du mois par commerciaux
    {
		$qb = $this->createQueryBuilder('c');
        $qb->select('c.totalht as careal, c.user, c.client, c.totalht, YEARMONTH(c.datecrea) as datecrea'); 
        $qb->where('YEARMONTH(c.datecrea) <= :today')
		   ->setParameter('today', date('Ym',strtotime($dEnd)))
		   ->andWhere('YEARMONTH(c.datecrea) >= :dtsart')
		   ->setParameter('dtsart', date('Ym',strtotime($dStart)))
		   ->andWhere('c.typedoc = :typedoc')
		   ->setParameter('typedoc', 'facture')
            ->andWhere('c.encompta = :encompta')
            ->setParameter('encompta', 1)
		   ->orderBy('datecrea');
                 
        return $qb->getQuery()->getArrayResult();
    }
	
    public function last12mca2($dStart, $dEnd)
    {
		$qb = $this->createQueryBuilder('c');
        $qb->select('SUM(c.totalht) as careal, c.user, c.totalht, c.typedoc, YEARMONTH(c.datecrea) as datecrea'); 
        $qb->where('c.reglement = :reglement')
              ->setParameter('reglement', 1)
		   ->andWhere('YEARMONTH(c.datecrea) <= :today')
		   ->setParameter('today', date('Ym',strtotime($dEnd)))
		   ->andWhere('YEARMONTH(c.datecrea) >= :dtsart')
		   ->setParameter('dtsart', date('Ym',strtotime($dStart)))
		   ->andWhere('c.typedoc = :typedoc')
		   ->setParameter('typedoc', 'facture')
            ->andWhere('c.encompta = :encompta')
            ->setParameter('encompta', 1)
		   // ->andWhere('c.client = :client')
		   // ->setParameter('client', 'GREENCABLE')
		   ->groupBy('datecrea')
		   ->orderBy('datecrea');
                 
        return $qb->getQuery()->getArrayResult();
    }
	
    public function last12mcanr2($dStart, $dEnd)
    {
		$qb = $this->createQueryBuilder('c');
        $qb->select('SUM(c.totalht) as careal, c.user, c.totalht, c.typedoc, YEARMONTH(c.datecrea) as datecrea'); 
        $qb->where('c.reglement = :reglement')
              ->setParameter('reglement', 0) 
           ->andWhere('YEARMONTH(c.datecrea) <= :today')
		   ->setParameter('today', date('Ym',strtotime($dEnd)))
		   ->andWhere('c.typedoc = :typedoc')
		   ->setParameter('typedoc', 'facture')
            ->andWhere('c.encompta = :encompta')
            ->setParameter('encompta', 1)
		   // ->andWhere('c.client = :client')
		   // ->setParameter('client', 'GREENCABLE')
		   ->groupBy('datecrea')
		   ->orderBy('datecrea');
                 
        return $qb->getQuery()->getArrayResult();
    }
	
    public function last12mcatf($dStart, $dEnd)
    {
		$qb = $this->createQueryBuilder('c');
        $qb->select('SUM(c.totalht) as careal, c.user, c.totalht, c.typedoc, YEARMONTH(c.datecrea) as datecrea'); 
        $qb->where('YEARMONTH(c.datecrea) <= :today')
		   ->setParameter('today', date('Ym',strtotime($dEnd)))
		   ->andWhere('YEARMONTH(c.datecrea) >= :dtsart')
		   ->setParameter('dtsart', date('Ym',strtotime($dStart)))
		   ->andWhere('c.typedoc = :typedoc')
		   ->setParameter('typedoc', 'facture')
            ->andWhere('c.encompta = :encompta')
            ->setParameter('encompta', 1)
		   ->groupBy('datecrea')
		   ->orderBy('datecrea');
                 
        return $qb->getQuery()->getArrayResult();
    }
	
    public function last12mavoirs($dStart, $dEnd)
    {
		$qb = $this->createQueryBuilder('c');
        $qb->select('SUM(c.totalht) as careal, c.user, c.totalht, c.typedoc, YEARMONTH(c.datecrea) as datecrea'); 
        $qb->where('YEARMONTH(c.datecrea) <= :today')
		   ->setParameter('today', date('Ym',strtotime($dEnd)))
            ->andWhere('YEARMONTH(c.datecrea) >= :dstart')
		   ->setParameter('dstart', date('Ym',strtotime($dStart)))
		   ->andWhere('c.typedoc = :typedoc')
		   ->setParameter('typedoc', 'avoir')
		   ->groupBy('datecrea')
		   ->orderBy('datecrea');
                 
        return $qb->getQuery()->getArrayResult();
    }
	
    public function avoirsclients($dStart, $dEnd, $search, $client)
    {
		if($search == 0)
		{//echo 'ici';			
			$qb = $this->createQueryBuilder('c');
			$qb->select('c.totalht, YEARMONTH(c.datecrea) as datecrea, c.client'); 
			$qb->where('YEARMONTH(c.datecrea) <= :today')
			   ->setParameter('today', date('Ym',strtotime($dEnd)))
			   ->andWhere('c.typedoc = :typedoc')
			   ->setParameter('typedoc', 'avoir')
			   ->groupBy('c.client')
			   ->orderBy('datecrea');
        }
		else
		{			
			$qb = $this->createQueryBuilder('c');
			$qb->select('c.totalht as careal, YEARMONTH(c.datecrea) as datecrea');  
			$qb->where('YEARMONTH(c.datecrea) <= :today')
			   ->setParameter('today', date('Ym',strtotime($dEnd)))
			   ->andWhere('c.typedoc = :typedoc')
			   ->setParameter('typedoc', 'avoir');
				if($client != 0)
				{
					$qb->andWhere('(a.client) = :client')
					->setParameter('client', $client);
				}
				$qb->groupBy('c.client')
			    ->orderBy('datecrea');			
		}
        return $qb->getQuery()->getArrayResult();
    }
	
	public function listefactures($vue, $mode, $numfacture, $client, $totalttc, $ttcgroupe, $modepaiement, $nombreParPage, $page, $daterech, $dejareg, $codecontrat, $numbdcloueur, $loueur, $datereprise)
	{
        $today = date('Y-m-d');
		// On déplace la vérification du numéro de page dans cette méthode
		if ($page < 1) {

		}//echo 'page'.$page;	
		// On utilise le QueryBuilder créé par le repository directement pour gagner du temps
		// Plus besoin de faire le select() ni le from() par la suite donc
		if($mode != 'search')
		{//echo 'pas search';
			$qb = $this->createQueryBuilder('a');
			if($vue == 'achats')
			{
                $qb->where('a.numfacfrs is null or (a.reglement = :reglement or a.encompta = :encompta or a.encompta is null)');
                $qb->setParameter('reglement', 0)
				->setParameter('encompta', 0);
				$qb->andWhere('a.typedoc = :bdc or a.typedoc = :avoirfrs')
				->setParameter('bdc', 'facture frs')
				->setParameter('avoirfrs', 'avoir frs')
                    ->andwhere('YEARMONTH(a.echeance) <= :daterelance')
                    ->setParameter('daterelance', date('Ym',strtotime($today)));
				$qb->orderBy('a.datecrea', 'DESC');
			}
			else
			{
                $qb->where('a.reglement = :reglement')
                ->setParameter('reglement', 0);
				$qb->andWhere('a.typedoc = :bdc or a.typedoc = :avoirfrs')
                    ->setParameter('bdc', 'facture')
                    ->setParameter('avoirfrs', 'avoir');
                $qb->orderBy('a.compteurfac', 'DESC');
			}
			$qb->getQuery();	
		}
		else
		{
			$qb = $this->createQueryBuilder('a')
			->where('a.id > :id')
			->setParameter('id', 0);
			if($numfacture !== '0' and $numfacture != 0)
			{//echo 'numfacture'.$numfacture;
				if($vue == 'achats')
				{
					$qb->andWhere('a.numfacfrs LIKE :numfacfrs')
					->setParameter('numfacfrs', '%'.$numfacture.'%');
				}
				else
				{
					$qb->andWhere('a.numfacture LIKE :numfacture')
					->setParameter('numfacture', '%'.$numfacture.'%');
				}
			}
			if($client !== 0)
			{//echo 'client'.$client;
				$qb->andWhere('a.client LIKE :client')
				->setParameter('client', '%'.$client.'%');
			}
			if($totalttc != 0)
			{//echo 'totalttc'.$totalttc;
				$qb->andWhere('a.totalttc = :totalttc')
				->setParameter('totalttc', $totalttc);
			}
			if($ttcgroupe != 0)
			{//echo 'ttcgroupe'.$ttcgroupe;
				$qb->andWhere('a.ttcgroupe = :ttcgroupe')
				->setParameter('ttcgroupe', $ttcgroupe);
			}
			if($modepaiement != '0' and $modepaiement !== 'vide')
			{//echo 'modepaiement'.$modepaiement;
				$qb->andWhere('a.modepaiement = :modepaiement')
				->setParameter('modepaiement', $modepaiement);
			}
			if($daterech != 0 and $daterech != 'vide' and !isset($daterech))
			{//echo 'daterechrepo'.$daterech;
				$qb->andWhere('a.datepaiement = :datepaiement')
				->setParameter('datepaiement', $daterech);
			}
			if($dejareg != 0 or $dejareg != 'vide')
			{//echo 'gogo'.$dejareg;
				$qb->andWhere('a.montantdejareg = :montantdejareg')
				->setParameter('montantdejareg', $dejareg);
			}
            if($codecontrat != '0' and $codecontrat != 'vide')
            {//echo '$codecontrat'.$codecontrat;
                $qb->andWhere('a.codelocata = :codelocata')
                    ->setParameter('codelocata', $codecontrat);
            }
            if($numbdcloueur != '0' and $numbdcloueur != 'vide')
            {//echo '$numbdcloueur'.$numbdcloueur;
                $qb->andWhere('a.numbdcloueur = :numbdcloueur')
                    ->setParameter('numbdcloueur', $numbdcloueur);
            }
            if($datereprise != '0' and $datereprise != '')
            {//echo '$datereprise'.$datereprise;
                $qb->andWhere('a.datereprise = :datereprise')
                    ->setParameter('datereprise', $datereprise);
            }
            if($loueur != '0' and $loueur != 'vide')
            {//echo '$loueur'.$loueur;
                $qb->andWhere('a.loueur LIKE :loueur')
                    ->setParameter('loueur', '%'.$loueur.'%');
            }
            if($vue == 'achats') {
                $qb->andWhere('a.typedoc = :bdc or a.typedoc = :avoirfrs')
                    ->setParameter('bdc', 'facture frs')
                    ->setParameter('avoirfrs', 'avoir frs')
                    ->orderBy('a.datecrea', 'DESC');
            }
            else
            {
                $qb->andWhere('a.typedoc = :bdc or a.typedoc = :avoirfrs')
                    ->setParameter('bdc', 'facture')
                    ->setParameter('avoirfrs', 'avoir');
                $qb->orderBy('a.compteurfac', 'DESC');
            }
			$qb->getQuery();
//            $page = 1;
		}

		// On définit l'article à partir duquel commencer la liste
		$qb->setFirstResult(($page-1) * $nombreParPage)
		// Ainsi que le nombre d'articles à afficher
		->setMaxResults($nombreParPage);
		// Enfin, on retourne l'objet Paginator correspondant à la requête construite
		// (n'oubliez pas le use correspondant en début de fichier)
		return new Paginator($qb);
	}


	public function listefacturesencompta($vue, $mode, $numfacture, $client, $totalttc, $ttcgroupe, $modepaiement, $nombreParPage, $page, $daterech, $dejareg, $codecontrat, $numbdcloueur, $loueur, $datereprise)
	{
        $today = date('Y-m-d');
		// On déplace la vérification du numéro de page dans cette méthode
		if ($page < 1) {

		}//echo 'page'.$page;
		// On utilise le QueryBuilder créé par le repository directement pour gagner du temps
		// Plus besoin de faire le select() ni le from() par la suite donc
		if($mode != 'search')
		{//echo 'pas search';
			$qb = $this->createQueryBuilder('a');
			if($vue == 'achats')
			{
                $qb->where('a.numfacfrs is null');
                $qb->orwhere('a.reglement = :reglement or a.encompta = :encompta or a.encompta is null')
                ->setParameter('reglement', 0)
				->setParameter('encompta', 0);
				$qb->andWhere('a.typedoc = :bdc or a.typedoc = :avoirfrs')
				->setParameter('bdc', 'facture frs')
				->setParameter('avoirfrs', 'avoir frs')
                    ->andwhere('YEARMONTH(a.echeance) <= :daterelance')
                    ->setParameter('daterelance', date('Ym',strtotime($today)));
				$qb->orderBy('a.datecrea', 'DESC');
			}
			else
			{
                $qb->where('a.reglement = :reglement')
                ->setParameter('reglement', 0);
				$qb->andWhere('a.typedoc != :bdc or a.typedoc = :avoirfrs')
                    ->setParameter('bdc', 'facture frs')
                    ->setParameter('avoirfrs', 'avoir frs');
                $qb->addOrderBy('a.encompta', 'DESC');
                $qb->addOrderBy('a.compteurfac', 'DESC');
			}
			$qb->getQuery();
		}
		else
		{
			$qb = $this->createQueryBuilder('a')
			->where('a.id > :id')
			->setParameter('id', 0);
			if($numfacture !== 0)
			{
				if($vue == 'achats')
				{
                    $qb->andWhere('a.typedoc = :bdc or a.typedoc = :avoirfrs')
                        ->setParameter('bdc', 'facture frs')
                        ->setParameter('avoirfrs', 'avoir frs');
					$qb->andWhere('a.numfacfrs LIKE :numfacfrs')
					->setParameter('numfacfrs', '%'.$numfacture.'%');
				}
				else
				{
                    $qb->andWhere('a.typedoc != :bdc or a.typedoc != :avoirfrs')
                        ->setParameter('bdc', 'facture frs')
                        ->setParameter('avoirfrs', 'avoir frs');
					$qb->andWhere('a.numfacture LIKE :numfacture')
					->setParameter('numfacture', '%'.$numfacture.'%');
				}
			}
			if($client !== 0)
			{//echo 'client'.$client;
				$qb->andWhere('a.client LIKE :client')
				->setParameter('client', '%'.$client.'%');
			}
			if($totalttc != 0)
			{//echo 'totalttc'.$totalttc;
				$qb->andWhere('a.totalttc = :totalttc')
				->setParameter('totalttc', $totalttc);
			}
			if($ttcgroupe != 0)
			{//echo 'ttcgroupe'.$ttcgroupe;
				$qb->andWhere('a.ttcgroupe = :ttcgroupe')
				->setParameter('ttcgroupe', $ttcgroupe);
			}
			if($modepaiement != 0 or $modepaiement != 'vide')
			{//echo 'modepaiement'.$modepaiement;
				$qb->andWhere('a.modepaiement = :modepaiement')
				->setParameter('modepaiement', $modepaiement);
			}
			if($daterech != 0 and $daterech != 'vide' and !isset($daterech))
			{//echo 'daterechrepo'.$daterech;
				$qb->andWhere('a.datepaiement = :datepaiement')
				->setParameter('datepaiement', $daterech);
			}
			if($dejareg != 0 or $dejareg != 'vide')
			{//echo 'gogo'.$dejareg;
				$qb->andWhere('a.montantdejareg = :montantdejareg')
				->setParameter('montantdejareg', $dejareg);
			}
            if($codecontrat != '0' and $codecontrat != 'vide')
            {
                $qb->andWhere('a.codelocata = :codelocata')
                    ->setParameter('codelocata', $codecontrat);
            }
            if($numbdcloueur != '0' and $numbdcloueur != 'vide')
            {
                $qb->andWhere('a.numbdcloueur = :numbdcloueur')
                    ->setParameter('numbdcloueur', $numbdcloueur);
            }
            if($datereprise != '0' and $datereprise != 'vide')
            {
                $qb->andWhere('a.datereprise = :datereprise')
                    ->setParameter('datereprise', $datereprise);
            }
            if($loueur != '0' and $loueur != 'vide')
            {
                $qb->andWhere('a.loueur = :loueur')
                    ->setParameter('loueur', $loueur);
            }
            if($vue == 'achats') {
                $qb->andWhere('a.typedoc = :bdc or a.typedoc = :avoirfrs')
                    ->setParameter('bdc', 'facture frs')
                    ->setParameter('avoirfrs', 'avoir frs')
                    ->orderBy('a.datecrea', 'DESC');
            }
            else
            {
                $qb->addOrderBy('a.encompta', 'DESC');
                $qb->addOrderBy('a.compteurfac', 'DESC');
            }
			$qb->getQuery();
            $page = 1;
		}

		// On définit l'article à partir duquel commencer la liste
		$qb->setFirstResult(($page-1) * $nombreParPage)
		// Ainsi que le nombre d'articles à afficher
		->setMaxResults($nombreParPage);
		// Enfin, on retourne l'objet Paginator correspondant à la requête construite
		// (n'oubliez pas le use correspondant en début de fichier)
		return new Paginator($qb);
	}

    public function facturesimpayees($id)
    {
		$qb = $this->createQueryBuilder('c');
        $qb->select('SUM(c.totalht) as impayes'); 
        $qb->where('c.reglement = :reglement')
              ->setParameter('reglement', 0)
			->andwhere('c.typedoc = :typedoc')
		   ->setParameter('typedoc', 'facture')
		   ->andWhere('c.clientid = :id')
		   ->setParameter('id', $id);                 
        return $qb->getQuery()->getSingleScalarResult();
    }
	
    public function ttesfacturesimpayees()
    {
		$qb = $this->createQueryBuilder('c');
        $qb->select('SUM(c.totalht - (c.montantdejareg/1.2))  as impayes');
        $qb->where('c.reglement = :reglement')
              ->setParameter('reglement', 0)
            ->andWhere('c.encompta = :encompta')
            ->setParameter('encompta', 1)
			->andwhere('c.typedoc = :typedoc')
		   ->setParameter('typedoc', 'facture') ;
        return $qb->getQuery()->getSingleScalarResult();
    }

    public function ttesfacturesimpayeesfrs()
    {
        $today = date('Y-m-d');
		$qb = $this->createQueryBuilder('c');
        $qb->select('SUM(c.totalht) as impayes');
        $qb->where('c.reglement = :reglement')
              ->setParameter('reglement', 0)
            ->andwhere('YEARMONTH(c.echeance) <= :daterelance')
            ->setParameter('daterelance', date('Ym',strtotime($today)))
            ->andwhere('c.typedoc = :typedoc')
		   ->setParameter('typedoc', 'facture frs') ;
        return $qb->getQuery()->getSingleScalarResult();
    }
	
    public function ttesfacturesimpayeesnonechues()
    {
		$today = date('Y-m-d');
		$qb = $this->createQueryBuilder('c');
        $qb->select('SUM(c.totalht - (c.montantdejareg/1.2))  as impayes');
        $qb->where('c.reglement = :reglement')
              ->setParameter('reglement', 0)
            ->andWhere('c.encompta = :encompta')
            ->setParameter('encompta', 1)
			->andwhere('c.echeance > :daterelance')
			->setParameter('daterelance', $today)
			->andwhere('c.typedoc = :typedoc')
		    ->setParameter('typedoc', 'facture');
        $qb->andWhere('c.datecrea >= :date')
            ->setParameter('date', '2020-01-01');
        return $qb->getQuery()->getSingleScalarResult();
    }

    public function ttesfacturesimpayeesnonechuesfrs()
    {
		$today = date('Y-m-d');
		$qb = $this->createQueryBuilder('c');
        $qb->select('SUM(c.totalht) as impayes');
        $qb->where('c.reglement = :reglement')
              ->setParameter('reglement', 0)
			->andwhere('c.echeance > :daterelance')
			->setParameter('daterelance', $today)
			->andwhere('c.echeance <= :daterelance2')
			->setParameter('daterelance2', date('Y-m-t'))
			->andwhere('c.typedoc = :typedoc')
		    ->setParameter('typedoc', 'facture frs');
        return $qb->getQuery()->getSingleScalarResult();
    }

    public function ttesfacturesechues()
    {
		$today = date('Y-m-d');
		$qb = $this->createQueryBuilder('f');
        $qb->select('SUM(f.totalht - (f.montantdejareg/1.2)) as echues');
		$qb->where('f.echeance <= :daterelance')
		->setParameter('daterelance', $today)
        ->andwhere('f.reglement = :reglement')
        ->setParameter('reglement', 0)
        ->andWhere('f.encompta = :encompta')
        ->setParameter('encompta', 1)
        ->andWhere('f.totalttc > :totalttc')
        ->setParameter('totalttc', 0)
		->andwhere('f.typedoc = :typedoc')
	    ->setParameter('typedoc', 'facture')
        ->andWhere('f.datecrea >= :date')
            ->setParameter('date', '2020-01-01')
        ->orderBy('f.echeance', 'ASC');

        return $qb->getQuery()->getSingleScalarResult();
    }

    public function ttesfacturesechuesfrs()
    {
		$today = date('Y-m-d');
		$qb = $this->createQueryBuilder('f');
        $qb->select('SUM(f.totalht) as echues');
		$qb->where('f.echeance <= :daterelance')
		->setParameter('daterelance', $today)
        ->andwhere('f.reglement = :reglement')
        ->setParameter('reglement', 0)
		->andwhere('f.typedoc = :typedoc')
	    ->setParameter('typedoc', 'facture frs')
        ->orderBy('f.echeance', 'ASC');

        return $qb->getQuery()->getSingleScalarResult();
    }

    public function ttesfacturesechuesthisfrs()
    {
		$today = date('Y-m-d');
		$qb = $this->createQueryBuilder('f');
        $qb->select('SUM(f.totalht) as echues');
		$qb->where('f.echeance <= :daterelance')
		->setParameter('daterelance', $today)
        ->andwhere('f.reglement = :reglement')
        ->setParameter('reglement', 0)
		->andwhere('f.typedoc = :typedoc')
	    ->setParameter('typedoc', 'facture frs')
        ->orderBy('f.echeance', 'ASC');

        return $qb->getQuery()->getSingleScalarResult();
    }
	
    public function listerelance()
    {
		$today = date('Y-m-d');
		$qb = $this->createQueryBuilder('f')
				   ->leftJoin('f.fiche', 'b')
				   ->addSelect('b');
		$qb->where('f.echeance <= :daterelance')
		->andWhere('f.reglement = :reglement or f.reglement is null')
		->andWhere('f.typedoc = :typedoc')
		->andWhere('f.encompta = :encompta')
		->andWhere('f.totalttc > :totalttc')
		->setParameter('daterelance', $today)
		->setParameter('reglement', 0)
		->setParameter('encompta', 1)
		->setParameter('totalttc', 0)
		->setParameter('typedoc', 'facture');
        $qb->orderBy('f.client', 'ASC');

        return $qb->getQuery()->getResult();
    }		
	
    public function facturesechues($clientid)
    {
		$today = date('Y-m-d');
		$qb = $this->createQueryBuilder('f');
		$qb->where('f.echeance <= :daterelance')
		->andWhere('f.echeance >= :debut')
		->setParameter('debut', '2020-01-01')
		->andWhere('f.clientid = :clientid')
		->setParameter('daterelance', $today)
		->andWhere('f.reglement = :reglement')
		->setParameter('reglement', 0)
        ->andWhere('f.encompta = :encompta')
        ->setParameter('encompta', 1)
        ->andWhere('f.totalttc > :totalttc')
        ->setParameter('totalttc', 0)
        ->andWhere('f.typedoc = :typedoc')
        ->setParameter('typedoc', 'facture')
		->setParameter('clientid', $clientid)
        ->orderBy('f.echeance', 'ASC');	
                 
        return $qb->getQuery()->getResult();
    }
	
    public function cavente($dStart, $dEnd)
    {
		$qb = $this->createQueryBuilder('c');
        $qb->select('SUM(c.totalht) as careal, c.user, c.totalht, c.typedoc, YEARMONTH(c.datecrea) as datecrea'); 
        $qb->where('YEARMONTH(c.datecrea) <= :today')
		   ->setParameter('today', date('Ym',strtotime($dEnd)))
		   ->andWhere('YEARMONTH(c.datecrea) >= :dtsart')
		   ->setParameter('dtsart', date('Ym',strtotime($dStart)))
		   ->andWhere('c.codelocata LIKE :codelocata')
		   ->setParameter('codelocata', '%V%')
		   ->andWhere('c.typedoc = :typedoc')
		   ->setParameter('typedoc', 'facture')
		   ->andWhere('c.encompta = :encompta')
		   ->setParameter('encompta', 1)
		   ->groupBy('datecrea')
		   ->orderBy('datecrea');
                 
        return $qb->getQuery()->getArrayResult();
    }

    public function extraitcompte($clientid, $du, $au)
    {
        $year = date('Y') - 3;
        $m1 = date($year.'-01-01');
        $today = date('Y-m-d');
        $qb = $this->createQueryBuilder('f');
        $qb->where('f.datecrea <= :datefin and f.datecrea >= :debut')
            ->setParameter('datefin', $au)
            ->setParameter('debut', $du)
            ->andWhere('f.clientid = :clientid')
            ->setParameter('clientid', $clientid)
//            ->andWhere('f.echeance <= :echeance')
//            ->setParameter('echeance', date('Y-m-d'))
            ->andWhere('f.encompta = :encompta')
            ->setParameter('encompta', 1)
            ->andWhere('f.typedoc = :typedoc or f.typedoc = :typedoc2')
            ->setParameter('typedoc', 'facture')
            ->setParameter('typedoc2', 'avoir');
        $qb->orderBy('f.datecrea', 'ASC');

        return $qb->getQuery()->getResult();
    }

    public function extraitcomptem1()
    {
        $m1 = date('Y-m-t', strtotime("-1 month"));
        $qb = $this->createQueryBuilder('f');
        $qb->where('f.echeance <= :echeance')
            ->setParameter('echeance', $m1)
            ->andWhere('f.encompta = :encompta')
            ->setParameter('encompta', 1)
            ->andWhere('f.typedoc = :typedoc or f.typedoc = :typedoc2')
            ->setParameter('typedoc', 'facture frs')
            ->setParameter('typedoc2', 'avoir frs');
        $qb->orderBy('f.echeance', 'ASC');

        return $qb->getQuery()->getResult();
    }

    public function encoursfac($clientid)
    {
        $today = date('Y-m-d');
        $qb = $this->createQueryBuilder('f');
        $qb->where('f.echeance <= :echeance')
            ->setParameter('echeance', $today)
            ->andWhere('f.clientid = :clientid')
            ->setParameter('clientid', $clientid)
            ->andWhere('f.reglement = :reglement')
            ->setParameter('reglement', 0)
            ->andWhere('f.encompta = :encompta')
            ->setParameter('encompta', 1);
        $qb->orderBy('f.datecrea', 'ASC');

        return $qb->getQuery()->getResult();
    }

    public function encoursfacttesfac($clientid)
    {
        $today = date('Y-m-d');
        $qb = $this->createQueryBuilder('f');
        $qb->where('f.clientid = :clientid')
            ->setParameter('clientid', $clientid)
            ->andWhere('f.reglement = :reglement')
            ->setParameter('reglement', 0)
            ->andWhere('f.encompta = :encompta')
            ->setParameter('encompta', 1);
        $qb->orderBy('f.datecrea', 'ASC');

        return $qb->getQuery()->getResult();
    }

    public function apayer($clientid)
    {
        $qb = $this->createQueryBuilder('c');
        $qb->where('c.reglement = :reglement')
            ->setParameter('reglement', 0)
            ->andwhere('c.typedoc = :typedoc or c.typedoc = :typedoc2')
            ->setParameter('typedoc', 'facture')
            ->setParameter('typedoc2', 'avoir')
            ->andwhere('c.encompta = :encompta')
            ->setParameter('encompta', 1)
            ->andwhere('c.clientid = :clientid')
            ->setParameter('clientid', $clientid)
        ->orderBy('c.numfacture', 'ASC');
        return $qb->getQuery()->getResult();
    }

    public function facturesafacturer($du, $au)
    {
        $qb = $this->createQueryBuilder('c');
        $qb->where('c.datecrea >= :du and c.datecrea <= :au')
            ->setParameter('du', $du)
            ->setParameter('au', $au)
            ->andWhere('c.numfacture != :numfacture')
            ->setParameter('numfacture', 'En attente')
            ->andWhere('c.typedoc = :facture or c.typedoc = :avoir')
            ->setParameter('facture', 'facture')
            ->setParameter('avoir', 'avoir')
            ->orderBy('c.numfacture', 'ASC');

        return $qb->getQuery()->getResult();
    }

    public function facturesafacturerachat($du, $au)
    {
        $qb = $this->createQueryBuilder('c');
        $qb->where('c.datecrea >= :du and c.datecrea <= :au')
            ->setParameter('du', $du)
            ->setParameter('au', $au)
            ->andWhere('c.numfacfrs is not null')
            ->andWhere('c.typedoc = :facture or c.typedoc = :avoir')
            ->setParameter('facture', 'facture frs')
            ->setParameter('avoir', 'avoir frs')
            ->orderBy('c.numfacfrs', 'ASC');

        return $qb->getQuery()->getResult();
    }
}
