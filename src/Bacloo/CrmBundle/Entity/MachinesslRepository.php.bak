<?php

namespace Bacloo\CrmBundle\Entity;

/**
 * MachinesslRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class MachinesslRepository extends \Doctrine\ORM\EntityRepository
{
	public function dispos($codemachine, $dstart, $dend)
	{
		$qb = $this->createQueryBuilder('m');
		$qb->select('m.code');
		$qb->where('m.codegenerique = :codegenerique')
		->setParameter('codegenerique', $codemachine)
		->andwhere("m.debutloc NOT BETWEEN :start AND :end OR m.debutloc is NULL OR m.debutloc = ''")
	    ->setParameter('start', $dstart)
	    ->setParameter('end', $dend)
		->andwhere("m.finloc NOT BETWEEN :start AND :end OR m.finloc is NULL OR m.finloc = ''")
	    ->setParameter('start', $dstart)
	    ->setParameter('end', $dend)
		->andwhere("m.etat != :enloc")
	    ->setParameter('enloc', 'En location')
		->andwhere("m.etat != :enpanne")
	    ->setParameter('enpanne', 'En panne')
		->andwhere("m.etat != :inspection")
	    ->setParameter('inspection', 'Inspection')
		->andwhere("m.etat != :reserve")
	    ->setParameter('reserve', 'Réservé')
		->groupBy('m.code');					
		$dispos = $qb->getQuery()->getResult();
		return $dispos;
	}
	
	public function dispoprecise($codemachine, $dstart, $dend)
	{
		$qb = $this->createQueryBuilder('m');
		$qb->select('m.code');
		$qb->where('m.code = :code')
		->setParameter('code', $codemachine)
		->andwhere("(m.debutloc BETWEEN :start AND :end) OR (m.finloc BETWEEN :start AND :end)")
	    ->setParameter('start', $dstart)
	    ->setParameter('end', $dend);					
		$dispos = $qb->getQuery()->getResult();
		return $dispos;
	}
	
	// public function dispoprecisenot($codemachine, $dstart, $dend)
	// {
		// $qb = $this->createQueryBuilder('m');
		// $qb->select('m.code');
		// $qb->where('m.code = :code')
		// ->setParameter('code', $codemachine)
		// ->andwhere("(m.debutloc NOT BETWEEN :start AND :end) OR (m.finloc NOT BETWEEN :start AND :end)")
	    // ->setParameter('start', $dstart)
	    // ->setParameter('end', $dend);					
		// $dispos = $qb->getQuery()->getResult();
		// return $dispos;
	// }
	
	public function dispoprecisenot($codemachine, $dstart, $dend)
	{
		$qb = $this->createQueryBuilder('m');
		$qb->select('m.code');
		$qb->where('m.code = :code')
		->setParameter('code', $codemachine)
		->andwhere("m.debutloc < :start AND m.finloc > :end")
	    ->setParameter('start', $dstart)
	    ->setParameter('end', $dend);					
		$dispos = $qb->getQuery()->getResult();
		return $dispos;
	}
	
	public function unedispo($codemachine, $dstart, $dend)
	{
		$qb = $this->createQueryBuilder('m');
		$qb->select('m.code, m.etat, m.energie');
		$qb->where('m.codegenerique = :codegenerique')
		->setParameter('codegenerique', $codemachine)
		->andwhere("m.debutloc NOT BETWEEN :start AND :end OR m.debutloc is NULL OR m.debutloc = ''")
		// ->andwhere("m.debutloc != :start")
		// ->andwhere("m.original = :original OR m.original =:original1")
		// ->andwhere("m.debutloc NOT BETWEEN :start AND :end OR m.debutloc is NULL OR m.debutloc = '' OR m.etat = 'Réservé'")//Pas sûr qu'il faille mettre le filtre etat
	    // ->setParameter('start', $dstart)
	    // ->setParameter('end', $dend)
		->andwhere("m.finloc NOT BETWEEN :start AND :end OR m.finloc is NULL OR m.finloc = ''")
		// ->andwhere("m.finloc != :end")
		// ->andwhere("m.finloc NOT BETWEEN :start AND :end OR m.finloc is NULL OR m.finloc = '' OR m.etat = :etat")//Pas sûr qu'il faille mettre le filtre etat
	    ->setParameter('start', $dstart)
	    ->setParameter('end', $dend);					
	    // ->setParameter('original', 1)					
	    // ->setParameter('original1', 0);					
		$dispos = $qb->getQuery()->getResult();
		return $dispos;
	}

    public function findAll()
    {	
        return $this->findBy(array(), array('code' => 'ASC'));
    }	
}
