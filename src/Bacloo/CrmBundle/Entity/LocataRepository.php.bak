<?php

namespace Bacloo\CrmBundle\Entity;
use DoctrineExtensions\Query\Mysql\Month;

use Doctrine\ORM\EntityRepository;
use Doctrine\ORM\Tools\Pagination\Paginator;

/**
 * LocataRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class LocataRepository extends \Doctrine\ORM\EntityRepository
{
	public function adispatcher($date)
	{
		$qb = $this->createQueryBuilder('f')
					->leftJoin('f.locations', 'c')
					->addSelect('c');
		//LIGNES A REACTIVER UNE FOIS LES CONTRATS SAISIS
		$qb->where('c.debutloc <= :debutloc')
		->setParameter('debutloc', $date);		
		$qb->andWhere('f.contrat = :contrat')		
		->setParameter('contrat', 1)		
		->andWhere("c.codemachineinterne = '' OR c.codemachineinterne is NULL")
		->orderBy('c.codemachine', 'ASC');					
		return $qb->getQuery()->getResult();
	}
	
	public function resa($date)
	{
		$qb = $this->createQueryBuilder('f')
					->leftJoin('f.locations', 'c')
					->addSelect('c');
		//LIGNES A REACTIVER UNE FOIS LES CONTRATS SAISIS
		$qb->where('c.debutloc <= :debutloc')
		->setParameter('debutloc', $date);		
		$qb->andWhere('f.bdcrecu = :bdcrecu or (f.bdcrecu = :bdcrecux and f.contrat = :contrat)')		
		->setParameter('bdcrecu', 1)		
		->setParameter('bdcrecux', 0)		
		->setParameter('contrat', 1)		
		->andWhere('c.etatloc = :etatloc')		
		->setParameter('etatloc', 'Réservé')
		->orderBy('c.codemachine', 'ASC');					
		return $qb->getQuery()->getResult();
	}
	
	public function apreprarer($date)
	{
		$qb = $this->createQueryBuilder('f')
					->leftJoin('f.locations', 'c')
					->addSelect('c');
		//LIGNES A REACTIVER UNE FOIS LES CONTRATS SAISIS
		$qb->where('c.datereprise <= :datereprise or c.finloc <= :today')
		->setParameter('datereprise', $date)		
		->setParameter('today', date('Y-m-d'));		
		$qb->andWhere('f.contrat = :contrat')		
		->setParameter('contrat', 1)
		->andwhere('c.etatloc = :etatloc')
		->setParameter('etatloc', 'Retour planifié')			
		->orderBy('c.finloc', 'ASC');					
		return $qb->getQuery()->getResult();
	}
	
	public function dejadispatch($date)
	{
		$qb = $this->createQueryBuilder('f')
					->leftJoin('f.locations', 'c')
					->addSelect('c');
		$qb->where('c.debutloc <= :debutloc')
		->setParameter('debutloc', $date)
		->andwhere('c.debutloc >= :debutloco')
		->setParameter('debutloco', date('Y-m-d', strtotime(" -1 days")))
		->andWhere('c.etatloc = :etatloc')
		->setParameter('etatloc', 'Prêt au départ')		
		->orderBy('f.id', 'ASC');					
		return $qb->getQuery()->getResult();
	}
	
	public function machinespretes($date)
	{
		$qb = $this->createQueryBuilder('f')
					->leftJoin('f.locations', 'c')
					->addSelect('c');
		$qb->where('c.debutloc = :debutloc')
		->setParameter('debutloc', $date)		
		->andWhere('f.contrat = :contrat')		
		->setParameter('contrat', 1)		
		->andWhere("c.codemachineinterne != ''")		
		->orderBy('c.codemachine', 'ASC');					
		return $qb->getQuery()->getResult();
	}
	
	public function retours($date)
	{
		$qb = $this->createQueryBuilder('f')
					->leftJoin('f.locations', 'c')
					->addSelect('c');
		$qb->where('c.finloc <= :finloc')
		->setParameter('finloc', $date)		
		->andWhere('f.contrat = :contrat')	
		->setParameter('contrat', 1)
		->andwhere('c.etatloc = :etatloc')
		->setParameter('etatloc', 'En location')
		->andwhere('c.etatloc != :etatloca')
		->setParameter('etatloca', 'Annulée')					
		->orderBy('c.finloc', 'ASC');					
		return $qb->getQuery()->getResult();
	}
	
	public function retourssl($date)
	{
		$qb = $this->createQueryBuilder('f')
					->leftJoin('f.locationssl', 'c')
					->addSelect('c');
		$qb->where('c.finloc <= :finloc')
		->setParameter('finloc', $date)		
		->andWhere('f.contrat = :contrat')	
		->setParameter('contrat', 1)
		->andwhere('c.etatloc = :etatloc')
		->setParameter('etatloc', 'En location')
		->andwhere('c.etatloc != :etatloca')
		->setParameter('etatloca', 'Annulée')					
		->orderBy('c.finloc', 'ASC');					
		return $qb->getQuery()->getResult();
	}

	public function retours2($date)
	{
		$qb = $this->createQueryBuilder('f')
					->leftJoin('f.locations', 'c')
					->addSelect('c');
		$qb->where('c.finloc = :finloc')
		->setParameter('finloc', $date)
		->andWhere('f.contrat = :contrat')
		->setParameter('contrat', 1)
		->andwhere('c.etatloc = :etatloc')
		->setParameter('etatloc', 'En location')
		->andwhere('c.etatloc != :etatloca')
		->setParameter('etatloca', 'Annulée')
		->orderBy('c.finloc', 'ASC');
		return $qb->getQuery()->getResult();
	}

	public function retourssl2($date)
	{
		$qb = $this->createQueryBuilder('f')
					->leftJoin('f.locationssl', 'c')
					->addSelect('c');
		$qb->where('c.finloc = :finloc')
		->setParameter('finloc', $date)
		->andWhere('f.contrat = :contrat')
		->setParameter('contrat', 1)
		->andwhere('c.etatloc = :etatloc')
		->setParameter('etatloc', 'En location')
		->andwhere('c.etatloc != :etatloca')
		->setParameter('etatloca', 'Annulée')
		->orderBy('c.finloc', 'ASC');
		return $qb->getQuery()->getResult();
	}
	
	public function livraisons($date)
	{
		$qb = $this->createQueryBuilder('f')
					->leftJoin('f.locations', 'c')
					->addSelect('c');
		//LIGNES A REACTIVER UNE FOIS LES CONTRATS SAISIS
		$qb->where('c.debutloc <= :debutloc')
		->setParameter('debutloc', $date);		
		$qb->andWhere('f.contrat = :contrat')	
		->setParameter('contrat', 1)
		->andwhere('c.etatloc = :etatloc')
		->setParameter('etatloc', 'Prêt au départ')					
		->orderBy('c.debutloc', 'ASC');					
		return $qb->getQuery()->getResult();
	}
	
	public function livraisonssl($date)
	{
		$qb = $this->createQueryBuilder('f')
					->leftJoin('f.locationssl', 'c')
					->addSelect('c');
		$qb->where('c.debutloc <= :debutloc')
		->setParameter('debutloc', $date)		
		->andWhere('f.contrat = :contrat')	
		->setParameter('contrat', 1)
		->andwhere('c.etatloc = :etatloc')
		->setParameter('etatloc', 'Prêt au départ')					
		->orderBy('c.debutloc', 'ASC');					
		return $qb->getQuery()->getResult();
	}
	
	public function findByEtatloc($etatloc)
	{
		$qb = $this->createQueryBuilder('f')
					->leftJoin('f.locations', 'c')
					->addSelect('c');
		$qb->where('c.etatloc = :etatloc')
		->setParameter('etatloc', $etatloc)				
		->orderBy('c.codemachineinterne', 'ASC');					
		return $qb->getQuery()->getResult();
	}
	
	public function findByEtatlocsl($etatloc)
	{
		$qb = $this->createQueryBuilder('f')
					->leftJoin('f.locationssl', 'c')
					->addSelect('c');
		$qb->where('c.etatloc = :etatloc')
		->setParameter('etatloc', $etatloc)				
		->orderBy('c.codemachineinterne', 'ASC');					
		return $qb->getQuery()->getResult();
	}
	
	public function findByEtatloca($etatlog, $etatlogok2, $date)
	{
		$qb = $this->createQueryBuilder('f')
					->leftJoin('f.locations', 'c')
					->addSelect('c');
		$qb->where('c.etatlog = :etatlog or c.etatlog = :etatlogok2')
		->setParameter('etatlog', $etatlog)		
		->setParameter('etatlogok2', $etatlogok2);
		$qb->orderBy('c.debutloc', 'ASC');				
		return $qb->getQuery()->getResult();
	}
	
	public function findByEtatloca2($etatlog, $etatlogok2, $date)
	{
		$qb = $this->createQueryBuilder('f')
					->leftJoin('f.locations', 'c')
					->addSelect('c');
		$qb->where('c.debutloc = :date ')
		->setParameter('date', $date)	
		->andWhere('f.contrat = :contrat ')		
		->setParameter('contrat', 1);
		$qb->orderBy('c.debutloc', 'ASC');				
		return $qb->getQuery()->getResult();
	}
	
	public function findByEtatlocasl($etatlog, $etatlogok2, $date)
	{
		$qb = $this->createQueryBuilder('f')
					->leftJoin('f.locationssl', 'c')
					->addSelect('c');
		$qb->where('c.etatlog = :etatlog or c.etatlog = :etatlogok2')
		->setParameter('etatlog', $etatlog)		
		->setParameter('etatlogok2', $etatlogok2);
		$qb->orderBy('c.debutloc', 'ASC');				
		return $qb->getQuery()->getResult();
	}
	
	public function findByEtatlocasl2($etatlog, $etatlogok2, $date)
	{
		$qb = $this->createQueryBuilder('f')
					->leftJoin('f.locationssl', 'c')
					->addSelect('c');
		$qb->where('c.debutloc = :date ')
		->setParameter('date', $date)	
		->andWhere('f.contrat = :contrat ')		
		->setParameter('contrat', 1);
		$qb->orderBy('c.debutloc', 'ASC');					
		return $qb->getQuery()->getResult();
	}
	
	public function last5loc($machineid)
	{
		$qb = $this->createQueryBuilder('f')
					->leftJoin('f.locations', 'c')
					->addSelect('c');
		$qb->where('c.machineid = :machineid')
		->setParameter('machineid', $machineid)
		->orderBy('c.debutloc', 'DESC')
		->setMaxResults(6);						
		$last5loc = $qb->getQuery()->getResult();
		return $last5loc;
	}
	
	public function last5locsl($machineid)
	{
		$qb = $this->createQueryBuilder('f')
					->leftJoin('f.locationssl', 'c')
					->addSelect('c');
		$qb->where('c.machineid = :machineid')
		->setParameter('machineid', $machineid)
		->orderBy('c.id', 'DESC')
		->setMaxResults(6);						
		$last5locsl = $qb->getQuery()->getResult();
		return $last5locsl;
	}
	
	public function findByEtatlog($etatlog)
	{
		$qb = $this->createQueryBuilder('f')
					->leftJoin('f.locations', 'c')
					->addSelect('c');
		$qb->where('c.etatlog = :etatlog')
		->setParameter('etatlog', $etatlog)				
		->orderBy('c.codemachineinterne', 'ASC');					
		return $qb->getQuery()->getResult();
	}
	
	public function devisnonvadparc()
	{
		$qb = $this->createQueryBuilder('f')
					->leftJoin('f.locations', 'c')
					->addSelect('c');
		$qb->where('f.offreencours = :offreencours')
		->setParameter('offreencours', 1)
		->andWhere('f.bdcrecu = :bdcrecu')
		->setParameter('bdcrecu', 0)
		->andWhere('f.contrat = :contrat')
		->setParameter('contrat', 0)	
		->andWhere('f.annulee = :annulee')
		->setParameter('annulee', 0)	
		->andWhere('f.offrerefusee = :offrerefusee')
		->setParameter('offrerefusee', 0)
		->andWhere('c.montantloc > :montantloc')
		->setParameter('montantloc', 0)				
		->orderBy('c.debutloc', 'ASC');					
		return $qb->getQuery()->getResult();
	}
	
	public function devisnonvadsl()
	{
		$qb = $this->createQueryBuilder('f')
					->leftJoin('f.locationssl', 'c')
					->addSelect('c');
		$qb->where('f.offreencours = :offreencours')
		->setParameter('offreencours', 1)
		->andWhere('f.bdcrecu = :bdcrecu')
		->setParameter('bdcrecu', 0)
		->andWhere('f.contrat = :contrat')
		->setParameter('contrat', 0)	
		->andWhere('f.annulee = :annulee')
		->setParameter('annulee', 0)	
		->andWhere('f.offrerefusee = :offrerefusee')
		->setParameter('offrerefusee', 0)
		->andWhere('c.montantloc > :montantloc')
		->setParameter('montantloc', 0)				
		->orderBy('c.debutloc', 'ASC');					
		return $qb->getQuery()->getResult();
	}
	
	public function locationsafacturer($debutmois, $finmois)
	{
		$qb = $this->createQueryBuilder('f')
					->leftJoin('f.locations', 'c')
					->leftJoin('f.locationssl', 's')
					->addSelect('c')
					->addSelect('s');
		// $qb->where('c.etatloc = :etatloc and s.etatloc = :etatloc')	
		$qb->where('f.contrat = :contrat and f.offrerefusee = :offrerefusee')	
		->setParameter('contrat', 1)	
		->setParameter('offrerefusee', 0)	
		->andWhere('(c.debutloc <= :finmois and c.finloc >= :debutmois) or (s.debutloc <= :finmois and s.finloc >= :debutmois)')		
		->setParameter('debutmois', $debutmois)		
		->setParameter('finmois',$finmois)	
		->andWhere('(c.etatloc = :etatloc1 or c.etatloc = :etatloc2) or (s.etatloc = :etatloc1 or s.etatloc = :etatloc2)')	
		->setParameter('etatloc1', 'En location')	
		->setParameter('etatloc2', 'Location terminée')
        ->andWhere('(c.cloture = :cloture or c.cloture is NULL) or (s.cloture = :cloture or s.cloture is NULL)')
        ->setParameter('cloture', 0)
		->groupBy('f.id');					
		return $qb->getQuery()->getScalarResult();
	}
	
	public function recupcodeloc($ecode, $typeloc, $codecontrat)
	{
		if($typeloc == 'parc')
		{
			$qb = $this->createQueryBuilder('f')
						->leftJoin('f.locations', 'c')
						->addSelect('c');	
			$qb->where('f.id = :codecontrat')	
			->andWhere('c.codemachineinterne = :codemachineinterne')	
			->setParameter('codecontrat', $codecontrat)					
			->setParameter('codemachineinterne', $ecode);					
			return $qb->getQuery()->getScalarResult();
		}
		else
		{
			$qb = $this->createQueryBuilder('f')
						->leftJoin('f.locationssl', 'c')
						->addSelect('c');
			$qb->where('c.codemachineinterne = :codemachineinterne')	
			->setParameter('codemachineinterne', $ecode);				
			return $qb->getQuery()->getScalarResult();		
		}
	}
	
	public function recupnomchantier($ecode, $typeloc, $codelocations)
	{
		if($typeloc == 'parc')
		{
			$qb = $this->createQueryBuilder('f')
						->leftJoin('f.locations', 'c')
						->addSelect('c');
			// $qb->where('c.etatloc = :etatloc and s.etatloc = :etatloc')	
			$qb->where('c.id = :codelocations')	
			->setParameter('codelocations', $codelocations);					
			return $qb->getQuery()->getScalarResult();
		}
		else
		{
			$qb = $this->createQueryBuilder('f')
						->leftJoin('f.locationssl', 'c')
						->addSelect('c');
			// $qb->where('c.etatloc = :etatloc and s.etatloc = :etatloc')	
			$qb->where('c.id = :codelocations')	
			->setParameter('codelocations', $codelocations);					
			return $qb->getQuery()->getScalarResult();		
		}
	}
	
	public function dejaenr($ecode, $locid)
	{
			$qb = $this->createQueryBuilder('f')
						->leftJoin('f.locations', 'c')
						->addSelect('c');	
			$qb->where('c.codemachineinterne = :codemachineinterne')	
			->setParameter('codemachineinterne', $ecode)	
			->andWhere('f.id = :locid')	
			->setParameter('locid', $locid);					
			return $qb->getQuery()->getScalarResult();	
	}
	
	public function dejaenrsl($ecode, $locid)
	{
			$qb = $this->createQueryBuilder('f')
						->leftJoin('f.locationssl', 'c')
						->addSelect('c');
			$qb->where('c.codemachineinterne = :codemachineinterne')	
			->setParameter('codemachineinterne', $ecode)	
			->andWhere('f.id = :locid')	
			->setParameter('locid', $locid);				
			return $qb->getQuery()->getScalarResult();	
	}
	
	public function offresdumois()
	{
		$debutmois = date('Y-m-01');
		$finmois = date('Y-m-t');		
		$qb = $this->createQueryBuilder('f');
		$qb->where("f.datemodif BETWEEN :debutmois AND :finmois")
	    ->setParameter('debutmois', $debutmois)
	    ->setParameter('finmois', $finmois)
		->orderBy('f.datemodif', 'ASC');					
		return $qb->getQuery()->getResult();
	}
	
	public function offresdumoisgroupe($page)
	{
		// On définit l'article à partir duquel commencer la liste
		$limitebasse = (($page-1) * 20);
		
		$debutmois = date('Y-m-01');
		$finmois = date('Y-m-t');		
		$qb = $this->createQueryBuilder('f');
		$qb->where("f.datemodif BETWEEN :debutmois AND :finmois")
	    ->setParameter('debutmois', $debutmois)
	    ->setParameter('finmois', $finmois)
		->orderBy('f.client', 'ASC')
		->GroupBy('f.client')
		->setFirstResult($limitebasse)
        ->setMaxResults(20);				
		return $qb->getQuery()->getResult();
	}	
	
	public function countoffres($du, $user)
	{
		$qb = $this->createQueryBuilder('f');
		$qb->select('COUNT(f.id)');
		$qb->where('f.user = :user')
		->setParameter('user', $user)
		->andwhere('f.offreencours = :nb')
		->setParameter('nb', 1)		
		->andWhere('f.datemodif >= :du')
		->setParameter('du', $du);					
		$countoffres = $qb->getQuery()->getSingleScalarResult();

		return $countoffres;
	}	
	
	public function caoffres($du, $user)
	{
		$qb = $this->createQueryBuilder('f');
		$qb->select('SUM(f.montantloc)+SUM(f.transportaller)+SUM(f.transportretour)+SUM(f.assurance)+SUM(f.contributionverte)');
		$qb->where('f.user = :user')
		->setParameter('user', $user)
		->andwhere('f.offreencours = :nb')
		->setParameter('nb', 1)		
		->andWhere('f.datemodif >= :du')
		->setParameter('du', $du);					
		$caoffres = $qb->getQuery()->getSingleScalarResult();

		return $caoffres;
	}	
	
	public function countcontrats($du, $user)
	{
		$qb = $this->createQueryBuilder('f');
		$qb->select('COUNT(f.id)');
		$qb->where('f.user = :user')
		->setParameter('user', $user)
		->andwhere('f.contrat = :nb')
		->setParameter('nb', 1)		
		->andWhere('f.datemodif >= :du')
		->setParameter('du', $du);					
		$countcontrats = $qb->getQuery()->getSingleScalarResult();

		return $countcontrats;
	}	
	
	public function cacontrats($du, $user)
	{
		$qb = $this->createQueryBuilder('f');
		$qb->select('SUM(f.montantloc)+SUM(f.transportaller)+SUM(f.transportretour)+SUM(f.assurance)+SUM(f.contributionverte)');
		$qb->where('f.user = :user')
		->setParameter('user', $user)
		->andwhere('f.contrat = :nb')
		->setParameter('nb', 1)		
		->andWhere('f.datemodif >= :du')
		->setParameter('du', $du);					
		$cacontrats = $qb->getQuery()->getSingleScalarResult();

		return $cacontrats;
	}
	
	public function statloc($dStart, $dEnd)
	{
		$qb = $this->createQueryBuilder('f')
					->leftJoin('f.locations', 'c')
					->leftJoin('f.locationssl', 's')
					->addSelect('c')
					->addSelect('s');
		$qb->where('c.finloc >= :finloc')
		->setParameter('finloc', $dStart)
		->orWhere('s.finloc >= :finloco')
		->setParameter('finloco', $dStart)		
		->andWhere('f.contrat = :contrat')		
		->setParameter('contrat', 1);
		   // ->andWhere('f.client = :client')
		   // ->setParameter('client', 'GREENCABLE');					
		$statloc = $qb->getQuery()->getResult();

		return $statloc;
	}
	
	public function statloctoday($dStart, $dEnd)
	{
		$qb = $this->createQueryBuilder('f')
					->leftJoin('f.locations', 'c')
					->leftJoin('f.locationssl', 's')
					->addSelect('c')
					->addSelect('s');
		$qb->where('c.debutloc <= :debutloc and c.finloc >= :finloc')
		->setParameter('debutloc', $dEnd)
		->setParameter('finloc', $dStart)
		->orWhere('s.debutloc <= :debutloco and s.finloc >= :finloco')
		->setParameter('debutloco', $dEnd)
		->setParameter('finloco', $dStart)		
		->andWhere('f.contrat = :contrat')		
		->setParameter('contrat', 1);					
		$statloctoday = $qb->getQuery()->getResult();

		return $statloctoday;
	}
	
	public function statlocmois($dStart, $dEnd)
	{
		$qb = $this->createQueryBuilder('f')
					->leftJoin('f.locations', 'c')
					->leftJoin('f.locationssl', 's')
					->addSelect('c')
					->addSelect('s');
		$qb->where('c.debutloc <= :finloc and c.finloc >= :debutloc')
		->setParameter('debutloc', $dStart)
		->setParameter('finloc', $dEnd)
		->orWhere('s.debutloc <= :finloco and s.finloc >= :debutloco')
		->setParameter('debutloco', $dStart)
		->setParameter('finloco', $dEnd)		
		->andWhere('f.contrat = :contrat')		
		->setParameter('contrat', 1);
		   // ->andWhere('f.client = :client')
		   // ->setParameter('client', 'GREENCABLE');					
		$statlocmois = $qb->getQuery()->getResult();

		return $statlocmois;
	}
	
	public function nblocparc()
	{
		// $qb = $this->createQueryBuilder('f')
					// ->leftJoin('f.locations', 'c')
					// ->addSelect('c')
					// ->Select('COUNT(c.id) as nblocparc');
		// $qb->where('c.debutloc <= :today and c.finloc >= :today')
		// ->setParameter('today',date('Y-m-d'))		
		// ->andWhere('f.contrat = :contrat')		
		// ->setParameter('contrat', 1);					
		// $nblocparc = $qb->getQuery()->getSingleScalarResult();
		
		$qb = $this->createQueryBuilder('f')
					->leftJoin('f.locations', 'c')
					->addSelect('c')
					->Select('COUNT(c.id) as nblocparc');
		$qb->where('c.etatloc = :etatloc')
		->setParameter('etatloc','En location');					
		$nblocparc = $qb->getQuery()->getSingleScalarResult();

		return $nblocparc;
	}
	
	public function nblocparcsl()
	{
		$qb = $this->createQueryBuilder('f')
					->leftJoin('f.locationssl', 'c')
					->addSelect('c')
					->Select('COUNT(c.id) as nblocparcsl');
		$qb->where('c.debutloc <= :today and c.finloc >= :today')
		->setParameter('today', date('Y-m-d'))		
		->andWhere('f.contrat = :contrat')		
		->setParameter('contrat', 1)		
		->andWhere('c.etatloc = :etatloc')		
		->setParameter('etatloc', 'En location');					
		$nblocparcsl = $qb->getQuery()->getSingleScalarResult();
		
		// $qb = $this->createQueryBuilder('f')
					// ->leftJoin('f.locationssl', 'c')
					// ->addSelect('c')
					// ->Select('COUNT(c.id) as nblocparc');
		// $qb->where('c.etatloc = :etatloc')
		// ->setParameter('etatloc','En location');					
		// $nblocparcsl = $qb->getQuery()->getSingleScalarResult();

		return $nblocparcsl;
	}
	
	public function listereprises()
	{
		$qb = $this->createQueryBuilder('f')
					->leftJoin('f.locations', 'c')
					->addSelect('c');
		//LIGNES A REACTIVER UNE FOIS LES CONTRATS SAISIS
		$qb->where('c.finloc <= :today')		
		->setParameter('today', date('Y-m-d'));		
		$qb->andWhere('f.contrat = :contrat')		
		->setParameter('contrat', 1)
		->andwhere('c.etatloc = :etatloc')
		->setParameter('etatloc', 'En location')			
		->orderBy('c.finloc', 'ASC');					
		return $qb->getQuery()->getResult();
	}
	
	public function listereprisessl()
	{
		$qb = $this->createQueryBuilder('f')
					->leftJoin('f.locationssl', 'c')
					->addSelect('c');
		//LIGNES A REACTIVER UNE FOIS LES CONTRATS SAISIS
		$qb->where('c.finloc <= :today')		
		->setParameter('today', date('Y-m-d'));		
		$qb->andWhere('f.contrat = :contrat')		
		->setParameter('contrat', 1)
		->andwhere('c.etatloc = :etatloc')
		->setParameter('etatloc', 'En location')			
		->orderBy('c.finloc', 'ASC');					
		return $qb->getQuery()->getResult();
	}

    public function camensuelclientsl($search, $dStart, $dEnd, $client)
    {
        if($search == 0)
        {//echo 'laaaa';echo $dEnd;echo $dStart;
            $qb = $this->createQueryBuilder('a')
                ->leftJoin('a.locationssl', 's')
                ->addSelect('s');
            $qb->where('YEARMONTH(s.debutloc) <= :today')
                ->setParameter('today', date('Ym',strtotime($dEnd)))
                ->andWhere('YEARMONTH(s.debutloc) >= :dtsart')
                ->setParameter('dtsart', date('Ym',strtotime($dStart)))
                ->orderBy('a.client', 'ASC');
        }
        else
        {
            $qb = $this->createQueryBuilder('a')
                ->leftJoin('a.locationssl', 's')
                ->addSelect('s');
            $qb->where('YEARMONTH(s.debutloc) <= :today')
                ->setParameter('today', date('Ym',strtotime($dEnd)))
                ->andWhere('YEARMONTH(s.debutloc) >= :dtsart')
                ->setParameter('dtsart', date('Ym',strtotime($dStart)));
            if($client != 0)
            {
                $qb->andWhere('(a.client) = :client')
                    ->setParameter('client', $client);
            }
            $qb->orderBy('a.client', 'ASC');
        }
        return $qb->getQuery()->getResult();
    }

    public function camensuelclientsldet($mois, $loueur)
    {
        $qb = $this->createQueryBuilder('a')
            ->leftJoin('a.locationssl', 's')
            ->addSelect('s');
        $qb->where('YEARMONTH(s.debutloc) = :today')
            ->setParameter('today', $mois)
            ->orderBy('a.client', 'ASC');
        return $qb->getQuery()->getResult();
    }

    public function locpasterm()
    {
        $qb = $this->createQueryBuilder('f')
            ->leftJoin('f.locations', 'c')
            ->leftJoin('f.locationssl', 's')
            ->addSelect('c')
            ->addSelect('s');
        $qb->where('c.etatloc != :etatloc1 or s.etatloc != :etatloc1')
            ->setParameter('etatloc1', 'Location terminée')
            ->andWhere('f.contrat = :contrat')
            ->setParameter('contrat', 1);
        // ->andWhere('f.client = :client')
        // ->setParameter('client', 'GREENCABLE');
        $statlocmois = $qb->getQuery()->getResult();

        return $statlocmois;
    }

    public function contratsenloc($id)
    {
        $qb = $this->createQueryBuilder('f')
            ->leftJoin('f.locations', 'c')
            ->leftJoin('f.locationssl', 's')
            ->addSelect('c')
            ->addSelect('s');
        $qb->where('c.etatloc = :etatloc1 or s.etatloc = :etatloc1')
            ->setParameter('etatloc1', 'En location')
            ->andWhere('f.contrat = :contrat')
            ->setParameter('contrat', 1)
         ->andWhere('f.clientid = :clientid')
         ->setParameter('clientid', $id)
            ->orderBy('f.datecrea', 'DESC');
        $statlocmois = $qb->getQuery()->getResult();

        return $statlocmois;
    }

    public function locatamoisdertoday()
    {
        $dStart = date('Y-m-01', strtotime(" -1 month"));
        $dEnd = date('Y-m-t', strtotime(" -1 month"));
        $qb = $this->createQueryBuilder('f')
        ->leftJoin('f.locations', 'c')
        ->leftJoin('f.locationssl', 's')
        ->addSelect('c')
        ->addSelect('s');
        $qb->where('(YEARMONTH(c.debutloc) >= :dtsart and YEARMONTH(c.debutloc) <= :dend) or (YEARMONTH(s.debutloc) >= :dtsart and YEARMONTH(c.debutloc) <= :dend)')
            ->setParameter('dtsart', date('Ym',strtotime($dStart)))
            ->setParameter('dend', date('Ym',strtotime($dEnd)))
            ->andWhere('f.contrat = :contrat')
            ->setParameter('contrat', 1)
            ->orderBy('f.id', 'ASC');

        return $qb->getQuery()->getArrayResult();
    }

    public function listedevis($vue, $mode, $client, $cp, $nbparpage, $page, $ville, $suivipar, $du, $au)
    {
        // On déplace la vérification du numéro de page dans cette méthode
        if ($page < 1) {

        }
        // On utilise le QueryBuilder cr�� par le repository directement pour gagner du temps
        // Plus besoin de faire le select() ni le from() par la suite donc
        if($mode != 'search')
        {
            $qb = $this->createQueryBuilder('a');
            $qb->orderBy('a.datecrea', 'DESC');
            $qb->getQuery();
        }
        else
        {//echo 'pas serach';
            $qb = $this->createQueryBuilder('a')
                ->where('a.id > :id')
                ->setParameter('id', 0);
            if($client != '0')
            {//echo '$client'.$client;
                $qb->andWhere('a.client LIKE :client')
                    ->setParameter('client', '%'.$client.'%');
            }
            if($suivipar != '0' and $suivipar != 'Non attribué')
            {//echo '$suivipar'.$suivipar;
                $qb->andWhere('a.user LIKE :suivipar')
                    ->setParameter('suivipar', '%'.$suivipar.'%');
            }
            if($ville != '0')
            {//echo '$ville'.$ville;
                $qb->andWhere('a.ville LIKE :ville')
                    ->setParameter('ville', '%'.$ville.'%');
            }
            if($cp != 0)
            {//echo '$cp'.$cp;
                $qb->andWhere('a.cp = :cp')
                    ->setParameter('cp', $cp);
            }
            if($du != '0' and $du != '')
            {//echo 'dduuu'.$du;
                $qb->andWhere('a.datecrea >= :datecrea')
                    ->setParameter('datecrea', $du);
            }
            if($au != '0' and $au != '')
            {//echo 'auuu'.$au;
                $qb->andWhere('a.datecrea <= :datecrea')
                    ->setParameter('datecrea', $au);
            }
            $qb->orderBy('a.datecrea', 'DESC');
            $qb->getQuery();
        }

        // On d�finit l'article � partir duquel commencer la liste
        $qb->setFirstResult(($page-1) * $nbparpage)
            // Ainsi que le nombre d'articles � afficher
            ->setMaxResults($nbparpage);
        // Enfin, on retourne l'objet Paginator correspondant � la requ�te construite
        // (n'oubliez pas le use correspondant en d�but de fichier)
        return new Paginator($qb);
    }

    public function devisfaits($du, $au, $user)
    {
        $qb = $this->createQueryBuilder('f')
            ->leftJoin('f.locations', 'c')
            ->leftJoin('f.locationssl', 's')
            ->addSelect('c')
            ->addSelect('s');
        $qb->where('f.offreencours = :offreencours')
            ->setParameter('offreencours', 1);
        if($du != '0' and $au != '0')
        {//echo 'du'.$du;
            $qb->andwhere('f.datecrea >= :du and f.datecrea <= :au')
                ->setParameter('du', $du)
                ->setParameter('au', $au);
        }
        if($user != '0' and $user != '')
        {//echo 'user'.$user;
            $qb->andWhere('f.user LIKE :suivipar')
                ->setParameter('suivipar', '%'.$user.'%');
        }
        $qb->orderBy('f.datecrea', 'DESC');

        return $qb->getQuery()->getResult();
    }

    public function devisacceptes($du, $au, $user)
    {
        $qb = $this->createQueryBuilder('f')
            ->leftJoin('f.locations', 'c')
            ->leftJoin('f.locationssl', 's')
            ->addSelect('c')
            ->addSelect('s');
        $qb->where('f.offreencours = :offreencours')
            ->setParameter('offreencours', 1);
        if($du != '0' and $au != '0')
        {
            $qb->andwhere('f.datecrea >= :du and f.datecrea <= :au')
                ->setParameter('du', $du)
                ->setParameter('au', $au);
        }
        $qb->andWhere('f.contrat = :contrat')
            ->setParameter('contrat', 1);
        if($user != '0' and $user != '')
        {
            $qb->andWhere('f.user LIKE :suivipar')
                ->setParameter('suivipar', '%'.$user.'%');
        }
        $qb->orderBy('f.datecrea', 'DESC');

        return $qb->getQuery()->getResult();
    }

    public function devissanssuite($du, $au, $user)
    {        $qb = $this->createQueryBuilder('f')
        ->leftJoin('f.locations', 'c')
        ->leftJoin('f.locationssl', 's')
        ->addSelect('c')
        ->addSelect('s');
        $qb->where('f.offreencours = :offreencours')
            ->setParameter('offreencours', 1);
        if($du != '0' and $au != '0')
        {
            $qb->andwhere('f.datecrea >= :du and f.datecrea <= :au')
                ->setParameter('du', $du)
                ->setParameter('au', $au);
        }
        $qb->andWhere('f.contrat = :contrat')
            ->setParameter('contrat', 0)
            ->andWhere('c.debutloc <= :debutloc or s.debutloc <= :debutloc')
            ->setParameter('debutloc', date('Y-m-d'));
        if($user != '0' and $user != '')
        {
            $qb->andWhere('f.user LIKE :suivipar')
                ->setParameter('suivipar', '%'.$user.'%');
        }
        $qb->orderBy('f.datecrea', 'DESC');

        return $qb->getQuery()->getResult();
    }

    public function devisencours($du, $au, $user)
    {        $qb = $this->createQueryBuilder('f')
        ->leftJoin('f.locations', 'c')
        ->leftJoin('f.locationssl', 's')
        ->addSelect('c')
        ->addSelect('s');
        $qb->where('f.offreencours = :offreencours')
            ->setParameter('offreencours', 1);
        if($du != '0' and $au != '0')
        {
            $qb->andwhere('f.datecrea >= :du and f.datecrea <= :au')
                ->setParameter('du', $du)
                ->setParameter('au', $au);
        }
        $qb->andWhere('f.contrat = :contrat')
            ->setParameter('contrat', 0)
            ->andWhere('c.debutloc > :debutloc or s.debutloc > :debutloc')
            ->setParameter('debutloc', date('Y-m-d'));
        if($user != '0' and $user != '')
        {
            $qb->andWhere('f.user LIKE :suivipar')
                ->setParameter('suivipar', '%'.$user.'%');
        }
        $qb->orderBy('f.datecrea', 'DESC');

        return $qb->getQuery()->getResult();
    }
}